
<!doctype html>
<html lang="de">
<head>
  <base href="/mittagio/app/">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Mittagio</title>
  <meta name="theme-color" content="#F2B705" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="assets/icons/icon-192.png" />
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png" />
  <script src="https://unpkg.com/lucide@latest" onload="if(typeof lucide !== 'undefined') lucide.createIcons();"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
    :root{
      /* Mittagio palette (can be adjusted later) */
      --bg:#F7F6F0;
      --card:#FFFFFF;
      --text:#111;
      --muted:#6b6b6b;
      --border:#e7e1d5;
      --shadow:0 10px 24px rgba(0,0,0,.08);
      --shadow2:0 16px 40px rgba(0,0,0,.14);
      --radius:24px;     /* rounded-3xl for messenger vibe */
      --brand:#FFCC00;   /* Mittagio-Gelb */
      --brand2:#1F9D55;  /* green */
      --danger:#E34D4D;
      
      /* Design Tokens - PWA Light */
      /* Radius */
      --r-sm: 10px;
      --r-md: 14px;
      --r-lg: 18px;
      --r-xl: 24px;
      --r-full: 999px;
      
      /* Spacing */
      --s-1: 4px;
      --s-2: 8px;
      --s-3: 12px;
      --s-4: 16px;
      --s-5: 20px;
      --s-6: 24px;
      --s-8: 32px;
      
      /* Typography */
      --font-title: 18px;
      --font-title-lg: 20px;
      --font-body: 14px;
      --font-body-lg: 16px;
      --font-meta: 12px;
      --font-meta-sm: 13px;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;
      
      /* Colors (Light) */
      --color-bg: #FFFFFF;
      --color-surface: #FFFFFF;
      --color-border: #EAEAEA;
      --color-text: #1A1A1A;
      --color-text-secondary: #6B6B6B;
      --color-brand-yellow: #FFCC00;
      --color-soft-yellow-bg: rgba(255, 204, 0, 0.15);
      --color-soft-green-bg: rgba(31, 157, 85, 0.12);
      --color-soft-grey-bg: rgba(0, 0, 0, 0.06);
      
      /* Icon Sizes */
      --icon-inline: 16px;
      --icon-inline-lg: 18px;
      --icon-header: 20px;
      --icon-header-lg: 22px;
      --icon-nav: 22px;
      --icon-nav-lg: 24px;
      
      /* Button Heights */
      --btn-height-min: 44px;
      --btn-height-md: 48px;
      
      /* Badge */
      --badge-height: 24px;
      --badge-px: 10px;
      --badge-px-lg: 12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-size:16px;
      line-height:1.5;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit}

    /* App shell */
    .app{min-height:100%; padding-bottom:78px;}
    .topbar{
      position:relative; z-index:10;
      background:rgba(247,246,240,.92);
      backdrop-filter:saturate(160%) blur(8px);
      border-bottom:1px solid var(--border);
    }
    .topbar-inner{max-width:980px; margin:0 auto; padding:12px 14px; display:flex; align-items:center; gap:10px;}
    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .brand-badge{
      width:38px; height:38px; border-radius:12px;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      box-shadow:0 8px 18px rgba(0,0,0,.16);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .brand-badge img{width:100%; height:100%; object-fit:cover; display:block}
    .brand-name{font-weight:900; letter-spacing:.06em; font-size:20px; white-space:nowrap}
    .spacer{flex:1}

    .chiprow{
      max-width:980px; margin:0 auto; padding:6px 14px 8px;
      display:flex; gap:8px; overflow:auto; -webkit-overflow-scrolling:touch;
    }
    .chip{
      flex:0 0 auto;
      border:1px solid var(--border);
      background:#f8f7f3;
      padding:10px 16px;
      border-radius:999px;
      font-size:14px;
      font-weight:800;
      color:#222;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .chip.active{
      border-color:rgba(31,157,85,.45);
      background:rgba(31,157,85,.12);
      box-shadow:0 10px 22px rgba(31,157,85,.12)
    }

    .pickup-group{
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      padding:10px;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .pickup-group + .pickup-group{margin-top:10px}
    .pickup-head{display:flex; align-items:center; justify-content:space-between; gap:8px; font-weight:900}
    .pickup-sub{font-size:12px; color:var(--muted)}
    .code-chip{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px; border:1px solid var(--border);
      background:#fff; font-size:12px; font-weight:900;
      margin:4px 6px 0 0; box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .code-chip.done{background:rgba(31,157,85,.12); border-color:rgba(31,157,85,.4); color:#1f9d55; text-decoration:line-through}

    .dayrow{
      max-width:980px; margin:0 auto; padding:0 14px 12px;
      display:flex; gap:8px; overflow:auto; -webkit-overflow-scrolling:touch;
    }
    .day{
      flex:0 0 auto;
      border:none;
      background:#fff;
      padding:12px 16px;
      border-radius:999px;
      font-size:14px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      border:1px solid var(--border);
    }
    .day.active{background:rgba(242,183,5,.14); border-color:rgba(242,183,5,.55)}

    main{max-width:980px; margin:0 auto; padding:14px}
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    @media (min-width:820px){ .grid{grid-template-columns:1fr 1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:20px;
      overflow:hidden;
      box-shadow:var(--shadow);
      cursor:pointer;
      position:relative;
    }
    .card.playful{
      border-color:rgba(242,183,5,.38);
      box-shadow:0 12px 26px rgba(242,183,5,.18);
    }
    .card.playful .body{
      background:linear-gradient(180deg,#fff, #fff4e6);
    }
    .card.playful .price{color:#b26b00}
    .card.playful .tag{background:rgba(242,183,5,.25)}
    .img{aspect-ratio:16/9; height:auto; min-height:120px; max-height:140px; background:#eee; position:relative; overflow:hidden; border-radius:20px 20px 0 0}
    .img img{width:100%; height:100%; object-fit:cover; display:block}

    .provider-logo{
      display:flex; align-items:center; gap:8px;
      padding:12px 14px 0;
    }
    .plogo{
      width:28px; height:28px; border-radius:8px;
      background:#f2f2f2;
      overflow:hidden;
      border:1px solid var(--border);
      flex:0 0 auto;
    }
    .plogo img{width:100%; height:100%; object-fit:cover; display:block}
    .pname{font-size:14px; font-weight:900; color:#222; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; line-height:1.3}

    .body{padding:14px 16px 16px}
    .title{font-weight:950; font-size:18px; margin:0; line-height:1.3}
    .sub{margin:4px 0 0; color:#444; font-size:14px; line-height:1.4}
    
    /* Refactored Card Styles - weniger Text, mehr Icons */
    .card-heart{
      position:absolute; top:12px; right:12px; z-index:5;
      width:36px; height:36px; border-radius:50%;
      border:none; background:rgba(255,255,255,.9);
      backdrop-filter:blur(8px); display:flex;
      align-items:center; justify-content:center;
      cursor:pointer; transition:all .2s;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
    }
    .card-heart:hover{background:rgba(255,255,255,1); transform:scale(1.05)}
    .card-heart.on{background:rgba(255,204,0,.2)}
    .card-heart i{width:18px; height:18px; color:#999}
    .card-heart.on i{color:#e74c3c; fill:currentColor}
    
    .card-title-row{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:8px; margin-bottom:6px;
    }
    .card-title{
      font-weight:900; font-size:17px; margin:0;
      line-height:1.3; flex:1; min-width:0;
      display:-webkit-box; -webkit-line-clamp:2;
      -webkit-box-orient:vertical; overflow:hidden;
      color:#111;
    }
    .card-provider{
      font-size:13px; color:#666; margin:0 0 8px;
      line-height:1.3; font-weight:500;
      display:flex; align-items:center; gap:6px;
    }
    .card-provider .ico-inline{
      width:16px; height:16px; flex-shrink:0;
      color:var(--muted);
    }
    .card-provider .ico-inline svg{
      width:16px; height:16px;
    }
    .card-price{
      font-size:24px; font-weight:950; color:var(--brand);
      margin:0 0 10px; line-height:1;
    }
    .card-info-badges{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-bottom:10px; align-items:center;
    }
    .card-info-badge{
      display:inline-flex; align-items:center; gap:4px;
      font-size:13px; font-weight:600; color:#666;
      white-space:nowrap;
    }
    .card-info-badge .ico-inline{
      width:16px; height:16px; flex-shrink:0;
      color:var(--muted);
    }
    .card-info-badge .ico-inline svg{
      width:16px; height:16px;
    }
    .card-status-badges{
      display:flex; gap:6px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .card-status-badge{
      display:inline-flex; align-items:center; gap:4px;
      padding:4px 10px; border-radius:999px;
      font-size:11px; font-weight:600;
      background:rgba(0,0,0,.06); color:#666;
      white-space:nowrap;
    }
    .card-status-badge .ico-inline{
      width:14px; height:14px; flex-shrink:0;
    }
    .card-status-badge .ico-inline svg{
      width:14px; height:14px;
    }
    /* Abholcode Badge: leicht hervorgehoben (Markenfarbe Gelb) */
    .card-status-badge.code{
      background:rgba(255,204,0,.2); color:#b8860b;
      font-weight:700;
    }
    .card-status-badge.code .ico-inline{color:#b8860b}
    /* Vor Ort Badge: weiche gr√ºne F√ºllung */
    .card-status-badge.dine{
      background:rgba(31,157,85,.12); color:#1f9d55;
    }
    .card-status-badge.dine .ico-inline{color:#1f9d55}
    /* Zum Mitnehmen Badge: neutrale weiche F√ºllung */
    .card-status-badge.pickup{
      background:rgba(0,0,0,.06); color:#666;
    }

    .meta{display:flex; justify-content:space-between; align-items:flex-end; gap:12px; margin-top:12px}
    .price{font-weight:950; font-size:18px; color:#0f5c4c}
    .right{ text-align:right; font-size:13px; color:var(--muted); line-height:1.4 }
    .meta-line{display:flex; align-items:center; gap:6px; justify-content:flex-end}
    .tag{display:inline-block; margin-top:6px; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:900; background:rgba(242,183,5,.18)}

    .badge{
      position:absolute; top:12px; left:12px;
      background:rgba(17,17,17,.72);
      color:#fff;
      font-size:12px; font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      box-shadow:0 10px 22px rgba(0,0,0,.18);
      line-height:1.3;
    }
    .badge.code{left:auto; right:12px; background:rgba(31,157,85,.9)}
    .badge.dine{background:rgba(242,183,5,.9); color:#111}
    .badge.inactive{background:rgba(0,0,0,.45)}

    .heart{
      position:absolute; top:12px; right:12px;
      width:36px; height:36px; border-radius:999px;
      border:none; cursor:pointer;
      background:rgba(255,255,255,.92);
      box-shadow:0 10px 22px rgba(0,0,0,.16);
      font-size:16px;
      color:#bbb;
      display:flex; align-items:center; justify-content:center;
    }
    .heart.on{color:var(--danger)}

    /* Bottom nav - Glassmorphism Mittagio-Bar */
    .bottom{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      height:80px; padding-bottom:env(safe-area-inset-bottom);
      background:rgba(255,255,255,.85);
      backdrop-filter:saturate(180%) blur(20px);
      -webkit-backdrop-filter:saturate(180%) blur(20px);
      border-top:1px solid rgba(231,225,213,.3);
      display:flex;
      box-shadow:0 -4px 20px rgba(0,0,0,.05);
    }
    .navbtn{
      flex:1; border:none; background:none; cursor:pointer;
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
      color:#777; font-size:11px; font-weight:600;
      padding:8px 4px; transition:color .2s;
      position:relative;
      -webkit-tap-highlight-color: transparent;
    }
    .navbtn * {
      pointer-events: none;
    }
    .navbtn .ico{font-size:22px; display:inline-flex; align-items:center; justify-content:center}
    .navbtn .ico svg{width:22px; height:22px; stroke-width:2}
    /* Bottom Navigation Icons: 22-24px */
    .navbtn.active{color:var(--brand)}
    .navbtn.active .ico svg{color:var(--brand); stroke:var(--brand)}
    .navbtn.active{color:var(--brand); font-weight:900}
    .navbtn .badge-notification{
      position:absolute; top:8px; right:calc(50% - 20px);
      width:8px; height:8px; border-radius:50%;
      background:var(--brand); border:2px solid rgba(255,255,255,.85);
    }

    /* Views */
    .view{display:none}
    .view.active{display:block}

    /* Sheets / modals */
    .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.38); opacity:0; pointer-events:none; transition:opacity .2s; z-index:30}
    .backdrop.active{opacity:1; pointer-events:auto}
    .sheet{
      position:fixed; left:0; right:0; bottom:-120%; z-index:31;
      background:#fff; border-radius:22px 22px 0 0;
      box-shadow:var(--shadow2);
      transition:bottom .28s ease;
      max-height:92vh; overflow:auto;
    }
    .sheet.active{bottom:0}
    .handle{width:46px; height:5px; background:#ddd; border-radius:999px; margin:10px auto 6px}
    .sheet-img{height:260px; background:#eee}
    .sheet-img img{width:100%; height:100%; object-fit:cover; display:block}
    .sheet-body{padding:12px 14px 18px}
    .row{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px 0; border-top:1px solid #eee; font-size:15px; line-height:1.4}
    .btn{
      width:100%; border:none; cursor:pointer;
      border-radius:999px; padding:16px 20px; font-weight:950; font-size:16px;
      background:var(--brand); color:#111;
      line-height:1.4;
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn.secondary{background:#fff; border:1px solid var(--border)}
    .btn.ghost{background:#f8f7f3; border:1px solid var(--border)}
    .mini{font-size:13px; color:var(--muted); margin-top:8px; line-height:1.5}
    
    /* Primary CTA (Yellow, Dark Text, 56-64px) */
    .btn-primary{
      width:100%; border:none; cursor:pointer;
      border-radius:999px; padding:16px 20px; font-weight:950; font-size:16px;
      background:#f2b705; color:#111;
      line-height:1.4;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-height:56px; max-height:64px;
      transition:all .2s;
    }
    .btn-primary:active{background:#e6b800}
    .btn-primary:disabled{
      opacity:.6; cursor:not-allowed; background:#f2b705;
    }
    .btn-primary.loading{
      opacity:.7; cursor:wait;
    }
    .btn-primary.success{
      background:#2e7d32; color:#fff;
    }

    .card-actions{display:flex; gap:8px; margin-top:12px}
    .card-action{
      flex:1; padding:0 16px; min-height:44px;
      border-radius:12px; border:none;
      background:#fff; font-weight:900; font-size:15px;
      cursor:pointer; transition:transform .1s, background .15s;
      display:flex; align-items:center; justify-content:center; gap:6px;
      text-align:center;
    }
    .card-action:active{transform:scale(.97)}
    .card-action.primary{
      background:var(--brand); color:#111;
      border:1px solid var(--brand);
      min-height:44px;
    }
    .card-action.primary:active{background:#e6b800}
    .card-action.ghost{background:#f8f7f3; border:1px solid var(--border)}
    .card-action:disabled{opacity:.5; cursor:not-allowed; background:#f5f5f5}

    /* Profile cards */
    .panel{background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); padding:12px}
    .panel h3{margin:0 0 10px; font-size:18px; font-weight:900; line-height:1.3}
    .section-title{font-weight:900; font-size:20px; margin:12px 0 8px; line-height:1.3}
    .rowlist{display:flex; flex-direction:column; gap:8px}
    .rowbtn{
      width:100%; border:1px solid var(--border); background:#fff; cursor:pointer;
      border-radius:14px; padding:12px; text-align:left; font-weight:900;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .rowbtn-left{display:flex; align-items:center; gap:10px; min-width:0}
    .rowbtn-ico{
      width:36px; height:36px; border-radius:10px; flex:0 0 auto;
      border:1px solid var(--border); background:#f8f7f3;
      display:flex; align-items:center; justify-content:center;
    }
    .rowbtn-ico svg{width:16px; height:16px}
    .rowbtn-text{min-width:0}
    .rowbtn-text span{display:block; font-weight:600; font-size:13px; color:var(--muted); margin-top:4px; line-height:1.4}
    .rowbtn .chev{font-size:20px; color:var(--muted)}
    .rowgroup-title{font-size:13px; font-weight:900; color:var(--muted); margin-top:8px; line-height:1.4}
    .profile-head{display:flex; align-items:center; gap:12px}
    .profile-head .plogo{width:56px; height:56px; border-radius:50%}
    .profile-meta{display:flex; flex-direction:column; gap:4px}
    .profile-chip{display:inline-flex; align-items:center; gap:6px; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900; background:#fff}
    .profile-actions{margin-top:10px}
    .profile-actions .btn{width:auto; margin-top:0}
    .row-group{margin-top:12px}
    .row-group .rowgroup-title{margin:0 0 8px}
    .row-muted{font-size:12px; color:var(--muted)}

    .tabrow{display:flex; gap:8px; flex-wrap:wrap}
    .tabrow .ans{font-size:12px; padding:8px 10px}
    .cookbook-item{border:1px solid var(--border); border-radius:14px; padding:10px; background:#fff; box-shadow:0 6px 14px rgba(0,0,0,.06)}
    .cookbook-item + .cookbook-item{margin-top:10px}
    .cookbook-actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .cookbook-facts{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.35}
    .cart-line{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 0; border-top:1px solid #eee}
    .cart-left{font-weight:700; flex:1; min-width:0}
    .cart-qty{display:flex; align-items:center; gap:6px}
    .qty-btn{border:1px solid var(--border); background:#fff; border-radius:999px; width:28px; height:28px; cursor:pointer; font-weight:900; transition:all .15s}
    .qty-btn:active{transform:scale(.95); background:#f5f5f5}
    .cart-price{font-weight:900; min-width:60px; text-align:right}
    /* Essenszeit Badge */
    .cart-window-badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 12px; border-radius:12px;
      background:rgba(255,204,0,.1); color:#b8860b;
      font-size:13px; font-weight:700; margin:8px 0;
    }
    .cart-window-badge i{width:16px; height:16px}
    /* Quick-Time-Chips */
    .cart-time-chips{
      display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px;
    }
    .cart-time-chip{
      padding:8px 14px; border-radius:12px;
      border:1px solid #ddd; background:#fff;
      font-size:13px; font-weight:600; color:#666;
      cursor:pointer; transition:all .15s;
    }
    .cart-time-chip:active{transform:scale(.96); background:#f5f5f5}
    .cart-time-chip.selected{
      background:var(--brand); color:#000; border-color:var(--brand);
    }
    /* Warenkorb leeren Button */
    .cart-clear-btn{
      display:inline-block; margin-top:12px;
      padding:8px 16px; border-radius:10px;
      background:#f5f5f5; color:#666;
      font-size:13px; font-weight:600;
      text-decoration:none; cursor:pointer;
      transition:all .15s;
    }
    .cart-clear-btn:hover{background:#eee}
    .cart-clear-btn:active{transform:scale(.98)}
    .order-item{border:1px solid var(--border); border-radius:14px; padding:10px; background:#fff; box-shadow:0 6px 14px rgba(0,0,0,.06)}
    .order-item.done{opacity:.65}
    .order-item + .order-item{margin-top:10px}
    .order-top{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .order-right{display:flex; flex-direction:column; align-items:flex-end; gap:6px}
    .order-code{border:1px solid var(--border); background:#fff; border-radius:10px; padding:6px 10px; font-weight:900; cursor:pointer}
    .status-pill{display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; font-size:11px; font-weight:900; border:1px solid var(--border)}
    .status-pill.open{background:rgba(242,183,5,.12); color:#b37b00}
    .status-pill.done{background:rgba(31,157,85,.12); color:#1f9d55}
    .code-full{font-size:42px; font-weight:950; text-align:center; margin:10px 0}

    /* Quick-Ticket (bildschirmf√ºllend) */
    /* Fullscreen Code Modal (extrem gro√ü, 1-2m lesbar) */
    .fullscreen-code{
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:#fff; z-index:1000;
      display:flex; align-items:center; justify-content:center;
      flex-direction:column; padding:40px 20px;
      opacity:0; pointer-events:none; transition:opacity .2s;
    }
    .fullscreen-code.active{
      opacity:1; pointer-events:auto;
    }
    .fullscreen-code-close{
      position:absolute; top:20px; right:20px;
      width:48px; height:48px; border-radius:50%;
      background:rgba(0,0,0,.1); border:none;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; transition:all .2s;
      z-index:1001;
    }
    .fullscreen-code-close:hover{background:rgba(0,0,0,.15)}
    .fullscreen-code-close i{width:24px; height:24px}
    .fullscreen-code-content{
      text-align:center; width:100%; max-width:600px;
    }
    .fullscreen-code-value{
      font-size:clamp(56px, 12vw, 120px);
      font-weight:900; font-family:monospace;
      letter-spacing:clamp(8px, 2vw, 16px);
      color:#000; line-height:1.2;
      margin-bottom:24px;
      word-spacing:clamp(12px, 3vw, 24px);
    }
    .fullscreen-code-subtext{
      font-size:clamp(14px, 3vw, 20px);
      color:#666; font-weight:600;
    }
    
    .quick-ticket{
      position:fixed; inset:0; z-index:31;
      background:linear-gradient(135deg, var(--brand) 0%, #FFD700 100%);
      display:flex; align-items:center; justify-content:center;
      transform:translateY(100%); transition:transform .3s cubic-bezier(.4,0,.2,1);
      padding:20px;
    }
    .quick-ticket.active{transform:translateY(0)}
    .quick-ticket-close{
      position:absolute; top:20px; right:20px;
      width:44px; height:44px; border-radius:50%;
      background:rgba(255,255,255,.2); backdrop-filter:blur(10px);
      border:2px solid rgba(255,255,255,.3);
      color:#fff; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      transition:background .2s;
    }
    .quick-ticket-close:hover{background:rgba(255,255,255,.3)}
    .quick-ticket-close i{width:24px; height:24px}
    .quick-ticket-content{
      width:100%; max-width:400px; text-align:center;
      color:#111;
    }
    .quick-ticket-header{
      margin-bottom:40px;
    }
    .quick-ticket-logo{
      width:80px; height:80px; border-radius:20px;
      background:#fff; border:4px solid rgba(255,255,255,.5);
      margin:0 auto 16px; overflow:hidden;
      box-shadow:0 8px 24px rgba(0,0,0,.2);
    }
    .quick-ticket-logo img{
      width:100%; height:100%; object-fit:cover;
    }
    .quick-ticket-provider{
      font-size:26px; font-weight:900; margin-bottom:10px; line-height:1.3;
    }
    .quick-ticket-time{
      font-size:15px; opacity:.8; font-weight:600; line-height:1.4;
    }
    .quick-ticket-code{
      background:#fff; border-radius:var(--radius);
      padding:32px 24px; margin-bottom:24px;
      box-shadow:0 12px 32px rgba(0,0,0,.2);
    }
    .quick-ticket-code-label{
      font-size:12px; font-weight:700; text-transform:uppercase;
      letter-spacing:.1em; color:var(--muted); margin-bottom:12px;
    }
    .quick-ticket-code-value{
      font-size:72px; font-weight:950; line-height:1;
      color:#111; font-family:'Inter', monospace;
      letter-spacing:.05em;
    }
    .quick-ticket-details{
      background:rgba(255,255,255,.3); backdrop-filter:blur(10px);
      border-radius:var(--radius); padding:20px;
      margin-bottom:20px;
    }
    .quick-ticket-detail-item{
      margin-bottom:16px;
    }
    .quick-ticket-detail-item:last-child{margin-bottom:0}
    .quick-ticket-detail-label{
      font-size:13px; font-weight:700; opacity:.7; margin-bottom:6px; line-height:1.4;
    }
    .quick-ticket-detail-value{
      font-size:17px; font-weight:900; line-height:1.4;
    }
    .quick-ticket-status{
      font-size:14px; font-weight:700; opacity:.8; line-height:1.4;
      margin-bottom:24px;
    }
    .quick-ticket-actions .btn{
      background:#fff; color:#111; box-shadow:0 8px 24px rgba(0,0,0,.2);
    }

    .print-view{display:none}
    @media print{
      body{background:#fff; color:#000}
      body > *:not(#printView){display:none !important}
      #printView{display:block}
      #printView .print-card{
        border:1px solid #ddd; border-radius:12px; padding:16px; margin-bottom:12px;
      }
      #printView h1{margin:0 0 8px; font-size:20px}
      #printView h2{margin:12px 0 6px; font-size:16px}
      #printView .print-row{display:flex; justify-content:space-between; gap:12px; margin-top:6px}
      #printView .print-muted{color:#555; font-size:12px}
      #printView .print-badge{display:inline-block; padding:4px 8px; border:1px solid #999; border-radius:999px; font-size:11px; font-weight:700}
      #printView .print-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
      #printView .qr{width:120px; height:120px; border:1px dashed #999; display:flex; align-items:center; justify-content:center; font-size:11px}
    }
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .bigbtn{
      border:none; cursor:pointer;
      border-radius:18px; padding:14px;
      background:linear-gradient(135deg,rgba(242,183,5,.18),rgba(31,157,85,.12));
      border:1px solid var(--border);
      text-align:left;
      font-weight:950;
    }
    .bigbtn span{display:block; font-weight:700; font-size:12px; color:var(--muted); margin-top:6px}

    /* Provider app header */
    .prov-pill{
      display:inline-flex; align-items:center; gap:8px;
      background:#fff; border:1px solid var(--border);
      padding:9px 12px; border-radius:999px;
      font-weight:950; font-size:13px;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .provider-header{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .provider-logo.compact{padding:0}
    .header-actions{display:flex; gap:8px; flex-wrap:wrap}
    .header-actions .btn{width:auto; margin-top:0}

    .snackbar{
      position:fixed; left:50%; bottom:90px; transform:translateX(-50%);
      background:#111; color:#fff; border-radius:999px; padding:10px 14px;
      display:flex; align-items:center; gap:10px; box-shadow:0 10px 24px rgba(0,0,0,.22);
      opacity:0; pointer-events:none; transition:opacity .2s ease;
      z-index:40; font-size:13px; font-weight:900;
    }
    .snackbar.active{opacity:1; pointer-events:auto}
    .snackbar button{
      border:none; background:#fff; color:#111; border-radius:999px; padding:6px 10px;
      font-size:12px; font-weight:900; cursor:pointer;
    }

    /* Wizard */
    .wizard{
      background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow);
      padding:12px;
    }
    .w-top{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .w-title{font-weight:950}
    .w-step{font-size:12px; color:var(--muted)}
    .w-q{margin:12px 0 10px; font-size:18px; font-weight:950; line-height:1.2}
    .w-help{margin:0 0 10px; color:var(--muted); font-size:13px}
    .answers{display:flex; flex-wrap:wrap; gap:8px}
    .ans{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-weight:950;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .ans.on{border-color:rgba(31,157,85,.4); background:rgba(31,157,85,.10)}
    .field{width:100%; padding:14px 16px; border-radius:14px; border:1px solid var(--border); font-size:16px; background:#fbfaf7; line-height:1.5}
    .w-actions{display:flex; gap:10px; margin-top:12px}
    .w-actions button{flex:1}

    /* FAQ accordion */
    .faq{margin-top:12px}
    details{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 14px rgba(0,0,0,.06);padding:14px 16px}
    details+details{margin-top:10px}
    summary{cursor:pointer;font-weight:950;font-size:15px;line-height:1.4}
    details p{margin:10px 0 0;color:var(--muted);font-size:14px;line-height:1.6}

    /* helper */
    .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.25}

    .loc-row{display:flex; gap:8px; align-items:center}
    .pin-btn{
      border:1px solid var(--border); background:#fff; border-radius:14px;
      width:44px; height:44px; cursor:pointer; font-size:18px;
      display:flex; align-items:center; justify-content:center;
    }
    .ico-inline{display:inline-flex; align-items:center}
    .ico-inline svg{width:14px; height:14px; stroke:currentColor}
    .info-row{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; font-size:12px; color:var(--muted)}
    /* Legacy: Alte info-row (wird nicht mehr in offerCard verwendet) */
    .info-item{
      display:inline-flex; align-items:center; gap:6px;
      background:#f8f7f3; border:1px solid var(--border);
      padding:5px 10px; border-radius:999px;
      font-size:13px; line-height:1.4;
    }

    /* Onboarding */
    .onboarding-step{
      max-width:600px; margin:0 auto;
    }
    .onboarding-header{
      display:flex; justify-content:space-between; align-items:flex-start;
    }
    .onboarding-progress{
      font-size:12px; font-weight:900; color:var(--muted);
      text-transform:uppercase; letter-spacing:.05em;
    }
    .onboarding-logo-preview:hover{
      border-color:var(--brand); background:#fff4e6;
    }
    .onboarding-logo-preview img{
      display:block;
    }
    .time-btn.active{
      background:var(--brand); border-color:var(--brand);
    }
    .onboarding-summary-item:last-child{
      margin-bottom:0;
    }

    /* Social Feed - Story-Leiste */
    .stories-container{
      padding:16px 14px 20px;
      max-width:980px; margin:0 auto;
    }
    .stories-scroll{
      display:flex; gap:16px; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:4px;
    }
    .story-item{
      flex:0 0 auto; display:flex; flex-direction:column; align-items:center; gap:8px;
      cursor:pointer;
    }
    .story-avatar{
      width:64px; height:64px; border-radius:50%;
      border:3px solid var(--brand);
      padding:2px; background:#fff;
      overflow:hidden; position:relative;
    }
    .story-avatar img{
      width:100%; height:100%; object-fit:cover; border-radius:50%;
    }
    .story-name{
      font-size:12px; font-weight:700; color:var(--text);
      max-width:64px; text-align:center; overflow:hidden; text-overflow:ellipsis;
      line-height:1.3;
    }

    /* Discover Page - App-like UX (PWA, Light Mode) */
    .discover-header{
      position:sticky; top:0; z-index:10;
      background:rgba(255,255,255,.95); backdrop-filter:blur(10px);
      padding:8px 14px; max-width:980px; margin:0 auto;
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    /* Kompakte Standort-Pill (44-48px) */
    .discover-location-pill{
      display:flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:24px;
      background:rgba(0,0,0,.04); border:1px solid rgba(0,0,0,.08);
      height:44px; box-sizing:border-box;
    }
    .discover-location-icon-left{
      width:18px; height:18px; flex-shrink:0; opacity:.7;
      color:#666;
    }
    .discover-location-input{
      flex:1; border:none; background:transparent;
      font-size:15px; font-weight:500; color:#333;
      outline:none; min-width:0;
    }
    .discover-location-input::placeholder{
      color:#999; font-weight:400;
    }
    .discover-location-btn{
      width:32px; height:32px; border-radius:50%;
      border:none; background:transparent;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; transition:background .2s;
      flex-shrink:0;
    }
    .discover-location-btn:hover{
      background:rgba(0,0,0,.05);
    }
    .discover-location-btn i{
      width:18px; height:18px; color:#666;
    }
    
    /* Kategorien (horizontal swipebar, ohne √úberschrift) */
    .discover-categories{
      padding:12px 0 8px;
      max-width:980px; margin:0 auto;
    }
    .discover-categories-scroll{
      display:flex; gap:10px; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding:0 14px; scrollbar-width:none;
    }
    .discover-categories-scroll::-webkit-scrollbar{display:none}
    .discover-category-chip{
      flex:0 0 auto; padding:10px 18px;
      border-radius:20px; border:1.5px solid transparent;
      font-size:14px; font-weight:700;
      background:#f5f5f5; color:#666;
      cursor:pointer; transition:all .2s;
      white-space:nowrap;
    }
    .discover-category-chip.active{
      background:var(--brand); color:#000;
      border-color:var(--brand);
      box-shadow:0 2px 8px rgba(255,204,0,.3);
      font-weight:900;
    }
    .discover-category-chip:not(.active){
      border-color:rgba(0,0,0,.1);
      background:#fff;
    }
    .discover-category-chip:active{
      transform:scale(.96);
    }
    
    /* Kalender (horizontal swipebar, ohne √úberschrift, distinct style) */
    .discover-calendar{
      padding:0 0 14px;
      max-width:980px; margin:0 auto;
      border-top:1px solid rgba(0,0,0,.06);
      margin-top:4px;
      padding-top:10px;
    }
    .discover-calendar-scroll{
      display:flex; gap:8px; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding:0 14px; scrollbar-width:none;
    }
    .discover-calendar-scroll::-webkit-scrollbar{display:none}
    .discover-day{
      flex:0 0 auto; padding:8px 14px;
      border-radius:16px; border:1.5px solid rgba(0,0,0,.15);
      font-size:13px; font-weight:600;
      background:#fff; color:#666;
      cursor:pointer; transition:all .2s;
      white-space:nowrap;
      min-width:60px; text-align:center;
    }
    .discover-day.active{
      background:var(--brand); color:#000;
      border-color:var(--brand);
      box-shadow:0 2px 6px rgba(255,204,0,.25);
      font-weight:900;
    }
    .discover-day:active{
      transform:scale(.96);
    }
    
    /* Angebots-Liste Container */
    .discover-offers{
      padding:0 14px 24px;
      max-width:980px; margin:0 auto;
      display:flex; flex-direction:column; gap:12px;
    }
    /* List Cards - Horizontal Layout (kleines Bild links, Content rechts) */
    .discover-list-card{
      display:flex; gap:12px; padding:12px;
      background:#fff; border-radius:16px;
      box-shadow:0 1px 6px rgba(0,0,0,.06);
      cursor:pointer; transition:transform .1s, box-shadow .1s;
      border:1px solid rgba(0,0,0,.04);
    }
    .discover-list-card:active{
      transform:scale(.98);
      box-shadow:0 1px 4px rgba(0,0,0,.1);
    }
    .discover-list-image{
      flex:0 0 80px; width:80px; height:80px;
      border-radius:12px; overflow:hidden;
      background:#f0f0f0; flex-shrink:0;
    }
    .discover-list-image img{
      width:100%; height:100%; object-fit:cover;
    }
    .discover-list-content{
      flex:1; display:flex; flex-direction:column;
      min-width:0; gap:4px;
    }
    .discover-list-title{
      font-size:16px; font-weight:900; line-height:1.3;
      color:#111; margin:0;
      display:-webkit-box; -webkit-line-clamp:2;
      -webkit-box-orient:vertical; overflow:hidden;
    }
    .discover-list-provider{
      font-size:13px; font-weight:500; color:#666;
      margin:0; line-height:1.3;
    }
    .discover-list-meta{
      display:flex; align-items:center; gap:8px;
      margin-top:4px; flex-wrap:wrap;
    }
    .discover-list-price{
      font-size:18px; font-weight:900; color:var(--brand);
      margin:0;
    }
    .discover-list-info{
      font-size:12px; color:#999;
      display:flex; align-items:center; gap:4px;
    }
    .discover-list-info .ico-inline{
      width:16px; height:16px; flex-shrink:0;
      color:var(--muted);
    }
    .discover-list-info .ico-inline svg{
      width:16px; height:16px;
    }
    .discover-list-badges{
      display:flex; gap:6px; flex-wrap:wrap;
      margin-top:6px;
    }
    .discover-list-badge{
      display:inline-flex; align-items:center; gap:3px;
      padding:4px 8px; border-radius:6px;
      font-size:10px; font-weight:700;
      background:rgba(0,0,0,.05); color:#666;
    }
    .discover-list-badge .ico-inline{
      width:14px; height:14px; flex-shrink:0;
    }
    .discover-list-badge .ico-inline svg{
      width:14px; height:14px;
    }
    .discover-list-badge.code{
      background:rgba(255,204,0,.15); color:#b8860b;
    }
    .discover-list-badge.dine{
      background:rgba(31,157,85,.1); color:#1f9d55;
    }
    .discover-list-badge.pickup{
      background:rgba(0,0,0,.05); color:#666;
    }
    .discover-list-actions{
      margin-top:auto; padding-top:8px;
    }
    .discover-list-btn{
      width:100%; padding:10px 14px; border-radius:10px;
      border:none; font-weight:900; font-size:14px;
      cursor:pointer; transition:transform .1s, background .15s;
      text-align:center; background:var(--brand); color:#111;
      display:flex; align-items:center; justify-content:center; gap:6px;
    }
    .discover-list-btn .ico-inline{
      width:18px; height:18px; flex-shrink:0;
    }
    .discover-list-btn .ico-inline svg{
      width:18px; height:18px;
    }
    .discover-list-btn:active{
      transform:scale(.97);
      background:#e6b800;
    }
    
    /* Back Navigation */
    .back-button{
      position:absolute; top:12px; left:12px;
      width:40px; height:40px;
      border-radius:50%; border:none;
      background:rgba(255,255,255,.9);
      backdrop-filter:blur(10px);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; z-index:10;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
    }
    .back-button i{
      width:20px; height:20px;
    }

    /* Chat-Bubbles Feed */
    .feed-container{
      max-width:980px; margin:0 auto; padding:0 14px 20px;
    }
    .chat-bubble{
      background:#fff; border:1px solid var(--border);
      border-radius:var(--radius); padding:16px;
      margin-bottom:16px; box-shadow:0 4px 12px rgba(0,0,0,.06);
      position:relative;
    }
    .chat-bubble-header{
      display:flex; align-items:center; gap:12px; margin-bottom:12px;
    }
    .chat-bubble-avatar{
      width:44px; height:44px; border-radius:50%;
      overflow:hidden; flex:0 0 auto;
      border:2px solid var(--border);
    }
    .chat-bubble-avatar img{
      width:100%; height:100%; object-fit:cover;
    }
    .chat-bubble-meta{
      flex:1; min-width:0;
    }
    .chat-bubble-name{
      font-weight:900; font-size:17px; margin-bottom:4px; line-height:1.3;
    }
    .chat-bubble-time{
      font-size:13px; color:var(--muted);
      display:flex; align-items:center; gap:6px; line-height:1.4;
    }
    .chat-bubble-distance{
      position:absolute; top:16px; right:16px;
      font-size:12px; font-weight:700; color:var(--muted);
      background:#f8f7f3; padding:5px 10px; border-radius:999px;
    }
    .chat-bubble-message{
      font-size:16px; line-height:1.6; color:var(--text);
      margin-bottom:14px;
    }
    .chat-bubble-image{
      width:100%; border-radius:16px; overflow:hidden;
      margin-bottom:12px; max-height:300px; object-fit:cover;
    }
    .chat-bubble-actions{
      display:flex; gap:10px; margin-top:12px;
    }
    .chat-bubble-btn{
      flex:1; padding:12px; border-radius:12px;
      border:none; font-weight:900; font-size:14px;
      cursor:pointer; transition:transform .1s;
    }
    .chat-bubble-btn:active{transform:scale(.98)}
    .chat-bubble-btn-primary{
      background:var(--brand); color:#111;
    }
    .chat-bubble-btn-secondary{
      background:#f8f7f3; border:1px solid var(--border); color:var(--text);
    }
    .feed-empty{
      max-width:980px; margin:0 auto;
    }
  </style>
</head>
<body>
<div class="app" id="app">
  <div class="topbar" id="topbar">
    <div class="topbar-inner">
      <div class="brand" role="button" aria-label="Mittagio">
        <div class="brand-badge"><img src="assets/mittagio-logo.png" alt="Mittagio" onerror="this.style.display='none'" /></div>
        <div class="brand-name">MITTAGIO</div>
      </div>
      <div class="spacer"></div>
      <div id="modePill" class="prov-pill" style="display:none;">Dashboard</div>
    </div>
  </div>

  <main>
    <!-- START - Lunch-Feed (Social Style) -->
    <section class="view" id="v-start">
      <!-- Standort-Suche -->
      <div class="panel" style="margin-top:12px;">
        <div class="section-title">Entdecken</div>
        <div class="loc-row" style="margin-top:8px;">
          <input class="field" id="startLocationInput" type="text" placeholder="Ort oder PLZ eingeben" />
          <button class="pin-btn" type="button" id="btnStartLocationPin" aria-label="Standort setzen"></button>
        </div>
      </div>

      <!-- Filter: Kategorien und Tage -->
      <div style="height:10px"></div>
      <div class="hint" style="padding:0 14px;">Kategorien</div>
      <div class="chiprow" id="startCatChips"></div>
      <div class="hint" style="margin-top:6px; padding:0 14px;">Datum</div>
      <div class="dayrow" id="startDayChips"></div>
      <div class="answers" style="margin-top:6px; padding:0 14px;">
        <button class="ans" type="button" id="btnStartNear" data-icon="location">In der N√§he</button>
      </div>

      <!-- Angebots-Grid (normale Kacheln) -->
      <div class="section-title" style="margin-top:8px; padding:0 14px;">Heute in deiner N√§he</div>
      <div class="grid" id="startOfferGrid"></div>
      <p class="hint" id="startEmptyOffers" style="display:none; text-align:center; padding:40px 20px;">
        Noch keine Angebote. Demo: Als Anbieter ein Inserat erstellen.
      </p>
    </section>

    <!-- CUSTOMER: Discover - App-like UX (Final Spec) -->
    <section class="view active" id="v-discover">
      <!-- Header: Kompakte Standort-Pill (44-48px) -->
      <div class="discover-header">
        <div class="discover-location-pill">
          <i data-lucide="map-pin" class="discover-location-icon-left"></i>
          <input type="text" class="discover-location-input" id="discoverLocationInput" placeholder="Ort oder PLZ" />
          <button class="discover-location-btn" type="button" id="btnDiscoverLocationSearch" aria-label="Standort suchen">
            <i data-lucide="search"></i>
          </button>
        </div>
      </div>

      <!-- Kategorien (horizontal swipebar, ohne √úberschrift) -->
      <div class="discover-categories">
        <div class="discover-categories-scroll" id="discoverCategories">
          <!-- Wird dynamisch bef√ºllt -->
        </div>
      </div>

      <!-- Kalender (horizontal swipebar, ohne √úberschrift) -->
      <div class="discover-calendar">
        <div class="discover-calendar-scroll" id="discoverCalendar">
          <!-- Wird dynamisch bef√ºllt -->
        </div>
      </div>

      <!-- Angebots-Liste (horizontale List-Cards) -->
      <div class="discover-offers" id="discoverOffers">
        <!-- Wird dynamisch bef√ºllt -->
      </div>
      <!-- Leerer Zustand (wenn keine Angebote) -->
      <div id="discoverEmpty" style="display:none; text-align:center; padding:80px 20px;">
        <div style="font-size:64px; margin-bottom:20px; opacity:.6;">üçΩÔ∏è</div>
        <div style="font-size:18px; font-weight:900; margin-bottom:10px; color:#333; line-height:1.4;">
          Noch keine Mittagsangebote in deiner N√§he
        </div>
        <div style="display:flex; flex-direction:column; gap:12px; max-width:280px; margin:24px auto 0;">
          <button class="btn" type="button" onclick="const q=prompt('Neuer Standort:'); if(q){locationQuery=q; renderDiscover();}" style="width:100%;">
            Standort √§ndern
          </button>
          <button class="btn secondary" type="button" onclick="setMode('provider')" style="width:100%;">
            Als Anbieter starten
          </button>
        </div>
      </div>
    </section>

    <section class="view" id="v-provider-billing">
      <!-- Kosten-Info-Box (ganz oben) -->
      <div class="panel" id="billingCostInfo" style="background:#f0f7f0; border:1px solid #4caf50; margin-bottom:12px;">
        <!-- Wird dynamisch bef√ºllt -->
      </div>
      
      <div class="panel">
        <h3>Abrechnungen</h3>
        <div class="hint">Auszahlbarer Betrag</div>
        <div style="font-size:24px;font-weight:900" id="billingAmount">0,00 ‚Ç¨</div>
        <div class="hint" id="billingLast">Letzte Auszahlung: ‚Äì</div>
      </div>

      <div style="height:12px"></div>
      <div class="panel">
        <div class="hint">Filter</div>
        <div class="answers" id="billingFilters"></div>
        <div style="height:8px"></div>
        <select class="field" id="billingMonth">
          <option value="2026-01">Januar 2026</option>
          <option value="2025-12">Dezember 2025</option>
          <option value="2025-11">November 2025</option>
        </select>
        <div style="height:10px"></div>
        <div id="billingList" class="hint">Noch keine Abrechnungen.</div>
      </div>

      <div style="height:12px"></div>
      <button class="btn ghost" type="button" id="btnBillingBack">Zur√ºck</button>
    </section>

    <!-- CUSTOMER: Favorites -->
    <section class="view" id="v-fav">
      <div class="panel">
        <div class="section-title">Anbieter-Favoriten</div>
        <div class="grid" id="favProviders"></div>
        <div class="hint" id="emptyFavProviders" style="display:none;">Noch keine Anbieter-Favoriten.</div>
        <div class="section-title" style="margin-top:12px;">Gericht-Favoriten</div>
        <div class="grid" id="favDishes"></div>
        <div class="hint" id="emptyFavDishes" style="display:none;">Noch keine Gericht-Favoriten.</div>
      </div>
    </section>

    <!-- CUSTOMER: Orders -->
    <section class="view" id="v-orders">
      <div class="panel">
        <h3>Mittagsbox</h3>
        <div class="hint">Deine aktiven Tickets (Abholcodes)</div>
        <div class="answers" id="ordersFilters" style="margin-top:12px;"></div>
        <div style="height:10px"></div>
        <div id="ordersList" class="hint">Noch keine Bestellungen.</div>
      </div>
    </section>

    <!-- CUSTOMER: Cart -->
    <section class="view" id="v-cart">
      <div class="panel">
        <h3>Warenkorb</h3>
        <div id="cartBox" class="hint">Dein Warenkorb ist leer.</div>
        <button class="btn" id="btnCheckout" type="button" style="display:none;" data-icon="card">Weiter zur Zahlung</button>
        <div class="mini" id="cartNote" style="display:none;">
          Ein Anbieter pro Bestellung ¬∑ Zahlung per Stripe ¬∑ Abholcode nach Zahlung
        </div>
      </div>
    </section>

    <!-- CUSTOMER: Pickup Code (AbholcodeScreen) -->
    <section class="view" id="v-pickup-code">
      <div class="panel">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
          <button class="back-button" type="button" id="btnPickupCodeBack" aria-label="Zur√ºck">
            <i data-lucide="arrow-left"></i>
          </button>
          <h3 style="margin:0; flex:1;">Abholcode</h3>
        </div>
        
        <!-- Status & Hinweis -->
        <div style="text-align:center; margin-bottom:24px;">
          <div style="font-size:16px; font-weight:700; color:#1f9d55; margin-bottom:8px;">
            ‚úì Bestellung best√§tigt
          </div>
          <div class="hint" style="font-size:13px;">
            Bitte diesen Code beim Abholen zeigen
          </div>
        </div>
        
        <!-- Code-Kachel (normal gro√ü) -->
        <div id="pickupCodeCard" style="background:#fff; border:2px solid var(--brand); border-radius:18px; padding:24px; text-align:center; margin-bottom:20px;">
          <div class="hint" style="font-size:12px; margin-bottom:8px; color:#666;">Abholcode</div>
          <div id="pickupCodeValue" style="font-size:48px; font-weight:900; font-family:monospace; letter-spacing:4px; color:#111; margin-bottom:12px;">
            ‚Äì
          </div>
          <button class="btn secondary" type="button" id="btnCopyCode" style="width:100%; min-height:44px;">
            <i data-lucide="copy"></i> Code kopieren
          </button>
        </div>
        
        <!-- Primary CTA: Code gro√ü anzeigen -->
        <button class="btn" type="button" id="btnShowFullscreenCode" style="width:100%; margin-bottom:16px; min-height:44px;">
          <i data-lucide="maximize-2"></i> Code gro√ü anzeigen
        </button>
        
        <!-- Bestellinfos kompakt -->
        <div id="pickupCodeInfo" style="background:#f8f8f8; border-radius:14px; padding:16px; margin-bottom:16px;">
          <div class="row" style="margin-bottom:8px;"><span>Gericht</span><b id="pickupCodeDish">‚Äì</b></div>
          <div class="row" style="margin-bottom:8px;"><span>Anbieter</span><b id="pickupCodeProvider">‚Äì</b></div>
          <div class="row" style="margin-bottom:8px;"><span>Abholzeit</span><b id="pickupCodeTime">‚Äì</b></div>
          <div class="row" style="margin-bottom:8px;"><span>Art</span><b id="pickupCodeType">‚Äì</b></div>
          <div class="row" style="margin-top:12px; padding-top:12px; border-top:1px solid #ddd;"><span style="font-size:16px; font-weight:900;">Gesamt</span><b style="font-size:16px;" id="pickupCodeTotal">‚Äì</b></div>
        </div>
        
        <!-- Secondary Buttons -->
        <div style="display:flex; flex-direction:column; gap:10px;">
          <button class="btn secondary" type="button" id="btnOpenRoute" style="width:100%; min-height:44px;">
            <i data-lucide="map-pin"></i> Route √∂ffnen
          </button>
          <!-- Zur Mittagsbox entfernt (nicht f√ºr Endkunden) -->
        </div>
      </div>
    </section>

    <!-- CUSTOMER: Profile ("Mein Mittagio") - MVP Final -->
    <section class="view" id="v-profile">
      <!-- Header -->
      <div style="padding:16px 16px 20px; background:transparent; border:none; box-shadow:none;">
        <h2 style="margin:0; font-size:24px; font-weight:900; line-height:1.2;">Dein Mittag in der N√§he</h2>
      </div>

      <!-- Welcome Card (dynamic) -->
      <div class="panel" id="profileWelcomeCard" style="margin-top:0; padding:16px; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.04);">
        <!-- Wird dynamisch bef√ºllt -->
      </div>

      <!-- K√ºrzlich angesehen -->
      <div class="panel" id="profileRecentlyViewed" style="margin-top:18px; padding:16px; display:none; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.04);">
        <div style="font-weight:600; font-size:17px; margin-bottom:10px; line-height:1.3;">K√ºrzlich angesehen</div>
        <div id="profileRecentlyViewedList" style="margin-bottom:12px;"></div>
        <button class="btn secondary" type="button" id="btnProfileViewAllRecent" style="width:100%; min-height:44px; display:none;">
          Angebote ansehen
        </button>
      </div>

      <!-- Reorder Teaser -->
      <div class="panel" id="profileReorderTeaser" style="margin-top:18px; padding:16px; display:none; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.04);">
        <div style="font-weight:600; font-size:17px; margin-bottom:10px; line-height:1.3;">Wieder bei bekannten Anbietern</div>
        <div class="hint" id="profileReorderHelper" style="font-size:13px; line-height:1.4; margin-bottom:12px; color:var(--muted); display:none;">
          Bestelle erneut bei Anbietern, die dir gefallen haben.
        </div>
        <div id="profileReorderProviders"></div>
      </div>

      <!-- Personal Data - ENTFERNT (Endkunden haben kein Profil) -->
      <div class="panel" id="profilePersonalData" style="margin-top:18px; padding:16px; display:none; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.04);">
        <!-- Endkunden haben kein Profil - dieser Bereich wird nicht angezeigt -->
      </div>

      <!-- Provider Area -->
      <div class="panel" style="margin-top:18px; padding:16px; background:linear-gradient(135deg, rgba(255,204,0,.08) 0%, rgba(255,204,0,.03) 100%); border:1px solid rgba(255,204,0,.15); border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.04);">
        <div style="font-weight:600; font-size:17px; margin-bottom:8px; line-height:1.3;">Als Anbieter starten</div>
        <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:14px; color:var(--muted);">
          Mittagtische einfach online anbieten
        </div>
        <button class="btn secondary" type="button" id="btnGoToProvider" style="width:100%; min-height:44px;">
          Zum Anbieterbereich
        </button>
      </div>

      <!-- FAQ (reduced) -->
      <div class="panel" style="margin-top:18px; padding:16px; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.04);">
        <div style="font-weight:600; font-size:17px; margin-bottom:12px; line-height:1.3;">H√§ufige Fragen</div>
        <div class="faq" id="profileFaqReduced" style="margin-bottom:12px;">
          <details>
            <summary style="font-size:14px; line-height:1.4; font-weight:500;">Wie funktioniert Mittagio?</summary>
            <p style="font-size:14px; line-height:1.5; margin-top:8px; color:var(--muted);">Du findest Mittagsangebote in deiner Stadt, optional bezahlst du online und holst zur gew√§hlten Zeit ab.</p>
          </details>
          <details>
            <summary>Ist Online-Zahlung Pflicht?</summary>
            <p>Nein. Online-Zahlung ist optional. Eine Abholnummer gibt‚Äôs nur bei Online-Zahlung.</p>
          </details>
          <details>
            <summary>Was ist der Abholcode?</summary>
            <p>Dein Schnell-Ticket f√ºr die Mittagspause.</p>
          </details>
          <details>
            <summary>Kann ich ohne Abholcode bestellen?</summary>
            <p>Nein. Angebote ohne Abholcode kannst du nur ansehen.</p>
          </details>
          <details>
            <summary>Wann kann ich abholen?</summary>
            <p>Innerhalb der Essenszeit. W√§hle eine ungef√§hre Abholzeit im Warenkorb.</p>
          </details>
          <details>
            <summary>Kann ich f√ºr mehrere Personen bestellen?</summary>
            <p>Ja. Du kannst mehrere Gerichte in einem Vorgang bestellen (eine Abholnummer).</p>
          </details>
          <details>
            <summary>Vor Ort essen m√∂glich?</summary>
            <p>Wenn das Badge ‚ÄûVor Ort‚Äú angezeigt wird, kannst du vor Ort essen.</p>
          </details>
          <details>
            <summary>Teilen</summary>
            <p>Teile Angebote per WhatsApp, Instagram oder Website.</p>
          </details>
          <details>
            <summary>Kontakt</summary>
            <p>Bei Fragen schreib uns an <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a></p>
          </details>
        </div>
        <a href="#" id="btnProfileShowMoreFaq" style="display:inline-block; font-size:13px; color:var(--muted); text-decoration:none; margin-top:4px;">
          Weitere Fragen anzeigen ‚Üí
        </a>
      </div>

      <!-- Legal (bottom, small) -->
      <div style="margin-top:20px; padding:16px 16px 24px; text-align:center;">
        <div style="display:flex; flex-wrap:wrap; justify-content:center; gap:12px 16px; font-size:12px; margin-bottom:10px;">
          <a href="#/impressum" id="btnProfileImpressum" onclick="showLegalPage('impressum'); return false;" style="color:var(--muted); text-decoration:none;">Impressum</a>
          <a href="#/agb-kurz" id="btnProfileAGB" onclick="showLegalPage('agb-kurz'); return false;" style="color:var(--muted); text-decoration:none;">AGB</a>
          <a href="#/datenschutz" id="btnProfileDatenschutz" onclick="showLegalPage('datenschutz'); return false;" style="color:var(--muted); text-decoration:none;">Datenschutz</a>
        </div>
        <div style="font-size:12px; color:var(--muted);">
          <a href="mailto:support@mittagio.de" style="color:var(--muted); text-decoration:none;">support@mittagio.de</a>
        </div>
      </div>
    </section>

    <!-- PROVIDER: Login page (f√ºr direkten Zugriff) -->
    <section class="view" id="v-provider-login">
      <div class="panel">
        <h3>Anbieter-Login</h3>
        <div class="hint">Melde dich als Gastronom an</div>
        <input class="field" id="provEmail" type="email" placeholder="E-Mail" autocomplete="email" style="margin-top:12px;" />
        <div style="height:10px"></div>
        <input class="field" id="provPass" type="password" placeholder="Passwort" autocomplete="current-password" />
        <button class="btn" type="button" id="btnProvLogin" style="margin-top:16px;">Einloggen</button>
        <button class="btn secondary" type="button" id="btnProvBack" style="margin-top:8px;">Zur√ºck</button>
        <p class="hint" style="margin-top:12px;">Demo: beliebige E-Mail/Passwort -> du bist drin. (Sp√§ter: Firebase Auth.)</p>
      </div>
    </section>

    <!-- PROVIDER: Onboarding (ALT - wird durch Hybrid Onboarding ersetzt) -->
    <section class="view" id="v-provider-onboarding" style="display:none;">
      <!-- Schritt 1: Betriebsname -->
      <div class="panel onboarding-step" data-step="1">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 1 von 5</div>
          <button class="btn ghost" type="button" id="btnOnboardingBack" style="width:auto; padding:8px 12px; margin-top:8px;">
            ‚Üê Zur√ºck
          </button>
        </div>
        <h3 style="margin-top:16px;">Wie hei√üt dein Betrieb?</h3>
        <div class="hint">Gib den Namen deines Restaurants, Caf√©s oder Betriebs ein.</div>
        <input class="field" id="onboardingBusinessNameOld" type="text" placeholder="z.B. Caf√© Sonnenschein" style="margin-top:12px;" />
        <button class="btn" type="button" id="btnOnboardingStep1Next" style="margin-top:16px;">Weiter</button>
      </div>

      <!-- Schritt 2: Adresse -->
      <div class="panel onboarding-step" data-step="2" style="display:none;">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 2 von 5</div>
          <button class="btn ghost" type="button" id="btnOnboardingStep2Back" style="width:auto; padding:8px 12px; margin-top:8px;">
            ‚Üê Zur√ºck
          </button>
        </div>
        <h3 style="margin-top:16px;">Adresse deines Betriebs</h3>
        <div class="hint">Wo k√∂nnen G√§ste dein Essen abholen?</div>
        <div class="loc-row" style="margin-top:12px;">
          <input class="field" id="onboardingAddress" type="text" placeholder="Stra√üe und Hausnummer" />
          <button class="pin-btn" type="button" id="btnOnboardingLocationPin" aria-label="Standort setzen"></button>
        </div>
        <input class="field" id="onboardingPostalCode" type="text" placeholder="PLZ" style="margin-top:10px;" />
        <input class="field" id="onboardingCity" type="text" placeholder="Stadt" style="margin-top:10px;" />
        <button class="btn" type="button" id="btnOnboardingStep2Next" style="margin-top:16px;">Weiter</button>
      </div>

      <!-- Schritt 3: Essenszeit -->
      <div class="panel onboarding-step" data-step="3" style="display:none;">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 3 von 5</div>
          <button class="btn ghost" type="button" id="btnOnboardingStep3Back" style="width:auto; padding:8px 12px; margin-top:8px;">
            ‚Üê Zur√ºck
          </button>
        </div>
        <h3 style="margin-top:16px;">Wann k√∂nnen G√§ste dein Essen genie√üen?</h3>
        <div class="hint">W√§hle die Standard-Zeiten f√ºr deine Essensausgabe.</div>
        
        <div style="margin-top:16px;">
          <div class="hint" style="margin-bottom:6px;">Startzeit</div>
          <div class="w-actions">
            <button class="btn secondary time-btn" type="button" data-time="11:00">11:00</button>
            <button class="btn secondary time-btn" type="button" data-time="11:30">11:30</button>
            <button class="btn secondary time-btn" type="button" data-time="12:00">12:00</button>
            <button class="btn secondary time-btn" type="button" data-time="12:30">12:30</button>
          </div>
          <input class="field" id="onboardingMealStart" type="time" placeholder="Startzeit" style="margin-top:10px;" />
        </div>

        <div style="margin-top:16px;">
          <div class="hint" style="margin-bottom:6px;">Endzeit</div>
          <div class="w-actions">
            <button class="btn secondary time-btn" type="button" data-time="14:00">14:00</button>
            <button class="btn secondary time-btn" type="button" data-time="14:30">14:30</button>
            <button class="btn secondary time-btn" type="button" data-time="15:00">15:00</button>
            <button class="btn secondary time-btn" type="button" data-time="15:30">15:30</button>
          </div>
          <input class="field" id="onboardingMealEnd" type="time" placeholder="Endzeit" style="margin-top:10px;" />
        </div>

        <button class="btn" type="button" id="btnOnboardingStep3Next" style="margin-top:20px;">Weiter</button>
      </div>

      <!-- Schritt 4: Logo -->
      <div class="panel onboarding-step" data-step="4" style="display:none;">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 4 von 5</div>
          <button class="btn ghost" type="button" id="btnOnboardingStep4Back" style="width:auto; padding:8px 12px; margin-top:8px;">
            ‚Üê Zur√ºck
          </button>
        </div>
        <h3 style="margin-top:16px;">Logo hochladen</h3>
        <div class="hint">Optional: Lade ein Logo f√ºr deinen Betrieb hoch. Du kannst das auch sp√§ter machen.</div>
        
        <div style="margin-top:20px; text-align:center;">
          <div class="onboarding-logo-preview" id="onboardingLogoPreview" style="width:120px; height:120px; margin:0 auto; border-radius:18px; border:2px dashed var(--border); background:#f8f7f3; display:flex; align-items:center; justify-content:center; cursor:pointer; position:relative; overflow:hidden;">
            <div style="text-align:center; color:var(--muted); font-size:12px;">
              <div style="font-size:32px; margin-bottom:8px;">üì∑</div>
              <div>Logo hinzuf√ºgen</div>
            </div>
            <img id="onboardingLogoImg" style="display:none; width:100%; height:100%; object-fit:cover;" />
          </div>
          <input type="file" id="onboardingLogoInput" accept="image/*" style="display:none;" />
          <button class="btn secondary" type="button" id="btnOnboardingLogoRemove" style="margin-top:12px; display:none;">Logo entfernen</button>
        </div>

        <button class="btn" type="button" id="btnOnboardingStep4Next" style="margin-top:20px;">Weiter</button>
        <button class="btn ghost" type="button" id="btnOnboardingSkipLogo" style="margin-top:8px;">√úberspringen</button>
      </div>

      <!-- Schritt 5: Zusammenfassung -->
      <div class="panel onboarding-step" data-step="5" style="display:none;">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 5 von 5</div>
        </div>
        <h3 style="margin-top:16px;">Profil ist bereit! üéâ</h3>
        <div class="hint">Hier ist eine Zusammenfassung deiner Angaben:</div>
        
        <div class="onboarding-summary" style="margin-top:20px; padding:16px; background:#f8f7f3; border-radius:14px; border:1px solid var(--border);">
          <div class="onboarding-summary-item" style="margin-bottom:12px;">
            <div style="font-weight:900; font-size:14px;" id="summaryBusinessName">‚Äì</div>
            <div class="hint" id="summaryAddress" style="margin-top:4px;">‚Äì</div>
          </div>
          <div class="onboarding-summary-item" style="margin-bottom:12px;">
            <div class="hint" style="margin-bottom:4px;">Essenszeit</div>
            <div style="font-weight:900;" id="summaryMealTime">‚Äì</div>
          </div>
          <div class="onboarding-summary-item" id="summaryLogoContainer" style="display:none;">
            <div class="hint" style="margin-bottom:4px;">Logo</div>
            <div id="summaryLogo" style="width:60px; height:60px; border-radius:12px; overflow:hidden; border:1px solid var(--border);">
              <img id="summaryLogoImg" style="width:100%; height:100%; object-fit:cover;" />
            </div>
          </div>
        </div>

        <button class="btn" type="button" id="btnOnboardingComplete" style="margin-top:24px;">Erstes Gericht erstellen</button>
        <button class="btn secondary" type="button" id="btnOnboardingEdit" style="margin-top:8px;">Angaben bearbeiten</button>
      </div>
    </section>

    <!-- PROVIDER: Hybrid Onboarding -->
    <section class="view" id="v-provider-onboarding-entry">
      <div class="panel" style="padding:24px; text-align:center; max-width:480px; margin:40px auto;">
        <h1 style="font-size:28px; font-weight:900; margin-bottom:16px; line-height:1.2;">Dein Mittag. Lokal. Frisch. Digital.</h1>
        <p style="font-size:16px; line-height:1.5; margin-bottom:32px; color:var(--muted);">
          Starte mit deinem ersten Gericht.
        </p>
        <button class="btn-primary" type="button" id="btnOnboardingEntryStart" style="width:100%; min-height:56px; margin-bottom:12px;">
          Gericht anlegen
        </button>
        <button class="btn secondary" type="button" id="btnOnboardingEntryLater" style="width:100%; min-height:44px;">
          Sp√§ter starten
        </button>
        <div style="margin-top:24px; font-size:12px; color:var(--muted);">
          Kein Abo ¬∑ Keine Verpflichtung
        </div>
      </div>
    </section>

    <section class="view" id="v-provider-onboarding-first-dish">
      <div class="panel" style="padding:20px;">
        <h2 style="font-size:20px; font-weight:900; margin-bottom:20px;">Erstes Gericht anlegen</h2>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">Gerichtname *</label>
          <input class="field" type="text" id="onboardingDishName" placeholder="z.B. K√ºrbissuppe" required />
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">Abholzeit von *</label>
          <input class="field" type="time" id="onboardingPickupTimeStart" required />
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">Abholzeit bis *</label>
          <input class="field" type="time" id="onboardingPickupTimeEnd" required />
        </div>
        
        <div style="margin-bottom:24px;">
          <button class="btn secondary" type="button" id="btnOnboardingAddPhoto" style="width:100%; min-height:44px;">
            <i data-lucide="camera"></i><span>Foto hinzuf√ºgen</span>
          </button>
          <div id="onboardingPhotoPreview" style="display:none; margin-top:12px;">
            <img id="onboardingPhotoPreviewImg" style="width:100%; max-height:200px; object-fit:cover; border-radius:12px;" />
          </div>
        </div>
        
        <div style="display:flex; gap:12px;">
          <button class="btn secondary" type="button" id="btnOnboardingFirstDishBack" style="flex:1; min-height:44px;">
            Zur√ºck
          </button>
          <button class="btn-primary" type="button" id="btnOnboardingFirstDishNext" style="flex:1; min-height:56px;">
            Weiter
          </button>
        </div>
      </div>
    </section>

    <section class="view" id="v-provider-onboarding-signup">
      <div class="panel" style="padding:20px;">
        <h2 style="font-size:20px; font-weight:900; margin-bottom:8px;">Speichern & weitermachen</h2>
        <p style="font-size:14px; line-height:1.5; margin-bottom:24px; color:var(--muted);">
          Erstelle ein Konto, um dein Gericht zu speichern und jederzeit weiterzumachen.
        </p>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">E-Mail *</label>
          <input class="field" type="email" id="onboardingEmail" placeholder="deine@email.de" required autocomplete="email" />
        </div>
        
        <div style="margin-bottom:24px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">Passwort *</label>
          <input class="field" type="password" id="onboardingPassword" placeholder="Mindestens 8 Zeichen" required autocomplete="new-password" />
        </div>
        
        <button class="btn-primary" type="button" id="btnOnboardingSignupCreate" style="width:100%; min-height:56px; margin-bottom:12px;">
          Konto erstellen
        </button>
        <button class="btn secondary" type="button" id="btnOnboardingSignupLater" style="width:100%; min-height:44px;">
          Sp√§ter
        </button>
        
        <div style="margin-top:16px; font-size:12px; color:var(--muted); text-align:center;">
          Kein Abo ¬∑ jederzeit k√ºndbar
        </div>
      </div>
    </section>

    <section class="view" id="v-provider-onboarding-business">
      <div class="panel" style="padding:20px;">
        <h2 style="font-size:20px; font-weight:900; margin-bottom:20px;">Dein Betrieb</h2>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">Betriebsname *</label>
          <input class="field" type="text" id="onboardingBusinessName" placeholder="z.B. Caf√© Sonnenschein" required />
        </div>
        
        <div style="margin-bottom:24px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">Stadt oder Adresse *</label>
          <input class="field" type="text" id="onboardingCityOrAddress" placeholder="z.B. Stuttgart oder Hauptstra√üe 1, 70173 Stuttgart" required />
        </div>
        
        <div class="hint" style="font-size:13px; margin-bottom:24px; color:var(--muted);">
          Diese Angaben kannst du jederzeit √§ndern.
        </div>
        
        <div style="display:flex; gap:12px;">
          <button class="btn secondary" type="button" id="btnOnboardingBusinessBack" style="flex:1; min-height:44px;">
            Zur√ºck
          </button>
          <button class="btn-primary" type="button" id="btnOnboardingBusinessNext" style="flex:1; min-height:56px;">
            Weiter
          </button>
        </div>
      </div>
    </section>

    <section class="view" id="v-provider-onboarding-preview">
      <div class="panel" style="padding:20px;">
        <h2 style="font-size:20px; font-weight:900; margin-bottom:8px;">So sehen Kunden dein Gericht</h2>
        <p style="font-size:14px; line-height:1.5; margin-bottom:20px; color:var(--muted);">
          So erscheint dein Gericht sp√§ter f√ºr Kunden.
        </p>
        
        <div style="margin-bottom:20px; padding:12px; background:#f0f7f0; border-radius:12px; border:1px solid #4caf50;">
          <div style="font-weight:600; font-size:13px; color:#2e7d32; margin-bottom:4px;">Vorschau ¬∑ noch nicht ver√∂ffentlicht</div>
        </div>
        
        <div id="onboardingPreviewCard" style="margin-bottom:24px;">
          <!-- Wird dynamisch bef√ºllt -->
        </div>
        
        <button class="btn-primary" type="button" id="btnOnboardingPreviewDashboard" style="width:100%; min-height:56px; margin-bottom:12px;">
          Weiter zum Dashboard
        </button>
        <button class="btn secondary" type="button" id="btnOnboardingPreviewEdit" style="width:100%; min-height:44px;">
          Gericht bearbeiten
        </button>
      </div>
    </section>

    <!-- PROVIDER APP - Dashboard (Home) -->
    <section class="view" id="v-provider-home">
      <!-- Provider Identity Card (Header) -->
      <div class="panel" id="providerIdentityCard" style="padding:16px; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.04);">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
          <div class="plogo" id="provCardLogo" style="width:56px; height:56px; border-radius:14px; flex-shrink:0;"></div>
          <div style="flex:1; min-width:0;">
            <div style="font-weight:600; font-size:17px; line-height:1.3; margin-bottom:4px;" id="provCardName">Anbieter</div>
            <div class="hint" id="provCardAddr" style="font-size:13px; line-height:1.4;">Adresse hinzuf√ºgen</div>
          </div>
        </div>
        <button class="btn secondary" type="button" id="btnProviderEditProfile" style="width:100%; min-height:44px;">
          Profil bearbeiten
        </button>
      </div>

      <!-- KPI Dashboard Cards (Row of 3) -->
      <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-top:18px;">
        <div class="panel" id="kpiCardInserate" style="padding:16px; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.04); cursor:pointer; text-align:center;">
          <div style="font-size:24px; font-weight:900; line-height:1.2; margin-bottom:6px;" id="kpiInserateCount">0</div>
          <div style="font-size:13px; color:var(--muted);">Inserate</div>
        </div>
        <div class="panel" id="kpiCardAbholungen" style="padding:16px; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.04); cursor:pointer; text-align:center;">
          <div style="font-size:24px; font-weight:900; line-height:1.2; margin-bottom:6px;" id="kpiAbholungenCount">0</div>
          <div style="font-size:13px; color:var(--muted);">Abholungen</div>
        </div>
        <div class="panel" id="kpiCardKochbuch" style="padding:16px; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.04); cursor:pointer; text-align:center;">
          <div style="font-size:24px; font-weight:900; line-height:1.2; margin-bottom:6px;" id="kpiKochbuchCount">0</div>
          <div style="font-size:13px; color:var(--muted);">Kochbuch</div>
        </div>
      </div>

      <!-- TODAY Card -->
      <div class="panel" id="providerTodayCard" style="margin-top:18px; padding:16px; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.04);">
        <div style="font-weight:600; font-size:17px; margin-bottom:12px; line-height:1.3;" id="providerTodayTitle">Heute</div>
        <div id="providerTodayContent">
          <!-- Wird dynamisch bef√ºllt -->
        </div>
      </div>

      <!-- Active Offers Mini List -->
      <div class="panel" id="providerActiveOffers" style="margin-top:18px; padding:16px; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.04); display:none;">
        <div style="font-weight:600; font-size:17px; margin-bottom:12px; line-height:1.3;">Aktive Inserate</div>
        <div id="providerActiveOffersList"></div>
        <a href="#" id="btnProviderShowAllOffers" style="display:inline-block; font-size:13px; color:var(--muted); text-decoration:none; margin-top:12px;">
          Alle Inserate anzeigen ‚Üí
        </a>
      </div>

      <!-- Week Preview -->
      <div class="panel" id="providerWeekPreview" style="margin-top:18px; padding:16px; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.04);">
        <div style="font-weight:600; font-size:17px; margin-bottom:12px; line-height:1.3;">Wochenvorschau</div>
        <div class="dayrow" id="providerWeekDays" style="padding:0 0 10px; max-width:none; margin-bottom:12px;"></div>
        <div id="providerWeekDayContent" style="min-height:60px;">
          <!-- Wird dynamisch bef√ºllt -->
        </div>
      </div>

      <!-- Empty Dashboard (Welcome Card) - ENTFERNT (kein Onboarding) -->
      <div class="panel" id="providerEmptyDashboard" style="margin-top:18px; padding:20px; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.04); text-align:center; display:none;">
        <!-- Dashboard zeigt nur Inserate, Abholung, Kochbuch + CTA "Inserat erstellen" -->
      </div>

      <!-- FAB (Floating Action Button) -->
      <button class="fab" id="fabProviderAddOffer" type="button" aria-label="Inserat hinzuf√ºgen" style="position:fixed; bottom:90px; right:16px; width:56px; height:56px; border-radius:28px; background:var(--brand); color:#111; border:none; box-shadow:0 4px 12px rgba(0,0,0,.2); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:900; z-index:20;">
        +
      </button>
      <div id="fabProviderAddOfferLabel" style="position:fixed; bottom:154px; right:16px; background:rgba(0,0,0,.8); color:#fff; padding:6px 12px; border-radius:8px; font-size:13px; white-space:nowrap; pointer-events:none; opacity:0; transition:opacity .2s; z-index:21;">
        + Inserat
      </div>
    </section>

    <section class="view" id="v-provider-pickups">
      <div class="panel" style="padding:16px;">
        <h3 style="margin:0 0 8px; font-size:24px; font-weight:900; line-height:1.2;">Abholungen</h3>
        <div id="provPickupsSubheader" class="hint" style="font-size:14px; margin-bottom:16px; color:var(--muted);">
          <!-- Wird dynamisch bef√ºllt -->
        </div>
        
        <!-- Filter Toggle -->
        <div class="answers" id="provPickupFilter" style="margin-bottom:16px;">
          <!-- Wird dynamisch bef√ºllt -->
        </div>
        
        <!-- Empty States -->
        <div id="provPickupsEmpty" class="hint" style="text-align:center; padding:40px 20px; display:none;">
          <!-- Wird dynamisch bef√ºllt -->
        </div>
        
        <!-- Pickup List -->
        <div id="provPickupsList" style="display:none;">
          <!-- Wird dynamisch bef√ºllt -->
        </div>
      </div>
    </section>

    <section class="view" id="v-provider-week">
      <div class="panel">
        <h3>Wochenplan</h3>
        <div class="dayrow" id="weekDays" style="padding:0 0 10px; max-width:none;"></div>
        <div id="weekList" style="text-align:center; padding:40px 20px;">
          <div style="font-weight:600; font-size:16px; margin-bottom:8px;">Keine Inserate geplant</div>
          <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:var(--muted);">
            Plane deine Woche und erstelle Inserate.
          </div>
          <button class="btn secondary" type="button" id="btnWeekEmptyAdd" style="width:100%; min-height:44px;">
            Inserat erstellen
          </button>
        </div>
        <button class="btn secondary" type="button" id="btnWeekPdf" data-icon="print" style="display:none; margin-top:12px;">PDF-Wochenkarte erstellen</button>
        <button class="btn ghost" type="button" id="btnWeekBack" style="margin-top:12px;">Zur√ºck</button>
      </div>
    </section>

    <section class="view" id="v-provider-cookbook">
      <div class="panel">
        <h3>Mein Kochbuch</h3>
        <div class="hint">Dein digitales Kochbuch. Immer griffbereit f√ºr deine Planung.</div>
        <div style="height:10px"></div>
        <div class="tabrow" id="cookbookTabs"></div>
        <div style="height:10px"></div>
        <input class="field" id="cookbookSearch" type="text" placeholder="Suche nach Gerichten" />
        <div style="height:10px"></div>
        <div class="hint">Sortierung</div>
        <div class="answers" id="cookbookSorts"></div>
        <button class="btn" type="button" id="btnCookbookAdd" data-icon="plus">Gericht hinzuf√ºgen</button>
        <div style="height:10px"></div>
        <div id="cookbookList" class="hint">Noch keine Gerichte gespeichert.</div>
      </div>
    </section>

    <section class="view" id="v-provider-profile">
      <div class="panel">
        <div class="profile-head">
          <div class="plogo" id="provProfileLogo"></div>
          <div class="profile-meta">
            <div style="font-weight:900" id="provProfileName">Anbieter</div>
            <div class="hint" id="provProfileCity"></div>
            <div class="profile-chip" id="provProfileMeal"></div>
          </div>
        </div>
        <div class="profile-actions">
          <button class="btn" type="button" id="btnProvSetup" data-icon="edit">Profil bearbeiten</button>
        </div>
      </div>

      <div style="height:12px"></div>
      <div class="panel">
        <div class="row-group">
          <div class="rowgroup-title">Profil & Betrieb</div>
          <div class="rowlist">
            <button class="rowbtn" type="button" id="rowProfileOverview">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="user" data-icon-only="1"></div>
                <div class="rowbtn-text">Mein Profil<span>√úbersicht</span></div>
              </div>
              <div class="chev">‚Ä∫</div>
            </button>
            <button class="rowbtn" type="button" id="btnBilling">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="wallet" data-icon-only="1"></div>
                <div class="rowbtn-text">Meine Abrechnungen</div>
              </div>
              <div class="chev">‚Ä∫</div>
            </button>
          </div>
        </div>

        <div class="row-group">
          <div class="rowgroup-title">Aktionen</div>
          <div class="rowlist">
            <button class="rowbtn" type="button" id="btnProvShareOffer">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="share" data-icon-only="1"></div>
                <div class="rowbtn-text">Angebot teilen</div>
              </div>
              <div class="chev">‚Ä∫</div>
            </button>
            <button class="rowbtn" type="button" id="btnProvWeekPdf">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="print" data-icon-only="1"></div>
                <div class="rowbtn-text">Wochenkarte als PDF</div>
              </div>
              <div class="chev">‚Ä∫</div>
            </button>
          </div>
        </div>

        <div class="row-group">
          <div class="rowgroup-title">Hilfe</div>
          <div class="rowlist">
            <button class="rowbtn" type="button" id="btnProvFaq">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="info" data-icon-only="1"></div>
                <div class="rowbtn-text">FAQ</div>
              </div>
              <div class="chev">‚Ä∫</div>
            </button>
            <button class="rowbtn" type="button" id="btnProvSupport">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="mail" data-icon-only="1"></div>
                <div class="rowbtn-text">Support kontaktieren<span>√ñffnet dein Mail-Programm</span></div>
              </div>
              <div class="chev">‚Ä∫</div>
            </button>
          </div>
        </div>

        <div class="row-group">
          <div class="rowgroup-title">Rechtliches & Hilfe</div>
          <div class="rowlist">
            <button class="rowbtn" type="button" id="btnLegalImprint">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="file" data-icon-only="1"></div>
                <div class="rowbtn-text">Impressum</div>
              </div>
              <div class="chev">‚Ä∫</div>
            </button>
            <button class="rowbtn" type="button" id="btnLegalPrivacy">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="shield" data-icon-only="1"></div>
                <div class="rowbtn-text">Datenschutz</div>
              </div>
              <div class="chev">‚Ä∫</div>
            </button>
            <button class="rowbtn" type="button" id="btnLegalTerms">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="file" data-icon-only="1"></div>
                <div class="rowbtn-text">AGB (Kurzfassung)</div>
              </div>
              <div class="chev">‚Ä∫</div>
            </button>
          </div>
        </div>
      </div>

      <div style="height:12px"></div>
      <div class="row-muted">Kein Abo ¬∑ Kein Vertrag ¬∑ Keine Mindestlaufzeit</div>
      <div style="height:12px"></div>
      <button class="btn ghost" type="button" id="btnProvLogout">Logout</button>

      <div id="provFaqBox" style="display:none;">
        
    </section>

    <!-- STATISCHE RECHTSTEXTE-SEITEN -->
    <section class="view" id="v-legal-impressum">
      <div class="panel">
        <h1 style="font-size:24px; font-weight:900; margin-bottom:20px;">Impressum</h1>
        <div style="line-height:1.8; font-size:15px;">
          <p style="font-weight:700; margin-bottom:12px;">Verantwortlich f√ºr den Inhalt:</p>
          <p>
            Mittagio<br>
            Inhaber: Mike Quach<br>
            Lang√§cker 2<br>
            73635 Rudersberg<br>
            Deutschland
          </p>
          <p style="margin-top:16px;">
            <strong>E-Mail:</strong> <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a>
          </p>
          <p style="margin-top:20px; padding-top:20px; border-top:1px solid #eee; font-size:13px; color:#666;">
            <strong>Unternehmensform:</strong> Einzelunternehmen<br>
            <strong>Umsatzsteuer-ID:</strong> nicht vorhanden (¬ß19 UStG)
          </p>
          <p style="margin-top:16px; padding-top:16px; border-top:1px solid #eee; font-size:13px; color:#666;">
            <strong>Plattformhinweis:</strong><br>
            Mittagio vermittelt Mittagsangebote lokaler Anbieter. Vertragspartner bei Bestellungen ist ausschlie√ülich der jeweilige Anbieter.
          </p>
        </div>
        <div style="margin-top:32px; padding-top:20px; border-top:1px solid #eee; text-align:center; font-size:14px; color:#666;">
          Fragen, Hilfe oder Vorschl√§ge? <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a>
        </div>
        <button class="btn ghost" type="button" onclick="history.back()" style="margin-top:20px; width:100%;">Zur√ºck</button>
      </div>
    </section>

    <section class="view" id="v-legal-agb-kurz">
      <div class="panel">
        <h1 style="font-size:24px; font-weight:900; margin-bottom:20px;">AGB (Kurzfassung)</h1>
        <div style="line-height:1.8; font-size:15px;">
          <p><strong>Mittagio ist Plattform, nicht Verk√§ufer</strong></p>
          <p>Mittagio vermittelt Mittagsangebote lokaler Anbieter. Vertragspartner bei Bestellungen ist ausschlie√ülich der jeweilige Anbieter.</p>
          
          <p style="margin-top:20px;"><strong>Kosten f√ºr Anbieter:</strong></p>
          <ul style="padding-left:20px; margin:8px 0;">
            <li>4,99 ‚Ç¨ zzgl. MwSt. pro Ver√∂ffentlichung</li>
            <li>0,89 ‚Ç¨ zzgl. MwSt. pro Online-Bestellung inkl. aller Bank- & Zahlungsgeb√ºhren (pro Bestellung, egal wie viele Gerichte)</li>
          </ul>
          
          <p style="margin-top:20px;"><strong>Abholcode:</strong></p>
          <p>Der Abholcode dient als Zahlungs- & Abholnachweis. Die Abwicklungsgeb√ºhr f√§llt auch bei Nicht-Abholung an.</p>
          
          <p style="margin-top:20px;"><strong>Verantwortung:</strong></p>
          <p>Der Anbieter ist verantwortlich f√ºr Inhalte, Speisen und gesetzliche Vorgaben.</p>
          
          <p style="margin-top:20px;"><strong>Support:</strong></p>
          <p><a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a></p>
        </div>
        <div style="margin-top:32px; padding-top:20px; border-top:1px solid #eee; text-align:center; font-size:14px; color:#666;">
          Fragen, Hilfe oder Vorschl√§ge? <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a>
        </div>
        <button class="btn ghost" type="button" onclick="history.back()" style="margin-top:20px; width:100%;">Zur√ºck</button>
      </div>
    </section>

    <section class="view" id="v-legal-datenschutz">
      <div class="panel">
        <h1 style="font-size:24px; font-weight:900; margin-bottom:20px;">Datenschutzerkl√§rung</h1>
        <div style="line-height:1.8; font-size:15px;">
          <p style="font-weight:700; margin-bottom:12px;">Verantwortlicher:</p>
          <p>
            Mittagio<br>
            Mike Quach<br>
            Lang√§cker 2<br>
            73635 Rudersberg<br>
            Deutschland<br>
            E-Mail: <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a>
          </p>
          
          <p style="margin-top:24px; font-weight:700;">Welche Daten erheben wir?</p>
          
          <p style="margin-top:12px;"><strong>Anbieter:</strong></p>
          <ul style="padding-left:20px; margin:8px 0;">
            <li>Betriebsname</li>
            <li>Kontaktdaten</li>
            <li>Standort/√ñffnungszeiten</li>
            <li>Inserats-/Bestelldaten</li>
            <li>Abrechnungsdaten</li>
          </ul>
          
          <p style="margin-top:12px;"><strong>Kunden:</strong></p>
          <ul style="padding-left:20px; margin:8px 0;">
            <li>Bestelldaten</li>
            <li>Zahlungsstatus</li>
            <li>Abholcode (keine unn√∂tigen personenbezogenen Daten)</li>
          </ul>
          
          <p style="margin-top:24px; font-weight:700;">Online-Zahlung:</p>
          <p>Online-Zahlung erfolgt √ºber externe Zahlungsdienstleister (z.B. Stripe). Wir speichern keine kompletter Zahlungsdaten (z.B. Kreditkartennummern).</p>
          
          <p style="margin-top:24px; font-weight:700;">Zweck des Abholcodes:</p>
          <p>Der Abholcode dient als Zahlungs-/Abholnachweis, zur Zuordnung und zum Missbrauchsschutz.</p>
          
          <p style="margin-top:24px; font-weight:700;">Weitergabe:</p>
          <p>Daten werden nur an Zahlungsdienstleister und wenn gesetzlich erforderlich weitergegeben. Keine Werbeweitergabe.</p>
          
          <p style="margin-top:24px; font-weight:700;">Speicherdauer:</p>
          <p>Daten werden nur so lange gespeichert wie n√∂tig und gem√§√ü gesetzlicher Aufbewahrungspflichten.</p>
          
          <p style="margin-top:24px; font-weight:700;">Ihre Rechte:</p>
          <p>Sie haben das Recht auf Auskunft, Berichtigung, L√∂schung, Einschr√§nkung und Widerspruch. Kontakt: <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a></p>
          
          <p style="margin-top:24px; font-weight:700;">Datensicherheit:</p>
          <p>Wir setzen technische und organisatorische Ma√ünahmen zum Schutz Ihrer Daten ein.</p>
          
          <p style="margin-top:24px; font-weight:700;">√Ñnderungen:</p>
          <p>Diese Datenschutzerkl√§rung kann angepasst werden. Aktuelle Version finden Sie auf dieser Seite.</p>
        </div>
        <div style="margin-top:32px; padding-top:20px; border-top:1px solid #eee; text-align:center; font-size:14px; color:#666;">
          Fragen, Hilfe oder Vorschl√§ge? <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a>
        </div>
        <button class="btn ghost" type="button" onclick="history.back()" style="margin-top:20px; width:100%;">Zur√ºck</button>
      </div>
    </section>


    <section class="view" id="v-legal-agb-onboarding">
      <div class="panel">
        <h2 style="font-size:20px; font-weight:900; margin-bottom:16px;">AGB (Kurzfassung)</h2>
        <div style="line-height:1.7; font-size:14px; max-height:60vh; overflow-y:auto;">
          <p><strong>Mittagio ist Plattform, nicht Verk√§ufer</strong></p>
          <p>Mittagio vermittelt Mittagsangebote lokaler Anbieter. Vertragspartner bei Bestellungen ist ausschlie√ülich der jeweilige Anbieter.</p>
          
          <p style="margin-top:16px;"><strong>Kosten:</strong></p>
          <ul style="padding-left:20px; margin:8px 0;">
            <li>4,99 ‚Ç¨ zzgl. MwSt. pro Ver√∂ffentlichung</li>
            <li>0,89 ‚Ç¨ zzgl. MwSt. pro Online-Bestellung inkl. aller Bank- & Zahlungsgeb√ºhren (pro Bestellung, egal wie viele Gerichte)</li>
          </ul>
          
          <p style="margin-top:16px;"><strong>Abholcode:</strong></p>
          <p>Abholcode = Zahlungs- & Abholnachweis. Abwicklungsgeb√ºhr f√§llt auch bei Nicht-Abholung an.</p>
          
          <p style="margin-top:16px;"><strong>Verantwortung:</strong></p>
          <p>Anbieter ist verantwortlich f√ºr Inhalte/Speisen/gesetzliche Vorgaben.</p>
          
          <p style="margin-top:16px;"><strong>Support:</strong></p>
          <p><a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a></p>
        </div>
      </div>
    </section>
      
      <div id="provFaqBox" style="display:none;">
        <div class="panel">
          <div class="section-title">FAQ (Anbieter)</div>
          <div class="faq">
            <details>
              <summary>Was ist Mittagio?</summary>
              <p>Mittagio ist eine Online-Plattform, auf der du dein Mittagsangebot sichtbar machst ‚Äì schnell, einfach und flexibel.</p>
            </details>
            <details>
              <summary>Wie verdiene ich damit Zeit?</summary>
              <p>Du legst Gerichte einmal an (Kochbuch) und ver√∂ffentlichst sie mit einem Klick. Weniger Telefonate, weniger Chaos.</p>
            </details>
            <details>
              <summary>Muss Online-Zahlung aktiv sein?</summary>
              <p>Nein. Online-Zahlung ist optional. Abholnummern gibt‚Äôs nur bei Online-Zahlung.</p>
            </details>
            <details>
              <summary>Wie kann ich mein Angebot teilen?</summary>
              <p>Mit einem Tap: WhatsApp, Instagram oder Homepage ‚Äì Text ist automatisch vorbereitet.</p>
            </details>
            <details>
              <summary>Kein Abo / keine Provision?</summary>
              <p>Ja. Fixpreis pro Inserat (aktuell 4,99 EUR). Keine Mindestlaufzeit.</p>
            </details>
            <details>
              <summary>Wie funktionieren Abholungen?</summary>
              <p>Wenn Abholcode aktiv ist, werden die Codes nach Gericht gruppiert angezeigt. Tippe einen Code an, sobald ein Gast abgeholt hat.</p>
            </details>
            <details>
              <summary>Warum Abholcode?</summary>
              <p>Vorab bezahlt, weniger Chaos an der Ausgabe und ein klarer Ablauf pro Bestellung.</p>
            </details>
            <details>
              <summary>Was kostet Abholcode?</summary>
              <p>49 Cent pro bezahltem Vorgang. (Auch wenn der Kunde mehrere Gerichte in einem Vorgang holt.)</p>
            </details>
            <details>
              <summary>Wie spare ich Zeit?</summary>
              <p>Speichere Gerichte im Kochbuch und ver√∂ffentliche sie mit 2-3 Taps erneut.</p>
            </details>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- CUSTOMER bottom nav - Mittagio-Bar -->
  <nav class="bottom" id="customerNav">
    <button class="navbtn active" data-go="discover" style="position:relative;">
      <div class="ico"><i data-lucide="utensils-crossed"></i></div>
      <div>Entdecken</div>
    </button>
    <button class="navbtn" data-go="fav" style="position:relative;">
      <div class="ico"><i data-lucide="heart"></i></div>
      <div>Favoriten</div>
    </button>
    <button class="navbtn" data-go="cart" style="position:relative;">
      <div class="ico"><i data-lucide="shopping-cart"></i></div>
      <div>Essenskorb</div>
      <span class="badge-notification" id="cartBadge" style="display:none;"></span>
    </button>
    <button class="navbtn" data-go="orders" style="position:relative;">
      <div class="ico"><i data-lucide="package"></i></div>
      <div>Mittagsbox</div>
    </button>
    <button class="navbtn" data-go="profile" style="position:relative;">
      <div class="ico"><i data-lucide="user"></i></div>
      <div>Profil</div>
    </button>
  </nav>

  <!-- PROVIDER bottom nav -->
  <nav class="bottom" id="providerNav" style="display:none;">
    <button class="navbtn active" data-pgo="provider-home"><div class="ico" data-icon="home" data-icon-only="1"></div><div>Home</div></button>
    <button class="navbtn" data-pgo="provider-pickups"><div class="ico" data-icon="receipt" data-icon-only="1"></div><div>Abholungen</div></button>
    <button class="navbtn" data-pgo="provider-cookbook"><div class="ico" data-icon="bookOpen" data-icon-only="1"></div><div>Kochbuch</div></button>
    <button class="navbtn" data-pgo="provider-profile"><div class="ico" data-icon="user" data-icon-only="1"></div><div>Profil</div></button>
  </nav>
</div>

<!-- Offer sheet -->
<div class="backdrop" id="bd" onclick="closeSheet()"></div>
<div class="sheet" id="sheet">
  <div class="sheet-header" style="position:sticky; top:0; z-index:10; background:var(--card); padding:12px 16px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border);">
    <button class="back-button" type="button" onclick="closeSheet()" aria-label="Zur√ºck" style="background:none; border:none; padding:8px; cursor:pointer;">
      <i data-lucide="arrow-left"></i>
    </button>
    <div style="font-weight:600; font-size:16px;">Angebot</div>
    <button class="share-button-header" type="button" id="btnShareHeader" aria-label="Teilen" style="background:none; border:none; padding:8px; cursor:pointer; color:var(--text-secondary);">
      <i data-lucide="share-2"></i>
    </button>
  </div>
  <div class="handle"></div>
  <div class="sheet-img" style="max-height:220px; overflow:hidden;"><img id="sImg" alt="" style="width:100%; height:auto; object-fit:cover; display:block;" /></div>
  <div class="sheet-body">
    <div style="margin-top:16px;">
      <div style="font-weight:700;font-size:20px; line-height:1.3; margin-bottom:8px;" id="sDish"></div>
      <div style="color:var(--text-secondary);font-size:14px; display:flex; align-items:center; gap:6px; margin-bottom:12px;" id="sProvider">
        ${iconMarkup('store')}<span></span>
      </div>
      <!-- Status Badge (dynamisch) -->
      <div id="sStatusBadge" style="margin-bottom:16px;"></div>
    </div>

    <div class="row"><span>Abholfenster</span><b id="sWindow"></b></div>
    <div class="row"><span>Adresse</span><a id="sAddr" href="#" target="_blank" rel="noopener">√∂ffnen</a></div>
    <div class="row"><span>Entfernung</span><b id="sDistance"></b></div>
    <div class="row"><span>Verf√ºgbar</span><b id="sAvail"></b></div>

    <div id="sAllergensWrap" style="display:none">
      <div class="row"><span>Allergene</span><span id="sAllergens" style="text-align:right;color:var(--muted)"></span></div>
    </div>
    <div id="sExtrasWrap" style="display:none">
      <div class="row"><span>Extras</span><span id="sExtras" style="text-align:right;color:var(--muted)"></span></div>
    </div>
    <div id="sReuseWrap" style="display:none">
      <div class="row"><span>Mehrweg / Pfand</span><span id="sReuse" style="text-align:right;color:var(--muted)"></span></div>
    </div>

    <!-- Badges Row (max 3) -->
    <div class="sheet-badges" id="sBadges" style="display:flex; gap:8px; margin:16px 0; flex-wrap:wrap;"></div>
    
    <!-- Info Row (Icons) -->
    <div class="sheet-info-row" id="sInfoRow" style="display:flex; gap:16px; margin:16px 0; color:var(--text-secondary); font-size:14px;"></div>
    
    <!-- Address Card -->
    <div class="sheet-address-card" style="background:var(--color-soft-grey-bg); border-radius:var(--r-md); padding:16px; margin:16px 0;">
      <div style="font-weight:600; margin-bottom:8px;">Adresse</div>
      <div id="sAddressFull" style="color:var(--text-secondary); font-size:14px; line-height:1.5;"></div>
    </div>
    
    <button class="btn ghost" type="button" id="btnDishFav" style="margin-top:8px;"><i data-lucide="heart"></i><span>Gericht speichern</span></button>
    
    <!-- Bottom Sticky Primary CTA -->
    <div style="position:sticky; bottom:0; background:var(--card); padding:16px 0; margin-top:24px; border-top:1px solid var(--border); z-index:10;">
      <button class="btn-primary" type="button" id="btnPrimaryCTA" style="width:100%; min-height:56px; max-height:64px;">
        <span id="btnPrimaryCTAText"></span>
      </button>
    </div>
  </div>
</div>

<!-- Fullscreen Code Modal (extrem gro√ü, 1-2m lesbar) -->
<!-- Fullscreen Code Modal (extrem gro√ü, 1-2m lesbar) -->
<div class="backdrop" id="fullscreenCodeBd"></div>
<div class="fullscreen-code" id="fullscreenCode">
  <button class="fullscreen-code-close" aria-label="Schlie√üen">
    <i data-lucide="x"></i>
  </button>
  <div class="fullscreen-code-content">
    <div class="fullscreen-code-value" id="fullscreenCodeValue">A  B  1  2  C</div>
    <div class="fullscreen-code-subtext">Bitte dem Personal zeigen</div>
  </div>
</div>

<!-- Provider offer sheet -->
<div class="backdrop" id="pbd" onclick="closeProviderSheet()"></div>
<div class="sheet" id="psheet">
  <div class="handle"></div>
  <div class="sheet-body">
    <div id="pPreview"></div>
    <div class="row"><span>Status</span><b id="pStatus"></b></div>
    <div class="row"><span>Essenszeit</span><b id="pWindow"></b></div>
    <button class="btn" type="button" id="btnEditOffer" data-icon="edit">Bearbeiten</button>
    <button class="btn secondary" type="button" id="btnToggleOffer" data-icon="action">Deaktivieren</button>
    <button class="btn ghost" type="button" id="btnShareOffer" data-icon="share">Teilen</button>
    <button class="btn ghost" type="button" id="btnPrintOffer" data-icon="print">Drucken</button>
  </div>
</div>

<!-- Quick-Ticket (bildschirmf√ºllend) -->
<div class="backdrop" id="codeBd" onclick="closeCodeSheet()"></div>
<div class="quick-ticket" id="codeSheet">
  <button class="quick-ticket-close" onclick="closeCodeSheet()" aria-label="Schlie√üen">
    <i data-lucide="x"></i>
  </button>
  <div class="quick-ticket-content">
    <div class="quick-ticket-header">
      <div class="quick-ticket-logo" id="codeProviderLogo"></div>
      <div class="quick-ticket-provider" id="codeProvider">Anbieter</div>
      <div class="quick-ticket-time" id="codePickupWindow">Essenszeit: ‚Äì</div>
    </div>
    <div class="quick-ticket-code">
      <div class="quick-ticket-code-label">Abholcode</div>
      <div class="quick-ticket-code-value" id="codeText">A1</div>
    </div>
    <div class="quick-ticket-details">
      <div class="quick-ticket-detail-item">
        <div class="quick-ticket-detail-label">Gericht</div>
        <div class="quick-ticket-detail-value" id="codeSummary">‚Äì</div>
      </div>
      <div class="quick-ticket-detail-item">
        <div class="quick-ticket-detail-label">Abholzeit</div>
        <div class="quick-ticket-detail-value" id="codePickupTime">offen</div>
      </div>
    </div>
    <div class="quick-ticket-status" id="codeStatus">Status: offen</div>
    <div class="quick-ticket-actions">
      <button class="btn" type="button" id="btnToggleOrderStatus">Als abgeholt markieren</button>
    </div>
  </div>
</div>

<!-- Legal Sheets (Impressum, AGB, Datenschutz) -->
<div class="backdrop" id="legalBd" onclick="closeLegalSheet()"></div>
<!-- AGB Onboarding Modal (1-Screen) -->
<div class="backdrop" id="agbOnboardingBd" onclick="closeAgbOnboardingModal()"></div>
<div class="sheet" id="agbOnboardingSheet">
  <div class="handle"></div>
  <div class="sheet-body" style="padding:24px;">
    <div id="agbOnboardingContent">
      <!-- Wird dynamisch bef√ºllt -->
    </div>
    <div style="display:flex; gap:12px; margin-top:20px;">
      <button class="btn" type="button" id="btnAgbOnboardingAccept" style="flex:1; min-height:56px;">
        Akzeptieren
      </button>
      <button class="btn secondary" type="button" id="btnAgbOnboardingCancel" style="flex:1; min-height:56px;">
        Abbrechen
      </button>
    </div>
  </div>
</div>

<div class="sheet" id="legalSheet">
  <div class="handle"></div>
  <div class="sheet-body" style="max-height:80vh; overflow-y:auto;">
    <div class="panel" id="legalContent">
      <!-- Wird dynamisch bef√ºllt -->
    </div>
  </div>
</div>

<!-- FAQ Sheet (Alle Fragen) -->
<div class="backdrop" id="faqBd" onclick="closeFaqSheet()"></div>
<div class="sheet" id="faqSheet">
  <div class="handle"></div>
  <div class="sheet-body" style="max-height:85vh; overflow-y:auto; padding:16px;">
    <div style="font-weight:600; font-size:18px; margin-bottom:16px; line-height:1.3;">H√§ufige Fragen</div>
    <div class="faq" id="faqSheetContent">
      <!-- Wird dynamisch bef√ºllt -->
    </div>
  </div>
</div>

<!-- Pickup Confirmation Sheet -->
<div class="backdrop" id="pickupConfirmBd" onclick="closePickupConfirmSheet()"></div>
<div class="sheet" id="pickupConfirmSheet">
  <div class="handle"></div>
  <div class="sheet-body" style="padding:24px;">
    <div style="font-weight:600; font-size:18px; margin-bottom:20px; line-height:1.3; text-align:center;">Abholung best√§tigen</div>
    <div style="font-size:48px; font-weight:900; font-family:monospace; color:var(--brand); margin-bottom:12px; text-align:center; line-height:1;" id="pickupConfirmCode">‚Äì</div>
    <div style="font-size:16px; color:var(--muted); margin-bottom:24px; text-align:center;" id="pickupConfirmDish">‚Äì</div>
    <div style="display:flex; flex-direction:column; gap:12px;">
      <button class="btn" type="button" id="btnPickupConfirmYes" style="width:100%; min-height:56px; font-size:16px; font-weight:600;">
        Als abgeholt markieren
      </button>
      <button class="btn secondary" type="button" id="btnPickupConfirmNo" style="width:100%; min-height:50px; font-size:16px;">
        ‚ùì Doch nicht
      </button>
    </div>
  </div>
</div>

<!-- Login Modal (Bottom Sheet) -->
<div class="backdrop" id="loginBd" onclick="closeLoginSheet()"></div>
<div class="sheet" id="loginSheet">
  <div class="handle"></div>
  <div class="sheet-body">
    <div class="panel">
      <h3 style="margin:0 0 8px;">Anmelden</h3>
      <div class="hint" style="margin-bottom:20px;">Melde dich an, um zu bestellen</div>
      <input class="field" id="loginModalEmail" type="email" placeholder="E-Mail" autocomplete="email" />
      <div style="height:10px"></div>
      <input class="field" id="loginModalPass" type="password" placeholder="Passwort" autocomplete="current-password" />
      <button class="btn" type="button" id="btnLoginModalLogin" style="margin-top:16px; width:100%;">Anmelden</button>
      <div style="margin-top:12px; text-align:center;">
        <button class="btn ghost" type="button" id="btnLoginModalDemo" style="width:auto; padding:8px 16px;">Demo-Login (ohne Anmeldung)</button>
      </div>
    </div>
  </div>
</div>

<!-- Share sheet (MVP: nur WhatsApp + E-Mail) -->
<div class="backdrop" id="shareBd" onclick="closeShareSheet()"></div>
<div class="sheet" id="shareSheet">
  <div class="handle"></div>
  <div class="sheet-body">
    <div class="panel">
      <div style="font-weight:900; font-size:18px;">Inserat teilen</div>
      <div class="hint" id="shareSheetSubtitle" style="margin-top:4px;">
        <!-- Wird dynamisch bef√ºllt -->
      </div>
    </div>
    <div class="answers" style="margin-top:16px;">
      <button class="ans" type="button" id="btnShareWhatsApp">
        <i data-lucide="message-circle"></i><span>WhatsApp</span>
      </button>
      <button class="ans" type="button" id="btnShareInstagram">
        <i data-lucide="share-2"></i><span>Instagram</span>
      </button>
      <button class="ans" type="button" id="btnShareCopy">
        <i data-lucide="copy"></i><span>Link kopieren</span>
      </button>
    </div>
  </div>
</div>

<!-- Create Flow Sheet (Gericht hinzuf√ºgen) -->
<div class="backdrop" id="createFlowBd" onclick="closeCreateFlowSheet()"></div>
<div class="sheet" id="createFlowSheet">
  <div class="handle"></div>
  <div class="sheet-body" style="padding:16px;">
    <div style="font-weight:600; font-size:18px; margin-bottom:16px; line-height:1.3;">Gericht hinzuf√ºgen</div>
    <div style="display:flex; flex-direction:column; gap:12px;">
      <button class="btn secondary" type="button" id="btnCreateFromCookbook" style="width:100%; min-height:44px; justify-content:flex-start; text-align:left;">
        <span style="margin-right:12px;">üìñ</span>
        <span>Aus Kochbuch ausw√§hlen</span>
      </button>
      <button class="btn secondary" type="button" id="btnCreateNewDish" style="width:100%; min-height:44px; justify-content:flex-start; text-align:left;">
        <span style="margin-right:12px;">‚ûï</span>
        <span>Neues Gericht erstellen</span>
      </button>
    </div>
    <div class="hint" id="createFlowDateHint" style="margin-top:12px; font-size:13px; color:var(--muted); display:none;"></div>
  </div>
</div>

<!-- Snackbar: Undo pickup -->
<div class="snackbar" id="pickupUndo">
  <span id="pickupUndoLabel">Abholung markiert</span>
  <button type="button" id="pickupUndoBtn">R√ºckg√§ngig</button>
</div>

<!-- Print view -->
<div id="printView" class="print-view"></div>

<!-- Provider Wizard sheet (single reusable) -->
<div class="backdrop" id="wbd" onclick="closeWizard()"></div>
<div class="sheet" id="wizard">
  <div class="handle"></div>
  <div class="sheet-body">
    <div class="wizard" id="wBox">
      <div class="w-top">
        <div class="w-title" id="wTitle">Setup</div>
        <div class="w-step" id="wStep">1/6</div>
      </div>
      <div class="w-q" id="wQ">‚Ä¶</div>
      <p class="w-help" id="wHelp"></p>
      <div id="wContent"></div>
      <div class="w-actions">
        <button class="btn secondary" type="button" id="wBack">Zur√ºck</button>
        <button class="btn" type="button" id="wNext">Weiter</button>
      </div>
    </div>
  </div>
</div>

<script>
  // --- Storage keys ---
  const LS = {
    offers: 'mittagio_offers_v2',
    favs: 'mittagio_favs_v1',
    providerFavs: 'mittagio_provider_favs_v1',
    dishFavs: 'mittagio_dish_favs_v1',
    cart: 'mittagio_cart_v1',
    orders: 'mittagio_orders_v1',
    customer: 'mittagio_customer_v1',
    provider: 'mittagio_provider_v1',
    cookbook: 'mittagio_cookbook_v1',
    week: 'mittagio_week_v1',
    onboardingDraft: 'mittagio_onboarding_draft_v1',
    pickupDone: 'mittagio_pickup_done_v1',
    mode: 'mittagio_mode_v1'
  };
  const load = (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch { return d; } };
  const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

  // --- Order Store (localStorage MVP) - MUSS VOR VERWENDUNG DEFINIERT SEIN ---
  /**
   * @typedef {Object} Order
   * @property {string} id
   * @property {number} createdAt
   * @property {number} updatedAt
   * @property {string} dishId
   * @property {string} dishName
   * @property {string} providerId
   * @property {string} providerName
   * @property {string} [providerAddress]
   * @property {number} quantity
   * @property {number} unitPrice - in cents
   * @property {number} total - in cents
   * @property {'PICKUP'|'DINE_IN'} fulfillType
   * @property {string} [etaTime]
   * @property {'CREATED'|'PAYMENT_PENDING'|'PAID'|'CANCELLED'|'COMPLETED'|'PICKED_UP'} status
   * @property {'EUR'} currency
   * @property {string} [stripeCheckoutSessionId]
   * @property {string} [stripePaymentIntentId]
   * @property {string} [receiptEmail]
   * @property {string} [pickupCode] - nur bei PAID (Format: "2B")
   * @property {number} [pickupCodeActivatedAt] - nur bei PAID
   * @property {string} [pickupDate] - ISO date "YYYY-MM-DD"
   * @property {string} [pickupWindow] - e.g. "11:30‚Äì14:30"
   * @property {'A'|'B'|'C'|'D'|'E'} [dishLetter] - nur bei PAID
   * @property {number} [runningNumber] - nur bei PAID
   * @property {string} [offerId] - Reference to offer
   * @property {'PAID'|'PICKED_UP'} [status] - Extended status
   * @property {boolean} isGuest
   */
  
  /**
   * Load orders from localStorage
   * @returns {Order[]}
   */
  function loadOrders(){
    try {
      const stored = localStorage.getItem(LS.orders);
      if(!stored) return [];
      const parsed = JSON.parse(stored);
      return Array.isArray(parsed) ? parsed : [];
    } catch(e){
      console.error('Error loading orders:', e);
      return [];
    }
  }
  
  /**
   * Save orders to localStorage
   * @param {Order[]} ordersList
   */
  function saveOrders(ordersList){
    try {
      localStorage.setItem(LS.orders, JSON.stringify(ordersList || []));
    } catch(e){
      console.error('Error saving orders:', e);
    }
  }
  
  /**
   * Add a new order
   * @param {Order} order
   * @returns {Order}
   */
  function addOrder(order){
    // Guard: pickupCode nur bei PAID
    if(order.pickupCode && order.status !== 'PAID'){
      console.warn('pickupCode should only be set when status is PAID');
      order.pickupCode = undefined;
      order.pickupCodeActivatedAt = undefined;
    }
    
    const ordersList = loadOrders();
    ordersList.push(order);
    saveOrders(ordersList);
    return order;
  }
  
  /**
   * Update an existing order
   * @param {string} orderId
   * @param {Partial<Order>} patch
   * @returns {Order|null}
   */
  function updateOrder(orderId, patch){
    const ordersList = loadOrders();
    const index = ordersList.findIndex(o => o.id === orderId);
    if(index === -1){
      console.error('Order not found:', orderId);
      return null;
    }
    
    const order = ordersList[index];
    
    // Guard: pickupCode nur bei PAID
    if(patch.pickupCode && patch.status !== 'PAID' && order.status !== 'PAID'){
      console.warn('pickupCode should only be set when status is PAID');
      patch.pickupCode = undefined;
      patch.pickupCodeActivatedAt = undefined;
    }
    
    // Merge patch
    const updated = {
      ...order,
      ...patch,
      updatedAt: Date.now()
    };
    
    ordersList[index] = updated;
    saveOrders(ordersList);
    return updated;
  }
  
  /**
   * Get order by ID
   * @param {string} orderId
   * @returns {Order|null}
   */
  function getOrderById(orderId){
    const ordersList = loadOrders();
    return ordersList.find(o => o.id === orderId) || null;
  }
  
  /**
   * List active orders (CREATED, PAYMENT_PENDING, PAID)
   * @returns {Order[]}
   */
  function listActiveOrders(){
    const ordersList = loadOrders();
    return ordersList.filter(o => 
      o.status === 'CREATED' || 
      o.status === 'PAYMENT_PENDING' || 
      o.status === 'PAID'
    );
  }
  
  /**
   * Generate pickup code (legacy: random 5-char code)
   * @param {number} [len=5]
   * @returns {string}
   */
  function generatePickupCode(len = 5){
    const alphabet = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789'; // ohne O/I/0/1
    let code = '';
    for(let i = 0; i < len; i++){
      code += alphabet[Math.floor(Math.random() * alphabet.length)];
    }
    
    // Optional: ensure uniqueness (wenn collision, neu generieren)
    const ordersList = loadOrders();
    const existingCodes = ordersList
      .filter(o => o.pickupCode)
      .map(o => o.pickupCode);
    
    if(existingCodes.includes(code)){
      // Collision: neu generieren (max 10 Versuche)
      for(let attempt = 0; attempt < 10; attempt++){
        code = '';
        for(let i = 0; i < len; i++){
          code += alphabet[Math.floor(Math.random() * alphabet.length)];
        }
        if(!existingCodes.includes(code)) break;
      }
    }
    
    return code;
  }
  
  /**
   * Assign pickup code (deterministic, mock)
   * Single source of truth: Order record
   * @param {Object} params
   * @param {string} params.providerId - Provider ID
   * @param {string} params.pickupDate - ISO date "YYYY-MM-DD"
   * @param {string} params.dishId - Dish/Offer ID
   * @returns {{dishLetter: string, runningNumber: number, pickupCode: string}}
   */
  function assignPickupCode({providerId, pickupDate, dishId}){
    // 1) Get today's active offers for provider (same pickupDate)
    const todayOffers = offers
      .filter(o => o.providerId === providerId && o.day === pickupDate && o.active !== false)
      .sort((a, b) => {
        // 2) Sort deterministically (createdAt or sortIndex)
        const timeA = a.createdAt || 0;
        const timeB = b.createdAt || 0;
        if(timeA !== timeB) return timeA - timeB;
        return (a.id || '').localeCompare(b.id || '');
      });
    
    // 3) Determine dishLetter based on index: 0->A, 1->B, 2->C, 3->D, 4->E
    const dishIndex = todayOffers.findIndex(o => o.id === dishId);
    if(dishIndex === -1){
      // Fallback: use first dish (A)
      const dishLetter = 'A';
      const ordersList = loadOrders();
      // 4) Find existing orders for (providerId + pickupDate + dishLetter)
      const existingOrders = ordersList.filter(o => 
        o.providerId === providerId && 
        o.pickupDate === pickupDate && 
        o.dishLetter === dishLetter &&
        o.status === 'PAID'
      );
      // 5) runningNumber = existingCount + 1
      const runningNumber = existingOrders.length + 1;
      // 6) pickupCode = `${runningNumber}${dishLetter}`
      const pickupCode = `${runningNumber}${dishLetter}`;
      return {dishLetter, runningNumber, pickupCode};
    }
    
    const position = Math.min(dishIndex, 4); // Max 5 dishes (0-4)
    const dishLetter = String.fromCharCode(65 + position); // A=65, B=66, etc. (0‚ÜíA, 1‚ÜíB, ...)
    
    // 4) Find existing orders for (providerId + pickupDate + dishLetter)
    const ordersList = loadOrders();
    const existingOrders = ordersList.filter(o => 
      o.providerId === providerId && 
      o.pickupDate === pickupDate && 
      o.dishLetter === dishLetter &&
      o.status === 'PAID'
    );
    
    // 5) runningNumber = existingCount + 1
    const runningNumber = existingOrders.length + 1;
    
    // 6) pickupCode = `${runningNumber}${dishLetter}`
    const pickupCode = `${runningNumber}${dishLetter}`;
    
    return {dishLetter, runningNumber, pickupCode};
  }
  
  /**
   * Generate dish-letter pickup code (legacy wrapper, uses assignPickupCode)
   * @param {string} orderId - Order ID
   * @param {string} dishId - Dish/Offer ID
   * @param {string} providerIdVal - Provider ID (from order)
   * @param {string} day - ISO date string (YYYY-MM-DD)
   * @returns {{code: string, dishLetter: string, runningNumber: number}} - Format: "1A", "2A", "3B", etc.
   */
  function generateDishLetterPickupCode(orderId, dishId, providerIdVal, day){
    const pickupDate = day || isoDate(new Date());
    // Use assignPickupCode (deterministic)
    const result = assignPickupCode({providerId: providerIdVal, pickupDate, dishId});
    return {code: result.pickupCode, dishLetter: result.dishLetter, runningNumber: result.runningNumber};
  }

  // --- State ---
  let mode = load(LS.mode, 'customer'); // 'start' | 'customer' | 'provider' (Standard: 'customer' f√ºr Discover-Seite)
  // Angebote werden sp√§ter durch seedExampleData() oder seed() geladen
  // Zuerst aus localStorage laden, falls vorhanden
  let offers = load(LS.offers, []);
  const legacyFavs = load(LS.favs, []);
  let providerFavs = new Set(load(LS.providerFavs, legacyFavs));
  let dishFavs = new Set(load(LS.dishFavs, []));
  let cart = load(LS.cart, null); // {providerId, items:[{offerId, qty}]} or null
  let orders = loadOrders(); // Load via Order Store
  let customer = load(LS.customer, { loggedIn:false, name:null });
  let provider = load(LS.provider, { loggedIn:false, email:null, profile:{ name:'', address:'', street:'', zip:'', city:'', mealWindow:'11:30 ‚Äì 14:00', logoData:'' } });
  let cookbook = load(LS.cookbook, []); // [{id, dish, category, price, allergens[], extras?, reuse? , photoData?}]
  let week = load(LS.week, {}); // { 'YYYY-MM-DD': [cookbookId,...] }

  const CATEGORIES = ['Vegetarisch','Vegan','Fisch','Mit Fleisch'];
  const CAT_MAP = {
    'Vegan':'Vegan',
    'Vegetarisch':'Vegetarisch',
    'Fisch':'Fisch',
    'Mit Fleisch':'Fleisch'
  };
  const DISH_SUGGESTIONS = [
    {name:'K√ºrbissuppe', category:'Vegan'},
    {name:'Tomatensuppe mit Brot', category:'Vegan'},
    {name:'Pasta mit Gem√ºse', category:'Vegetarisch'},
    {name:'K√§sesp√§tzle', category:'Vegetarisch'},
    {name:'Salat Bowl', category:'Vegetarisch'},
    {name:'Falafel Teller', category:'Vegan'},
    {name:'Veggie Burger', category:'Vegan'},
    {name:'Schnitzel mit Pommes', category:'Fleisch'},
    {name:'Currywurst', category:'Fleisch'},
    {name:'Gulasch mit Sp√§tzle', category:'Fleisch'}
  ];

  // Day slider: today..+6
  // Format: "Montag, 24.01." (immer vollst√§ndiger Wochentag + DD.MM.)
  function fmtDay(d, includeToday = false){
    const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
    const wd = weekdays[d.getDay()];
    const day = String(d.getDate()).padStart(2,'0');
    const month = String(d.getMonth()+1).padStart(2,'0');
    
    if(includeToday){
      const today = new Date();
      const isToday = d.toDateString() === today.toDateString();
      if(isToday){
        return `Heute, ${wd} ${day}.${month}.`;
      }
    }
    
    return `${wd}, ${day}.${month}.`;
  }
  
  // Format date with time range: "Montag, 24.01. ¬∑ 11:30‚Äì14:30"
  function fmtDateWithTime(d, timeRange){
    const dateStr = fmtDay(d);
    return timeRange ? `${dateStr} ¬∑ ${timeRange}` : dateStr;
  }
  
  function isoDate(d){ return d.toISOString().slice(0,10); }

  let activeCat = null;
  let activeDay = isoDate(new Date());
  let providerWeekDay = isoDate(new Date());
  let pickupSort = 'code'; // Default: sort by code (1A, 1B, 1C, 2A, 2B...)
  let pickupFilter = 'offen'; // 'offen' | 'abgeholt'
  let cookbookSort = 'recent';
  let cookbookQuery = '';
  let cookbookTab = 'dishes';
  let weekPlanDay = isoDate(new Date());
  let locationQuery = '';
  let pickupDone = new Set(load(LS.pickupDone, []));
  let activeOrderId = null;
  let ordersFilter = 'offen';
  let pickupUndoKey = null;
  let pickupUndoTimer = null;
  let billingFilter = 'month';
  let billingMonth = '2026-01';

  // --- Seed demo offers (Testanbieter) ---
  function seed(){
    // Testdaten immer erstellen (zum Testen)
    const today = isoDate(new Date());
    offers = [
      // 4 Testanbieter √ó 4 Gerichte (mit Bildern & je Abholcodes)
      
      // 1. Pizzeria Bella Vista (Stuttgart)
      {id: cryptoId(), providerId: 'p_bellavista', providerName: 'Pizzeria Bella Vista', address: 'Hauptstra√üe 45, 70173 Stuttgart', title: 'Leberk√§se mit Sp√§tzle', price: 6.90, time: '11:30 ‚Äì 14:30', diet: 'Fleisch', day: today, img: 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 3},
      {id: cryptoId(), providerId: 'p_bellavista', providerName: 'Pizzeria Bella Vista', address: 'Hauptstra√üe 45, 70173 Stuttgart', title: 'Pizza Quattro Formaggi', price: 8.50, time: '11:30 ‚Äì 14:30', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1571997478779-2adcbbe9ab2f?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 4},
      {id: cryptoId(), providerId: 'p_bellavista', providerName: 'Pizzeria Bella Vista', address: 'Hauptstra√üe 45, 70173 Stuttgart', title: 'Pasta Carbonara', price: 8.80, time: '11:30 ‚Äì 14:30', diet: 'Fleisch', day: today, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 2},
      {id: cryptoId(), providerId: 'p_bellavista', providerName: 'Pizzeria Bella Vista', address: 'Hauptstra√üe 45, 70173 Stuttgart', title: 'Insalata Caprese', price: 7.20, time: '11:30 ‚Äì 14:30', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 3},

      // 2. Asia Wok Express (T√ºbingen)
      {id: cryptoId(), providerId: 'p_asiawok', providerName: 'Asia Wok Express', address: 'Neckarhalde 8, 72070 T√ºbingen', title: 'H√§hnchen Teriyaki', price: 8.90, time: '11:00 ‚Äì 14:00', diet: 'Fleisch', day: today, img: 'https://images.unsplash.com/photo-1603133872878-684f208fb84b?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 5},
      {id: cryptoId(), providerId: 'p_asiawok', providerName: 'Asia Wok Express', address: 'Neckarhalde 8, 72070 T√ºbingen', title: 'Gebratene Nudeln mit Gem√ºse', price: 7.50, time: '11:00 ‚Äì 14:00', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1569718212165-3a8278d5f624?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 4},
      {id: cryptoId(), providerId: 'p_asiawok', providerName: 'Asia Wok Express', address: 'Neckarhalde 8, 72070 T√ºbingen', title: 'Pad Thai', price: 8.40, time: '11:00 ‚Äì 14:00', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 3},
      {id: cryptoId(), providerId: 'p_asiawok', providerName: 'Asia Wok Express', address: 'Neckarhalde 8, 72070 T√ºbingen', title: 'Fr√ºhlingsrollen (4 St√ºck)', price: 6.80, time: '11:00 ‚Äì 14:00', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1529692236671-f1f6cf9683ba?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 6},

      // 3. Burger House (Ludwigsburg)
      {id: cryptoId(), providerId: 'p_burgerhouse', providerName: 'Burger House', address: 'Wilhelmstra√üe 12, 71634 Ludwigsburg', title: 'Classic Cheeseburger', price: 8.90, time: '11:30 ‚Äì 14:00', diet: 'Fleisch', day: today, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 4},
      {id: cryptoId(), providerId: 'p_burgerhouse', providerName: 'Burger House', address: 'Wilhelmstra√üe 12, 71634 Ludwigsburg', title: 'Veggie Burger', price: 7.90, time: '11:30 ‚Äì 14:00', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1525059696034-4967a7290027?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 3},
      {id: cryptoId(), providerId: 'p_burgerhouse', providerName: 'Burger House', address: 'Wilhelmstra√üe 12, 71634 Ludwigsburg', title: 'Chicken Burger', price: 9.20, time: '11:30 ‚Äì 14:00', diet: 'Fleisch', day: today, img: 'https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 5},
      {id: cryptoId(), providerId: 'p_burgerhouse', providerName: 'Burger House', address: 'Wilhelmstra√üe 12, 71634 Ludwigsburg', title: 'Sweet Potato Fries', price: 4.50, time: '11:30 ‚Äì 14:00', diet: 'Vegan', day: today, img: 'https://images.unsplash.com/photo-1573080496219-bb080dd4f877?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 8},

      // 4. Green Garden (Esslingen)
      {id: cryptoId(), providerId: 'p_greengarden', providerName: 'Green Garden', address: 'Marktplatz 7, 73728 Esslingen', title: 'Avocado-Bowl', price: 9.50, time: '11:00 ‚Äì 14:00', diet: 'Vegan', day: today, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 4},
      {id: cryptoId(), providerId: 'p_greengarden', providerName: 'Green Garden', address: 'Marktplatz 7, 73728 Esslingen', title: 'Quinoa-Salat', price: 8.20, time: '11:00 ‚Äì 14:00', diet: 'Vegan', day: today, img: 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 5},
      {id: cryptoId(), providerId: 'p_greengarden', providerName: 'Green Garden', address: 'Marktplatz 7, 73728 Esslingen', title: 'Falafel-Wrap', price: 7.80, time: '11:00 ‚Äì 14:00', diet: 'Vegan', day: today, img: 'https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 6},
      {id: cryptoId(), providerId: 'p_greengarden', providerName: 'Green Garden', address: 'Marktplatz 7, 73728 Esslingen', title: 'Gem√ºse-Curry', price: 8.60, time: '11:00 ‚Äì 14:00', diet: 'Vegan', day: today, img: 'https://images.unsplash.com/photo-1546069901-d5bfd2cbfb1f?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 3},
    ];
    save(LS.offers, offers);
  }

  // --- Beispieldaten: 10 Anbieter mit je 3 Gerichten und 10 Abholcodes ---
  function seedExampleData(){
    const today = isoDate(new Date());
    const providerNames = [
      {id: 'p_01', name: 'Pizzeria Bella Vista', address: 'Hauptstra√üe 45, 70173 Stuttgart', street: 'Hauptstra√üe 45', zip: '70173', city: 'Stuttgart'},
      {id: 'p_02', name: 'Asia Wok Express', address: 'Neckarhalde 8, 72070 T√ºbingen', street: 'Neckarhalde 8', zip: '72070', city: 'T√ºbingen'},
      {id: 'p_03', name: 'Burger House', address: 'Wilhelmstra√üe 12, 71634 Ludwigsburg', street: 'Wilhelmstra√üe 12', zip: '71634', city: 'Ludwigsburg'},
      {id: 'p_04', name: 'Green Garden', address: 'Marktplatz 7, 73728 Esslingen', street: 'Marktplatz 7', zip: '73728', city: 'Esslingen'},
      {id: 'p_05', name: 'La Trattoria', address: 'K√∂nigstra√üe 23, 70173 Stuttgart', street: 'K√∂nigstra√üe 23', zip: '70173', city: 'Stuttgart'},
      {id: 'p_06', name: 'Sushi Bar Tokyo', address: 'Eberhardstra√üe 15, 72072 T√ºbingen', street: 'Eberhardstra√üe 15', zip: '72072', city: 'T√ºbingen'},
      {id: 'p_07', name: 'Curry & Co', address: 'Bahnhofstra√üe 8, 71634 Ludwigsburg', street: 'Bahnhofstra√üe 8', zip: '71634', city: 'Ludwigsburg'},
      {id: 'p_08', name: 'Veggie Delight', address: 'Hafenstra√üe 12, 73728 Esslingen', street: 'Hafenstra√üe 12', zip: '73728', city: 'Esslingen'},
      {id: 'p_09', name: 'Steakhouse Premium', address: 'Schillerplatz 5, 70173 Stuttgart', street: 'Schillerplatz 5', zip: '70173', city: 'Stuttgart'},
      {id: 'p_10', name: 'Bio Bistro', address: 'M√ºnzgasse 3, 72070 T√ºbingen', street: 'M√ºnzgasse 3', zip: '72070', city: 'T√ºbingen'}
    ];

    const dishTemplates = [
      // Verschiedene Kategorien
      {dish: 'K√ºrbissuppe', category: 'Vegan', price: 6.50, img: 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Pasta Carbonara', category: 'Mit Fleisch', price: 8.80, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Salat Bowl', category: 'Vegetarisch', price: 7.90, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'H√§hnchen Teriyaki', category: 'Mit Fleisch', price: 9.20, img: 'https://images.unsplash.com/photo-1603133872878-684f208fb84b?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Falafel Teller', category: 'Vegan', price: 7.50, img: 'https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'K√§sesp√§tzle', category: 'Vegetarisch', price: 7.20, img: 'https://images.unsplash.com/photo-1546069901-d5bfd2cbfb1f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Pizza Margherita', category: 'Vegetarisch', price: 8.50, img: 'https://images.unsplash.com/photo-1571997478779-2adcbbe9ab2f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Lachs mit Gem√ºse', category: 'Fisch', price: 10.50, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Veggie Burger', category: 'Vegan', price: 7.90, img: 'https://images.unsplash.com/photo-1525059696034-4967a7290027?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Schnitzel mit Pommes', category: 'Mit Fleisch', price: 9.80, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Quinoa-Salat', category: 'Vegan', price: 8.20, img: 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Thunfisch-Steak', category: 'Fisch', price: 11.20, img: 'https://images.unsplash.com/photo-1569718212165-3a8278d5f624?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Gulasch mit Sp√§tzle', category: 'Mit Fleisch', price: 9.50, img: 'https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Gem√ºse-Curry', category: 'Vegan', price: 8.60, img: 'https://images.unsplash.com/photo-1546069901-d5bfd2cbfb1f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Risotto ai Funghi', category: 'Vegetarisch', price: 8.90, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Sushi Platte', category: 'Fisch', price: 12.50, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Steak mit Beilagen', category: 'Mit Fleisch', price: 13.90, img: 'https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Buddha Bowl', category: 'Vegan', price: 8.80, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Caprese Salat', category: 'Vegetarisch', price: 7.40, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Fischfilet mit Kartoffeln', category: 'Fisch', price: 10.80, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Chili con Carne', category: 'Mit Fleisch', price: 8.70, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Avocado-Bowl', category: 'Vegan', price: 9.50, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Mozzarella-Pasta', category: 'Vegetarisch', price: 8.30, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Lachs-Tartar', category: 'Fisch', price: 11.90, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Hamburger Classic', category: 'Mit Fleisch', price: 8.90, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Tofu-Wrap', category: 'Vegan', price: 7.60, img: 'https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Gem√ºse-Lasagne', category: 'Vegetarisch', price: 9.20, img: 'https://images.unsplash.com/photo-1546069901-d5bfd2cbfb1f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Forelle blau', category: 'Fisch', price: 10.40, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Rinderbraten', category: 'Mit Fleisch', price: 12.50, img: 'https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Power-Smoothie Bowl', category: 'Vegan', price: 6.90, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60'}
    ];

    const newOffers = [];
    const newCookbook = [];
    const newOrders = [];

    providerNames.forEach((provider, pIdx) => {
      // 3 Gerichte pro Provider (verschiedene Kategorien)
      const dishIndices = [
        (pIdx * 3) % dishTemplates.length,
        ((pIdx * 3 + 1) % dishTemplates.length),
        ((pIdx * 3 + 2) % dishTemplates.length)
      ];

      dishIndices.forEach((dishIdx, dIdx) => {
        const template = dishTemplates[dishIdx];
        const cookbookId = cryptoId();
        const offerId = cryptoId();

        // Kochbuch-Eintrag
        newCookbook.push({
          id: cookbookId,
          providerId: provider.id,
          dish: template.dish,
          category: template.category,
          price: template.price,
          allergens: [],
          extras: [],
          reuse: {enabled: false, deposit: 0},
          photoData: template.img,
          hasPickupCode: true,
          dineInPossible: true,
          createdAt: Date.now() - (pIdx * 86400000) - (dIdx * 3600000),
          lastUsed: Date.now() - (pIdx * 86400000) - (dIdx * 3600000)
        });

        // Offer (Inserat f√ºr heute)
        newOffers.push({
          id: offerId,
          providerId: provider.id,
          providerName: provider.name,
          providerStreet: provider.street,
          providerZip: provider.zip,
          providerCity: provider.city,
          address: provider.address,
          dish: template.dish,
          category: template.category,
          price: template.price,
          pickupWindow: '11:30 ‚Äì 14:00',
          day: today,
          imageUrl: template.img,
          hasPickupCode: true,
          dineInPossible: true,
          allergens: [],
          extras: [],
          reuse: {enabled: false, deposit: 0},
          active: true,
          createdAt: Date.now() - (pIdx * 3600000) - (dIdx * 600000)
        });
      });
    });

    // Zuerst Offers speichern, damit assignPickupCode sie verwenden kann
    // WICHTIG: Ersetze alte Offers, damit keine Duplikate entstehen
    offers = [...newOffers];
    save(LS.offers, offers);

    // Jetzt Bestellungen mit Abholcodes erstellen
    providerNames.forEach((provider, pIdx) => {
      const dishIndices = [
        (pIdx * 3) % dishTemplates.length,
        ((pIdx * 3 + 1) % dishTemplates.length),
        ((pIdx * 3 + 2) % dishTemplates.length)
      ];

      dishIndices.forEach((dishIdx, dIdx) => {
        const template = dishTemplates[dishIdx];
        // Finde das entsprechende Offer
        const offer = newOffers.find(o => 
          o.providerId === provider.id && 
          o.dish === template.dish
        );
        if(!offer) return;

        // 10 Bestellungen pro Provider (mit Abholcodes)
        // Verteilung: 3-4 pro Gericht
        const ordersPerDish = dIdx === 0 ? 4 : (dIdx === 1 ? 3 : 3);
        for(let o = 0; o < ordersPerDish; o++){
          const orderId = cryptoId();
          const pickupCode = assignPickupCode({
            providerId: provider.id,
            pickupDate: today,
            dishId: offer.id
          });

          newOrders.push({
            id: orderId,
            createdAt: Date.now() - (pIdx * 3600000) - (dIdx * 600000) - (o * 60000),
            updatedAt: Date.now() - (pIdx * 3600000) - (dIdx * 600000) - (o * 60000),
            dishId: offer.id,
            dishName: template.dish,
            providerId: provider.id,
            providerName: provider.name,
            providerAddress: provider.address,
            quantity: 1,
            unitPrice: Math.round(template.price * 100), // in cents
            total: Math.round(template.price * 100),
            fulfillType: 'PICKUP',
            status: 'PAID',
            currency: 'EUR',
            pickupCode: pickupCode.pickupCode,
            pickupCodeActivatedAt: Date.now() - (pIdx * 3600000) - (dIdx * 600000) - (o * 60000),
            pickupDate: today,
            pickupWindow: '11:30 ‚Äì 14:00',
            dishLetter: pickupCode.dishLetter,
            runningNumber: pickupCode.runningNumber,
            offerId: offer.id,
            isGuest: false
          });
        }
      });
    });

    // Speichern (Offers bereits oben gespeichert)
    // Ersetze Cookbook komplett f√ºr Demo (keine Duplikate)
    const existingCookbook = cookbook.filter(c => !providerNames.some(p => p.id === c.providerId));
    cookbook = [...existingCookbook, ...newCookbook];
    save(LS.cookbook, cookbook);

    const existingOrders = loadOrders();
    const allOrders = [...existingOrders, ...newOrders];
    saveOrders(allOrders);

    console.log(`‚úÖ Beispieldaten erstellt: ${providerNames.length} Anbieter, ${newCookbook.length} Kochbuch-Eintr√§ge, ${newOffers.length} Inserate, ${newOrders.length} Bestellungen`);
    return {providers: providerNames.length, cookbook: newCookbook.length, offers: newOffers.length, orders: newOrders.length};
  }

  // --- Test-Funktion f√ºr Abholcode-Logik ---
  function testPickupCodeLogic(){
    console.log('üß™ Teste Abholcode-Logik...');
    const today = isoDate(new Date());
    
    // Test 1: Pr√ºfe ob Beispieldaten vorhanden sind
    const allOrders = loadOrders();
    const allOffers = offers;
    const todayOrders = allOrders.filter(o => o.pickupDate === today && o.status === 'PAID');
    const todayOffers = allOffers.filter(o => o.day === today && o.active !== false);
    
    console.log(`üìä Test 1 - Daten vorhanden:`);
    console.log(`  - Heutige Bestellungen: ${todayOrders.length}`);
    console.log(`  - Heutige Inserate: ${todayOffers.length}`);
    
    if(todayOrders.length === 0){
      console.warn('‚ö†Ô∏è Keine Bestellungen f√ºr heute gefunden. seedExampleData() ausf√ºhren?');
      return false;
    }
    
    // Test 2: Pr√ºfe Abholcode-Format
    console.log(`\nüìä Test 2 - Abholcode-Format:`);
    const codes = todayOrders.map(o => o.pickupCode).filter(Boolean);
    const invalidCodes = codes.filter(c => !/^\d+[A-E]$/.test(c));
    if(invalidCodes.length > 0){
      console.error(`‚ùå Ung√ºltige Codes gefunden: ${invalidCodes.join(', ')}`);
      return false;
    }
    console.log(`  ‚úÖ Alle ${codes.length} Codes haben g√ºltiges Format (z.B. "1A", "2B")`);
    
    // Test 3: Pr√ºfe Eindeutigkeit pro Provider/Tag
    console.log(`\nüìä Test 3 - Eindeutigkeit pro Provider/Tag:`);
    const providers = [...new Set(todayOrders.map(o => o.providerId))];
    let allUnique = true;
    providers.forEach(pid => {
      const providerOrders = todayOrders.filter(o => o.providerId === pid);
      const providerCodes = providerOrders.map(o => o.pickupCode);
      const uniqueCodes = [...new Set(providerCodes)];
      if(providerCodes.length !== uniqueCodes.length){
        console.error(`‚ùå Provider ${pid}: Duplikate gefunden!`);
        console.error(`  Codes: ${providerCodes.join(', ')}`);
        allUnique = false;
      } else {
        console.log(`  ‚úÖ Provider ${pid}: ${providerCodes.length} eindeutige Codes`);
      }
    });
    if(!allUnique) return false;
    
    // Test 4: Pr√ºfe dishLetter-Zuordnung
    console.log(`\nüìä Test 4 - dishLetter-Zuordnung:`);
    providers.forEach(pid => {
      const providerOffers = todayOffers.filter(o => o.providerId === pid).sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0));
      const providerOrders = todayOrders.filter(o => o.providerId === pid);
      
      // Erwartete Letters: A, B, C (f√ºr 3 Gerichte)
      const expectedLetters = ['A', 'B', 'C'];
      const actualLetters = [...new Set(providerOrders.map(o => o.dishLetter).filter(Boolean))].sort();
      
      console.log(`  Provider ${pid}:`);
      console.log(`    - Inserate: ${providerOffers.length} (erwartet: 3)`);
      console.log(`    - Bestellungen: ${providerOrders.length} (erwartet: 10)`);
      console.log(`    - dishLetters: ${actualLetters.join(', ')} (erwartet: A, B, C)`);
      
      // Pr√ºfe ob Letters korrekt zugeordnet sind
      providerOffers.forEach((offer, idx) => {
        const expectedLetter = expectedLetters[idx] || 'A';
        const ordersForOffer = providerOrders.filter(o => o.offerId === offer.id);
        const lettersForOffer = [...new Set(ordersForOffer.map(o => o.dishLetter))];
        if(lettersForOffer.length !== 1 || lettersForOffer[0] !== expectedLetter){
          console.warn(`    ‚ö†Ô∏è Offer "${offer.dish}" hat unerwartete Letters: ${lettersForOffer.join(', ')} (erwartet: ${expectedLetter})`);
        } else {
          console.log(`    ‚úÖ Offer "${offer.dish}": Letter ${expectedLetter}, ${ordersForOffer.length} Bestellungen`);
        }
      });
    });
    
    // Test 5: Pr√ºfe runningNumber-Sequenz
    console.log(`\nüìä Test 5 - runningNumber-Sequenz:`);
    providers.forEach(pid => {
      const providerOrders = todayOrders.filter(o => o.providerId === pid);
      const letters = ['A', 'B', 'C'];
      letters.forEach(letter => {
        const ordersForLetter = providerOrders.filter(o => o.dishLetter === letter).sort((a,b) => a.runningNumber - b.runningNumber);
        if(ordersForLetter.length > 0){
          const numbers = ordersForLetter.map(o => o.runningNumber);
          const expected = Array.from({length: ordersForLetter.length}, (_, i) => i + 1);
          const isSequential = JSON.stringify(numbers) === JSON.stringify(expected);
          if(!isSequential){
            console.error(`‚ùå Provider ${pid}, Letter ${letter}: Sequenz fehlerhaft!`);
            console.error(`  Gefunden: ${numbers.join(', ')}`);
            console.error(`  Erwartet: ${expected.join(', ')}`);
          } else {
            console.log(`  ‚úÖ Provider ${pid}, Letter ${letter}: Sequenz korrekt (1-${numbers.length})`);
          }
        }
      });
    });
    
    // Test 6: Pr√ºfe assignPickupCode Funktion direkt
    console.log(`\nüìä Test 6 - assignPickupCode Funktion:`);
    if(todayOffers.length > 0 && providers.length > 0){
      const testProvider = providers[0];
      const testOffers = todayOffers.filter(o => o.providerId === testProvider).sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0));
      if(testOffers.length > 0){
        const testOffer = testOffers[0];
        const testResult = assignPickupCode({
          providerId: testProvider,
          pickupDate: today,
          dishId: testOffer.id
        });
        console.log(`  Test f√ºr Provider ${testProvider}, Offer "${testOffer.dish}":`);
        console.log(`    - dishLetter: ${testResult.dishLetter} (erwartet: A)`);
        console.log(`    - runningNumber: ${testResult.runningNumber}`);
        console.log(`    - pickupCode: ${testResult.pickupCode}`);
        
        const existingCount = todayOrders.filter(o => 
          o.providerId === testProvider && 
          o.pickupDate === today && 
          o.dishLetter === testResult.dishLetter &&
          o.status === 'PAID'
        ).length;
        const expectedRunningNumber = existingCount + 1;
        if(testResult.runningNumber === expectedRunningNumber){
          console.log(`    ‚úÖ runningNumber korrekt (${testResult.runningNumber} = ${existingCount} + 1)`);
        } else {
          console.error(`    ‚ùå runningNumber falsch! Gefunden: ${testResult.runningNumber}, Erwartet: ${expectedRunningNumber}`);
        }
      }
    }
    
    console.log(`\n‚úÖ Alle Tests abgeschlossen!`);
    return true;
  }

  // --- UI helpers ---
  function euro(n){
    const v = Number(n||0);
    return v.toFixed(2).replace('.',',') + ' ‚Ç¨';
  }
  function cryptoId(){
    return 'id_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
  }
  function esc(s){
    return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[c]));
  }

  const ICONS = {
    plus:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>',
    book:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M4 4.5A2.5 2.5 0 0 1 6.5 2H20v15H6.5A2.5 2.5 0 0 0 4 17.5z"/></svg>',
    share:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="m16 6-4-4-4 4"/><path d="M12 2v14"/></svg>',
    'share-2':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="m8.59 13.51 6.83 3.98"/><path d="m15.41 6.51-6.82 3.98"/></svg>',
    print:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 14h12v8H6z"/></svg>',
    edit:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>',
    action:'<svg viewBox="0 0 24 24" fill="currentColor"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/></svg>',
    heart:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.8 6.6a5 5 0 0 0-7.1 0L12 8.3l-1.7-1.7a5 5 0 1 0-7.1 7.1L12 22l8.8-8.3a5 5 0 0 0 0-7.1Z"/></svg>',
    heartFilled:'<svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><path d="M20.8 6.6a5 5 0 0 0-7.1 0L12 8.3l-1.7-1.7a5 5 0 1 0-7.1 7.1L12 22l8.8-8.3a5 5 0 0 0 0-7.1Z"/></svg>',
    cart:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2h12l2 7H4z"/><path d="M4 9h16v11a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V9Z"/></svg>',
    'shopping-cart':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>',
    location:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s7-7.2 7-12a7 7 0 1 0-14 0c0 4.8 7 12 7 12z"/><circle cx="12" cy="10" r="2.5"/></svg>',
    star:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 2 3 7 7 .6-5.2 4.5 1.6 7L12 17l-6.4 4.1 1.6-7L2 9.6 9 9z"/></svg>',
    box:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7l9-4 9 4-9 4-9-4Z"/><path d="M3 7v10l9 4 9-4V7"/><path d="M12 11v10"/></svg>',
    leaf:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 14c6-8 14-8 16-6-2 8-10 16-18 14 0-6 2-8 2-8Z"/><path d="M6 14c2 0 6 0 10-4"/></svg>',
    flame:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2s3 4 3 7a3 3 0 1 1-6 0c0-3 3-7 3-7Z"/><path d="M5.5 14.5a6.5 6.5 0 1 0 13 0c0-3.5-2.5-6.5-6.5-9-4 2.5-6.5 5.5-6.5 9Z"/></svg>',
    calendar:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>',
    eye:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6S2 12 2 12Z"/><circle cx="12" cy="12" r="3"/></svg>',
    info:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 10v6"/><path d="M12 7h.01"/></svg>',
    card:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/></svg>',
    home:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 11.5 12 4l9 7.5"/><path d="M5 10.5V20h14v-9.5"/></svg>',
    user:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20a8 8 0 0 1 16 0"/></svg>',
    compass:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M15 9l-2 6-6 2 2-6 6-2Z"/></svg>',
    receipt:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2h12v20l-3-2-3 2-3-2-3 2Z"/><path d="M8 6h8M8 10h8M8 14h6"/></svg>',
    bookOpen:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 5h7a4 4 0 0 1 4 4v12H6a4 4 0 0 0-4 4Z"/><path d="M22 5h-7a4 4 0 0 0-4 4v12h7a4 4 0 0 1 4 4Z"/></svg>',
    clock:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 7v6l4 2"/></svg>',
    globe:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M3 12h18"/><path d="M12 3a12 12 0 0 1 0 18"/><path d="M12 3a12 12 0 0 0 0 18"/></svg>',
    link:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 1 0-7l2-2a5 5 0 0 1 7 7l-2 2"/><path d="M14 11a5 5 0 0 1 0 7l-2 2a5 5 0 0 1-7-7l2-2"/></svg>',
    message:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a4 4 0 0 1-4 4H7l-4 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/></svg>',
    camera:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h4l2-3h4l2 3h4v12H4z"/><circle cx="12" cy="13" r="3"/></svg>',
    mail:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="m3 7 9 6 9-6"/></svg>',
    shield:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2 20 5v6c0 5-3.5 9-8 11-4.5-2-8-6-8-11V5z"/></svg>',
    file:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>',
    wallet:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7h18a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H3z"/><path d="M3 7V5a2 2 0 0 1 2-2h14"/><path d="M17 12h4"/></svg>',
    utensils:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 2v6a4 4 0 0 0 8 0V2"/><path d="M8 2v10"/><path d="M16 2v20"/><path d="M20 2v6a2 2 0 0 1-2 2h-2"/></svg>',
    // Mittagio Icon Set (Lucide Icons - Outline only)
    carrot:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2.5 16.88a1 1 0 0 1-.32-1.43l1.5-2.5a1 1 0 0 1 1.37-.37L8 15l5-5-2-2-5 5-3.13-1.95a1 1 0 0 0-1.37.37l-2.5 1.5a1 1 0 0 0-.5.88Z"/><path d="M16 21h5a1 1 0 0 0 1-1v-5"/><path d="M21 16l-5 5"/><path d="M11 2L9 4l5 5 2-2-5-5Z"/></svg>',
    drumstick:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15.5 9.5 12 13l-1-1-1 1c-1 1-2.5 1.5-4 1l-1 1c-.5.5-1 1.5-1 2.5 0 1 .5 1.5 1 2l2 2c.5.5 1 .5 1.5 0l1-1c-.5-1.5 0-3 1-4l1-1 1 1 3.5-3.5Z"/><path d="M20 2v10"/><path d="M22 4h-4"/></svg>',
    fish:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 10s3-3 8-3 8 3 8 3-3 3-8 3-8-3-8-3Z"/><path d="M4 10v4"/><path d="M8 10v4"/><path d="M12 10v4"/><path d="M16 10v4"/><path d="M2 16s3-3 8-3 8 3 8 3"/><path d="M2 4s3 3 8 3 8-3 8-3"/></svg>',
    'key-round':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="15" r="4"/><path d="m10 15 6-6"/><path d="m18 5 2 2"/><path d="m20 5-2 2"/></svg>',
    'credit-card':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/></svg>',
    'shopping-bag':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>',
    package:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 18v-8Z"/><path d="M3.27 6.96 12 12.01l8.73-5.05"/><path d="M12 22.08V12"/></svg>',
    'utensils-crossed':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15.5-1-.5.5"/><path d="M15 2v5"/><path d="M12 22V8"/><path d="M12 2v3"/><path d="M19 22V11"/><path d="M19 2v4"/><path d="M2 22l20-20"/></svg>',
    store:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7v13h16V7"/><path d="M4 7l2-5h12l2 5"/><path d="M9 12v6"/><path d="M15 12v6"/></svg>',
    'calendar-days':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/><path d="M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01M16 18h.01"/></svg>',
    'map-pin':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>',
    copy:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>',
    check:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6 9 17l-5-5"/></svg>',
    'arrow-left':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>',
    'maximize-2':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6"/><path d="M9 21H3v-6"/><path d="M21 3l-7 7"/><path d="M3 21l7-7"/></svg>',
    x:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg>',
    'alert-circle':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>'
  };
  const iconMarkup = (name, opts={})=> {
    const iconName = opts.fill && ICONS[name + 'Filled'] ? name + 'Filled' : name;
    return ICONS[iconName] ? `<span class="ico-inline">${ICONS[iconName]}</span>` : '';
  };
  function applyStaticIcons(){
    document.querySelectorAll('[data-icon]').forEach(el=>{
      if(el.dataset.iconApplied) return;
      const iconOnly = el.dataset.iconOnly === '1';
      const label = el.dataset.label || el.textContent.trim();
      el.dataset.label = label;
      if(iconOnly){
        el.innerHTML = iconMarkup(el.dataset.icon);
      } else {
        el.innerHTML = `${iconMarkup(el.dataset.icon)}<span>${esc(label)}</span>`;
      }
      el.dataset.iconApplied = '1';
    });
  }

  function seededInfoKey(str){
    const s = String(str||'');
    let h = 0;
    for(let i=0;i<s.length;i++){ h = (h*31 + s.charCodeAt(i)) % 10000; }
    return h;
  }
  function seededInfo(str){
    const h = seededInfoKey(str);
    const distanceKm = Number((0.5 + (h % 80) / 10).toFixed(1));
    const rating = Number((4 + (h % 9) / 10).toFixed(1));
    const ratingCount = 30 + (h % 400);
    const availableCount = 1 + (h % 6);
    return {distanceKm, rating, ratingCount, availableCount};
  }

  const DEFAULT_MEAL_WINDOW = '11:30 ‚Äì 14:00';

  function buildAddress(p){
    if(p && p.address && String(p.address).trim()) return String(p.address).trim();
    const rest = [p?.zip, p?.city].filter(Boolean).join(' ').trim();
    return [p?.street, rest].filter(Boolean).join(', ');
  }

  function parseAddress(addr){
    const raw = String(addr||'').trim();
    const out = { address: raw, street:'', zip:'', city:'' };
    if(!raw) return out;
    const parts = raw.split(',').map(s=>s.trim()).filter(Boolean);
    if(parts.length){ out.street = parts[0]; }
    if(parts.length > 1){
      const rest = parts.slice(1).join(', ');
      const m = rest.match(/^(\d{4,6})\s*(.*)$/);
      if(m){ out.zip = m[1]; out.city = m[2] || ''; }
      else { out.city = rest; }
    }
    return out;
  }

  function normalizeProviderProfile(p){
    const base = { name:'', address:'', street:'', zip:'', city:'', mealWindow:DEFAULT_MEAL_WINDOW, logoData:'' };
    const out = {...base, ...(p||{})};
    if(!out.address){ out.address = buildAddress(out); }
    if(!out.mealWindow){ out.mealWindow = DEFAULT_MEAL_WINDOW; }
    return out;
  }

  function normalizeOffer(o){
    const out = {...(o||{})};
    if(!out.dish && out.title) out.dish = out.title;
    if(!out.imageUrl && out.img) out.imageUrl = out.img;
    if(!out.pickupWindow && out.time) out.pickupWindow = out.time;
    if(!out.category && out.diet) out.category = out.diet;

    if(out.address && (!out.providerStreet && !out.providerZip && !out.providerCity)){
      const parsed = parseAddress(out.address);
      out.providerStreet = out.providerStreet || parsed.street || '';
      out.providerZip = out.providerZip || parsed.zip || '';
      out.providerCity = out.providerCity || parsed.city || '';
    }
    out.providerStreet = out.providerStreet || '';
    out.providerZip = out.providerZip || '';
    out.providerCity = out.providerCity || '';
    out.hasPickupCode = !!out.hasPickupCode;
    out.dineInPossible = !!out.dineInPossible;
    if(out.active === undefined) out.active = true;
    const info = seededInfo(out.dish || out.providerName || out.providerId);
    if(out.distanceKm == null) out.distanceKm = info.distanceKm;
    if(out.rating == null) out.rating = info.rating;
    if(out.ratingCount == null) out.ratingCount = info.ratingCount;
    if(out.availableCount == null) out.availableCount = info.availableCount;
    return out;
  }

  // --- Navigation ---
  const views = {
    start:'v-start',
    discover:'v-discover', fav:'v-fav', orders:'v-orders', cart:'v-cart', profile:'v-profile',
    pickupCode:'v-pickup-code', // Neuer AbholcodeScreen
    providerLogin:'v-provider-login',
    providerOnboardingEntry:'v-provider-onboarding-entry',
    providerOnboardingFirstDish:'v-provider-onboarding-first-dish',
    providerOnboardingSignup:'v-provider-onboarding-signup',
    providerOnboardingBusiness:'v-provider-onboarding-business',
    providerOnboardingPreview:'v-provider-onboarding-preview',
    providerHome:'v-provider-home', providerPickups:'v-provider-pickups', providerCookbook:'v-provider-cookbook',
    providerProfile:'v-provider-profile', providerBilling:'v-provider-billing', providerWeek:'v-provider-week',
    legalImpressum:'v-legal-impressum', legalAgbKurz:'v-legal-agb-kurz', legalDatenschutz:'v-legal-datenschutz', legalAgbOnboarding:'v-legal-agb-onboarding'
  };

  function setCustomerNavActive(go){
    document.querySelectorAll('#customerNav .navbtn').forEach(b=>b.classList.toggle('active', b.dataset.go===go));
  }
  function setProviderNavActive(go){
    document.querySelectorAll('#providerNav .navbtn').forEach(b=>b.classList.toggle('active', b.dataset.pgo===go));
  }

  function showView(id){
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo({top:0,behavior:'smooth'});
  }

  function setMode(next){
    mode = next;
    save(LS.mode, mode);

    const isProv = mode==='provider';
    const isStart = mode==='start';
    const isCustomer = mode==='customer';
    const customerNav = document.getElementById('customerNav');
    const providerNav = document.getElementById('providerNav');
    const discoverFilters = document.getElementById('discoverFilters');
    const modePill = document.getElementById('modePill');
    
    if(customerNav) customerNav.style.display = (isCustomer || isStart) ? 'flex' : 'none';
    if(providerNav) providerNav.style.display = isProv ? 'flex' : 'none';
    if(discoverFilters) discoverFilters.style.display = isCustomer ? 'block' : 'none';
    if(modePill) modePill.style.display = isProv ? 'inline-flex' : 'none';

    if(isStart){
      // Start-Seite: Wenn nicht eingeloggt, zur Discover-Seite (kein Zwang)
      if(!customer.loggedIn){
        setMode('customer');
        showDiscover();
        return;
      }
      showStart();
      return;
    }

    if(isProv){
      // provider must be logged in OR show onboarding entry
      if(!provider.loggedIn){
        // Check if user has onboarding draft -> show returning banner
        const onboardingDraft = load(LS.onboardingDraft, null);
        if(onboardingDraft && !provider.onboardingCompleted){
          // Show onboarding entry with returning banner
          showOnboardingEntry(true);
        } else {
          // Check if onboarding should be shown (new provider)
          if(!provider.onboardingCompleted){
            showOnboardingEntry(false);
          } else {
            showView(views.providerLogin);
          }
        }
      } else {
        showProviderHome();
      }
    } else {
      showDiscover();
    }
  }

  // --- Start ---
  function showStart(){
    // Navigation auf "Entdecken" setzen (auch wenn wir auf Startseite sind)
    const navBtn = document.querySelector('#customerNav button[data-go="discover"]');
    if(navBtn){
      document.querySelectorAll('#customerNav .navbtn').forEach(b=>b.classList.remove('active'));
      navBtn.classList.add('active');
    }
    showView(views.start);
    renderStart();
  }

  // --- Customer views ---
  function showDiscover(){
    setCustomerNavActive('discover');
    showView(views.discover);
    renderChips();
    renderDiscover();
  }
  function showFav(){
    setCustomerNavActive('fav');
    showView(views.fav);
    renderFavorites();
  }
  function showOrders(){
    setCustomerNavActive('orders');
    showView(views.orders);
    renderOrders();
  }
  function showCart(){
    setCustomerNavActive('cart');
    showView(views.cart);
    renderCart();
  }
  function showProfile(){
    setCustomerNavActive('profile');
    showView(views.profile);
    updateProfileView();
    lucide.createIcons();
  }
  
  // --- Pickup Code Screen ---
  let currentPickupOrderId = null;
  
  /**
   * Show pickup code screen (with guard)
   * Route: /abholcode/:orderId
   * @param {string} orderId
   */
  function showPickupCode(orderId){
    const order = getOrderById(orderId);
    
    // Guard: Order nicht gefunden
    if(!order){
      // Fehler-UI: "Bestellung nicht gefunden" + CTA "Zur Entdecken"
      const errorView = document.createElement('div');
      errorView.className = 'panel';
      errorView.style.padding = '40px 20px';
      errorView.style.textAlign = 'center';
      errorView.innerHTML = `
        <div style="font-size:48px; margin-bottom:20px;">‚ö†Ô∏è</div>
        <h3 style="margin-bottom:12px;">Bestellung nicht gefunden</h3>
        <p class="hint" style="margin-bottom:24px;">Die Bestellung konnte nicht gefunden werden.</p>
        <button class="btn" type="button" onclick="showDiscover()" style="width:100%; min-height:44px;">
          <i data-lucide="compass"></i> Zur Entdecken-Seite
        </button>
      `;
      document.body.appendChild(errorView);
      showView(null); // Hide all views
      if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
      return;
    }
    
    // GUARD: Code nur anzeigen wenn PAID
    if(order.status !== 'PAID'){
      // Info UI: "Zahlung noch nicht best√§tigt" + Button "Zur√ºck"
      const infoView = document.createElement('div');
      infoView.className = 'panel';
      infoView.style.padding = '40px 20px';
      infoView.style.textAlign = 'center';
      
      const statusLabel = order.status === 'PAYMENT_PENDING' ? 'Zahlung ausstehend' :
                         order.status === 'CREATED' ? 'Bestellung erstellt' :
                         order.status === 'CANCELLED' ? 'Bestellung abgebrochen' :
                         'Unbekannter Status';
      
      infoView.innerHTML = `
        <div style="font-size:48px; margin-bottom:20px;">‚è≥</div>
        <h3 style="margin-bottom:12px;">Zahlung noch nicht best√§tigt</h3>
        <p class="hint" style="margin-bottom:8px;">Status: ${statusLabel}</p>
        <p class="hint" style="margin-bottom:24px;">Der Abholcode wird nach erfolgreicher Zahlung angezeigt.</p>
        <button class="btn" type="button" onclick="showOrders()" style="width:100%; min-height:44px;">
          <i data-lucide="arrow-left"></i> Zur√ºck
        </button>
      `;
      document.body.appendChild(infoView);
      showView(null); // Hide all views
      if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
      return;
    }
    
    // PAID: Zeige Code
    currentPickupOrderId = orderId;
    setCustomerNavActive('orders'); // Navigation auf Mittagsbox setzen
    showView(views.pickupCode);
    renderPickupCode(order);
  }
  
  /**
   * Render pickup code screen
   * @param {Order} order
   */
  function renderPickupCode(order){
    // Code anzeigen (nur wenn PAID - Guard bereits in showPickupCode)
    const codeEl = document.getElementById('pickupCodeValue');
    if(codeEl){
      const code = order.pickupCode || order.code || '';
      // Code gro√ü anzeigen (Format: 1A, 2B, etc.)
      codeEl.textContent = code || '‚Äì';
      codeEl.style.fontSize = '64px'; // Gr√∂√üer f√ºr bessere Lesbarkeit
      codeEl.style.letterSpacing = '2px';
    }
    
    // Bestellinfos
    const dishEl = document.getElementById('pickupCodeDish');
    if(dishEl) dishEl.textContent = order.dishName || order.summary || '‚Äì';
    
    const providerEl = document.getElementById('pickupCodeProvider');
    if(providerEl) providerEl.textContent = order.providerName || '‚Äì';
    
    const timeEl = document.getElementById('pickupCodeTime');
    if(timeEl){
      // Use pickupWindow (from order) or fallback to etaTime/pickupTime
      const timeWindow = order.pickupWindow || order.etaTime || order.pickupTime || 'offen';
      // Format: Show date if available
      let timeText = timeWindow;
      if(order.pickupDate){
        const date = new Date(order.pickupDate);
        const dateStr = `${date.getDate()}.${String(date.getMonth()+1).padStart(2,'0')}.`;
        timeText = `${dateStr} ¬∑ ${timeWindow}`;
      }
      timeEl.textContent = timeText;
    }
    
    const typeEl = document.getElementById('pickupCodeType');
    if(typeEl){
      const fulfillType = order.fulfillType || (order.dineInPossible ? 'DINE_IN' : 'PICKUP');
      // Formatierung: PICKUP -> "Zum Mitnehmen", DINE_IN -> "Vor Ort"
      typeEl.textContent = fulfillType === 'DINE_IN' ? 'Vor Ort' : 'Zum Mitnehmen';
    }
    
    const totalEl = document.getElementById('pickupCodeTotal');
    if(totalEl){
      // Total in EUR formatieren (cents ‚Üí ‚Ç¨ mit 2 Dezimalstellen)
      const totalCents = order.totalCents || (order.total ? Math.round(order.total * 100) : 0);
      const totalEur = totalCents / 100;
      totalEl.textContent = totalEur > 0 ? euro(totalEur) : '‚Äì';
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }

  // --- Provider views ---
  function showProviderHome(){
    setProviderNavActive('provider-home');
    showView(views.providerHome);
    renderProviderHome();
    
    // FAB anzeigen
    const fab = document.getElementById('fabProviderAddOffer');
    const fabLabel = document.getElementById('fabProviderAddOfferLabel');
    if(fab) fab.style.display = 'flex';
    if(fabLabel) fabLabel.style.display = 'block';
  }
  function showProviderPickups(){
    setProviderNavActive('provider-pickups');
    showView(views.providerPickups);
    renderProviderPickups();
    // FAB ausblenden
    const fab = document.getElementById('fabProviderAddOffer');
    const fabLabel = document.getElementById('fabProviderAddOfferLabel');
    if(fab) fab.style.display = 'none';
    if(fabLabel) fabLabel.style.display = 'none';
  }
  function showProviderWeek(){
    setProviderNavActive('provider-home');
    showView(views.providerWeek);
    renderWeekPlan();
    // FAB ausblenden
    const fab = document.getElementById('fabProviderAddOffer');
    const fabLabel = document.getElementById('fabProviderAddOfferLabel');
    if(fab) fab.style.display = 'none';
    if(fabLabel) fabLabel.style.display = 'none';
  }
  function showProviderCookbook(){
    setProviderNavActive('provider-cookbook');
    showView(views.providerCookbook);
    renderCookbook();
    // FAB ausblenden
    const fab = document.getElementById('fabProviderAddOffer');
    const fabLabel = document.getElementById('fabProviderAddOfferLabel');
    if(fab) fab.style.display = 'none';
    if(fabLabel) fabLabel.style.display = 'none';
  }
  function showProviderProfile(){
    setProviderNavActive('provider-profile');
    showView(views.providerProfile);
    renderProviderProfile();
    // FAB ausblenden
    const fab = document.getElementById('fabProviderAddOffer');
    const fabLabel = document.getElementById('fabProviderAddOfferLabel');
    if(fab) fab.style.display = 'none';
    if(fabLabel) fabLabel.style.display = 'none';
  }
  function showProviderBilling(){
    setProviderNavActive('provider-profile');
    showView(views.providerBilling);
    renderBilling();
  }

  // --- Chips render ---
  function renderChips(){
    const catEl = document.getElementById('catChips');
    const dayEl = document.getElementById('dayChips');
    if(!catEl || !dayEl){
      return;
    }
    catEl.innerHTML='';
    // Discover Filter Chips: "In der N√§he" (default) + Kategorien
    const discoverCats = [
      {id: 'near', label: 'In der N√§he', icon: null},
      {id: 'Vegan', label: 'Vegan', icon: 'leaf'},
      {id: 'Vegetarisch', label: 'Vegetarisch', icon: 'carrot'},
      {id: 'Fisch', label: 'Fisch', icon: 'fish'},
      {id: 'Mit Fleisch', label: 'Mit Fleisch', icon: 'drumstick'}
    ];
    
    discoverCats.forEach(cat=>{
      const b=document.createElement('button');
      b.className='discover-category-chip' + (activeDiscoverFilter === cat.id ? ' active' : '');
      b.innerHTML = cat.icon ? `${iconMarkup(cat.icon)}<span>${esc(cat.label)}</span>` : `<span>${esc(cat.label)}</span>`;
      b.onclick=()=>{
        activeDiscoverFilter = cat.id;
        renderChips();
        renderDiscover();
      };
      catEl.appendChild(b);
    });

    dayEl.innerHTML='';
    // Date Swipebar: Heute + n√§chste 6 Tage
    const today = new Date();
    for(let i=0;i<7;i++){
      const d=new Date(today); d.setDate(d.getDate()+i);
      const key=isoDate(d);
      const b=document.createElement('button');
      b.className='discover-calendar-day'+(activeDay===key?' active':'');
      // Format: "Heute" f√ºr heute, sonst "Montag, 24.01."
      if(i===0){
        b.textContent = 'Heute';
      } else {
        b.textContent = fmtDay(d);
      }
      b.onclick=()=>{ activeDay=key; renderChips(); renderDiscover(); };
      dayEl.appendChild(b);
    }
  }

  function renderStartChips(){
    const catEl = document.getElementById('startCatChips');
    const dayEl = document.getElementById('startDayChips');
    if(!catEl || !dayEl){
      return;
    }
    catEl.innerHTML='';
    CATEGORIES.forEach(c=>{
      const b=document.createElement('button');
      b.className='chip'+(activeCat===c?' active':'');
      // Icon Mapping: Vegan=leaf, Vegetarisch=carrot, Mit Fleisch=drumstick
      const iconName = c==='Vegan' ? 'leaf' : (c==='Vegetarisch' ? 'carrot' : 'drumstick');
      b.innerHTML = `${iconMarkup(iconName)}<span>${esc(c)}</span>`;
      b.onclick=()=>{
        activeCat = activeCat===c ? null : c;
        renderStart();
        renderDiscover();
      };
      catEl.appendChild(b);
    });

    dayEl.innerHTML='';
    for(let i=0;i<5;i++){
      const d=new Date(); d.setDate(d.getDate()+i);
      const key=isoDate(d);
      const b=document.createElement('button');
      b.className='day'+(activeDay===key?' active':'');
      b.textContent = fmtDay(d);
      b.onclick=()=>{ activeDay=key; renderStart(); renderDiscover(); };
      dayEl.appendChild(b);
    }
  }

  function renderStart(){
    renderStartChips();
    renderStartDiscover();
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }

  function renderStartDiscover(){
    const grid = document.getElementById('startOfferGrid');
    const empty = document.getElementById('startEmptyOffers');
    const loc = document.getElementById('startLocationInput');
    
    if(!grid || !empty) return;

    // Standort-Suche
    if(loc){
      if(loc.value !== locationQuery) loc.value = locationQuery || '';
      loc.oninput=()=>{ locationQuery = loc.value; renderStart(); renderDiscover(); };
    }

    let list = offers.filter(o => o.day === activeDay && o.active !== false);

    if(activeCat){
      const cat = CAT_MAP[activeCat] || activeCat;
      list = list.filter(o => (o.category||'') === cat);
    }

    const q = String(locationQuery||'').trim().toLowerCase();
    if(q){
      list = list.filter(o=>{
        const data = normalizeOffer(o);
        const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity});
        return String(addr||'').toLowerCase().includes(q);
      });
    }

    // Normale Kacheln rendern
    grid.innerHTML='';
    empty.textContent = q ? 'Keine Angebote f√ºr diesen Standort.' : 'Noch keine Angebote. Demo: Als Anbieter ein Inserat erstellen.';
    empty.style.display = list.length ? 'none' : 'block';

    list.slice(0,6).forEach(o=> grid.appendChild(offerCard(o, {context:'start'})));
  }

  function createChatBubble(offer){
    const data = normalizeOffer(offer);
    const bubble = document.createElement('div');
    bubble.className='chat-bubble';
    bubble.onclick=()=>openOffer(data.id);
    
    const timeAgo = 'vor 2h'; // Placeholder
    const distance = data.distanceKm ? `${Number(data.distanceKm).toFixed(1)} km` : '';
    // Food type icon (keine Emojis)
    const foodTypeIcon = data.category === 'Vegan' ? 'leaf' : 
                         data.category === 'Vegetarisch' ? 'carrot' : 
                         data.category === 'Mit Fleisch' ? 'drumstick' : 
                         data.category === 'Fisch' ? 'fish' : '';
    
    bubble.innerHTML=`
      <div class="chat-bubble-header">
        <div class="chat-bubble-avatar">
          <img src="${esc(data.imageUrl || 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60')}" alt="${esc(data.providerName || '')}" />
        </div>
        <div class="chat-bubble-meta">
          <div class="chat-bubble-name">${esc(data.providerName || 'Anbieter')}</div>
          <div class="chat-bubble-time">
            ${iconMarkup('clock')}
            <span>${timeAgo}</span>
          </div>
        </div>
        ${distance ? `<div class="chat-bubble-distance">${distance}</div>` : ''}
      </div>
      ${data.imageUrl ? `<img src="${esc(data.imageUrl)}" alt="${esc(data.dish || '')}" class="chat-bubble-image" />` : ''}
      <div class="chat-bubble-message">
        Hey! Heute gibt's ${foodTypeIcon ? iconMarkup(foodTypeIcon) : ''} <strong>${esc(data.dish || 'Gericht')}</strong> f√ºr <strong>${euro(data.price || 0)}</strong> ‚Äì wer ist dabei?
      </div>
      <div class="chat-bubble-actions">
        <button class="chat-bubble-btn chat-bubble-btn-primary" onclick="event.stopPropagation(); const o=offers.find(x=>x.id==='${data.id}'); if(o) openOffer('${data.id}');">Dabei sein</button>
      </div>
    `;
    
    return bubble;
  }

  // --- Discover render (App-like UX, PWA, Light Mode) ---
  let activeDiscoverFilter = 'near'; // 'near', 'Vegan', 'Vegetarisch', 'Mit Fleisch'
  
  function renderDiscover(){
    // Header: Standort-Input
    const locationInput = document.getElementById('discoverLocationInput');
    if(locationInput){
      locationInput.value = locationQuery || '';
      locationInput.oninput = ()=>{
        locationQuery = locationInput.value;
        renderDiscover();
      };
      locationInput.onkeydown = (e)=>{
        if(e.key === 'Enter'){
          e.preventDefault();
          renderDiscover();
        }
      };
    }
    
    // Location Search Button
    const btnLocationSearch = document.getElementById('btnDiscoverLocationSearch');
    if(btnLocationSearch){
      btnLocationSearch.onclick = ()=>{
        if(locationInput) locationInput.focus();
      };
    }
    
    // Kategorien rendern (ohne √úberschrift)
    const categoriesEl = document.getElementById('discoverCategories');
    if(categoriesEl){
      categoriesEl.innerHTML = '';
      const cats = [
        {id:'near', label:'In der N√§he', icon: null},
        {id:'Vegan', label:'Vegan', icon: 'leaf'},
        {id:'Vegetarisch', label:'Vegetarisch', icon: 'carrot'},
        {id:'Fisch', label:'Fisch', icon: 'fish'},
        {id:'Mit Fleisch', label:'Mit Fleisch', icon: 'drumstick'}
      ];
      cats.forEach(cat=>{
        const btn = document.createElement('button');
        btn.className = 'discover-category-chip' + (activeDiscoverFilter === cat.id ? ' active' : '');
        btn.innerHTML = cat.icon ? `${iconMarkup(cat.icon)}<span>${esc(cat.label)}</span>` : `<span>${esc(cat.label)}</span>`;
        btn.onclick = ()=>{
          activeDiscoverFilter = cat.id;
          renderDiscover();
        };
        categoriesEl.appendChild(btn);
      });
    }
    
    // Kalender rendern (ohne √úberschrift, distinct style)
    const calendarEl = document.getElementById('discoverCalendar');
    if(calendarEl){
      calendarEl.innerHTML = '';
      const today = new Date();
      for(let i=0; i<7; i++){
        const d = new Date(today);
        d.setDate(d.getDate() + i);
        const key = isoDate(d);
        
        const btn = document.createElement('button');
        btn.className = 'discover-day' + (activeDay === key ? ' active' : '');
        // Format: "Heute" f√ºr heute, sonst "Montag, 24.01."
        if(i === 0){
          btn.textContent = 'Heute';
        } else {
          btn.textContent = fmtDay(d);
        }
        btn.onclick = ()=>{
          activeDay = key;
          renderDiscover();
        };
        calendarEl.appendChild(btn);
      }
    }
    
    // Angebote filtern
    let list = offers.filter(o => o.day === activeDay && o.active !== false);
    
    // Kategorie-Filter (entferne doppelte "In der N√§he" Filterung)
    if(activeDiscoverFilter !== 'near'){
      const cat = CAT_MAP[activeDiscoverFilter] || activeDiscoverFilter;
      list = list.filter(o => (o.category||'') === cat);
    }
    // "In der N√§he" zeigt alle Angebote (keine zus√§tzliche Filterung)
    
    // Standort-Filter
    const q = String(locationQuery||'').trim().toLowerCase();
    if(q){
      list = list.filter(o=>{
        const data = normalizeOffer(o);
        const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity});
        return String(addr||'').toLowerCase().includes(q);
      });
    }
    
    // List Cards rendern (horizontale List-Cards statt Hero Cards)
    const offersEl = document.getElementById('discoverOffers');
    const emptyEl = document.getElementById('discoverEmpty');
    if(offersEl && emptyEl){
      offersEl.innerHTML = '';
      emptyEl.style.display = list.length ? 'none' : 'block';
      
      list.forEach(o=> offersEl.appendChild(createDiscoverListCard(o)));
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }
  
  // List Card f√ºr Discover-Seite (kompakt, horizontal, app-like)
  function createDiscoverListCard(o){
    const data = normalizeOffer(o);
    const card = document.createElement('div');
    card.className = 'discover-list-card';
    
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    
    // Badges (mit Icons statt Emojis)
    const badges = [];
    if(data.hasPickupCode) badges.push(`<div class="discover-list-badge code">${iconMarkup('key-round')} <span>Abholcode</span></div>`);
    if(data.dineInPossible) badges.push(`<div class="discover-list-badge dine">${iconMarkup('utensils')} <span>Vor Ort</span></div>`);
    if(!data.dineInPossible && !data.hasPickupCode) badges.push(`<div class="discover-list-badge pickup">${iconMarkup('shopping-bag')} <span>Zum Mitnehmen</span></div>`);
    
    // Meta-Info (optional: time/qty/distance) - mit Icons
    const metaInfo = [];
    if(data.pickupWindow) metaInfo.push(`<span class="discover-list-info">${iconMarkup('clock')} <span>${esc(data.pickupWindow)}</span></span>`);
    if(data.distanceKm != null) metaInfo.push(`<span class="discover-list-info">${iconMarkup('map-pin')} <span>${Number(data.distanceKm).toFixed(1)}</span></span>`);
    if(data.availableCount != null) metaInfo.push(`<span class="discover-list-info">${iconMarkup('box')} <span>${data.availableCount}</span></span>`);
    
    // Food type icon
    const foodTypeIcon = data.category === 'Vegan' ? 'leaf' : 
                         data.category === 'Vegetarisch' ? 'carrot' : 
                         data.category === 'Mit Fleisch' ? 'drumstick' : 
                         data.category === 'Fisch' ? 'fish' : '';
    if(foodTypeIcon) metaInfo.push(`<span class="discover-list-info">${iconMarkup(foodTypeIcon)}</span>`);
    
    card.innerHTML = `
      <div class="discover-list-image">
        <img src="${esc(imgSrc)}" alt="${esc(data.dish||'')}" />
      </div>
      <div class="discover-list-content">
        <h3 class="discover-list-title">${esc(data.dish||'Gericht')}</h3>
        <p class="discover-list-provider">${esc(data.providerName||'Anbieter')}</p>
        <div class="discover-list-meta">
          <span class="discover-list-price">${euro(data.price)}</span>
          ${metaInfo.length ? metaInfo.join('') : ''}
        </div>
        ${badges.length ? `<div class="discover-list-badges">${badges.join('')}</div>` : ''}
        <div class="discover-list-actions">
          <button class="discover-list-btn" onclick="event.stopPropagation(); const o=offers.find(x=>x.id==='${data.id}'); if(o) handleOrderClick(o);">
            ${data.hasPickupCode ? iconMarkup('shopping-cart') + ' <span>Bestellen</span>' : iconMarkup('eye') + ' <span>Details</span>'}
          </button>
        </div>
      </div>
    `;
    
    // Klick auf Kachel √∂ffnet direkt Bestellung (wenn m√∂glich) oder Details
    card.onclick = (e)=>{
      if(e.target.closest('.discover-list-btn')) return; // Button-Handler √ºbernimmt
      if(data.hasPickupCode){
        handleOrderClick(o);
      } else {
        openOffer(data.id);
      }
    };
    
    return card;
  }

  function offerCard(o, opts={}){
    const data = normalizeOffer(o);
    const interactive = opts.interactive !== false;
    const card=document.createElement('div');
    card.className='card';
    if(opts.context === 'start' || opts.context === 'customer'){
      card.classList.add('playful');
    }
    if(interactive){
      card.onclick=()=>openOffer(data.id);
    } else {
      card.style.cursor='default';
    }

    // Image
    const img=document.createElement('div');
    img.className='img';
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    img.innerHTML = `<img alt="${esc(data.dish||'')}" src="${esc(imgSrc)}" />`;

    // Heart Icon (Favorit) - rechts oben (kein Text, nur Icon)
    const dishKey = data.id;
    const heart=document.createElement('button');
    heart.className='card-heart'+(dishFavs.has(dishKey)?' on':'');
    heart.type='button';
    heart.innerHTML = dishFavs.has(dishKey) ? iconMarkup('heart', {fill:true}) : iconMarkup('heart');
    heart.onclick=(e)=>{ e.stopPropagation(); toggleDishFav(dishKey); };
    if(interactive){ card.appendChild(heart); }

    // Body
    const body=document.createElement('div');
    body.className='body';
    
    // Titelzeile: Dish name (max 2 Zeilen)
    const titleRow = document.createElement('div');
    titleRow.className='card-title-row';
    const title = document.createElement('h3');
    title.className='card-title';
    title.textContent = data.dish || 'Gericht';
    titleRow.appendChild(title);
    body.appendChild(titleRow);
    
    // Anbieter: Kurzform mit Store-Icon
    const provider = document.createElement('p');
    provider.className='card-provider';
    provider.innerHTML = `${iconMarkup('store')} <span>${esc(data.providerName || 'Anbieter')}</span>`;
    body.appendChild(provider);
    
    // Pickup-Badges (obligatorisch, max 3, nach Anbieter, vor Preis)
    // Reihenfolge: Vor Ort ‚Üí Zum Mitnehmen ‚Üí Abholcode
    // Nur anwendbare Badges anzeigen
    const pickupBadges = [];
    
    // 1. Vor Ort (wenn dineInPossible)
    if(data.dineInPossible) {
      pickupBadges.push({class:'dine', text:'Vor Ort', icon:'utensils'});
    }
    
    // 2. Zum Mitnehmen (immer anzeigen, au√üer wenn nur Vor Ort m√∂glich)
    // Wenn dineInPossible false ist, dann ist es definitiv "Zum Mitnehmen"
    // Wenn dineInPossible true ist, kann es beides sein
    if(!data.dineInPossible) {
      // Nur Zum Mitnehmen m√∂glich
      pickupBadges.push({class:'pickup', text:'Zum Mitnehmen', icon:'shopping-bag'});
    } else if(pickupBadges.length < 3) {
      // Beides m√∂glich, aber max 3 Badges
      pickupBadges.push({class:'pickup', text:'Zum Mitnehmen', icon:'shopping-bag'});
    }
    
    // 3. Abholcode (wenn verf√ºgbar und noch Platz)
    if(data.hasPickupCode && pickupBadges.length < 3) {
      pickupBadges.push({class:'code', text:'Abholcode', icon:'key-round'});
    }
    
    // Max 3 Badges sicherstellen
    if(pickupBadges.length > 3) {
      pickupBadges.splice(3);
    }
    
    if(pickupBadges.length > 0){
      const badgesRow = document.createElement('div');
      badgesRow.className='card-status-badges';
      pickupBadges.forEach(badge => {
        const badgeEl = document.createElement('span');
        badgeEl.className = `card-status-badge ${badge.class}`;
        badgeEl.innerHTML = `${iconMarkup(badge.icon)} <span>${esc(badge.text)}</span>`;
        badgesRow.appendChild(badgeEl);
      });
      body.appendChild(badgesRow);
    }
    
    // Preis: Gro√ü & prominent, Markenfarbe
    const price = document.createElement('div');
    price.className='card-price';
    price.textContent = euro(data.price);
    body.appendChild(price);
    
    // Info-Zeile als Icon-Badges (eine Zeile, max 4 Icons, nur Icons + Zahlen)
    const infoRow = document.createElement('div');
    infoRow.className='card-info-badges';
    
    // clock: timeRange
    if(data.pickupWindow){
      const timeBadge = document.createElement('span');
      timeBadge.className='card-info-badge';
      timeBadge.innerHTML = `${iconMarkup('clock')} <span>${esc(data.pickupWindow)}</span>`;
      infoRow.appendChild(timeBadge);
    }
    
    // map-pin: distance
    if(data.distanceKm != null){
      const distBadge = document.createElement('span');
      distBadge.className='card-info-badge';
      distBadge.innerHTML = `${iconMarkup('map-pin')} <span>${Number(data.distanceKm).toFixed(1)}</span>`;
      infoRow.appendChild(distBadge);
    }
    
    // box: quantity/availability
    if(data.availableCount != null){
      const qtyBadge = document.createElement('span');
      qtyBadge.className='card-info-badge';
      qtyBadge.innerHTML = `${iconMarkup('box')} <span>${data.availableCount}</span>`;
      infoRow.appendChild(qtyBadge);
    }
    
    // food type: leaf (Vegan), carrot (Vegetarian), drumstick (Meat), fish (Fish)
    const foodTypeIcon = data.category === 'Vegan' ? 'leaf' : 
                         data.category === 'Vegetarisch' ? 'carrot' : 
                         data.category === 'Mit Fleisch' ? 'drumstick' : 
                         data.category === 'Fisch' ? 'fish' : '';
    if(foodTypeIcon){
      const typeBadge = document.createElement('span');
      typeBadge.className='card-info-badge';
      typeBadge.innerHTML = iconMarkup(foodTypeIcon);
      infoRow.appendChild(typeBadge);
    }
    
    // Max 4 Icons pro Info-Zeile
    if(infoRow.children.length > 4){
      while(infoRow.children.length > 4){
        infoRow.removeChild(infoRow.lastChild);
      }
    }
    
    if(infoRow.children.length > 0){
      body.appendChild(infoRow);
    }
    
    // Actions: Nur ein Primary CTA "Bestellen"
    if(interactive){
      const actions=document.createElement('div');
      actions.className='card-actions';
      
      const orderBtn=document.createElement('button');
      orderBtn.type='button';
      orderBtn.className='card-action primary';
      orderBtn.innerHTML = `${iconMarkup('shopping-cart')} <span>Bestellen</span>`;
      orderBtn.disabled = !data.hasPickupCode;
      orderBtn.onclick=(e)=>{ e.stopPropagation(); handleOrderClick(data); };
      
      actions.appendChild(orderBtn);
      body.appendChild(actions);
    }

    card.appendChild(img);
    card.appendChild(body);
    
    // Icons aktualisieren (f√ºr Heart Icon)
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
    
    return card;
  }

  function providerCard(o, opts={}){
    const data = normalizeOffer(o);
    const interactive = opts.interactive !== false;
    const showActions = opts.showActions === true;
    const isToday = data.day === (opts.todayKey || isoDate(new Date()));
    const statusLine = data.hasPickupCode ? (isToday ? 'Online-Abholcode ¬∑ Heute' : 'Online-Abholcode') : '';
    const card=document.createElement('div');
    card.className='card';
    card.style.cursor = interactive ? 'pointer' : 'default';
    if(interactive){
      card.onclick=()=>openProviderOffer(data.id);
    }

    const profile = normalizeProviderProfile(provider.profile || {});
    const imgSrc = data.imageUrl || data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    const windowText = data.pickupWindow || profile.mealWindow || '';

    const img=document.createElement('div');
    img.className='img';
    img.innerHTML = `
      <img alt="${esc(data.dish||'Gericht')}" src="${esc(imgSrc)}" />
      ${data.active===false?'<div class="badge inactive">Inaktiv</div>':''}
      ${data.hasPickupCode?'<div class="badge code">Abholcode</div>':''}
      ${data.dineInPossible?'<div class="badge dine">Vor Ort</div>':''}
    `;

    const body=document.createElement('div');
    body.className='body';
    body.innerHTML = `
      <p class="title">${esc(data.dish||'Gericht')}</p>
      <p class="sub">Essenszeit: ${esc(windowText || '‚Äî')}</p>
      ${statusLine ? `<div class="tag">${esc(statusLine)}</div>` : ''}
      <div class="meta">
        <div class="price">${euro(data.price)}</div>
        <div class="right">
          <div>${esc(data.category||'')}</div>
        </div>
      </div>
    `;

    const info=document.createElement('div');
    info.className='info-row';
    const addInfo = (icon, text)=>{
      const item=document.createElement('div');
      item.className='info-item';
      item.innerHTML = `${iconMarkup(icon)}<span>${esc(text)}</span>`;
      info.appendChild(item);
    };
    if(data.hasPickupCode) addInfo('card', 'Online-Abholcode');
    if(data.dineInPossible) addInfo('utensils', 'Vor Ort');
    if(info.childElementCount){ body.appendChild(info); }

    if(showActions){
      const actions=document.createElement('div');
      actions.className='card-actions';

      const actBtn=document.createElement('button');
      actBtn.type='button';
      actBtn.className='card-action';
      actBtn.innerHTML = `${iconMarkup('action')}<span>Aktionen</span>`;
      actBtn.onclick=(e)=>{ e.stopPropagation(); openProviderOffer(data.id); };

      const shareBtn=document.createElement('button');
      shareBtn.type='button';
      shareBtn.className='card-action';
      shareBtn.innerHTML = `${iconMarkup('share')}<span>Teilen</span>`;
      shareBtn.onclick=(e)=>{ e.stopPropagation(); shareOffer(data); };

      const printBtn=document.createElement('button');
      printBtn.type='button';
      printBtn.className='card-action';
      printBtn.innerHTML = `${iconMarkup('print')}<span>Drucken</span>`;
      printBtn.onclick=(e)=>{ e.stopPropagation(); printOffer(data); };

      actions.appendChild(actBtn);
      actions.appendChild(shareBtn);
      actions.appendChild(printBtn);
      body.appendChild(actions);
    }

    card.appendChild(img);
    card.appendChild(body);
    return card;
  }

  function toggleProviderFav(providerId){
    if(!providerId) return;
    if(providerFavs.has(providerId)) providerFavs.delete(providerId); else providerFavs.add(providerId);
    const arr = Array.from(providerFavs);
    save(LS.providerFavs, arr);
    // keep legacy key for compatibility
    save(LS.favs, arr);
    renderDiscover();
    renderStart();
    renderFavorites();
    updateSheetFavs();
  }

  function toggleDishFav(offerId){
    if(!offerId) return;
    if(dishFavs.has(offerId)) dishFavs.delete(offerId); else dishFavs.add(offerId);
    save(LS.dishFavs, Array.from(dishFavs));
    renderDiscover();
    renderStart();
    renderFavorites();
    updateSheetFavs();
  }

  function renderFavorites(){
    const provGrid=document.getElementById('favProviders');
    const provEmpty=document.getElementById('emptyFavProviders');
    const dishGrid=document.getElementById('favDishes');
    const dishEmpty=document.getElementById('emptyFavDishes');
    if(!provGrid || !dishGrid || !provEmpty || !dishEmpty) return;

    const candidates = offers
      .filter(o => o.active !== false && providerFavs.has(o.providerId))
      .sort((a,b)=>String(b.day||'').localeCompare(String(a.day||'')));
    const bestByProvider = new Map();
    candidates.forEach(o=>{
      if(!bestByProvider.has(o.providerId)) bestByProvider.set(o.providerId, o);
    });
    const providerList = Array.from(bestByProvider.values());

    provGrid.innerHTML='';
    provEmpty.style.display = providerList.length ? 'none' : 'block';
    providerList.forEach(o=>provGrid.appendChild(offerCard(o)));

    const dishList = offers
      .filter(o => o.active !== false && dishFavs.has(o.id))
      .sort((a,b)=>String(b.day||'').localeCompare(String(a.day||'')));
    dishGrid.innerHTML='';
    dishEmpty.style.display = dishList.length ? 'none' : 'block';
    dishList.forEach(o=>dishGrid.appendChild(offerCard(o)));
  }

  // Legacy: genPickupCode (wird durch generatePickupCode ersetzt)
  function genPickupCode(){
    return generatePickupCode();
  }

  function renderOrders(){
    // Orders aus localStorage laden
    orders = loadOrders();
    
    const box = document.getElementById('ordersList');
    const filters = document.getElementById('ordersFilters');
    if(!box) return;
    if(filters){
      filters.innerHTML='';
      [
        {id:'offen', label:'Offen'},
        {id:'abgeholt', label:'Abgeholt'},
        {id:'alle', label:'Alle'}
      ].forEach(f=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(ordersFilter===f.id?' on':'');
        b.textContent=f.label;
        b.onclick=()=>{ ordersFilter=f.id; renderOrders(); };
        filters.appendChild(b);
      });
    }
    if(!orders.length){
      box.textContent = 'Noch keine Bestellungen.';
      return;
    }
    const fmt = (ts)=>{
      const d = new Date(ts);
      if(Number.isNaN(d.getTime())) return '';
      return fmtDay(d);
    };
    const list = orders.filter(o=>{
      if(ordersFilter==='alle') return true;
      // Map status for filter matching
      const status = o.status || 'offen';
      if(ordersFilter === 'offen'){
        // Show PAID orders (not picked up)
        return status === 'PAID';
      }
      if(ordersFilter === 'abgeholt'){
        // Show PICKED_UP or COMPLETED orders
        return status === 'PICKED_UP' || status === 'COMPLETED' || o.pickupStatus === 'PICKED_UP';
      }
      return status === ordersFilter;
    });
    list.sort((a,b)=>{
      if(ordersFilter === 'alle'){
        const sa = a.status || 'offen';
        const sb = b.status || 'offen';
        // Sortierung: PAID > PAYMENT_PENDING > CREATED > andere
        const priority = { 'PAID': 1, 'PAYMENT_PENDING': 2, 'CREATED': 3, 'offen': 4 };
        const pa = priority[sa] || 5;
        const pb = priority[sb] || 5;
        if(pa !== pb) return pa - pb;
      }
      return (b.createdAt||0) - (a.createdAt||0);
    });
    if(!list.length){
      box.textContent = 'Keine passenden Bestellungen.';
      return;
    }
    box.innerHTML = list.map(o=>{
      // Status-Anzeige
      const status = o.status || 'offen';
      // Check for PICKED_UP status (from pickupStatus field or status)
      // Single source of truth: Order record
      const isPickedUp = status === 'PICKED_UP' || status === 'COMPLETED' || o.pickupStatus === 'PICKED_UP' || status === 'abgeholt';
      const statusLabel = isPickedUp ? 'Abgeholt ‚úÖ' :
                         status === 'CREATED' ? 'Erstellt' :
                         status === 'PAYMENT_PENDING' ? 'Zahlung ausstehend' :
                         status === 'PAID' ? 'Bezahlt' :
                         status === 'CANCELLED' ? 'Abgebrochen' :
                         status;
      const isDone = isPickedUp;
      const code = o.pickupCode || o.code || '';
      // Code nur anzeigen wenn PAID (Guard)
      const showCode = status === 'PAID' && code;
      
      return `
      <div class="order-item ${isDone ? 'done' : ''}">
        <div class="order-top">
          <div>
            <div style="font-weight:900">${esc(o.providerName || 'Anbieter')}</div>
            <div class="hint">${esc(o.dishName || o.summary || '')}</div>
          </div>
          <div class="order-right">
            ${showCode ? `<button class="order-code" type="button" data-id="${esc(o.id||'')}" data-code="${esc(code)}">${esc(code)}</button>` : ''}
            <div class="status-pill ${isDone ? 'done' : 'open'}">${esc(statusLabel)}</div>
          </div>
        </div>
        <div class="hint" style="margin-top:6px;">
          ${o.total ? `Gesamt: ${euro(o.totalCents ? (o.totalCents / 100) : (o.total || 0))} ¬∑ ` : ''}${o.etaTime ? `Abholzeit: ${esc(o.etaTime)} ¬∑ ` : ''}${fmt(o.createdAt)}
        </div>
      </div>
    `;
    }).join('');

    box.querySelectorAll('.order-code').forEach(btn=>{
      btn.onclick=()=> {
        const orderId = btn.getAttribute('data-id') || '';
        showPickupCode(orderId); // Navigiere zu AbholcodeScreen statt codeSheet
      };
    });
  }

  function openCodeSheet(orderId){
    const order = orders.find(o=>o.id===orderId);
    if(!order) return;
    activeOrderId = orderId;
    document.getElementById('codeText').textContent = order.code || '';
    document.getElementById('codeStatus').textContent = order.status === 'abgeholt' ? 'Status: abgeholt' : 'Status: offen';
    document.getElementById('btnToggleOrderStatus').textContent = order.status === 'abgeholt' ? 'Als offen markieren' : 'Als abgeholt markieren';
    document.getElementById('codeProvider').textContent = order.providerName || 'Anbieter';
    document.getElementById('codeSummary').textContent = order.summary || '';
    document.getElementById('codePickupWindow').textContent = order.pickupWindow ? `Essenszeit: ${order.pickupWindow}` : 'Essenszeit: ‚Äì';
    document.getElementById('codePickupTime').textContent = order.pickupTime ? order.pickupTime : 'offen';
    
    // Logo rendern (falls vorhanden)
    const logoEl = document.getElementById('codeProviderLogo');
    if(logoEl){
      const providerOffer = offers.find(o=>o.providerName === order.providerName);
      if(providerOffer && providerOffer.providerLogo){
        logoEl.innerHTML = `<img src="${providerOffer.providerLogo}" alt="Logo" />`;
      } else {
        logoEl.innerHTML = `<img src="assets/provider-placeholder.png" alt="Logo" />`;
      }
    }
    
    document.getElementById('codeBd').classList.add('active');
    document.getElementById('codeSheet').classList.add('active');
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }
  function closeCodeSheet(){
    document.getElementById('codeBd').classList.remove('active');
    document.getElementById('codeSheet').classList.remove('active');
    activeOrderId = null;
  }

  // --- Offer sheet ---
  let activeOfferId=null;
  let activeProviderOfferId=null;
  // Navigation History f√ºr Back-Button
  let navigationHistory = [];
  
  function openOffer(id){
    const raw = offers.find(x=>x.id===id);
    if(!raw) return;
    const o = normalizeOffer(raw);
    activeOfferId=id;
    
    // History speichern (inkl. Scroll-Position)
    navigationHistory.push({
      view: mode === 'start' ? 'start' : 'discover',
      locationQuery: locationQuery,
      activeCat: activeCat,
      activeDay: activeDay,
      activeFilter: activeDiscoverFilter,
      scrollY: window.scrollY
    });

    const sImg = document.getElementById('sImg');
    const sDish = document.getElementById('sDish');
    const sProvider = document.getElementById('sProvider');
    const sPrice = document.getElementById('sPrice');
    const sCat = document.getElementById('sCat');
    const sWindow = document.getElementById('sWindow');
    
    if(sImg) sImg.src = o.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    if(sDish) sDish.textContent = o.dish || '';
    // Provider mit Icon
    const sProviderEl = document.getElementById('sProvider');
    if(sProviderEl){
      const providerSpan = sProviderEl.querySelector('span');
      if(providerSpan) providerSpan.textContent = o.providerName || 'Anbieter';
    }
    // Preis wird nicht mehr angezeigt (√∂ffentliche Seite)
    // if(sPrice) sPrice.textContent = euro(o.price);
    if(sCat) sCat.textContent = o.category || '';
    if(sWindow) sWindow.textContent = o.pickupWindow || '';
    
    // Status Badge (dynamisch basierend auf Abholcode)
    const statusBadgeEl = document.getElementById('sStatusBadge');
    if(statusBadgeEl){
      if(o.hasPickupCode){
        // MIT Abholcode: Status "Online bezahlen & Abholcode"
        statusBadgeEl.innerHTML = '<span style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px; background:rgba(46,125,50,.12); border-radius:8px; color:#2e7d32; font-size:14px; font-weight:600;">üü¢ Online bezahlen & Abholcode</span>';
      } else {
        // OHNE Abholcode: Status "Vor Ort erh√§ltlich"
        statusBadgeEl.innerHTML = '<span style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px; background:rgba(0,0,0,.06); border-radius:8px; color:#666; font-size:14px; font-weight:600;">‚ö™ Vor Ort erh√§ltlich</span>';
      }
    }

    // Badges Row (max 3)
    const badgesEl = document.getElementById('sBadges');
    if(badgesEl){
      badgesEl.innerHTML = '';
      const badges = [];
      if(o.dineInPossible) badges.push({class:'dine', text:'Vor Ort', icon:'utensils'});
      if(!o.dineInPossible || badges.length < 3) badges.push({class:'pickup', text:'Zum Mitnehmen', icon:'shopping-bag'});
      if(o.hasPickupCode && badges.length < 3) badges.push({class:'code', text:'Abholcode', icon:'key-round'});
      
      badges.slice(0, 3).forEach(badge => {
        const badgeEl = document.createElement('span');
        badgeEl.className = `card-status-badge ${badge.class}`;
        badgeEl.innerHTML = `${iconMarkup(badge.icon)} <span>${esc(badge.text)}</span>`;
        badgesEl.appendChild(badgeEl);
      });
    }
    
    // Info Row (Icons: clock, map-pin, food icon)
    const infoRowEl = document.getElementById('sInfoRow');
    if(infoRowEl){
      infoRowEl.innerHTML = '';
      if(o.pickupWindow){
        const day = o.day ? new Date(o.day) : new Date();
        const dateStr = fmtDateWithTime(day, o.pickupWindow);
        const timeEl = document.createElement('div');
        timeEl.style.display = 'flex';
        timeEl.style.alignItems = 'center';
        timeEl.style.gap = '6px';
        timeEl.innerHTML = `${iconMarkup('clock')} <span>${esc(dateStr)}</span>`;
        infoRowEl.appendChild(timeEl);
      }
      if(o.distanceKm != null){
        const distEl = document.createElement('div');
        distEl.style.display = 'flex';
        distEl.style.alignItems = 'center';
        distEl.style.gap = '6px';
        distEl.innerHTML = `${iconMarkup('map-pin')} <span>${Number(o.distanceKm).toFixed(1)} km</span>`;
        infoRowEl.appendChild(distEl);
      }
      // Food type icon (exactly one)
      const foodTypeIcon = o.category === 'Vegan' ? 'leaf' : 
                           o.category === 'Vegetarisch' ? 'carrot' : 
                           o.category === 'Fisch' ? 'fish' :
                           o.category === 'Mit Fleisch' ? 'drumstick' : '';
      if(foodTypeIcon){
        const foodEl = document.createElement('div');
        foodEl.innerHTML = iconMarkup(foodTypeIcon);
        infoRowEl.appendChild(foodEl);
      }
    }
    
    // Address Card
    const addr = buildAddress({address:o.address, street:o.providerStreet, zip:o.providerZip, city:o.providerCity});
    const maps = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
    const addressFullEl = document.getElementById('sAddressFull');
    if(addressFullEl){
      const fullAddr = [
        o.providerName || '',
        o.providerStreet || '',
        o.providerZip || '',
        o.providerCity || ''
      ].filter(Boolean).join(', ');
      addressFullEl.textContent = fullAddr || addr || '-';
    }
    
    const btnOpenRoute = document.getElementById('btnOpenRoute');
    if(btnOpenRoute){
      btnOpenRoute.onclick = () => {
        window.open(maps, '_blank');
      };
    }

    // Allergens
    const aw = document.getElementById('sAllergensWrap');
    if(o.allergens && o.allergens.length){
      aw.style.display='block';
      document.getElementById('sAllergens').textContent = o.allergens.join(', ');
    } else aw.style.display='none';

    // Extras
    const ew = document.getElementById('sExtrasWrap');
    if(o.extras && o.extras.length){
      ew.style.display='block';
      document.getElementById('sExtras').textContent = o.extras.map(e=>`${e.name} (+${euro(e.price)})`).join(' ¬∑ ');
    } else ew.style.display='none';

    // Reuse
    const rw = document.getElementById('sReuseWrap');
    if(o.reuse && o.reuse.enabled){
      rw.style.display='block';
      document.getElementById('sReuse').textContent = `Pfand ${euro(o.reuse.deposit)}`;
    } else rw.style.display='none';

    // Primary CTA (dynamisch basierend auf Abholcode)
    const primaryCTA = document.getElementById('btnPrimaryCTA');
    const primaryCTAText = document.getElementById('btnPrimaryCTAText');
    // btnOpenRoute wurde bereits oben deklariert (Zeile 4580)
    
    if(primaryCTA && primaryCTAText){
      // Reset states
      primaryCTA.disabled = false;
      primaryCTA.className = 'btn-primary';
      primaryCTA.classList.remove('loading', 'success');
      
      // Check if offer is active/available
      const isActive = o.active !== false;
      const todayKey = isoDate(new Date());
      const isToday = o.day === todayKey;
      const isAvailable = isActive && isToday;
      
      if(!isAvailable){
        // Disabled state with reason
        primaryCTA.disabled = true;
        if(!isActive){
          primaryCTAText.textContent = 'Angebot nicht verf√ºgbar';
        } else if(!isToday){
          primaryCTAText.textContent = 'Angebot nicht mehr verf√ºgbar';
        } else {
          primaryCTAText.textContent = 'Nicht verf√ºgbar';
        }
        primaryCTA.onclick = null;
      } else if(o.hasPickupCode){
        // MIT Abholcode: CTA "Jetzt online bestellen"
        primaryCTAText.textContent = 'Jetzt online bestellen';
        primaryCTA.onclick = () => {
          // Loading state
          primaryCTA.disabled = true;
          primaryCTA.classList.add('loading');
          primaryCTAText.textContent = 'Wird geladen...';
          
          // Navigate to cart/checkout
          setTimeout(() => {
            if(addToCart(o)){
              // Success state
              primaryCTA.classList.remove('loading');
              primaryCTA.classList.add('success');
              primaryCTAText.textContent = 'Erfolgreich!';
              showToast('Gericht zum Warenkorb hinzugef√ºgt');
              
              // Redirect to cart
              setTimeout(() => {
                showCart();
                // Reset button after navigation
                setTimeout(() => {
                  primaryCTA.disabled = false;
                  primaryCTA.classList.remove('success');
                  primaryCTAText.textContent = 'Jetzt online bestellen';
                }, 500);
              }, 300);
            } else {
              // Error: reset to default
              primaryCTA.disabled = false;
              primaryCTA.classList.remove('loading');
              primaryCTAText.textContent = 'Jetzt online bestellen';
              showToast('Fehler beim Hinzuf√ºgen. Bitte erneut versuchen.');
            }
          }, 200);
        };
      } else {
        // OHNE Abholcode: CTA "Route √∂ffnen"
        primaryCTAText.textContent = 'Route √∂ffnen';
        primaryCTA.onclick = () => {
          // Open route in maps (no loading state needed)
          const profile = normalizeProviderProfile(provider.profile || {});
          const address = `${profile.street || ''}, ${profile.zip || ''} ${profile.city || ''}`.trim();
          const maps = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
          window.open(maps, '_blank');
        };
      }
    }
    
    // Route Button in Address Card (nur bei OHNE Abholcode sichtbar)
    if(btnOpenRoute){
      if(!o.hasPickupCode){
        btnOpenRoute.style.display = 'block';
        btnOpenRoute.onclick = () => {
          const profile = normalizeProviderProfile(provider.profile || {});
          const address = `${profile.street || ''}, ${profile.zip || ''} ${profile.city || ''}`.trim();
          const maps = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
          window.open(maps, '_blank');
        };
      } else {
        btnOpenRoute.style.display = 'none';
      }
    }

    updateSheetFavs();

    document.getElementById('bd').classList.add('active');
    document.getElementById('sheet').classList.add('active');
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }

  function updateSheetFavs(){
    const providerBtn = document.getElementById('btnFav');
    const dishBtn = document.getElementById('btnDishFav');
    if(!activeOfferId){
      if(providerBtn) providerBtn.textContent='Anbieter speichern';
      if(dishBtn) dishBtn.textContent='Gericht speichern';
      return;
    }
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    const providerKey = o.providerId;
    const dishKey = o.id;
    if(providerBtn){
      const label = providerKey && providerFavs.has(providerKey) ? 'Anbieter entfernen' : 'Anbieter speichern';
      providerBtn.innerHTML = `${iconMarkup('heart')}<span>${esc(label)}</span>`;
    }
    if(dishBtn){
      const label = dishKey && dishFavs.has(dishKey) ? 'Gericht entfernen' : 'Gericht speichern';
      dishBtn.innerHTML = `${iconMarkup('heart')}<span>${esc(label)}</span>`;
    }
  }

  function closeSheet(){
    document.getElementById('bd').classList.remove('active');
    document.getElementById('sheet').classList.remove('active');
    
    // Zur√ºck zur vorherigen Ansicht (inkl. Scroll-Position)
    if(navigationHistory.length > 0){
      const prev = navigationHistory.pop();
      locationQuery = prev.locationQuery || '';
      activeCat = prev.activeCat || null;
      activeDay = prev.activeDay || isoDate(new Date());
      activeDiscoverFilter = prev.activeFilter || 'near';
      
      if(prev.view === 'start'){
        showStart();
      } else {
        showDiscover();
      }
      
      // Scroll-Position wiederherstellen
      if(prev.scrollY !== undefined){
        setTimeout(()=>{
          window.scrollTo({top: prev.scrollY, behavior: 'auto'});
        }, 100);
      }
    }
  }
  
  // Android Hardware-Back unterst√ºtzen
  window.addEventListener('popstate', function(e){
    // AGB Onboarding Modal schlie√üen
    if(document.getElementById('agbOnboardingSheet') && document.getElementById('agbOnboardingSheet').classList.contains('active')){
      closeAgbOnboardingModal();
      e.preventDefault();
      return;
    }
    // Fullscreen Code Modal schlie√üen
    if(document.getElementById('fullscreenCode') && document.getElementById('fullscreenCode').classList.contains('active')){
      closeFullscreenCode();
      e.preventDefault();
      history.pushState(null, '', location.pathname);
      return;
    }
    // Pickup Confirmation Sheet schlie√üen
    if(document.getElementById('pickupConfirmSheet') && document.getElementById('pickupConfirmSheet').classList.contains('active')){
      closePickupConfirmSheet();
      e.preventDefault();
      history.pushState(null, '', location.pathname);
      return;
    }
    // Create Flow Sheet schlie√üen
    if(document.getElementById('createFlowSheet') && document.getElementById('createFlowSheet').classList.contains('active')){
      closeCreateFlowSheet();
      e.preventDefault();
      history.pushState(null, '', location.pathname);
      return;
    }
    // FAQ Sheet schlie√üen
    if(document.getElementById('faqSheet') && document.getElementById('faqSheet').classList.contains('active')){
      closeFaqSheet();
      e.preventDefault();
      history.pushState(null, '', location.pathname);
      return;
    }
    // Login Modal schlie√üen
    if(document.getElementById('loginSheet') && document.getElementById('loginSheet').classList.contains('active')){
      closeLoginSheet();
      e.preventDefault();
      history.pushState(null, '', location.pathname);
      return;
    }
    // Wizard schlie√üen
    if(document.getElementById('wizard') && document.getElementById('wizard').classList.contains('active')){
      closeWizard();
      e.preventDefault();
      history.pushState(null, '', location.pathname);
      return;
    }
    // Sheet schlie√üen
    if(document.getElementById('sheet') && document.getElementById('sheet').classList.contains('active')){
      closeSheet();
      e.preventDefault();
      history.pushState(null, '', location.pathname);
      return;
    }
    // Onboarding back navigation
    const currentView = document.querySelector('.view.active');
    if(currentView && currentView.id.startsWith('v-provider-onboarding')){
      if(currentView.id === 'v-provider-onboarding-preview'){
        showOnboardingBusiness();
        e.preventDefault();
        history.pushState(null, '', location.pathname);
        return;
      } else if(currentView.id === 'v-provider-onboarding-business'){
        showOnboardingSignup();
        e.preventDefault();
        history.pushState(null, '', location.pathname);
        return;
      } else if(currentView.id === 'v-provider-onboarding-signup'){
        showOnboardingFirstDish(!!onboardingDraftDish);
        e.preventDefault();
        history.pushState(null, '', location.pathname);
        return;
      } else if(currentView.id === 'v-provider-onboarding-first-dish'){
        showOnboardingEntry(!!onboardingDraftDish);
        e.preventDefault();
        history.pushState(null, '', location.pathname);
        return;
      } else if(currentView.id === 'v-provider-onboarding-entry'){
        // Exit onboarding, go to login or customer mode
        if(provider.loggedIn){
          showProviderHome();
        } else {
          setMode('customer');
          showProfile();
        }
        e.preventDefault();
        history.pushState(null, '', location.pathname);
        return;
      }
    }
  });

  function openProviderOffer(id){
    const raw = offers.find(x=>x.id===id);
    if(!raw) return;
    const o = normalizeOffer(raw);
    activeProviderOfferId = id;

    const preview = document.getElementById('pPreview');
    preview.innerHTML = '';
    preview.appendChild(offerCard(o, {interactive:false}));

    document.getElementById('pStatus').textContent = o.active===false ? 'Inaktiv' : 'Aktiv';
    document.getElementById('pWindow').textContent = o.pickupWindow || '-';
    const toggleLabel = o.active===false ? 'Aktivieren' : 'Deaktivieren';
    const toggleBtn = document.getElementById('btnToggleOffer');
    if(toggleBtn){
      toggleBtn.innerHTML = `${iconMarkup('action')}<span>${esc(toggleLabel)}</span>`;
    }

    document.getElementById('pbd').classList.add('active');
    document.getElementById('psheet').classList.add('active');
  }

  function closeProviderSheet(){
    document.getElementById('pbd').classList.remove('active');
    document.getElementById('psheet').classList.remove('active');
  }

  function buildShareText(o){
    const dish = o.dish || o.title || 'Gericht';
    const profile = normalizeProviderProfile(provider.profile || {});
    const providerName = o.providerName || profile.name || 'Anbieter';
    const pickup = o.pickupWindow || profile.mealWindow || '‚Äî';
    return `${providerName}\nHeute zu Mittag: ${dish}\n${euro(o.price)}\n${pickup}\nPowered by Mittagio`;
  }

  function setPrintView(html){
    const pv = document.getElementById('printView');
    if(!pv) return;
    pv.innerHTML = html;
  }
  function clearPrintView(){
    const pv = document.getElementById('printView');
    if(!pv) return;
    pv.innerHTML = '';
  }
  window.addEventListener('afterprint', clearPrintView);

  function printHtml(html){
    setPrintView(html);
    window.print();
    setTimeout(clearPrintView, 300);
  }

  function buildOfferPrintHtml(o){
    const data = normalizeOffer(o);
    const profile = normalizeProviderProfile(provider.profile || {});
    const name = data.providerName || profile.name || 'Anbieter';
    const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity}) || buildAddress(profile);
    const badges = [];
    if(data.hasPickupCode) badges.push('Abholcode');
    if(data.dineInPossible) badges.push('Vor Ort');
    return `
      <div class="print-card">
        <div style="display:flex;align-items:center;gap:12px;">
          ${profile.logoData ? `<img src="${profile.logoData}" alt="Logo" style="width:56px;height:56px;border-radius:12px;object-fit:cover" />` : ''}
          <div>
            <h1>${esc(name)}</h1>
            <div class="print-muted">${esc(addr || '')}</div>
          </div>
        </div>
        <h2>${esc(data.dish || 'Gericht')}</h2>
        <div class="print-row">
          <div><b>Preis:</b> ${euro(data.price || 0)}</div>
          <div><b>Essenszeit:</b> ${esc(data.pickupWindow || profile.mealWindow || '')}</div>
        </div>
        <div style="margin-top:8px;">
          ${badges.map(b=>`<span class="print-badge">${esc(b)}</span>`).join(' ')}
        </div>
      </div>
    `;
  }

  function buildWeekCardHtml(){
    const profile = normalizeProviderProfile(provider.profile || {});
    const days = [];
    for(let i=0;i<5;i++){
      const d = new Date(); d.setDate(d.getDate()+i);
      days.push(isoDate(d));
    }
    const dayBlocks = days.map(key=>{
      const items = (week[key]||[])
        .filter(x=>x.providerId===providerId() && x.active !== false)
        .map(entry=>{
          const cb = cookbook.find(c=>c.id===entry.cookbookId);
          const name = cb?.dish || entry.dish || 'Gericht';
          const price = cb?.price || 0;
          const windowText = cb?.pickupWindow || profile.mealWindow || '';
          return `
            <div class="print-row">
              <div>
                <div>${esc(name)}</div>
                <div class="print-muted">${esc(windowText)}</div>
              </div>
              <div>${euro(price)}</div>
            </div>
          `;
        });
      const label = key ? fmtDay(new Date(key)) : key;
      return `
        <div class="print-card">
          <h2>${esc(label)}</h2>
          ${items.length ? items.join('') : '<div class="print-muted">Keine Gerichte geplant.</div>'}
        </div>
      `;
    }).join('');

    return `
      <div class="print-card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <div>
            <h1>${esc(profile.name || 'Anbieter')}</h1>
            <div class="print-muted">${esc(buildAddress(profile) || '')}</div>
            <div class="print-muted">Essenszeit: ${esc(profile.mealWindow || '')}</div>
            <div class="print-muted" style="margin-top:6px;"><b>Unsere Gerichte ‚Äì n√§chste Tage</b></div>
          </div>
          ${profile.logoData ? `<img src="${profile.logoData}" alt="Logo" style="width:72px;height:72px;border-radius:14px;object-fit:cover" />` : ''}
        </div>
      </div>
      <div class="print-grid">
        ${dayBlocks}
      </div>
      <div class="print-card" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div>
          <div style="font-weight:900">Mittagio</div>
          <div class="print-muted">Dein Mittag. Lokal. Frisch. Digital.</div>
        </div>
        <div style="text-align:center;">
          <div class="qr">QR-Code</div>
          <div class="print-muted">Jetzt scannen</div>
        </div>
      </div>
    `;
  }

  function printOffer(o){
    if(!o) return;
    printHtml(buildOfferPrintHtml(o));
  }

  function printCookbookEntry(entry){
    if(!entry) return;
    const profile = normalizeProviderProfile(provider.profile || {});
    const offer = normalizeOffer({
      dish: entry.dish,
      category: entry.category,
      price: entry.price,
      pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
      providerName: profile.name || provider.email || 'Anbieter',
      providerStreet: profile.street||'',
      providerZip: profile.zip||'',
      providerCity: profile.city||'',
      providerLogoData: profile.logoData||'',
      hasPickupCode: !!entry.hasPickupCode,
      dineInPossible: !!entry.dineInPossible,
      allergens: entry.allergens||[],
      extras: entry.extras||[],
      reuse: entry.reuse||{enabled:false,deposit:0}
    });
    printHtml(buildOfferPrintHtml(offer));
  }

  function printWeekCard(){
    printHtml(buildWeekCardHtml());
  }

  // Share Payload f√ºr Offer Details
  let sharePayload = { subject: '', body: '', url: '' };
  
  function openShareSheet(subject, body, url=location.href, subtitle=''){
    sharePayload = { subject, body, url };
    
    // Dynamischen Untertitel setzen
    const subtitleEl = document.getElementById('shareSheetSubtitle');
    if(subtitleEl){
      subtitleEl.textContent = subtitle || 'Empfiehl dieses Mittagsangebot weiter';
    }
    
    document.getElementById('shareBd').classList.add('active');
    document.getElementById('shareSheet').classList.add('active');
  }

  function closeShareSheet(){
    document.getElementById('shareBd').classList.remove('active');
    document.getElementById('shareSheet').classList.remove('active');
  }
  
  // Create Flow Sheet
  function openCreateFlowSheet(){
    const sheet = document.getElementById('createFlowSheet');
    const hint = document.getElementById('createFlowDateHint');
    if(sheet && hint){
      if(createFlowPreselectedDate){
        const d = new Date(createFlowPreselectedDate);
        const weekday = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'][d.getDay()];
        const dateStr = `${d.getDate()}.${String(d.getMonth()+1).padStart(2,'0')}.`;
        hint.textContent = `F√ºr: ${weekday}, ${dateStr}`;
        hint.style.display = 'block';
      } else {
        hint.style.display = 'none';
      }
      document.getElementById('createFlowBd').classList.add('active');
      sheet.classList.add('active');
    }
  }
  
  function closeCreateFlowSheet(){
    document.getElementById('createFlowBd').classList.remove('active');
    document.getElementById('createFlowSheet').classList.remove('active');
    createFlowPreselectedDate = null;
  }
  
  // Create Flow Handlers - Beide √∂ffnen Master-Flow
  const btnCreateFromCookbook = document.getElementById('btnCreateFromCookbook');
  if(btnCreateFromCookbook){
    btnCreateFromCookbook.onclick = () => {
      closeCreateFlowSheet();
      // Navigate to cookbook - user selects entry there, then "Inserieren" opens Master-Flow
      showProviderCookbook();
    };
  }
  
  const btnCreateNewDish = document.getElementById('btnCreateNewDish');
  if(btnCreateNewDish){
    btnCreateNewDish.onclick = () => {
      closeCreateFlowSheet();
      // Open Master-Flow directly (new dish)
      startListingFlow({date: createFlowPreselectedDate});
    };
  }
  
  // Offer More Menu
  function openOfferMoreMenu(offerId){
    const offer = offers.find(o => o.id === offerId);
    if(!offer) return;
    
    const actions = [
      {label: 'Bearbeiten', action: () => {
        closeCreateFlowSheet(); // Falls offen
        startListingFlow({editOfferId: offerId});
      }},
      {label: 'Duplizieren', action: () => {
        const newOffer = {...offer, id: cryptoId(), createdAt: Date.now()};
        offers.unshift(newOffer);
        save(LS.offers, offers);
        renderProviderHome();
        renderDiscover();
        showToast('Inserat dupliziert');
      }},
      {label: 'Pausieren', action: () => {
        offer.active = false;
        save(LS.offers, offers);
        renderProviderHome();
        renderDiscover();
        showToast('Inserat pausiert');
      }},
      {label: 'L√∂schen', action: () => {
        if(confirm('Inserat wirklich l√∂schen?')){
          const idx = offers.findIndex(o => o.id === offerId);
          if(idx >= 0){
            offers.splice(idx, 1);
            save(LS.offers, offers);
            renderProviderHome();
            renderDiscover();
            showToast('Inserat gel√∂scht');
          }
        }
      }}
    ];
    
    // Simple prompt-based menu (sp√§ter kann ein Sheet verwendet werden)
    const choice = prompt(`Aktion f√ºr "${offer.dish || offer.title}":\n1. Bearbeiten\n2. Duplizieren\n3. Pausieren\n4. L√∂schen\n\nNummer eingeben:`);
    const idx = parseInt(choice) - 1;
    if(idx >= 0 && idx < actions.length){
      actions[idx].action();
    }
  }
  
  // Toast helper
  function showToast(message){
    // Simple snackbar-style toast
    let toast = document.getElementById('toast');
    if(!toast){
      toast = document.createElement('div');
      toast.id = 'toast';
      toast.style.cssText = 'position:fixed; bottom:90px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.85); color:#fff; padding:12px 20px; border-radius:12px; font-size:14px; z-index:100; opacity:0; transition:opacity .3s; pointer-events:none;';
      document.body.appendChild(toast);
    }
    toast.textContent = message;
    toast.style.opacity = '1';
    setTimeout(() => {
      toast.style.opacity = '0';
    }, 3000);
  }

  async function copyShareLink(){
    const url = sharePayload.url || location.href;
    if(navigator.clipboard && navigator.clipboard.writeText){
      try{ 
        await navigator.clipboard.writeText(url);
        alert('Link kopiert!');
        return true;
      }catch{}
    }
    prompt('Link kopieren:', url);
    return false;
  }
  
  function shareViaWhatsApp(subject, body, url){
    const text = `${subject}\n\n${body}\n\nüëâ Jetzt anschauen:\n${url}`;
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
    window.open(whatsappUrl, '_blank');
  }
  
  function shareViaInstagram(subject, body, url){
    // Instagram unterst√ºtzt keine direkten Share-Links, daher Link kopieren + Hinweis
    const text = `${subject}\n\n${body}\n\nüëâ Jetzt anschauen:\n${url}`;
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).then(() => {
        showToast('Text kopiert! F√ºge ihn in deinen Instagram-Post ein.');
      }).catch(() => {
        prompt('Text f√ºr Instagram kopieren:', text);
      });
    } else {
      prompt('Text f√ºr Instagram kopieren:', text);
    }
  }

  function shareOffer(o){
    if(!o) return;
    const data = normalizeOffer(o);
    const url = `${location.origin}${location.pathname}#offer/${o.id}`;
    
    // Dynamische Share-Texte basierend auf Abholcode-Status
    let subject, body, subtitle;
    const claim = 'Dein Mittag. Lokal. Frisch. Digital.\nauf mittagio.de';
    
    if(data.hasPickupCode){
      // Share-Modus A: MIT Abholcode (ON)
      // Status: Online bezahlt
      // Share-Modus: Online bestellen & Abholcode
      // Kunde zahlt online
      subject = 'Online bestellen & mit Abholcode abholen';
      body = `Online bestellen & mit Abholcode abholen\n${claim}`;
      subtitle = 'Kunden bestellen online & holen mit Abholcode ab';
    } else {
      // Share-Modus B: OHNE Abholcode (OFF)
      // Status: Vor Ort
      // Share-Modus: Vor Ort erh√§ltlich
      // Keine Online-Zahlung
      subject = 'Heute Mittag frisch vor Ort';
      body = `Heute Mittag frisch vor Ort\n${claim}`;
      subtitle = 'F√ºr Laufkundschaft & Vor-Ort-Verkauf';
    }
    
    openShareSheet(subject, body, url, subtitle);
  }

  function addToCart(o){
    if(!o || !o.hasPickupCode){
      alert('Ohne Abholcode nur ansehen.');
      return false;
    }
    if(cart && cart.providerId !== o.providerId){
      alert('MVP: Warenkorb nur f√ºr einen Anbieter. Bitte zuerst Warenkorb leeren.');
      return false;
    }
    if(!cart){ cart = { providerId:o.providerId, providerName:o.providerName, items:[], pickupTime:'' }; }
    const idx = cart.items.findIndex(i=>i.offerId===o.id);
    if(idx>=0) cart.items[idx].qty += 1; else cart.items.push({offerId:o.id, qty:1});
    save(LS.cart, cart);
    return true;
  }

  function handleOrderClick(o){
    // KEIN Login-Zwang: Gast kann direkt bestellen
    if(addToCart(o)){
      showCart();
    } else {
      openOffer(o.id);
    }
  }

  const btnFav = document.getElementById('btnFav');
  if(btnFav) btnFav.onclick=()=>{
    if(!activeOfferId) return;
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    toggleProviderFav(o.providerId);
  };
  const btnDishFav = document.getElementById('btnDishFav');
  if(btnDishFav) btnDishFav.onclick=()=>{
    if(!activeOfferId) return;
    toggleDishFav(activeOfferId);
  };
  // Share Button im Header (Offer Detail Page)
  const btnShareHeader = document.getElementById('btnShareHeader');
  if(btnShareHeader) btnShareHeader.onclick=()=>{
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    shareOffer(o);
  };
  
  // Share Button im Body (legacy, kann entfernt werden)
  const btnShare = document.getElementById('btnShare');
  if(btnShare) btnShare.onclick=()=>{
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    shareOffer(o);
  };
  
  // Share Sheet Actions
  const btnShareWhatsApp = document.getElementById('btnShareWhatsApp');
  if(btnShareWhatsApp) btnShareWhatsApp.onclick=()=>{
    shareViaWhatsApp(sharePayload.subject, sharePayload.body, sharePayload.url);
    closeShareSheet();
  };
  
  const btnShareInstagram = document.getElementById('btnShareInstagram');
  if(btnShareInstagram) btnShareInstagram.onclick=()=>{
    shareViaInstagram(sharePayload.subject, sharePayload.body, sharePayload.url);
    closeShareSheet();
  };
  
  const btnShareCopy = document.getElementById('btnShareCopy');
  if(btnShareCopy) btnShareCopy.onclick=()=>{
    copyShareLink();
    closeShareSheet();
  };
  
  const btnCodeClose = document.getElementById('btnCodeClose');
  if(btnCodeClose) btnCodeClose.onclick=()=> closeCodeSheet();
  const btnToggleOrderStatus = document.getElementById('btnToggleOrderStatus');
  if(btnToggleOrderStatus) btnToggleOrderStatus.onclick=()=>{
    if(!activeOrderId) return;
    const idx = orders.findIndex(o=>o.id===activeOrderId);
    if(idx<0) return;
    orders[idx].status = orders[idx].status === 'abgeholt' ? 'offen' : 'abgeholt';
    save(LS.orders, orders);
    renderOrders();
    openCodeSheet(activeOrderId);
  };
  
  // --- Login Modal ---
  function openLoginSheet(){
    document.getElementById('loginBd').classList.add('active');
    document.getElementById('loginSheet').classList.add('active');
    // Focus auf E-Mail-Input
    setTimeout(()=>{
      const emailInput = document.getElementById('loginModalEmail');
      if(emailInput) emailInput.focus();
    }, 300);
  }
  
  function closeLoginSheet(){
    document.getElementById('loginBd').classList.remove('active');
    document.getElementById('loginSheet').classList.remove('active');
  }
  
  // Login Modal Backdrop Handler
  const loginBd = document.getElementById('loginBd');
  if(loginBd){
    loginBd.onclick = () => {
      closeLoginSheet();
    };
  }
  
  // Login Modal Handler
  const btnLoginModalLogin = document.getElementById('btnLoginModalLogin');
  if(btnLoginModalLogin){
    btnLoginModalLogin.onclick=()=>{
      const email = document.getElementById('loginModalEmail').value.trim();
      const pass = document.getElementById('loginModalPass').value.trim();
      if(!email || !pass){
        alert('Bitte E-Mail und Passwort eingeben.');
        return;
      }
      customer.loggedIn = true;
      customer.name = customer.name || email.split('@')[0];
      customer.email = email;
      save(LS.customer, customer);
      updateProfileView();
      closeLoginSheet();
      // Nach Login zur Discover-Seite
      setMode('customer');
      showDiscover();
    };
  }
  
  const btnLoginModalDemo = document.getElementById('btnLoginModalDemo');
  if(btnLoginModalDemo){
    btnLoginModalDemo.onclick=()=>{
      customer.loggedIn = true;
      customer.name = customer.name || 'Mike';
      save(LS.customer, customer);
      updateProfileView();
      closeLoginSheet();
      // Nach Demo-Login zur Discover-Seite
      setMode('customer');
      showDiscover();
    };
  }

  applyStaticIcons();
  const locBtn = document.getElementById('btnLocationPin');
  if(locBtn){
    locBtn.innerHTML = iconMarkup('location');
    locBtn.onclick=()=>{
      alert('Standort gesetzt. Du kannst jederzeit wechseln.');
    };
  }
  const startLocBtn = document.getElementById('btnStartLocationPin');
  if(startLocBtn){
    startLocBtn.innerHTML = iconMarkup('location');
    startLocBtn.onclick=()=>{
      alert('Standort gesetzt. Du kannst jederzeit wechseln.');
    };
  }
  const startNearBtn = document.getElementById('btnStartNear');
  if(startNearBtn){
    startNearBtn.onclick=()=>{
      alert('Zeige Angebote in deiner N√§he.');
      renderStart();
    };
  }
  
  // Discover Standort-Button
  const discoverLocationBtn = document.getElementById('btnDiscoverLocation');
  if(discoverLocationBtn){
    discoverLocationBtn.onclick=()=>{
      const newLoc = prompt('Standort eingeben (Ort oder PLZ):', locationQuery || '');
      if(newLoc !== null){
        locationQuery = newLoc.trim();
        renderDiscover();
      }
    };
  }

  const btnAddCart = document.getElementById('btnAddCart');
  if(btnAddCart){
    btnAddCart.onclick=()=>{
      const o = offers.find(x=>x.id===activeOfferId);
      if(!o) return;
      if(!addToCart(o)) return;
      closeSheet();
      showCart();
    };
  }

  // --- Cart ---
  function renderCart(){
    const box=document.getElementById('cartBox');
    const btn=document.getElementById('btnCheckout');
    const note=document.getElementById('cartNote');

    if(!cart || !cart.items.length){
      box.textContent='Dein Warenkorb ist leer.';
      btn.style.display='none';
      note.style.display='none';
      return;
    }

    let total=0;
    let canCheckout = true;
    const firstOffer = cart.items.length ? offers.find(x=>x.id===cart.items[0].offerId) : null;
    const firstOfferNormalized = firstOffer ? normalizeOffer(firstOffer) : null;
    const windowText = firstOfferNormalized && firstOfferNormalized.pickupWindow ? firstOfferNormalized.pickupWindow : '';
    const lines = cart.items.map(it=>{
      const o = offers.find(x=>x.id===it.offerId);
      if(!o) return '';
      const normalized = normalizeOffer(o);
      if(!normalized.hasPickupCode) canCheckout = false;
      const lineTotal = Number(normalized.price||0) * it.qty;
      total += lineTotal;
      return `
        <div class="cart-line">
          <div class="cart-left">${esc(normalized.dish || normalized.title || 'Gericht')}</div>
          <div class="cart-qty">
            <button class="qty-btn" type="button" data-action="dec" data-id="${esc(o.id)}">-</button>
            <div>${it.qty}</div>
            <button class="qty-btn" type="button" data-action="inc" data-id="${esc(o.id)}">+</button>
          </div>
          <div class="cart-price">${euro(lineTotal)}</div>
        </div>
      `;
    }).filter(Boolean);

    // Quick-Time-Chips generieren (basierend auf Essenszeit)
    let timeChips = '';
    if(windowText){
      // Versuche Zeitfenster zu parsen (z.B. "11:30 ‚Äì 14:30")
      const timeMatch = windowText.match(/(\d{1,2}):(\d{2})\s*[‚Äì-]\s*(\d{1,2}):(\d{2})/);
      if(timeMatch){
        const startH = parseInt(timeMatch[1]);
        const startM = parseInt(timeMatch[2]);
        const endH = parseInt(timeMatch[3]);
        const endM = parseInt(timeMatch[4]);
        // Generiere 3 Quick-Time-Chips (Start, Mitte, Ende)
        const times = [];
        if(startH < endH || (startH === endH && startM < endM)){
          const midH = Math.floor((startH + endH) / 2);
          const midM = Math.floor((startM + endM) / 2);
          times.push(`${String(startH).padStart(2,'0')}:${String(startM).padStart(2,'0')}`);
          times.push(`${String(midH).padStart(2,'0')}:${String(midM).padStart(2,'0')}`);
          times.push(`${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`);
        }
        timeChips = times.map(t => 
          `<button class="cart-time-chip ${cart.pickupTime === t ? 'selected' : ''}" type="button" data-time="${t}">${t} Uhr</button>`
        ).join('');
      }
    }
    
    box.innerHTML = `
      <div style="font-size:16px; font-weight:900; margin-bottom:12px;">${esc(cart.providerName || 'Anbieter')}</div>
      ${lines.join('')}
      ${windowText ? `
        <div class="cart-window-badge">
          <i data-lucide="clock"></i>
          <span>Essenszeit: ${esc(windowText)}</span>
        </div>
      ` : ''}
      <div class="row" style="margin-top:16px;"><span>Wann m√∂chtest du ungef√§hr da sein?</span></div>
      ${timeChips ? `<div class="cart-time-chips">${timeChips}</div>` : ''}
      <input class="field" id="pickupTimeInput" type="text" placeholder="z.B. 12:15 Uhr" value="${esc(cart.pickupTime||'')}" />
      <div class="hint" style="margin-top:6px;">Bitte innerhalb der Essenszeit.</div>
      <div class="row" style="margin-top:20px; padding-top:16px; border-top:2px solid #eee;"><span style="font-size:16px; font-weight:900;">Gesamt</span><b style="font-size:18px;">${euro(total)}</b></div>
      <a href="#" id="clearCart" class="cart-clear-btn">Warenkorb leeren</a>
    `;

    // Warenkorb leeren mit Best√§tigung
    const clearCartBtn = document.getElementById('clearCart');
    if(clearCartBtn){
      clearCartBtn.onclick=(e)=>{
        e.preventDefault();
        if(confirm('M√∂chtest du den Warenkorb wirklich leeren?')){
          cart=null;
          save(LS.cart, cart);
          renderCart();
        }
      };
    }
    
    // Quick-Time-Chips Handler
    box.querySelectorAll('.cart-time-chip').forEach(chip=>{
      chip.onclick=()=>{
        const time = chip.getAttribute('data-time');
        cart.pickupTime = time;
        save(LS.cart, cart);
        renderCart();
        // Input fokussieren f√ºr bessere UX
        setTimeout(()=>{
          const input = document.getElementById('pickupTimeInput');
          if(input) input.focus();
        }, 50);
      };
    });
    
    // Ankunftszeit Input
    const timeInput = document.getElementById('pickupTimeInput');
    if(timeInput){
      timeInput.oninput=()=>{
        cart.pickupTime = timeInput.value.trim();
        save(LS.cart, cart);
        // Quick-Chips aktualisieren
        box.querySelectorAll('.cart-time-chip').forEach(chip=>{
          const chipTime = chip.getAttribute('data-time');
          chip.classList.toggle('selected', chipTime === cart.pickupTime);
        });
      };
    }

    box.querySelectorAll('.qty-btn').forEach(btnEl=>{
      btnEl.onclick=()=>{
        const id = btnEl.getAttribute('data-id');
        const action = btnEl.getAttribute('data-action');
        const idx = cart.items.findIndex(i=>i.offerId===id);
        if(idx<0) return;
        if(action==='inc') cart.items[idx].qty += 1;
        if(action==='dec') cart.items[idx].qty -= 1;
        if(cart.items[idx].qty <= 0) cart.items.splice(idx,1);
        save(LS.cart, cart);
        renderCart();
      };
    });

    btn.style.display='block';
    btn.disabled = !canCheckout;
    // CTA-Text: Zahlung ist Pflicht (Stripe Checkout, Gastzahlung)
    if(canCheckout){
      // Alle Items haben hasPickupCode = true ‚Üí Stripe Checkout (Gastzahlung, Zahlung Pflicht)
      btn.innerHTML = `${iconMarkup('card')}<span>Weiter zur Zahlung</span>`;
    } else {
      // Kein Payment m√∂glich ‚Üí Button deaktiviert
      btn.innerHTML = `${iconMarkup('alert-circle')}<span>Zahlung nicht m√∂glich</span>`;
    }
    note.style.display='block';
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }

  const btnCheckout = document.getElementById('btnCheckout');
  if(btnCheckout){
    btnCheckout.onclick=()=>{
      // KEIN Login-Zwang: Gast kann direkt bezahlen
      if(!cart || !cart.items || !cart.items.length) return;
      
      // Pr√ºfe ob Payment m√∂glich ist
      const hasPayment = cart.items.every(it=>{
        const o = offers.find(x=>x.id===it.offerId);
        return o && normalizeOffer(o).hasPickupCode;
      });
      
      const pickupTime = String(cart.pickupTime||'').trim();
      if(!pickupTime){
        alert('Bitte eine ungef√§hre Abholzeit angeben.');
        showCart();
        setTimeout(()=>{
          const input = document.getElementById('pickupTimeInput');
          if(input) input.focus();
        }, 50);
        return;
      }
      
      // Gesamtpreis berechnen
      let total = 0;
      cart.items.forEach(it=>{
        const o = offers.find(x=>x.id===it.offerId);
        if(o){
          const normalized = normalizeOffer(o);
          total += Number(normalized.price||0) * it.qty;
        }
      });
      
      // Zahlung ist Pflicht (MVP: Stripe Checkout)
      if(!hasPayment){
        alert('Diese Bestellung enth√§lt Gerichte ohne Abholcode. Bitte w√§hle Angebote mit Abholcode aus.');
        return;
      }
      
      if(total <= 0){
        alert('Bitte w√§hle mindestens ein Gericht aus.');
        return;
      }
      
      // Order mit Status CREATED erstellen (Warenkorb)
      const orderCreated = createOrderFromCart(cart, 'CREATED');
      if(!orderCreated){
        alert('Fehler beim Erstellen der Bestellung.');
        return;
      }
      
      // Stripe Checkout √∂ffnen (Gastzahlung, Zahlung Pflicht)
      // Order wird auf PAYMENT_PENDING gesetzt
      updateOrder(orderCreated.id, { status: 'PAYMENT_PENDING' });
      
      startStripeCheckout(total, cart, orderCreated.id);
    };
  }
  
  /**
   * Create order from cart
   * @param {Object} cartData
   * @param {'CREATED'|'PAYMENT_PENDING'} initialStatus
   * @returns {Order|null}
   */
  function createOrderFromCart(cartData, initialStatus){
    if(!cartData || !cartData.items || !cartData.items.length) return null;
    
    const firstOffer = cartData.items.length ? offers.find(x=>x.id===cartData.items[0].offerId) : null;
    const firstOfferNormalized = firstOffer ? normalizeOffer(firstOffer) : null;
    
    // Gesamtpreis berechnen (in Cents)
    let totalCents = 0;
    const items = cartData.items.map(it=>{
      const o = offers.find(x=>x.id===it.offerId);
      if(!o) return null;
      const normalized = normalizeOffer(o);
      const unitPriceCents = Math.round(Number(normalized.price||0) * 100);
      const lineTotalCents = unitPriceCents * it.qty;
      totalCents += lineTotalCents;
      return {
        dishId: o.id,
        dishName: normalized.dish || normalized.title || 'Gericht',
        quantity: it.qty,
        unitPriceCents: unitPriceCents
      };
    }).filter(Boolean);
    
    const now = Date.now();
    /** @type {Order} */
    const order = {
      id: cryptoId(),
      createdAt: now,
      updatedAt: now,
      dishId: items[0]?.dishId || '',
      offerId: items[0]?.dishId || '', // Same as dishId for MVP
      dishName: items.map(i => `${i.dishName} x ${i.quantity}`).join(', '),
      providerId: cartData.providerId || '',
      providerName: cartData.providerName || 'Anbieter',
      providerAddress: firstOfferNormalized ? buildAddress({
        address: firstOfferNormalized.address,
        street: firstOfferNormalized.providerStreet,
        zip: firstOfferNormalized.providerZip,
        city: firstOfferNormalized.providerCity
      }) : '',
      quantity: cartData.items.reduce((sum, it) => sum + it.qty, 0),
      unitPrice: items[0]?.unitPriceCents || 0,
      total: totalCents,
      fulfillType: firstOfferNormalized && firstOfferNormalized.dineInPossible ? 'DINE_IN' : 'PICKUP',
      etaTime: cartData.pickupTime || '',
      status: initialStatus,
      currency: 'EUR',
      stripeCheckoutSessionId: undefined,
      stripePaymentIntentId: undefined,
      receiptEmail: undefined,
      pickupCode: undefined, // Nur bei PAID (Guard in addOrder)
      pickupCodeActivatedAt: undefined, // Nur bei PAID
      pickupDate: undefined, // Wird bei PAID gesetzt
      pickupWindow: firstOfferNormalized && firstOfferNormalized.pickupWindow ? firstOfferNormalized.pickupWindow : '',
      dishLetter: undefined, // Wird bei PAID gesetzt
      runningNumber: undefined, // Wird bei PAID gesetzt
      isGuest: true,
      // Legacy-Felder f√ºr Kompatibilit√§t
      summary: items.map(i => `${i.dishName} x ${i.quantity}`).join(', '),
      code: null,
      pickupTime: cartData.pickupTime || '',
      pickupWindow: firstOfferNormalized && firstOfferNormalized.pickupWindow ? firstOfferNormalized.pickupWindow : '',
      unitPriceCents: items[0]?.unitPriceCents || 0,
      totalCents: totalCents,
      paymentIntentId: null
    };
    
    return addOrder(order);
  }
  
  // --- Stripe Checkout (Gastzahlung, Zahlung Pflicht) ---
  /**
   * Start Stripe Checkout flow
   * @param {number} total - Total amount in EUR (not cents)
   * @param {Object} cartData - Cart data
   * @param {string} orderId - Order ID
   */
  function startStripeCheckout(total, cartData, orderId){
    // TODO: Replace with real Stripe integration
    // In Production:
    //   1. Backend-Endpoint: POST /api/create-checkout-session
    //   2. Request Body: { orderId, items: cartData.items, total, pickupTime, ... }
    //   3. Backend erstellt Stripe Checkout Session (mode: 'payment', allow_promotion_codes: true)
    //   4. Session-URL erhalten: session.url
    //   5. window.location.href = session.url; (√∂ffnet Stripe Checkout)
    //   6. Nach Zahlung: Stripe leitet zur√ºck zu success_url?session_id=xxx
    //   7. Webhook best√§tigt Zahlung ‚Üí handleCheckoutSuccess(session_id)
    
    // MVP Demo: Simuliere Stripe Checkout
    const sessionId = 'demo_session_' + cryptoId();
    
    // Speichere session_id in Order (wird sp√§ter bei Success verwendet)
    updateOrder(orderId, {
      stripeCheckoutSessionId: sessionId
    });
    
    // Demo: Simuliere erfolgreiche Zahlung
    // In Production: window.location.href = session.url;
    if(confirm(`Stripe Checkout w√ºrde jetzt ge√∂ffnet.\n\nGesamtbetrag: ${euro(total)}\n\nGastzahlung m√∂glich (E-Mail nur f√ºr Zahlungsbeleg, kein Login erforderlich).\n\nDemo: Zahlung erfolgreich simulieren?`)){
      // Simuliere Success-Return
      handleCheckoutSuccess(sessionId, orderId);
    } else {
      // Simuliere Cancel
      handleCheckoutCancel(orderId);
    }
  }
  
  /**
   * Handle Stripe Checkout Success Return
   * Route: /checkout/success?session_id=xxx OR ?orderId=xxx
   * @param {string} [sessionId] - Stripe session ID (optional)
   * @param {string} [orderId] - Order ID (optional, if sessionId not available)
   */
  function handleCheckoutSuccess(sessionId, orderId){
    // TODO: In Production, verify payment via Webhook
    // For now: MVP assumes payment is successful if we reach this point
    
    let order = null;
    
    // Find order: priority: orderId > sessionId
    if(orderId){
      order = getOrderById(orderId);
    } else if(sessionId){
      // Find order by session_id
      const ordersList = loadOrders();
      order = ordersList.find(o => o.stripeCheckoutSessionId === sessionId);
    }
    
    // Fehler-UI: Bestellung nicht gefunden
    if(!order){
      console.error('Order not found for checkout success', { sessionId, orderId });
      // Zeige Fehler-UI
      const errorView = document.createElement('div');
      errorView.className = 'panel';
      errorView.style.padding = '40px 20px';
      errorView.style.textAlign = 'center';
      errorView.innerHTML = `
        <div style="font-size:48px; margin-bottom:20px;">‚ö†Ô∏è</div>
        <h3 style="margin-bottom:12px;">Bestellung nicht gefunden</h3>
        <p class="hint" style="margin-bottom:24px;">Die Bestellung konnte nicht gefunden werden.</p>
        <button class="btn" type="button" onclick="showDiscover()" style="width:100%; min-height:44px;">
          <i data-lucide="compass"></i> Zur Entdecken-Seite
        </button>
      `;
      document.body.appendChild(errorView);
      showView(null); // Hide all views
      if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
      return;
    }
    
    // Wenn Order noch nicht PAID: auf PAID setzen und Code generieren
    if(order.status !== 'PAID'){
      if(order.status !== 'PAYMENT_PENDING'){
        console.warn('Order status is not PAYMENT_PENDING:', order.status);
      }
      
      // Mark as PAID and generate pickup code
      completePayment(order.id, {
        stripeCheckoutSessionId: sessionId || order.stripeCheckoutSessionId,
        paymentIntentId: 'pi_' + cryptoId(), // Would come from Stripe webhook
        receiptEmail: 'customer@example.com' // Would come from Stripe
      });
    } else {
      // Bereits PAID: direkt zu Abholcode navigieren
      showPickupCode(order.id);
    }
  }
  
  /**
   * Handle Stripe Checkout Cancel
   * Route: /checkout/cancel?orderId=xxx OR ?session_id=xxx
   * @param {string} [orderId] - Order ID (optional)
   * @param {string} [sessionId] - Stripe session ID (optional)
   */
  function handleCheckoutCancel(orderId, sessionId){
    let order = null;
    
    // Find order: priority: orderId > sessionId
    if(orderId){
      order = getOrderById(orderId);
    } else if(sessionId){
      const ordersList = loadOrders();
      order = ordersList.find(o => o.stripeCheckoutSessionId === sessionId);
    }
    
    if(!order){
      // Fallback: direkt zum Warenkorb
      showCart();
      return;
    }
    
    // Set status to CANCELLED
    updateOrder(order.id, {
      status: 'CANCELLED'
    });
    
    // UI: "Zahlung abgebrochen" + Button "Zur√ºck zum Warenkorb"
    // Navigate back to cart
    showCart();
    
    // Zeige Info (optional, kann auch weggelassen werden)
    setTimeout(() => {
      const cartBox = document.getElementById('cartBox');
      if(cartBox){
        const infoDiv = document.createElement('div');
        infoDiv.className = 'hint';
        infoDiv.style.cssText = 'background:#fff3cd; border:1px solid #ffc107; border-radius:12px; padding:12px; margin-bottom:16px; text-align:center;';
        infoDiv.innerHTML = '‚ÑπÔ∏è Zahlung abgebrochen';
        cartBox.insertBefore(infoDiv, cartBox.firstChild);
      }
    }, 100);
  }
  
  /**
   * Complete payment (set status to PAID and generate pickup code)
   * @param {string} orderId
   * @param {Object} paymentData
   * @param {string} [paymentData.stripeCheckoutSessionId]
   * @param {string} [paymentData.paymentIntentId]
   * @param {string} [paymentData.receiptEmail]
   */
  function completePayment(orderId, paymentData){
    const order = getOrderById(orderId);
    if(!order){
      console.error('Order not found:', orderId);
      return;
    }
    
    // Get offer to determine day and pickup window
    const offer = offers.find(o => o.id === order.dishId || o.id === order.offerId);
    const pickupDate = offer ? offer.day : isoDate(new Date());
    const pickupWindow = offer ? (offer.pickupWindow || '') : (order.pickupWindow || '');
    
    // Assign pickup code (deterministic, mock)
    // Single source of truth: Order record
    const {dishLetter, runningNumber, pickupCode} = assignPickupCode({
      providerId: order.providerId,
      pickupDate: pickupDate,
      dishId: order.dishId || order.offerId
    });
    const now = Date.now();
    
    // Order auf PAID setzen (pickupCode wird hier gesetzt, da status=PAID)
    const updatedOrder = updateOrder(orderId, {
      status: 'PAID',
      stripeCheckoutSessionId: paymentData.stripeCheckoutSessionId,
      stripePaymentIntentId: paymentData.paymentIntentId,
      receiptEmail: paymentData.receiptEmail,
      pickupCode: pickupCode,
      pickupCodeActivatedAt: now,
      pickupDate: pickupDate,
      pickupWindow: pickupWindow,
      dishLetter: dishLetter,
      runningNumber: runningNumber,
      // Legacy-Felder f√ºr Kompatibilit√§t
      code: pickupCode,
      paymentStatus: 'PAID',
      paymentIntentId: paymentData.paymentIntentId
    });
    
    if(!updatedOrder){
      console.error('Failed to update order');
      return;
    }
    
    // Warenkorb leeren
    cart = null;
    save(LS.cart, cart);
    renderCart();
    
    // Orders aktualisieren
    orders = loadOrders();
    renderOrders();
    
    // Navigiere zu AbholcodeScreen
    showPickupCode(updatedOrder.id);
  }

  // --- Start actions ---
  const startCustomerBtn = document.getElementById('btnStartCustomer');
  if(startCustomerBtn){
    startCustomerBtn.onclick=()=>{
      setMode('customer');
    };
  }
  const startProviderBtn = document.getElementById('btnStartProvider');
  if(startProviderBtn){
    startProviderBtn.onclick=()=>{
      setMode('provider');
    };
  }

  // --- Profile View ("Mein Mittagio") - MVP Final ---
  function updateProfileView(){
    // Welcome Card - immer gleich f√ºr Endkunden (kein Login)
    const welcomeCard = document.getElementById('profileWelcomeCard');
    if(welcomeCard){
      welcomeCard.innerHTML = `
        <div style="font-weight:600; font-size:17px; margin-bottom:8px; line-height:1.3;">Willkommen bei Mittagio üëã</div>
        <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:14px; color:var(--muted);">Finde frische Mittagsangebote in deiner N√§he.</div>
        <button class="btn secondary" type="button" id="btnProfileDiscover" style="width:100%; min-height:44px;">
          Angebote entdecken
        </button>
      `;
      const btn = document.getElementById('btnProfileDiscover');
      if(btn) btn.onclick = () => {
        setMode('customer');
        showView('discover');
      };
    }
    
    // K√ºrzlich angesehen (session-basiert)
    const recentlyViewed = document.getElementById('profileRecentlyViewed');
    const recentlyViewedList = document.getElementById('profileRecentlyViewedList');
    if(recentlyViewed && recentlyViewedList){
      // TODO: Session-basierte Anzeige implementieren
      recentlyViewed.style.display = 'none'; // Erstmal ausblenden, bis Logik implementiert ist
    }
    
    // Orders Teaser - ENTFERNT (nicht mehr f√ºr Endkunden - keine Bestellungen/Box)
    const ordersTeaser = document.getElementById('profileOrdersTeaser');
    if(ordersTeaser) ordersTeaser.style.display = 'none';
    
    // Reorder Teaser (mit Empty States)
    const reorderTeaser = document.getElementById('profileReorderTeaser');
    const reorderProviders = document.getElementById('profileReorderProviders');
    const reorderHelper = document.getElementById('profileReorderHelper');
    
    if(reorderTeaser && reorderProviders){
      // Nur anzeigen wenn Orders existieren
      if(!hasOrders){
        // CASE 1 & 2: No orders - hide completely
        reorderTeaser.style.display = 'none';
      } else {
        const uniqueProviders = [];
        const providerMap = new Map();
        allOrders.forEach(o => {
          if(o.providerName && o.providerId && !providerMap.has(o.providerId)){
            providerMap.set(o.providerId, o.providerName);
            uniqueProviders.push({id: o.providerId, name: o.providerName});
          }
        });
        
        if(uniqueProviders.length > 0){
          // CASE: Reorder providers exist - show cards with CTAs
          reorderTeaser.style.display = 'block';
          if(reorderHelper) reorderHelper.style.display = 'none';
          reorderProviders.innerHTML = uniqueProviders.slice(0, 2).map(p => `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:#f8f7f3; border-radius:14px; margin-bottom:8px; border:1px solid var(--border);">
              <div style="font-weight:600; font-size:14px; line-height:1.4;">${esc(p.name)}</div>
              <button class="btn ghost" type="button" data-provider-id="${esc(p.id)}" style="padding:8px 12px; font-size:14px; min-height:36px; margin-left:12px; flex-shrink:0;">
                Angebote ansehen
              </button>
            </div>
          `).join('');
          
          // Event Handler f√ºr Reorder-Buttons
          reorderProviders.querySelectorAll('button[data-provider-id]').forEach(btn => {
            btn.onclick = () => {
              const providerId = btn.dataset.providerId;
              // Filtere Discover nach diesem Provider
              locationQuery = '';
              activeDiscoverFilter = 'near';
              const providerOffer = offers.find(o => o.providerId === providerId);
              if(providerOffer) activeDay = providerOffer.day;
              showDiscover();
              renderDiscover();
            };
          });
        } else {
          // CASE 3: Orders exist, but no reorder providers - show helper text only
          reorderTeaser.style.display = 'block';
          if(reorderHelper) reorderHelper.style.display = 'block';
          reorderProviders.innerHTML = '';
        }
      }
    }
    
    // Personal Data - ENTFERNT (Endkunden haben kein Profil)
    const personalData = document.getElementById('profilePersonalData');
    if(personalData) personalData.style.display = 'none';
    
    const btnProfileEditEmail = document.getElementById('btnProfileEditEmail');
    if(btnProfileEditEmail) btnProfileEditEmail.onclick = () => {
      const newEmail = prompt('Neue E-Mail-Adresse:', customer.email || '');
      if(newEmail && newEmail !== customer.email){
        customer.email = newEmail;
        save(LS.customer, customer);
        updateProfileView();
      }
    };
  }
  
  // "Zum Anbieterbereich" Button
  const btnGoToProvider = document.getElementById('btnGoToProvider');
  if(btnGoToProvider){
    btnGoToProvider.onclick = () => {
      setMode('provider');
    };
  }

  // Logout-Handler (wenn vorhanden)
  const btnUnifiedLogout = document.getElementById('btnUnifiedLogout');
  if(btnUnifiedLogout){
    btnUnifiedLogout.onclick=()=>{
      customer.loggedIn = false;
      customer.name = null;
      customer.email = null;
      save(LS.customer, customer);
      updateProfileView();
      showProfile();
    };
  }

  // Provider Switch (wenn vorhanden)
  const btnSwitchToProvider = document.getElementById('btnSwitchToProvider');
  if(btnSwitchToProvider){
    btnSwitchToProvider.onclick=()=>{
      if(!provider.loggedIn){
        setMode('provider');
      } else {
        showProviderHome();
      }
    };
  }

  // --- Hybrid Onboarding System ---
  let onboardingDraftDish = load(LS.onboardingDraft, null);
  
  function showOnboardingEntry(hasDraft = false){
    showView(views.providerOnboardingEntry);
    
    // Show returning banner if draft exists
    const entryPanel = document.querySelector('#v-provider-onboarding-entry .panel');
    if(hasDraft && onboardingDraftDish && entryPanel){
      const banner = document.createElement('div');
      banner.style.cssText = 'margin-bottom:24px; padding:16px; background:#f0f7f0; border-radius:12px; border:1px solid #4caf50;';
      banner.innerHTML = `
        <div style="font-weight:600; font-size:16px; margin-bottom:8px; color:#2e7d32;">Du hast ein Gericht vorbereitet</div>
        <div style="font-size:14px; line-height:1.4; margin-bottom:12px; color:#666;">M√∂chtest du weitermachen?</div>
        <div style="display:flex; gap:8px;">
          <button class="btn secondary" type="button" id="btnOnboardingResume" style="flex:1; min-height:44px;">Weiter bearbeiten</button>
          <button class="btn ghost" type="button" id="btnOnboardingDiscard" style="flex:1; min-height:44px;">Verwerfen</button>
        </div>
      `;
      entryPanel.insertBefore(banner, entryPanel.firstChild);
      
      const btnResume = document.getElementById('btnOnboardingResume');
      const btnDiscard = document.getElementById('btnOnboardingDiscard');
      if(btnResume) btnResume.onclick = () => showOnboardingFirstDish(true);
      if(btnDiscard) btnDiscard.onclick = () => {
        onboardingDraftDish = null;
        save(LS.onboardingDraft, null);
        showOnboardingEntry(false);
      };
    }
  }
  
  function showOnboardingFirstDish(prefill = false){
    showView(views.providerOnboardingFirstDish);
    
    // Push state for browser back button
    history.pushState({onboarding: 'first-dish'}, '', location.pathname);
    
    if(prefill && onboardingDraftDish){
      const dishName = document.getElementById('onboardingDishName');
      const timeStart = document.getElementById('onboardingPickupTimeStart');
      const timeEnd = document.getElementById('onboardingPickupTimeEnd');
      const photoPreview = document.getElementById('onboardingPhotoPreview');
      const photoPreviewImg = document.getElementById('onboardingPhotoPreviewImg');
      
      if(dishName) dishName.value = onboardingDraftDish.dishName || '';
      if(timeStart) timeStart.value = onboardingDraftDish.pickupTimeStart || '';
      if(timeEnd) timeEnd.value = onboardingDraftDish.pickupTimeEnd || '';
      if(onboardingDraftDish.photoData && photoPreview && photoPreviewImg){
        photoPreview.style.display = 'block';
        photoPreviewImg.src = onboardingDraftDish.photoData;
      }
    }
    
    // Photo upload handler (recreate each time to avoid duplicates)
    const existingInput = document.getElementById('onboardingPhotoInput');
    if(existingInput) existingInput.remove();
    
    const photoInput = document.createElement('input');
    photoInput.id = 'onboardingPhotoInput';
    photoInput.type = 'file';
    photoInput.accept = 'image/*';
    photoInput.style.display = 'none';
    document.body.appendChild(photoInput);
    
    const btnAddPhoto = document.getElementById('btnOnboardingAddPhoto');
    if(btnAddPhoto){
      btnAddPhoto.onclick = () => photoInput.click();
    }
    
    photoInput.onchange = async (e) => {
      const file = e.target.files[0];
      if(!file) return;
      const dataUrl = await toDataUrl(file);
      const photoPreview = document.getElementById('onboardingPhotoPreview');
      const photoPreviewImg = document.getElementById('onboardingPhotoPreviewImg');
      if(photoPreview && photoPreviewImg){
        photoPreview.style.display = 'block';
        photoPreviewImg.src = dataUrl;
      }
      if(!onboardingDraftDish) onboardingDraftDish = {};
      onboardingDraftDish.photoData = dataUrl;
      save(LS.onboardingDraft, onboardingDraftDish);
    };
    
    // Warn before leaving if changes exist
    let hasChanges = false;
    const inputs = ['onboardingDishName', 'onboardingPickupTimeStart', 'onboardingPickupTimeEnd'];
    inputs.forEach(id => {
      const el = document.getElementById(id);
      if(el){
        el.oninput = () => { hasChanges = true; };
      }
    });
    
    window.onbeforeunload = (e) => {
      if(hasChanges && onboardingDraftDish){
        e.preventDefault();
        e.returnValue = '';
      }
    };
  }
  
  function showOnboardingSignup(){
    showView(views.providerOnboardingSignup);
    history.pushState({onboarding: 'signup'}, '', location.pathname);
  }
  
  function showOnboardingBusiness(){
    showView(views.providerOnboardingBusiness);
    history.pushState({onboarding: 'business'}, '', location.pathname);
  }
  
  function showOnboardingPreview(dishId){
    showView(views.providerOnboardingPreview);
    history.pushState({onboarding: 'preview'}, '', location.pathname);
    
    // Load saved dish and show preview
    const savedDish = dishId ? cookbook.find(c => c.id === dishId) : cookbook.find(c => c.providerId === providerId());
    const previewCard = document.getElementById('onboardingPreviewCard');
    if(previewCard && (savedDish || onboardingDraftDish)){
      const dish = savedDish || {
        dish: onboardingDraftDish.dishName,
        category: 'Vegetarisch',
        photoData: onboardingDraftDish.photoData || null
      };
      
      const preview = offerCard({
        id: dish.id || 'preview',
        dish: dish.dish,
        category: dish.category || 'Vegetarisch',
        price: 0, // No price in preview
        pickupWindow: savedDish?.pickupWindow || `${onboardingDraftDish?.pickupTimeStart || '11:30'} ‚Äì ${onboardingDraftDish?.pickupTimeEnd || '14:30'}`,
        imageUrl: dish.photoData || dish.imageUrl || '',
        providerName: provider.profile?.name || 'Dein Betrieb',
        hasPickupCode: false, // No abholcode in preview
        dineInPossible: false
      }, {interactive: false});
      
      previewCard.innerHTML = '';
      previewCard.appendChild(preview);
      
      // Disable all interactive elements in preview
      preview.querySelectorAll('button, a').forEach(el => {
        el.style.pointerEvents = 'none';
        el.style.opacity = '0.5';
      });
      
      // Update icons
      if(typeof lucide !== 'undefined'){
        setTimeout(() => lucide.createIcons(), 50);
      }
    }
  }
  
  // Onboarding Event Handlers
  const btnOnboardingEntryStart = document.getElementById('btnOnboardingEntryStart');
  if(btnOnboardingEntryStart) btnOnboardingEntryStart.onclick = () => showOnboardingFirstDish(false);
  
  const btnOnboardingEntryLater = document.getElementById('btnOnboardingEntryLater');
  if(btnOnboardingEntryLater) btnOnboardingEntryLater.onclick = () => {
    if(provider.loggedIn){
      showProviderHome();
    } else {
      showView(views.providerLogin);
    }
  };
  
  const btnOnboardingFirstDishBack = document.getElementById('btnOnboardingFirstDishBack');
  if(btnOnboardingFirstDishBack) btnOnboardingFirstDishBack.onclick = () => {
    const dishName = document.getElementById('onboardingDishName')?.value.trim();
    const timeStart = document.getElementById('onboardingPickupTimeStart')?.value;
    const timeEnd = document.getElementById('onboardingPickupTimeEnd')?.value;
    
    // Check if user has made changes
    if(dishName || timeStart || timeEnd || onboardingDraftDish?.photoData){
      if(confirm('Sp√§ter weitermachen?\n\nDein Gericht ist noch nicht gespeichert.')){
        showOnboardingEntry(!!onboardingDraftDish);
      }
    } else {
      showOnboardingEntry(!!onboardingDraftDish);
    }
  };
  
  const btnOnboardingFirstDishNext = document.getElementById('btnOnboardingFirstDishNext');
  if(btnOnboardingFirstDishNext) btnOnboardingFirstDishNext.onclick = () => {
    const dishName = document.getElementById('onboardingDishName')?.value.trim();
    const timeStart = document.getElementById('onboardingPickupTimeStart')?.value;
    const timeEnd = document.getElementById('onboardingPickupTimeEnd')?.value;
    
    if(!dishName || !timeStart || !timeEnd){
      alert('Bitte f√ºlle alle Pflichtfelder aus.');
      return;
    }
    
    // Save draft
    onboardingDraftDish = {
      dishName,
      pickupTimeStart: timeStart,
      pickupTimeEnd: timeEnd,
      photoData: onboardingDraftDish?.photoData || null
    };
    save(LS.onboardingDraft, onboardingDraftDish);
    
    // Check if user wants to leave
    showOnboardingSignup();
  };
  
  const btnOnboardingSignupCreate = document.getElementById('btnOnboardingSignupCreate');
  if(btnOnboardingSignupCreate) btnOnboardingSignupCreate.onclick = () => {
    const email = document.getElementById('onboardingEmail')?.value.trim();
    const password = document.getElementById('onboardingPassword')?.value.trim();
    
    if(!email || !password || password.length < 8){
      alert('Bitte gib eine g√ºltige E-Mail und ein Passwort (mind. 8 Zeichen) ein.');
      return;
    }
    
    // Create account
    provider.loggedIn = true;
    provider.email = email;
    provider.onboardingCompleted = false; // Will be set to true after preview
    save(LS.provider, provider);
    
    // Save dish to cookbook
    if(onboardingDraftDish){
      const newDish = {
        id: cryptoId(),
        providerId: providerId(),
        dish: onboardingDraftDish.dishName,
        category: 'Vegetarisch',
        price: 0, // No price in onboarding
        pickupWindow: `${onboardingDraftDish.pickupTimeStart} ‚Äì ${onboardingDraftDish.pickupTimeEnd}`,
        photoData: onboardingDraftDish.photoData || '',
        hasPickupCode: false, // No abholcode in onboarding
        dineInPossible: false,
        allergens: [],
        extras: [],
        reuse: {enabled: false, deposit: 0},
        createdAt: Date.now(),
        lastUsed: null
      };
      cookbook.push(newDish);
      save(LS.cookbook, cookbook);
      
      // Clear draft after successful save
      onboardingDraftDish = null;
      save(LS.onboardingDraft, null);
      
      // Proceed to business screen
      showOnboardingBusiness();
    }
  };
  
  const btnOnboardingSignupLater = document.getElementById('btnOnboardingSignupLater');
  if(btnOnboardingSignupLater) btnOnboardingSignupLater.onclick = () => {
    // Keep draft, go to login
    showView(views.providerLogin);
  };
  
  const btnOnboardingBusinessBack = document.getElementById('btnOnboardingBusinessBack');
  if(btnOnboardingBusinessBack) btnOnboardingBusinessBack.onclick = () => showOnboardingSignup();
  
  const btnOnboardingBusinessNext = document.getElementById('btnOnboardingBusinessNext');
  if(btnOnboardingBusinessNext) btnOnboardingBusinessNext.onclick = () => {
    const businessName = document.getElementById('onboardingBusinessName')?.value.trim();
    const cityOrAddress = document.getElementById('onboardingCityOrAddress')?.value.trim();
    
    if(!businessName || !cityOrAddress){
      alert('Bitte f√ºlle alle Felder aus.');
      return;
    }
    
    // Save provider profile basics
    if(!provider.profile) provider.profile = {};
    provider.profile.name = businessName;
    const parsed = parseAddress(cityOrAddress);
    provider.profile.street = parsed.street || cityOrAddress;
    provider.profile.zip = parsed.zip || '';
    provider.profile.city = parsed.city || cityOrAddress;
    save(LS.provider, provider);
    
    // Get the saved dish ID
    const savedDish = cookbook.find(c => c.providerId === providerId() && c.dish === onboardingDraftDish?.dishName);
    if(savedDish){
      showOnboardingPreview(savedDish.id);
    } else {
      // Fallback: show preview with draft data
      showOnboardingPreview(null);
    }
  };
  
  const btnOnboardingPreviewDashboard = document.getElementById('btnOnboardingPreviewDashboard');
  if(btnOnboardingPreviewDashboard) btnOnboardingPreviewDashboard.onclick = () => {
    provider.onboardingCompleted = true;
    save(LS.provider, provider);
    showProviderHome();
  };
  
  const btnOnboardingPreviewEdit = document.getElementById('btnOnboardingPreviewEdit');
  if(btnOnboardingPreviewEdit) btnOnboardingPreviewEdit.onclick = () => {
    // Restore draft from saved dish
    const savedDish = cookbook.find(c => c.providerId === providerId());
    if(savedDish){
      onboardingDraftDish = {
        dishName: savedDish.dish,
        pickupTimeStart: savedDish.pickupWindow?.split(' ‚Äì ')[0] || '11:30',
        pickupTimeEnd: savedDish.pickupWindow?.split(' ‚Äì ')[1] || '14:30',
        photoData: savedDish.photoData || null
      };
      save(LS.onboardingDraft, onboardingDraftDish);
    }
    showOnboardingFirstDish(true);
  };
  
  // Browser back button handling for onboarding (integrated in existing popstate handler)
  // The existing popstate handler already handles wizard and sheets
  // We add onboarding handling there

  // --- Provider entry ---
  const btnProvBack = document.getElementById('btnProvBack');
  if(btnProvBack){
    btnProvBack.onclick=()=>{ setMode('customer'); showProfile(); };
  }

  const btnProvLogin = document.getElementById('btnProvLogin');
  if(btnProvLogin){
    btnProvLogin.onclick=()=>{
      const email = document.getElementById('provEmail').value.trim();
      const pass = document.getElementById('provPass').value.trim();
      if(!email || !pass){ alert('Bitte E-Mail und Passwort eingeben.'); return; }
      provider.loggedIn = true;
      provider.email = email;
      save(LS.provider, provider);
      showProviderHome();
    };
  }

  const btnProvLogout = document.getElementById('btnProvLogout');
  if(btnProvLogout){
    btnProvLogout.onclick=()=>{
      provider.loggedIn=false;
      save(LS.provider, provider);
      setMode('customer');
      showProfile();
    };
  }

  // Rechtliches
  // --- AGB Onboarding Modal (1-Screen) ---
  function openAgbOnboardingModal(callback){
    const content = document.getElementById('agbOnboardingContent');
    if(!content) return;
    
    content.innerHTML = `
      <h2 style="font-size:20px; font-weight:900; margin-bottom:16px;">AGB (Kurzfassung)</h2>
      <div style="line-height:1.7; font-size:14px; max-height:60vh; overflow-y:auto; padding-right:8px;">
        <p><strong>Mittagio ist Plattform, nicht Verk√§ufer</strong></p>
        <p>Mittagio vermittelt Mittagsangebote lokaler Anbieter. Vertragspartner bei Bestellungen ist ausschlie√ülich der jeweilige Anbieter.</p>
        
        <p style="margin-top:16px;"><strong>Kosten:</strong></p>
        <ul style="padding-left:20px; margin:8px 0;">
          <li>4,99 ‚Ç¨ zzgl. MwSt. pro Ver√∂ffentlichung</li>
          <li>0,89 ‚Ç¨ zzgl. MwSt. pro Online-Bestellung inkl. aller Bank- & Zahlungsgeb√ºhren (pro Bestellung, egal wie viele Gerichte)</li>
        </ul>
        
        <p style="margin-top:16px;"><strong>Abholcode:</strong></p>
        <p>Abholcode = Zahlungs- & Abholnachweis. Abwicklungsgeb√ºhr f√§llt auch bei Nicht-Abholung an.</p>
        
        <p style="margin-top:16px;"><strong>Verantwortung:</strong></p>
        <p>Anbieter ist verantwortlich f√ºr Inhalte/Speisen/gesetzliche Vorgaben.</p>
        
        <p style="margin-top:16px;"><strong>Support:</strong></p>
        <p><a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a></p>
      </div>
    `;
    
    document.getElementById('agbOnboardingBd').classList.add('active');
    document.getElementById('agbOnboardingSheet').classList.add('active');
    
    const acceptBtn = document.getElementById('btnAgbOnboardingAccept');
    const cancelBtn = document.getElementById('btnAgbOnboardingCancel');
    if(acceptBtn) acceptBtn.onclick = () => {
      closeAgbOnboardingModal();
      if(callback) callback(true);
    };
    if(cancelBtn) cancelBtn.onclick = () => {
      closeAgbOnboardingModal();
      if(callback) callback(false);
    };
  }
  
  function closeAgbOnboardingModal(){
    document.getElementById('agbOnboardingBd').classList.remove('active');
    document.getElementById('agbOnboardingSheet').classList.remove('active');
  }
  
  // --- Legal Sheets (Impressum, AGB, Datenschutz) ---
  function openLegalSheet(type){
    const content = document.getElementById('legalContent');
    if(!content) return;
    
    let html = '';
    let title = '';
    
    if(type === 'impressum'){
      title = 'Impressum';
      html = `
        <h3 style="margin:0 0 20px;">Impressum</h3>
        <div style="line-height:1.8;">
          <p style="font-weight:700; margin-bottom:12px;">Verantwortlich f√ºr den Inhalt:</p>
          <p>
            Mittagio<br>
            Inhaber: Mike Quach<br>
            Lang√§cker 2<br>
            73635 Rudersberg<br>
            Deutschland
          </p>
          <p style="margin-top:16px;">
            <strong>E-Mail:</strong> <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a>
          </p>
          <p style="margin-top:20px; padding-top:20px; border-top:1px solid #eee; font-size:13px; color:#666;">
            <strong>Unternehmensform:</strong> Einzelunternehmen<br>
            <strong>Umsatzsteuer-ID:</strong> nicht vorhanden (¬ß19 UStG)
          </p>
          <p style="margin-top:16px; padding-top:16px; border-top:1px solid #eee; font-size:13px; color:#666;">
            <strong>Plattformhinweis:</strong><br>
            Mittagio vermittelt Mittagsangebote lokaler Anbieter. Vertragspartner bei Bestellungen ist ausschlie√ülich der jeweilige Anbieter.
          </p>
        </div>
      `;
    } else if(type === 'agb'){
      title = 'Allgemeine Gesch√§ftsbedingungen (Kunden)';
      html = `
        <h3 style="margin:0 0 20px;">Allgemeine Gesch√§ftsbedingungen (Kunden)</h3>
        <div style="line-height:1.8; font-size:14px;">
          <p style="margin-bottom:16px;"><strong>1. Geltungsbereich</strong></p>
          <p style="margin-bottom:20px;">Diese Allgemeinen Gesch√§ftsbedingungen (AGB) gelten f√ºr die Nutzung der Plattform Mittagio durch Kunden. Mittagio betreibt eine Plattform zur Vermittlung von Mittagsangeboten lokaler Anbieter.</p>
          
          <p style="margin-bottom:16px;"><strong>2. Rolle von Mittagio</strong></p>
          <p style="margin-bottom:20px;">Mittagio ist kein Restaurant und kein Lieferdienst. Mittagio vermittelt ausschlie√ülich zwischen Kunden und Anbietern. Der Kaufvertrag kommt direkt zwischen dem Kunden und dem jeweiligen Anbieter zustande.</p>
          
          <p style="margin-bottom:16px;"><strong>3. Nutzung der Plattform</strong></p>
          <p style="margin-bottom:20px;">Die Nutzung ist grunds√§tzlich ohne Registrierung m√∂glich. Kunden k√∂nnen Mittagsangebote ausw√§hlen und vorbestellen. Ein Anspruch auf Verf√ºgbarkeit bestimmter Angebote besteht nicht.</p>
          
          <p style="margin-bottom:16px;"><strong>4. Bestellung & Abholung</strong></p>
          <p style="margin-bottom:20px;">Mit Abschluss der Bestellung erh√§lt der Kunde einen Abholcode. Der Abholcode ist beim Anbieter vorzuzeigen. Die Abholung erfolgt innerhalb der vom Anbieter angegebenen Essenszeit.</p>
          
          <p style="margin-bottom:16px;"><strong>5. Preise & Bezahlung</strong></p>
          <p style="margin-bottom:20px;">Alle Preise werden vom Anbieter festgelegt. Die Bezahlung erfolgt direkt beim Anbieter vor Ort, sofern nicht anders angegeben. Mittagio erhebt aktuell keine Geb√ºhren vom Kunden.</p>
          
          <p style="margin-bottom:16px;"><strong>6. Stornierung</strong></p>
          <p style="margin-bottom:20px;">Stornierungen sind abh√§ngig von den Regelungen des jeweiligen Anbieters. Ein Anspruch auf Stornierung oder R√ºckerstattung √ºber Mittagio besteht nicht.</p>
          
          <p style="margin-bottom:16px;"><strong>7. Haftung</strong></p>
          <p style="margin-bottom:20px;">Mittagio haftet nicht f√ºr Qualit√§t, Menge oder Beschaffenheit der Speisen, Ausf√§lle, Versp√§tungen oder √Ñnderungen durch den Anbieter, sowie Allergene oder Unvertr√§glichkeiten. F√ºr diese Punkte ist ausschlie√ülich der jeweilige Anbieter verantwortlich.</p>
          
          <p style="margin-bottom:16px;"><strong>8. Verf√ºgbarkeit</strong></p>
          <p style="margin-bottom:20px;">Mittagio bem√ºht sich um eine hohe Verf√ºgbarkeit der Plattform, √ºbernimmt jedoch keine Garantie f√ºr eine jederzeit unterbrechungsfreie Nutzung.</p>
          
          <p style="margin-bottom:16px;"><strong>9. √Ñnderungen der AGB</strong></p>
          <p style="margin-bottom:20px;">Mittagio beh√§lt sich vor, diese AGB anzupassen, wenn sich Funktionen oder rechtliche Rahmenbedingungen √§ndern.</p>
          
          <p style="margin-bottom:16px;"><strong>10. Kontakt</strong></p>
          <p style="margin-bottom:20px;">Bei Fragen zur Nutzung der Plattform: <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a></p>
          
          <p style="margin-top:24px; padding-top:20px; border-top:1px solid #eee; font-size:12px; color:#666;">
            <strong>Stand:</strong> Januar 2026
          </p>
        </div>
      `;
    } else if(type === 'datenschutz'){
      title = 'Datenschutzerkl√§rung';
      html = `
        <h3 style="margin:0 0 20px;">Datenschutzerkl√§rung</h3>
        <div style="line-height:1.8; font-size:14px;">
          <p style="margin-bottom:16px;"><strong>1. Verantwortlicher</strong></p>
          <p style="margin-bottom:20px;">
            Verantwortlich f√ºr die Datenverarbeitung ist:<br><br>
            <strong>Mittagio</strong><br>
            Inhaber: Mike Quach<br>
            Lang√§cker 2<br>
            73635 Rudersberg<br>
            Deutschland<br><br>
            <strong>E-Mail:</strong> <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a>
          </p>
          
          <p style="margin-bottom:16px;"><strong>2. Allgemeines</strong></p>
          <p style="margin-bottom:20px;">Der Schutz deiner pers√∂nlichen Daten ist uns wichtig. Wir verarbeiten personenbezogene Daten nur im notwendigen Umfang und gem√§√ü den geltenden Datenschutzgesetzen (DSGVO).</p>
          
          <p style="margin-bottom:16px;"><strong>3. Welche Daten wir verarbeiten</strong></p>
          <p style="margin-bottom:12px;"><strong>a) Bei der Nutzung der Plattform</strong></p>
          <p style="margin-bottom:20px;">Beim Besuch von Mittagio werden technisch notwendige Daten verarbeitet, z. B.:</p>
          <ul style="margin:0 0 20px 20px; padding-left:0;">
            <li style="margin-bottom:8px;">IP-Adresse (gek√ºrzt/anonymisiert, sofern m√∂glich)</li>
            <li style="margin-bottom:8px;">Datum und Uhrzeit des Zugriffs</li>
            <li style="margin-bottom:8px;">Browsertyp / Betriebssystem</li>
            <li style="margin-bottom:8px;">aufgerufene Seiten</li>
          </ul>
          <p style="margin-bottom:20px;">Diese Daten sind technisch erforderlich, um die Plattform bereitzustellen.</p>
          
          <p style="margin-bottom:12px;"><strong>b) Bei einer Bestellung</strong></p>
          <p style="margin-bottom:12px;">Wenn du ein Mittagsangebot bestellst, verarbeiten wir:</p>
          <ul style="margin:0 0 12px 20px; padding-left:0;">
            <li style="margin-bottom:8px;">ausgew√§hltes Gericht</li>
            <li style="margin-bottom:8px;">Anbieter</li>
            <li style="margin-bottom:8px;">Abholzeit (ungef√§hr)</li>
            <li style="margin-bottom:8px;">generierter Abholcode</li>
          </ul>
          <p style="margin-bottom:20px;">
            üëâ Keine Pflicht zur Registrierung<br>
            üëâ Keine Zahlungsdaten (Bezahlung erfolgt ggf. vor Ort beim Anbieter)
          </p>
          
          <p style="margin-bottom:12px;"><strong>c) Lokale Speicherung (PWA)</strong></p>
          <p style="margin-bottom:20px;">Bestellungen und Abholcodes werden lokal auf deinem Ger√§t gespeichert (z. B. im LocalStorage), damit du sie auch offline wieder anzeigen kannst. Diese Daten werden nicht automatisch an uns √ºbertragen.</p>
          
          <p style="margin-bottom:16px;"><strong>4. Weitergabe von Daten</strong></p>
          <p style="margin-bottom:20px;">Deine Daten werden nur an den jeweiligen Anbieter weitergegeben, soweit dies zur Abwicklung deiner Bestellung erforderlich ist.</p>
          <p style="margin-bottom:20px;">Eine Weitergabe an Dritte erfolgt nicht, au√üer:</p>
          <ul style="margin:0 0 20px 20px; padding-left:0;">
            <li style="margin-bottom:8px;">es besteht eine gesetzliche Verpflichtung</li>
            <li style="margin-bottom:8px;">oder du hast ausdr√ºcklich eingewilligt</li>
          </ul>
          
          <p style="margin-bottom:16px;"><strong>5. Cookies & Tracking</strong></p>
          <p style="margin-bottom:20px;">Mittagio verwendet keine Tracking-Cookies und kein Nutzer-Tracking zu Werbezwecken.</p>
          <p style="margin-bottom:20px;">Es werden ausschlie√ülich technisch notwendige Speichermechanismen verwendet (z. B. f√ºr App-Funktionen).</p>
          
          <p style="margin-bottom:16px;"><strong>6. Hosting</strong></p>
          <p style="margin-bottom:20px;">Die Plattform wird √ºber externe Hosting-Anbieter betrieben. Dabei k√∂nnen technisch notwendige Zugriffsdaten (z. B. IP-Adresse) verarbeitet werden, um den sicheren Betrieb zu gew√§hrleisten.</p>
          
          <p style="margin-bottom:16px;"><strong>7. Deine Rechte</strong></p>
          <p style="margin-bottom:12px;">Du hast jederzeit das Recht auf:</p>
          <ul style="margin:0 0 12px 20px; padding-left:0;">
            <li style="margin-bottom:8px;">Auskunft √ºber deine gespeicherten Daten</li>
            <li style="margin-bottom:8px;">Berichtigung unrichtiger Daten</li>
            <li style="margin-bottom:8px;">L√∂schung deiner Daten</li>
            <li style="margin-bottom:8px;">Einschr√§nkung der Verarbeitung</li>
            <li style="margin-bottom:8px;">Widerspruch gegen die Verarbeitung</li>
          </ul>
          <p style="margin-bottom:20px;">Anfragen bitte per E-Mail an: <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a></p>
          
          <p style="margin-bottom:16px;"><strong>8. √Ñnderungen dieser Datenschutzerkl√§rung</strong></p>
          <p style="margin-bottom:20px;">Diese Datenschutzerkl√§rung kann angepasst werden, wenn sich Funktionen oder gesetzliche Vorgaben √§ndern.</p>
          <p style="margin-bottom:20px;">Es gilt jeweils die auf dieser Seite ver√∂ffentlichte Version.</p>
          
          <p style="margin-top:24px; padding-top:20px; border-top:1px solid #eee; font-size:12px; color:#666;">
            <strong>9. Stand</strong><br>
            Stand: Januar 2026
          </p>
        </div>
      `;
    }
    
    content.innerHTML = html;
    document.getElementById('legalBd').classList.add('active');
    document.getElementById('legalSheet').classList.add('active');
  }
  
  function closeLegalSheet(){
    document.getElementById('legalBd').classList.remove('active');
    document.getElementById('legalSheet').classList.remove('active');
  }
  
  // FAQ Sheet
  function openFaqSheet(){
    const content = document.getElementById('faqSheetContent');
    if(!content) return;
    
    const allFaq = `
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Wie funktioniert Mittagio?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Du findest Mittagsangebote in deiner Stadt, optional bezahlst du online und holst zur gew√§hlten Zeit ab.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Was ist der Abholcode?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Dein Schnell-Ticket f√ºr die Mittagspause. Du erh√§ltst ihn nach erfolgreicher Online-Zahlung.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Muss ich online bezahlen?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Nein. Online-Zahlung ist optional. Eine Abholnummer gibt's nur bei Online-Zahlung.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Kann ich ohne Abholcode bestellen?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Nein. Angebote ohne Abholcode kannst du nur ansehen.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Wann kann ich abholen?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Innerhalb der Essenszeit. W√§hle eine ungef√§hre Abholzeit im Warenkorb.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Kann ich f√ºr mehrere Personen bestellen?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Ja. Du kannst mehrere Gerichte in einem Vorgang bestellen (eine Abholnummer).</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Vor Ort essen m√∂glich?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Wenn das Badge ‚ÄûVor Ort" angezeigt wird, kannst du vor Ort essen.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Teilen</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Teile Angebote per WhatsApp, Instagram oder Website.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Kontakt</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Bei Fragen schreib uns an <a href="mailto:support@mittagio.de" style="color:var(--muted);">support@mittagio.de</a></p>
      </details>
    `;
    
    content.innerHTML = allFaq;
    document.getElementById('faqBd').classList.add('active');
    document.getElementById('faqSheet').classList.add('active');
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined') setTimeout(()=> lucide.createIcons(), 50);
  }
  
  function closeFaqSheet(){
    document.getElementById('faqBd').classList.remove('active');
    document.getElementById('faqSheet').classList.remove('active');
  }
  
  // Legal Links (alte IDs)
  const btnImpressum = document.getElementById('btnImpressum');
  if(btnImpressum) btnImpressum.onclick=()=>{ openLegalSheet('impressum'); };
  const btnAGB = document.getElementById('btnAGB');
  if(btnAGB) btnAGB.onclick=()=>{ openLegalSheet('agb'); };
  const btnDatenschutz = document.getElementById('btnDatenschutz');
  if(btnDatenschutz) btnDatenschutz.onclick=()=>{ openLegalSheet('datenschutz'); };
  
  // Profile Legal Links - √∂ffnen statische Seiten
  const btnProfileImpressum = document.getElementById('btnProfileImpressum');
  if(btnProfileImpressum) btnProfileImpressum.onclick=(e)=>{ e.preventDefault(); showLegalPage('impressum'); };
  const btnProfileAGB = document.getElementById('btnProfileAGB');
  if(btnProfileAGB) btnProfileAGB.onclick=(e)=>{ e.preventDefault(); showLegalPage('agb-kurz'); };
  const btnProfileDatenschutz = document.getElementById('btnProfileDatenschutz');
  if(btnProfileDatenschutz) btnProfileDatenschutz.onclick=(e)=>{ e.preventDefault(); showLegalPage('datenschutz'); };
  
  // FAQ Expand Button (Text Link) - √∂ffnet Modal
  const btnProfileShowMoreFaq = document.getElementById('btnProfileShowMoreFaq');
  if(btnProfileShowMoreFaq){
    btnProfileShowMoreFaq.onclick = (e) => {
      e.preventDefault();
      openFaqSheet();
    };
  }

  // Provider nav handlers
  document.getElementById('providerNav').addEventListener('click',(e)=>{
    const b = e.target.closest('button');
    if(!b) return;
    const go = b.dataset.pgo;
    if(go==='provider-home') showProviderHome();
    if(go==='provider-pickups') showProviderPickups();
    if(go==='provider-cookbook') showProviderCookbook();
    if(go==='provider-profile') showProviderProfile();
  });

  // Customer nav handlers - Robuster Event-Delegation-Ansatz
  document.addEventListener('click', function(e){
    // Pr√ºfe ob Klick innerhalb von customerNav
    const nav = document.getElementById('customerNav');
    if(!nav || !nav.contains(e.target)) return;
    
    // Finde den Button (auch wenn auf Icon/Text geklickt wurde)
    let target = e.target;
    let btn = null;
    
    while(target && target !== nav){
      if(target.tagName === 'BUTTON' && target.classList.contains('navbtn')){
        btn = target;
        break;
      }
      target = target.parentElement;
    }
    
    if(!btn || !btn.dataset.go) return;
    
    const go = btn.dataset.go;
    e.preventDefault();
    e.stopPropagation();
    
    console.log('Navigation clicked:', go, 'mode:', mode);
    
    try {
      if(go==='discover'){
        if(mode === 'start'){
          showStart();
        } else {
          showDiscover();
        }
      } else if(go==='fav'){
        showFav();
      } else if(go==='orders'){
        showOrders();
      } else if(go==='cart'){
        showCart();
      } else if(go==='profile'){
        showProfile();
      }
    } catch(err){
      console.error('Navigation error:', err, go);
      alert('Navigation-Fehler: ' + err.message);
    }
  }, true); // useCapture f√ºr fr√ºhere Event-Erfassung

  // --- Provider Dashboard (Home) - FINAL MVP ---
  let createFlowPreselectedDate = null; // F√ºr Date-Preselect aus Today/Week
  
  function renderProviderHome(){
    const profile = normalizeProviderProfile(provider.profile || {});
    const todayKey = isoDate(new Date());
    const mineAll = offers.filter(o => o.providerId === providerId());
    const mineActive = mineAll.filter(o => o.active !== false);
    const mineToday = mineActive.filter(o => o.day === todayKey);
    
    // Provider Identity Card
    const logoWrap = document.getElementById('provCardLogo');
    if(logoWrap){
      if(profile.logoData){
        logoWrap.innerHTML = `<img src="${esc(profile.logoData)}" alt="Logo" style="width:100%; height:100%; object-fit:cover; border-radius:14px;" />`;
      } else {
        const initials = (profile.name || provider.email || 'A').charAt(0).toUpperCase();
        logoWrap.innerHTML = `<div style="width:100%; height:100%; background:linear-gradient(135deg, var(--brand), var(--brand2)); display:flex; align-items:center; justify-content:center; border-radius:14px; font-size:24px; font-weight:900; color:#111;">${esc(initials)}</div>`;
      }
    }
    const nameEl = document.getElementById('provCardName');
    if(nameEl) nameEl.textContent = profile.name || provider.email || 'Anbieter';
    const addrEl = document.getElementById('provCardAddr');
    if(addrEl){
      const addr = buildAddress(profile);
      if(addr){
        addrEl.textContent = esc(addr);
        addrEl.style.color = 'var(--muted)';
      } else {
        addrEl.textContent = 'Adresse hinzuf√ºgen';
        addrEl.style.color = 'var(--brand)';
      }
    }
    
    const btnProviderEditProfile = document.getElementById('btnProviderEditProfile');
    if(btnProviderEditProfile){
      btnProviderEditProfile.textContent = buildAddress(profile) ? 'Profil bearbeiten' : 'Adresse hinzuf√ºgen';
      btnProviderEditProfile.onclick = () => {
        showProviderProfile();
      };
    }
    
    // KPI Cards
    const activeOffersCount = mineActive.length;
    const todayPickups = loadOrders().filter(o => {
      const offer = offers.find(off => off.id === o.dishId || off.providerId === o.providerId);
      return offer && offer.providerId === providerId() && offer.day === todayKey && o.status === 'PAID';
    }).length;
    const cookbookCount = cookbook.length;
    
    const kpiInserateCount = document.getElementById('kpiInserateCount');
    if(kpiInserateCount) kpiInserateCount.textContent = activeOffersCount;
    const kpiAbholungenCount = document.getElementById('kpiAbholungenCount');
    if(kpiAbholungenCount) kpiAbholungenCount.textContent = todayPickups;
    const kpiKochbuchCount = document.getElementById('kpiKochbuchCount');
    if(kpiKochbuchCount) kpiKochbuchCount.textContent = cookbookCount;
    
    // KPI Card Handlers
    const kpiCardInserate = document.getElementById('kpiCardInserate');
    if(kpiCardInserate) kpiCardInserate.onclick = () => {
      // Scroll to Active Offers section
      const activeOffers = document.getElementById('providerActiveOffers');
      if(activeOffers){
        activeOffers.scrollIntoView({behavior: 'smooth', block: 'start'});
      }
    };
    const kpiCardAbholungen = document.getElementById('kpiCardAbholungen');
    if(kpiCardAbholungen) kpiCardAbholungen.onclick = () => {
      showProviderPickups();
    };
    const kpiCardKochbuch = document.getElementById('kpiCardKochbuch');
    if(kpiCardKochbuch) kpiCardKochbuch.onclick = () => {
      showProviderCookbook();
    };
    
    // TODAY Card
    const providerTodayCard = document.getElementById('providerTodayCard');
    const providerTodayTitle = document.getElementById('providerTodayTitle');
    const providerTodayContent = document.getElementById('providerTodayContent');
    if(providerTodayCard && providerTodayTitle && providerTodayContent){
      const today = new Date();
      const weekday = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'][today.getDay()];
      const dateStr = `${today.getDate()}.${String(today.getMonth()+1).padStart(2,'0')}.`;
      providerTodayTitle.textContent = `Heute ¬∑ ${weekday}, ${dateStr}`;
      
      if(mineToday.length > 0){
        const withCodeToday = mineToday.filter(o => o.hasPickupCode).length;
        const nextPickup = loadOrders().filter(o => {
          const offer = offers.find(off => off.id === o.dishId || off.providerId === o.providerId);
          return offer && offer.providerId === providerId() && offer.day === todayKey && o.status === 'PAID';
        }).sort((a,b) => (a.etaTime || '').localeCompare(b.etaTime || ''))[0];
        
        let html = `
          <div style="margin-bottom:12px;">
            <a href="#" id="providerTodayInserateLink" style="display:block; padding:10px; background:#f8f7f3; border-radius:12px; text-decoration:none; color:inherit; margin-bottom:8px;">
              <div style="font-weight:600; font-size:14px;">Inserate heute: ${mineToday.length}</div>
            </a>
            <a href="#" id="providerTodayPickupsLink" style="display:block; padding:10px; background:#f8f7f3; border-radius:12px; text-decoration:none; color:inherit;">
              <div style="font-weight:600; font-size:14px;">Abholungen heute: ${todayPickups}</div>
            </a>
        `;
        if(nextPickup && nextPickup.etaTime){
          const pickupCount = loadOrders().filter(o => {
            const offer = offers.find(off => off.id === o.dishId || off.providerId === o.providerId);
            return offer && offer.providerId === providerId() && offer.day === todayKey && o.status === 'PAID' && o.etaTime === nextPickup.etaTime;
          }).length;
          html += `
            <div style="margin-top:8px; padding:10px; background:#f8f7f3; border-radius:12px;">
              <div style="font-weight:600; font-size:14px;">N√§chste Abholung: ${esc(nextPickup.etaTime)} (${pickupCount} ${pickupCount === 1 ? 'Code' : 'Codes'})</div>
            </div>
          `;
        }
        html += `</div>`;
        providerTodayContent.innerHTML = html;
        
        const providerTodayInserateLink = document.getElementById('providerTodayInserateLink');
        if(providerTodayInserateLink) providerTodayInserateLink.onclick = (e) => {
          e.preventDefault();
          // Scroll to Active Offers section (falls vorhanden)
          const activeOffers = document.getElementById('providerActiveOffers');
          if(activeOffers){
            activeOffers.scrollIntoView({behavior: 'smooth', block: 'start'});
          }
        };
        const providerTodayPickupsLink = document.getElementById('providerTodayPickupsLink');
        if(providerTodayPickupsLink) providerTodayPickupsLink.onclick = (e) => {
          e.preventDefault();
          showProviderPickups();
        };
      } else {
        providerTodayContent.innerHTML = `
          <div style="font-weight:600; font-size:16px; margin-bottom:8px; text-align:center;">Keine Inserate heute</div>
          <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:var(--muted); text-align:center;">
            Erstelle dein erstes Inserat f√ºr heute.
          </div>
          <button class="btn secondary" type="button" id="btnProviderTodayAddDish" style="width:100%; min-height:44px;">
            Inserat f√ºr heute erstellen
          </button>
        `;
        const btnProviderTodayAddDish = document.getElementById('btnProviderTodayAddDish');
        if(btnProviderTodayAddDish) btnProviderTodayAddDish.onclick = () => {
          createFlowPreselectedDate = todayKey;
          openCreateFlowSheet();
        };
      }
    }
    
    // Active Offers Mini List (max 3, expandable)
    const providerActiveOffers = document.getElementById('providerActiveOffers');
    const providerActiveOffersList = document.getElementById('providerActiveOffersList');
    if(providerActiveOffers && providerActiveOffersList){
      const showAll = providerActiveOffers.dataset.showAll === 'true';
      const activeList = showAll ? mineActive : mineActive.slice(0, 3);
      if(activeList.length > 0){
        providerActiveOffers.style.display = 'block';
        providerActiveOffersList.innerHTML = activeList.map(o => {
          // Status-Badge: "LIVE ¬∑ Online bezahlt" oder "LIVE ¬∑ Vor Ort"
          let statusBadge = '';
          if(o.active !== false){
            if(o.hasPickupCode){
              statusBadge = '<span style="font-size:11px; padding:2px 8px; background:rgba(46,125,50,.12); border-radius:6px; color:#2e7d32; font-weight:600;">üü¢ LIVE ¬∑ Online bezahlt</span>';
            } else {
              statusBadge = '<span style="font-size:11px; padding:2px 8px; background:rgba(0,0,0,.06); border-radius:6px; color:#666; font-weight:600;">‚ö™ LIVE ¬∑ Vor Ort</span>';
            }
          }
          
          // Verzehrart-Badges
          const badges = [];
          if(o.hasPickupCode) badges.push('<span style="font-size:11px; padding:2px 6px; background:rgba(255,204,0,.15); border-radius:6px; color:var(--brand);">Abholcode</span>');
          if(o.dineInPossible) badges.push('<span style="font-size:11px; padding:2px 6px; background:rgba(31,157,85,.15); border-radius:6px; color:var(--brand2);">Vor Ort</span>');
          if(!o.dineInPossible && !o.hasPickupCode) badges.push('<span style="font-size:11px; padding:2px 6px; background:rgba(0,0,0,.06); border-radius:6px;">To Go</span>');
          
          return `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 0; border-bottom:1px solid var(--border);">
              <div style="flex:1; min-width:0;" data-offer-id="${esc(o.id)}" style="cursor:pointer;">
                <div style="font-weight:600; font-size:14px; line-height:1.3; margin-bottom:4px;">${esc(o.dish || o.title || 'Gericht')}</div>
                <div style="font-size:12px; color:var(--muted); margin-bottom:6px;">${esc(o.pickupWindow || o.time || '')}</div>
                <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
                  ${statusBadge}
                  ${badges.join('')}
                </div>
              </div>
              <button class="btn ghost" type="button" data-offer-id="${esc(o.id)}" style="padding:8px; min-width:36px; margin-left:8px; flex-shrink:0;" onclick="event.stopPropagation(); openOfferMoreMenu('${esc(o.id)}');">
                ‚ãØ
              </button>
            </div>
          `;
        }).join('');
        
        // Tap on offer item
        providerActiveOffersList.querySelectorAll('[data-offer-id]').forEach(el => {
          if(el.tagName !== 'BUTTON'){
            el.onclick = () => {
              const offerId = el.dataset.offerId;
              startListingFlow({editOfferId: offerId});
            };
          }
        });
        
        const btnProviderShowAllOffers = document.getElementById('btnProviderShowAllOffers');
        if(btnProviderShowAllOffers){
          if(mineActive.length > 3){
            btnProviderShowAllOffers.style.display = 'inline-block';
            btnProviderShowAllOffers.onclick = (e) => {
              e.preventDefault();
              providerActiveOffers.dataset.showAll = 'true';
              renderProviderHome();
            };
          } else {
            btnProviderShowAllOffers.style.display = 'none';
          }
        }
      } else {
        providerActiveOffers.style.display = 'none';
      }
    }
    
    // Week Preview
    renderProviderWeekPreviewNew();
    
    // Post-Onboarding Dashboard State (if just completed onboarding)
    const providerEmptyDashboard = document.getElementById('providerEmptyDashboard');
    if(providerEmptyDashboard){
      const hasAnyData = mineActive.length > 0 || cookbook.length > 0;
      const justCompletedOnboarding = provider.onboardingCompleted && !provider.onboardingShown && cookbook.length > 0;
      
      if(justCompletedOnboarding){
        // Show post-onboarding state
        providerEmptyDashboard.style.display = 'block';
        providerEmptyDashboard.innerHTML = `
          <div style="font-weight:600; font-size:18px; margin-bottom:8px; line-height:1.3;">Gericht erstellt</div>
          <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:var(--muted);">
            Dein Gericht ist gespeichert. Ver√∂ffentliche es, um sichtbar zu werden.
          </div>
          <button class="btn-primary" type="button" id="btnPostOnboardingPublish" style="width:100%; min-height:56px; margin-bottom:12px;">
            Gericht ver√∂ffentlichen
          </button>
          <button class="btn secondary" type="button" id="btnPostOnboardingPlan" style="width:100%; min-height:44px;">
            Weiter planen
          </button>
        `;
        
        const btnPublish = document.getElementById('btnPostOnboardingPublish');
        const btnPlan = document.getElementById('btnPostOnboardingPlan');
        if(btnPublish){
          const savedDish = cookbook.find(c => c.providerId === providerId());
          if(savedDish){
            btnPublish.onclick = () => {
              startListingFlow({dishId: savedDish.id});
            };
          }
        }
        if(btnPlan) btnPlan.onclick = () => showProviderCookbook();
        
        // Mark onboarding as shown
        provider.onboardingShown = true;
        save(LS.provider, provider);
      } else {
        // Normal empty state - Dashboard zeigt nur Inserate/Abholung/Kochbuch (kein Onboarding)
        providerEmptyDashboard.style.display = 'none'; // Immer ausblenden, kein Onboarding
        
        const btnProviderEmptyAddDish = document.getElementById('btnProviderEmptyAddDish');
        if(btnProviderEmptyAddDish) btnProviderEmptyAddDish.onclick = () => {
          createFlowPreselectedDate = null;
          openCreateFlowSheet();
        };
      }
    }
    
    // FAB
    const fabProviderAddOffer = document.getElementById('fabProviderAddOffer');
    const fabProviderAddOfferLabel = document.getElementById('fabProviderAddOfferLabel');
    if(fabProviderAddOffer){
      fabProviderAddOffer.onclick = () => {
        createFlowPreselectedDate = null;
        openCreateFlowSheet();
      };
      fabProviderAddOffer.onmouseenter = () => {
        if(fabProviderAddOfferLabel) fabProviderAddOfferLabel.style.opacity = '1';
      };
      fabProviderAddOffer.onmouseleave = () => {
        if(fabProviderAddOfferLabel) fabProviderAddOfferLabel.style.opacity = '0';
      };
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined') setTimeout(()=> lucide.createIcons(), 50);
  }

  // Week Preview (7 Tage)
  function renderProviderWeekPreviewNew(){
    const dayWrap = document.getElementById('providerWeekDays');
    const dayContent = document.getElementById('providerWeekDayContent');
    if(!dayWrap || !dayContent) return;
    
    const today = new Date();
    let selectedDay = providerWeekDay || isoDate(today);
    
    dayWrap.innerHTML = '';
    for(let i=0; i<7; i++){
      const d = new Date(today);
      d.setDate(d.getDate() + i);
      const key = isoDate(d);
      const b = document.createElement('button');
      b.className = 'day' + (selectedDay === key ? ' active' : '');
      const weekday = ['So','Mo','Di','Mi','Do','Fr','Sa'][d.getDay()];
      const dateStr = `${d.getDate()}.${String(d.getMonth()+1).padStart(2,'0')}.`;
      b.textContent = i === 0 ? 'Heute' : `${weekday}, ${dateStr}`;
      b.onclick = () => {
        providerWeekDay = key;
        renderProviderWeekPreviewNew();
      };
      dayWrap.appendChild(b);
    }
    
    // Day Content
    const offersForDay = offers.filter(o => o.providerId === providerId() && o.active !== false && o.day === selectedDay);
    const weekEntries = (week[selectedDay] || []).filter(x => x.providerId === providerId() && x.active !== false);
    const totalPlanned = offersForDay.length + weekEntries.length;
    
    if(totalPlanned > 0){
      dayContent.innerHTML = `
        <div style="padding:12px; background:#f8f7f3; border-radius:12px; margin-bottom:12px;">
          <div style="font-weight:600; font-size:14px; margin-bottom:8px;">${totalPlanned} ${totalPlanned === 1 ? 'Inserat' : 'Inserate'} geplant</div>
          <div style="font-size:13px; color:var(--muted); margin-bottom:12px;">${offersForDay.length} aktiv, ${weekEntries.length} im Wochenplan</div>
        </div>
        <button class="btn secondary" type="button" id="btnProviderWeekAddDish" style="width:100%; min-height:44px;">
          Inserat f√ºr diesen Tag hinzuf√ºgen
        </button>
      `;
      const btnProviderWeekAddDish = document.getElementById('btnProviderWeekAddDish');
      if(btnProviderWeekAddDish) btnProviderWeekAddDish.onclick = () => {
        createFlowPreselectedDate = selectedDay;
        openCreateFlowSheet();
      };
    } else {
      dayContent.innerHTML = `
        <div style="font-weight:600; font-size:16px; margin-bottom:8px; text-align:center;">Keine Inserate geplant</div>
        <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:var(--muted); text-align:center;">
          Erstelle ein Inserat f√ºr diesen Tag.
        </div>
        <button class="btn secondary" type="button" id="btnProviderWeekAddDishEmpty" style="width:100%; min-height:44px;">
          Inserat f√ºr diesen Tag erstellen
        </button>
      `;
      const btnProviderWeekAddDishEmpty = document.getElementById('btnProviderWeekAddDishEmpty');
      if(btnProviderWeekAddDishEmpty) btnProviderWeekAddDishEmpty.onclick = () => {
        createFlowPreselectedDate = selectedDay;
        openCreateFlowSheet();
      };
    }
  }
  
  // Legacy function (f√ºr Kompatibilit√§t)
  function renderProviderWeekPreview(){
    const dayWrap = document.getElementById('provWeekDays');
    const list = document.getElementById('provWeekPreview');
    if(!dayWrap || !list) return;

    dayWrap.innerHTML = '';
    for(let i=0;i<5;i++){
      const d = new Date(); d.setDate(d.getDate()+i);
      const key = isoDate(d);
      const b = document.createElement('button');
      b.className = 'day' + (providerWeekDay===key ? ' active' : '');
      b.textContent = fmtDay(d);
      b.onclick=()=>{ providerWeekDay = key; renderProviderWeekPreview(); };
      dayWrap.appendChild(b);
    }

    const items = (week[providerWeekDay]||[]).filter(x=>x.providerId===providerId() && x.active !== false);
    if(!items.length){
      list.innerHTML = `
        <div>Keine Inserate geplant.</div>
        <div style="height:8px"></div>
        <button class="btn secondary" type="button" id="btnWeekAdd">Inserat hinzuf√ºgen</button>
      `;
      const addBtn = document.getElementById('btnWeekAdd');
      if(addBtn) addBtn.onclick=()=> startListingFlow({});
      return;
    }
    list.innerHTML = items.map(i=>`‚Ä¢ ${esc(i.dish)}`).join('<br>');
  }

  function renderWeekPlan(){
    const dayWrap = document.getElementById('weekDays');
    const list = document.getElementById('weekList');
    if(!dayWrap || !list) return;

    dayWrap.innerHTML = '';
    for(let i=0;i<5;i++){
      const d = new Date(); d.setDate(d.getDate()+i);
      const key = isoDate(d);
      const b = document.createElement('button');
      b.className = 'day' + (weekPlanDay===key ? ' active' : '');
      b.textContent = fmtDay(d);
      b.onclick=()=>{ weekPlanDay = key; renderWeekPlan(); };
      dayWrap.appendChild(b);
    }

    const dayEntries = week[weekPlanDay] || [];
    const providerEntries = dayEntries
      .map((entry, idx)=>({entry, idx}))
      .filter(x=>x.entry.providerId===providerId());

    if(!providerEntries.length){
      list.innerHTML = `
        <div style="font-weight:600; font-size:16px; margin-bottom:8px;">Keine Inserate geplant</div>
        <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:var(--muted);">
          Plane deine Woche und erstelle Inserate.
        </div>
        <button class="btn secondary" type="button" id="btnWeekEmptyAdd" style="width:100%; min-height:44px;">
          Inserat erstellen
        </button>
      `;
      const btnWeekEmptyAdd = document.getElementById('btnWeekEmptyAdd');
      if(btnWeekEmptyAdd) btnWeekEmptyAdd.onclick = () => {
        createFlowPreselectedDate = weekPlanDay;
        openCreateFlowSheet();
      };
      // Hide PDF button in empty state
      const btnWeekPdf = document.getElementById('btnWeekPdf');
      if(btnWeekPdf) btnWeekPdf.style.display = 'none';
      return;
    }

    // Show PDF button only when there are entries
    const btnWeekPdf = document.getElementById('btnWeekPdf');
    if(btnWeekPdf) btnWeekPdf.style.display = 'block';
    
    list.innerHTML = '';
    providerEntries.forEach(({entry, idx})=>{
      const cb = cookbook.find(c=>c.id===entry.cookbookId);
      const name = cb?.dish || entry.dish || 'Gericht';
      const price = cb?.price || 0;
      const isActive = entry.active !== false;

      const item = document.createElement('div');
      item.className = 'cookbook-item';
      item.innerHTML = `
        <div style="font-weight:900">${esc(name)}</div>
        <div class="hint">${euro(price)} - ${isActive ? 'Aktiv' : 'Inaktiv'}</div>
      `;

      const actions = document.createElement('div');
      actions.className = 'cookbook-actions';

      const edit = document.createElement('button');
      edit.type='button';
      edit.className='ans';
      edit.textContent='Bearbeiten';
      edit.onclick=()=>{ if(entry.cookbookId) startWizard('cookbook', {editId: entry.cookbookId}); };

      const toggle = document.createElement('button');
      toggle.type='button';
      toggle.className='ans';
      toggle.textContent = isActive ? 'Deaktivieren' : 'Aktivieren';
      toggle.onclick=()=>{
        const updated = (week[weekPlanDay]||[]).map((x,i)=> i===idx ? {...x, active: !(x.active !== false)} : x);
        if(updated.length) week[weekPlanDay]=updated; else delete week[weekPlanDay];
        save(LS.week, week);
        renderWeekPlan();
        renderProviderWeekPreview();
      };

      const share = document.createElement('button');
      share.type='button';
      share.className='ans';
      share.textContent='Teilen';
      share.onclick=()=>{ shareOffer({dish:name, price}); };

      const print = document.createElement('button');
      print.type='button';
      print.className='ans';
      print.textContent='Drucken';
      print.onclick=()=>{
        const profile = normalizeProviderProfile(provider.profile || {});
        const offer = normalizeOffer({
          providerId: providerId(),
          providerName: profile.name || provider.email || 'Anbieter',
          providerStreet: profile.street||'',
          providerZip: profile.zip||'',
          providerCity: profile.city||'',
          providerLogoData: profile.logoData||'',
          dish: name,
          category: cb?.category || 'Vegetarisch',
          price: Number(price||0),
          pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
          hasPickupCode: !!cb?.hasPickupCode,
          dineInPossible: !!cb?.dineInPossible,
          imageUrl: cb?.photoData || ''
        });
        printOffer(offer);
      };

      actions.appendChild(edit);
      actions.appendChild(toggle);
      actions.appendChild(share);
      actions.appendChild(print);
      item.appendChild(actions);
      list.appendChild(item);
    });
  }

  function pickupCodeCount(dish){
    const base = String(dish||'').split('').reduce((sum, ch)=>sum + ch.charCodeAt(0), 0);
    return 2 + (base % 4); // 2..5
  }

  // Build pickup list (single list, no grouping)
  // Single source of truth: Order record (ordersStore)
  function buildPickupList(){
    const todayKey = isoDate(new Date());
    const providerIdVal = providerId();
    
    // Load from shared ordersStore (localStorage)
    const ordersList = loadOrders();
    
    // Filter: providerId + pickupDate + status=PAID (default "Offen")
    const todayOrders = ordersList.filter(o => {
      // Must be for this provider
      if(o.providerId !== providerIdVal) return false;
      
      // Must be PAID with pickupCode
      if(o.status !== 'PAID' || !o.pickupCode) return false;
      
      // Check pickupDate (from order - single source of truth)
      const orderPickupDate = o.pickupDate;
      if(orderPickupDate){
        return orderPickupDate === todayKey;
      }
      
      // Fallback: check offer.day (for legacy orders)
      const offer = offers.find(off => off.id === o.dishId || off.id === o.offerId);
      return offer && offer.day === todayKey;
    });
    
    if(!todayOrders.length) return [];
    
    // Map orders to pickup items (simple list, no grouping)
    return todayOrders.map(order => {
      // Check status (single source of truth: Order record)
      const isPickedUp = order.status === 'PICKED_UP' || order.status === 'COMPLETED' || order.pickupStatus === 'PICKED_UP';
      
      return {
        orderId: order.id,
        code: order.pickupCode || order.code || '',
        dishName: order.dishName || 'Gericht',
        pickupTime: order.pickupWindow || order.etaTime || '',
        status: isPickedUp ? 'PICKED_UP' : 'OPEN',
        order: order
      };
    });
  }

  function renderProviderPickups(){
    const subheader = document.getElementById('provPickupsSubheader');
    const filterEl = document.getElementById('provPickupFilter');
    const empty = document.getElementById('provPickupsEmpty');
    const listEl = document.getElementById('provPickupsList');
    if(!subheader || !filterEl || !empty || !listEl) return;

    // Subheader: "Heute ¬∑ {weekday, date}"
    const today = new Date();
    const weekday = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'][today.getDay()];
    const dateStr = `${today.getDate()}.${String(today.getMonth()+1).padStart(2,'0')}.`;
    subheader.textContent = `Heute ¬∑ ${weekday}, ${dateStr}`;

    // Get all pickups
    const allPickups = buildPickupList();
    
    // Filter pickups
    const filteredPickups = allPickups.filter(p => {
      if(pickupFilter === 'offen') return p.status === 'OPEN';
      if(pickupFilter === 'abgeholt') return p.status === 'PICKED_UP';
      return true;
    });

    // Filter Toggle
    filterEl.innerHTML='';
    [
      {id:'offen', label:'Bezahlt'},
      {id:'abgeholt', label:'Abgeholt'}
    ].forEach(f=>{
      const b=document.createElement('button');
      b.type='button';
      b.className='ans'+(pickupFilter===f.id?' on':'');
      b.textContent=f.label;
      b.onclick=()=>{ pickupFilter=f.id; renderProviderPickups(); };
      filterEl.appendChild(b);
    });

    // Empty States
    if(!allPickups.length){
      empty.style.display='block';
      empty.innerHTML = `
        <div style="font-weight:600; font-size:16px; margin-bottom:8px;">Keine Abholungen</div>
        <div style="font-size:14px; line-height:1.4; color:var(--muted);">Heute gibt es noch keine Abholungen.</div>
      `;
      listEl.style.display='none';
      return;
    }
    
    if(!filteredPickups.length){
      empty.style.display='block';
      if(pickupFilter === 'offen'){
        empty.innerHTML = `
          <div style="font-weight:600; font-size:16px; margin-bottom:8px;">Alles erledigt</div>
          <div style="font-size:14px; line-height:1.4; color:var(--muted);">Alle Abholungen sind abgeschlossen.</div>
        `;
      } else {
        empty.innerHTML = `
          <div style="font-weight:600; font-size:16px; margin-bottom:8px;">Keine abgeholten Bestellungen</div>
          <div style="font-size:14px; line-height:1.4; color:var(--muted);">Noch keine Bestellungen als abgeholt markiert.</div>
        `;
      }
      listEl.style.display='none';
      return;
    }
    
    empty.style.display='none';
    listEl.style.display='block';

    // Sort pickups by code order (1A, 1B, 1C, 2A, 2B, 2C, 10A, 10B...)
    const list = [...filteredPickups];
    list.sort((a, b) => {
      // Extract number and letter from code (e.g., "1A" -> num=1, letter="A", "10B" -> num=10, letter="B")
      const parseCode = (code) => {
        const match = String(code || '').match(/^(\d+)([A-Z])$/);
        if(!match) return {num: 0, letter: ''};
        return {num: parseInt(match[1], 10), letter: match[2]};
      };
      const aCode = parseCode(a.code);
      const bCode = parseCode(b.code);
      
      // Sort by number first (numeric comparison), then by letter
      if(aCode.num !== bCode.num) return aCode.num - bCode.num;
      return aCode.letter.localeCompare(bCode.letter);
    });

    // Render list
    listEl.innerHTML='';
    list.forEach(p=>{
      const isPickedUp = p.status === 'PICKED_UP';
      const row = document.createElement('div');
      row.className = 'pickup-row' + (isPickedUp ? ' picked-up' : '');
      row.style.cssText = 'display:flex; align-items:center; gap:16px; padding:16px; border-bottom:1px solid var(--border); ' + (isPickedUp ? 'opacity:0.5; background:#f8f8f8;' : 'cursor:pointer;');
      row.innerHTML = `
        <div style="font-size:36px; font-weight:900; font-family:monospace; color:var(--brand); min-width:70px; text-align:center; line-height:1;">
          ${esc(p.code)}
        </div>
        <div style="flex:1; min-width:0;">
          <div style="font-weight:600; font-size:16px; line-height:1.3; margin-bottom:6px;">${esc(p.dishName)}</div>
          <div style="font-size:14px; color:var(--muted); margin-bottom:6px;">${esc(p.pickupTime || '')}</div>
          <div style="font-size:13px; color:${isPickedUp ? 'var(--muted)' : '#2e7d32'}; font-weight:500; display:flex; align-items:center; gap:4px;">
            ${isPickedUp ? '‚úÖ Abgeholt' : 'üü¢ Bezahlt'}
          </div>
        </div>
      `;
      if(!isPickedUp){
        row.onclick = () => {
          openPickupConfirmSheet(p.orderId, p.code, p.dishName);
        };
      }
      listEl.appendChild(row);
    });
  }
  
  // Pickup Confirmation Sheet
  let currentPickupConfirmOrderId = null;
  
  function openPickupConfirmSheet(orderId, code, dishName){
    currentPickupConfirmOrderId = orderId;
    const codeEl = document.getElementById('pickupConfirmCode');
    const dishEl = document.getElementById('pickupConfirmDish');
    if(codeEl) codeEl.textContent = code;
    if(dishEl) dishEl.textContent = dishName;
    
    document.getElementById('pickupConfirmBd').classList.add('active');
    document.getElementById('pickupConfirmSheet').classList.add('active');
  }
  
  function closePickupConfirmSheet(){
    document.getElementById('pickupConfirmBd').classList.remove('active');
    document.getElementById('pickupConfirmSheet').classList.remove('active');
    currentPickupConfirmOrderId = null;
  }
  
  // Pickup Confirmation Handlers
  const btnPickupConfirmYes = document.getElementById('btnPickupConfirmYes');
  if(btnPickupConfirmYes){
    btnPickupConfirmYes.onclick = () => {
      if(!currentPickupConfirmOrderId) return;
      
      const order = getOrderById(currentPickupConfirmOrderId);
      if(!order) return;
      
      // Mark as picked up (status = PICKED_UP)
      // Single source of truth: Order record in ordersStore
      updateOrder(currentPickupConfirmOrderId, {
        status: 'PICKED_UP', // Use PICKED_UP as status
        pickupStatus: 'PICKED_UP',
        completedAt: Date.now()
      });
      
      closePickupConfirmSheet();
      renderProviderPickups();
      
      // Show toast
      showToast(`Abholung ${order.pickupCode || order.code || ''} best√§tigt`);
    };
  }
  
  const btnPickupConfirmNo = document.getElementById('btnPickupConfirmNo');
  if(btnPickupConfirmNo){
    btnPickupConfirmNo.onclick = () => {
      closePickupConfirmSheet();
    };
  }

  function showPickupUndo(key){
    pickupUndoKey = key;
    const snack = document.getElementById('pickupUndo');
    if(!snack) return;
    const label = document.getElementById('pickupUndoLabel');
    if(label) label.textContent = 'Abholung markiert';
    const btn = document.getElementById('pickupUndoBtn');
    if(btn){
      btn.onclick=()=>{
        if(pickupUndoKey && pickupDone.has(pickupUndoKey)){
          pickupDone.delete(pickupUndoKey);
          save(LS.pickupDone, Array.from(pickupDone));
          renderProviderPickups();
        }
        hidePickupUndo();
      };
    }
    snack.classList.add('active');
    if(pickupUndoTimer) clearTimeout(pickupUndoTimer);
    pickupUndoTimer = setTimeout(hidePickupUndo, 5000);
  }

  function hidePickupUndo(){
    const snack = document.getElementById('pickupUndo');
    if(!snack) return;
    snack.classList.remove('active');
    pickupUndoKey = null;
  }

  function renderProviderProfile(){
    const p = normalizeProviderProfile(provider.profile || {});
    const addr = buildAddress(p);
    const parsed = parseAddress(p.address || '');
    const city = p.city || parsed.city || '';
    const logoWrap = document.getElementById('provProfileLogo');
    if(logoWrap){
      logoWrap.innerHTML = p.logoData ? `<img src="${p.logoData}" alt="Logo" />` : `<img src="assets/provider-placeholder.png" alt="Logo" />`;
    }
    const nameEl = document.getElementById('provProfileName');
    if(nameEl) nameEl.textContent = p.name || provider.email || 'Anbieter';
    const cityEl = document.getElementById('provProfileCity');
    if(cityEl) cityEl.textContent = city || addr || 'Ort fehlt';
    const mealEl = document.getElementById('provProfileMeal');
    if(mealEl) mealEl.textContent = p.mealWindow || DEFAULT_MEAL_WINDOW;
  }

  function renderBilling(){
    // Kosten-Info-Box (ganz oben)
    const costInfoEl = document.getElementById('billingCostInfo');
    if(costInfoEl){
      costInfoEl.innerHTML = `
        <div style="font-weight:600; font-size:16px; margin-bottom:12px; color:#2e7d32;">Kosten ‚Äì kurz erkl√§rt</div>
        <div style="font-size:14px; line-height:1.6; color:#333; margin-bottom:8px;">
          <div style="margin-bottom:8px;">
            <strong>4,99 ‚Ç¨ zzgl. MwSt.</strong> pro Ver√∂ffentlichung
          </div>
          <div>
            <strong>0,89 ‚Ç¨ zzgl. MwSt.</strong> pro Bestellung f√ºr Online-Zahlung & Abholcode<br>
            <span style="font-size:12px; color:#666; font-style:italic;">
              inkl. aller Bank- & Zahlungsgeb√ºhren ¬∑ gilt pro Bestellung (egal wie viele Gerichte)
            </span>
          </div>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <a href="#/datenschutz" onclick="showLegalPage('datenschutz'); return false;" style="font-size:13px; color:var(--brand); text-decoration:none;">Datenschutz</a>
        </div>
      `;
    }
    
    const amountEl = document.getElementById('billingAmount');
    const lastEl = document.getElementById('billingLast');
    const filtersEl = document.getElementById('billingFilters');
    const monthEl = document.getElementById('billingMonth');
    const listEl = document.getElementById('billingList');
    if(!amountEl || !lastEl || !filtersEl || !monthEl || !listEl) return;

    const demo = [
      {range:'06.01.‚Äì12.01.2026', sales:18, total:148.50, fee:7.20, payout:141.30, status:'N√§chste Auszahlung geplant'},
      {range:'30.12.‚Äì05.01.2026', sales:12, total:96.80, fee:4.80, payout:92.00, status:'Auszahlung erfolgt'}
    ];

    amountEl.textContent = euro(demo[0].payout);
    lastEl.textContent = `Letzte Auszahlung: ${demo[1].range} ¬∑ ${euro(demo[1].payout)}`;

    const filters = [
      {id:'today', label:'Heute'},
      {id:'week', label:'Woche'},
      {id:'month', label:'Monat'},
      {id:'custom', label:'Benutzerdefiniert'}
    ];
    filtersEl.innerHTML = '';
    filters.forEach(f=>{
      const b=document.createElement('button');
      b.type='button';
      b.className='ans'+(billingFilter===f.id?' on':'');
      b.textContent=f.label;
      b.onclick=()=>{ billingFilter = f.id; renderBilling(); };
      filtersEl.appendChild(b);
    });

    monthEl.value = billingMonth;
    monthEl.onchange = ()=>{ billingMonth = monthEl.value; renderBilling(); };

    listEl.innerHTML = demo.map(d=>`
      <div class="cookbook-item">
        <div style="font-weight:900">${esc(d.range)}</div>
        <div class="cookbook-facts">
          Verk√§ufe: ${d.sales} ¬∑ Gesamt: ${euro(d.total)}<br>
          Geb√ºhren: ${euro(d.fee)} ¬∑ Auszahlung: <b>${euro(d.payout)}</b><br>
          Status: ${esc(d.status)}
        </div>
        <div class="cookbook-actions">
          <button class="card-action" type="button" data-icon="print">PDF-Download</button>
        </div>
      </div>
    `).join('');
    listEl.querySelectorAll('button').forEach(btn=>{
      btn.onclick=()=> alert('PDF-Download (Demo).');
    });
    applyStaticIcons();
  }

  const btnProvFaq = document.getElementById('btnProvFaq');
  if(btnProvFaq){
    btnProvFaq.onclick=()=>{
      const box = document.getElementById('provFaqBox');
      if(box) box.style.display = box.style.display==='none' ? 'block' : 'none';
    };
  }

  const btnBilling = document.getElementById('btnBilling');
  if(btnBilling){
    btnBilling.onclick=()=>{
      showProviderBilling();
    };
  }
  const btnBillingBack = document.getElementById('btnBillingBack');
  if(btnBillingBack){
    btnBillingBack.onclick=()=> showProviderProfile();
  }

  const rowProfileOverview = document.getElementById('rowProfileOverview');
  if(rowProfileOverview){
    rowProfileOverview.onclick=()=>{
      const p = normalizeProviderProfile(provider.profile || {});
      const addr = buildAddress(p) || 'Adresse fehlt';
      alert(`Profil-√úbersicht\n${p.name || 'Name fehlt'}\n${addr}\nEssenszeit: ${p.mealWindow || DEFAULT_MEAL_WINDOW}`);
    };
  }

  const btnProvShareOffer = document.getElementById('btnProvShareOffer');
  if(btnProvShareOffer){
    btnProvShareOffer.onclick=()=>{
      const first = offers.find(o=>o.providerId===providerId());
      if(first) shareOffer(first);
      else alert('Noch keine Inserate zum Teilen.');
    };
  }
  const btnProvWeekPdf = document.getElementById('btnProvWeekPdf');
  if(btnProvWeekPdf){
    btnProvWeekPdf.onclick=()=> printWeekCard();
  }
  // Provider Support (nur im Anbieter-Dashboard, support@mittagio.de)
  const btnProvSupport = document.getElementById('btnProvSupport');
  if(btnProvSupport){
    btnProvSupport.onclick=()=>{
      window.location.href = 'mailto:support@mittagio.de';
    };
  }

  // Legal Pages Navigation (statische Seiten)
  function showLegalPage(page){
    const pageMap = {
      'impressum': 'v-legal-impressum',
      'agb-kurz': 'v-legal-agb-kurz',
      'datenschutz': 'v-legal-datenschutz'
    };
    const viewId = pageMap[page];
    if(viewId){
      showView(viewId);
      window.scrollTo({top:0, behavior:'smooth'});
    }
  }
  
  function goBackFromLegalPage(){
    // Zur√ºck zur Profil-Seite (Kunde oder Anbieter)
    if(mode === 'provider'){
      showProviderProfile();
    } else {
      showProfile();
    }
  }

  // Provider Legal Links - √∂ffnen statische Seiten
  const btnLegalImprint = document.getElementById('btnLegalImprint');
  if(btnLegalImprint){
    btnLegalImprint.onclick=()=>{
      showLegalPage('impressum');
    };
  }
  const btnLegalPrivacy = document.getElementById('btnLegalPrivacy');
  if(btnLegalPrivacy){
    btnLegalPrivacy.onclick=()=>{
      showLegalPage('datenschutz');
    };
  }
  const btnLegalTerms = document.getElementById('btnLegalTerms');
  if(btnLegalTerms){
    btnLegalTerms.onclick=()=>{
      showLegalPage('agb-kurz');
    };
  }

  // --- Provider actions (alte Buttons entfernt, jetzt √ºber Create Flow Sheet) ---
  // btnNewListing und btnFromCookbook werden nicht mehr verwendet
  const btnNewListing = document.getElementById('btnNewListing');
  if(btnNewListing) btnNewListing.style.display = 'none';
  const btnFromCookbook = document.getElementById('btnFromCookbook');
  if(btnFromCookbook) btnFromCookbook.style.display = 'none';
  
  // Kochbuch: "+ Gericht hinzuf√ºgen" √∂ffnet IMMER Master-Flow (kein cookbook-Wizard)
  const btnCookbookAdd = document.getElementById('btnCookbookAdd');
  if(btnCookbookAdd) btnCookbookAdd.onclick=()=> startListingFlow({});
  const btnProvSetup = document.getElementById('btnProvSetup');
  if(btnProvSetup){
    btnProvSetup.onclick=()=> startWizard('provider');
  }
  // btnOpenWeekPlan wird nicht mehr verwendet (Week Preview ist jetzt im Dashboard)
  const btnOpenWeekPlan = document.getElementById('btnOpenWeekPlan');
  if(btnOpenWeekPlan) btnOpenWeekPlan.style.display = 'none';
  const btnPickupsFaq = document.getElementById('btnPickupsFaq');
  if(btnPickupsFaq){
    btnPickupsFaq.onclick=()=>{
      showProviderProfile();
      const box = document.getElementById('provFaqBox');
      if(box) box.style.display = 'block';
    };
  }

  const btnEditOffer = document.getElementById('btnEditOffer');
  if(btnEditOffer){
    btnEditOffer.onclick=()=>{
      if(!activeProviderOfferId) return;
      closeProviderSheet();
      startListingFlow({editOfferId: activeProviderOfferId});
    };
  }
  const btnToggleOffer = document.getElementById('btnToggleOffer');
  if(btnToggleOffer){
    btnToggleOffer.onclick=()=>{
      if(!activeProviderOfferId) return;
      const idx = offers.findIndex(x=>x.id===activeProviderOfferId);
      if(idx<0) return;
      offers[idx].active = offers[idx].active === false ? true : false;
      save(LS.offers, offers);
      closeProviderSheet();
      renderProviderHome();
      renderProviderPickups();
      renderDiscover();
    };
  }
  const btnShareOffer = document.getElementById('btnShareOffer');
  if(btnShareOffer){
    btnShareOffer.onclick=()=>{
      if(!activeProviderOfferId) return;
      const o = offers.find(x=>x.id===activeProviderOfferId);
      if(!o) return;
      shareOffer(o);
    };
  }
  const btnPrintOffer = document.getElementById('btnPrintOffer');
  if(btnPrintOffer){
    btnPrintOffer.onclick=()=>{
      if(!activeProviderOfferId) return;
      const o = offers.find(x=>x.id===activeProviderOfferId);
      if(!o) return;
      printOffer(o);
    };
  }

  const btnWeekBack = document.getElementById('btnWeekBack');
  if(btnWeekBack){
    btnWeekBack.onclick=()=> showProviderHome();
  }
  const btnWeekPdf = document.getElementById('btnWeekPdf');
  if(btnWeekPdf){
    btnWeekPdf.onclick=()=>{
    printWeekCard();
  };

  // Provider ID (for demo)
  function providerId(){
    // stable per email
    const e = provider.email || 'provider';
    return 'prov_' + btoa(unescape(encodeURIComponent(e))).slice(0,16);
  }

  // --- Cookbook ---
  function renderCookbook(){
    const box = document.getElementById('cookbookList');
    const tabs = document.getElementById('cookbookTabs');
    const sortBox = document.getElementById('cookbookSorts');
    const search = document.getElementById('cookbookSearch');
    if(!box) return;

    let updated = false;
    cookbook = cookbook.map(entry=>{
      const out = {...entry};
      if(!out.createdAt){ out.createdAt = Date.now(); updated = true; }
      if(out.lastUsed === undefined){ out.lastUsed = null; updated = true; }
      return out;
    });
    if(updated) save(LS.cookbook, cookbook);

    if(search){
      if(search.value !== cookbookQuery) search.value = cookbookQuery || '';
      search.oninput=()=>{ cookbookQuery = search.value; renderCookbook(); };
    }

    if(tabs){
      tabs.innerHTML='';
      [
        {id:'drafts', label:'Entw√ºrfe'},
        {id:'dishes', label:'Gerichte'}
      ].forEach(t=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(cookbookTab===t.id?' on':'');
        b.textContent=t.label;
        b.onclick=()=>{ cookbookTab=t.id; renderCookbook(); };
        tabs.appendChild(b);
      });
    }

    if(sortBox){
      sortBox.innerHTML='';
      [
        {id:'recent', label:'Zuletzt verwendet'},
        {id:'alpha', label:'Alphabetisch'},
        {id:'priceAsc', label:'Preis aufsteigend'},
        {id:'priceDesc', label:'Preis absteigend'}
      ].forEach(f=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(cookbookSort===f.id?' on':'');
        b.textContent=f.label;
        b.onclick=()=>{ cookbookSort=f.id; renderCookbook(); };
        sortBox.appendChild(b);
      });
    }

    const mine = cookbook.filter(x=>x.providerId===providerId());
    const q = String(cookbookQuery||'').trim().toLowerCase();
    const filtered = mine.filter(x => !q || String(x.dish||'').toLowerCase().includes(q));

    if(!filtered.length){
      box.innerHTML = `
        <div style="text-align:center; padding:40px 20px;">
          <div style="font-weight:600; font-size:16px; margin-bottom:8px;">Keine Gerichte</div>
          <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:var(--muted);">
            Erstelle dein erstes Gericht im Kochbuch.
          </div>
          <button class="btn secondary" type="button" id="btnCookbookEmptyAdd" style="width:100%; min-height:44px;">
            Gericht hinzuf√ºgen
          </button>
        </div>
      `;
      const btnCookbookEmptyAdd = document.getElementById('btnCookbookEmptyAdd');
      if(btnCookbookEmptyAdd) btnCookbookEmptyAdd.onclick = () => {
        startListingFlow({});
      };
      return;
    }

    const sortRecent = (a,b)=>(b.lastUsed||b.createdAt) - (a.lastUsed||a.createdAt);
    const sortAlpha = (a,b)=>String(a.dish||'').localeCompare(String(b.dish||''));
    const sortPriceAsc = (a,b)=>(Number(a.price||0) - Number(b.price||0));
    const sortPriceDesc = (a,b)=>(Number(b.price||0) - Number(a.price||0));
    const sortFn = cookbookSort==='alpha' ? sortAlpha : (cookbookSort==='priceAsc' ? sortPriceAsc : (cookbookSort==='priceDesc' ? sortPriceDesc : sortRecent));

    const dishes = filtered.filter(x=>x.lastUsed);
    const drafts = filtered.filter(x=>!x.lastUsed);
    dishes.sort(sortFn);
    drafts.sort(sortFn);

    const list = cookbookTab === 'drafts' ? drafts : dishes;
    const formatDayLabel = (iso)=>{
      if(!iso) return '‚Äî';
      const d = new Date(iso);
      if(Number.isNaN(d.getTime())) return iso;
      const today = isoDate(new Date());
      const tomorrow = isoDate(new Date(Date.now()+86400000));
      if(iso===today) return 'Heute';
      if(iso===tomorrow) return 'Morgen';
      return fmtDay(d);
    };

    const buildItem = (entry, isDraft)=>{
      const item=document.createElement('div');
      item.className='cookbook-item';

      const lastOnline = offers
        .filter(o=>o.providerId===providerId() && o.dish===entry.dish)
        .map(o=>o.day)
        .sort()
        .slice(-1)[0];
      const sales = offers.filter(o=>o.providerId===providerId() && o.dish===entry.dish).length * 3;

      // Optional: Bild anzeigen (falls vorhanden)
      const imageHtml = entry.photoData ? `<img src="${esc(entry.photoData)}" alt="${esc(entry.dish)}" style="width:100%; height:120px; object-fit:cover; border-radius:12px; margin-bottom:8px;" />` : '';
      // Optional: Kategorie-Badge
      const categoryBadge = entry.category ? `<span style="font-size:11px; padding:2px 6px; background:rgba(0,0,0,.06); border-radius:6px; color:var(--muted);">${esc(entry.category)}</span>` : '';
      
      item.innerHTML = `
        ${imageHtml}
        <div style="font-weight:900; font-size:16px; margin-bottom:4px;">${esc(entry.dish||'Gericht')}</div>
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
          ${categoryBadge}
          <span class="hint" style="font-size:13px;">${euro(entry.price||0)}</span>
        </div>
        <div class="cookbook-facts" style="font-size:12px; color:var(--muted);">
          ${isDraft ? 'Entwurf seit:' : 'Letzte Ver√∂ffentlichung:'}
          <b>${esc(formatDayLabel(isDraft ? entry.createdAt : lastOnline))}</b>
        </div>
      `;

      const actions=document.createElement('div');
      actions.className='cookbook-actions';
      actions.style.cssText = 'display:flex; align-items:center; gap:8px; margin-top:12px;';

      // Button: "Inserieren" (√∂ffnet Master-Flow vorbef√ºllt)
      const insertBtn=document.createElement('button');
      insertBtn.type='button';
      insertBtn.className='ans';
      insertBtn.textContent='Inserieren';
      insertBtn.dataset.icon = 'plus';
      insertBtn.onclick=()=>{ startListingFlow({dishId: entry.id, date: createFlowPreselectedDate}); };
      actions.appendChild(insertBtn);

      // Button: "üìÖ In Wochenplan" (√∂ffnet Master-Flow mit weekplan-context)
      const weekPlanBtn=document.createElement('button');
      weekPlanBtn.type='button';
      weekPlanBtn.className='ans';
      weekPlanBtn.textContent='üìÖ In Wochenplan';
      weekPlanBtn.onclick=()=>{ startListingFlow({dishId: entry.id, source: 'weekplan'}); };
      actions.appendChild(weekPlanBtn);

      // Men√º: "‚ãØ" (Einstellungen: bearbeiten/pausieren/archivieren/l√∂schen)
      const menuBtn=document.createElement('button');
      menuBtn.type='button';
      menuBtn.className='btn ghost';
      menuBtn.textContent='‚ãØ';
      menuBtn.style.cssText = 'padding:8px; min-width:36px; font-size:18px;';
      menuBtn.onclick=(e)=>{
        e.stopPropagation();
        // Simple menu (sp√§ter kann ein Sheet verwendet werden)
        const menuActions = [
          {label: 'Bearbeiten', action: () => startWizard('cookbook', {editId: entry.id})},
          {label: 'Pausieren', action: () => {
            // TODO: Implement pause/archive
            alert('Pausieren (TODO)');
          }},
          {label: 'Archivieren', action: () => {
            // TODO: Implement archive
            alert('Archivieren (TODO)');
          }},
          {label: 'L√∂schen', action: () => {
            if(confirm(`"${entry.dish}" wirklich l√∂schen?`)){
              const idx = cookbook.findIndex(c => c.id === entry.id);
              if(idx >= 0){
                cookbook.splice(idx, 1);
                save(LS.cookbook, cookbook);
                renderCookbook();
                showToast('Gericht gel√∂scht');
              }
            }
          }}
        ];
        const choice = prompt(`Aktion f√ºr "${entry.dish}":\n${menuActions.map((a,i) => `${i+1}. ${a.label}`).join('\n')}\n\nNummer eingeben:`);
        const idx = parseInt(choice) - 1;
        if(idx >= 0 && idx < menuActions.length){
          menuActions[idx].action();
        }
      };
      actions.appendChild(menuBtn);
      item.appendChild(actions);
      return item;
    };

    box.innerHTML = '';
    if(!list.length){
      box.innerHTML = `<div class="hint">Keine ${cookbookTab==='drafts' ? 'Entw√ºrfe' : 'Gerichte'} vorhanden.</div>`;
      return;
    }
    list.forEach(entry=> box.appendChild(buildItem(entry, cookbookTab==='drafts')));
    applyStaticIcons();
  }

  function publishCookbookEntry(entryId){
    const entry = cookbook.find(c=>c.id===entryId && c.providerId===providerId());
    if(!entry) return;

    const profile = normalizeProviderProfile(provider.profile || {});
    const offer = normalizeOffer({
      id: cryptoId(),
      providerId: providerId(),
      providerName: profile.name || provider.email || 'Anbieter',
      providerStreet: profile.street||'',
      providerZip: profile.zip||'',
      providerCity: profile.city||'',
      providerLogoData: profile.logoData||'',
      dish: entry.dish||'',
      category: entry.category||'Vegetarisch',
      price: Number(entry.price||0),
      pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
      hasPickupCode: !!entry.hasPickupCode,
      dineInPossible: !!entry.dineInPossible,
      allergens: entry.allergens||[],
      extras: entry.extras||[],
      reuse: entry.reuse||{enabled:false,deposit:0},
      imageUrl: entry.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
      day: isoDate(new Date())
    });

    if(!offer.providerStreet){
      alert('Bitte zuerst Anbieterprofil ausf√ºllen (Adresse).');
      return;
    }

    offers.unshift(offer);
    save(LS.offers, offers);

    const idx = cookbook.findIndex(c=>c.id===entryId);
    if(idx>=0){ cookbook[idx].lastUsed = Date.now(); }
    save(LS.cookbook, cookbook);

    renderCookbook();
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
    renderStart();
    alert('Inserat ver√∂ffentlicht.');
  }

  function publishWeekEntry(dayKey, entry){
    const cb = cookbook.find(c=>c.id===entry.cookbookId);
    if(!cb){
      alert('Gericht nicht gefunden.');
      return;
    }

    const profile = normalizeProviderProfile(provider.profile || {});
    const offer = normalizeOffer({
      id: cryptoId(),
      providerId: providerId(),
      providerName: profile.name || provider.email || 'Anbieter',
      providerStreet: profile.street||'',
      providerZip: profile.zip||'',
      providerCity: profile.city||'',
      providerLogoData: profile.logoData||'',
      dish: cb.dish||entry.dish||'',
      category: cb.category||'Vegetarisch',
      price: Number(cb.price||0),
      pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
      hasPickupCode: !!cb.hasPickupCode,
      dineInPossible: !!cb.dineInPossible,
      allergens: cb.allergens||[],
      extras: cb.extras||[],
      reuse: cb.reuse||{enabled:false,deposit:0},
      imageUrl: cb.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
      day: dayKey
    });

    if(!offer.providerStreet){
      alert('Bitte zuerst Anbieterprofil ausf√ºllen (Adresse).');
      return;
    }

    offers.unshift(offer);
    save(LS.offers, offers);

    const idx = cookbook.findIndex(c=>c.id===entry.cookbookId);
    if(idx>=0){ cookbook[idx].lastUsed = Date.now(); }
    save(LS.cookbook, cookbook);

    renderWeekPlan();
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
    renderStart();
    alert('Inserat ver√∂ffentlicht.');
  }

  // --- Wizard engine (Provider profile / Listing / Cookbook / Week) ---
  let w = { kind:null, step:0, data:{}, ctx:{} };

  const ALLERGENS_14 = [
    {name:'Gluten', short:'GL'},
    {name:'Krebstiere', short:'KR'},
    {name:'Eier', short:'EI'},
    {name:'Fisch', short:'FI'},
    {name:'Erdn√ºsse', short:'EN'},
    {name:'Soja', short:'SO'},
    {name:'Milch', short:'MI'},
    {name:'Schalenfr√ºchte', short:'SF'},
    {name:'Sellerie', short:'SE'},
    {name:'Senf', short:'SN'},
    {name:'Sesam', short:'SS'},
    {name:'Sulfite', short:'SU'},
    {name:'Lupinen', short:'LU'},
    {name:'Weichtiere', short:'WE'}
  ];

  function openWizard(){
    const wbd = document.getElementById('wbd');
    const wizard = document.getElementById('wizard');
    if(wbd) wbd.classList.add('active');
    if(wizard) wizard.classList.add('active');
    // Push state for browser back button
    history.pushState({wizard: true}, '', location.pathname);
  }
  function closeWizard(){
    document.getElementById('wbd').classList.remove('active');
    document.getElementById('wizard').classList.remove('active');
  }

  /**
   * MASTER INSERATSFLOW - Einziger Entry-Point
   * Wird IMMER verwendet f√ºr:
   * - Inserat erstellen
   * - Gericht hinzuf√ºgen (Kochbuch)
   * - Gericht hinzuf√ºgen (Wochenplan)
   * KEINE Sonderflows bauen!
   * 
   * @param {Object} context
   * @param {string} [context.source] - "cookbook" | "new" | undefined
   * @param {string} [context.dishId] - Kochbuch-Eintrag ID (wenn aus Kochbuch)
   * @param {string} [context.date] - Preselected date (ISO format)
   * @param {string} [context.editOfferId] - Offer ID (wenn bearbeiten)
   */
  function startListingFlow(context = {}){
    // Always use listing wizard (Master Flow)
    startWizard('listing', context);
  }

  function startWizard(kind, ctx={}){
    w = { kind, step:0, data:{}, ctx };

    if(kind==='provider'){
      w.data = normalizeProviderProfile(JSON.parse(JSON.stringify(provider.profile||{})));
      buildProviderStep();
    }
    if(kind==='cookbook'){
      // Cookbook editing only (not for creating new dishes)
      // For creating new dishes, use startListingFlow() instead
      if(ctx.editId){
        const existing = cookbook.find(c=>c.id===ctx.editId);
        if(existing){ w.data = JSON.parse(JSON.stringify(existing)); }
      }
      if(!w.data || !w.data.providerId){
        w.data = {
          providerId: providerId(),
          dish:'', category:'Vegetarisch', price:0,
          allergens:[],
          extras:[],
          reuse:{enabled:false, deposit:0},
          photoData:'',
          hasPickupCode:false,
          dineInPossible:false,
          createdAt: Date.now(),
          lastUsed: null
        };
      }
      w.data.providerId = providerId();
      w.data.category = w.data.category || 'Vegetarisch';
      w.data.price = Number(w.data.price||0);
      w.data.allergens = Array.isArray(w.data.allergens) ? w.data.allergens : [];
      w.data.extras = Array.isArray(w.data.extras) ? w.data.extras : [];
      if(!w.data.reuse) w.data.reuse = {enabled:false, deposit:0};
      w.data.photoData = w.data.photoData || '';
      w.data.hasPickupCode = !!w.data.hasPickupCode;
      w.data.dineInPossible = !!w.data.dineInPossible;
      w.data.createdAt = w.data.createdAt || Date.now();
      if(w.data.lastUsed === undefined) w.data.lastUsed = null;
      buildCookbookStep();
    }
    if(kind==='listing'){
      // MASTER INSERATSFLOW - Always the same flow
      const profile = normalizeProviderProfile(provider.profile || {});
      
      // Case 1: Edit existing offer
      if(ctx.editOfferId){
        const existing = offers.find(o=>o.id===ctx.editOfferId);
        if(existing){
          const o = normalizeOffer(existing);
          w.data = {
            providerId: o.providerId || providerId(),
            dish: o.dish||'',
            category: o.category||'Vegetarisch',
            price: Number(o.price||0),
            pickupWindow: o.pickupWindow || profile.mealWindow || DEFAULT_MEAL_WINDOW,
            hasPickupCode: !!o.hasPickupCode,
            dineInPossible: !!o.dineInPossible,
            allergens: Array.isArray(o.allergens) ? [...o.allergens] : [],
            extras: Array.isArray(o.extras) ? JSON.parse(JSON.stringify(o.extras)) : [],
            reuse: o.reuse ? JSON.parse(JSON.stringify(o.reuse)) : {enabled:false, deposit:0},
            photoData: o.imageUrl || '',
            day: o.day,
            active: o.active !== false,
            cookbookId: null
          };
        }
      } 
      // Case 2: From cookbook (context.dishId or ctx.fromCookbookId)
      else if(ctx.dishId || ctx.fromCookbookId){
        const cookbookId = ctx.dishId || ctx.fromCookbookId;
        const x = cookbook.find(c=>c.id===cookbookId);
        if(x){
          // Prefill from cookbook entry
          w.data = {
            providerId: providerId(),
            dish: x.dish || '',
            category: x.category || 'Vegetarisch',
            price: Number(x.price||0),
            pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
            hasPickupCode: !!x.hasPickupCode,
            dineInPossible: !!x.dineInPossible,
            allergens: Array.isArray(x.allergens) ? [...x.allergens] : [],
            extras: Array.isArray(x.extras) ? JSON.parse(JSON.stringify(x.extras)) : [],
            reuse: x.reuse ? JSON.parse(JSON.stringify(x.reuse)) : {enabled:false, deposit:0},
            photoData: x.photoData || '',
            cookbookId: x.id,
            day: ctx.date || createFlowPreselectedDate || isoDate(new Date())
          };
        } else {
          // Fallback: new dish
          w.data = {
            providerId: providerId(),
            dish:'', category:'Vegetarisch', price:0,
            pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
            hasPickupCode:false,
            dineInPossible:false,
            allergens:[],
            extras:[],
            reuse:{enabled:false, deposit:0},
            photoData:'',
            cookbookId:null,
            day: ctx.date || createFlowPreselectedDate || isoDate(new Date())
          };
        }
      } 
      // Case 3: New dish (default)
      else {
        w.data = {
          providerId: providerId(),
          dish:'', category:'Vegetarisch', price:0,
          pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
          hasPickupCode:true, // Default: ON
          dineInPossible:false,
          allergens:[],
          extras:[],
          reuse:{enabled:false, deposit:0},
          photoData:'',
          cookbookId:null,
          day: ctx.date || createFlowPreselectedDate || isoDate(new Date())
        };
      }
      
      // Normalize data
      w.data.providerId = w.data.providerId || providerId();
      w.data.category = w.data.category || 'Vegetarisch';
      w.data.price = Number(w.data.price||0);
      w.data.pickupWindow = w.data.pickupWindow || profile.mealWindow || DEFAULT_MEAL_WINDOW;
      w.data.cookbookId = w.data.cookbookId || null;
      // Date preselect support
      if(ctx.date || createFlowPreselectedDate){
        w.data.day = ctx.date || createFlowPreselectedDate;
      } else if(!w.data.day){
        w.data.day = isoDate(new Date());
      }
      w.data.hasPickupCode = !!w.data.hasPickupCode;
      w.data.dineInPossible = !!w.data.dineInPossible;
      w.data.allergens = Array.isArray(w.data.allergens) ? w.data.allergens : [];
      w.data.extras = Array.isArray(w.data.extras) ? w.data.extras : [];
      if(!w.data.reuse) w.data.reuse = {enabled:false, deposit:0};
      buildListingStep();
    }
    if(kind==='week'){
      // Legacy: schedule cookbook item to a date
      // Should use startListingFlow({dishId, date}) instead
      const x = cookbook.find(c=>c.id===ctx.fromCookbookId);
      if(!x){ alert('Bitte erst ein Gericht im Kochbuch speichern.'); return; }
      w.data = { cookbookId:x.id, date: isoDate(new Date()) };
      buildWeekStep();
    }

    openWizard();
  }

  // Common wizard buttons
  const wBackBtn = document.getElementById('wBack');
  const wNextBtn = document.getElementById('wNext');
  const defaultWizardNext = ()=>{ w.step += 1; rebuildWizard(); };
  function setWizardNextDefault(){ wNextBtn.onclick = defaultWizardNext; }

  wBackBtn.onclick=()=>{
    if(w.step===0){ closeWizard(); return; }
    w.step -= 1;
    rebuildWizard();
  };
  setWizardNextDefault();

  function setWizardHeader(title, stepText){
    document.getElementById('wTitle').textContent = title;
    document.getElementById('wStep').textContent = stepText;
  }
  function setWizardQuestion(q, help=''){ 
    document.getElementById('wQ').textContent = q;
    document.getElementById('wHelp').textContent = help;
  }
  function setWizardContent(node){
    const c = document.getElementById('wContent');
    c.innerHTML='';
    c.appendChild(node);
  }

  function rebuildWizard(){
    if(w.kind==='provider') return buildProviderStep();
    if(w.kind==='cookbook') return buildCookbookStep();
    if(w.kind==='listing') return buildListingStep();
    if(w.kind==='week') return buildWeekStep();
  }

  function saveProviderProfileFromWizard(){
    const parsed = parseAddress(w.data.address || '');
    const street = parsed.street || w.data.street || '';
    const zip = parsed.zip || w.data.zip || '';
    const city = parsed.city || w.data.city || '';
    const address = parsed.address || buildAddress({street, zip, city});

    provider.profile = {
      name: w.data.name||'',
      address,
      street,
      zip,
      city,
      mealWindow: w.data.mealWindow || DEFAULT_MEAL_WINDOW,
      logoData: w.data.logoData||''
    };
    save(LS.provider, provider);
    renderProviderProfile();
    renderProviderHome();
  }

  // --- Provider onboarding (step-by-step, no form) ---
  function buildProviderStep(){
    setWizardNextDefault();
    const total = 5;
    const stepText = `Schritt ${Math.min(w.step+1,total)} von ${total}`;
    setWizardHeader('Anbieter-Profil', stepText);

    if(w.step >= total){
      saveProviderProfileFromWizard();
      closeWizard();
      alert('Profil ist bereit.');
      return;
    }

    if(w.step===0){
      setWizardQuestion('Wie hei√üt dein Betrieb?', 'Du kannst den Namen jederzeit √§ndern.');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field';
      input.placeholder='z.B. Metzgerei M√ºller';
      input.value = w.data.name || '';
      input.oninput=()=>{ w.data.name=input.value; };
      box.appendChild(input);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===1){
      setWizardQuestion('Adresse deines Betriebs?', 'Auto-Vervollst√§ndigung folgt (Demo).');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field';
      input.placeholder='Musterstrasse 12, 73614 Schorndorf';
      input.value = w.data.address || buildAddress(w.data) || '';
      input.oninput=()=>{ w.data.address=input.value; };
      box.appendChild(input);
      const h=document.createElement('div'); h.className='hint'; h.textContent='Tipp: Stra√üe, PLZ, Ort - getrennt mit Komma.';
      box.appendChild(h);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===2){
      setWizardQuestion('Wann k√∂nnen G√§ste dein Essen genie√üen?', 'Standard aus Profil, optional anpassen.');
      if(!w.data.mealWindow) w.data.mealWindow = DEFAULT_MEAL_WINDOW;

      const current = w.data.mealWindow || DEFAULT_MEAL_WINDOW;
      const split = current.includes('‚Äì') ? current.split('‚Äì') : current.split('-');
      const startDefault = split[0] ? split[0].trim() : '11:30';
      const endDefault = split[1] ? split[1].trim() : '14:00';
      if(!w.data.mealStart) w.data.mealStart = startDefault;
      if(!w.data.mealEnd) w.data.mealEnd = endDefault;

      const box=document.createElement('div');
      const summary=document.createElement('div');
      summary.className='panel';
      summary.innerHTML = `<b>${esc(current)}</b><div class="hint">Standard aus Profil</div>`;
      box.appendChild(summary);

      const actions=document.createElement('div');
      actions.className='answers';
      const toggle=document.createElement('button');
      toggle.type='button';
      toggle.className='ans';
      toggle.textContent = w.data.mealCustom ? 'Fertig' : 'Essenszeit √§ndern';
      toggle.onclick=()=>{
        w.data.mealCustom = !w.data.mealCustom;
        rebuildWizard();
      };
      actions.appendChild(toggle);
      box.appendChild(actions);

      if(w.data.mealCustom){
        const updateMealWindow = ()=>{
          if(w.data.mealStart && w.data.mealEnd){
            w.data.mealWindow = `${w.data.mealStart} ‚Äì ${w.data.mealEnd}`;
          }
        };

        const startLabel=document.createElement('div'); startLabel.className='hint'; startLabel.textContent='Start';
        const startRow=document.createElement('div'); startRow.className='answers';
        ['10:30','11:00','11:30','12:00'].forEach(t=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.mealStart===t?' on':'');
          b.textContent=t;
          b.onclick=()=>{ w.data.mealStart=t; updateMealWindow(); rebuildWizard(); };
          startRow.appendChild(b);
        });

        const endLabel=document.createElement('div'); endLabel.className='hint'; endLabel.textContent='Ende';
        const endRow=document.createElement('div'); endRow.className='answers';
        ['13:00','13:30','14:00','14:30'].forEach(t=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.mealEnd===t?' on':'');
          b.textContent=t;
          b.onclick=()=>{ w.data.mealEnd=t; updateMealWindow(); rebuildWizard(); };
          endRow.appendChild(b);
        });

        box.appendChild(document.createElement('div')).style.height='10px';
        box.appendChild(startLabel);
        box.appendChild(startRow);
        box.appendChild(document.createElement('div')).style.height='8px';
        box.appendChild(endLabel);
        box.appendChild(endRow);
      }

      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===3){
      setWizardQuestion('Logo hochladen?', 'Optional, sp√§ter jederzeit austauschbar.');
      const wrap = document.createElement('div');
      const btns=document.createElement('div');
      btns.className='answers';

      const up=document.createElement('button');
      up.className='ans';
      up.type='button';
      up.textContent='Logo ausw√§hlen';
      up.onclick=async()=>{
        const file = await pickImage();
        if(!file) return;
        w.data.logoData = await toDataUrl(file);
        rebuildWizard();
      };

      const skip=document.createElement('button');
      skip.className='ans';
      skip.type='button';
      skip.textContent='Sp√§ter';
      skip.onclick=()=>{ w.data.logoData=''; rebuildWizard(); };

      btns.appendChild(up);
      btns.appendChild(skip);
      wrap.appendChild(btns);

      if(w.data.logoData){
        const prev=document.createElement('div');
        prev.style.marginTop='10px';
        prev.innerHTML = `<div class="hint">Vorschau:</div><div class="plogo" style="width:60px;height:60px;border-radius:14px"><img src="${w.data.logoData}" alt="Logo" /></div>`;
        wrap.appendChild(prev);
      }

      setWizardContent(wrap);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===4){
      setWizardQuestion('Profil ist bereit', 'Kurz pr√ºfen, dann loslegen.');
      const box=document.createElement('div');
      const addr = buildAddress(w.data);
      const logo = w.data.logoData ? `<img src="${w.data.logoData}" alt="Logo" />` : `<img src="assets/provider-placeholder.png" alt="Logo" />`;

      const summary=document.createElement('div');
      summary.className='panel';
      summary.innerHTML = `
        <div style="display:flex;gap:10px;align-items:center;">
          <div class="plogo" style="width:52px;height:52px;border-radius:14px">${logo}</div>
          <div>
            <div style="font-weight:950">${esc(w.data.name || 'Betrieb')}</div>
            <div class="hint">${esc(addr || 'Adresse fehlt')}</div>
          </div>
        </div>
        <div class="row"><span>Essenszeit</span><b>${esc(w.data.mealWindow || DEFAULT_MEAL_WINDOW)}</b></div>
      `;

      const cta=document.createElement('button');
      cta.className='btn';
      cta.type='button';
      cta.textContent='Erstes Gericht erstellen';
      cta.onclick=()=>{
        saveProviderProfileFromWizard();
        closeWizard();
        startWizard('listing');
      };

      box.appendChild(summary);
      box.appendChild(cta);
      setWizardContent(box);
      wNextBtn.textContent='Fertig';
      return;
    }
  }

  // --- Listing wizard (Punkt 6 final) ---
  function updateListingPreviewContent(target){
    target.innerHTML = '';
    const title = document.createElement('div');
    title.className = 'hint';
    title.textContent = 'Live-Vorschau';
    target.appendChild(title);
    
    // Badge und Subline f√ºr Online-Zahlung + Abholcode
    if(w.data.hasPickupCode){
      const badgeContainer = document.createElement('div');
      badgeContainer.style.cssText = 'margin-bottom:12px; padding:12px; background:#f0f7f0; border-radius:12px; border:1px solid #4caf50;';
      const badge = document.createElement('div');
      badge.style.cssText = 'font-weight:600; font-size:14px; color:#2e7d32; margin-bottom:4px; display:flex; align-items:center; gap:6px;';
      badge.innerHTML = 'üü¢ Online bezahlt ¬∑ Abholung mit Abholcode';
      const subline = document.createElement('div');
      subline.style.cssText = 'font-size:12px; color:#666;';
      subline.textContent = 'Zahlung l√§uft direkt √ºber Mittagio';
      badgeContainer.appendChild(badge);
      badgeContainer.appendChild(subline);
      target.appendChild(badgeContainer);
    }
    
    target.appendChild(offerCard(previewOfferFromWizard(), {interactive:false}));
    if(w.data.hasPickupCode){
      const note = document.createElement('div');
      note.className = 'mini';
      note.textContent = 'Beispielcode: A3';
      target.appendChild(note);
    }
  }

  function attachListingPreview(box){
    const wrap = document.createElement('div');
    wrap.id = 'listingPreview';
    wrap.style.marginTop = '12px';
    updateListingPreviewContent(wrap);
    box.appendChild(wrap);
  }

  function refreshListingPreview(){
    const wrap = document.getElementById('listingPreview');
    if(wrap){ updateListingPreviewContent(wrap); }
  }

  // ============================================================
  // MASTER INSERATSFLOW
  // Wird IMMER verwendet f√ºr:
  // - Inserat erstellen
  // - Gericht hinzuf√ºgen (Kochbuch)
  // - Gericht hinzuf√ºgen (Wochenplan)
  // KEINE Sonderflows bauen!
  // ============================================================
  function buildListingStep(){
    setWizardNextDefault();
    const total = 8;
    setWizardHeader('Inserat erstellen', `Schritt ${Math.min(w.step+1,total)} von ${total}`);
    const profile = normalizeProviderProfile(provider.profile || {});
    if(!w.data.pickupWindow){ w.data.pickupWindow = profile.mealWindow || DEFAULT_MEAL_WINDOW; }

    if(w.step===0){
      setWizardQuestion('Kategorie?', 'W√§hle eine Kategorie.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      CATEGORIES.forEach(c=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(w.data.category===c?' on':'');
        b.textContent=c;
        b.onclick=()=>{ w.data.category=c; rebuildWizard(); };
        ans.appendChild(b);
      });
      box.appendChild(ans);
      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===1){
      // MASTER FLOW: Always start with dish name input (no "Aus Kochbuch/Neu" switch)
      // If context.dishId is provided, prefill from cookbook
      setWizardQuestion('Gericht', 'Wie hei√üt das Gericht?');
      const box=document.createElement('div');
      
      // Check if we should prefill from cookbook
      const cookbookEntry = w.data.cookbookId ? cookbook.find(c => c.id === w.data.cookbookId) : null;
      const isFromCookbook = !!cookbookEntry;
      
      const input=document.createElement('input');
      input.className='field';
      input.placeholder='z.B. K√ºrbissuppe';
      input.value=w.data.dish||'';
      input.oninput=()=>{
        w.data.dish = input.value;
        const hit = DISH_SUGGESTIONS.find(d => d.name.toLowerCase() === input.value.trim().toLowerCase());
        if(hit){ w.data.category = hit.category; }
        refreshListingPreview();
      };
      
      const suggest=document.createElement('div');
      suggest.className='answers';
      DISH_SUGGESTIONS.slice(0,6).forEach(s=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans';
        b.textContent=s.name;
        b.onclick=()=>{ w.data.dish = s.name; w.data.category = s.category; rebuildWizard(); };
        suggest.appendChild(b);
      });
      
      box.appendChild(document.createElement('div')).style.height='8px';
      box.appendChild(input);
      box.appendChild(document.createElement('div')).style.height='8px';
      box.appendChild(suggest);
      
      // Show hint if from cookbook
      if(isFromCookbook){
        const hint=document.createElement('div');
        hint.className='hint';
        hint.style.marginTop='12px';
        hint.textContent='‚úì Aus Kochbuch geladen';
        box.appendChild(hint);
      }

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===2){
      setWizardQuestion('Preis pro Portion?', 'Preset w√§hlen oder frei eingeben.');
      const box=document.createElement('div');
      const presets=document.createElement('div'); presets.className='answers';
      [4.5,5.5,6.5,7.5,8.5].forEach(val=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(Number(w.data.price)===val?' on':'');
        b.textContent=`${val.toFixed(2).replace('.',',')} ‚Ç¨`;
        b.onclick=()=>{ w.data.price=val; rebuildWizard(); };
        presets.appendChild(b);
      });
      const input=document.createElement('input');
      input.className='field';
      input.inputMode='decimal';
      input.placeholder='0,00';
      input.value = formatPriceInput(w.data.price);
      input.oninput=()=>{ w.data.price = parsePriceInput(input.value); refreshListingPreview(); };
      box.appendChild(presets);
      box.appendChild(document.createElement('div')).style.height='8px';
      box.appendChild(input);
      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===3){
      setWizardQuestion('Abholzeit', 'Aus Profil √ºbernommen.');
      const box=document.createElement('div');
      const summary=document.createElement('div');
      summary.className='panel';
      summary.innerHTML = `<b>${esc(w.data.pickupWindow || DEFAULT_MEAL_WINDOW)}</b><div class="hint">Aus Profil √ºbernommen</div>`;
      const hint=document.createElement('div');
      hint.className='hint';
      hint.textContent='√Ñnderung der Essenszeit ist im Profil m√∂glich.';
      box.appendChild(summary);
      box.appendChild(hint);
      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===4){
      setWizardQuestion('Extras & Mehrweg', 'Optional hinzuf√ºgen.');
      const box=document.createElement('div');
      if(!Array.isArray(w.data.extras)) w.data.extras=[];
      if(!w.data.reuse) w.data.reuse = {enabled:false, deposit:0};

      const extrasTitle=document.createElement('div');
      extrasTitle.className='hint';
      extrasTitle.textContent='Extras';
      const extrasAns=document.createElement('div'); extrasAns.className='answers';
      ['Beilagensalat','Extrasosse','Sonstiges'].forEach(name=>{
        const active = w.data.extras.some(e=>e.name===name);
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(active?' on':'');
        b.textContent=name;
        b.onclick=()=>{
          const idx = w.data.extras.findIndex(e=>e.name===name);
          if(idx>=0) w.data.extras.splice(idx,1);
          else w.data.extras.push({name, price:0});
          rebuildWizard();
        };
        extrasAns.appendChild(b);
      });
      box.appendChild(extrasTitle);
      box.appendChild(extrasAns);

      if(w.data.extras.length){
        w.data.extras.forEach(extra=>{
          const label=document.createElement('div');
          label.className='hint';
          label.textContent=extra.name;
          const input=document.createElement('input');
          input.className='field';
          input.inputMode='decimal';
          input.placeholder='Preis in EUR (z.B. 2,00)';
          input.value = formatPriceInput(extra.price);
          input.oninput=()=>{ extra.price = parsePriceInput(input.value); refreshListingPreview(); };
          box.appendChild(document.createElement('div')).style.height='8px';
          box.appendChild(label);
          box.appendChild(input);
        });
      }

      const reuseTitle=document.createElement('div');
      reuseTitle.className='hint';
      reuseTitle.textContent='Mehrweg / Pfand';
      const reuseAns=document.createElement('div'); reuseAns.className='answers';
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(w.data.reuse.enabled?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!w.data.reuse.enabled?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.reuse.enabled=true; if(!w.data.reuse.deposit) w.data.reuse.deposit=2; rebuildWizard(); };
      no.onclick=()=>{ w.data.reuse.enabled=false; w.data.reuse.deposit=0; w.data.reuseCustom=false; rebuildWizard(); };
      reuseAns.appendChild(yes); reuseAns.appendChild(no);
      box.appendChild(document.createElement('div')).style.height='8px';
      box.appendChild(reuseTitle);
      box.appendChild(reuseAns);

      if(w.data.reuse.enabled){
        const presets=document.createElement('div'); presets.className='answers';
        [2,3,5].forEach(val=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.reuse.deposit===val && !w.data.reuseCustom?' on':'');
          b.textContent=`${val} ‚Ç¨`;
          b.onclick=()=>{ w.data.reuse.deposit=val; w.data.reuseCustom=false; rebuildWizard(); };
          presets.appendChild(b);
        });
        const other=document.createElement('button');
        other.type='button';
        other.className='ans'+(w.data.reuseCustom?' on':'');
        other.textContent='Anderer Betrag';
        other.onclick=()=>{ w.data.reuseCustom=true; rebuildWizard(); };
        presets.appendChild(other);
        box.appendChild(document.createElement('div')).style.height='8px';
        box.appendChild(presets);

        if(w.data.reuseCustom){
          const input=document.createElement('input');
          input.className='field';
          input.inputMode='decimal';
          input.placeholder='Betrag in EUR';
          input.value = formatPriceInput(w.data.reuse.deposit);
          input.oninput=()=>{ w.data.reuse.deposit = parsePriceInput(input.value); refreshListingPreview(); };
          box.appendChild(document.createElement('div')).style.height='8px';
          box.appendChild(input);
        }
      }

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===5){
      setWizardQuestion('Allergene?', 'Optional ausw√§hlen.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      const has = w.data.hasAllergens || (Array.isArray(w.data.allergens) && w.data.allergens.length);
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(has?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!has?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.hasAllergens=true; if(!Array.isArray(w.data.allergens)) w.data.allergens=[]; rebuildWizard(); };
      no.onclick=()=>{ w.data.hasAllergens=false; w.data.allergens=[]; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);

      if(has){
        const list=document.createElement('div'); list.className='answers';
        ALLERGENS_14.forEach(a=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.allergens.includes(a.short)?' on':'');
          b.textContent=`${a.short} ${a.name}`;
          b.onclick=()=>{
            const i=w.data.allergens.indexOf(a.short);
            if(i>=0) w.data.allergens.splice(i,1); else w.data.allergens.push(a.short);
            rebuildWizard();
          };
          list.appendChild(b);
        });
        box.appendChild(document.createElement('div')).style.height='8px';
        box.appendChild(list);
      }

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===6){
      setWizardQuestion('Foto', 'Pflicht: Foto mit automatischem Filter & Zuschnitt.');
      const box=document.createElement('div');
      
      if(!w.data.photoData){
        const ans=document.createElement('div'); ans.className='answers';
        const cam=document.createElement('button'); cam.type='button'; cam.className='ans'; cam.textContent='Kamera';
        cam.onclick=async()=>{ 
          const f=await pickImage({capture:true}); 
          if(!f) return; 
          const dataUrl = await toDataUrl(f);
          await openPhotoEditor(dataUrl);
        };
        const gal=document.createElement('button'); gal.type='button'; gal.className='ans'; gal.textContent='Galerie';
        gal.onclick=async()=>{ 
          const f=await pickImage(); 
          if(!f) return; 
          const dataUrl = await toDataUrl(f);
          await openPhotoEditor(dataUrl);
        };
        ans.appendChild(cam); ans.appendChild(gal);
        box.appendChild(ans);
      } else {
        // Foto bereits vorhanden - Editor √∂ffnen
        const preview=document.createElement('div');
        preview.style.marginTop='10px';
        preview.innerHTML = `
          <div class="hint">Aktuelles Foto:</div>
          <div style="border-radius:16px;overflow:hidden;border:1px solid #eee;margin-top:8px">
            <img src="${w.data.photoData}" alt="" style="width:100%;height:200px;object-fit:cover;display:block">
          </div>
        `;
        box.appendChild(preview);
        
        const editBtn=document.createElement('button');
        editBtn.className='btn secondary';
        editBtn.type='button';
        editBtn.textContent='Foto bearbeiten';
        editBtn.style.marginTop='12px';
        editBtn.onclick=async()=> await openPhotoEditor(w.data.photoData);
        box.appendChild(editBtn);
        
        const removeBtn=document.createElement('button');
        removeBtn.className='btn ghost';
        removeBtn.type='button';
        removeBtn.textContent='Foto entfernen';
        removeBtn.style.marginTop='8px';
        removeBtn.onclick=()=>{ w.data.photoData=''; rebuildWizard(); };
        box.appendChild(removeBtn);
      }
      
      // Live-Vorschau "So erscheint es in der App"
      const livePreview=document.createElement('div');
      livePreview.style.marginTop='20px';
      livePreview.style.padding='16px';
      livePreview.style.background='#f8f7f3';
      livePreview.style.borderRadius='16px';
      livePreview.innerHTML = `
        <div class="hint" style="margin-bottom:8px;font-weight:700;">So erscheint es in der App:</div>
        <div class="discover-hero-card" style="margin:0;cursor:default;">
          <div class="discover-hero-image">
            <img src="${w.data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70'}" alt="" />
          </div>
          <div class="discover-hero-content">
            <div class="discover-hero-title">${esc(w.data.dish||'Gericht')}</div>
            <div class="discover-hero-price">${euro(w.data.price||0)}</div>
          </div>
        </div>
      `;
      box.appendChild(livePreview);

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===7){
      setWizardQuestion('Abschluss', 'Ver√∂ffentlichen oder speichern.');
      const box=document.createElement('div');
      attachListingPreview(box);

      const options=document.createElement('div');
      options.style.marginTop='10px';
      const codeLabel=document.createElement('div');
      codeLabel.className='hint';
      codeLabel.textContent='Abholcode & Online-Zahlung';
      const codeRow=document.createElement('div'); codeRow.className='answers';
      const codeYes=document.createElement('button'); codeYes.type='button'; codeYes.className='ans'+(w.data.hasPickupCode?' on':''); codeYes.textContent='Ja';
      const codeNo=document.createElement('button'); codeNo.type='button'; codeNo.className='ans'+(!w.data.hasPickupCode?' on':''); codeNo.textContent='Nein';
      codeYes.onclick=()=>{ w.data.hasPickupCode=true; rebuildWizard(); };
      codeNo.onclick=()=>{ w.data.hasPickupCode=false; rebuildWizard(); };
      codeRow.appendChild(codeYes); codeRow.appendChild(codeNo);
      
      // Optionaler Hinweis bei deaktiviertem Abholcode (nicht blockierend)
      if(!w.data.hasPickupCode){
        const hintBox = document.createElement('div');
        hintBox.style.cssText = 'margin-top:12px; padding:12px; background:#f8f8f8; border-radius:12px; border:1px solid #e0e0e0;';
        hintBox.innerHTML = `
          <div style="font-size:13px; line-height:1.5; color:#666; margin-bottom:8px;">
            Tipp: Mit Abholcode zahlen Kunden online und du hast weniger Aufwand.
          </div>
          <button class="btn secondary" type="button" style="width:100%; min-height:44px; font-size:14px;" onclick="w.data.hasPickupCode=true; rebuildWizard();">
            Abholcode aktivieren
          </button>
        `;
        options.appendChild(hintBox);
      }

      const dineLabel=document.createElement('div');
      dineLabel.className='hint';
      dineLabel.textContent='Vor Ort essen m√∂glich';
      const dineRow=document.createElement('div'); dineRow.className='answers';
      const dineYes=document.createElement('button'); dineYes.type='button'; dineYes.className='ans'+(w.data.dineInPossible?' on':''); dineYes.textContent='Ja';
      const dineNo=document.createElement('button'); dineNo.type='button'; dineNo.className='ans'+(!w.data.dineInPossible?' on':''); dineNo.textContent='Nein';
      dineYes.onclick=()=>{ w.data.dineInPossible=true; rebuildWizard(); };
      dineNo.onclick=()=>{ w.data.dineInPossible=false; rebuildWizard(); };
      dineRow.appendChild(dineYes); dineRow.appendChild(dineNo);

      options.appendChild(codeLabel);
      options.appendChild(codeRow);
      options.appendChild(document.createElement('div')).style.height='6px';
      options.appendChild(dineLabel);
      options.appendChild(dineRow);
      box.appendChild(options);

      const actions=document.createElement('div');
      actions.style.marginTop='10px';

      // Kosten-Info-Bl√∂cke vor dem Button
      const costInfo = document.createElement('div');
      costInfo.style.cssText = 'margin-top:16px; margin-bottom:16px;';
      
      // Block 1: Ver√∂ffentlichung
      const block1 = document.createElement('div');
      block1.style.cssText = 'padding:12px; background:#f8f8f8; border-radius:12px; margin-bottom:12px;';
      block1.innerHTML = `
        <div style="font-weight:600; font-size:14px; margin-bottom:4px;">Ver√∂ffentlichung</div>
        <div style="font-size:16px; font-weight:700; color:var(--brand);">4,99 ‚Ç¨ + MwSt. pro Ver√∂ffentlichung</div>
      `;
      
      // Block 2: Online-Zahlung inkl. Abholcode
      if(w.data.hasPickupCode){
        const block2 = document.createElement('div');
        block2.style.cssText = 'padding:12px; background:#f0f7f0; border-radius:12px; border:1px solid #4caf50;';
        block2.innerHTML = `
          <div style="font-weight:600; font-size:14px; margin-bottom:8px; color:#2e7d32;">Online-Zahlung inkl. Abholcode</div>
          <ul style="margin:0; padding-left:20px; font-size:13px; line-height:1.6; color:#333;">
            <li>Kunde bezahlt online</li>
            <li>Geld ist sicher</li>
            <li>Keine Kasse ¬∑ kein Bargeld</li>
          </ul>
          <div style="margin-top:8px; font-size:11px; color:#666; font-style:italic;">
            F√ºr jede Online-Bestellung f√§llt eine Abwicklungsgeb√ºhr an (inkl. aller Zahlungsgeb√ºhren).
          </div>
        `;
        costInfo.appendChild(block2);
      }
      
      costInfo.appendChild(block1);
      box.appendChild(costInfo);

      const btnPub=document.createElement('button');
      btnPub.className='btn';
      btnPub.type='button';
      btnPub.textContent = 'Jetzt ver√∂ffentlichen';
      btnPub.style.cssText = 'width:100%; min-height:56px; font-size:16px; font-weight:600; margin-top:8px;';
      btnPub.onclick=()=>{
        const o = previewOfferFromWizard();
        closeWizard();
        publishOffer(o);
        // publishOffer navigates back to Dashboard and shows toast
      };

      const btnSave=document.createElement('button');
      btnSave.className='btn secondary';
      btnSave.type='button';
      btnSave.textContent='Im Kochbuch speichern';
      btnSave.onclick=()=>{
        saveToCookbookFromWizard();
        closeWizard();
        showProviderCookbook();
      };

      const btnWeek=document.createElement('button');
      btnWeek.className='btn ghost';
      btnWeek.type='button';
      btnWeek.textContent='Zum Wochenplan hinzuf√ºgen';
      btnWeek.onclick=()=>{
        saveToCookbookFromWizard(true);
        const cb = cookbook.filter(x=>x.providerId===providerId()).slice(-1)[0];
        // Week plan: Use Master-Flow instead
        if(cb) startListingFlow({dishId: cb.id});
      };

      actions.appendChild(btnPub);
      actions.appendChild(btnSave);
      actions.appendChild(btnWeek);
      box.appendChild(actions);

      setWizardContent(box);
      wNextBtn.textContent='Schlie√üen';
      wNextBtn.onclick=()=>{ closeWizard(); showProviderHome(); };
      return;
    }
  }

  function previewOfferFromWizard(){
    const p = normalizeProviderProfile(provider.profile||{});
    const pickupWindow = w.data.pickupWindow || p.mealWindow || DEFAULT_MEAL_WINDOW;
    return {
      id: 'preview',
      providerId: providerId(),
      providerName: p.name || provider.email || 'Anbieter',
      providerStreet: p.street||'',
      providerZip: p.zip||'',
      providerCity: p.city||'',
      providerLogoData: p.logoData||'',
      dish: w.data.dish||'Gericht',
      category: w.data.category||'Vegetarisch',
      price: Number(w.data.price||0),
      pickupWindow,
      imageUrl: w.data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
      hasPickupCode: !!w.data.hasPickupCode,
      dineInPossible: !!w.data.dineInPossible,
      allergens: w.data.allergens||[],
      extras: w.data.extras||[],
      reuse: w.data.reuse||{enabled:false,deposit:0},
      day: w.data.day || isoDate(new Date()),
      active: w.data.active !== false
    };
  }

  function publishOffer(o){
    const existingId = w.ctx && w.ctx.editOfferId ? w.ctx.editOfferId : null;
    const id = existingId || cryptoId();
    const out = {...o, id, day: o.day || w.data.day || isoDate(new Date()), active: o.active !== false};
    // ensure provider address exists
    if(!out.providerStreet){
      alert('Bitte zuerst Anbieterprofil ausf√ºllen (Adresse).');
      return;
    }
    if(existingId){
      const idx = offers.findIndex(x=>x.id===existingId);
      if(idx>=0){
        const prev = offers[idx];
        offers[idx] = {...prev, ...out, id: prev.id, day: out.day, active: out.active};
      } else {
        offers.unshift(out);
      }
    } else {
      offers.unshift(out);
    }
    save(LS.offers, offers);
    
    // Reset createFlowPreselectedDate
    createFlowPreselectedDate = null;
    // restore default next button handler
    setWizardNextDefault();
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
    renderStart();
  }

  function saveToCookbookFromWizard(keepOpen=false){
    const now = Date.now();
    const base = {
      id: cryptoId(),
      providerId: providerId(),
      dish: w.data.dish||'',
      category: w.data.category||'Vegetarisch',
      price: Number(w.data.price||0),
      allergens: w.data.allergens||[],
      extras: w.data.extras||[],
      reuse: w.data.reuse||{enabled:false,deposit:0},
      photoData: w.data.photoData||'',
      hasPickupCode: !!w.data.hasPickupCode,
      dineInPossible: !!w.data.dineInPossible,
      createdAt: now,
      lastUsed: null
    };
    if(w.ctx && w.ctx.editId){
      const idx = cookbook.findIndex(c=>c.id===w.ctx.editId);
      if(idx>=0){
        const prev = cookbook[idx];
        cookbook[idx] = {
          ...prev,
          ...base,
          id: prev.id,
          createdAt: prev.createdAt || now,
          lastUsed: prev.lastUsed ?? null
        };
      } else {
        cookbook.push(base);
      }
    } else {
      cookbook.push(base);
    }
    save(LS.cookbook, cookbook);
    if(!keepOpen){ renderCookbook(); }
  }

  // Cookbook wizard (add recipe)
  function buildCookbookStep(){
    setWizardNextDefault();
    // reuse listing steps subset: category, photo, name, allergens, extras, reuse, price, preview/save
    const total = 8;
    setWizardHeader('Kochbuch', `${Math.min(w.step+1,total)}/${total}`);

    if(w.step===0){
      setWizardQuestion('Kategorie?', 'Tippe eine Kategorie.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      ['Vegan','Vegetarisch','Fleisch','Salat'].forEach(c=>{
        const b=document.createElement('button'); b.type='button'; b.className='ans'+(w.data.category===c?' on':''); b.textContent=c;
        b.onclick=()=>{ w.data.category=c; rebuildWizard(); };
        ans.appendChild(b);
      });
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===1){
      setWizardQuestion('Foto speichern?', 'Optional (f√ºr schnelleres Wiederverwenden).');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      const b1=document.createElement('button'); b1.type='button'; b1.className='ans'; b1.textContent='Foto ausw√§hlen';
      b1.onclick=async()=>{ const f=await pickImage(); if(!f) return; w.data.photoData = await toDataUrl(f); rebuildWizard(); };
      const b2=document.createElement('button'); b2.type='button'; b2.className='ans'; b2.textContent='Ohne';
      b2.onclick=()=>{ w.data.photoData=''; rebuildWizard(); };
      ans.appendChild(b1); ans.appendChild(b2);
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===2){
      setWizardQuestion('Gerichtname?', 'Wie im Kochbuch.');
      const box=document.createElement('div');
      const input=document.createElement('input'); input.className='field'; input.placeholder='z.B. Lasagne'; input.value=w.data.dish||'';
      input.oninput=()=>{ w.data.dish=input.value; };
      box.appendChild(input);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===3){
      setWizardQuestion('Allergene?', 'Optional, antippen.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      if(!Array.isArray(w.data.allergens)) w.data.allergens=[];
      ALLERGENS_14.forEach(a=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(w.data.allergens.includes(a.short)?' on':'');
        b.textContent=`${a.short} ${a.name}`;
        b.onclick=()=>{
          const i=w.data.allergens.indexOf(a.short);
          if(i>=0) w.data.allergens.splice(i,1); else w.data.allergens.push(a.short);
          rebuildWizard();
        };
        ans.appendChild(b);
      });
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===4){
      // Extras
      setWizardQuestion('Extras?', 'Optional.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(w.data.extras?.length?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!w.data.extras?.length?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.extras = w.data.extras?.length ? w.data.extras : [{name:'Beilagensalat', price:2.0}]; rebuildWizard(); };
      no.onclick=()=>{ w.data.extras=[]; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===5){
      // reuse
      setWizardQuestion('Mehrweg / Pfand?', 'Optional.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      if(!w.data.reuse) w.data.reuse={enabled:false,deposit:0};
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(w.data.reuse.enabled?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!w.data.reuse.enabled?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.reuse.enabled=true; if(!w.data.reuse.deposit) w.data.reuse.deposit=5; rebuildWizard(); };
      no.onclick=()=>{ w.data.reuse.enabled=false; w.data.reuse.deposit=0; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===6){
      setWizardQuestion('Standardpreis?', 'Nur Zahl - Komma nicht n√∂tig.');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field'; input.inputMode='numeric'; input.placeholder='z.B. 799';
      input.value = w.data.price ? String(Math.round(w.data.price*100)) : '';
      input.oninput=()=>{ w.data.price = smartNumberToEuro(input.value); };
      box.appendChild(input);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===7){
      setWizardQuestion('Speichern?', 'Damit du sp√§ter mit 2 Taps inserierst.');
      const box=document.createElement('div');
      const prev = {
        id:'preview',
        providerId:providerId(),
        providerName: provider.profile.name || provider.email || 'Anbieter',
        providerStreet:'',providerZip:'',providerCity:'',providerLogoData: provider.profile.logoData||'',
        dish:w.data.dish||'Gericht',
        category:w.data.category||'Vegetarisch',
        price:Number(w.data.price||0),
        pickupWindow:'',
        imageUrl: w.data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
        hasPickupCode:false,
        allergens:w.data.allergens||[],
        extras:w.data.extras||[],
        reuse:w.data.reuse||{enabled:false,deposit:0},
        day: isoDate(new Date())
      };
      box.appendChild(offerCard(prev, {interactive:false}));
      const btn=document.createElement('button');
      btn.className='btn';
      btn.type='button';
      btn.textContent = w.ctx && w.ctx.editId ? '√Ñnderungen speichern' : 'Im Kochbuch speichern';
      btn.onclick=()=>{
        saveToCookbookFromWizard();
        closeWizard();
        renderCookbook();
        alert('Gespeichert.');
      };
      box.appendChild(btn);
      setWizardContent(box);
      wNextBtn.textContent='Fertig';
      wNextBtn.onclick=()=>{ closeWizard(); showProviderCookbook(); };
      return;
    }
  }

  // Weekplan wizard (simple date choose)
  function buildWeekStep(){
    setWizardNextDefault();
    setWizardHeader('Wochenplan', '1/1');
    setWizardQuestion('F√ºr welchen Tag?', 'W√§hle einen Tag und f√ºge das Gericht hinzu.');

    const box=document.createElement('div');
    const ans=document.createElement('div'); ans.className='answers';

    for(let i=0;i<5;i++){
      const d=new Date(); d.setDate(d.getDate()+i);
      const key=isoDate(d);
      const b=document.createElement('button');
      b.type='button';
      b.className='ans'+(w.data.date===key?' on':'');
      b.textContent = i===0?'Heute':(i===1?'Morgen':fmtDay(d));
      b.onclick=()=>{ w.data.date=key; rebuildWizard(); };
      ans.appendChild(b);
    }
    box.appendChild(ans);

    const btn=document.createElement('button');
    btn.className='btn';
    btn.type='button';
    btn.textContent='Zum Wochenplan hinzuf√ºgen';
    btn.onclick=()=>{
      const cb = cookbook.find(c=>c.id===w.data.cookbookId);
      if(!cb){ alert('Gericht nicht gefunden'); return; }
      const entry = { providerId:providerId(), dish:cb.dish, cookbookId:cb.id, active:true };
      if(!week[w.data.date]) week[w.data.date]=[];
      week[w.data.date].push(entry);
      save(LS.week, week);
      
      // Automatisch als Angebot ver√∂ffentlichen, damit Kunden es sehen
      publishWeekEntry(w.data.date, entry);
      
      closeWizard();
      renderProviderHome();
    };

    box.appendChild(document.createElement('div')).style.height='10px';
    box.appendChild(btn);

    setWizardContent(box);
    wNextBtn.textContent='Fertig';
    wNextBtn.onclick=()=>{ closeWizard(); showProviderHome(); };
  }

  // --- Input helpers (thumb-friendly) ---
  function formatPriceInput(value){
    const num = Number(value||0);
    return num.toFixed(2).replace('.',',');
  }
  function parsePriceInput(raw){
    const cleaned = String(raw||'').trim().replace(',', '.').replace(/[^0-9.]/g,'');
    const num = parseFloat(cleaned);
    if(Number.isNaN(num)) return 0;
    return Math.round(num*100)/100;
  }
  function smartNumberToEuro(raw){
    const digits = String(raw||'').replace(/\D/g,'');
    if(!digits) return 0;
    const cents = parseInt(digits,10);
    return Math.round((cents/100)*100)/100;
  }
  function smartNumber(raw){
    const digits = String(raw||'').replace(/\D/g,'');
    if(!digits) return 0;
    return parseInt(digits,10);
  }

  // Image picker
  function pickImage(opts={}){
    return new Promise(resolve=>{
      const input=document.createElement('input');
      input.type='file';
      input.accept='image/*';
      if(opts.capture) input.capture='environment';
      input.onchange=()=> resolve(input.files && input.files[0] ? input.files[0] : null);
      input.click();
    });
  }
  function toDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload=()=>resolve(r.result);
      r.onerror=reject;
      r.readAsDataURL(file);
    });
  }
  
  // Fotoeditor mit Filter & Zuschnitt
  async function openPhotoEditor(imageDataUrl){
    return new Promise((resolve)=>{
      const editor = document.createElement('div');
      editor.className='backdrop active';
      editor.style.zIndex='50';
      
      const editorContent = document.createElement('div');
      editorContent.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:24px;padding:24px;max-width:90vw;max-height:90vh;overflow:auto;z-index:51;box-shadow:0 8px 32px rgba(0,0,0,.2);';
      
      const img = new Image();
      img.src = imageDataUrl;
      img.onload = ()=>{
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const size = 400;
        canvas.width = size;
        canvas.height = size;
        
        // Quadratischer Zuschnitt (zentriert)
        const sourceSize = Math.min(img.width, img.height);
        const sourceX = (img.width - sourceSize) / 2;
        const sourceY = (img.height - sourceSize) / 2;
        
        // Filter: Helligkeit + Kontrast
        ctx.filter = 'brightness(1.1) contrast(1.15) saturate(1.1)';
        ctx.drawImage(img, sourceX, sourceY, sourceSize, sourceSize, 0, 0, size, size);
        
        const processedDataUrl = canvas.toDataURL('image/jpeg', 0.85);
        
        const acceptBtn = document.createElement('button');
        acceptBtn.className='btn';
        acceptBtn.textContent='√úbernehmen';
        acceptBtn.onclick=()=>{
          w.data.photoData = processedDataUrl;
          editor.remove();
          rebuildWizard();
          resolve(processedDataUrl);
        };
        
        const cancelBtn = document.createElement('button');
        cancelBtn.className='btn secondary';
        cancelBtn.textContent='Abbrechen';
        cancelBtn.style.marginLeft='8px';
        cancelBtn.onclick=()=>{
          editor.remove();
          resolve(null);
        };
        
        editorContent.innerHTML = `
          <h3 style="margin:0 0 16px;font-size:18px;font-weight:900;">Foto bearbeiten</h3>
          <div style="border-radius:16px;overflow:hidden;border:1px solid #eee;margin-bottom:16px;background:#f5f5f5">
            <img src="${processedDataUrl}" alt="" style="width:100%;max-width:400px;display:block" />
          </div>
          <div class="hint" style="margin-bottom:16px;">‚úì Automatisch optimiert: Helligkeit + Kontrast<br>‚úì Quadratischer Zuschnitt (wie in der App)</div>
        `;
        
        const btnRow = document.createElement('div');
        btnRow.style.display='flex';
        btnRow.style.gap='8px';
        btnRow.appendChild(acceptBtn);
        btnRow.appendChild(cancelBtn);
        editorContent.appendChild(btnRow);
        
        editor.onclick=(e)=>{
          if(e.target === editor){
            editor.remove();
            resolve(null);
          }
        };
        
        editor.appendChild(editorContent);
        document.body.appendChild(editor);
      };
    });
  }

  // --- Pickup Code Screen Event Handlers ---
  const btnPickupCodeBack = document.getElementById('btnPickupCodeBack');
  if(btnPickupCodeBack){
    btnPickupCodeBack.onclick = () => {
      showOrders(); // Zur√ºck zur Mittagsbox (nicht Warenkorb)
    };
  }
  
  const btnCopyCode = document.getElementById('btnCopyCode');
  if(btnCopyCode){
    btnCopyCode.onclick = async () => {
      if(!currentPickupOrderId) return;
      const order = getOrderById(currentPickupOrderId);
      if(!order) return;
      // Code nur kopieren wenn PAID
      if(order.status !== 'PAID'){
        alert('Abholcode wird nach erfolgreicher Zahlung generiert.');
        return;
      }
      const code = order.pickupCode || order.code || '';
      if(!code) return;
      
      // Clipboard API nutzen
      try{
        if(navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(code);
          btnCopyCode.innerHTML = '<i data-lucide="check"></i> Kopiert!';
          setTimeout(()=>{
            btnCopyCode.innerHTML = '<i data-lucide="copy"></i> Code kopieren';
            if(typeof lucide !== 'undefined') lucide.createIcons();
          }, 2000);
          if(typeof lucide !== 'undefined') lucide.createIcons();
          return;
        }
      } catch(e){
        // Fallback
      }
      
      // Fallback: select + copy
      const textarea = document.createElement('textarea');
      textarea.value = code;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      try{
        document.execCommand('copy');
        btnCopyCode.innerHTML = '<i data-lucide="check"></i> Kopiert!';
        setTimeout(()=>{
          btnCopyCode.innerHTML = '<i data-lucide="copy"></i> Code kopieren';
          if(typeof lucide !== 'undefined') lucide.createIcons();
        }, 2000);
        if(typeof lucide !== 'undefined') lucide.createIcons();
      } catch(e){
        // Fehler
      }
      document.body.removeChild(textarea);
    };
  }
  
  // --- Fullscreen Code Modal Functions ---
  let wakeLock = null;
  
  /**
   * Open fullscreen code modal
   * @param {string} code - Pickup code (without spaces)
   */
  function openFullscreenCode(code){
    if(!code) return;
    
    const modal = document.getElementById('fullscreenCode');
    const valueEl = document.getElementById('fullscreenCodeValue');
    const backdrop = document.getElementById('fullscreenCodeBd');
    
    if(!modal || !valueEl) return;
    
    // Code mit Zwischenr√§umen formatieren: "A  B  1  2  C"
    const formattedCode = code.split('').join('  ');
    valueEl.textContent = formattedCode;
    
    // Modal anzeigen
    modal.classList.add('active');
    if(backdrop) backdrop.classList.add('active');
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(() => lucide.createIcons(), 50);
    }
    
    // Optional: WakeLock API (MVP+)
    if(navigator.wakeLock){
      navigator.wakeLock.request('screen').then(lock => {
        wakeLock = lock;
      }).catch(err => {
        console.log('WakeLock not available:', err);
      });
    }
    
    // Esc schlie√üt Modal
    const handleKeyDown = (e) => {
      if(e.key === 'Escape'){
        closeFullscreenCode();
        document.removeEventListener('keydown', handleKeyDown);
      }
    };
    document.addEventListener('keydown', handleKeyDown);
  }
  
  /**
   * Close fullscreen code modal
   */
  function closeFullscreenCode(){
    const modal = document.getElementById('fullscreenCode');
    const backdrop = document.getElementById('fullscreenCodeBd');
    
    if(modal) modal.classList.remove('active');
    if(backdrop) backdrop.classList.remove('active');
    
    // WakeLock freigeben
    if(wakeLock){
      wakeLock.release().catch(err => {
        console.log('WakeLock release error:', err);
      });
      wakeLock = null;
    }
  }
  
  const btnShowFullscreenCode = document.getElementById('btnShowFullscreenCode');
  if(btnShowFullscreenCode){
    btnShowFullscreenCode.onclick = () => {
      if(!currentPickupOrderId) return;
      const order = getOrderById(currentPickupOrderId);
      if(!order) return;
      // Code nur anzeigen wenn PAID
      if(order.status === 'PAID'){
        const code = order.pickupCode || order.code || '';
        if(code) openFullscreenCode(code);
      } else {
        alert('Abholcode wird nach erfolgreicher Zahlung generiert.');
      }
    };
  }
  
  const btnOpenRoute = document.getElementById('btnOpenRoute');
  if(btnOpenRoute){
    btnOpenRoute.onclick = () => {
      if(!currentPickupOrderId) return;
      const order = getOrderById(currentPickupOrderId);
      if(!order) return;
      const address = order.providerAddress || '';
      if(address){
        // Route √∂ffnen (√∂ffnet Maps mit providerAddress)
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
        window.open(mapsUrl, '_blank');
      } else {
        alert('Adresse nicht verf√ºgbar.');
      }
    };
  }
  
  const btnToOrders = document.getElementById('btnToOrders');
  if(btnToOrders){
    btnToOrders.onclick = () => {
      showOrders(); // Zur Mittagsbox (orders)
    };
  }
  
  // Fullscreen Code Modal: Tap anywhere to close
  const fullscreenCodeBd = document.getElementById('fullscreenCodeBd');
  if(fullscreenCodeBd){
    fullscreenCodeBd.onclick = () => {
      closeFullscreenCode();
    };
  }
  
  const fullscreenCodeClose = document.querySelector('.fullscreen-code-close');
  if(fullscreenCodeClose){
    fullscreenCodeClose.onclick = () => {
      closeFullscreenCode();
    };
  }
  
  // --- boot ---
  // Testdaten erstellen (nur wenn keine vorhanden oder f√ºr Demo)
  // Alte seed() Funktion - wird durch seedExampleData() ersetzt
  // seed(); // Auskommentiert, da seedExampleData() die neuen Beispieldaten l√§dt
  
  // Neue Beispieldaten laden (10 Anbieter, je 3 Gerichte, je 10 Abholcodes)
  // Nur wenn keine Offers vorhanden oder f√ºr Demo
  if(offers.length === 0 || true){ // true f√ºr Demo - immer neu generieren
    seedExampleData();
  }
  offers = offers.map(normalizeOffer);
  save(LS.offers, offers);
  
  // Orders laden
  orders = loadOrders();
  
  // --- Route Handler: Checkout Success/Cancel + Abholcode ---
  // Routes:
  //   /checkout/success?session_id=xxx OR ?orderId=xxx
  //   /checkout/cancel?orderId=xxx OR ?session_id=xxx
  //   /abholcode/:orderId (via URL hash or query param)
  {
    const urlParams = new URLSearchParams(window.location.search);
    const path = window.location.pathname;
    const hash = window.location.hash;
    
    // Success Route: /checkout/success
    if(path.includes('/checkout/success') || urlParams.has('session_id') || (urlParams.has('success') && urlParams.has('orderId'))){
      const sessionId = urlParams.get('session_id');
      const orderId = urlParams.get('orderId');
      
      if(sessionId || orderId){
        handleCheckoutSuccess(sessionId, orderId);
        // Clean URL (remove query params)
        window.history.replaceState({}, '', window.location.pathname);
      }
    }
    
    // Cancel Route: /checkout/cancel
    if(path.includes('/checkout/cancel') || (urlParams.has('cancel') && (urlParams.has('orderId') || urlParams.has('session_id')))){
      const orderId = urlParams.get('orderId');
      const sessionId = urlParams.get('session_id');
      if(orderId || sessionId){
        handleCheckoutCancel(orderId, sessionId);
        // Clean URL
        window.history.replaceState({}, '', window.location.pathname);
      }
    }
    
    // Legal Pages Routes: /impressum, /agb-kurz, /datenschutz
    if(hash){
      const legalRoutes = {
        '#/impressum': 'impressum',
        '#/agb-kurz': 'agb-kurz',
        '#/datenschutz': 'datenschutz'
      };
      if(legalRoutes[hash]){
        showLegalPage(legalRoutes[hash]);
      }
    }
    
    // Hash-Change Listener f√ºr Legal Pages
    window.addEventListener('hashchange', function(){
      const hash = window.location.hash;
      const legalRoutes = {
        '#/impressum': 'impressum',
        '#/agb-kurz': 'agb-kurz',
        '#/datenschutz': 'datenschutz'
      };
      if(legalRoutes[hash]){
        showLegalPage(legalRoutes[hash]);
      }
    });
    
    // Abholcode Route: /abholcode/:orderId
    // Support: /abholcode?orderId=xxx OR hash #abholcode/:orderId
    if(path.includes('/abholcode') || hash.includes('#abholcode/') || urlParams.has('abholcode')){
      let orderId = null;
      
      // Try hash first: #abholcode/:orderId
      if(hash.includes('#abholcode/')){
        orderId = hash.split('#abholcode/')[1]?.split('?')[0]?.split('#')[0];
      }
      
      // Try query param: ?abholcode=xxx or ?orderId=xxx
      if(!orderId){
        orderId = urlParams.get('abholcode') || urlParams.get('orderId');
      }
      
      if(orderId){
        showPickupCode(orderId);
        // Clean URL
        window.history.replaceState({}, '', window.location.pathname);
      }
    }
  }
  
  // 1. Initialisierung - Script-Block validiert
  renderChips();

  // 2. Navigation & Logik
  if(mode === 'provider' && !provider.loggedIn) mode = 'customer';
  if(mode === 'start') mode = 'customer';
  setMode(mode);
  
  updateProfileView();
  
  // 3. Views rendern
  if(mode === 'customer'){
    setTimeout(() => {
      if(typeof renderDiscover !== 'undefined') renderDiscover();
      if(typeof lucide !== 'undefined') {
        setTimeout(() => lucide.createIcons(), 150);
      }
    }, 100);
  }
  
  if(mode === 'start'){
    setTimeout(() => {
      if(typeof renderStart !== 'undefined') renderStart();
    }, 200);
  }
  
  } // Fehlende Klammer hinzugef√ºgt - SyntaxError behoben
</script>

<script>
  // Icon-Initialisierung (immer, nicht nur bei Service Worker)
  function initIcons(){
    if(typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function'){
      lucide.createIcons();
    } else {
      // Warte bis Lucide geladen ist (max. 2 Sekunden)
      let attempts = 0;
      const checkLucide = setInterval(()=>{
        attempts++;
        if(typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function'){
          lucide.createIcons();
          clearInterval(checkLucide);
        } else if(attempts > 20){ // Nach 2 Sekunden aufgeben
          clearInterval(checkLucide);
        }
      }, 100);
    }
  }

  // Beispieldaten laden: 10 Anbieter mit je 3 Gerichten und 10 Abholcodes
  // WICHTIG: seedExampleData() NACH seed() aufrufen, damit die neuen Daten nicht √ºberschrieben werden
  // seedExampleData() wird am Ende aufgerufen (siehe unten)
  
  // Test-Funktion global verf√ºgbar machen (in Browser-Konsole: testPickupCodeLogic() aufrufen)
  if(typeof testPickupCodeLogic !== 'undefined'){
    window.testPickupCodeLogic = testPickupCodeLogic;
  }

  // PWA (optional)
  // TEMPOR√ÑR DEAKTIVIERT ZUM TESTEN
  if(false && 'serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      // Service Worker-Pfad relativ zum aktuellen Verzeichnis
      const swPath = document.querySelector('base') ? 'sw.js' : './sw.js';
      navigator.serviceWorker.register(swPath).catch(()=>{});
      // Icons initialisieren
      initIcons();
      // Profile-View aktualisieren
      if(typeof updateProfileView !== 'undefined'){
        updateProfileView();
      }
      // Startseite rendern, falls im start-Mode
      if(typeof mode !== 'undefined' && mode === 'start' && typeof renderStart !== 'undefined'){
        setTimeout(()=>{
          renderStart();
          initIcons();
        }, 100);
      }
    });
  } else {
    // Fallback: Icons auch ohne Service Worker initialisieren
    window.addEventListener('load', ()=>{
      initIcons();
      // Profile-View aktualisieren
      if(typeof updateProfileView !== 'undefined'){
        updateProfileView();
      }
      // Startseite rendern, falls im start-Mode
      if(typeof mode !== 'undefined' && mode === 'start' && typeof renderStart !== 'undefined'){
        setTimeout(()=>{
          renderStart();
          initIcons();
        }, 100);
      }
    });
  }

  // Icons nach jedem View-Wechsel aktualisieren
  if(typeof showView !== 'undefined'){
    const originalShowView = showView;
    showView = function(id){
      originalShowView(id);
      setTimeout(()=> initIcons(), 50);
    };
  }
</script>
</body>
</html>
