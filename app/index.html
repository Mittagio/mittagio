<!doctype html>
<html lang="de">
<head>
  <base href="/mittagio/app/">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Mittagio</title>
  <meta name="theme-color" content="#F2B705" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="assets/icons/icon-192.png" />
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png" />
  <script src="https://unpkg.com/lucide@latest" onload="if(typeof lucide !== 'undefined') lucide.createIcons();"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Montserrat:wght@400;600;700;900&display=swap');
    :root{
      /* Mittagio palette (can be adjusted later) */
      --bg:#F7F6F0;
      --card:#FFFFFF;
      --text:#111;
      --muted:#6b6b6b;
      --border:#e7e1d5;
      --shadow:0 10px 24px rgba(0,0,0,.08);
      --shadow2:0 16px 40px rgba(0,0,0,.14);
      --radius:24px;     /* rounded-3xl for messenger vibe */
      --brand:#FFCC00;   /* Mittagio-Gelb */
      --brand2:#1F9D55;  /* green */
      --danger:#E34D4D;
      
      /* Design Tokens - PWA Light */
      /* Radius */
      --r-sm: 10px;
      --r-md: 14px;
      --r-lg: 18px;
      --r-xl: 24px;
      --r-full: 999px;
      
      /* Spacing */
      --s-1: 4px;
      --s-2: 8px;
      --s-3: 12px;
      --s-4: 16px;
      --s-5: 20px;
      --s-6: 24px;
      --s-8: 32px;
      
      /* Typography */
      --font-title: 18px;
      --font-title-lg: 20px;
      --font-body: 14px;
      --font-body-lg: 16px;
      --font-meta: 12px;
      --font-meta-sm: 13px;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;
      
      /* Colors (Light) */
      --color-bg: #FFFFFF;
      --color-surface: #FFFFFF;
      --color-border: #EAEAEA;
      --color-text: #1A1A1A;
      --color-text-secondary: #6B6B6B;
      --color-brand-yellow: #FFCC00;
      --color-soft-yellow-bg: rgba(255, 204, 0, 0.15);
      --color-soft-green-bg: rgba(31, 157, 85, 0.12);
      --color-soft-grey-bg: rgba(0, 0, 0, 0.06);
      
      /* Icon Sizes */
      --icon-inline: 16px;
      --icon-inline-lg: 18px;
      --icon-header: 20px;
      --icon-header-lg: 22px;
      --icon-nav: 22px;
      --icon-nav-lg: 24px;
      
      /* Button Heights */
      --btn-height-min: 44px;
      --btn-height-md: 48px;
      
      /* Badge */
      --badge-height: 24px;
      --badge-px: 10px;
      --badge-px-lg: 12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Inter', 'Montserrat', system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-size:16px;
      line-height:1.5;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit}

    /* App shell */
    .app{min-height:100%; padding-bottom:calc(78px + env(safe-area-inset-bottom, 0px));}
    .topbar{
      position:sticky; top:0; z-index:10;
      background:rgba(247,246,240,.92);
      backdrop-filter:saturate(160%) blur(8px);
      -webkit-backdrop-filter:saturate(160%) blur(8px);
      border-bottom:1px solid var(--border);
      padding-top:env(safe-area-inset-top, 0px);
    }
    .topbar-inner{max-width:980px; margin:0 auto; padding:12px 16px; display:flex; align-items:center; gap:10px;}
    .header-basket-btn{
      position:relative;
      background:none;
      border:none;
      cursor:pointer;
      padding:8px;
      transition:transform 0.2s ease, filter 0.3s ease;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .header-basket-btn:hover{
      transform:scale(1.1);
    }
    .header-basket-btn:active{
      transform:scale(0.95);
    }
    .header-basket-btn.bounce{
      animation:basketBounce 0.5s ease;
    }
    .header-basket-btn.glow{
      filter:drop-shadow(0 0 12px rgba(255,215,0,0.8));
    }
    @keyframes basketBounce{
      0%, 100%{transform:scale(1);}
      50%{transform:scale(1.2);}
    }
    .header-basket-badge{
      position:absolute;
      top:4px;
      right:4px;
      width:18px;
      height:18px;
      background:#FFD700;
      color:#2D3436;
      border-radius:50%;
      font-size:11px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
      border:2px solid #fff;
      box-shadow:0 2px 8px rgba(0,0,0,0.15);
    }
    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
      cursor:pointer;
      transition:opacity 0.2s ease;
    }
    .brand:hover{
      opacity:0.8;
    }
    .brand:active{
      opacity:0.6;
    }
    .brand-badge{
      width:38px; height:38px; border-radius:12px;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      box-shadow:0 8px 18px rgba(0,0,0,.16);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .brand-badge img{width:100%; height:100%; object-fit:cover; display:block}
    .brand-name{font-weight:900; letter-spacing:.06em; font-size:20px; white-space:nowrap}
    .spacer{flex:1}

    .chiprow{
      max-width:980px; margin:0 auto; padding:6px 14px 8px;
      display:flex; gap:8px; overflow:auto; -webkit-overflow-scrolling:touch;
    }
    .chip{
      flex:0 0 auto;
      border:1px solid var(--border);
      background:#f8f7f3;
      padding:10px 16px;
      border-radius:999px;
      font-size:14px;
      font-weight:800;
      color:#222;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .chip.active{
      border-color:rgba(31,157,85,.45);
      background:rgba(31,157,85,.12);
      box-shadow:0 10px 22px rgba(31,157,85,.12)
    }

    .pickup-group{
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      padding:10px;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .pickup-group + .pickup-group{margin-top:10px}
    .pickup-head{display:flex; align-items:center; justify-content:space-between; gap:8px; font-weight:900}
    .pickup-sub{font-size:12px; color:var(--muted)}
    .code-chip{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px; border:1px solid var(--border);
      background:#fff; font-size:12px; font-weight:900;
      margin:4px 6px 0 0; box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .code-chip.done{background:rgba(31,157,85,.12); border-color:rgba(31,157,85,.4); color:#1f9d55; text-decoration:line-through}

    /* Ticket Card Animation (Pulse/Shimmer) */
    /* Match-Screen Animationen */
    @keyframes scaleIn {
      0% { transform: scale(0); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    @keyframes slideUp {
      0% { transform: translateY(20px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    @keyframes ticketPulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
      }
      50% {
        transform: scale(1.01);
        box-shadow: 0 25px 30px -5px rgba(255,204,0,0.15), 0 15px 15px -5px rgba(255,204,0,0.08);
      }
    }
    @keyframes ticketShimmer {
      0% {
        background-position: -200% 0;
      }
      100% {
        background-position: 200% 0;
      }
    }
    .ticket-card-pulse {
      animation: ticketPulse 2s ease-in-out infinite;
    }
    .ticket-card-pulse::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: ticketShimmer 3s ease-in-out infinite;
    }

    .dayrow{
      max-width:980px; margin:0 auto; padding:0 14px 12px;
      display:flex; gap:8px; overflow:auto; -webkit-overflow-scrolling:touch;
    }
    .day{
      flex:0 0 auto;
      border:none;
      background:#fff;
      padding:12px 16px;
      border-radius:999px;
      font-size:14px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      border:1px solid var(--border);
    }
    .day.active{background:rgba(242,183,5,.14); border-color:rgba(242,183,5,.55)}

    main{max-width:980px; margin:0 auto; padding:16px}
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    @media (min-width:820px){ .grid{grid-template-columns:1fr 1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:20px;
      overflow:hidden;
      box-shadow:0 4px 16px rgba(0,0,0,.08);
      cursor:pointer;
      position:relative;
      margin-bottom:16px;
    }
    .card.playful{
      border-color:rgba(242,183,5,.38);
      box-shadow:0 12px 26px rgba(242,183,5,.18);
    }
    .card.playful .body{
      background:linear-gradient(180deg,#fff, #fff4e6);
    }
    .card.playful .price{color:#b26b00}
    .card.playful .tag{background:rgba(242,183,5,.25)}
    .img{aspect-ratio:16/9; height:auto; min-height:120px; max-height:140px; background:#eee; position:relative; overflow:hidden; border-radius:20px 20px 0 0}
    .img img{width:100%; height:100%; object-fit:cover; display:block}

    .provider-logo{
      display:flex; align-items:center; gap:8px;
      padding:12px 14px 0;
    }
    .plogo{
      width:28px; height:28px; border-radius:8px;
      background:#f2f2f2;
      overflow:hidden;
      border:1px solid var(--border);
      flex:0 0 auto;
    }
    .plogo img{width:100%; height:100%; object-fit:cover; display:block}
    .pname{font-size:14px; font-weight:900; color:#222; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; line-height:1.3}

    .body{padding:16px}
    .title{font-weight:950; font-size:18px; margin:0; line-height:1.3}
    .sub{margin:4px 0 0; color:#444; font-size:14px; line-height:1.4}
    
    /* Refactored Card Styles - weniger Text, mehr Icons */
    .card-heart{
      position:absolute; top:12px; right:12px; z-index:5;
      width:36px; height:36px; border-radius:50%;
      border:none; background:rgba(255,255,255,.9);
      backdrop-filter:blur(8px); display:flex;
      align-items:center; justify-content:center;
      cursor:pointer; transition:all .2s;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
    }
    .card-heart:hover{background:rgba(255,255,255,1); transform:scale(1.05)}
    .card-heart.on{background:rgba(255,204,0,.2)}
    .card-heart i{width:18px; height:18px; color:#999}
    .card-heart.on i{color:#e74c3c; fill:currentColor}
    
    .card-title-row{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:8px; margin-bottom:6px;
    }
    .card-title{
      font-weight:900; font-size:17px; margin:0;
      line-height:1.3; flex:1; min-width:0;
      display:-webkit-box; -webkit-line-clamp:2;
      -webkit-box-orient:vertical; overflow:hidden;
      color:#111;
    }
    .card-provider{
      font-size:13px; color:#666; margin:0 0 8px;
      line-height:1.3; font-weight:500;
      display:flex; align-items:center; gap:6px;
    }
    .card-provider .ico-inline{
      width:16px; height:16px; flex-shrink:0;
      color:var(--muted);
    }
    .card-provider .ico-inline svg{
      width:16px; height:16px;
    }
    .card-price{
      font-size:24px; font-weight:950; color:var(--brand);
      margin:0 0 10px; line-height:1;
    }
    .card-info-badges{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-bottom:10px; align-items:center;
    }
    .card-info-badge{
      display:inline-flex; align-items:center; gap:4px;
      font-size:13px; font-weight:600; color:#666;
      white-space:nowrap;
    }
    .card-info-badge .ico-inline{
      width:16px; height:16px; flex-shrink:0;
      color:var(--muted);
    }
    .card-info-badge .ico-inline svg{
      width:16px; height:16px;
    }
    .card-status-badges{
      display:flex; gap:6px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .card-status-badge{
      display:inline-flex; align-items:center; gap:4px;
      padding:4px 10px; border-radius:999px;
      font-size:11px; font-weight:600;
      background:rgba(0,0,0,.06); color:#666;
      white-space:nowrap;
    }
    .card-status-badge .ico-inline{
      width:14px; height:14px; flex-shrink:0;
    }
    .card-status-badge .ico-inline svg{
      width:14px; height:14px;
    }
    /* Abholnummer Badge: leicht hervorgehoben (Markenfarbe Gelb) */
    .card-status-badge.code{
      background:rgba(255,204,0,.2); color:#b8860b;
      font-weight:700;
    }
    .card-status-badge.code .ico-inline{color:#b8860b}
    /* Vor Ort Badge: weiche grüne Füllung */
    .card-status-badge.dine{
      background:rgba(31,157,85,.12); color:#1f9d55;
    }
    .card-status-badge.dine .ico-inline{color:#1f9d55}
    /* Zum Mitnehmen Badge: neutrale weiche Füllung */
    .card-status-badge.pickup{
      background:rgba(0,0,0,.06); color:#666;
    }

    .meta{display:flex; justify-content:space-between; align-items:flex-end; gap:12px; margin-top:12px}
    .price{font-weight:950; font-size:18px; color:#0f5c4c}
    .right{ text-align:right; font-size:13px; color:var(--muted); line-height:1.4 }
    .meta-line{display:flex; align-items:center; gap:6px; justify-content:flex-end}
    .tag{display:inline-block; margin-top:6px; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:900; background:rgba(242,183,5,.18)}

    .badge{
      position:absolute; top:12px; left:12px;
      background:rgba(17,17,17,.72);
      color:#fff;
      font-size:12px; font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      box-shadow:0 10px 22px rgba(0,0,0,.18);
      line-height:1.3;
    }
    .badge.code{left:auto; right:12px; background:rgba(31,157,85,.9)}
    .badge.dine{background:rgba(242,183,5,.9); color:#111}
    .badge.inactive{background:rgba(0,0,0,.45)}

    .heart{
      position:absolute; top:12px; right:12px;
      width:36px; height:36px; border-radius:999px;
      border:none; cursor:pointer;
      background:rgba(255,255,255,.92);
      box-shadow:0 10px 22px rgba(0,0,0,.16);
      font-size:16px;
      color:#bbb;
      display:flex; align-items:center; justify-content:center;
    }
    .heart.on{color:var(--danger)}

    /* Bottom nav - Glassmorphism Mittagio-Bar */
    .nav-badge{
      position:absolute; top:4px; right:8px;
      width:18px; height:18px;
      background:#FFD700; color:#2D3436;
      border-radius:50%; font-size:11px; font-weight:900;
      display:flex; align-items:center; justify-content:center;
      border:2px solid #fff; box-shadow:0 2px 8px rgba(0,0,0,0.15);
      z-index:10;
    }
    .navbtn.bounce{
      animation:basketBounce 0.5s ease;
    }
    .navbtn.glow{
      filter:drop-shadow(0 0 12px rgba(255,215,0,0.8));
    }
    @keyframes basketBounce{
      0%, 100%{transform:scale(1);}
      50%{transform:scale(1.15);}
    }
    .bottom{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      height:calc(60px + env(safe-area-inset-bottom, 16px));
      padding-bottom:env(safe-area-inset-bottom, 16px);
      background:rgba(255,255,255,.85);
      backdrop-filter:saturate(180%) blur(20px);
      -webkit-backdrop-filter:saturate(180%) blur(20px);
      border-top:1px solid rgba(231,225,213,.3);
      display:flex;
      box-shadow:0 -4px 20px rgba(0,0,0,.05);
    }
    .navbtn{
      flex:1; border:none; background:none; cursor:pointer;
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
      color:#777; font-size:11px; font-weight:600;
      padding:8px 4px; transition:color .2s;
      position:relative;
      -webkit-tap-highlight-color: transparent;
    }
    .navbtn * {
      pointer-events: none;
    }
    .navbtn .ico{font-size:22px; display:inline-flex; align-items:center; justify-content:center}
    .navbtn .ico svg{width:22px; height:22px; stroke-width:2}
    /* Bottom Navigation Icons: 22-24px */
    .navbtn.active{color:var(--brand)}
    .navbtn.active .ico svg{color:var(--brand); stroke:var(--brand)}
    .navbtn.active{color:var(--brand); font-weight:900}
    .navbtn .badge-notification{
      position:absolute; top:8px; right:calc(50% - 20px);
      width:8px; height:8px; border-radius:50%;
      background:var(--brand); border:2px solid rgba(255,255,255,.85);
    }

    /* Views */
    .view{display:none}
    .view.active{display:block}

    /* Sheets / modals */
    .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.38); opacity:0; pointer-events:none; transition:opacity .2s; z-index:30}
    .backdrop.active{opacity:1; pointer-events:auto}
    .sheet{
      position:fixed; left:0; right:0; bottom:-120%; z-index:31;
      background:#fff; border-radius:22px 22px 0 0;
      box-shadow:var(--shadow2);
      transition:bottom .28s ease;
      max-height:92vh; overflow:auto;
    }
    .sheet.active{bottom:0}
    .handle{width:46px; height:5px; background:#ddd; border-radius:999px; margin:10px auto 6px}
    .sheet-img{height:260px; background:#eee}
    .sheet-img img{width:100%; height:100%; object-fit:cover; display:block}
    .sheet-body{padding:12px 14px 18px}
    .row{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px 0; border-top:1px solid #eee; font-size:15px; line-height:1.4}
    .btn{
      width:100%; border:none; cursor:pointer;
      border-radius:999px; padding:16px 20px; font-weight:950; font-size:16px;
      background:var(--brand); color:#111;
      line-height:1.4;
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn.secondary{background:#fff; border:1px solid var(--border)}
    .btn.ghost{background:#f8f7f3; border:1px solid var(--border)}
    .mini{font-size:13px; color:var(--muted); margin-top:8px; line-height:1.5}
    
    /* Primary CTA (Yellow, Dark Text, 56-64px) */
    .btn-primary{
      width:100%; border:none; cursor:pointer;
      border-radius:999px; padding:16px 20px; font-weight:950; font-size:16px;
      background:#f2b705; color:#111;
      line-height:1.4;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-height:56px; max-height:64px;
      transition:all .2s;
    }
    .btn-primary:active{
      background:#e6b800;
      transform:scale(0.98);
    }
    .btn-primary:disabled{
      opacity:.6; cursor:not-allowed; background:#f2b705;
    }
    .btn-primary.loading{
      opacity:.7; cursor:wait;
    }
    .btn-primary.success{
      background:#2e7d32; color:#fff;
    }

    .card-actions{display:flex; gap:8px; margin-top:12px}
    .card-action{
      flex:1; padding:0 16px; min-height:44px;
      border-radius:12px; border:none;
      background:#fff; font-weight:900; font-size:15px;
      cursor:pointer; transition:transform .1s, background .15s;
      display:flex; align-items:center; justify-content:center; gap:6px;
      text-align:center;
    }
    .card-action:active{transform:scale(.97)}
    .card-action.primary{
      background:var(--brand); color:#111;
      border:1px solid var(--brand);
      min-height:44px;
    }
    .card-action.primary:active{background:#e6b800}
    .card-action.ghost{background:#f8f7f3; border:1px solid var(--border)}
    .card-action:disabled{opacity:.5; cursor:not-allowed; background:#f5f5f5}

    /* Profile cards */
    .panel{background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:0 4px 16px rgba(0,0,0,.08); padding:16px; margin-bottom:16px}
    .panel h3{margin:0 0 10px; font-size:18px; font-weight:900; line-height:1.3}
    .section-title{font-weight:900; font-size:20px; margin:12px 0 8px; line-height:1.3}
    .rowlist{display:flex; flex-direction:column; gap:8px}
    .rowbtn{
      width:100%; border:1px solid var(--border); background:#fff; cursor:pointer;
      border-radius:14px; padding:12px; text-align:left; font-weight:900;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .rowbtn-left{display:flex; align-items:center; gap:10px; min-width:0}
    .rowbtn-ico{
      width:36px; height:36px; border-radius:10px; flex:0 0 auto;
      border:1px solid var(--border); background:#f8f7f3;
      display:flex; align-items:center; justify-content:center;
    }
    .rowbtn-ico svg{width:16px; height:16px}
    .rowbtn-text{min-width:0}
    .rowbtn-text span{display:block; font-weight:600; font-size:13px; color:var(--muted); margin-top:4px; line-height:1.4}
    .rowbtn .chev{font-size:20px; color:var(--muted)}
    .rowgroup-title{font-size:13px; font-weight:900; color:var(--muted); margin-top:8px; line-height:1.4}
    .profile-head{display:flex; align-items:center; gap:12px}
    .profile-head .plogo{width:56px; height:56px; border-radius:50%}
    .profile-meta{display:flex; flex-direction:column; gap:4px}
    .profile-chip{display:inline-flex; align-items:center; gap:6px; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900; background:#fff}
    .profile-actions{margin-top:10px}
    .profile-actions .btn{width:auto; margin-top:0}
    .row-group{margin-top:12px}
    .row-group .rowgroup-title{margin:0 0 8px}
    .row-muted{font-size:12px; color:var(--muted)}

    .tabrow{display:flex; gap:8px; flex-wrap:wrap}
    .tabrow .ans{font-size:12px; padding:8px 10px}
    .cookbook-item{border:1px solid var(--border); border-radius:14px; padding:10px; background:#fff; box-shadow:0 6px 14px rgba(0,0,0,.06)}
    .cookbook-item + .cookbook-item{margin-top:10px}
    .cookbook-actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .cookbook-facts{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.35}
    .cart-line{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 0; border-top:1px solid #eee}
    .cart-left{font-weight:700; flex:1; min-width:0}
    .cart-qty{display:flex; align-items:center; gap:6px}
    .qty-btn{border:1px solid var(--border); background:#fff; border-radius:999px; width:28px; height:28px; cursor:pointer; font-weight:900; transition:all .15s}
    .qty-btn:active{transform:scale(.95); background:#f5f5f5}
    .cart-price{font-weight:900; min-width:60px; text-align:right}
    /* Essenszeit Badge */
    .cart-window-badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 12px; border-radius:12px;
      background:rgba(255,204,0,.1); color:#b8860b;
      font-size:13px; font-weight:700; margin:8px 0;
    }
    .cart-window-badge i{width:16px; height:16px}
    /* Quick-Time-Chips */
    .cart-time-chips{
      display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px;
    }
    .cart-time-chip{
      padding:8px 14px; border-radius:12px;
      border:1px solid #ddd; background:#fff;
      font-size:13px; font-weight:600; color:#666;
      cursor:pointer; transition:all .15s;
    }
    .cart-time-chip:active{transform:scale(.96); background:#f5f5f5}
    .cart-time-chip.selected{
      background:var(--brand); color:#000; border-color:var(--brand);
    }
    /* Warenkorb leeren Button */
    .cart-clear-btn{
      display:inline-block; margin-top:12px;
      padding:8px 16px; border-radius:10px;
      background:#f5f5f5; color:#666;
      font-size:13px; font-weight:600;
      text-decoration:none; cursor:pointer;
      transition:all .15s;
    }
    .cart-clear-btn:hover{background:#eee}
    .cart-clear-btn:active{transform:scale(.98)}
    .order-item{border:1px solid var(--border); border-radius:14px; padding:10px; background:#fff; box-shadow:0 6px 14px rgba(0,0,0,.06)}
    .order-item.done{opacity:.65}
    .order-item + .order-item{margin-top:10px}
    .order-top{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .order-right{display:flex; flex-direction:column; align-items:flex-end; gap:6px}
    .order-code{
      border:1px solid var(--border); 
      background:#fff; 
      border-radius:10px; 
      padding:6px 10px; 
      font-weight:900; 
      cursor:pointer;
      transition:transform 0.1s ease;
    }
    .order-code:active{
      transform:scale(0.95);
    }
    .status-pill{display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; font-size:11px; font-weight:900; border:1px solid var(--border)}
    .status-pill.open{background:rgba(242,183,5,.12); color:#b37b00}
    .status-pill.done{background:rgba(31,157,85,.12); color:#1f9d55}
    .code-full{font-size:42px; font-weight:950; text-align:center; margin:10px 0}

    /* Quick-Ticket (bildschirmfüllend) */
    /* Fullscreen Code Modal (extrem groß, 1-2m lesbar) */
    .fullscreen-code{
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:#fff; z-index:1000;
      display:flex; align-items:center; justify-content:center;
      flex-direction:column; padding:40px 20px;
      opacity:0; pointer-events:none; transition:opacity .2s;
    }
    .fullscreen-code.active{
      opacity:1; pointer-events:auto;
    }
    .fullscreen-code-close{
      position:absolute; top:20px; right:20px;
      width:48px; height:48px; border-radius:50%;
      background:rgba(0,0,0,.1); border:none;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; transition:all .2s;
      z-index:1001;
    }
    .fullscreen-code-close:hover{background:rgba(0,0,0,.15)}
    .fullscreen-code-close i{width:24px; height:24px}
    .fullscreen-code-content{
      text-align:center; width:100%; max-width:600px;
    }
    .fullscreen-code-value{
      font-size:clamp(56px, 12vw, 120px);
      font-weight:900; font-family:monospace;
      letter-spacing:clamp(8px, 2vw, 16px);
      color:#000; line-height:1.2;
      margin-bottom:24px;
      word-spacing:clamp(12px, 3vw, 24px);
    }
    .fullscreen-code-subtext{
      font-size:clamp(14px, 3vw, 20px);
      color:#666; font-weight:600;
    }
    
    .quick-ticket{
      position:fixed; inset:0; z-index:31;
      background:linear-gradient(135deg, var(--brand) 0%, #FFD700 100%);
      display:flex; align-items:center; justify-content:center;
      transform:translateY(100%); transition:transform .3s cubic-bezier(.4,0,.2,1);
      padding:20px;
    }
    .quick-ticket.active{transform:translateY(0)}
    .quick-ticket-close{
      position:absolute; top:20px; right:20px;
      width:44px; height:44px; border-radius:50%;
      background:rgba(255,255,255,.2); backdrop-filter:blur(10px);
      border:2px solid rgba(255,255,255,.3);
      color:#fff; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      transition:background .2s;
    }
    .quick-ticket-close:hover{background:rgba(255,255,255,.3)}
    .quick-ticket-close i{width:24px; height:24px}
    .quick-ticket-content{
      width:100%; max-width:400px; text-align:center;
      color:#111;
    }
    .quick-ticket-header{
      margin-bottom:40px;
    }
    .quick-ticket-logo{
      width:80px; height:80px; border-radius:20px;
      background:#fff; border:4px solid rgba(255,255,255,.5);
      margin:0 auto 16px; overflow:hidden;
      box-shadow:0 8px 24px rgba(0,0,0,.2);
    }
    .quick-ticket-logo img{
      width:100%; height:100%; object-fit:cover;
    }
    .quick-ticket-provider{
      font-size:26px; font-weight:900; margin-bottom:10px; line-height:1.3;
    }
    .quick-ticket-time{
      font-size:15px; opacity:.8; font-weight:600; line-height:1.4;
    }
    .quick-ticket-code{
      background:#fff; border-radius:var(--radius);
      padding:32px 24px; margin-bottom:24px;
      box-shadow:0 12px 32px rgba(0,0,0,.2);
    }
    .quick-ticket-code-label{
      font-size:12px; font-weight:700; text-transform:uppercase;
      letter-spacing:.1em; color:var(--muted); margin-bottom:12px;
    }
    .quick-ticket-code-value{
      font-size:72px; font-weight:950; line-height:1;
      color:#111; font-family:'Inter', monospace;
      letter-spacing:.05em;
    }
    .quick-ticket-details{
      background:rgba(255,255,255,.3); backdrop-filter:blur(10px);
      border-radius:var(--radius); padding:20px;
      margin-bottom:20px;
    }
    .quick-ticket-detail-item{
      margin-bottom:16px;
    }
    .quick-ticket-detail-item:last-child{margin-bottom:0}
    .quick-ticket-detail-label{
      font-size:13px; font-weight:700; opacity:.7; margin-bottom:6px; line-height:1.4;
    }
    .quick-ticket-detail-value{
      font-size:17px; font-weight:900; line-height:1.4;
    }
    .quick-ticket-status{
      font-size:14px; font-weight:700; opacity:.8; line-height:1.4;
      margin-bottom:24px;
    }
    .quick-ticket-actions .btn{
      background:#fff; color:#111; box-shadow:0 8px 24px rgba(0,0,0,.2);
    }

    .print-view{display:none}
    @media print{
      body{background:#fff; color:#000}
      body > *:not(#printView){display:none !important}
      #printView{display:block}
      #printView .print-card{
        border:1px solid #ddd; border-radius:12px; padding:16px; margin-bottom:12px;
      }
      #printView h1{margin:0 0 8px; font-size:20px}
      #printView h2{margin:12px 0 6px; font-size:16px}
      #printView .print-row{display:flex; justify-content:space-between; gap:12px; margin-top:6px}
      #printView .print-muted{color:#555; font-size:12px}
      #printView .print-badge{display:inline-block; padding:4px 8px; border:1px solid #999; border-radius:999px; font-size:11px; font-weight:700}
      #printView .print-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
      #printView .pickup-code-display{width:120px; height:120px; border:2px solid var(--brand); border-radius:12px; background:#fff; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; color:#2D3436}
    }
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .bigbtn{
      border:none; cursor:pointer;
      border-radius:18px; padding:14px;
      background:linear-gradient(135deg,rgba(242,183,5,.18),rgba(31,157,85,.12));
      border:1px solid var(--border);
      text-align:left;
      font-weight:950;
    }
    .bigbtn span{display:block; font-weight:700; font-size:12px; color:var(--muted); margin-top:6px}

    /* Provider app header */
    .prov-pill{
      display:inline-flex; align-items:center; gap:8px;
      background:#fff; border:1px solid var(--border);
      padding:9px 12px; border-radius:999px;
      font-weight:950; font-size:13px;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .provider-header{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .provider-logo.compact{padding:0}
    .header-actions{display:flex; gap:8px; flex-wrap:wrap}
    .header-actions .btn{width:auto; margin-top:0}

    .snackbar{
      position:fixed; left:50%; bottom:90px; transform:translateX(-50%);
      background:#111; color:#fff; border-radius:999px; padding:10px 14px;
      display:flex; align-items:center; gap:10px; box-shadow:0 10px 24px rgba(0,0,0,.22);
      opacity:0; pointer-events:none; transition:opacity .2s ease;
      z-index:40; font-size:13px; font-weight:900;
    }
    .snackbar.active{opacity:1; pointer-events:auto}
    .snackbar button{
      border:none; background:#fff; color:#111; border-radius:999px; padding:6px 10px;
      font-size:12px; font-weight:900; cursor:pointer;
    }

    /* Wizard */
    .wizard{
      background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow);
      padding:12px;
    }
    .w-top{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .w-title{font-weight:950}
    .w-step{font-size:12px; color:var(--muted)}
    .w-q{margin:12px 0 10px; font-size:18px; font-weight:950; line-height:1.2}
    .w-help{margin:0 0 10px; color:var(--muted); font-size:13px}
    .answers{display:flex; flex-wrap:wrap; gap:8px}
    .ans{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-weight:950;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .ans.on{border-color:rgba(31,157,85,.4); background:rgba(31,157,85,.10)}
    .field{width:100%; padding:14px 16px; border-radius:14px; border:1px solid var(--border); font-size:16px; background:#fbfaf7; line-height:1.5}
    .w-actions{display:flex; gap:10px; margin-top:12px}
    .w-actions button{flex:1}

    /* FAQ accordion */
    .faq{margin-top:12px}
    details{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 14px rgba(0,0,0,.06);padding:14px 16px}
    details+details{margin-top:10px}
    summary{cursor:pointer;font-weight:950;font-size:15px;line-height:1.4}
    details p{margin:10px 0 0;color:var(--muted);font-size:14px;line-height:1.6}

    /* helper */
    .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.25}

    .loc-row{display:flex; gap:8px; align-items:center}
    .pin-btn{
      border:1px solid var(--border); background:#fff; border-radius:14px;
      width:44px; height:44px; cursor:pointer; font-size:18px;
      display:flex; align-items:center; justify-content:center;
    }
    .ico-inline{display:inline-flex; align-items:center}
    .ico-inline svg{width:14px; height:14px; stroke:currentColor}
    .info-row{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; font-size:12px; color:var(--muted)}
    /* Legacy: Alte info-row (wird nicht mehr in offerCard verwendet) */
    .info-item{
      display:inline-flex; align-items:center; gap:6px;
      background:#f8f7f3; border:1px solid var(--border);
      padding:5px 10px; border-radius:999px;
      font-size:13px; line-height:1.4;
    }

    /* Onboarding */
    .onboarding-step{
      max-width:600px; margin:0 auto;
    }
    .onboarding-header{
      display:flex; justify-content:space-between; align-items:flex-start;
    }
    .onboarding-progress{
      font-size:12px; font-weight:900; color:var(--muted);
      text-transform:uppercase; letter-spacing:.05em;
    }
    .onboarding-logo-preview:hover{
      border-color:var(--brand); background:#fff4e6;
    }
    .onboarding-logo-preview img{
      display:block;
    }
    .time-btn.active{
      background:var(--brand); border-color:var(--brand);
    }
    .onboarding-summary-item:last-child{
      margin-bottom:0;
    }

    /* Social Feed - Story-Leiste */
    .stories-container{
      padding:16px 14px 20px;
      max-width:980px; margin:0 auto;
    }
    .stories-scroll{
      display:flex; gap:16px; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:4px;
    }
    .story-item{
      flex:0 0 auto; display:flex; flex-direction:column; align-items:center; gap:8px;
      cursor:pointer;
    }
    .story-avatar{
      width:64px; height:64px; border-radius:50%;
      border:3px solid var(--brand);
      padding:2px; background:#fff;
      overflow:hidden; position:relative;
    }
    .story-avatar img{
      width:100%; height:100%; object-fit:cover; border-radius:50%;
    }
    .story-name{
      font-size:12px; font-weight:700; color:var(--text);
      max-width:64px; text-align:center; overflow:hidden; text-overflow:ellipsis;
      line-height:1.3;
    }

    /* Discover Page - App-like UX (PWA, Light Mode) */
    /* Toggle-Switch für Discover-View */
    .discover-view-toggle{
      margin-left:auto; /* Rechts ausrichten in Quick-Filters */
    }
    /* View-Toggle im Topbar (oben rechts neben Logo) - Versteckt, wird durch FAB ersetzt */
    .discover-view-toggle-topbar{
      display:none;
    }
    
    /* Floating Action Button (FAB) für Modus-Wechsel */
    .fab-mode-toggle{
      position:fixed; bottom:calc(80px + env(safe-area-inset-bottom, 16px) + 20px); right:16px;
      width:56px; height:56px; border-radius:50%;
      background:rgba(255,255,255,.85);
      backdrop-filter:saturate(180%) blur(20px);
      -webkit-backdrop-filter:saturate(180%) blur(20px);
      border:1px solid rgba(231,225,213,.3);
      box-shadow:0 8px 24px rgba(0,0,0,.12), 0 0 0 1px rgba(0,0,0,.04);
      display:none; flex; align-items:center; justify-content:center;
      cursor:pointer; z-index:25;
      transition:transform .2s ease, box-shadow .2s ease, background .2s ease;
      user-select:none;
    }
    .fab-mode-toggle:hover{
      transform:scale(1.05);
      box-shadow:0 12px 32px rgba(0,0,0,.16), 0 0 0 1px rgba(0,0,0,.06);
      background:rgba(255,255,255,.95);
    }
    .fab-mode-toggle:active{
      transform:scale(.95);
    }
    .fab-mode-toggle.pulsing{
      animation:fabPulse .4s ease-out;
    }
    @keyframes fabPulse{
      0%{transform:scale(1);}
      50%{transform:scale(1.15); box-shadow:0 12px 40px rgba(255,184,0,.3), 0 0 0 1px rgba(255,184,0,.2);}
      100%{transform:scale(1);}
    }
    .fab-mode-toggle i{
      width:24px; height:24px;
      color:#2D3436;
      transition:transform .2s ease;
    }
    .fab-mode-toggle.active i{
      transform:rotate(180deg);
    }
    
    /* Micro-Hint (Sprechblase beim ersten Start) */
    .fab-hint{
      position:absolute; bottom:calc(100% + 12px); right:0;
      background:#2D3436; color:#fff;
      padding:10px 14px; border-radius:12px;
      font-size:13px; font-weight:600; white-space:nowrap;
      box-shadow:0 4px 16px rgba(0,0,0,.2);
      opacity:0; pointer-events:none;
      transform:translateY(8px);
      transition:opacity .3s ease, transform .3s ease;
    }
    .fab-hint.show{
      opacity:1; transform:translateY(0);
    }
    .fab-hint::after{
      content:''; position:absolute; top:100%; right:20px;
      width:0; height:0;
      border-left:6px solid transparent;
      border-right:6px solid transparent;
      border-top:6px solid #2D3436;
    }
    .discover-calendar-wrapper{
      padding:8px 0;
      border-top:1px solid rgba(0,0,0,.04);
      max-width:980px;
      margin:0 auto;
    }
    .discover-calendar-scroll{
      display:flex;
      gap:8px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding:0 14px;
      scrollbar-width:none;
    }
    .discover-calendar-scroll::-webkit-scrollbar{display:none}
    .toggle-switch{
      position:relative;
      width:64px;
      height:32px;
      background:#e0e0e0;
      border-radius:16px;
      border:none;
      cursor:pointer;
      transition:background 0.3s ease;
      display:flex;
      align-items:center;
      padding:4px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    .toggle-switch.active{
      background:var(--brand);
    }
    .toggle-icon{
      position:absolute;
      width:24px;
      height:24px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:opacity 0.3s ease, transform 0.3s ease;
      z-index:2;
    }
    .toggle-icon-list{
      left:4px;
      opacity:1;
    }
    .toggle-icon-match{
      right:4px;
      opacity:0.5;
    }
    .toggle-switch.active .toggle-icon-list{
      opacity:0.5;
    }
    .toggle-switch.active .toggle-icon-match{
      opacity:1;
    }
    .toggle-icon svg{
      width:18px;
      height:18px;
      stroke-width:2.5;
    }
    .toggle-slider{
      position:absolute;
      width:24px;
      height:24px;
      background:#fff;
      border-radius:50%;
      transition:transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:0 2px 4px rgba(0,0,0,0.2);
      left:4px;
      z-index:3;
    }
    .toggle-switch.active .toggle-slider{
      transform:translateX(32px);
    }
    
    /* Discover Header - Sticky mit zwei Ebenen */
    .discover-header-sticky{
      position:sticky; top:0; z-index:10;
      background:rgba(255,255,255,.98); backdrop-filter:blur(20px);
      border-bottom:1px solid rgba(0,0,0,.06);
      box-shadow:0 2px 8px rgba(0,0,0,.04);
    }
    
    /* Ebene 1: Quick-Filters */
    .discover-quick-filters{
      display:flex; align-items:center; gap:8px;
      padding:12px 14px; max-width:980px; margin:0 auto;
      flex-wrap:wrap;
    }
    
    .quick-filter-btn{
      display:flex; align-items:center; gap:6px;
      padding:10px 16px; border-radius:24px;
      border:1px solid rgba(0,0,0,.1);
      background:#fff; color:#333;
      font-size:14px; font-weight:600;
      cursor:pointer; transition:all 0.2s ease;
      white-space:nowrap;
      box-shadow:0 2px 4px rgba(0,0,0,.05);
    }
    .quick-filter-btn i{
      width:18px; height:18px; flex-shrink:0;
    }
    .quick-filter-btn:hover{
      background:#f8f8f8;
      transform:translateY(-1px);
      box-shadow:0 4px 8px rgba(0,0,0,.08);
    }
    .quick-filter-btn.active{
      background:var(--brand);
      color:#2D3436; border-color:var(--brand);
      font-weight:700;
      box-shadow:0 4px 12px rgba(255,204,0,0.3);
    }
    
    .discover-header{
      position:relative;
    }
    /* Kompakte Standort-Pill (44-48px) */
    .discover-location-pill{
      display:flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:24px;
      background:rgba(0,0,0,.04); border:1px solid rgba(0,0,0,.08);
      height:44px; box-sizing:border-box;
    }
    .discover-location-icon-left{
      width:18px; height:18px; flex-shrink:0; opacity:.7;
      color:#666;
    }
    .discover-location-input{
      flex:1; border:none; background:transparent;
      font-size:15px; font-weight:500; color:#333;
      outline:none; min-width:0;
    }
    .discover-location-input::placeholder{
      color:#999; font-weight:400;
    }
    .discover-location-btn{
      width:32px; height:32px; border-radius:50%;
      border:none; background:transparent;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; transition:background .2s;
      flex-shrink:0;
    }
    .discover-location-btn:hover{
      background:rgba(0,0,0,.05);
    }
    .discover-location-btn i{
      width:18px; height:18px; color:#666;
    }
    
    /* Kategorien (horizontal swipebar, ohne Überschrift) */
    .discover-categories{
      padding:12px 0 8px;
      max-width:980px; margin:0 auto;
    }
    .discover-categories-scroll{
      display:flex; gap:10px; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding:0 16px 0 16px; scrollbar-width:none;
      /* Letztes Element leicht abgeschnitten für Scroll-Hinweis */
      padding-right:calc(16px + 20%);
    }
    .discover-categories-scroll::-webkit-scrollbar{display:none}
    .discover-category-chip{
      flex:0 0 auto; padding:8px 16px;
      height:40px; border-radius:999px; border:1px solid rgba(0,0,0,.15);
      font-size:14px; font-weight:700;
      background:#f5f5f5; color:#666;
      cursor:pointer; transition:all .2s;
      white-space:nowrap;
      display:flex; align-items:center; justify-content:center;
    }
    .discover-category-chip.active{
      background:#FFD700; color:#2D3436;
      border-color:#FFD700;
      box-shadow:0 2px 8px rgba(255,215,0,.3);
      font-weight:900;
    }
    .discover-category-chip:not(.active){
      border-color:rgba(0,0,0,.15);
      background:#f5f5f5;
    }
    .discover-category-chip:active{
      transform:scale(.96);
    }
    
    /* Kalender (horizontal swipebar, ohne Überschrift, distinct style) */
    .discover-calendar{
      padding:0 0 14px;
      max-width:980px; margin:0 auto;
      border-top:1px solid rgba(0,0,0,.06);
      margin-top:4px;
      padding-top:10px;
    }
    .discover-calendar-scroll{
      display:flex; gap:8px; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding:0 14px; scrollbar-width:none;
    }
    .discover-calendar-scroll::-webkit-scrollbar{display:none}
    .discover-day{
      flex:0 0 auto; padding:8px 14px;
      border-radius:16px; border:1.5px solid rgba(0,0,0,.15);
      font-size:13px; font-weight:600;
      background:#fff; color:#666;
      cursor:pointer; transition:all .2s;
      white-space:nowrap;
      min-width:60px; text-align:center;
    }
    .discover-day.active{
      background:var(--brand); color:#000;
      border-color:var(--brand);
      box-shadow:0 2px 6px rgba(255,204,0,.25);
      font-weight:900;
    }
    .discover-day:active{
      transform:scale(.96);
    }
    
    /* Angebots-Liste Container */
    .discover-offers{
      padding:0 14px 24px;
      max-width:980px; margin:0 auto;
      display:flex; flex-direction:column; gap:12px;
    }
    /* List Cards - Horizontal Layout (kleines Bild links, Content rechts) */
    .discover-list-card{
      display:flex; gap:12px; padding:12px;
      background:#fff; border-radius:16px;
      box-shadow:0 1px 6px rgba(0,0,0,.06);
      cursor:pointer; transition:transform .1s, box-shadow .1s;
      border:1px solid rgba(0,0,0,.04);
    }
    .discover-list-card:active{
      transform:scale(.98);
      box-shadow:0 1px 4px rgba(0,0,0,.1);
    }
    .discover-list-image{
      flex:0 0 80px; width:80px; height:80px;
      border-radius:12px; overflow:hidden;
      background:#f0f0f0; flex-shrink:0;
    }
    .discover-list-image img{
      width:100%; height:100%; object-fit:cover;
    }
    .discover-list-content{
      flex:1; display:flex; flex-direction:column;
      min-width:0; gap:4px;
    }
    .discover-list-title{
      font-size:16px; font-weight:900; line-height:1.3;
      color:#111; margin:0;
      display:-webkit-box; -webkit-line-clamp:2;
      -webkit-box-orient:vertical; overflow:hidden;
    }
    .discover-list-provider{
      font-size:13px; font-weight:500; color:#666;
      margin:0; line-height:1.3;
    }
    .discover-list-meta{
      display:flex; align-items:center; gap:8px;
      margin-top:4px; flex-wrap:wrap;
    }
    .discover-list-price{
      font-size:18px; font-weight:900; color:var(--brand);
      margin:0;
    }
    .discover-list-info{
      font-size:12px; color:#999;
      display:flex; align-items:center; gap:4px;
    }
    .discover-list-info .ico-inline{
      width:16px; height:16px; flex-shrink:0;
      color:var(--muted);
    }
    .discover-list-info .ico-inline svg{
      width:16px; height:16px;
    }
    .discover-list-badges{
      display:flex; gap:6px; flex-wrap:wrap;
      margin-top:6px;
    }
    /* Premium Horizontale Gericht-Karte */
    .dish-card {
      display: flex;
      height: 160px;
      background: #ffffff;
      border-radius: 24px; /* rounded-3xl */
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.05);
      box-shadow: 0 4px 15px rgba(0,0,0,0.04);
      margin-bottom: 14px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
    }
    .dish-card:active {
      transform: scale(0.98);
    }
    .dish-card:hover {
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
    }
    /* Linke Seite: Bild - 50% der Karte */
    .dish-image-box {
      width: 50%;
      height: 160px;
      flex-shrink: 0;
      background: #f5f5f5;
    }
    .dish-image-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    /* Rechte Seite: Details */
    .dish-details {
      flex: 1;
      padding: 14px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    /* Obere Zeile: Name & Preis */
    .dish-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
    }
    .dish-name {
      font-size: 18px;
      font-weight: 900; /* Kräftiger */
      color: #111;
      line-height: 1.2;
      margin: 0;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Montserrat', 'Segoe UI', sans-serif;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .dish-price {
      font-size: 16px;
      font-weight: 700;
      color: #111;
      white-space: nowrap;
    }
    /* Mittlere Zeile: Anbieter */
    .dish-provider {
      font-size: 13px;
      color: #666;
      font-weight: 500;
      margin-top: 4px;
    }
    /* Untere Zeile: Meta & Buttons */
    .dish-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
    }
    .distance-badge {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 700;
      color: #444;
      background: #f0f0f0;
      padding: 4px 10px;
      border-radius: 8px;
    }
    .action-group {
      display: flex;
      gap: 8px;
    }
    .btn-icon {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: 1px solid #f0f0f0;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #111;
      transition: all 0.2s ease;
      cursor: pointer;
      flex-shrink: 0;
    }
    .btn-icon:hover {
      background: #f9f9f9;
    }
    .btn-icon.heart-btn:hover {
      color: #ff4757;
      border-color: #ffdce0;
    }
    .btn-icon.heart-btn.active {
      color: #ff4757;
      background: #ffdce0;
      border-color: #ff4757;
    }
    .discover-list-badge{
      display:inline-flex; align-items:center; gap:3px;
      padding:4px 8px; border-radius:6px;
      font-size:10px; font-weight:700;
      background:rgba(0,0,0,.05); color:#666;
    }
    .discover-list-badge .ico-inline{
      width:14px; height:14px; flex-shrink:0;
    }
    .discover-list-badge .ico-inline svg{
      width:14px; height:14px;
    }
    .discover-list-badge.code{
      background:rgba(255,204,0,.15); color:#b8860b;
    }
    .discover-list-badge.dine{
      background:rgba(31,157,85,.1); color:#1f9d55;
    }
    .discover-list-badge.pickup{
      background:rgba(0,0,0,.05); color:#666;
    }
    .discover-list-actions{
      margin-top:auto; padding-top:8px;
    }
    .discover-list-btn{
      width:100%; padding:10px 14px; border-radius:10px;
      border:none; font-weight:900; font-size:14px;
      cursor:pointer; transition:transform .1s, background .15s;
      text-align:center; background:var(--brand); color:#111;
      display:flex; align-items:center; justify-content:center; gap:6px;
    }
    .discover-list-btn .ico-inline{
      width:18px; height:18px; flex-shrink:0;
    }
    .discover-list-btn .ico-inline svg{
      width:18px; height:18px;
    }
    .discover-list-btn:active{
      transform:scale(.97);
      background:#e6b800;
    }
    
    /* SwipeCard Styles (Tinder-Style) - Premium Modern Design - Optimiert für Samsung S25 */
    .swipe-card{
      position:absolute; top:0; left:50%; transform:translateX(-50%);
      background:#fff; border-radius:24px;
      box-shadow:0 8px 32px rgba(0,0,0,.12), 0 0 0 1px rgba(0,0,0,.04);
      overflow:hidden; cursor:grab;
      user-select:none; touch-action:none;
      transition:transform .2s ease-out, opacity .2s, box-shadow .2s;
      will-change:transform;
      height:100%; max-height:100%;
      width:calc(100% - 32px);
      max-width:calc(100% - 32px);
      box-sizing:border-box;
    }
    /* Responsive für Samsung S25 (390x844) und ähnliche Geräte */
    @media (max-width:420px) and (min-height:800px){
      #discoverSwipe{
        height:calc(100vh - 220px) !important;
        min-height:480px !important;
        padding:12px 8px !important;
      }
      .swipe-card{
        border-radius:28px;
      }
      .swipe-card-image{
        min-height:360px !important;
      }
    }
    .swipe-card:active{
      cursor:grabbing;
      box-shadow:0 15px 45px rgba(0,0,0,.25), 0 0 0 1px rgba(0,0,0,.08);
    }
    .swipe-card.swiping{
      transition:none;
    }
    .swipe-card.swipe-left{
      transform:translateX(-100vw) rotate(-10deg);
      opacity:0;
      box-shadow:0 20px 50px rgba(227,77,77,0.3);
    }
    .swipe-card.swipe-right{
      transform:translateX(100vw) rotate(10deg);
      opacity:0;
      box-shadow:0 20px 50px rgba(31,157,85,0.3);
    }
    .swipe-card.match-left{
      box-shadow:0 20px 50px rgba(227,77,77,0.4);
      border:3px solid rgba(227,77,77,0.6);
    }
    .swipe-card.match-right{
      box-shadow:0 20px 50px rgba(31,157,85,0.4);
      border:3px solid rgba(31,157,85,0.6);
    }
    .swipe-card-image{
      width:100%; height:70%; min-height:400px;
      background:#f0f0f0; position:relative;
      overflow:hidden;
      border-radius:32px 32px 0 0;
    }
    .swipe-card-image img{
      width:100%; height:100%; object-fit:cover;
    }
    .swipe-card-content{
      padding:28px; height:30%;
      display:flex; flex-direction:column;
      justify-content:space-between;
      background:linear-gradient(to top, #fff 0%, rgba(255,255,255,0.95) 100%);
    }
    .swipe-card-title{
      font-size:36px; font-weight:900;
      margin:0 0 8px; line-height:1.2;
      color:#111;
      font-family:'Inter', 'Montserrat', sans-serif;
    }
    .swipe-card-provider{
      font-size:16px; color:#666;
      margin:0 0 16px; display:flex;
      align-items:center; gap:6px;
    }
    .swipe-card-meta{
      display:flex; align-items:center;
      gap:16px; margin-bottom:16px;
      flex-wrap:wrap;
    }
    .swipe-card-price{
      font-size:32px; font-weight:900;
      color:var(--brand);
    }
    .swipe-card-badges{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-bottom:16px;
    }
    .swipe-card-badge{
      padding:6px 12px; border-radius:8px;
      font-size:12px; font-weight:700;
      background:rgba(0,0,0,.05); color:#666;
    }
    .swipe-card-badge.code{
      background:rgba(255,204,0,.15); color:#b8860b;
    }
    .swipe-card-badge.dine{
      background:rgba(31,157,85,.1); color:#1f9d55;
    }
    .swipe-overlay{
      position:absolute; top:20px; left:20px; right:20px;
      z-index:10; pointer-events:none;
      font-size:32px; font-weight:900;
      text-align:center; opacity:0;
      transition:opacity .2s;
      padding:12px; border-radius:12px;
    }
    .swipe-overlay.show{opacity:1}
    .swipe-overlay.left{
      background:rgba(227,77,77,.9); color:#fff;
      transform:rotate(-15deg);
    }
    .swipe-overlay.right{
      background:rgba(31,157,85,.9); color:#fff;
      transform:rotate(15deg);
    }
    
    /* Back Navigation */
    .back-button{
      position:absolute; top:12px; left:12px;
      width:40px; height:40px;
      border-radius:50%; border:none;
      background:rgba(255,255,255,.9);
      backdrop-filter:blur(10px);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; z-index:10;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
    }
    .back-button i{
      width:20px; height:20px;
    }

    /* Chat-Bubbles Feed */
    .feed-container{
      max-width:980px; margin:0 auto; padding:0 16px 20px;
    }
    .chat-bubble{
      background:#fff; border:1px solid var(--border);
      border-radius:var(--radius); padding:16px;
      margin-bottom:16px; box-shadow:0 4px 12px rgba(0,0,0,.06);
      position:relative;
    }
    .chat-bubble-header{
      display:flex; align-items:center; gap:12px; margin-bottom:12px;
    }
    .chat-bubble-avatar{
      width:44px; height:44px; border-radius:50%;
      overflow:hidden; flex:0 0 auto;
      border:2px solid var(--border);
    }
    .chat-bubble-avatar img{
      width:100%; height:100%; object-fit:cover;
    }
    .chat-bubble-meta{
      flex:1; min-width:0;
    }
    .chat-bubble-name{
      font-weight:900; font-size:17px; margin-bottom:4px; line-height:1.3;
    }
    .chat-bubble-time{
      font-size:13px; color:var(--muted);
      display:flex; align-items:center; gap:6px; line-height:1.4;
    }
    .chat-bubble-distance{
      position:absolute; top:16px; right:16px;
      font-size:12px; font-weight:700; color:var(--muted);
      background:#f8f7f3; padding:5px 10px; border-radius:999px;
    }
    .chat-bubble-message{
      font-size:16px; line-height:1.6; color:var(--text);
      margin-bottom:14px;
    }
    .chat-bubble-image{
      width:100%; border-radius:16px; overflow:hidden;
      margin-bottom:12px; max-height:300px; object-fit:cover;
    }
    .chat-bubble-actions{
      display:flex; gap:10px; margin-top:12px;
    }
    .chat-bubble-btn{
      flex:1; padding:12px; border-radius:12px;
      border:none; font-weight:900; font-size:14px;
      cursor:pointer; transition:transform .1s;
    }
    .chat-bubble-btn:active{transform:scale(.98)}
    .chat-bubble-btn-primary{
      background:var(--brand); color:#111;
    }
    .chat-bubble-btn-secondary{
      background:#f8f7f3; border:1px solid var(--border); color:var(--text);
    }
    .feed-empty{
      max-width:980px; margin:0 auto;
    }
  </style>
</head>
<body>
<div class="app" id="app">
  <div class="topbar" id="topbar">
      <div class="topbar-inner">
        <div class="brand" role="button" aria-label="Mittagio" onclick="handleLogoClick();" style="cursor:pointer;">
          <div class="brand-badge"><img src="assets/mittagio-logo.png" alt="Mittagio" onerror="this.style.display='none'" /></div>
          <div class="brand-name">MITTAGIO</div>
        </div>
        <!-- View-Toggle oben rechts (nur in Discover-View sichtbar) -->
        <div class="discover-view-toggle-topbar" id="discoverViewToggleTopbar" style="display:none;">
          <button type="button" class="toggle-switch" id="toggleDiscoverViewTopbar" aria-label="Ansicht wechseln">
            <span class="toggle-icon toggle-icon-list">
              <i data-lucide="list"></i>
            </span>
            <span class="toggle-icon toggle-icon-match">
              <i data-lucide="flame"></i>
            </span>
            <span class="toggle-slider"></span>
          </button>
        </div>
      <div class="spacer"></div>
      <div id="modePill" class="prov-pill" style="display:none;">Dashboard</div>
    </div>
  </div>

  <main>
    <!-- START - Lunch-Feed (Social Style) -->
    <section class="view" id="v-start">
      <!-- Standort-Suche -->
      <div class="panel" style="margin-top:12px;">
        <div class="section-title">Entdecken</div>
        <div class="loc-row" style="margin-top:8px;">
          <input class="field" id="startLocationInput" type="text" placeholder="Ort oder PLZ eingeben" />
          <button class="pin-btn" type="button" id="btnStartLocationPin" aria-label="Standort setzen"></button>
        </div>
      </div>

      <!-- Filter: Kategorien und Tage -->
      <div style="height:10px"></div>
      <div class="hint" style="padding:0 14px;">Kategorien</div>
      <div class="chiprow" id="startCatChips"></div>
      <div class="hint" style="margin-top:6px; padding:0 14px;">Datum</div>
      <div class="dayrow" id="startDayChips"></div>
      <div class="answers" style="margin-top:6px; padding:0 14px;">
        <button class="ans" type="button" id="btnStartNear" data-icon="location">In der Nähe</button>
      </div>

      <!-- Angebots-Grid (normale Kacheln) -->
      <div class="section-title" style="margin-top:8px; padding:0 14px;">Heute in deiner Nähe</div>
      <div class="grid" id="startOfferGrid"></div>
      <p class="hint" id="startEmptyOffers" style="display:none; text-align:center; padding:40px 20px;">
        Noch keine Angebote. Demo: Als Anbieter ein Inserat erstellen.
      </p>
    </section>

    <!-- CUSTOMER: Discover - App-like UX (Final Spec) -->
    <section class="view active" id="v-discover">
      <!-- Header: Sticky mit Quick-Filters und Kategorien -->
      <div class="discover-header-sticky">
        <!-- Ebene 1: Quick-Filters (große Kapseln) -->
        <div class="discover-quick-filters">
          <div class="discover-location-pill">
            <i data-lucide="map-pin" class="discover-location-icon-left"></i>
            <input type="text" class="discover-location-input" id="discoverLocationInput" placeholder="Ort oder PLZ" />
            <button class="discover-location-btn" type="button" id="btnDiscoverLocationSearch" aria-label="Standort suchen">
              <i data-lucide="search"></i>
            </button>
          </div>
          <button class="quick-filter-btn" id="quickFilterNear" data-filter="near">
            <i data-lucide="navigation"></i>
            <span>In der Nähe</span>
          </button>
          <button class="quick-filter-btn" id="quickFilterToday" data-filter="today">
            <i data-lucide="calendar"></i>
            <span>Heute</span>
          </button>
        </div>
        
        <!-- Ebene 2: Datums-Leiste (horizontaler Scroller) -->
        <div class="discover-calendar-wrapper">
          <div class="discover-calendar-scroll" id="discoverCalendar">
            <!-- Wird dynamisch befüllt -->
          </div>
        </div>
        
        <!-- Ebene 3: Food-Kategorien (horizontal scrollbar) -->
        <div class="discover-categories-wrapper">
          <div class="discover-categories-scroll" id="discoverCategories">
            <!-- Wird dynamisch befüllt -->
          </div>
        </div>
      </div>


      <!-- Angebots-Liste (horizontale List-Cards) -->
      <div class="discover-offers" id="discoverOffers">
        <!-- Wird dynamisch befüllt -->
      </div>
      
      <!-- Swipe-Stack (Tinder-Style) -->
      <div id="discoverSwipe" style="display:none; position:relative; height:80vh; min-height:500px; max-height:600px; max-width:400px; margin:0 auto; padding:20px 0;">
        <div id="swipeStack" style="position:relative; width:100%; height:100%;">
          <!-- SwipeCards werden hier eingefügt -->
        </div>
        <div id="swipeEmpty" style="display:none; text-align:center; padding:80px 20px; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);">
          <div style="font-size:64px; margin-bottom:20px; opacity:.6;">🍽️</div>
          <div style="font-size:18px; font-weight:900; margin-bottom:10px; color:#333; line-height:1.4;">
            Keine weiteren Angebote
          </div>
          <button class="btn secondary" type="button" onclick="switchDiscoverView('list')" style="margin-top:20px;">
            Zur Liste wechseln
          </button>
        </div>
      </div>
      
      <!-- Leerer Zustand (wenn keine Angebote) -->
      <div id="discoverEmpty" style="display:none; text-align:center; padding:80px 20px;">
        <div style="font-size:64px; margin-bottom:20px; opacity:.6;">🍽️</div>
        <div style="font-size:18px; font-weight:900; margin-bottom:10px; color:#333; line-height:1.4;">
          Noch keine Mittagsangebote in deiner Nähe
        </div>
        <div style="display:flex; flex-direction:column; gap:12px; max-width:280px; margin:24px auto 0;">
          <button class="btn" type="button" onclick="const q=prompt('Neuer Standort:'); if(q){locationQuery=q; renderDiscover();}" style="width:100%;">
            Standort ändern
          </button>
          <button class="btn secondary" type="button" onclick="setMode('provider')" style="width:100%;">
            Als Anbieter starten
          </button>
        </div>
      </div>
    </section>

    <section class="view" id="v-provider-billing">
      <!-- Kosten-Info-Box (ganz oben) -->
      <div class="panel" id="billingCostInfo" style="background:#f0f7f0; border:1px solid #4caf50; margin-bottom:12px;">
        <!-- Wird dynamisch befüllt -->
      </div>
      
      <div class="panel">
        <h3>Abrechnungen</h3>
        <div class="hint">Auszahlbarer Betrag</div>
        <div style="font-size:24px;font-weight:900" id="billingAmount">0,00 €</div>
        <div class="hint" id="billingLast">Letzte Auszahlung: –</div>
      </div>

      <div style="height:12px"></div>
      <div class="panel">
        <div class="hint">Filter</div>
        <div class="answers" id="billingFilters"></div>
        <div style="height:8px"></div>
        <select class="field" id="billingMonth">
          <option value="2026-01">Januar 2026</option>
          <option value="2025-12">Dezember 2025</option>
          <option value="2025-11">November 2025</option>
        </select>
        <div style="height:10px"></div>
        <div id="billingList" class="hint">Noch keine Abrechnungen.</div>
      </div>

      <div style="height:12px"></div>
      <button class="btn ghost" type="button" id="btnBillingBack">Zurück</button>
    </section>

    <!-- CUSTOMER: Favorites -->
    <section class="view" id="v-fav">
      <div class="panel">
        <!-- Empty State (wenn beide Listen leer) -->
        <div id="favEmptyState" style="display:none; flex-direction:column; align-items:center; text-align:center; padding:60px 20px; gap:24px;">
          <div style="width:120px; height:120px; background:linear-gradient(135deg, rgba(255,215,0,0.1) 0%, rgba(255,184,0,0.15) 100%); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:64px; flex-shrink:0;">
            ❤️
          </div>
          <div style="display:flex; flex-direction:column; align-items:center; gap:12px; max-width:100%;">
            <h3 style="font-size:22px; font-weight:900; margin:0; color:#111; font-family:'Inter', 'Montserrat', sans-serif; line-height:1.3;">Noch keine Favoriten</h3>
            <p style="font-size:15px; color:#666; margin:0; line-height:1.6; max-width:320px; padding:0 12px;">Zeit, dich zu verlieben! Entdecke leckere Gerichte und markiere deine Favoriten.</p>
          </div>
          <button class="btn-primary" type="button" onclick="showDiscover();" style="width:100%; max-width:280px; min-height:52px; font-size:16px; font-weight:700; margin-top:8px;">
            <i data-lucide="compass" style="width:20px;height:20px;"></i> <span>Jetzt Gerichte entdecken</span>
          </button>
        </div>
        
        <div id="favContent">
          <div class="section-title" id="sectionProviders" style="display:none;">Anbieter-Favoriten</div>
          <div class="grid" id="favProviders"></div>
          <div class="hint" id="emptyFavProviders" style="display:none; text-align:center; padding:32px;">
            <div style="width:80px; height:80px; margin:0 auto 16px; background:rgba(0,0,0,0.03); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:40px; opacity:0.6;">🍽️</div>
            <p style="font-size:14px; color:#666; margin:0;">Noch keine Anbieter-Favoriten</p>
          </div>
          <div class="section-title" id="sectionDishes" style="display:none; margin-top:24px;">Gericht-Favoriten</div>
          <div class="grid" id="favDishes"></div>
          <div class="hint" id="emptyFavDishes" style="display:none; text-align:center; padding:32px;">
            <div style="width:80px; height:80px; margin:0 auto 16px; background:rgba(0,0,0,0.03); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:40px; opacity:0.6;">🍴</div>
            <p style="font-size:14px; color:#666; margin:0;">Noch keine Gericht-Favoriten</p>
          </div>
        </div>
      </div>
    </section>

    <!-- CUSTOMER: Orders -->
    <section class="view" id="v-orders">
      <div class="panel">
        <h3>Aktive Abholnummern</h3>
        <div class="hint">Deine aktiven Abholnummern</div>
        <div class="answers" id="ordersFilters" style="margin-top:12px;"></div>
        <div style="height:10px"></div>
        <div id="ordersList" class="hint">Noch keine Bestellungen.</div>
      </div>
    </section>

    <!-- CUSTOMER: Cart -->
    <section class="view" id="v-cart">
      <div style="padding:16px; padding-bottom:calc(90px + env(safe-area-inset-bottom, 0px));">
        <!-- Aktive Tickets (Wallet-Look) -->
        <div class="panel" id="cartActiveTickets" style="margin-bottom:16px; padding:20px; display:none; border-radius:24px; box-shadow:0 4px 16px rgba(0,0,0,.08); background:rgba(255,255,255,0.98); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); border:2px dashed rgba(255,184,0,0.3); position:relative;">
          <h3 style="font-weight:900; font-size:22px; margin:0 0 20px; line-height:1.3; color:#2D3436; display:flex; align-items:center; gap:10px;">
            <span style="font-size:28px;">🎫</span>
            <span>Aktive Abholnummern</span>
          </h3>
          <div id="cartActiveTicketsList" style="display:flex; flex-direction:column; gap:16px;"></div>
        </div>
        
        <!-- Warenkorb -->
        <div class="panel" style="padding:20px; border-radius:24px; box-shadow:0 4px 16px rgba(0,0,0,.08); background:rgba(255,255,255,0.95); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);">
          <h3 style="font-weight:900; font-size:24px; margin:0 0 20px; line-height:1.3; color:#2D3436;">Meine Mittagsbox</h3>
          <div id="cartBox" class="hint">Deine Mittagsbox ist leer.</div>
          <button class="btn" id="btnCheckout" type="button" style="display:none; width:100%; min-height:56px; font-size:18px; font-weight:800; margin-top:20px; background:#FFB800; color:#2D3436; border:none; border-radius:16px; box-shadow:0 4px 16px rgba(255,184,0,0.25);" data-icon="card">
            <i data-lucide="ticket" style="width:22px;height:22px;"></i>
            <span>Abholnummer jetzt sichern</span>
          </button>
          <div class="mini" id="cartNote" style="display:none; margin-top:12px; padding:12px; background:rgba(255,184,0,0.08); border-radius:12px; font-size:12px; color:#666; line-height:1.5; text-align:center;">
            Du erhältst deine Abholnummer direkt nach der Bestätigung.
          </div>
          <!-- Trust-Icons (horizontal) -->
          <div id="cartTrustIcons" style="display:none; margin-top:16px; display:flex; justify-content:center; gap:24px; padding:12px 0; border-top:1px solid rgba(0,0,0,.06);">
            <div style="display:flex; flex-direction:column; align-items:center; gap:6px;">
              <i data-lucide="shield-check" style="width:24px;height:24px; color:#1f9d55;"></i>
              <span style="font-size:11px; color:#666; font-weight:600;">Sichere Zahlung</span>
            </div>
            <div style="display:flex; flex-direction:column; align-items:center; gap:6px;">
              <i data-lucide="store" style="width:24px;height:24px; color:#666;"></i>
              <span style="font-size:11px; color:#666; font-weight:600;">Ein Anbieter</span>
            </div>
            <div style="display:flex; flex-direction:column; align-items:center; gap:6px;">
              <i data-lucide="ticket" style="width:24px;height:24px; color:#FFD700;"></i>
              <span style="font-size:11px; color:#666; font-weight:600;">Abholnummer sofort</span>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- CUSTOMER: One-Page Checkout (Checkout-Turbo) -->
    <section class="view" id="v-checkout" style="display:none;">
      <div style="padding:16px; padding-bottom:calc(90px + env(safe-area-inset-bottom, 0px));">
        <div class="panel" style="padding:20px; border-radius:24px; box-shadow:0 4px 16px rgba(0,0,0,.08); background:rgba(255,255,255,0.95); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);">
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
            <button class="back-button" type="button" id="btnCheckoutBack" aria-label="Zurück" style="background:none; border:none; padding:8px; cursor:pointer;">
              <i data-lucide="arrow-left"></i>
            </button>
            <h3 style="margin:0; flex:1; font-weight:900; font-size:24px; color:#2D3436;">Zahlung</h3>
          </div>
          
          <!-- Bestellübersicht -->
          <div id="checkoutSummary" style="margin-bottom:16px; padding:16px; background:#f8f9fa; border-radius:16px;">
            <!-- Wird dynamisch befüllt -->
          </div>
          
          <!-- Abholzeit-Auswahl (15-Minuten-Takt) -->
          <div style="margin-bottom:24px;">
            <label style="display:block; font-weight:700; font-size:15px; margin-bottom:12px; color:#2D3436;">Wann holst du dein Essen ab?</label>
            <div id="checkoutTimeSlots" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-bottom:12px;">
              <!-- Wird dynamisch befüllt -->
            </div>
            <button type="button" id="btnOtherTime" class="time-chip-alternative" style="width:100%; min-height:44px; margin-top:8px; background:#f0f0f0; border:2px dashed #e7e1d5; border-radius:12px; color:#666; font-size:14px; font-weight:600; cursor:pointer; transition:all 0.2s ease; display:flex; align-items:center; justify-content:center; gap:8px;" onmouseover="this.style.borderColor='#FFB800'; this.style.background='rgba(255,184,0,0.1)'; this.style.color='#2D3436';" onmouseout="this.style.borderColor='#e7e1d5'; this.style.background='#f0f0f0'; this.style.color='#666';">
              <i data-lucide="clock" style="width:18px;height:18px;"></i>
              <span>🕒 Andere Zeit</span>
            </button>
            <div id="customTimeInputWrapper" style="display:none; margin-top:15px; padding:15px; background:#fff9e6; border-radius:12px; text-align:center;">
              <input type="time" id="checkoutPickupTimeCustom" min="11:30" max="14:00" style="width:100%; padding:14px; border:2px solid #FFD700; border-radius:12px; font-size:18px; font-weight:700; background:#fff; text-align:center; margin-bottom:8px;" />
              <p class="hint" style="font-size:12px; color:#666; margin:0; line-height:1.5;">Bitte zwischen 11:30 und 14:00 Uhr wählen</p>
            </div>
            <input type="hidden" id="checkoutPickupTime" value="${cart && cart.pickupTime ? cart.pickupTime : ''}" />
          </div>
          
          <!-- Kontaktdaten (minimal) -->
          <div style="margin-bottom:24px;">
            <label style="display:block; font-weight:700; font-size:15px; margin-bottom:12px; color:#2D3436;">Name (für Abholung)</label>
            <input type="text" id="checkoutName" placeholder="Dein Name" style="width:100%; padding:14px; border:2px solid #e7e1d5; border-radius:12px; font-size:16px; background:#fff;" />
          </div>
          
          <div style="margin-bottom:24px;">
            <label style="display:block; font-weight:700; font-size:15px; margin-bottom:12px; color:#2D3436;">E-Mail (optional, für Beleg)</label>
            <input type="email" id="checkoutEmail" placeholder="email@beispiel.de" style="width:100%; padding:14px; border:2px solid #e7e1d5; border-radius:12px; font-size:16px; background:#fff;" />
          </div>
          
          <!-- Zahlungsmethoden -->
          <div style="margin-bottom:24px;">
            <label style="display:block; font-weight:700; font-size:15px; margin-bottom:12px; color:#2D3436;">Zahlungsart</label>
            <div id="checkoutPaymentMethods" style="display:flex; flex-direction:column; gap:12px;">
              <!-- Apple Pay / Google Pay Buttons (wenn verfügbar) -->
              <button class="btn" type="button" id="btnApplePay" style="display:none; width:100%; min-height:56px; background:#000; color:#fff; border:none; border-radius:12px; font-size:16px; font-weight:700; margin-bottom:8px;">
                <span style="font-size:20px;">🍎</span> Apple Pay
              </button>
              <button class="btn" type="button" id="btnGooglePay" style="display:none; width:100%; min-height:56px; background:#4285F4; color:#fff; border:none; border-radius:12px; font-size:16px; font-weight:700; margin-bottom:8px;">
                <span style="font-size:20px;">G</span> Google Pay
              </button>
              <!-- Standard Zahlung -->
              <button class="btn" type="button" id="btnStandardPayment" style="width:100%; min-height:56px; background:#FFB800; color:#2D3436; border:none; border-radius:12px; font-size:16px; font-weight:800; box-shadow:0 4px 16px rgba(255,184,0,0.25);">
                <i data-lucide="credit-card"></i> <span>Mit Karte bezahlen</span>
              </button>
            </div>
          </div>
          
          <!-- Guest-Checkout Hinweis -->
          <div style="padding:16px; background:rgba(255,184,0,0.08); border-radius:12px; font-size:13px; color:#666; line-height:1.5; text-align:center; margin-top:20px;">
            Kein Account nötig. Nach dem Kauf kannst du optional ein Passwort festlegen, um Belege zu speichern.
          </div>
        </div>
      </div>
    </section>

    <!-- CUSTOMER: Pickup Code (Abholnummer-Screen) -->
    <section class="view" id="v-pickup-code">
      <div class="panel">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
          <button class="back-button" type="button" id="btnPickupCodeBack" aria-label="Zurück">
            <i data-lucide="arrow-left"></i>
          </button>
          <h3 style="margin:0; flex:1;">Abholnummer</h3>
        </div>
        
        <!-- Status & Hinweis -->
        <div style="text-align:center; margin-bottom:24px;">
          <div style="font-size:16px; font-weight:700; color:#1f9d55; margin-bottom:8px;">
            ✓ Bestellung bestätigt
          </div>
          <div class="hint" style="font-size:13px;">
            Zeige diese Abholnummer beim Abholen
          </div>
        </div>
        
        <!-- Code-Kachel (groß & gut lesbar) -->
        <div id="pickupCodeCard" style="background:#fff; border:3px solid var(--brand); border-radius:20px; padding:32px; text-align:center; margin-bottom:20px; box-shadow:0 4px 16px rgba(255,215,0,0.2);">
          <div class="hint" style="font-size:13px; margin-bottom:12px; color:#666; font-weight:600;">Abholnummer</div>
          <div id="pickupCodeValue" style="font-size:64px; font-weight:900; font-family:monospace; letter-spacing:6px; color:#2D3436; margin-bottom:16px; line-height:1;">
            –
          </div>
          <button class="btn secondary" type="button" id="btnCopyCode" style="width:100%; min-height:44px;">
            <i data-lucide="copy"></i> Abholnummer kopieren
          </button>
        </div>
        
        <!-- Primary CTA: Code groß anzeigen -->
        <button class="btn" type="button" id="btnShowFullscreenCode" style="width:100%; margin-bottom:16px; min-height:44px;">
          <i data-lucide="maximize-2"></i> Abholnummer groß anzeigen
        </button>
        
        <!-- Bestellinfos kompakt -->
        <div id="pickupCodeInfo" style="background:#f8f8f8; border-radius:14px; padding:16px; margin-bottom:16px;">
          <div class="row" style="margin-bottom:8px;"><span>Gericht</span><b id="pickupCodeDish">–</b></div>
          <div class="row" style="margin-bottom:8px;"><span>Anbieter</span><b id="pickupCodeProvider">–</b></div>
          <div class="row" style="margin-bottom:8px;"><span>Abholzeit</span><b id="pickupCodeTime">–</b></div>
          <div class="row" style="margin-bottom:8px;"><span>Art</span><b id="pickupCodeType">–</b></div>
          <div class="row" style="margin-top:12px; padding-top:12px; border-top:1px solid #ddd;"><span style="font-size:16px; font-weight:900;">Gesamt</span><b style="font-size:16px;" id="pickupCodeTotal">–</b></div>
        </div>
        
        <!-- Secondary Buttons -->
        <div style="display:flex; flex-direction:column; gap:10px;">
          <button class="btn secondary" type="button" id="btnOpenRoute" style="width:100%; min-height:44px;">
            <i data-lucide="map-pin"></i> Route öffnen
          </button>
          <button class="btn ghost" type="button" id="btnToOrders" style="width:100%; min-height:44px;">
            <i data-lucide="ticket"></i> Zu meinen Abholnummern
          </button>
        </div>
      </div>
    </section>

    <!-- CUSTOMER: Profile ("Mein Mittagio") - Zalando-Prinzip -->
    <section class="view" id="v-profile">
      <!-- Header-Card (Identität) -->
      <div class="panel" id="profileHeaderCard" style="margin-top:0; padding:20px; border-radius:24px; box-shadow:0 4px 16px rgba(0,0,0,.08); background:linear-gradient(135deg, rgba(255,215,0,0.1) 0%, rgba(255,184,0,0.05) 100%);">
        <!-- Wird dynamisch befüllt -->
      </div>

      <!-- Quick-History (Aktive Tickets) -->
      <div class="panel" id="profileTicketsSection" style="margin-top:20px; padding:20px; border-radius:20px; box-shadow:0 2px 12px rgba(0,0,0,.06); display:none;">
        <div style="font-weight:900; font-size:18px; margin-bottom:16px; color:#2D3436; display:flex; align-items:center; gap:8px;">
          <i data-lucide="ticket" style="width:20px;height:20px; color:#FFD700;"></i>
          <span>Meine heutigen Tickets</span>
        </div>
        <div id="profileActiveTicketsList" style="display:flex; flex-direction:column; gap:12px;">
          <!-- Wird dynamisch befüllt -->
        </div>
      </div>

      <!-- Ernährungs-Zentrale (Präferenzen) -->
      <div class="panel" id="profileDietSection" style="margin-top:20px; padding:20px; border-radius:20px; box-shadow:0 2px 12px rgba(0,0,0,.06);">
        <div style="font-weight:900; font-size:18px; margin-bottom:16px; color:#2D3436; display:flex; align-items:center; gap:8px;">
          <i data-lucide="leaf" style="width:20px;height:20px; color:#1f9d55;"></i>
          <span>Ernährungs-Präferenzen</span>
        </div>
        <div class="hint" style="font-size:13px; color:#666; margin-bottom:20px; line-height:1.5;">
          Diese Einstellungen filtern automatisch deinen "Entdecken"-Feed, sodass dir nur Essen angezeigt wird, das du auch wirklich magst.
        </div>
        <div id="profileDietSwitches" style="display:flex; flex-direction:column; gap:16px;">
          <!-- Wird dynamisch befüllt -->
        </div>
      </div>

      <!-- Support & Vertrauen -->
      <div class="panel" id="profileSupportSection" style="margin-top:20px; padding:20px; border-radius:20px; box-shadow:0 2px 12px rgba(0,0,0,.06);">
        <div style="font-weight:900; font-size:18px; margin-bottom:16px; color:#2D3436;">Support & Vertrauen</div>
        <div id="profileSupportList" style="display:flex; flex-direction:column; gap:0;">
          <!-- Wird dynamisch befüllt -->
        </div>
      </div>

      <!-- Business-Card: Für Partner -->
      <div class="panel" id="profileBusinessCard" style="margin-top:20px; padding:24px; background:linear-gradient(135deg, rgba(255,204,0,.12) 0%, rgba(255,184,0,.06) 100%); border:2px solid rgba(255,204,0,.2); border-radius:24px; box-shadow:0 4px 16px rgba(255,204,0,0.15); position:relative; overflow:hidden;">
        <!-- Dekoratives Icon -->
        <div style="position:absolute; top:16px; right:16px; width:64px; height:64px; background:rgba(255,204,0,0.15); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:32px; opacity:0.6;">
          🏪
        </div>
        <div style="position:relative; z-index:1;">
          <div style="font-weight:900; font-size:20px; margin-bottom:6px; line-height:1.3; color:#2D3436; display:flex; align-items:center; gap:8px;">
            <i data-lucide="store" style="width:22px;height:22px; color:#FFD700;"></i>
            <span>MITTAGIO Business</span>
          </div>
          <div class="hint" style="font-size:14px; line-height:1.5; margin-bottom:20px; color:#666; max-width:280px;">
            Biete deine Mittagstische online an und erreiche mehr Gäste.
          </div>
          <button class="btn-primary" type="button" id="btnProviderBusinessLogin" style="width:100%; min-height:52px; font-size:16px; font-weight:700; box-shadow:0 4px 12px rgba(255,204,0,0.3);">
            <i data-lucide="log-in" style="width:20px;height:20px;"></i>
            <span id="btnProviderBusinessLoginText">Jetzt als Anbieter einloggen</span>
          </button>
        </div>
      </div>

      <!-- FAQ (reduced) -->
      <div class="panel" style="margin-top:18px; padding:16px; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.04);">
        <div style="font-weight:600; font-size:17px; margin-bottom:12px; line-height:1.3;">Häufige Fragen</div>
        <div class="faq" id="profileFaqReduced" style="margin-bottom:12px;">
          <details>
            <summary style="font-size:14px; line-height:1.4; font-weight:500;">Wie funktioniert Mittagio?</summary>
            <p style="font-size:14px; line-height:1.5; margin-top:8px; color:var(--muted);">Du findest Mittagsangebote in deiner Stadt, optional bezahlst du online und holst zur gewählten Zeit ab.</p>
          </details>
          <details>
            <summary>Ist Online-Zahlung Pflicht?</summary>
            <p>Nein. Online-Zahlung ist optional. Eine Abholnummer gibt’s nur bei Online-Zahlung.</p>
          </details>
          <details>
            <summary>Was ist die Abholnummer?</summary>
            <p>Deine Abholnummer für die Mittagspause.</p>
          </details>
          <details>
            <summary>Kann ich ohne Ticket bestellen?</summary>
            <p>Nein. Angebote ohne Ticket kannst du nur ansehen.</p>
          </details>
          <details>
            <summary>Wann kann ich abholen?</summary>
            <p>Innerhalb der Essenszeit. Wähle eine ungefähre Abholzeit in deiner Mittagsbox.</p>
          </details>
          <details>
            <summary>Kann ich für mehrere Personen bestellen?</summary>
            <p>Ja. Du kannst mehrere Gerichte in einem Vorgang bestellen (eine Abholnummer).</p>
          </details>
          <details>
            <summary>Vor Ort essen möglich?</summary>
            <p>Wenn das Badge „Vor Ort“ angezeigt wird, kannst du vor Ort essen.</p>
          </details>
          <details>
            <summary>Teilen</summary>
            <p>Teile Angebote per WhatsApp, Instagram oder Website.</p>
          </details>
          <details>
            <summary>Kontakt</summary>
            <p>Bei Fragen schreib uns an <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a></p>
          </details>
        </div>
        <a href="#" id="btnProfileShowMoreFaq" style="display:inline-block; font-size:13px; color:var(--muted); text-decoration:none; margin-top:4px;">
          Weitere Fragen anzeigen →
        </a>
      </div>

      <!-- Legal (bottom, small) -->
      <div style="margin-top:20px; padding:16px 16px 24px; text-align:center;">
        <div style="display:flex; flex-wrap:wrap; justify-content:center; gap:12px 16px; font-size:12px; margin-bottom:10px;">
          <a href="#/impressum" id="btnProfileImpressum" onclick="showLegalPage('impressum'); return false;" style="color:var(--muted); text-decoration:none;">Impressum</a>
          <a href="#/agb-kurz" id="btnProfileAGB" onclick="showLegalPage('agb-kurz'); return false;" style="color:var(--muted); text-decoration:none;">AGB</a>
          <a href="#/datenschutz" id="btnProfileDatenschutz" onclick="showLegalPage('datenschutz'); return false;" style="color:var(--muted); text-decoration:none;">Datenschutz</a>
        </div>
        <div style="font-size:12px; color:var(--muted);">
          <a href="mailto:info@mittagio.de" style="color:var(--muted); text-decoration:none;">info@mittagio.de</a>
        </div>
      </div>
    </section>

    <!-- PROVIDER: Login page (für direkten Zugriff) -->
    <section class="view" id="v-provider-login">
      <div class="panel">
        <h3>Anbieter-Login</h3>
        <div class="hint">Melde dich als Gastronom an</div>
        <input class="field" id="provEmail" type="email" placeholder="E-Mail" autocomplete="email" style="margin-top:12px;" />
        <div style="height:10px"></div>
        <input class="field" id="provPass" type="password" placeholder="Passwort" autocomplete="current-password" />
        <button class="btn" type="button" id="btnProvLogin" style="margin-top:16px;">Einloggen</button>
        <button class="btn secondary" type="button" id="btnProvBack" style="margin-top:8px;">Zurück</button>
        <p class="hint" style="margin-top:12px;">Demo: beliebige E-Mail/Passwort -> du bist drin. (Später: Firebase Auth.)</p>
      </div>
    </section>

    <!-- PROVIDER: Onboarding (ALT - wird durch Hybrid Onboarding ersetzt) -->
    <section class="view" id="v-provider-onboarding" style="display:none;">
      <!-- Schritt 1: Betriebsname -->
      <div class="panel onboarding-step" data-step="1">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 1 von 5</div>
          <button class="btn ghost" type="button" id="btnOnboardingBack" style="width:auto; padding:8px 12px; margin-top:8px;">
            ← Zurück
          </button>
        </div>
        <h3 style="margin-top:16px;">Wie heißt dein Betrieb?</h3>
        <div class="hint">Gib den Namen deines Restaurants, Cafés oder Betriebs ein.</div>
        <input class="field" id="onboardingBusinessNameOld" type="text" placeholder="z.B. Café Sonnenschein" style="margin-top:12px;" />
        <button class="btn" type="button" id="btnOnboardingStep1Next" style="margin-top:16px;">Weiter</button>
      </div>

      <!-- Schritt 2: Adresse -->
      <div class="panel onboarding-step" data-step="2" style="display:none;">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 2 von 5</div>
          <button class="btn ghost" type="button" id="btnOnboardingStep2Back" style="width:auto; padding:8px 12px; margin-top:8px;">
            ← Zurück
          </button>
        </div>
        <h3 style="margin-top:16px;">Adresse deines Betriebs</h3>
        <div class="hint">Wo können Gäste dein Essen abholen?</div>
        <div class="loc-row" style="margin-top:12px;">
          <input class="field" id="onboardingAddress" type="text" placeholder="Straße und Hausnummer" />
          <button class="pin-btn" type="button" id="btnOnboardingLocationPin" aria-label="Standort setzen"></button>
        </div>
        <input class="field" id="onboardingPostalCode" type="text" placeholder="PLZ" style="margin-top:10px;" />
        <input class="field" id="onboardingCity" type="text" placeholder="Stadt" style="margin-top:10px;" />
        <button class="btn" type="button" id="btnOnboardingStep2Next" style="margin-top:16px;">Weiter</button>
      </div>

      <!-- Schritt 3: Essenszeit -->
      <div class="panel onboarding-step" data-step="3" style="display:none;">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 3 von 5</div>
          <button class="btn ghost" type="button" id="btnOnboardingStep3Back" style="width:auto; padding:8px 12px; margin-top:8px;">
            ← Zurück
          </button>
        </div>
        <h3 style="margin-top:16px;">Wann können Gäste dein Essen genießen?</h3>
        <div class="hint">Wähle die Standard-Zeiten für deine Essensausgabe.</div>
        
        <div style="margin-top:16px;">
          <div class="hint" style="margin-bottom:6px;">Startzeit</div>
          <div class="w-actions">
            <button class="btn secondary time-btn" type="button" data-time="11:00">11:00</button>
            <button class="btn secondary time-btn" type="button" data-time="11:30">11:30</button>
            <button class="btn secondary time-btn" type="button" data-time="12:00">12:00</button>
            <button class="btn secondary time-btn" type="button" data-time="12:30">12:30</button>
          </div>
          <input class="field" id="onboardingMealStart" type="time" placeholder="Startzeit" style="margin-top:10px;" />
        </div>

        <div style="margin-top:16px;">
          <div class="hint" style="margin-bottom:6px;">Endzeit</div>
          <div class="w-actions">
            <button class="btn secondary time-btn" type="button" data-time="14:00">14:00</button>
            <button class="btn secondary time-btn" type="button" data-time="14:30">14:30</button>
            <button class="btn secondary time-btn" type="button" data-time="15:00">15:00</button>
            <button class="btn secondary time-btn" type="button" data-time="15:30">15:30</button>
          </div>
          <input class="field" id="onboardingMealEnd" type="time" placeholder="Endzeit" style="margin-top:10px;" />
        </div>

        <button class="btn" type="button" id="btnOnboardingStep3Next" style="margin-top:20px;">Weiter</button>
      </div>

      <!-- Schritt 4: Logo -->
      <div class="panel onboarding-step" data-step="4" style="display:none;">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 4 von 5</div>
          <button class="btn ghost" type="button" id="btnOnboardingStep4Back" style="width:auto; padding:8px 12px; margin-top:8px;">
            ← Zurück
          </button>
        </div>
        <h3 style="margin-top:16px;">Logo hochladen</h3>
        <div class="hint">Optional: Lade ein Logo für deinen Betrieb hoch. Du kannst das auch später machen.</div>
        
        <div style="margin-top:20px; text-align:center;">
          <div class="onboarding-logo-preview" id="onboardingLogoPreview" style="width:120px; height:120px; margin:0 auto; border-radius:18px; border:2px dashed var(--border); background:#f8f7f3; display:flex; align-items:center; justify-content:center; cursor:pointer; position:relative; overflow:hidden;">
            <div style="text-align:center; color:var(--muted); font-size:12px;">
              <div style="font-size:32px; margin-bottom:8px;">📷</div>
              <div>Logo hinzufügen</div>
            </div>
            <img id="onboardingLogoImg" style="display:none; width:100%; height:100%; object-fit:cover;" />
          </div>
          <input type="file" id="onboardingLogoInput" accept="image/*" style="display:none;" />
          <button class="btn secondary" type="button" id="btnOnboardingLogoRemove" style="margin-top:12px; display:none;">Logo entfernen</button>
        </div>

        <button class="btn" type="button" id="btnOnboardingStep4Next" style="margin-top:20px;">Weiter</button>
        <button class="btn ghost" type="button" id="btnOnboardingSkipLogo" style="margin-top:8px;">Überspringen</button>
      </div>

      <!-- Schritt 5: Zusammenfassung -->
      <div class="panel onboarding-step" data-step="5" style="display:none;">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 5 von 5</div>
        </div>
        <h3 style="margin-top:16px;">Profil ist bereit! 🎉</h3>
        <div class="hint">Hier ist eine Zusammenfassung deiner Angaben:</div>
        
        <div class="onboarding-summary" style="margin-top:20px; padding:16px; background:#f8f7f3; border-radius:14px; border:1px solid var(--border);">
          <div class="onboarding-summary-item" style="margin-bottom:12px;">
            <div style="font-weight:900; font-size:14px;" id="summaryBusinessName">–</div>
            <div class="hint" id="summaryAddress" style="margin-top:4px;">–</div>
          </div>
          <div class="onboarding-summary-item" style="margin-bottom:12px;">
            <div class="hint" style="margin-bottom:4px;">Essenszeit</div>
            <div style="font-weight:900;" id="summaryMealTime">–</div>
          </div>
          <div class="onboarding-summary-item" id="summaryLogoContainer" style="display:none;">
            <div class="hint" style="margin-bottom:4px;">Logo</div>
            <div id="summaryLogo" style="width:60px; height:60px; border-radius:12px; overflow:hidden; border:1px solid var(--border);">
              <img id="summaryLogoImg" style="width:100%; height:100%; object-fit:cover;" />
            </div>
          </div>
        </div>

        <button class="btn" type="button" id="btnOnboardingComplete" style="margin-top:24px;">Erstes Gericht erstellen</button>
        <button class="btn secondary" type="button" id="btnOnboardingEdit" style="margin-top:8px;">Angaben bearbeiten</button>
      </div>
    </section>

    <!-- PROVIDER: Hybrid Onboarding -->
    <section class="view" id="v-provider-onboarding-entry" style="background:linear-gradient(135deg, #121826 0%, #1a1a1a 100%); min-height:100vh; padding:20px; position:relative;">
      <!-- Hero Video Loop (Full-Screen Background mit Overlay) -->
      <div style="position:absolute; top:0; left:0; right:0; bottom:0; z-index:0; overflow:hidden;">
        <div style="width:100%; height:100%; background:linear-gradient(135deg, #FFB800 0%, #FFD700 100%); display:flex; align-items:center; justify-content:center; position:relative;">
          <div style="position:absolute; inset:0; background:rgba(0,0,0,0.6); z-index:1;"></div>
          <div style="text-align:center; color:#fff; z-index:2; position:relative;">
            <div style="font-size:64px; margin-bottom:16px;">👆</div>
            <div style="font-size:18px; font-weight:900;">Nummer sehen → Antippen → Erledigt</div>
          </div>
          <!-- Video würde hier eingefügt: <video autoplay loop muted playsinline style="width:100%; height:100%; object-fit:cover; position:absolute; inset:0; z-index:0;"></video> -->
        </div>
      </div>
      
      <!-- Content (über Background) -->
      <div style="position:relative; z-index:1;">
      
      <div class="panel" style="padding:32px; text-align:center; max-width:480px; margin:0 auto; background:rgba(255,255,255,0.95); border-radius:24px; box-shadow:0 8px 32px rgba(0,0,0,0.3);">
        <h1 style="font-size:32px; font-weight:900; margin-bottom:16px; line-height:1.2; color:#2D3436;">Verdiene Zeit an der Theke.</h1>
        <p style="font-size:18px; line-height:1.5; margin-bottom:32px; color:#666; font-weight:600;">
          Stell dein Tagesgericht online, bevor der Ansturm kommt. Kein Telefon-Stress, keine Zettelwirtschaft.
        </p>
        
        <!-- 3-Punkte-Erklärung mit großen Icons (animiert) -->
        <div id="onboardingExplanationPoints" style="display:flex; flex-direction:column; gap:20px; margin-bottom:32px; text-align:left;">
          <div class="onboarding-point" style="display:flex; align-items:start; gap:16px; opacity:0; transform:translateY(20px); transition:opacity 0.6s ease-out, transform 0.6s ease-out;">
            <div style="width:64px; height:64px; border-radius:16px; background:rgba(255,184,0,0.15); display:flex; align-items:center; justify-content:center; flex-shrink:0;">
              <i data-lucide="shield" style="width:32px; height:32px; color:#FFD700;"></i>
            </div>
            <div style="flex:1;">
              <div style="font-size:18px; font-weight:900; margin-bottom:6px; color:#2D3436;">Tages-Angebot live schalten</div>
              <div style="font-size:14px; color:#666; line-height:1.5;">Fokus aufs Handwerk: Wir kümmern uns um die Sichtbarkeit, du dich ums Essen.</div>
            </div>
          </div>
          
          <div class="onboarding-point" style="display:flex; align-items:start; gap:16px; opacity:0; transform:translateY(20px); transition:opacity 0.6s ease-out, transform 0.6s ease-out;">
            <div style="width:64px; height:64px; border-radius:16px; background:rgba(255,184,0,0.15); display:flex; align-items:center; justify-content:center; flex-shrink:0;">
              <i data-lucide="hand" style="width:32px; height:32px; color:#FFD700;"></i>
            </div>
            <div style="flex:1;">
              <div style="font-size:18px; font-weight:900; margin-bottom:6px; color:#2D3436;">Abholung per Fingertipp</div>
              <div style="font-size:14px; color:#666; line-height:1.5;">Kein Scannen, kein Warten. Einfach die Abholnummer auf dem Display antippen und fertig.</div>
            </div>
          </div>
          
          <div class="onboarding-point" style="display:flex; align-items:start; gap:16px; opacity:0; transform:translateY(20px); transition:opacity 0.6s ease-out, transform 0.6s ease-out;">
            <div style="width:64px; height:64px; border-radius:16px; background:rgba(255,184,0,0.15); display:flex; align-items:center; justify-content:center; flex-shrink:0;">
              <i data-lucide="timer" style="width:32px; height:32px; color:#FFD700;"></i>
            </div>
            <div style="flex:1;">
              <div style="font-size:18px; font-weight:900; margin-bottom:6px; color:#2D3436;">Zeit gewinnen & Umsatz steigern</div>
              <div style="font-size:14px; color:#666; line-height:1.5;">Planbarkeit: Du weißt morgens schon, wie viele Portionen du vorbereiten musst.</div>
            </div>
          </div>
        </div>
        
        <!-- Interaktiver Tap-Moment: Demo-Kachel "49C" -->
        <div id="onboardingTapDemo" style="margin-bottom:24px; text-align:center;">
          <div style="font-size:14px; font-weight:600; color:#666; margin-bottom:12px;">So einfach geht's:</div>
          <div id="demoPickupCode" style="display:inline-block; padding:20px 32px; background:#fff; border:3px solid #FFD700; border-radius:20px; font-size:48px; font-weight:900; color:#2D3436; cursor:pointer; transition:all 0.2s ease; box-shadow:0 4px 16px rgba(255,215,0,0.2);" onclick="triggerTapDemo()">
            49C
          </div>
          <div id="tapDemoMessage" style="display:none; margin-top:16px; padding:12px 20px; background:rgba(76,175,80,0.1); border-radius:12px; font-size:16px; font-weight:700; color:#4caf50; animation:slideUp 0.4s ease-out;">
            So einfach gewinnst du Zeit! ⚡
          </div>
        </div>
        
        <!-- Badge: Garantiert ohne IT-Vorkenntnisse -->
        <div style="padding:12px 20px; background:rgba(46,125,50,0.12); border-radius:12px; margin-bottom:24px; display:inline-block;">
          <div style="font-size:14px; font-weight:700; color:#2e7d32;">✓ Garantiert ohne IT-Vorkenntnisse bedienbar</div>
        </div>
        
        <button class="btn-primary" type="button" id="btnOnboardingEntryStart" style="width:100%; min-height:64px; background:#FFD700; color:#111; font-weight:900; font-size:18px; border:none; border-radius:24px; box-shadow:0 25px 50px -12px rgba(255, 215, 0, 0.25); margin-bottom:12px; transition:transform 0.1s ease;">
          JETZT MEINE KÜCHE ERÖFFNEN
        </button>
        <button class="btn secondary" type="button" id="btnOnboardingEntryLater" style="width:100%; min-height:52px; background:transparent; color:#666; border:2px solid #e7e1d5; border-radius:16px;">
          Später starten
        </button>
        <div style="margin-top:24px; font-size:13px; color:#666; line-height:1.5;">
          <div style="font-weight:700; margin-bottom:4px;">Inseratsgebühr: 4,99 €. All-In Erfolgsgebühr: 0,89 €. In 2 Minuten online.</div>
          <div>Inklusive automatischer Abrechnung & bezahlter Bankgebühren.</div>
        </div>
      </div>
    </section>

    <section class="view" id="v-provider-onboarding-first-dish">
      <div class="panel" style="padding:20px;">
        <h2 style="font-size:20px; font-weight:900; margin-bottom:20px;">Erstes Gericht anlegen</h2>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">Gerichtname *</label>
          <input class="field" type="text" id="onboardingDishName" placeholder="z.B. Kürbissuppe" required />
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">Abholzeit von *</label>
          <input class="field" type="time" id="onboardingPickupTimeStart" required />
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">Abholzeit bis *</label>
          <input class="field" type="time" id="onboardingPickupTimeEnd" required />
        </div>
        
        <div style="margin-bottom:24px;">
          <div style="display:flex; gap:12px; margin-bottom:12px;">
            <button class="btn secondary" type="button" id="btnOnboardingAddPhoto" style="flex:1; min-height:52px; background:#FFB800; color:#2D3436; font-weight:700; border:none;">
              <i data-lucide="camera"></i><span>Foto aufnehmen</span>
            </button>
            <button class="btn secondary" type="button" id="btnOnboardingChooseProPhoto" style="flex:1; min-height:52px; background:#2d2d2d; color:#fff; font-weight:700; border:none;">
              <i data-lucide="image"></i><span>Aus Profi-Galerie</span>
            </button>
          </div>
          <div id="onboardingPhotoPreview" style="display:none; margin-top:12px; position:relative;">
            <img id="onboardingPhotoPreviewImg" style="width:100%; max-height:200px; object-fit:cover; border-radius:12px;" />
            <div id="onboardingPhotoWatermark" style="display:none; position:absolute; bottom:8px; left:8px; right:8px; background:rgba(0,0,0,0.7); color:#fff; padding:6px 12px; border-radius:8px; font-size:11px; text-align:center;">
              Serviervorschlag – Original weicht ab
            </div>
          </div>
        </div>
        
        <!-- Profi-Galerie Modal -->
        <div class="backdrop" id="proPhotoBd" onclick="closeProPhotoGallery()" style="display:none;"></div>
        <div class="sheet" id="proPhotoSheet" style="max-width:600px; max-height:80vh; overflow:hidden; display:flex; flex-direction:column;">
          <div style="padding:20px; border-bottom:1px solid var(--border);">
            <h3 style="margin:0; font-size:20px; font-weight:900;">Profi-Galerie</h3>
            <p style="margin:8px 0 0; font-size:14px; color:#666;">Wähle ein hochwertiges Stock-Foto aus</p>
          </div>
          
          <!-- Kategorien-Tabs -->
          <div style="display:flex; gap:8px; padding:16px; border-bottom:1px solid var(--border); overflow-x:auto; scrollbar-width:none;">
            <button class="pro-photo-category-tab active" data-category="all" style="padding:8px 16px; border-radius:12px; background:#FFB800; color:#2D3436; font-weight:700; border:none; white-space:nowrap;">Alle</button>
            <button class="pro-photo-category-tab" data-category="klassiker" style="padding:8px 16px; border-radius:12px; background:#f5f5f5; color:#666; font-weight:600; border:none; white-space:nowrap;">Klassiker</button>
            <button class="pro-photo-category-tab" data-category="deftig" style="padding:8px 16px; border-radius:12px; background:#f5f5f5; color:#666; font-weight:600; border:none; white-space:nowrap;">Deftig</button>
            <button class="pro-photo-category-tab" data-category="eintoepfe" style="padding:8px 16px; border-radius:12px; background:#f5f5f5; color:#666; font-weight:600; border:none; white-space:nowrap;">Eintöpfe</button>
            <button class="pro-photo-category-tab" data-category="modern" style="padding:8px 16px; border-radius:12px; background:#f5f5f5; color:#666; font-weight:600; border:none; white-space:nowrap;">Modern</button>
          </div>
          
          <!-- Zuletzt genutzt -->
          <div id="proPhotoRecent" style="padding:16px; border-bottom:1px solid var(--border); display:none;">
            <div style="font-size:14px; font-weight:700; margin-bottom:12px; color:#666;">Zuletzt genutzt</div>
            <div id="proPhotoRecentGrid" style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px;">
              <!-- Wird dynamisch befüllt -->
            </div>
          </div>
          
          <!-- Galerie-Grid -->
          <div style="flex:1; overflow-y:auto; padding:16px;">
            <div id="proPhotoGrid" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px;">
              <!-- Wird dynamisch befüllt -->
            </div>
          </div>
        </div>
        
        <div style="display:flex; gap:12px;">
          <button class="btn secondary" type="button" id="btnOnboardingFirstDishBack" style="flex:1; min-height:44px;">
            Zurück
          </button>
          <button class="btn-primary" type="button" id="btnOnboardingFirstDishNext" style="flex:1; min-height:56px;">
            Weiter
          </button>
        </div>
      </div>
    </section>

    <section class="view" id="v-provider-onboarding-signup">
      <div class="panel" style="padding:20px;">
        <h2 style="font-size:20px; font-weight:900; margin-bottom:8px;">Speichern & weitermachen</h2>
        <p style="font-size:14px; line-height:1.5; margin-bottom:24px; color:var(--muted);">
          Erstelle ein Konto, um dein Gericht zu speichern und jederzeit weiterzumachen.
        </p>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">E-Mail *</label>
          <input class="field" type="email" id="onboardingEmail" placeholder="deine@email.de" required autocomplete="email" />
        </div>
        
        <div style="margin-bottom:24px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">Passwort *</label>
          <input class="field" type="password" id="onboardingPassword" placeholder="Mindestens 8 Zeichen" required autocomplete="new-password" />
        </div>
        
        <button class="btn-primary" type="button" id="btnOnboardingSignupCreate" style="width:100%; min-height:56px; margin-bottom:12px;">
          Konto erstellen
        </button>
        <button class="btn secondary" type="button" id="btnOnboardingSignupLater" style="width:100%; min-height:44px;">
          Später
        </button>
        
        <div style="margin-top:16px; font-size:12px; color:var(--muted); text-align:center;">
          Inseratsgebühr nur bei Veröffentlichung · keine Mindestlaufzeit
        </div>
      </div>
    </section>

    <section class="view" id="v-provider-onboarding-business">
      <div class="panel" style="padding:20px;">
        <h2 style="font-size:20px; font-weight:900; margin-bottom:20px;">Dein Betrieb</h2>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">Betriebsname *</label>
          <input class="field" type="text" id="onboardingBusinessName" placeholder="z.B. Café Sonnenschein" required />
        </div>
        
        <div style="margin-bottom:24px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">Stadt oder Adresse *</label>
          <input class="field" type="text" id="onboardingCityOrAddress" placeholder="z.B. Stuttgart oder Hauptstraße 1, 70173 Stuttgart" required />
        </div>
        
        <div class="hint" style="font-size:13px; margin-bottom:24px; color:var(--muted);">
          Diese Angaben kannst du jederzeit ändern.
        </div>
        
        <div style="display:flex; gap:12px;">
          <button class="btn secondary" type="button" id="btnOnboardingBusinessBack" style="flex:1; min-height:44px;">
            Zurück
          </button>
          <button class="btn-primary" type="button" id="btnOnboardingBusinessNext" style="flex:1; min-height:56px;">
            Weiter
          </button>
        </div>
      </div>
    </section>

    <section class="view" id="v-provider-onboarding-preview">
      <div class="panel" style="padding:20px;">
        <h2 style="font-size:20px; font-weight:900; margin-bottom:8px;">So sehen Kunden dein Gericht</h2>
        <p style="font-size:14px; line-height:1.5; margin-bottom:20px; color:var(--muted);">
          So erscheint dein Gericht später für Kunden.
        </p>
        
        <div style="margin-bottom:20px; padding:12px; background:#f0f7f0; border-radius:12px; border:1px solid #4caf50;">
          <div style="font-weight:600; font-size:13px; color:#2e7d32; margin-bottom:4px;">Vorschau · noch nicht veröffentlicht</div>
        </div>
        
        <div id="onboardingPreviewCard" style="margin-bottom:24px;">
          <!-- Wird dynamisch befüllt -->
        </div>
        
        <button class="btn-primary" type="button" id="btnOnboardingPreviewDashboard" style="width:100%; min-height:56px; margin-bottom:12px;">
          Weiter zum Dashboard
        </button>
        <button class="btn secondary" type="button" id="btnOnboardingPreviewEdit" style="width:100%; min-height:44px;">
          Gericht bearbeiten
        </button>
      </div>
    </section>

    <!-- PROVIDER APP - Dashboard (Home) -->
    <section class="view" id="v-provider-home" style="background:#1a1a1a; min-height:100vh; padding:20px; padding-bottom:90px;">
      <!-- Status-Banner: LIVE/PAUSE -->
      <div class="panel" id="providerStatusBanner" style="padding:20px; border-radius:20px; box-shadow:0 4px 16px rgba(0,0,0,.3); background:linear-gradient(135deg, #2e7d32 0%, #1f5f23 100%); margin-bottom:20px; text-align:center;">
        <div style="font-weight:900; font-size:20px; color:#fff; margin-bottom:8px;" id="providerStatusText">Deine Küche ist LIVE</div>
        <div style="font-size:14px; color:rgba(255,255,255,0.9);">Bereit für Bestellungen</div>
      </div>
      
      <!-- Provider Identity Card (Header) - Dark Mode -->
      <div class="panel" id="providerIdentityCard" style="padding:20px; border-radius:20px; box-shadow:0 4px 16px rgba(0,0,0,.3); background:#2d2d2d; margin-bottom:20px;">
        <div style="display:flex; align-items:center; gap:16px; margin-bottom:16px;">
          <div class="plogo" id="provCardLogo" style="width:64px; height:64px; border-radius:16px; flex-shrink:0; border:3px solid rgba(255,184,0,0.3);"></div>
          <div style="flex:1; min-width:0;">
            <div style="font-weight:900; font-size:20px; line-height:1.3; margin-bottom:6px; color:#fff;" id="provCardName">Anbieter</div>
            <div class="hint" id="provCardAddr" style="font-size:14px; line-height:1.4; color:rgba(255,255,255,0.7);">Adresse hinzufügen</div>
          </div>
        </div>
        <button class="btn secondary" type="button" id="btnProviderEditProfile" style="width:100%; min-height:52px; background:#FFB800; color:#2D3436; font-weight:800; border:none; border-radius:12px;">
          Profil bearbeiten
        </button>
      </div>
      
      <!-- Quick-Kill-Widget: ALLES AUSVERKAUFT -->
      <div class="panel" id="providerQuickKill" style="padding:20px; border-radius:20px; box-shadow:0 4px 16px rgba(0,0,0,.3); background:#2d2d2d; margin-bottom:20px; text-align:center;">
        <button class="btn" type="button" id="btnQuickKill" style="width:100%; min-height:72px; background:#E34D4D; color:#fff; font-weight:900; font-size:18px; border:none; border-radius:16px; box-shadow:0 4px 16px rgba(227,77,77,0.3);">
          ALLES AUSVERKAUFT
        </button>
        <div style="font-size:13px; color:rgba(255,255,255,0.6); margin-top:12px;">Schließt alle aktiven Inserate für heute</div>
      </div>

      <!-- KPI Dashboard Cards (Row of 3) - Dark Mode -->
      <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-bottom:20px;">
        <div class="panel" id="kpiCardInserate" style="padding:20px; border-radius:16px; box-shadow:0 4px 16px rgba(0,0,0,.3); background:#2d2d2d; cursor:pointer; text-align:center; border:2px solid rgba(255,184,0,0.2);">
          <div style="font-size:32px; font-weight:900; line-height:1.2; margin-bottom:8px; color:#FFB800;" id="kpiInserateCount">0</div>
          <div style="font-size:13px; color:rgba(255,255,255,0.7); font-weight:600;">Inserate</div>
        </div>
        <div class="panel" id="kpiCardAbholungen" style="padding:20px; border-radius:16px; box-shadow:0 4px 16px rgba(0,0,0,.3); background:#2d2d2d; cursor:pointer; text-align:center; border:2px solid rgba(255,184,0,0.2);">
          <div style="font-size:32px; font-weight:900; line-height:1.2; margin-bottom:8px; color:#FFB800;" id="kpiAbholungenCount">0</div>
          <div style="font-size:13px; color:rgba(255,255,255,0.7); font-weight:600;">Abholungen</div>
        </div>
        <div class="panel" id="kpiCardKochbuch" style="padding:20px; border-radius:16px; box-shadow:0 4px 16px rgba(0,0,0,.3); background:#2d2d2d; cursor:pointer; text-align:center; border:2px solid rgba(255,184,0,0.2);">
          <div style="font-size:32px; font-weight:900; line-height:1.2; margin-bottom:8px; color:#FFB800;" id="kpiKochbuchCount">0</div>
          <div style="font-size:13px; color:rgba(255,255,255,0.7); font-weight:600;">Kochbuch</div>
        </div>
      </div>
      
      <!-- Zeit-Gewinn-Tracker Widget -->
      <div class="panel" id="providerTimeTracker" style="padding:20px; border-radius:20px; box-shadow:0 4px 16px rgba(0,0,0,.3); background:#2d2d2d; margin-bottom:20px; text-align:center; border:2px solid rgba(46,125,50,0.3);">
        <div style="font-size:14px; color:rgba(255,255,255,0.7); margin-bottom:8px; font-weight:600;">Deine Bilanz</div>
        <div style="font-size:36px; font-weight:900; color:#1F9D55; margin-bottom:8px;" id="providerTimeSaved">
          0h 0min
        </div>
        <div style="font-size:13px; color:rgba(255,255,255,0.7);">
          Zeit an der Theke gewonnen
        </div>
      </div>

      <!-- TODAY Card -->
      <div class="panel" id="providerTodayCard" style="margin-top:18px; padding:16px; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.04);">
        <div style="font-weight:600; font-size:17px; margin-bottom:12px; line-height:1.3;" id="providerTodayTitle">Heute</div>
        <div id="providerTodayContent">
          <!-- Wird dynamisch befüllt -->
        </div>
      </div>

      <!-- Active Offers Mini List -->
      <div class="panel" id="providerActiveOffers" style="margin-top:18px; padding:16px; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.04); display:none;">
        <div style="font-weight:600; font-size:17px; margin-bottom:12px; line-height:1.3;">Aktive Inserate</div>
        <div id="providerActiveOffersList"></div>
        <a href="#" id="btnProviderShowAllOffers" style="display:inline-block; font-size:13px; color:var(--muted); text-decoration:none; margin-top:12px;">
          Alle Inserate anzeigen →
        </a>
      </div>

      <!-- Week Preview -->
      <div class="panel" id="providerWeekPreview" style="margin-top:18px; padding:16px; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.04);">
        <div style="font-weight:600; font-size:17px; margin-bottom:12px; line-height:1.3;">Wochenvorschau</div>
        <div class="dayrow" id="providerWeekDays" style="padding:0 0 10px; max-width:none; margin-bottom:12px;"></div>
        <div id="providerWeekDayContent" style="min-height:60px;">
          <!-- Wird dynamisch befüllt -->
        </div>
      </div>

      <!-- Empty Dashboard (Welcome Card) -->
      <div class="panel" id="providerEmptyDashboard" style="margin-top:18px; padding:20px; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.04); text-align:center; display:none;">
        <div style="font-weight:600; font-size:18px; margin-bottom:8px; line-height:1.3;">Willkommen bei Mittagio</div>
        <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:var(--muted);">
          Starte mit deinem ersten Gericht.
        </div>
        <button class="btn secondary" type="button" id="btnProviderEmptyAddDish" style="width:100%; min-height:44px;">
          Gericht hinzufügen
        </button>
      </div>

      <!-- FAB (Floating Action Button) -->
      <button class="fab" id="fabProviderAddOffer" type="button" aria-label="Inserat hinzufügen" style="position:fixed; bottom:90px; right:16px; width:56px; height:56px; border-radius:28px; background:var(--brand); color:#111; border:none; box-shadow:0 4px 12px rgba(0,0,0,.2); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:900; z-index:20;">
        +
      </button>
      <div id="fabProviderAddOfferLabel" style="position:fixed; bottom:154px; right:16px; background:rgba(0,0,0,.8); color:#fff; padding:6px 12px; border-radius:8px; font-size:13px; white-space:nowrap; pointer-events:none; opacity:0; transition:opacity .2s; z-index:21;">
        + Inserat
      </div>
    </section>

    <section class="view" id="v-provider-pickups" style="background:#1a1a1a; min-height:100vh; padding:20px; padding-bottom:90px;">
      <div style="margin-bottom:20px;">
        <h3 style="margin:0 0 8px; font-size:28px; font-weight:900; line-height:1.2; color:#fff;">Abholungen</h3>
        <div id="provPickupsSubheader" class="hint" style="font-size:15px; color:rgba(255,255,255,0.7);">
          <!-- Wird dynamisch befüllt -->
        </div>
      </div>
      
      <!-- Filter Toggle -->
      <div class="answers" id="provPickupFilter" style="margin-bottom:24px; background:#2d2d2d; padding:8px; border-radius:12px;">
        <!-- Wird dynamisch befüllt -->
      </div>
      
      <!-- Empty States -->
      <div id="provPickupsEmpty" class="hint" style="text-align:center; padding:60px 20px; display:none; color:rgba(255,255,255,0.7);">
        <!-- Wird dynamisch befüllt -->
      </div>
      
      <!-- Pickup Grid (Theken-Grid) - Große Kacheln für Ein-Hand-Check-in (USP) -->
      <div id="provPickupsGrid" style="display:none; display:grid; grid-template-columns:repeat(2, 1fr); gap:20px; padding:0 4px;">
        <!-- Wird dynamisch befüllt -->
      </div>
      
      <!-- Pickup List (Legacy, für nicht-Grid-Ansicht) -->
      <div id="provPickupsList" style="display:none;">
        <!-- Wird dynamisch befüllt -->
      </div>
    </section>

    <section class="view" id="v-provider-week">
      <div class="panel">
        <h3>Wochenplan</h3>
        <div class="dayrow" id="weekDays" style="padding:0 0 10px; max-width:none;"></div>
        <div id="weekList" style="text-align:center; padding:40px 20px;">
          <div style="font-weight:600; font-size:16px; margin-bottom:8px;">Keine Inserate geplant</div>
          <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:var(--muted);">
            Plane deine Woche und erstelle Inserate.
          </div>
          <button class="btn secondary" type="button" id="btnWeekEmptyAdd" style="width:100%; min-height:44px;">
            Inserat erstellen
          </button>
        </div>
        <button class="btn secondary" type="button" id="btnWeekPdf" data-icon="print" style="display:none; margin-top:12px;">PDF-Wochenkarte erstellen</button>
        <button class="btn ghost" type="button" id="btnWeekBack" style="margin-top:12px;">Zurück</button>
      </div>
    </section>

    <section class="view" id="v-provider-cookbook">
      <div class="panel">
        <h3>Mein Kochbuch</h3>
        <div class="hint">Dein digitales Kochbuch. Immer griffbereit für deine Planung.</div>
        <div style="height:10px"></div>
        <div class="tabrow" id="cookbookTabs"></div>
        <div style="height:10px"></div>
        <input class="field" id="cookbookSearch" type="text" placeholder="Suche nach Gerichten" />
        <div style="height:10px"></div>
        <div class="hint">Sortierung</div>
        <div class="answers" id="cookbookSorts"></div>
        <button class="btn" type="button" id="btnCookbookAdd" data-icon="plus">Gericht hinzufügen</button>
        <div style="height:10px"></div>
        <div id="cookbookList" class="hint">Noch keine Gerichte gespeichert.</div>
      </div>
    </section>

    <section class="view" id="v-provider-profile">
      <div class="panel" id="providerContactCard" style="padding:20px;">
        <!-- Kontaktkarte: Nur anzeigen wenn Daten vorhanden -->
        <div id="providerContactCardContent"></div>
      </div>

      <div style="height:12px"></div>
      <div class="panel">
        <div class="row-group">
          <div class="rowgroup-title">Profil & Betrieb</div>
          <div class="rowlist">
            <button class="rowbtn" type="button" id="rowProfileOverview">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="user" data-icon-only="1"></div>
                <div class="rowbtn-text">Mein Profil<span>Übersicht</span></div>
              </div>
              <div class="chev">›</div>
            </button>
            <button class="rowbtn" type="button" id="btnProfileEdit">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="edit" data-icon-only="1"></div>
                <div class="rowbtn-text">Profil bearbeiten</div>
              </div>
              <div class="chev">›</div>
            </button>
            <button class="rowbtn" type="button" id="btnBilling">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="wallet" data-icon-only="1"></div>
                <div class="rowbtn-text">Meine Abrechnungen</div>
              </div>
              <div class="chev">›</div>
            </button>
          </div>
        </div>

        <div class="row-group">
          <div class="rowgroup-title">Aktionen</div>
          <div class="rowlist">
            <button class="rowbtn" type="button" id="btnProvShareOffer">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="share" data-icon-only="1"></div>
                <div class="rowbtn-text">Angebot teilen</div>
              </div>
              <div class="chev">›</div>
            </button>
            <button class="rowbtn" type="button" id="btnProvWeekPdf">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="print" data-icon-only="1"></div>
                <div class="rowbtn-text">Wochenkarte als PDF</div>
              </div>
              <div class="chev">›</div>
            </button>
          </div>
        </div>

        <div class="row-group">
          <div class="rowgroup-title">Hilfe</div>
          <div class="rowlist">
            <button class="rowbtn" type="button" id="btnProvFaq">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="info" data-icon-only="1"></div>
                <div class="rowbtn-text">FAQ</div>
              </div>
              <div class="chev">›</div>
            </button>
            <button class="rowbtn" type="button" id="btnProvSupport">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="mail" data-icon-only="1"></div>
                <div class="rowbtn-text">Support kontaktieren</div>
              </div>
              <div class="chev">›</div>
            </button>
          </div>
        </div>

        <div class="row-group">
          <div class="rowgroup-title">Rechtliches & Hilfe</div>
          <div class="rowlist">
            <button class="rowbtn" type="button" id="btnLegalImprint">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="file" data-icon-only="1"></div>
                <div class="rowbtn-text">Impressum</div>
              </div>
              <div class="chev">›</div>
            </button>
            <button class="rowbtn" type="button" id="btnLegalPrivacy">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="shield" data-icon-only="1"></div>
                <div class="rowbtn-text">Datenschutz</div>
              </div>
              <div class="chev">›</div>
            </button>
            <button class="rowbtn" type="button" id="btnLegalTerms">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="file" data-icon-only="1"></div>
                <div class="rowbtn-text">AGB</div>
              </div>
              <div class="chev">›</div>
            </button>
          </div>
        </div>
      </div>

      <div style="height:12px"></div>
      <div class="row-muted">Inseratsgebühr nur bei Veröffentlichung · Kein Vertrag · Keine Mindestlaufzeit</div>
      <div style="height:12px"></div>
      <button class="btn ghost" type="button" id="btnProvLogout">Logout</button>

      <div id="provFaqBox" style="display:none;">
        
    </section>

    <!-- STATISCHE RECHTSTEXTE-SEITEN -->
    <section class="view" id="v-legal-impressum">
      <div class="panel">
        <h1 style="font-size:24px; font-weight:900; margin-bottom:20px;">Impressum</h1>
        <div style="line-height:1.8; font-size:15px;">
          <p style="font-weight:700; margin-bottom:12px;">Verantwortlich für den Inhalt:</p>
          <p>
            Mittagio<br>
            Inhaber: Mike Quach<br>
            Langäcker 2<br>
            73635 Rudersberg<br>
            Deutschland
          </p>
          <p style="margin-top:16px;">
            <strong>E-Mail:</strong> <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a>
          </p>
          <p style="margin-top:20px; padding-top:20px; border-top:1px solid #eee; font-size:13px; color:#666;">
            <strong>Unternehmensform:</strong> Einzelunternehmen<br>
            <strong>Umsatzsteuer-ID:</strong> nicht vorhanden (§19 UStG)
          </p>
          <p style="margin-top:16px; padding-top:16px; border-top:1px solid #eee; font-size:13px; color:#666;">
            <strong>Plattformhinweis:</strong><br>
            Mittagio vermittelt Mittagsangebote lokaler Anbieter. Vertragspartner bei Bestellungen ist ausschließlich der jeweilige Anbieter.
          </p>
        </div>
        <div style="margin-top:32px; padding-top:20px; border-top:1px solid #eee; text-align:center; font-size:14px; color:#666;">
          Fragen, Hilfe oder Vorschläge? <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a>
        </div>
        <button class="btn ghost" type="button" onclick="history.back()" style="margin-top:20px; width:100%;">Zurück</button>
      </div>
    </section>

    <section class="view" id="v-legal-agb-kurz">
      <div class="panel">
        <h1 style="font-size:24px; font-weight:900; margin-bottom:20px;">AGB</h1>
        <div style="line-height:1.8; font-size:15px;">
          <p><strong>Mittagio ist Plattform, nicht Verkäufer</strong></p>
          <p>Mittagio vermittelt Mittagsangebote lokaler Anbieter. Vertragspartner bei Bestellungen ist ausschließlich der jeweilige Anbieter.</p>
          
          <p style="margin-top:20px;"><strong>Kosten für Anbieter:</strong></p>
          <ul style="padding-left:20px; margin:8px 0;">
            <li>4,99 € zzgl. MwSt. pro Veröffentlichung</li>
            <li>0,89 € zzgl. MwSt. pro Online-Bestellung inkl. aller Bank- & Zahlungsgebühren (pro Bestellung, egal wie viele Gerichte)</li>
          </ul>
          
          <p style="margin-top:20px;"><strong>Abholnummer:</strong></p>
          <p>Die Abholnummer dient als Zahlungs- & Abholnachweis. Die Abwicklungsgebühr fällt auch bei Nicht-Abholung an.</p>
          
          <p style="margin-top:20px;"><strong>Verantwortung:</strong></p>
          <p>Der Anbieter ist verantwortlich für Inhalte, Speisen und gesetzliche Vorgaben.</p>
          
          <p style="margin-top:20px;"><strong>Support:</strong></p>
          <p><a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a></p>
        </div>
        <div style="margin-top:32px; padding-top:20px; border-top:1px solid #eee; text-align:center; font-size:14px; color:#666;">
          Fragen, Hilfe oder Vorschläge? <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a>
        </div>
        <button class="btn ghost" type="button" onclick="history.back()" style="margin-top:20px; width:100%;">Zurück</button>
      </div>
    </section>

    <section class="view" id="v-legal-datenschutz">
      <div class="panel">
        <h1 style="font-size:24px; font-weight:900; margin-bottom:20px;">Datenschutzerklärung</h1>
        <div style="line-height:1.8; font-size:15px;">
          <p style="font-weight:700; margin-bottom:12px;">Verantwortlicher:</p>
          <p>
            Mittagio<br>
            Mike Quach<br>
            Langäcker 2<br>
            73635 Rudersberg<br>
            Deutschland<br>
            E-Mail: <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a>
          </p>
          
          <p style="margin-top:24px; font-weight:700;">Welche Daten erheben wir?</p>
          
          <p style="margin-top:12px;"><strong>Anbieter:</strong></p>
          <ul style="padding-left:20px; margin:8px 0;">
            <li>Betriebsname</li>
            <li>Kontaktdaten</li>
            <li>Standort/Öffnungszeiten</li>
            <li>Inserats-/Bestelldaten</li>
            <li>Abrechnungsdaten</li>
          </ul>
          
          <p style="margin-top:12px;"><strong>Kunden:</strong></p>
          <ul style="padding-left:20px; margin:8px 0;">
            <li>Bestelldaten</li>
            <li>Zahlungsstatus</li>
            <li>Abholnummer (keine unnötigen personenbezogenen Daten)</li>
          </ul>
          
          <p style="margin-top:24px; font-weight:700;">Online-Zahlung:</p>
          <p>Online-Zahlung erfolgt über externe Zahlungsdienstleister (z.B. Stripe). Wir speichern keine kompletter Zahlungsdaten (z.B. Kreditkartennummern).</p>
          
          <p style="margin-top:24px; font-weight:700;">Zweck der Abholnummer:</p>
          <p>Die Abholnummer dient als Zahlungs-/Abholnachweis, zur Zuordnung und zum Missbrauchsschutz.</p>
          
          <p style="margin-top:24px; font-weight:700;">Weitergabe:</p>
          <p>Daten werden nur an Zahlungsdienstleister und wenn gesetzlich erforderlich weitergegeben. Keine Werbeweitergabe.</p>
          
          <p style="margin-top:24px; font-weight:700;">Speicherdauer:</p>
          <p>Daten werden nur so lange gespeichert wie nötig und gemäß gesetzlicher Aufbewahrungspflichten.</p>
          
          <p style="margin-top:24px; font-weight:700;">Ihre Rechte:</p>
          <p>Sie haben das Recht auf Auskunft, Berichtigung, Löschung, Einschränkung und Widerspruch. Kontakt: <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a></p>
          
          <p style="margin-top:24px; font-weight:700;">Datensicherheit:</p>
          <p>Wir setzen technische und organisatorische Maßnahmen zum Schutz Ihrer Daten ein.</p>
          
          <p style="margin-top:24px; font-weight:700;">Änderungen:</p>
          <p>Diese Datenschutzerklärung kann angepasst werden. Aktuelle Version finden Sie auf dieser Seite.</p>
        </div>
        <div style="margin-top:32px; padding-top:20px; border-top:1px solid #eee; text-align:center; font-size:14px; color:#666;">
          Fragen, Hilfe oder Vorschläge? <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a>
        </div>
        <button class="btn ghost" type="button" onclick="history.back()" style="margin-top:20px; width:100%;">Zurück</button>
      </div>
    </section>


    <section class="view" id="v-legal-agb-onboarding">
      <div class="panel">
        <h2 style="font-size:20px; font-weight:900; margin-bottom:16px;">AGB</h2>
        <div style="line-height:1.7; font-size:14px; max-height:60vh; overflow-y:auto;">
          <p><strong>Mittagio ist Plattform, nicht Verkäufer</strong></p>
          <p>Mittagio vermittelt Mittagsangebote lokaler Anbieter. Vertragspartner bei Bestellungen ist ausschließlich der jeweilige Anbieter.</p>
          
          <p style="margin-top:16px;"><strong>Kosten:</strong></p>
          <ul style="padding-left:20px; margin:8px 0;">
            <li>4,99 € zzgl. MwSt. pro Veröffentlichung</li>
            <li>0,89 € zzgl. MwSt. pro Online-Bestellung inkl. aller Bank- & Zahlungsgebühren (pro Bestellung, egal wie viele Gerichte)</li>
          </ul>
          
          <p style="margin-top:16px;"><strong>Abholnummer:</strong></p>
          <p>Abholnummer = Zahlungs- & Abholnachweis. Abwicklungsgebühr fällt auch bei Nicht-Abholung an.</p>
          
          <p style="margin-top:16px;"><strong>Verantwortung:</strong></p>
          <p>Anbieter ist verantwortlich für Inhalte/Speisen/gesetzliche Vorgaben.</p>
          
          <p style="margin-top:16px;"><strong>Support:</strong></p>
          <p><a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a></p>
        </div>
      </div>
    </section>
      
      <div id="provFaqBox" style="display:none;">
        <div class="panel">
          <div class="section-title">FAQ (Anbieter)</div>
          <div class="faq">
            <details>
              <summary>Was ist Mittagio?</summary>
              <p>Mittagio ist eine Online-Plattform, auf der du dein Mittagsangebot sichtbar machst – schnell, einfach und flexibel.</p>
            </details>
            <details>
              <summary>Wie verdiene ich damit Zeit?</summary>
              <p>Du legst Gerichte einmal an (Kochbuch) und veröffentlichst sie mit einem Klick. Weniger Telefonate, weniger Chaos.</p>
            </details>
            <details>
              <summary>Muss Online-Zahlung aktiv sein?</summary>
              <p>Nein. Online-Zahlung ist optional. Abholnummern gibt’s nur bei Online-Zahlung.</p>
            </details>
            <details>
              <summary>Wie kann ich mein Angebot teilen?</summary>
              <p>Mit einem Tap: WhatsApp, Instagram oder Homepage – Text ist automatisch vorbereitet.</p>
            </details>
            <details>
              <summary>Inseratsgebühr / All-In Erfolgsgebühr?</summary>
              <p>Inseratsgebühr: 4,99 € einmalig pro Gericht. All-In Erfolgsgebühr: 0,89 € pro verkaufter Abholnummer (inkl. aller Bank- und Stripe-Gebühren). Keine Mindestlaufzeit.</p>
            </details>
            <details>
              <summary>Wie funktionieren Abholungen?</summary>
              <p>Wenn Abholnummer aktiv ist, werden die Nummern nach Gericht gruppiert angezeigt. Tippe eine Nummer an, sobald ein Gast abgeholt hat.</p>
            </details>
            <details>
              <summary>Warum Abholnummer?</summary>
              <p>Vorab bezahlt, weniger Chaos an der Ausgabe und ein klarer Ablauf pro Bestellung.</p>
            </details>
            <details>
              <summary>Was kostet die All-In Erfolgsgebühr?</summary>
              <p>0,89 € pro verkaufter Abholnummer. Diese Gebühr beinhaltet bereits alle Bank-, Stripe- und Verwaltungsgebühren. (Auch wenn der Kunde mehrere Gerichte in einem Vorgang holt.)</p>
            </details>
            <details>
              <summary>Wie spare ich Zeit?</summary>
              <p>Speichere Gerichte im Kochbuch und veröffentliche sie mit 2-3 Taps erneut.</p>
            </details>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Floating Action Button (FAB) für Modus-Wechsel -->
  <button class="fab-mode-toggle" id="fabModeToggle" aria-label="Ansicht wechseln" style="display:none;">
    <i data-lucide="sparkles" id="fabModeIcon"></i>
    <div class="fab-hint" id="fabHint">Lust auf Inspiration?</div>
  </button>

  <!-- CUSTOMER bottom nav - Mittagio-Bar -->
  <nav class="bottom" id="customerNav">
    <button class="navbtn active" data-go="discover" style="position:relative;">
      <div class="ico"><i data-lucide="utensils-crossed"></i></div>
      <div>Entdecken</div>
    </button>
    <button class="navbtn" data-go="fav" style="position:relative;">
      <div class="ico"><i data-lucide="heart"></i></div>
      <div>Favoriten</div>
    </button>
    <button class="navbtn" data-go="cart" style="position:relative;" id="bottomNavBasketBtn">
      <div class="ico"><i data-lucide="shopping-basket"></i></div>
      <div>Mittagsbox</div>
      <span id="bottomNavBasketBadge" class="nav-badge" style="display:none; position:absolute; top:4px; right:8px; width:18px; height:18px; background:#FFD700; color:#2D3436; border-radius:50%; font-size:11px; font-weight:900; display:flex; align-items:center; justify-content:center; border:2px solid #fff; box-shadow:0 2px 8px rgba(0,0,0,0.15);">0</span>
    </button>
    <button class="navbtn" data-go="profile" style="position:relative;">
      <div class="ico"><i data-lucide="user"></i></div>
      <div>Meins</div>
    </button>
  </nav>

    <!-- PROVIDER bottom nav -->
  <nav class="bottom" id="providerNav" style="display:none; background:#1a1a1a; border-top:1px solid rgba(255,255,255,0.1);">
    <button class="navbtn active" data-pgo="provider-home"><div class="ico" data-icon="utensils" data-icon-only="1"></div><div>Meine Küche</div></button>
    <button class="navbtn" data-pgo="provider-pickups"><div class="ico" data-icon="receipt" data-icon-only="1"></div><div>Abholungen</div></button>
    <button class="navbtn" data-pgo="provider-cookbook"><div class="ico" data-icon="bookOpen" data-icon-only="1"></div><div>Kochbuch</div></button>
    <button class="navbtn" data-pgo="provider-profile"><div class="ico" data-icon="user" data-icon-only="1"></div><div>Meins</div></button>
  </nav>
</div>

<!-- Publish Fee Modal (vor Inserats-Veröffentlichung) -->
<div class="backdrop" id="publishFeeBd" onclick="closePublishFeeModal()" style="background:rgba(0,0,0,0.7); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); display:none;"></div>
<div class="sheet" id="publishFeeSheet" style="max-width:480px; border-radius:24px; overflow:hidden; display:none;">
  <div class="sheet-body" style="padding:28px;">
    <h3 style="margin:0 0 20px; font-size:22px; font-weight:900; color:#2D3436;">Inserat veröffentlichen</h3>
    <div style="margin-bottom:24px; padding:20px; background:rgba(255,215,0,0.1); border-radius:16px; border:2px solid rgba(255,215,0,0.3);">
      <div style="font-weight:700; font-size:16px; color:#2D3436; margin-bottom:12px; display:flex; align-items:center; gap:8px;">
        <i data-lucide="info" style="width:20px;height:20px; color:#FFD700;"></i>
        <span>Gebühren-Übersicht</span>
      </div>
      <div style="font-size:15px; line-height:1.6; color:#2D3436; margin-bottom:16px;">
        <div style="margin-bottom:12px;">
          <strong>Inseratsgebühr:</strong> <span style="color:#FFD700; font-weight:900;">4,99 €</span>
          <div style="font-size:13px; color:#666; margin-top:4px;">Einmalig pro Gericht für die Sichtbarkeit im Feed</div>
        </div>
        <div style="padding-top:12px; border-top:1px solid rgba(0,0,0,0.1);">
          <strong>All-In Erfolgsgebühr:</strong> <span style="color:#1f9d55; font-weight:900;">0,89 €</span>
          <div style="font-size:13px; color:#666; margin-top:4px;">Pro verkaufter Abholnummer. Beinhaltet bereits alle Bank-, Stripe- und Verwaltungsgebühren.</div>
        </div>
      </div>
    </div>
    <div style="display:flex; flex-direction:column; gap:12px;">
      <button class="btn-primary" type="button" id="btnPublishConfirm" style="width:100%; min-height:56px; font-size:16px; font-weight:700;">
        Veröffentlichen
      </button>
      <button class="btn ghost" type="button" onclick="closePublishFeeModal();" style="width:100%; min-height:44px;">
        Abbrechen
      </button>
    </div>
  </div>
</div>

<!-- Match Success Modal (nach Rechts-Swipe) -->
<div class="backdrop" id="matchBd" onclick="closeMatchModal()" style="background:rgba(0,0,0,0.7); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);"></div>
<div class="sheet" id="matchSheet" style="max-width:400px; border-radius:24px; overflow:hidden;">
  <div style="position:relative; padding:40px 24px; text-align:center; background:linear-gradient(135deg, #FFB800 0%, #FFD700 100%);">
    <!-- Konfetti-Animation (Canvas) -->
    <canvas id="matchConfetti" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></canvas>
    
    <div style="font-size:64px; margin-bottom:16px; animation:scaleIn 0.5s ease-out;">🔥</div>
    <h2 style="font-size:32px; font-weight:900; margin:0 0 8px; color:#2D3436; animation:slideUp 0.5s ease-out;">It's a Match!</h2>
    <div id="matchDistance" style="font-size:16px; color:#2D3436; font-weight:600; opacity:0.9; animation:slideUp 0.6s ease-out;">
      <!-- Wird dynamisch befüllt -->
    </div>
  </div>
  
  <div style="padding:32px 24px; background:#fff;">
    <div id="matchDishImage" style="width:100%; height:200px; border-radius:16px; overflow:hidden; margin-bottom:24px; background:#f0f0f0;">
      <!-- Wird dynamisch befüllt -->
    </div>
    
    <div id="matchDishName" style="font-size:24px; font-weight:900; margin-bottom:8px; color:#2D3436;">
      <!-- Wird dynamisch befüllt -->
    </div>
    <div id="matchProviderName" style="font-size:16px; color:#666; margin-bottom:24px;">
      <!-- Wird dynamisch befüllt -->
    </div>
    
    <!-- Fast weg Badge (wenn ausverkauft) -->
    <div id="matchFastWeg" style="display:none; padding:12px; background:rgba(227,77,77,0.15); border-radius:12px; margin-bottom:24px; text-align:center; animation:blink 1s infinite;">
      <div style="font-size:14px; font-weight:700; color:#E34D4D;">⚡ Fast weg!</div>
    </div>
    
    <!-- Quick-Action Frage -->
    <div style="margin-bottom:20px; text-align:center;">
      <div style="font-size:18px; font-weight:700; color:#2D3436; margin-bottom:16px;">
        Heute essen oder für später planen?
      </div>
    </div>
    
    <!-- CTA Buttons -->
    <div style="display:flex; flex-direction:column; gap:12px;">
      <button class="btn" type="button" id="btnMatchReserve" style="width:100%; min-height:56px; background:#FFB800; color:#2D3436; font-weight:800; font-size:18px; border:none; border-radius:16px; box-shadow:0 4px 16px rgba(255,184,0,0.3);">
        Heute essen
      </button>
      <button class="btn secondary" type="button" id="btnMatchLater" style="width:100%; min-height:52px; background:transparent; color:#666; font-weight:700; border:2px solid #e7e1d5; border-radius:16px;">
        Für später planen
      </button>
    </div>
  </div>
</div>

<!-- Offer sheet -->
<div class="backdrop" id="bd" onclick="closeSheet()"></div>
<div class="sheet" id="sheet">
  <div class="sheet-header" style="position:sticky; top:0; z-index:10; background:var(--card); padding:12px 16px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border);">
    <button class="back-button" type="button" onclick="closeSheet()" aria-label="Zurück" style="background:none; border:none; padding:8px; cursor:pointer;">
      <i data-lucide="arrow-left"></i>
    </button>
    <div style="font-weight:600; font-size:16px;">Angebot</div>
    <button class="share-button-header" type="button" id="btnShareHeader" aria-label="Teilen" style="background:none; border:none; padding:8px; cursor:pointer; color:var(--text-secondary);">
      <i data-lucide="share-2"></i>
    </button>
  </div>
  <div class="handle"></div>
  <div class="sheet-img" style="max-height:220px; overflow:hidden;"><img id="sImg" alt="" style="width:100%; height:auto; object-fit:cover; display:block;" /></div>
  <div class="sheet-body">
    <div style="margin-top:16px;">
      <div style="font-weight:700;font-size:20px; line-height:1.3; margin-bottom:8px;" id="sDish"></div>
      <div style="color:var(--text-secondary);font-size:14px; display:flex; align-items:center; gap:6px; margin-bottom:12px;" id="sProvider">
        ${iconMarkup('store')}<span></span>
      </div>
      <!-- Status Badge (dynamisch) -->
      <div id="sStatusBadge" style="margin-bottom:16px;"></div>
    </div>

    <div class="row"><span>Abholfenster</span><b id="sWindow"></b></div>
    <div class="row"><span>Adresse</span><a id="sAddr" href="#" target="_blank" rel="noopener">öffnen</a></div>
    <div class="row"><span>Entfernung</span><b id="sDistance"></b></div>
    <div class="row"><span>Verfügbar</span><b id="sAvail"></b></div>

    <div id="sAllergensWrap" style="display:none">
      <div class="row"><span>Allergene</span><span id="sAllergens" style="text-align:right;color:var(--muted)"></span></div>
    </div>
    <div id="sExtrasWrap" style="display:none">
      <div class="row"><span>Extras</span><span id="sExtras" style="text-align:right;color:var(--muted)"></span></div>
    </div>
    <div id="sReuseWrap" style="display:none">
      <div class="row"><span>Mehrweg / Pfand</span><span id="sReuse" style="text-align:right;color:var(--muted)"></span></div>
    </div>

    <!-- Badges Row (max 3) -->
    <div class="sheet-badges" id="sBadges" style="display:flex; gap:8px; margin:16px 0; flex-wrap:wrap;"></div>
    
    <!-- Info Row (Icons) -->
    <div class="sheet-info-row" id="sInfoRow" style="display:flex; gap:16px; margin:16px 0; color:var(--text-secondary); font-size:14px;"></div>
    
    <!-- Address Card -->
    <div class="sheet-address-card" style="background:var(--color-soft-grey-bg); border-radius:var(--r-md); padding:16px; margin:16px 0;">
      <div style="font-weight:600; margin-bottom:8px;">Adresse</div>
      <div id="sAddressFull" style="color:var(--text-secondary); font-size:14px; line-height:1.5;"></div>
    </div>
    
    <button class="btn ghost" type="button" id="btnDishFav" style="margin-top:8px;"><i data-lucide="heart"></i><span>Gericht speichern</span></button>
    
    <!-- Bottom Sticky Primary CTA: "In die Mittagsbox" -->
    <div style="position:sticky; bottom:0; background:var(--card); padding:16px 0; margin-top:24px; border-top:1px solid var(--border); z-index:10;">
      <button class="btn-primary" type="button" id="btnPrimaryCTA" style="width:100%; min-height:56px; max-height:64px; background:#FFB800; color:#2D3436; font-weight:800; font-size:18px; border:none; border-radius:16px; box-shadow:0 4px 16px rgba(255,184,0,0.3);">
        <i data-lucide="shopping-basket" style="width:22px;height:22px;"></i>
        <span id="btnPrimaryCTAText">In die Mittagsbox</span>
      </button>
    </div>
  </div>
</div>

<!-- Fullscreen Code Modal (extrem groß, 1-2m lesbar) -->
<!-- Fullscreen Code Modal (extrem groß, 1-2m lesbar) -->
<div class="backdrop" id="fullscreenCodeBd"></div>
<div class="fullscreen-code" id="fullscreenCode">
  <button class="fullscreen-code-close" aria-label="Schließen">
    <i data-lucide="x"></i>
  </button>
  <div class="fullscreen-code-content">
    <div class="fullscreen-code-value" id="fullscreenCodeValue">A  B  1  2  C</div>
    <div class="fullscreen-code-subtext">Bitte dem Personal zeigen</div>
  </div>
</div>

<!-- Provider offer sheet -->
<div class="backdrop" id="pbd" onclick="closeProviderSheet()"></div>
<div class="sheet" id="psheet">
  <div class="handle"></div>
  <div class="sheet-body">
    <div id="pPreview"></div>
    <div class="row"><span>Status</span><b id="pStatus"></b></div>
    <div class="row"><span>Essenszeit</span><b id="pWindow"></b></div>
    <button class="btn" type="button" id="btnEditOffer" data-icon="edit">Bearbeiten</button>
    <button class="btn" type="button" id="btnToggleOffer" data-icon="action" style="background:var(--brand); color:#2D3436; font-weight:900;">Noch da</button>
    <button class="btn ghost" type="button" id="btnShareOffer" data-icon="share">Teilen</button>
    <button class="btn ghost" type="button" id="btnPrintOffer" data-icon="print">Drucken</button>
  </div>
</div>

<!-- Quick-Ticket (bildschirmfüllend) -->
<div class="backdrop" id="codeBd" onclick="closeCodeSheet()"></div>
<div class="quick-ticket" id="codeSheet">
  <button class="quick-ticket-close" onclick="closeCodeSheet()" aria-label="Schließen">
    <i data-lucide="x"></i>
  </button>
  <div class="quick-ticket-content">
    <div class="quick-ticket-header">
      <div class="quick-ticket-logo" id="codeProviderLogo"></div>
      <div class="quick-ticket-provider" id="codeProvider">Anbieter</div>
      <div class="quick-ticket-time" id="codePickupWindow">Essenszeit: –</div>
    </div>
    <div class="quick-ticket-code">
      <div class="quick-ticket-code-label">Abholnummer</div>
      <div class="quick-ticket-code-value" id="codeText">A1</div>
    </div>
    <div class="quick-ticket-details">
      <div class="quick-ticket-detail-item">
        <div class="quick-ticket-detail-label">Gericht</div>
        <div class="quick-ticket-detail-value" id="codeSummary">–</div>
      </div>
      <div class="quick-ticket-detail-item">
        <div class="quick-ticket-detail-label">Abholzeit</div>
        <div class="quick-ticket-detail-value" id="codePickupTime">offen</div>
      </div>
    </div>
    <div class="quick-ticket-status" id="codeStatus">Status: offen</div>
    <div class="quick-ticket-actions">
      <button class="btn" type="button" id="btnToggleOrderStatus">Als abgeholt markieren</button>
    </div>
  </div>
</div>

<!-- Legal Sheets (Impressum, AGB, Datenschutz) -->
<div class="backdrop" id="legalBd" onclick="closeLegalSheet()"></div>
<!-- AGB Onboarding Modal (1-Screen) -->
<div class="backdrop" id="agbOnboardingBd" onclick="closeAgbOnboardingModal()"></div>
<div class="sheet" id="agbOnboardingSheet">
  <div class="handle"></div>
  <div class="sheet-body" style="padding:24px;">
    <div id="agbOnboardingContent">
      <!-- Wird dynamisch befüllt -->
    </div>
    <div style="display:flex; gap:12px; margin-top:20px;">
      <button class="btn" type="button" id="btnAgbOnboardingAccept" style="flex:1; min-height:56px;">
        Akzeptieren
      </button>
      <button class="btn secondary" type="button" id="btnAgbOnboardingCancel" style="flex:1; min-height:56px;">
        Abbrechen
      </button>
    </div>
  </div>
</div>

<div class="sheet" id="legalSheet">
  <div class="handle"></div>
  <div class="sheet-body" style="max-height:80vh; overflow-y:auto;">
    <div class="panel" id="legalContent">
      <!-- Wird dynamisch befüllt -->
    </div>
  </div>
</div>

<!-- FAQ Sheet (Alle Fragen) -->
<div class="backdrop" id="faqBd" onclick="closeFaqSheet()"></div>
<div class="sheet" id="faqSheet">
  <div class="handle"></div>
  <div class="sheet-body" style="max-height:85vh; overflow-y:auto; padding:16px;">
    <div style="font-weight:600; font-size:18px; margin-bottom:16px; line-height:1.3;">Häufige Fragen</div>
    <div class="faq" id="faqSheetContent">
      <!-- Wird dynamisch befüllt -->
    </div>
  </div>
</div>

<!-- Pickup Confirmation Sheet -->
<div class="backdrop" id="pickupConfirmBd" onclick="closePickupConfirmSheet()"></div>
<div class="sheet" id="pickupConfirmSheet">
  <div class="handle"></div>
  <div class="sheet-body" style="padding:24px;">
    <div style="font-weight:600; font-size:18px; margin-bottom:20px; line-height:1.3; text-align:center;">Abholung bestätigen</div>
    <div style="font-size:48px; font-weight:900; font-family:monospace; color:var(--brand); margin-bottom:12px; text-align:center; line-height:1;" id="pickupConfirmCode">–</div>
    <div style="font-size:16px; color:var(--muted); margin-bottom:24px; text-align:center;" id="pickupConfirmDish">–</div>
    <div style="display:flex; flex-direction:column; gap:12px;">
      <button class="btn" type="button" id="btnPickupConfirmYes" style="width:100%; min-height:56px; font-size:16px; font-weight:600;">
        Als abgeholt markieren
      </button>
      <button class="btn secondary" type="button" id="btnPickupConfirmNo" style="width:100%; min-height:50px; font-size:16px;">
        ❓ Doch nicht
      </button>
    </div>
  </div>
</div>

<!-- Login Modal (Bottom Sheet) -->
<div class="backdrop" id="loginBd" onclick="closeLoginSheet()"></div>
<div class="sheet" id="loginSheet">
  <div class="handle"></div>
  <div class="sheet-body">
    <div class="panel">
      <h3 style="margin:0 0 8px;">Anmelden</h3>
      <div class="hint" style="margin-bottom:20px;">Melde dich an, um zu bestellen</div>
      <input class="field" id="loginModalEmail" type="email" placeholder="E-Mail" autocomplete="email" />
      <div style="height:10px"></div>
      <input class="field" id="loginModalPass" type="password" placeholder="Passwort" autocomplete="current-password" />
      <button class="btn" type="button" id="btnLoginModalLogin" style="margin-top:16px; width:100%;">Anmelden</button>
      <div style="margin-top:12px; text-align:center;">
        <button class="btn ghost" type="button" id="btnLoginModalDemo" style="width:auto; padding:8px 16px;">Demo-Login (ohne Anmeldung)</button>
      </div>
    </div>
  </div>
</div>

<!-- Provider Login Modal (Business-Login) -->
<div class="backdrop" id="providerLoginBd" onclick="closeProviderLoginModal()" style="background:rgba(0,0,0,0.7); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); display:none;"></div>
<div class="sheet" id="providerLoginSheet" style="max-width:420px; border-radius:24px; overflow:hidden; display:none;">
  <div class="sheet-body" style="padding:32px;">
    <div style="text-align:center; margin-bottom:24px;">
      <div style="width:64px; height:64px; margin:0 auto 16px; background:linear-gradient(135deg, rgba(255,204,0,0.2) 0%, rgba(255,184,0,0.1) 100%); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:32px;">
        🏪
      </div>
      <h3 style="margin:0 0 8px; font-size:24px; font-weight:900; color:#2D3436;">MITTAGIO Business</h3>
      <p class="hint" style="font-size:14px; color:#666; line-height:1.5;">Melde dich als Gastronom an</p>
    </div>
    <div style="display:flex; flex-direction:column; gap:16px;">
      <input class="field" id="providerLoginEmail" type="email" placeholder="E-Mail-Adresse" autocomplete="email" style="width:100%; padding:14px 16px; border-radius:14px; border:1px solid var(--border); font-size:16px; background:#fbfaf7;" />
      <input class="field" id="providerLoginPass" type="password" placeholder="Passwort" autocomplete="current-password" style="width:100%; padding:14px 16px; border-radius:14px; border:1px solid var(--border); font-size:16px; background:#fbfaf7;" />
      <button class="btn-primary" type="button" id="btnProviderLoginModal" style="width:100%; min-height:52px; font-size:16px; font-weight:700; margin-top:8px;">
        <i data-lucide="log-in" style="width:20px;height:20px;"></i>
        <span>Einloggen</span>
      </button>
      <button class="btn ghost" type="button" onclick="closeProviderLoginModal();" style="width:100%; min-height:44px;">
        Abbrechen
      </button>
    </div>
    <div class="hint" style="margin-top:20px; padding:12px; background:rgba(255,204,0,0.08); border-radius:12px; font-size:12px; color:#666; line-height:1.5; text-align:center;">
      Demo: Beliebige E-Mail/Passwort → du bist drin.<br>(Später: Firebase Auth)
    </div>
  </div>
</div>

<!-- Share sheet (MVP: nur WhatsApp + E-Mail) -->
<div class="backdrop" id="shareBd" onclick="closeShareSheet()"></div>
<div class="sheet" id="shareSheet">
  <div class="handle"></div>
  <div class="sheet-body">
    <div class="panel">
      <div style="font-weight:900; font-size:18px;">Inserat teilen</div>
      <div class="hint" id="shareSheetSubtitle" style="margin-top:4px;">
        <!-- Wird dynamisch befüllt -->
      </div>
    </div>
    <div class="answers" style="margin-top:16px;">
      <button class="ans" type="button" id="btnShareWhatsApp">
        <i data-lucide="message-circle"></i><span>WhatsApp</span>
      </button>
      <button class="ans" type="button" id="btnShareInstagram">
        <i data-lucide="share-2"></i><span>Instagram</span>
      </button>
      <button class="ans" type="button" id="btnShareCopy">
        <i data-lucide="copy"></i><span>Link kopieren</span>
      </button>
    </div>
  </div>
</div>

<!-- Create Flow Sheet (Gericht hinzufügen) -->
<div class="backdrop" id="createFlowBd" onclick="closeCreateFlowSheet()"></div>
<div class="sheet" id="createFlowSheet">
  <div class="handle"></div>
  <div class="sheet-body" style="padding:16px;">
    <div style="font-weight:600; font-size:18px; margin-bottom:16px; line-height:1.3;">Gericht hinzufügen</div>
    <div style="display:flex; flex-direction:column; gap:12px;">
      <button class="btn secondary" type="button" id="btnCreateFromCookbook" style="width:100%; min-height:44px; justify-content:flex-start; text-align:left;">
        <span style="margin-right:12px;">📖</span>
        <span>Aus Kochbuch auswählen</span>
      </button>
      <button class="btn secondary" type="button" id="btnCreateNewDish" style="width:100%; min-height:44px; justify-content:flex-start; text-align:left;">
        <span style="margin-right:12px;">➕</span>
        <span>Neues Gericht erstellen</span>
      </button>
    </div>
    <div class="hint" id="createFlowDateHint" style="margin-top:12px; font-size:13px; color:var(--muted); display:none;"></div>
  </div>
</div>

<!-- Snackbar: Undo pickup -->
<div class="snackbar" id="pickupUndo">
  <span id="pickupUndoLabel">Abholung markiert</span>
  <button type="button" id="pickupUndoBtn">Rückgängig</button>
</div>

<!-- Print view -->
<div id="printView" class="print-view"></div>

<!-- Provider Wizard sheet (single reusable) -->
<div class="backdrop" id="wbd" onclick="closeWizard()"></div>
<div class="sheet" id="wizard">
  <div class="handle"></div>
  <div class="sheet-body">
    <div class="wizard" id="wBox">
      <div class="w-top">
        <div class="w-title" id="wTitle">Setup</div>
        <div class="w-step" id="wStep">1/6</div>
      </div>
      <div class="w-q" id="wQ">…</div>
      <p class="w-help" id="wHelp"></p>
      <div id="wContent"></div>
      <div class="w-actions">
        <button class="btn secondary" type="button" id="wBack">Zurück</button>
        <button class="btn" type="button" id="wNext">Weiter</button>
      </div>
    </div>
  </div>
</div>

<script>
  // --- Storage keys ---
  const LS = {
    offers: 'mittagio_offers_v2',
    favs: 'mittagio_favs_v1',
    providerFavs: 'mittagio_provider_favs_v1',
    dishFavs: 'mittagio_dish_favs_v1',
    cart: 'mittagio_cart_v1',
    orders: 'mittagio_orders_v1',
    customer: 'mittagio_customer_v1',
    provider: 'mittagio_provider_v1',
    cookbook: 'mittagio_cookbook_v1',
    week: 'mittagio_week_v1',
    onboardingDraft: 'mittagio_onboarding_draft_v1',
    pickupDone: 'mittagio_pickup_done_v1',
    mode: 'mittagio_mode_v1',
    discoverView: 'mittagio_discover_view_v1'
  };
  const load = (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch { return d; } };
  const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

  // --- Order Store (localStorage MVP) - MUSS VOR VERWENDUNG DEFINIERT SEIN ---
  /**
   * @typedef {Object} Order
   * @property {string} id
   * @property {number} createdAt
   * @property {number} updatedAt
   * @property {string} dishId
   * @property {string} dishName
   * @property {string} providerId
   * @property {string} providerName
   * @property {string} [providerAddress]
   * @property {number} quantity
   * @property {number} unitPrice - in cents
   * @property {number} total - in cents
   * @property {'PICKUP'|'DINE_IN'} fulfillType
   * @property {string} [etaTime]
   * @property {'CREATED'|'PAYMENT_PENDING'|'PAID'|'CANCELLED'|'COMPLETED'|'PICKED_UP'} status
   * @property {'EUR'} currency
   * @property {string} [stripeCheckoutSessionId]
   * @property {string} [stripePaymentIntentId]
   * @property {string} [receiptEmail]
   * @property {string} [pickupCode] - nur bei PAID (Format: "2B")
   * @property {number} [pickupCodeActivatedAt] - nur bei PAID
   * @property {string} [pickupDate] - ISO date "YYYY-MM-DD"
   * @property {string} [pickupWindow] - e.g. "11:30–14:30"
   * @property {'A'|'B'|'C'|'D'|'E'} [dishLetter] - nur bei PAID
   * @property {number} [runningNumber] - nur bei PAID
   * @property {string} [offerId] - Reference to offer
   * @property {'PAID'|'PICKED_UP'} [status] - Extended status
   * @property {boolean} isGuest
   */
  
  /**
   * Load orders from localStorage
   * @returns {Order[]}
   */
  function loadOrders(){
    try {
      const stored = localStorage.getItem(LS.orders);
      if(!stored) return [];
      const parsed = JSON.parse(stored);
      return Array.isArray(parsed) ? parsed : [];
    } catch(e){
      console.error('Error loading orders:', e);
      return [];
    }
  }
  
  /**
   * Save orders to localStorage
   * @param {Order[]} ordersList
   */
  function saveOrders(ordersList){
    try {
      localStorage.setItem(LS.orders, JSON.stringify(ordersList || []));
    } catch(e){
      console.error('Error saving orders:', e);
    }
  }
  
  /**
   * Add a new order
   * @param {Order} order
   * @returns {Order}
   */
  function addOrder(order){
    // Guard: pickupCode nur bei PAID
    if(order.pickupCode && order.status !== 'PAID'){
      console.warn('pickupCode should only be set when status is PAID');
      order.pickupCode = undefined;
      order.pickupCodeActivatedAt = undefined;
    }
    
    const ordersList = loadOrders();
    ordersList.push(order);
    saveOrders(ordersList);
    return order;
  }
  
  /**
   * Update an existing order
   * @param {string} orderId
   * @param {Partial<Order>} patch
   * @returns {Order|null}
   */
  function updateOrder(orderId, patch){
    const ordersList = loadOrders();
    const index = ordersList.findIndex(o => o.id === orderId);
    if(index === -1){
      console.error('Order not found:', orderId);
      return null;
    }
    
    const order = ordersList[index];
    
    // Guard: pickupCode nur bei PAID
    if(patch.pickupCode && patch.status !== 'PAID' && order.status !== 'PAID'){
      console.warn('pickupCode should only be set when status is PAID');
      patch.pickupCode = undefined;
      patch.pickupCodeActivatedAt = undefined;
    }
    
    // Merge patch
    const updated = {
      ...order,
      ...patch,
      updatedAt: Date.now()
    };
    
    ordersList[index] = updated;
    saveOrders(ordersList);
    return updated;
  }
  
  /**
   * Get order by ID
   * @param {string} orderId
   * @returns {Order|null}
   */
  function getOrderById(orderId){
    const ordersList = loadOrders();
    return ordersList.find(o => o.id === orderId) || null;
  }
  
  /**
   * List active orders (CREATED, PAYMENT_PENDING, PAID)
   * @returns {Order[]}
   */
  function listActiveOrders(){
    const ordersList = loadOrders();
    return ordersList.filter(o => 
      o.status === 'CREATED' || 
      o.status === 'PAYMENT_PENDING' || 
      o.status === 'PAID'
    );
  }
  
  /**
   * Generate pickup code (legacy: random 5-char code)
   * @param {number} [len=5]
   * @returns {string}
   */
  function generatePickupCode(len = 5){
    const alphabet = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789'; // ohne O/I/0/1
    let code = '';
    for(let i = 0; i < len; i++){
      code += alphabet[Math.floor(Math.random() * alphabet.length)];
    }
    
    // Optional: ensure uniqueness (wenn collision, neu generieren)
    const ordersList = loadOrders();
    const existingCodes = ordersList
      .filter(o => o.pickupCode)
      .map(o => o.pickupCode);
    
    if(existingCodes.includes(code)){
      // Collision: neu generieren (max 10 Versuche)
      for(let attempt = 0; attempt < 10; attempt++){
        code = '';
        for(let i = 0; i < len; i++){
          code += alphabet[Math.floor(Math.random() * alphabet.length)];
        }
        if(!existingCodes.includes(code)) break;
      }
    }
    
    return code;
  }
  
  /**
   * Assign pickup code (deterministic, mock)
   * Single source of truth: Order record
   * @param {Object} params
   * @param {string} params.providerId - Provider ID
   * @param {string} params.pickupDate - ISO date "YYYY-MM-DD"
   * @param {string} params.dishId - Dish/Offer ID
   * @returns {{dishLetter: string, runningNumber: number, pickupCode: string}}
   */
  function assignPickupCode({providerId, pickupDate, dishId}){
    // 1) Get today's active offers for provider (same pickupDate)
    const todayOffers = offers
      .filter(o => o.providerId === providerId && o.day === pickupDate && o.active !== false)
      .sort((a, b) => {
        // 2) Sort deterministically (createdAt or sortIndex)
        const timeA = a.createdAt || 0;
        const timeB = b.createdAt || 0;
        if(timeA !== timeB) return timeA - timeB;
        return (a.id || '').localeCompare(b.id || '');
      });
    
    // 3) Determine dishLetter based on index: 0->A, 1->B, 2->C, 3->D, 4->E
    const dishIndex = todayOffers.findIndex(o => o.id === dishId);
    if(dishIndex === -1){
      // Fallback: use first dish (A)
      const dishLetter = 'A';
      const ordersList = loadOrders();
      // 4) Find existing orders for (providerId + pickupDate + dishLetter)
      const existingOrders = ordersList.filter(o => 
        o.providerId === providerId && 
        o.pickupDate === pickupDate && 
        o.dishLetter === dishLetter &&
        o.status === 'PAID'
      );
      // 5) runningNumber = existingCount + 1
      const runningNumber = existingOrders.length + 1;
      // 6) pickupCode = `${runningNumber}${dishLetter}`
      const pickupCode = `${runningNumber}${dishLetter}`;
      return {dishLetter, runningNumber, pickupCode};
    }
    
    const position = Math.min(dishIndex, 4); // Max 5 dishes (0-4)
    const dishLetter = String.fromCharCode(65 + position); // A=65, B=66, etc. (0→A, 1→B, ...)
    
    // 4) Find existing orders for (providerId + pickupDate + dishLetter)
    const ordersList = loadOrders();
    const existingOrders = ordersList.filter(o => 
      o.providerId === providerId && 
      o.pickupDate === pickupDate && 
      o.dishLetter === dishLetter &&
      o.status === 'PAID'
    );
    
    // 5) runningNumber = existingCount + 1
    const runningNumber = existingOrders.length + 1;
    
    // 6) pickupCode = `${runningNumber}${dishLetter}`
    const pickupCode = `${runningNumber}${dishLetter}`;
    
    return {dishLetter, runningNumber, pickupCode};
  }
  
  /**
   * Generate dish-letter pickup code (legacy wrapper, uses assignPickupCode)
   * @param {string} orderId - Order ID
   * @param {string} dishId - Dish/Offer ID
   * @param {string} providerIdVal - Provider ID (from order)
   * @param {string} day - ISO date string (YYYY-MM-DD)
   * @returns {{code: string, dishLetter: string, runningNumber: number}} - Format: "1A", "2A", "3B", etc.
   */
  function generateDishLetterPickupCode(orderId, dishId, providerIdVal, day){
    const pickupDate = day || isoDate(new Date());
    // Use assignPickupCode (deterministic)
    const result = assignPickupCode({providerId: providerIdVal, pickupDate, dishId});
    return {code: result.pickupCode, dishLetter: result.dishLetter, runningNumber: result.runningNumber};
  }

  // --- State ---
  let mode = load(LS.mode, 'customer'); // 'start' | 'customer' | 'provider' (Standard: 'customer' für Discover-Seite)
  // Angebote werden später durch seedExampleData() oder seed() geladen
  // Zuerst aus localStorage laden, falls vorhanden
  let offers = load(LS.offers, []);
  const legacyFavs = load(LS.favs, []);
  let providerFavs = new Set(load(LS.providerFavs, legacyFavs));
  let dishFavs = new Set(load(LS.dishFavs, []));
  let cart = load(LS.cart, null); // {providerId, items:[{offerId, qty}]} or null
  let orders = loadOrders(); // Load via Order Store
  let customer = load(LS.customer, { 
    loggedIn:false, 
    name:null,
    email:null,
    dietaryPreferences: {
      vegan: false,
      vegetarian: false,
      glutenFree: false,
      lactoseFree: false
    }
  });
  let provider = load(LS.provider, { loggedIn:false, email:null, profile:{ name:'', address:'', street:'', zip:'', city:'', mealWindow:'11:30 – 14:00', logoData:'' } });
  let cookbook = load(LS.cookbook, []); // [{id, dish, category, price, allergens[], extras?, reuse? , photoData?}]
  let week = load(LS.week, {}); // { 'YYYY-MM-DD': [cookbookId,...] }

  const CATEGORIES = ['Vegetarisch','Vegan','Fisch','Mit Fleisch'];
  const CAT_MAP = {
    'Vegan':'Vegan',
    'Vegetarisch':'Vegetarisch',
    'Fisch':'Fisch',
    'Mit Fleisch':'Fleisch'
  };
  const DISH_SUGGESTIONS = [
    {name:'Kürbissuppe', category:'Vegan'},
    {name:'Tomatensuppe mit Brot', category:'Vegan'},
    {name:'Pasta mit Gemüse', category:'Vegetarisch'},
    {name:'Käsespätzle', category:'Vegetarisch'},
    {name:'Salat Bowl', category:'Vegetarisch'},
    {name:'Falafel Teller', category:'Vegan'},
    {name:'Veggie Burger', category:'Vegan'},
    {name:'Schnitzel mit Pommes', category:'Fleisch'},
    {name:'Currywurst', category:'Fleisch'},
    {name:'Gulasch mit Spätzle', category:'Fleisch'}
  ];

  // Day slider: today..+6
  // Format: "Montag, 24.01." (immer vollständiger Wochentag + DD.MM.)
  function fmtDay(d, includeToday = false){
    const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
    const wd = weekdays[d.getDay()];
    const day = String(d.getDate()).padStart(2,'0');
    const month = String(d.getMonth()+1).padStart(2,'0');
    
    if(includeToday){
      const today = new Date();
      const isToday = d.toDateString() === today.toDateString();
      if(isToday){
        return `Heute, ${wd} ${day}.${month}.`;
      }
    }
    
    return `${wd}, ${day}.${month}.`;
  }
  
  // Format date with time range: "Montag, 24.01. · 11:30–14:30"
  function fmtDateWithTime(d, timeRange){
    const dateStr = fmtDay(d);
    return timeRange ? `${dateStr} · ${timeRange}` : dateStr;
  }
  
  function isoDate(d){ return d.toISOString().slice(0,10); }

  let activeCat = null;
  let activeDay = isoDate(new Date());
  let providerWeekDay = isoDate(new Date());
  let pickupSort = 'code'; // Default: sort by code (1A, 1B, 1C, 2A, 2B...)
  let pickupFilter = 'offen'; // 'offen' | 'abgeholt'
  let cookbookSort = 'recent';
  let cookbookQuery = '';
  let cookbookTab = 'dishes';
  let weekPlanDay = isoDate(new Date());
  let locationQuery = '';
  let pickupDone = new Set(load(LS.pickupDone, []));
  let activeOrderId = null;
  let ordersFilter = 'offen';
  let pickupUndoKey = null;
  let pickupUndoTimer = null;
  let billingFilter = 'month';
  let billingMonth = '2026-01';

  // --- Seed demo offers (Testanbieter) ---
  function seed(){
    // Testdaten immer erstellen (zum Testen)
    const today = isoDate(new Date());
    offers = [
      // 4 Testanbieter × 4 Gerichte (mit Bildern & je Abholcodes)
      
      // 1. Pizzeria Bella Vista (Stuttgart)
      {id: cryptoId(), providerId: 'p_bellavista', providerName: 'Pizzeria Bella Vista', address: 'Hauptstraße 45, 70173 Stuttgart', title: 'Leberkäse mit Spätzle', price: 6.90, time: '11:30 – 14:30', diet: 'Fleisch', day: today, img: 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 3},
      {id: cryptoId(), providerId: 'p_bellavista', providerName: 'Pizzeria Bella Vista', address: 'Hauptstraße 45, 70173 Stuttgart', title: 'Pizza Quattro Formaggi', price: 8.50, time: '11:30 – 14:30', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1571997478779-2adcbbe9ab2f?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 4},
      {id: cryptoId(), providerId: 'p_bellavista', providerName: 'Pizzeria Bella Vista', address: 'Hauptstraße 45, 70173 Stuttgart', title: 'Pasta Carbonara', price: 8.80, time: '11:30 – 14:30', diet: 'Fleisch', day: today, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 2},
      {id: cryptoId(), providerId: 'p_bellavista', providerName: 'Pizzeria Bella Vista', address: 'Hauptstraße 45, 70173 Stuttgart', title: 'Insalata Caprese', price: 7.20, time: '11:30 – 14:30', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 3},

      // 2. Asia Wok Express (Tübingen)
      {id: cryptoId(), providerId: 'p_asiawok', providerName: 'Asia Wok Express', address: 'Neckarhalde 8, 72070 Tübingen', title: 'Hähnchen Teriyaki', price: 8.90, time: '11:00 – 14:00', diet: 'Fleisch', day: today, img: 'https://images.unsplash.com/photo-1603133872878-684f208fb84b?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 5},
      {id: cryptoId(), providerId: 'p_asiawok', providerName: 'Asia Wok Express', address: 'Neckarhalde 8, 72070 Tübingen', title: 'Gebratene Nudeln mit Gemüse', price: 7.50, time: '11:00 – 14:00', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1569718212165-3a8278d5f624?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 4},
      {id: cryptoId(), providerId: 'p_asiawok', providerName: 'Asia Wok Express', address: 'Neckarhalde 8, 72070 Tübingen', title: 'Pad Thai', price: 8.40, time: '11:00 – 14:00', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 3},
      {id: cryptoId(), providerId: 'p_asiawok', providerName: 'Asia Wok Express', address: 'Neckarhalde 8, 72070 Tübingen', title: 'Frühlingsrollen (4 Stück)', price: 6.80, time: '11:00 – 14:00', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1529692236671-f1f6cf9683ba?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 6},

      // 3. Burger House (Ludwigsburg)
      {id: cryptoId(), providerId: 'p_burgerhouse', providerName: 'Burger House', address: 'Wilhelmstraße 12, 71634 Ludwigsburg', title: 'Classic Cheeseburger', price: 8.90, time: '11:30 – 14:00', diet: 'Fleisch', day: today, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 4},
      {id: cryptoId(), providerId: 'p_burgerhouse', providerName: 'Burger House', address: 'Wilhelmstraße 12, 71634 Ludwigsburg', title: 'Veggie Burger', price: 7.90, time: '11:30 – 14:00', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1525059696034-4967a7290027?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 3},
      {id: cryptoId(), providerId: 'p_burgerhouse', providerName: 'Burger House', address: 'Wilhelmstraße 12, 71634 Ludwigsburg', title: 'Chicken Burger', price: 9.20, time: '11:30 – 14:00', diet: 'Fleisch', day: today, img: 'https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 5},
      {id: cryptoId(), providerId: 'p_burgerhouse', providerName: 'Burger House', address: 'Wilhelmstraße 12, 71634 Ludwigsburg', title: 'Sweet Potato Fries', price: 4.50, time: '11:30 – 14:00', diet: 'Vegan', day: today, img: 'https://images.unsplash.com/photo-1573080496219-bb080dd4f877?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 8},

      // 4. Green Garden (Esslingen)
      {id: cryptoId(), providerId: 'p_greengarden', providerName: 'Green Garden', address: 'Marktplatz 7, 73728 Esslingen', title: 'Avocado-Bowl', price: 9.50, time: '11:00 – 14:00', diet: 'Vegan', day: today, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 4},
      {id: cryptoId(), providerId: 'p_greengarden', providerName: 'Green Garden', address: 'Marktplatz 7, 73728 Esslingen', title: 'Quinoa-Salat', price: 8.20, time: '11:00 – 14:00', diet: 'Vegan', day: today, img: 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 5},
      {id: cryptoId(), providerId: 'p_greengarden', providerName: 'Green Garden', address: 'Marktplatz 7, 73728 Esslingen', title: 'Falafel-Wrap', price: 7.80, time: '11:00 – 14:00', diet: 'Vegan', day: today, img: 'https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 6},
      {id: cryptoId(), providerId: 'p_greengarden', providerName: 'Green Garden', address: 'Marktplatz 7, 73728 Esslingen', title: 'Gemüse-Curry', price: 8.60, time: '11:00 – 14:00', diet: 'Vegan', day: today, img: 'https://images.unsplash.com/photo-1546069901-d5bfd2cbfb1f?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 3},
    ];
    save(LS.offers, offers);
  }

  // --- Beispieldaten: 10 Anbieter mit je 3 Gerichten und 10 Abholcodes ---
  function seedExampleData(){
    const today = isoDate(new Date());
    const providerNames = [
      {id: 'p_01', name: 'Pizzeria Bella Vista', address: 'Hauptstraße 45, 70173 Stuttgart', street: 'Hauptstraße 45', zip: '70173', city: 'Stuttgart'},
      {id: 'p_02', name: 'Asia Wok Express', address: 'Neckarhalde 8, 72070 Tübingen', street: 'Neckarhalde 8', zip: '72070', city: 'Tübingen'},
      {id: 'p_03', name: 'Burger House', address: 'Wilhelmstraße 12, 71634 Ludwigsburg', street: 'Wilhelmstraße 12', zip: '71634', city: 'Ludwigsburg'},
      {id: 'p_04', name: 'Green Garden', address: 'Marktplatz 7, 73728 Esslingen', street: 'Marktplatz 7', zip: '73728', city: 'Esslingen'},
      {id: 'p_05', name: 'La Trattoria', address: 'Königstraße 23, 70173 Stuttgart', street: 'Königstraße 23', zip: '70173', city: 'Stuttgart'},
      {id: 'p_06', name: 'Sushi Bar Tokyo', address: 'Eberhardstraße 15, 72072 Tübingen', street: 'Eberhardstraße 15', zip: '72072', city: 'Tübingen'},
      {id: 'p_07', name: 'Curry & Co', address: 'Bahnhofstraße 8, 71634 Ludwigsburg', street: 'Bahnhofstraße 8', zip: '71634', city: 'Ludwigsburg'},
      {id: 'p_08', name: 'Veggie Delight', address: 'Hafenstraße 12, 73728 Esslingen', street: 'Hafenstraße 12', zip: '73728', city: 'Esslingen'},
      {id: 'p_09', name: 'Steakhouse Premium', address: 'Schillerplatz 5, 70173 Stuttgart', street: 'Schillerplatz 5', zip: '70173', city: 'Stuttgart'},
      {id: 'p_10', name: 'Bio Bistro', address: 'Münzgasse 3, 72070 Tübingen', street: 'Münzgasse 3', zip: '72070', city: 'Tübingen'}
    ];

    const dishTemplates = [
      // Verschiedene Kategorien
      {dish: 'Kürbissuppe', category: 'Vegan', price: 6.50, img: 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Pasta Carbonara', category: 'Mit Fleisch', price: 8.80, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Salat Bowl', category: 'Vegetarisch', price: 7.90, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Hähnchen Teriyaki', category: 'Mit Fleisch', price: 9.20, img: 'https://images.unsplash.com/photo-1603133872878-684f208fb84b?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Falafel Teller', category: 'Vegan', price: 7.50, img: 'https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Käsespätzle', category: 'Vegetarisch', price: 7.20, img: 'https://images.unsplash.com/photo-1546069901-d5bfd2cbfb1f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Pizza Margherita', category: 'Vegetarisch', price: 8.50, img: 'https://images.unsplash.com/photo-1571997478779-2adcbbe9ab2f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Lachs mit Gemüse', category: 'Fisch', price: 10.50, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Veggie Burger', category: 'Vegan', price: 7.90, img: 'https://images.unsplash.com/photo-1525059696034-4967a7290027?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Schnitzel mit Pommes', category: 'Mit Fleisch', price: 9.80, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Quinoa-Salat', category: 'Vegan', price: 8.20, img: 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Thunfisch-Steak', category: 'Fisch', price: 11.20, img: 'https://images.unsplash.com/photo-1569718212165-3a8278d5f624?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Gulasch mit Spätzle', category: 'Mit Fleisch', price: 9.50, img: 'https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Gemüse-Curry', category: 'Vegan', price: 8.60, img: 'https://images.unsplash.com/photo-1546069901-d5bfd2cbfb1f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Risotto ai Funghi', category: 'Vegetarisch', price: 8.90, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Sushi Platte', category: 'Fisch', price: 12.50, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Steak mit Beilagen', category: 'Mit Fleisch', price: 13.90, img: 'https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Buddha Bowl', category: 'Vegan', price: 8.80, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Caprese Salat', category: 'Vegetarisch', price: 7.40, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Fischfilet mit Kartoffeln', category: 'Fisch', price: 10.80, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Chili con Carne', category: 'Mit Fleisch', price: 8.70, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Avocado-Bowl', category: 'Vegan', price: 9.50, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Mozzarella-Pasta', category: 'Vegetarisch', price: 8.30, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Lachs-Tartar', category: 'Fisch', price: 11.90, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Hamburger Classic', category: 'Mit Fleisch', price: 8.90, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Tofu-Wrap', category: 'Vegan', price: 7.60, img: 'https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Gemüse-Lasagne', category: 'Vegetarisch', price: 9.20, img: 'https://images.unsplash.com/photo-1546069901-d5bfd2cbfb1f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Forelle blau', category: 'Fisch', price: 10.40, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Rinderbraten', category: 'Mit Fleisch', price: 12.50, img: 'https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Power-Smoothie Bowl', category: 'Vegan', price: 6.90, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60'}
    ];

    const newOffers = [];
    const newCookbook = [];
    const newOrders = [];

    providerNames.forEach((provider, pIdx) => {
      // 3 Gerichte pro Provider (verschiedene Kategorien)
      const dishIndices = [
        (pIdx * 3) % dishTemplates.length,
        ((pIdx * 3 + 1) % dishTemplates.length),
        ((pIdx * 3 + 2) % dishTemplates.length)
      ];

      dishIndices.forEach((dishIdx, dIdx) => {
        const template = dishTemplates[dishIdx];
        const cookbookId = cryptoId();
        const offerId = cryptoId();

        // Kochbuch-Eintrag
        newCookbook.push({
          id: cookbookId,
          providerId: provider.id,
          dish: template.dish,
          category: template.category,
          price: template.price,
          allergens: [],
          extras: [],
          reuse: {enabled: false, deposit: 0},
          photoData: template.img,
          hasPickupCode: true,
          dineInPossible: true,
          createdAt: Date.now() - (pIdx * 86400000) - (dIdx * 3600000),
          lastUsed: Date.now() - (pIdx * 86400000) - (dIdx * 3600000)
        });

        // Offer (Inserat für heute)
        newOffers.push({
          id: offerId,
          providerId: provider.id,
          providerName: provider.name,
          providerStreet: provider.street,
          providerZip: provider.zip,
          providerCity: provider.city,
          address: provider.address,
          dish: template.dish,
          category: template.category,
          price: template.price,
          pickupWindow: '11:30 – 14:00',
          day: today,
          imageUrl: template.img,
          hasPickupCode: true,
          dineInPossible: true,
          allergens: [],
          extras: [],
          reuse: {enabled: false, deposit: 0},
          active: true,
          createdAt: Date.now() - (pIdx * 3600000) - (dIdx * 600000)
        });
      });
    });

    // Zuerst Offers speichern, damit assignPickupCode sie verwenden kann
    // WICHTIG: Ersetze alte Offers, damit keine Duplikate entstehen
    offers = [...newOffers];
    save(LS.offers, offers);

    // Jetzt Bestellungen mit Abholcodes erstellen
    providerNames.forEach((provider, pIdx) => {
      const dishIndices = [
        (pIdx * 3) % dishTemplates.length,
        ((pIdx * 3 + 1) % dishTemplates.length),
        ((pIdx * 3 + 2) % dishTemplates.length)
      ];

      dishIndices.forEach((dishIdx, dIdx) => {
        const template = dishTemplates[dishIdx];
        // Finde das entsprechende Offer
        const offer = newOffers.find(o => 
          o.providerId === provider.id && 
          o.dish === template.dish
        );
        if(!offer) return;

        // 10 Bestellungen pro Provider (mit Abholcodes)
        // Verteilung: 3-4 pro Gericht
        const ordersPerDish = dIdx === 0 ? 4 : (dIdx === 1 ? 3 : 3);
        for(let o = 0; o < ordersPerDish; o++){
          const orderId = cryptoId();
          const pickupCode = assignPickupCode({
            providerId: provider.id,
            pickupDate: today,
            dishId: offer.id
          });

          newOrders.push({
            id: orderId,
            createdAt: Date.now() - (pIdx * 3600000) - (dIdx * 600000) - (o * 60000),
            updatedAt: Date.now() - (pIdx * 3600000) - (dIdx * 600000) - (o * 60000),
            dishId: offer.id,
            dishName: template.dish,
            providerId: provider.id,
            providerName: provider.name,
            providerAddress: provider.address,
            quantity: 1,
            unitPrice: Math.round(template.price * 100), // in cents
            total: Math.round(template.price * 100),
            fulfillType: 'PICKUP',
            status: 'PAID',
            currency: 'EUR',
            pickupCode: pickupCode.pickupCode,
            pickupCodeActivatedAt: Date.now() - (pIdx * 3600000) - (dIdx * 600000) - (o * 60000),
            pickupDate: today,
            pickupWindow: '11:30 – 14:00',
            dishLetter: pickupCode.dishLetter,
            runningNumber: pickupCode.runningNumber,
            offerId: offer.id,
            isGuest: false
          });
        }
      });
    });

    // Speichern (Offers bereits oben gespeichert)
    // Ersetze Cookbook komplett für Demo (keine Duplikate)
    const existingCookbook = cookbook.filter(c => !providerNames.some(p => p.id === c.providerId));
    cookbook = [...existingCookbook, ...newCookbook];
    save(LS.cookbook, cookbook);

    const existingOrders = loadOrders();
    const allOrders = [...existingOrders, ...newOrders];
    saveOrders(allOrders);

    console.log(`✅ Beispieldaten erstellt: ${providerNames.length} Anbieter, ${newCookbook.length} Kochbuch-Einträge, ${newOffers.length} Inserate, ${newOrders.length} Bestellungen`);
    return {providers: providerNames.length, cookbook: newCookbook.length, offers: newOffers.length, orders: newOrders.length};
  }

  // --- Test-Funktion für Abholcode-Logik ---
  function testPickupCodeLogic(){
    console.log('🧪 Teste Abholcode-Logik...');
    const today = isoDate(new Date());
    
    // Test 1: Prüfe ob Beispieldaten vorhanden sind
    const allOrders = loadOrders();
    const allOffers = offers;
    const todayOrders = allOrders.filter(o => o.pickupDate === today && o.status === 'PAID');
    const todayOffers = allOffers.filter(o => o.day === today && o.active !== false);
    
    console.log(`📊 Test 1 - Daten vorhanden:`);
    console.log(`  - Heutige Bestellungen: ${todayOrders.length}`);
    console.log(`  - Heutige Inserate: ${todayOffers.length}`);
    
    if(todayOrders.length === 0){
      console.warn('⚠️ Keine Bestellungen für heute gefunden. seedExampleData() ausführen?');
      return false;
    }
    
    // Test 2: Prüfe Abholcode-Format
    console.log(`\n📊 Test 2 - Abholcode-Format:`);
    const codes = todayOrders.map(o => o.pickupCode).filter(Boolean);
    const invalidCodes = codes.filter(c => !/^\d+[A-E]$/.test(c));
    if(invalidCodes.length > 0){
      console.error(`❌ Ungültige Codes gefunden: ${invalidCodes.join(', ')}`);
      return false;
    }
    console.log(`  ✅ Alle ${codes.length} Codes haben gültiges Format (z.B. "1A", "2B")`);
    
    // Test 3: Prüfe Eindeutigkeit pro Provider/Tag
    console.log(`\n📊 Test 3 - Eindeutigkeit pro Provider/Tag:`);
    const providers = [...new Set(todayOrders.map(o => o.providerId))];
    let allUnique = true;
    providers.forEach(pid => {
      const providerOrders = todayOrders.filter(o => o.providerId === pid);
      const providerCodes = providerOrders.map(o => o.pickupCode);
      const uniqueCodes = [...new Set(providerCodes)];
      if(providerCodes.length !== uniqueCodes.length){
        console.error(`❌ Provider ${pid}: Duplikate gefunden!`);
        console.error(`  Codes: ${providerCodes.join(', ')}`);
        allUnique = false;
      } else {
        console.log(`  ✅ Provider ${pid}: ${providerCodes.length} eindeutige Codes`);
      }
    });
    if(!allUnique) return false;
    
    // Test 4: Prüfe dishLetter-Zuordnung
    console.log(`\n📊 Test 4 - dishLetter-Zuordnung:`);
    providers.forEach(pid => {
      const providerOffers = todayOffers.filter(o => o.providerId === pid).sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0));
      const providerOrders = todayOrders.filter(o => o.providerId === pid);
      
      // Erwartete Letters: A, B, C (für 3 Gerichte)
      const expectedLetters = ['A', 'B', 'C'];
      const actualLetters = [...new Set(providerOrders.map(o => o.dishLetter).filter(Boolean))].sort();
      
      console.log(`  Provider ${pid}:`);
      console.log(`    - Inserate: ${providerOffers.length} (erwartet: 3)`);
      console.log(`    - Bestellungen: ${providerOrders.length} (erwartet: 10)`);
      console.log(`    - dishLetters: ${actualLetters.join(', ')} (erwartet: A, B, C)`);
      
      // Prüfe ob Letters korrekt zugeordnet sind
      providerOffers.forEach((offer, idx) => {
        const expectedLetter = expectedLetters[idx] || 'A';
        const ordersForOffer = providerOrders.filter(o => o.offerId === offer.id);
        const lettersForOffer = [...new Set(ordersForOffer.map(o => o.dishLetter))];
        if(lettersForOffer.length !== 1 || lettersForOffer[0] !== expectedLetter){
          console.warn(`    ⚠️ Offer "${offer.dish}" hat unerwartete Letters: ${lettersForOffer.join(', ')} (erwartet: ${expectedLetter})`);
        } else {
          console.log(`    ✅ Offer "${offer.dish}": Letter ${expectedLetter}, ${ordersForOffer.length} Bestellungen`);
        }
      });
    });
    
    // Test 5: Prüfe runningNumber-Sequenz
    console.log(`\n📊 Test 5 - runningNumber-Sequenz:`);
    providers.forEach(pid => {
      const providerOrders = todayOrders.filter(o => o.providerId === pid);
      const letters = ['A', 'B', 'C'];
      letters.forEach(letter => {
        const ordersForLetter = providerOrders.filter(o => o.dishLetter === letter).sort((a,b) => a.runningNumber - b.runningNumber);
        if(ordersForLetter.length > 0){
          const numbers = ordersForLetter.map(o => o.runningNumber);
          const expected = Array.from({length: ordersForLetter.length}, (_, i) => i + 1);
          const isSequential = JSON.stringify(numbers) === JSON.stringify(expected);
          if(!isSequential){
            console.error(`❌ Provider ${pid}, Letter ${letter}: Sequenz fehlerhaft!`);
            console.error(`  Gefunden: ${numbers.join(', ')}`);
            console.error(`  Erwartet: ${expected.join(', ')}`);
          } else {
            console.log(`  ✅ Provider ${pid}, Letter ${letter}: Sequenz korrekt (1-${numbers.length})`);
          }
        }
      });
    });
    
    // Test 6: Prüfe assignPickupCode Funktion direkt
    console.log(`\n📊 Test 6 - assignPickupCode Funktion:`);
    if(todayOffers.length > 0 && providers.length > 0){
      const testProvider = providers[0];
      const testOffers = todayOffers.filter(o => o.providerId === testProvider).sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0));
      if(testOffers.length > 0){
        const testOffer = testOffers[0];
        const testResult = assignPickupCode({
          providerId: testProvider,
          pickupDate: today,
          dishId: testOffer.id
        });
        console.log(`  Test für Provider ${testProvider}, Offer "${testOffer.dish}":`);
        console.log(`    - dishLetter: ${testResult.dishLetter} (erwartet: A)`);
        console.log(`    - runningNumber: ${testResult.runningNumber}`);
        console.log(`    - pickupCode: ${testResult.pickupCode}`);
        
        const existingCount = todayOrders.filter(o => 
          o.providerId === testProvider && 
          o.pickupDate === today && 
          o.dishLetter === testResult.dishLetter &&
          o.status === 'PAID'
        ).length;
        const expectedRunningNumber = existingCount + 1;
        if(testResult.runningNumber === expectedRunningNumber){
          console.log(`    ✅ runningNumber korrekt (${testResult.runningNumber} = ${existingCount} + 1)`);
        } else {
          console.error(`    ❌ runningNumber falsch! Gefunden: ${testResult.runningNumber}, Erwartet: ${expectedRunningNumber}`);
        }
      }
    }
    
    console.log(`\n✅ Alle Tests abgeschlossen!`);
    return true;
  }

  // --- UI helpers ---
  function euro(n){
    const v = Number(n||0);
    return v.toFixed(2).replace('.',',') + ' €';
  }
  function cryptoId(){
    return 'id_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
  }
  function esc(s){
    return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[c]));
  }

  const ICONS = {
    plus:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>',
    book:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M4 4.5A2.5 2.5 0 0 1 6.5 2H20v15H6.5A2.5 2.5 0 0 0 4 17.5z"/></svg>',
    share:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="m16 6-4-4-4 4"/><path d="M12 2v14"/></svg>',
    'share-2':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="m8.59 13.51 6.83 3.98"/><path d="m15.41 6.51-6.82 3.98"/></svg>',
    print:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 14h12v8H6z"/></svg>',
    edit:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>',
    action:'<svg viewBox="0 0 24 24" fill="currentColor"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/></svg>',
    heart:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.8 6.6a5 5 0 0 0-7.1 0L12 8.3l-1.7-1.7a5 5 0 1 0-7.1 7.1L12 22l8.8-8.3a5 5 0 0 0 0-7.1Z"/></svg>',
    heartFilled:'<svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><path d="M20.8 6.6a5 5 0 0 0-7.1 0L12 8.3l-1.7-1.7a5 5 0 1 0-7.1 7.1L12 22l8.8-8.3a5 5 0 0 0 0-7.1Z"/></svg>',
    cart:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2h12l2 7H4z"/><path d="M4 9h16v11a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V9Z"/></svg>',
    'shopping-cart':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>',
    location:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s7-7.2 7-12a7 7 0 1 0-14 0c0 4.8 7 12 7 12z"/><circle cx="12" cy="10" r="2.5"/></svg>',
    star:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 2 3 7 7 .6-5.2 4.5 1.6 7L12 17l-6.4 4.1 1.6-7L2 9.6 9 9z"/></svg>',
    box:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7l9-4 9 4-9 4-9-4Z"/><path d="M3 7v10l9 4 9-4V7"/><path d="M12 11v10"/></svg>',
    leaf:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 14c6-8 14-8 16-6-2 8-10 16-18 14 0-6 2-8 2-8Z"/><path d="M6 14c2 0 6 0 10-4"/></svg>',
    flame:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2s3 4 3 7a3 3 0 1 1-6 0c0-3 3-7 3-7Z"/><path d="M5.5 14.5a6.5 6.5 0 1 0 13 0c0-3.5-2.5-6.5-6.5-9-4 2.5-6.5 5.5-6.5 9Z"/></svg>',
    calendar:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>',
    eye:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6S2 12 2 12Z"/><circle cx="12" cy="12" r="3"/></svg>',
    info:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 10v6"/><path d="M12 7h.01"/></svg>',
    card:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/></svg>',
    home:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 11.5 12 4l9 7.5"/><path d="M5 10.5V20h14v-9.5"/></svg>',
    user:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20a8 8 0 0 1 16 0"/></svg>',
    compass:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M15 9l-2 6-6 2 2-6 6-2Z"/></svg>',
    receipt:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2h12v20l-3-2-3 2-3-2-3 2Z"/><path d="M8 6h8M8 10h8M8 14h6"/></svg>',
    bookOpen:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 5h7a4 4 0 0 1 4 4v12H6a4 4 0 0 0-4 4Z"/><path d="M22 5h-7a4 4 0 0 0-4 4v12h7a4 4 0 0 1 4 4Z"/></svg>',
    clock:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 7v6l4 2"/></svg>',
    globe:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M3 12h18"/><path d="M12 3a12 12 0 0 1 0 18"/><path d="M12 3a12 12 0 0 0 0 18"/></svg>',
    link:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 1 0-7l2-2a5 5 0 0 1 7 7l-2 2"/><path d="M14 11a5 5 0 0 1 0 7l-2 2a5 5 0 0 1-7-7l2-2"/></svg>',
    message:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a4 4 0 0 1-4 4H7l-4 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/></svg>',
    camera:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h4l2-3h4l2 3h4v12H4z"/><circle cx="12" cy="13" r="3"/></svg>',
    mail:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="m3 7 9 6 9-6"/></svg>',
    shield:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2 20 5v6c0 5-3.5 9-8 11-4.5-2-8-6-8-11V5z"/></svg>',
    file:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>',
    wallet:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7h18a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H3z"/><path d="M3 7V5a2 2 0 0 1 2-2h14"/><path d="M17 12h4"/></svg>',
    utensils:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 2v6a4 4 0 0 0 8 0V2"/><path d="M8 2v10"/><path d="M16 2v20"/><path d="M20 2v6a2 2 0 0 1-2 2h-2"/></svg>',
    // Mittagio Icon Set (Lucide Icons - Outline only)
    carrot:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2.5 16.88a1 1 0 0 1-.32-1.43l1.5-2.5a1 1 0 0 1 1.37-.37L8 15l5-5-2-2-5 5-3.13-1.95a1 1 0 0 0-1.37.37l-2.5 1.5a1 1 0 0 0-.5.88Z"/><path d="M16 21h5a1 1 0 0 0 1-1v-5"/><path d="M21 16l-5 5"/><path d="M11 2L9 4l5 5 2-2-5-5Z"/></svg>',
    drumstick:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15.5 9.5 12 13l-1-1-1 1c-1 1-2.5 1.5-4 1l-1 1c-.5.5-1 1.5-1 2.5 0 1 .5 1.5 1 2l2 2c.5.5 1 .5 1.5 0l1-1c-.5-1.5 0-3 1-4l1-1 1 1 3.5-3.5Z"/><path d="M20 2v10"/><path d="M22 4h-4"/></svg>',
    fish:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 10s3-3 8-3 8 3 8 3-3 3-8 3-8-3-8-3Z"/><path d="M4 10v4"/><path d="M8 10v4"/><path d="M12 10v4"/><path d="M16 10v4"/><path d="M2 16s3-3 8-3 8 3 8 3"/><path d="M2 4s3 3 8 3 8-3 8-3"/></svg>',
    'key-round':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="15" r="4"/><path d="m10 15 6-6"/><path d="m18 5 2 2"/><path d="m20 5-2 2"/></svg>',
    'credit-card':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/></svg>',
    'shopping-bag':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>',
    package:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 18v-8Z"/><path d="M3.27 6.96 12 12.01l8.73-5.05"/><path d="M12 22.08V12"/></svg>',
    'utensils-crossed':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15.5-1-.5.5"/><path d="M15 2v5"/><path d="M12 22V8"/><path d="M12 2v3"/><path d="M19 22V11"/><path d="M19 2v4"/><path d="M2 22l20-20"/></svg>',
    store:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7v13h16V7"/><path d="M4 7l2-5h12l2 5"/><path d="M9 12v6"/><path d="M15 12v6"/></svg>',
    'calendar-days':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/><path d="M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01M16 18h.01"/></svg>',
    'map-pin':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>',
    copy:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>',
    check:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6 9 17l-5-5"/></svg>',
    'arrow-left':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>',
    'maximize-2':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6"/><path d="M9 21H3v-6"/><path d="M21 3l-7 7"/><path d="M3 21l7-7"/></svg>',
    x:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg>',
    'alert-circle':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>'
  };
  const iconMarkup = (name, opts={})=> {
    const iconName = opts.fill && ICONS[name + 'Filled'] ? name + 'Filled' : name;
    return ICONS[iconName] ? `<span class="ico-inline">${ICONS[iconName]}</span>` : '';
  };
  function applyStaticIcons(){
    document.querySelectorAll('[data-icon]').forEach(el=>{
      if(el.dataset.iconApplied) return;
      const iconOnly = el.dataset.iconOnly === '1';
      const label = el.dataset.label || el.textContent.trim();
      el.dataset.label = label;
      if(iconOnly){
        el.innerHTML = iconMarkup(el.dataset.icon);
      } else {
        el.innerHTML = `${iconMarkup(el.dataset.icon)}<span>${esc(label)}</span>`;
      }
      el.dataset.iconApplied = '1';
    });
  }

  function seededInfoKey(str){
    const s = String(str||'');
    let h = 0;
    for(let i=0;i<s.length;i++){ h = (h*31 + s.charCodeAt(i)) % 10000; }
    return h;
  }
  function seededInfo(str){
    const h = seededInfoKey(str);
    const distanceKm = Number((0.5 + (h % 80) / 10).toFixed(1));
    const rating = Number((4 + (h % 9) / 10).toFixed(1));
    const ratingCount = 30 + (h % 400);
    // No-Limits: Keine Mengenangaben mehr
    return {distanceKm, rating, ratingCount};
  }

  const DEFAULT_MEAL_WINDOW = '11:30 – 14:00';

  function buildAddress(p){
    if(p && p.address && String(p.address).trim()) return String(p.address).trim();
    const rest = [p?.zip, p?.city].filter(Boolean).join(' ').trim();
    return [p?.street, rest].filter(Boolean).join(', ');
  }

  function parseAddress(addr){
    const raw = String(addr||'').trim();
    const out = { address: raw, street:'', zip:'', city:'' };
    if(!raw) return out;
    const parts = raw.split(',').map(s=>s.trim()).filter(Boolean);
    if(parts.length){ out.street = parts[0]; }
    if(parts.length > 1){
      const rest = parts.slice(1).join(', ');
      const m = rest.match(/^(\d{4,6})\s*(.*)$/);
      if(m){ out.zip = m[1]; out.city = m[2] || ''; }
      else { out.city = rest; }
    }
    return out;
  }

  function normalizeProviderProfile(p){
    const base = { name:'', address:'', street:'', zip:'', city:'', mealWindow:DEFAULT_MEAL_WINDOW, logoData:'' };
    const out = {...base, ...(p||{})};
    if(!out.address){ out.address = buildAddress(out); }
    if(!out.mealWindow){ out.mealWindow = DEFAULT_MEAL_WINDOW; }
    return out;
  }

  function normalizeOffer(o){
    const out = {...(o||{})};
    if(!out.dish && out.title) out.dish = out.title;
    if(!out.imageUrl && out.img) out.imageUrl = out.img;
    if(!out.pickupWindow && out.time) out.pickupWindow = out.time;
    if(!out.category && out.diet) out.category = out.diet;

    if(out.address && (!out.providerStreet && !out.providerZip && !out.providerCity)){
      const parsed = parseAddress(out.address);
      out.providerStreet = out.providerStreet || parsed.street || '';
      out.providerZip = out.providerZip || parsed.zip || '';
      out.providerCity = out.providerCity || parsed.city || '';
    }
    out.providerStreet = out.providerStreet || '';
    out.providerZip = out.providerZip || '';
    out.providerCity = out.providerCity || '';
    out.hasPickupCode = !!out.hasPickupCode;
    out.dineInPossible = !!out.dineInPossible;
    if(out.active === undefined) out.active = true;
    const info = seededInfo(out.dish || out.providerName || out.providerId);
    if(out.distanceKm == null) out.distanceKm = info.distanceKm;
    if(out.rating == null) out.rating = info.rating;
    if(out.ratingCount == null) out.ratingCount = info.ratingCount;
    // No-Limits: availableCount entfernt - Status wird nur über active gesteuert
    return out;
  }

  // --- Navigation ---
  const views = {
    start:'v-start',
    discover:'v-discover', fav:'v-fav', orders:'v-orders', cart:'v-cart', profile:'v-profile',
    pickupCode:'v-pickup-code', // Neuer AbholcodeScreen
    checkout:'v-checkout', // One-Page Checkout
    providerLogin:'v-provider-login',
    providerOnboardingEntry:'v-provider-onboarding-entry',
    providerOnboardingFirstDish:'v-provider-onboarding-first-dish',
    providerOnboardingSignup:'v-provider-onboarding-signup',
    providerOnboardingBusiness:'v-provider-onboarding-business',
    providerOnboardingPreview:'v-provider-onboarding-preview',
    providerHome:'v-provider-home', providerPickups:'v-provider-pickups', providerCookbook:'v-provider-cookbook',
    providerProfile:'v-provider-profile', providerBilling:'v-provider-billing', providerWeek:'v-provider-week',
    legalImpressum:'v-legal-impressum', legalAgbKurz:'v-legal-agb-kurz', legalDatenschutz:'v-legal-datenschutz', legalAgbOnboarding:'v-legal-agb-onboarding'
  };

  function setCustomerNavActive(go){
    document.querySelectorAll('#customerNav .navbtn').forEach(b=>b.classList.toggle('active', b.dataset.go===go));
  }
  function setProviderNavActive(go){
    document.querySelectorAll('#providerNav .navbtn').forEach(b=>b.classList.toggle('active', b.dataset.pgo===go));
  }

  function showView(id){
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo({top:0,behavior:'smooth'});
  }

  function setMode(next){
    mode = next;
    save(LS.mode, mode);

    const isProv = mode==='provider';
    const isStart = mode==='start';
    const isCustomer = mode==='customer';
    const customerNav = document.getElementById('customerNav');
    const providerNav = document.getElementById('providerNav');
    const discoverFilters = document.getElementById('discoverFilters');
    const modePill = document.getElementById('modePill');
    
    if(customerNav) customerNav.style.display = (isCustomer || isStart) ? 'flex' : 'none';
    if(providerNav) providerNav.style.display = isProv ? 'flex' : 'none';
    if(discoverFilters) discoverFilters.style.display = isCustomer ? 'block' : 'none';
    if(modePill) modePill.style.display = isProv ? 'inline-flex' : 'none';
    
    // Mittagsbox Badge aktualisieren (nur für Endkunden)
    updateHeaderBasket();

    if(isStart){
      // Start-Seite: Wenn nicht eingeloggt, zur Discover-Seite (kein Zwang)
      if(!customer.loggedIn){
        setMode('customer');
        showDiscover();
        return;
      }
      showStart();
      return;
    }

    if(isProv){
      // provider must be logged in OR show onboarding entry
      if(!provider.loggedIn){
        // Check if user has onboarding draft -> show returning banner
        const onboardingDraft = load(LS.onboardingDraft, null);
        if(onboardingDraft && !provider.onboardingCompleted){
          // Show onboarding entry with returning banner
          showOnboardingEntry(true);
        } else {
          // Check if onboarding should be shown (new provider)
          if(!provider.onboardingCompleted){
            showOnboardingEntry(false);
          } else {
            showView(views.providerLogin);
          }
        }
      } else {
        showProviderHome();
      }
    } else {
      showDiscover();
    }
  }

  // Logo-Click Handler (Home-Button)
  function handleLogoClick(){
    // Je nach Mode zur entsprechenden Startseite navigieren
    if(mode === 'provider'){
      showProviderHome();
    } else if(mode === 'start'){
      showStart();
    } else {
      // Customer Mode: Zur Discover-Seite
      showDiscover();
    }
  }
  
  // --- Start ---
  function showStart(){
    // Navigation auf "Entdecken" setzen (auch wenn wir auf Startseite sind)
    const navBtn = document.querySelector('#customerNav button[data-go="discover"]');
    if(navBtn){
      document.querySelectorAll('#customerNav .navbtn').forEach(b=>b.classList.remove('active'));
      navBtn.classList.add('active');
    }
    showView(views.start);
    renderStart();
    // Browser-Verlauf aktualisieren
    history.pushState({view: 'start', mode: mode}, '', location.pathname);
  }

  // --- Customer views ---
  function showDiscover(){
    setCustomerNavActive('discover');
    showView(views.discover);
    renderChips();
    renderDiscover();
    // FAB anzeigen (Toggle im Topbar bleibt versteckt)
    const fabModeToggle = document.getElementById('fabModeToggle');
    if(fabModeToggle) fabModeToggle.style.display = 'flex';
    // Browser-Verlauf aktualisieren
    history.pushState({view: 'discover', mode: mode}, '', location.pathname);
  }
  function showFav(){
    setCustomerNavActive('fav');
    showView(views.fav);
    // Toggle im Topbar ausblenden
    const toggleTopbar = document.getElementById('discoverViewToggleTopbar');
    if(toggleTopbar) toggleTopbar.style.display = 'none';
    renderFavorites();
    // Browser-Verlauf aktualisieren
    history.pushState({view: 'fav', mode: mode}, '', location.pathname);
  }
  function showOrders(){
    setCustomerNavActive('orders');
    showView(views.orders);
    renderOrders();
    // Browser-Verlauf aktualisieren
    history.pushState({view: 'orders', mode: mode}, '', location.pathname);
  }
  function showCart(){
    setCustomerNavActive('cart');
    showView(views.cart);
    renderCart();
    // Browser-Verlauf aktualisieren
    history.pushState({view: 'cart', mode: mode}, '', location.pathname);
  }
  function showProfile(){
    setCustomerNavActive('profile');
    showView(views.profile);
    updateProfileView();
    lucide.createIcons();
    // Browser-Verlauf aktualisieren
    history.pushState({view: 'profile', mode: mode}, '', location.pathname);
  }
  
  // --- Pickup Code Screen ---
  let currentPickupOrderId = null;
  
  /**
   * Show pickup code screen (with guard)
   * Route: /abholcode/:orderId
   * @param {string} orderId
   */
  function showPickupCode(orderId){
    const order = getOrderById(orderId);
    
    // Guard: Order nicht gefunden
    if(!order){
      // Fehler-UI: "Bestellung nicht gefunden" + CTA "Zur Entdecken"
      const errorView = document.createElement('div');
      errorView.className = 'panel';
      errorView.style.padding = '40px 20px';
      errorView.style.textAlign = 'center';
      errorView.innerHTML = `
        <div style="font-size:48px; margin-bottom:20px;">⚠️</div>
        <h3 style="margin-bottom:12px;">Bestellung nicht gefunden</h3>
        <p class="hint" style="margin-bottom:24px;">Die Bestellung konnte nicht gefunden werden.</p>
        <button class="btn" type="button" onclick="showDiscover()" style="width:100%; min-height:44px;">
          <i data-lucide="compass"></i> Zur Entdecken-Seite
        </button>
      `;
      document.body.appendChild(errorView);
      showView(null); // Hide all views
      if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
      return;
    }
    
    // GUARD: Code nur anzeigen wenn PAID
    if(order.status !== 'PAID'){
      // Info UI: "Zahlung noch nicht bestätigt" + Button "Zurück"
      const infoView = document.createElement('div');
      infoView.className = 'panel';
      infoView.style.padding = '40px 20px';
      infoView.style.textAlign = 'center';
      
      const statusLabel = order.status === 'PAYMENT_PENDING' ? 'Zahlung ausstehend' :
                         order.status === 'CREATED' ? 'Bestellung erstellt' :
                         order.status === 'CANCELLED' ? 'Bestellung abgebrochen' :
                         'Unbekannter Status';
      
      infoView.innerHTML = `
        <div style="font-size:48px; margin-bottom:20px;">⏳</div>
        <h3 style="margin-bottom:12px;">Zahlung noch nicht bestätigt</h3>
        <p class="hint" style="margin-bottom:8px;">Status: ${statusLabel}</p>
        <p class="hint" style="margin-bottom:24px;">Das Ticket wird nach erfolgreicher Zahlung angezeigt.</p>
        <button class="btn" type="button" onclick="showOrders()" style="width:100%; min-height:44px;">
          <i data-lucide="arrow-left"></i> Zurück
        </button>
      `;
      document.body.appendChild(infoView);
      showView(null); // Hide all views
      if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
      return;
    }
    
    // PAID: Zeige Code
    currentPickupOrderId = orderId;
    setCustomerNavActive('profile'); // Navigation auf Meins setzen
    showView(views.pickupCode);
    renderPickupCode(order);
  }
  
  /**
   * Render pickup code screen
   * @param {Order} order
   */
  function renderPickupCode(order){
    // Code anzeigen (nur wenn PAID - Guard bereits in showPickupCode)
    const codeEl = document.getElementById('pickupCodeValue');
    if(codeEl){
      const code = order.pickupCode || order.code || '';
      // Code groß anzeigen (Format: 1A, 2B, etc.)
      codeEl.textContent = code || '–';
      codeEl.style.fontSize = '64px'; // Größer für bessere Lesbarkeit
      codeEl.style.letterSpacing = '2px';
    }
    
    // Bestellinfos
    const dishEl = document.getElementById('pickupCodeDish');
    if(dishEl) dishEl.textContent = order.dishName || order.summary || '–';
    
    const providerEl = document.getElementById('pickupCodeProvider');
    if(providerEl) providerEl.textContent = order.providerName || '–';
    
    const timeEl = document.getElementById('pickupCodeTime');
    if(timeEl){
      // Use pickupWindow (from order) or fallback to etaTime/pickupTime
      const timeWindow = order.pickupWindow || order.etaTime || order.pickupTime || 'offen';
      // Format: Show date if available
      let timeText = timeWindow;
      if(order.pickupDate){
        const date = new Date(order.pickupDate);
        const dateStr = `${date.getDate()}.${String(date.getMonth()+1).padStart(2,'0')}.`;
        timeText = `${dateStr} · ${timeWindow}`;
      }
      timeEl.textContent = timeText;
    }
    
    const typeEl = document.getElementById('pickupCodeType');
    if(typeEl){
      const fulfillType = order.fulfillType || (order.dineInPossible ? 'DINE_IN' : 'PICKUP');
      // Formatierung: PICKUP -> "Zum Mitnehmen", DINE_IN -> "Vor Ort"
      typeEl.textContent = fulfillType === 'DINE_IN' ? 'Vor Ort' : 'Zum Mitnehmen';
    }
    
    const totalEl = document.getElementById('pickupCodeTotal');
    if(totalEl){
      // Total in EUR formatieren (cents → € mit 2 Dezimalstellen)
      const totalCents = order.totalCents || (order.total ? Math.round(order.total * 100) : 0);
      const totalEur = totalCents / 100;
      totalEl.textContent = totalEur > 0 ? euro(totalEur) : '–';
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }

  // --- Provider views ---
  function showProviderHome(){
    setProviderNavActive('provider-home');
    showView(views.providerHome);
    renderProviderHome();
    
    // FAB anzeigen
    const fab = document.getElementById('fabProviderAddOffer');
    const fabLabel = document.getElementById('fabProviderAddOfferLabel');
    if(fab) fab.style.display = 'flex';
    if(fabLabel) fabLabel.style.display = 'block';
    
    // Browser-Verlauf aktualisieren
    history.pushState({view: 'provider-home', mode: mode}, '', location.pathname);
  }
  function showProviderPickups(){
    setProviderNavActive('provider-pickups');
    showView(views.providerPickups);
    renderProviderPickups();
    // FAB ausblenden
    const fab = document.getElementById('fabProviderAddOffer');
    const fabLabel = document.getElementById('fabProviderAddOfferLabel');
    if(fab) fab.style.display = 'none';
    if(fabLabel) fabLabel.style.display = 'none';
    
    // Browser-Verlauf aktualisieren
    history.pushState({view: 'provider-pickups', mode: mode}, '', location.pathname);
  }
  function showProviderWeek(){
    setProviderNavActive('provider-home');
    showView(views.providerWeek);
    renderWeekPlan();
    // FAB ausblenden
    const fab = document.getElementById('fabProviderAddOffer');
    const fabLabel = document.getElementById('fabProviderAddOfferLabel');
    if(fab) fab.style.display = 'none';
    if(fabLabel) fabLabel.style.display = 'none';
    
    // Browser-Verlauf aktualisieren
    history.pushState({view: 'provider-week', mode: mode}, '', location.pathname);
  }
  function showProviderCookbook(){
    setProviderNavActive('provider-cookbook');
    showView(views.providerCookbook);
    renderCookbook();
    // FAB ausblenden
    const fab = document.getElementById('fabProviderAddOffer');
    const fabLabel = document.getElementById('fabProviderAddOfferLabel');
    if(fab) fab.style.display = 'none';
    if(fabLabel) fabLabel.style.display = 'none';
    
    // Browser-Verlauf aktualisieren
    history.pushState({view: 'provider-cookbook', mode: mode}, '', location.pathname);
  }
  function showProviderProfile(){
    setProviderNavActive('provider-profile');
    showView(views.providerProfile);
    renderProviderProfile();
    // FAB ausblenden
    const fab = document.getElementById('fabProviderAddOffer');
    const fabLabel = document.getElementById('fabProviderAddOfferLabel');
    if(fab) fab.style.display = 'none';
    if(fabLabel) fabLabel.style.display = 'none';
    
    // Browser-Verlauf aktualisieren
    history.pushState({view: 'provider-profile', mode: mode}, '', location.pathname);
  }
  function showProviderBilling(){
    setProviderNavActive('provider-profile');
    showView(views.providerBilling);
    renderBilling();
    
    // Browser-Verlauf aktualisieren
    history.pushState({view: 'provider-billing', mode: mode}, '', location.pathname);
  }

  // --- Chips render ---
  function renderChips(){
    const catEl = document.getElementById('catChips');
    const dayEl = document.getElementById('dayChips');
    if(!catEl || !dayEl){
      return;
    }
    catEl.innerHTML='';
    // Discover Filter Chips: "In der Nähe" (default) + Kategorien
    const discoverCats = [
      {id: 'near', label: 'In der Nähe', icon: null},
      {id: 'Vegan', label: 'Vegan', icon: 'leaf'},
      {id: 'Vegetarisch', label: 'Vegetarisch', icon: 'carrot'},
      {id: 'Fisch', label: 'Fisch', icon: 'fish'},
      {id: 'Mit Fleisch', label: 'Mit Fleisch', icon: 'drumstick'}
    ];
    
    discoverCats.forEach(cat=>{
      const b=document.createElement('button');
      b.className='discover-category-chip' + (activeDiscoverFilter === cat.id ? ' active' : '');
      b.innerHTML = cat.icon ? `${iconMarkup(cat.icon)}<span>${esc(cat.label)}</span>` : `<span>${esc(cat.label)}</span>`;
      b.onclick=()=>{
        activeDiscoverFilter = cat.id;
        renderChips();
        renderDiscover();
      };
      catEl.appendChild(b);
    });

    dayEl.innerHTML='';
    // Date Swipebar: Heute + nächste 6 Tage
    const today = new Date();
    for(let i=0;i<7;i++){
      const d=new Date(today); d.setDate(d.getDate()+i);
      const key=isoDate(d);
      const b=document.createElement('button');
      b.className='discover-calendar-day'+(activeDay===key?' active':'');
      // Format: "Heute" für heute, sonst "Montag, 24.01."
      if(i===0){
        b.textContent = 'Heute';
      } else {
        b.textContent = fmtDay(d);
      }
      b.onclick=()=>{ activeDay=key; renderChips(); renderDiscover(); };
      dayEl.appendChild(b);
    }
  }

  function renderStartChips(){
    const catEl = document.getElementById('startCatChips');
    const dayEl = document.getElementById('startDayChips');
    if(!catEl || !dayEl){
      return;
    }
    catEl.innerHTML='';
    CATEGORIES.forEach(c=>{
      const b=document.createElement('button');
      b.className='chip'+(activeCat===c?' active':'');
      // Icon Mapping: Vegan=leaf, Vegetarisch=carrot, Mit Fleisch=drumstick
      const iconName = c==='Vegan' ? 'leaf' : (c==='Vegetarisch' ? 'carrot' : 'drumstick');
      b.innerHTML = `${iconMarkup(iconName)}<span>${esc(c)}</span>`;
      b.onclick=()=>{
        activeCat = activeCat===c ? null : c;
        renderStart();
        renderDiscover();
      };
      catEl.appendChild(b);
    });

    dayEl.innerHTML='';
    for(let i=0;i<5;i++){
      const d=new Date(); d.setDate(d.getDate()+i);
      const key=isoDate(d);
      const b=document.createElement('button');
      b.className='day'+(activeDay===key?' active':'');
      b.textContent = fmtDay(d);
      b.onclick=()=>{ activeDay=key; renderStart(); renderDiscover(); };
      dayEl.appendChild(b);
    }
  }

  function renderStart(){
    renderStartChips();
    renderStartDiscover();
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }

  function renderStartDiscover(){
    const grid = document.getElementById('startOfferGrid');
    const empty = document.getElementById('startEmptyOffers');
    const loc = document.getElementById('startLocationInput');
    
    if(!grid || !empty) return;

    // Standort-Suche
    if(loc){
      if(loc.value !== locationQuery) loc.value = locationQuery || '';
      loc.oninput=()=>{ locationQuery = loc.value; renderStart(); renderDiscover(); };
    }

    let list = offers.filter(o => o.day === activeDay && o.active !== false);

    if(activeCat){
      const cat = CAT_MAP[activeCat] || activeCat;
      list = list.filter(o => (o.category||'') === cat);
    }

    const q = String(locationQuery||'').trim().toLowerCase();
    if(q){
      list = list.filter(o=>{
        const data = normalizeOffer(o);
        const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity});
        return String(addr||'').toLowerCase().includes(q);
      });
    }

    // Normale Kacheln rendern
    grid.innerHTML='';
    empty.textContent = q ? 'Keine Angebote für diesen Standort.' : 'Noch keine Angebote. Demo: Als Anbieter ein Inserat erstellen.';
    empty.style.display = list.length ? 'none' : 'block';

    list.slice(0,6).forEach(o=> grid.appendChild(offerCard(o, {context:'start'})));
  }

  function createChatBubble(offer){
    const data = normalizeOffer(offer);
    const bubble = document.createElement('div');
    bubble.className='chat-bubble';
    bubble.onclick=()=>openOffer(data.id);
    
    const timeAgo = 'vor 2h'; // Placeholder
    const distance = data.distanceKm ? `${Number(data.distanceKm).toFixed(1)} km` : '';
    // Food type icon (keine Emojis)
    const foodTypeIcon = data.category === 'Vegan' ? 'leaf' : 
                         data.category === 'Vegetarisch' ? 'carrot' : 
                         data.category === 'Mit Fleisch' ? 'drumstick' : 
                         data.category === 'Fisch' ? 'fish' : '';
    
    bubble.innerHTML=`
      <div class="chat-bubble-header">
        <div class="chat-bubble-avatar">
          <img src="${esc(data.imageUrl || 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60')}" alt="${esc(data.providerName || '')}" />
        </div>
        <div class="chat-bubble-meta">
          <div class="chat-bubble-name">${esc(data.providerName || 'Anbieter')}</div>
          <div class="chat-bubble-time">
            ${iconMarkup('clock')}
            <span>${timeAgo}</span>
          </div>
        </div>
        ${distance ? `<div class="chat-bubble-distance">${distance}</div>` : ''}
      </div>
      ${data.imageUrl ? `<img src="${esc(data.imageUrl)}" alt="${esc(data.dish || '')}" class="chat-bubble-image" />` : ''}
      <div class="chat-bubble-message">
        Hey! Heute gibt's ${foodTypeIcon ? iconMarkup(foodTypeIcon) : ''} <strong>${esc(data.dish || 'Gericht')}</strong> für <strong>${euro(data.price || 0)}</strong> – wer ist dabei?
      </div>
      <div class="chat-bubble-actions">
        <button class="chat-bubble-btn chat-bubble-btn-primary" onclick="event.stopPropagation(); const o=offers.find(x=>x.id==='${data.id}'); if(o) openOffer('${data.id}');">Dabei sein</button>
      </div>
    `;
    
    return bubble;
  }

  // --- Discover render (App-like UX, PWA, Light Mode) ---
  let activeDiscoverFilter = 'near'; // 'near', 'Vegan', 'Vegetarisch', 'Mit Fleisch'
  
  function renderDiscover(){
    // Header: Standort-Input
    const locationInput = document.getElementById('discoverLocationInput');
    if(locationInput){
      locationInput.value = locationQuery || '';
      locationInput.oninput = ()=>{
        locationQuery = locationInput.value;
        renderDiscover();
      };
      locationInput.onkeydown = (e)=>{
        if(e.key === 'Enter'){
          e.preventDefault();
          renderDiscover();
        }
      };
    }
    
    // Location Search Button
    const btnLocationSearch = document.getElementById('btnDiscoverLocationSearch');
    if(btnLocationSearch){
      btnLocationSearch.onclick = ()=>{
        if(locationInput) locationInput.focus();
      };
    }
    
    // Quick-Filter Buttons
    const quickFilterNear = document.getElementById('quickFilterNear');
    const quickFilterToday = document.getElementById('quickFilterToday');
    if(quickFilterNear){
      quickFilterNear.classList.toggle('active', activeDiscoverFilter === 'near');
      quickFilterNear.onclick = () => {
        activeDiscoverFilter = 'near';
        renderDiscover();
      };
    }
    if(quickFilterToday){
      const todayKey = isoDate(new Date());
      quickFilterToday.classList.toggle('active', activeDay === todayKey);
      quickFilterToday.onclick = () => {
        activeDay = todayKey;
        renderDiscover();
      };
    }
    
    // Kategorien rendern (mit farbigen Icons)
    const categoriesEl = document.getElementById('discoverCategories');
    if(categoriesEl){
      categoriesEl.innerHTML = '';
      const cats = [
        {id:'Vegan', label:'Vegan', icon: 'leaf', emoji: '🌿'},
        {id:'Vegetarisch', label:'Vegetarisch', icon: 'carrot', emoji: '🧀'},
        {id:'Fisch', label:'Fisch', icon: 'fish', emoji: '🐟'},
        {id:'Mit Fleisch', label:'Fleisch', icon: 'drumstick', emoji: '🍖'},
        {id:'Salat', label:'Salat', icon: 'leaf', emoji: '🥗'}
      ];
      cats.forEach(cat=>{
        const btn = document.createElement('button');
        btn.className = 'discover-category-chip' + (activeDiscoverFilter === cat.id ? ' active' : '');
        btn.setAttribute('data-cat', cat.id);
        // Emoji + Icon für bessere Sichtbarkeit
        btn.innerHTML = `<span style="font-size:18px;">${cat.emoji}</span><i data-lucide="${cat.icon}"></i><span>${esc(cat.label)}</span>`;
        btn.onclick = ()=>{
          activeDiscoverFilter = cat.id;
          renderDiscover();
        };
        categoriesEl.appendChild(btn);
      });
    }
    
    // Kalender rendern (ohne Überschrift, distinct style)
    const calendarEl = document.getElementById('discoverCalendar');
    if(calendarEl){
      calendarEl.innerHTML = '';
      const today = new Date();
      for(let i=0; i<7; i++){
        const d = new Date(today);
        d.setDate(d.getDate() + i);
        const key = isoDate(d);
        
        const btn = document.createElement('button');
        btn.className = 'discover-day' + (activeDay === key ? ' active' : '');
        // Format: "Heute" für heute, sonst "Montag, 24.01."
        if(i === 0){
          btn.textContent = 'Heute';
        } else {
          btn.textContent = fmtDay(d);
        }
        btn.onclick = ()=>{
          activeDay = key;
          renderDiscover();
        };
        calendarEl.appendChild(btn);
      }
    }
    
    // Angebote filtern
    let list = offers.filter(o => o.day === activeDay && o.active !== false);
    
    // Ernährungs-Präferenzen Filter (aus Profil)
    if(customer && customer.dietaryPreferences){
      const prefs = customer.dietaryPreferences;
      list = list.filter(o => {
        const normalized = normalizeOffer(o);
        const category = normalized.category || '';
        const allergens = normalized.allergens || [];
        
        // Vegan: Nur "Vegan" Kategorie
        if(prefs.vegan && category !== 'Vegan') return false;
        
        // Vegetarisch: "Vegan" oder "Vegetarisch" (aber nicht "Mit Fleisch" oder "Fisch")
        if(prefs.vegetarian && (category === 'Mit Fleisch' || category === 'Fisch')) return false;
        
        // Glutenfrei: Keine glutenhaltigen Allergene
        if(prefs.glutenFree && allergens.some(a => 
          a.toLowerCase().includes('gluten') || 
          a.toLowerCase().includes('weizen') ||
          a.toLowerCase().includes('dinkel')
        )) return false;
        
        // Laktosefrei: Keine laktosehaltigen Allergene
        if(prefs.lactoseFree && allergens.some(a => 
          a.toLowerCase().includes('laktose') || 
          a.toLowerCase().includes('milch') ||
          a.toLowerCase().includes('käse')
        )) return false;
        
        return true;
      });
    }
    
    // Kategorie-Filter (entferne doppelte "In der Nähe" Filterung)
    if(activeDiscoverFilter !== 'near'){
      const cat = CAT_MAP[activeDiscoverFilter] || activeDiscoverFilter;
      list = list.filter(o => (o.category||'') === cat);
    }
    // "In der Nähe" zeigt alle Angebote (keine zusätzliche Filterung)
    
    // Standort-Filter
    const q = String(locationQuery||'').trim().toLowerCase();
    if(q){
      list = list.filter(o=>{
        const data = normalizeOffer(o);
        const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity});
        return String(addr||'').toLowerCase().includes(q);
      });
    }
    
    // List Cards rendern (horizontale List-Cards statt Hero Cards)
    const offersEl = document.getElementById('discoverOffers');
    const emptyEl = document.getElementById('discoverEmpty');
    if(offersEl && emptyEl){
      offersEl.innerHTML = '';
      emptyEl.style.display = list.length ? 'none' : 'block';
      
      list.forEach(o=> {
        const card = createDiscoverListCard(o);
        // Match-Screen Trigger: Bei Rechts-Swipe (für später, wenn Swipe-System implementiert wird)
        // Hier können wir einen Test-Button hinzufügen für Demo-Zwecke
        offersEl.appendChild(card);
      });
    }
    
    // Demo: Match-Screen Test (kann später durch Swipe-System ersetzt werden)
    // Wenn ein Gericht angeklickt wird und es hasPickupCode hat, könnte man showMatchModal aufrufen
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }
  
  // Swipe-View State (mit LocalStorage-Persistenz)
  let discoverViewMode = load(LS.discoverView, 'list'); // 'list' oder 'swipe'
  
  // Initialisiere FAB State
  setTimeout(() => {
    if(typeof syncToggleState === 'function') syncToggleState();
  }, 100);
  let swipeCards = [];
  let currentSwipeIndex = 0;
  
  // View-Toggle Handler
  function switchDiscoverView(mode){
    discoverViewMode = mode;
    save(LS.discoverView, mode); // Präferenz speichern
    
    const listEl = document.getElementById('discoverOffers');
    const swipeEl = document.getElementById('discoverSwipe');
    const toggleBtn = document.getElementById('toggleDiscoverView');
    
    if(mode === 'swipe'){
      if(listEl) listEl.style.display = 'none';
      if(swipeEl) swipeEl.style.display = 'block';
      if(toggleBtn) toggleBtn.classList.add('active');
      renderSwipeCards();
    } else {
      if(listEl) listEl.style.display = 'block';
      if(swipeEl) swipeEl.style.display = 'none';
      if(toggleBtn) toggleBtn.classList.remove('active');
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(() => lucide.createIcons(), 50);
    }
  }
  
  // SwipeCards rendern
  function renderSwipeCards(){
    const swipeStack = document.getElementById('swipeStack');
    const swipeEmpty = document.getElementById('swipeEmpty');
    if(!swipeStack) return;
    
    // Filtere Angebote (gleiche Logik wie renderDiscover)
    let list = offers.filter(o => o.day === activeDay && o.active !== false);
    
    // Ernährungs-Präferenzen Filter (aus Profil)
    if(customer && customer.dietaryPreferences){
      const prefs = customer.dietaryPreferences;
      list = list.filter(o => {
        const normalized = normalizeOffer(o);
        const category = normalized.category || '';
        const allergens = normalized.allergens || [];
        
        // Vegan: Nur "Vegan" Kategorie
        if(prefs.vegan && category !== 'Vegan') return false;
        
        // Vegetarisch: "Vegan" oder "Vegetarisch" (aber nicht "Mit Fleisch" oder "Fisch")
        if(prefs.vegetarian && (category === 'Mit Fleisch' || category === 'Fisch')) return false;
        
        // Glutenfrei: Keine glutenhaltigen Allergene
        if(prefs.glutenFree && allergens.some(a => 
          a.toLowerCase().includes('gluten') || 
          a.toLowerCase().includes('weizen') ||
          a.toLowerCase().includes('dinkel')
        )) return false;
        
        // Laktosefrei: Keine laktosehaltigen Allergene
        if(prefs.lactoseFree && allergens.some(a => 
          a.toLowerCase().includes('laktose') || 
          a.toLowerCase().includes('milch') ||
          a.toLowerCase().includes('käse')
        )) return false;
        
        return true;
      });
    }
    
    // Kategorie-Filter
    if(activeDiscoverFilter !== 'near'){
      const cat = CAT_MAP[activeDiscoverFilter] || activeDiscoverFilter;
      list = list.filter(o => (o.category||'') === cat);
    }
    
    const q = String(locationQuery||'').trim().toLowerCase();
    if(q){
      list = list.filter(o=>{
        const data = normalizeOffer(o);
        const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity});
        return String(addr||'').toLowerCase().includes(q);
      });
    }
    
    swipeCards = list;
    currentSwipeIndex = 0;
    
    swipeStack.innerHTML = '';
    
    if(swipeCards.length === 0){
      if(swipeEmpty) swipeEmpty.style.display = 'block';
      return;
    }
    
    if(swipeEmpty) swipeEmpty.style.display = 'none';
    
    // Erstelle nur die ersten 3 Karten (Performance)
    const cardsToShow = Math.min(3, swipeCards.length);
    for(let i = 0; i < cardsToShow; i++){
      const card = createSwipeCard(swipeCards[i], i);
      swipeStack.appendChild(card);
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }
  
  // SwipeCard erstellen
  function createSwipeCard(offer, index){
    const data = normalizeOffer(offer);
    const card = document.createElement('div');
    card.className = 'swipe-card';
    card.dataset.offerId = data.id;
    card.style.zIndex = 100 - index;
    card.style.transform = `scale(${1 - index * 0.05}) translateY(${index * 10}px)`;
    card.style.opacity = index === 0 ? 1 : 0.95;
    
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    
    // Badges
    const badges = [];
    if(data.hasPickupCode) badges.push(`<span class="swipe-card-badge code">Abholnummer</span>`);
    if(data.dineInPossible) badges.push(`<span class="swipe-card-badge dine">Vor Ort</span>`);
    if(!data.dineInPossible && !data.hasPickupCode) badges.push(`<span class="swipe-card-badge">Zum Mitnehmen</span>`);
    
    // Meta-Info
    const metaInfo = [];
    if(data.pickupWindow) metaInfo.push(`<span style="display:flex;align-items:center;gap:4px;font-size:14px;color:#666;">${iconMarkup('clock')} ${esc(data.pickupWindow)}</span>`);
    if(data.distanceKm != null) metaInfo.push(`<span style="display:flex;align-items:center;gap:4px;font-size:14px;color:#666;">${iconMarkup('map-pin')} ${Number(data.distanceKm).toFixed(1)} km</span>`);
    
    card.innerHTML = `
      <div class="swipe-overlay left">Bäh: Kein Lust auf ${esc(data.dish||'')} heute</div>
      <div class="swipe-overlay right">Gut: Das möchte ich!</div>
      <div class="swipe-card-image">
        <img src="${esc(imgSrc)}" alt="${esc(data.dish||'')}" />
      </div>
      <div class="swipe-card-content">
        <div>
          <h2 class="swipe-card-title">${esc(data.dish||'Gericht')}</h2>
          <p class="swipe-card-provider">${iconMarkup('store')} <span>${esc(data.providerName||'Anbieter')}</span></p>
          ${badges.length ? `<div class="swipe-card-badges">${badges.join('')}</div>` : ''}
          <div class="swipe-card-meta">
            <span class="swipe-card-price">${euro(data.price)}</span>
            ${metaInfo.join('')}
          </div>
        </div>
      </div>
    `;
    
    // Touch-Gesten
    let startX = 0, startY = 0, currentX = 0, currentY = 0;
    let isDragging = false;
    const SWIPE_THRESHOLD = 100;
    const ROTATION_FACTOR = 0.15; // Rotation pro Pixel (erhöht für mehr Rotation)
    const MAX_ROTATION = 25; // Max 25 Grad Rotation
    
    card.addEventListener('touchstart', (e) => {
      if(index !== 0) return; // Nur oberste Karte
      const touch = e.touches[0];
      startX = touch.clientX;
      startY = touch.clientY;
      isDragging = true;
      card.classList.add('swiping');
    }, {passive: true});
    
    card.addEventListener('touchmove', (e) => {
      if(!isDragging || index !== 0) return;
      const touch = e.touches[0];
      currentX = touch.clientX - startX;
      currentY = touch.clientY - startY;
      
      // Physikalisch korrekte Rotation: begrenzt auf max 25 Grad
      const rotation = Math.max(-MAX_ROTATION, Math.min(MAX_ROTATION, currentX * ROTATION_FACTOR));
      card.style.transform = `translateX(${currentX}px) translateY(${currentY}px) rotate(${rotation}deg)`;
      
      // Match-Feedback während Swipe
      if(Math.abs(currentX) > 50){
        if(currentX < 0){
          card.classList.add('match-left');
          card.classList.remove('match-right');
        } else {
          card.classList.add('match-right');
          card.classList.remove('match-left');
        }
      } else {
        card.classList.remove('match-left', 'match-right');
      }
      
      // Overlay anzeigen
      const overlayLeft = card.querySelector('.swipe-overlay.left');
      const overlayRight = card.querySelector('.swipe-overlay.right');
      if(currentX < -50 && overlayLeft){
        overlayLeft.classList.add('show');
        if(overlayRight) overlayRight.classList.remove('show');
      } else if(currentX > 50 && overlayRight){
        overlayRight.classList.add('show');
        if(overlayLeft) overlayLeft.classList.remove('show');
      } else {
        if(overlayLeft) overlayLeft.classList.remove('show');
        if(overlayRight) overlayRight.classList.remove('show');
      }
    }, {passive: true});
    
    card.addEventListener('touchend', (e) => {
      if(!isDragging || index !== 0) return;
      isDragging = false;
      card.classList.remove('swiping');
      
      const overlayLeft = card.querySelector('.swipe-overlay.left');
      const overlayRight = card.querySelector('.swipe-overlay.right');
      if(overlayLeft) overlayLeft.classList.remove('show');
      if(overlayRight) overlayRight.classList.remove('show');
      
      if(Math.abs(currentX) > SWIPE_THRESHOLD){
        // Swipe durchgeführt - finale Rotation für den Swipe beibehalten
        const finalRotation = Math.max(-30, Math.min(30, currentX * ROTATION_FACTOR));
        if(currentX < 0){
          // Links swipen = "Bäh" - Rot aufleuchten
          card.classList.add('match-left');
          setTimeout(() => {
            triggerHapticFeedback();
            // Finale Rotation beim Wegfliegen
            card.style.transform = `translateX(-100vw) rotate(${finalRotation - 10}deg)`;
            card.style.opacity = '0';
            card.classList.add('swipe-left');
            setTimeout(() => {
              handleSwipeLeft(offer);
              card.remove();
              currentSwipeIndex++;
              showNextSwipeCard();
            }, 200);
          }, 100);
        } else {
          // Rechts swipen = "Gut" - Grün aufleuchten
          card.classList.add('match-right');
          setTimeout(() => {
            triggerHapticFeedback();
            // Finale Rotation beim Wegfliegen
            card.style.transform = `translateX(100vw) rotate(${finalRotation + 10}deg)`;
            card.style.opacity = '0';
            card.classList.add('swipe-right');
            setTimeout(() => {
              handleSwipeRight(offer);
              card.remove();
              currentSwipeIndex++;
              showNextSwipeCard();
            }, 200);
          }, 100);
        }
      } else {
        // Zurück zur Mitte mit smooth Animation
        card.classList.remove('match-left', 'match-right');
        card.style.transition = 'transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
        card.style.transform = '';
        setTimeout(() => {
          card.style.transition = '';
        }, 300);
      }
      
      currentX = 0;
      currentY = 0;
    }, {passive: true});
    
    // Mouse-Events für Desktop (optional)
    card.addEventListener('mousedown', (e) => {
      if(index !== 0) return;
      startX = e.clientX;
      startY = e.clientY;
      isDragging = true;
      card.classList.add('swiping');
      e.preventDefault();
    });
    
    card.addEventListener('mousemove', (e) => {
      if(!isDragging || index !== 0) return;
      currentX = e.clientX - startX;
      currentY = e.clientY - startY;
      // Physikalisch korrekte Rotation: begrenzt auf max 25 Grad
      const rotation = Math.max(-MAX_ROTATION, Math.min(MAX_ROTATION, currentX * ROTATION_FACTOR));
      card.style.transform = `translateX(${currentX}px) translateY(${currentY}px) rotate(${rotation}deg)`;
      
      const overlayLeft = card.querySelector('.swipe-overlay.left');
      const overlayRight = card.querySelector('.swipe-overlay.right');
      if(currentX < -50 && overlayLeft){
        overlayLeft.classList.add('show');
        if(overlayRight) overlayRight.classList.remove('show');
      } else if(currentX > 50 && overlayRight){
        overlayRight.classList.add('show');
        if(overlayLeft) overlayLeft.classList.remove('show');
      } else {
        if(overlayLeft) overlayLeft.classList.remove('show');
        if(overlayRight) overlayRight.classList.remove('show');
      }
    });
    
    card.addEventListener('mouseup', () => {
      if(!isDragging || index !== 0) return;
      isDragging = false;
      card.classList.remove('swiping');
      
      const overlayLeft = card.querySelector('.swipe-overlay.left');
      const overlayRight = card.querySelector('.swipe-overlay.right');
      if(overlayLeft) overlayLeft.classList.remove('show');
      if(overlayRight) overlayRight.classList.remove('show');
      
      if(Math.abs(currentX) > SWIPE_THRESHOLD){
        if(currentX < 0){
          // Links swipen = "Bäh" - Rot aufleuchten
          card.classList.add('match-left');
          setTimeout(() => {
            triggerHapticFeedback();
            card.classList.add('swipe-left');
            setTimeout(() => {
              handleSwipeLeft(offer);
              card.remove();
              currentSwipeIndex++;
              showNextSwipeCard();
            }, 200);
          }, 100);
        } else {
          // Rechts swipen = "Gut" - Grün aufleuchten
          card.classList.add('match-right');
          setTimeout(() => {
            triggerHapticFeedback();
            card.classList.add('swipe-right');
            setTimeout(() => {
              handleSwipeRight(offer);
              card.remove();
              currentSwipeIndex++;
              showNextSwipeCard();
            }, 200);
          }, 100);
        }
      } else {
        card.classList.remove('match-left', 'match-right');
        card.style.transform = '';
      }
      
      currentX = 0;
      currentY = 0;
    });
    
    card.addEventListener('mouseleave', () => {
      if(isDragging){
        isDragging = false;
        card.classList.remove('swiping');
        card.style.transform = '';
        currentX = 0;
        currentY = 0;
      }
    });
    
    return card;
  }
  
  // Haptic Feedback
  function triggerHapticFeedback(){
    if('vibrate' in navigator){
      navigator.vibrate(50); // 50ms Vibration
    }
  }
  
  // Swipe-Handler
  function handleSwipeLeft(offer){
    // Links = "Bäh: Kein Lust auf [Gericht] heute"
    // Einfach überspringen, keine Aktion
    console.log('Swipe left:', offer);
  }
  
  function handleSwipeRight(offer){
    // Rechts = "Gut: Das möchte ich!" - Zu Favoriten hinzufügen
    const data = normalizeOffer(offer);
    const dishKey = data.id;
    
    // Zu Favoriten hinzufügen (wenn noch nicht vorhanden)
    if(!dishFavs.has(dishKey)){
      dishFavs.add(dishKey);
      save(LS.dishFavs, Array.from(dishFavs));
      
      // Fly-to-Favorites Animation
      triggerFlyToFavoritesAnimation(offer);
      
      // Haptic Feedback
      if(navigator.vibrate) navigator.vibrate([30, 20, 30]);
      
      // Toast-Bestätigung
      showToast('Gericht zu Favoriten hinzugefügt ❤️', 2000);
      
      // Favoriten-Seite aktualisieren (falls sichtbar)
      renderFavorites();
    } else {
      // Bereits in Favoriten - kurze Bestätigung
      showToast('Bereits in Favoriten ❤️', 1500);
    }
  }
  
  // Fly-to-Favorites Animation: Gericht fliegt zum Herz-Icon
  function triggerFlyToFavoritesAnimation(offer){
    const data = normalizeOffer(offer);
    const card = document.querySelector('.swipe-card[data-offer-id="' + data.id + '"]');
    if(!card) return;
    
    const img = card.querySelector('.swipe-card-image img');
    if(!img) return;
    
    // Finde das Favoriten-Icon in der Bottom Nav
    const favNavBtn = document.querySelector('#customerNav button[data-go="fav"]');
    if(!favNavBtn) return;
    
    // Temporäre Kopie des Bildes erstellen
    const flyImg = img.cloneNode(true);
    flyImg.style.cssText = `
      position:fixed;
      width:100px;
      height:100px;
      object-fit:cover;
      border-radius:16px;
      z-index:9999;
      pointer-events:none;
      box-shadow:0 8px 24px rgba(0,0,0,0.3);
      transition:all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    `;
    
    const cardRect = card.getBoundingClientRect();
    const favRect = favNavBtn.getBoundingClientRect();
    
    flyImg.style.left = cardRect.left + (cardRect.width / 2) - 50 + 'px';
    flyImg.style.top = cardRect.top + (cardRect.height * 0.3) + 'px';
    
    document.body.appendChild(flyImg);
    
    // Animation zum Herz-Icon
    setTimeout(() => {
      flyImg.style.left = favRect.left + (favRect.width / 2) - 50 + 'px';
      flyImg.style.top = favRect.top + (favRect.height / 2) - 50 + 'px';
      flyImg.style.transform = 'scale(0.2) rotate(360deg)';
      flyImg.style.opacity = '0';
    }, 50);
    
    // Heart-Reaction: Bounce + Glow
    setTimeout(() => {
      favNavBtn.classList.add('bounce', 'glow');
      
      // Cleanup
      setTimeout(() => {
        favNavBtn.classList.remove('bounce', 'glow');
      }, 500);
    }, 300);
    
    // Cleanup
    setTimeout(() => {
      if(flyImg.parentNode) flyImg.parentNode.removeChild(flyImg);
    }, 700);
  }
  
  // Anbieter-Quick-View (Modal mit Adresse & Maps-Link)
  function openProviderQuickView(providerId){
    const providerOffers = offers.filter(o => o.providerId === providerId && o.active !== false);
    if(providerOffers.length === 0) return;
    
    const provider = normalizeOffer(providerOffers[0]);
    const address = buildAddress({
      street: provider.providerStreet,
      zip: provider.providerZip,
      city: provider.providerCity,
      address: provider.address
    });
    
    // Modal erstellen
    const modal = document.createElement('div');
    modal.className = 'backdrop active';
    modal.style.zIndex = '100';
    modal.onclick = () => {
      modal.remove();
    };
    
    const content = document.createElement('div');
    content.style.cssText = `
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      background:#fff;
      border-radius:24px;
      padding:24px;
      max-width:90vw;
      width:400px;
      box-shadow:0 8px 32px rgba(0,0,0,0.2);
      z-index:101;
    `;
    content.onclick = (e) => e.stopPropagation();
    
    content.innerHTML = `
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
        <div style="width:48px; height:48px; border-radius:12px; background:rgba(255,215,0,0.15); display:flex; align-items:center; justify-content:center;">
          <i data-lucide="store" style="width:24px;height:24px; color:#FFD700;"></i>
        </div>
        <div style="flex:1;">
          <div style="font-weight:900; font-size:18px; color:#2D3436; margin-bottom:4px;">${esc(provider.providerName || 'Anbieter')}</div>
          <div style="font-size:14px; color:#666; display:flex; align-items:center; gap:6px;">
            <i data-lucide="map-pin" style="width:14px;height:14px;"></i>
            <span>${esc(address)}</span>
          </div>
        </div>
        <button onclick="this.closest('.backdrop').remove();" style="background:none; border:none; padding:8px; cursor:pointer; border-radius:8px; transition:background 0.2s;" onmouseover="this.style.background='#f5f5f5';" onmouseout="this.style.background='none';">
          <i data-lucide="x" style="width:20px;height:20px; color:#666;"></i>
        </button>
      </div>
      <div style="display:flex; flex-direction:column; gap:12px;">
        <button class="btn-primary" type="button" onclick="openGoogleMapsRoute('${esc(providerId)}'); this.closest('.backdrop').remove();" style="width:100%; min-height:48px; font-weight:700;">
          <i data-lucide="navigation" style="width:20px;height:20px;"></i> <span>Anfahrt</span>
        </button>
        ${provider.distanceKm != null ? `<div style="text-align:center; font-size:13px; color:#666; padding:8px;">Entfernung: ${Number(provider.distanceKm).toFixed(1)} km</div>` : ''}
      </div>
    `;
    
    modal.appendChild(content);
    document.body.appendChild(modal);
    
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }
  
  // Google Maps Route öffnen (für einen oder mehrere Anbieter)
  function openGoogleMapsRoute(providerId){
    // Wenn kein providerId, dann Multi-Vendor aus Korb
    if(!providerId){
      if(!cart || !cart.items.length) return;
      const providerIds = new Set();
      cart.items.forEach(it => {
        const o = offers.find(x => x.id === it.offerId);
        if(o) providerIds.add(o.providerId);
      });
      
      if(providerIds.size === 0) return;
      if(providerIds.size === 1){
        openGoogleMapsRoute(Array.from(providerIds)[0]);
        return;
      }
      
      // Mehrere Anbieter: Optimale Route mit Waypoints
      const addresses = [];
      Array.from(providerIds).forEach(id => {
        const o = offers.find(x => x.providerId === id && x.active !== false);
        if(o){
          const p = normalizeOffer(o);
          const addr = buildAddress({
            street: p.providerStreet,
            zip: p.providerZip,
            city: p.providerCity
          });
          if(addr) addresses.push(encodeURIComponent(addr));
        }
      });
      
      if(addresses.length === 0) return;
      
      // Google Maps mit Waypoints (optimale Route)
      if(addresses.length > 1){
        const waypoints = addresses.slice(0, -1).join('|');
        const destination = addresses[addresses.length - 1];
        const url = `https://www.google.com/maps/dir/?api=1&origin=My+Location&waypoints=${waypoints}&destination=${destination}`;
        window.open(url, '_blank');
      } else {
        const url = `https://www.google.com/maps/search/?api=1&query=${addresses[0]}`;
        window.open(url, '_blank');
      }
      return;
    }
    
    // Einzelner Anbieter
    const o = offers.find(x => x.providerId === providerId && x.active !== false);
    if(!o) return;
    
    const p = normalizeOffer(o);
    const address = buildAddress({
      street: p.providerStreet,
      zip: p.providerZip,
      city: p.providerCity
    });
    
    if(!address) return;
    
    const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
    window.open(url, '_blank');
  }
  
  // Nächste Karte anzeigen
  function showNextSwipeCard(){
    const swipeStack = document.getElementById('swipeStack');
    if(!swipeStack) return;
    
    // Verschiebe alle Karten nach oben
    const cards = swipeStack.querySelectorAll('.swipe-card');
    cards.forEach((card, i) => {
      card.style.zIndex = 100 - i;
      card.style.transform = `scale(${1 - i * 0.05}) translateY(${i * 10}px)`;
      card.style.opacity = i === 0 ? 1 : 0.95;
    });
    
    // Wenn weniger als 3 Karten sichtbar, füge neue hinzu
    if(cards.length < 3 && currentSwipeIndex + cards.length < swipeCards.length){
      const nextIndex = currentSwipeIndex + cards.length;
      const nextCard = createSwipeCard(swipeCards[nextIndex], cards.length);
      swipeStack.appendChild(nextCard);
    }
    
    // Wenn keine Karten mehr, zeige Empty-State
    if(cards.length === 0 && currentSwipeIndex >= swipeCards.length){
      const swipeEmpty = document.getElementById('swipeEmpty');
      if(swipeEmpty) swipeEmpty.style.display = 'block';
    }
  }
  
  // FAB (Floating Action Button) für Modus-Wechsel
  const fabModeToggle = document.getElementById('fabModeToggle');
  const fabModeIcon = document.getElementById('fabModeIcon');
  const fabHint = document.getElementById('fabHint');
  
  // Toggle-Switch Handler (Legacy - im Header, wird versteckt)
  const toggleDiscoverView = document.getElementById('toggleDiscoverView');
  const toggleDiscoverViewTopbar = document.getElementById('toggleDiscoverViewTopbar');
  
  function syncToggleState(){
    const isSwipe = discoverViewMode === 'swipe';
    
    // Legacy Toggle (versteckt, aber für Kompatibilität)
    if(toggleDiscoverView){
      if(isSwipe) toggleDiscoverView.classList.add('active');
      else toggleDiscoverView.classList.remove('active');
    }
    if(toggleDiscoverViewTopbar){
      if(isSwipe) toggleDiscoverViewTopbar.classList.add('active');
      else toggleDiscoverViewTopbar.classList.remove('active');
    }
    
    // FAB aktualisieren
    if(fabModeToggle){
      if(isSwipe){
        fabModeToggle.classList.add('active');
        // Icon wechseln: Sparkles (Inspiration) → Liste
        if(fabModeIcon){
          fabModeIcon.setAttribute('data-lucide', 'list');
          if(typeof lucide !== 'undefined') lucide.createIcons();
        }
      } else {
        fabModeToggle.classList.remove('active');
        // Icon wechseln: Liste → Sparkles (Inspiration)
        if(fabModeIcon){
          fabModeIcon.setAttribute('data-lucide', 'sparkles');
          if(typeof lucide !== 'undefined') lucide.createIcons();
        }
      }
    }
  }
  
  // FAB Click-Handler mit Puls-Animation
  if(fabModeToggle){
    fabModeToggle.onclick = () => {
      // Puls-Animation
      fabModeToggle.classList.add('pulsing');
      setTimeout(() => fabModeToggle.classList.remove('pulsing'), 400);
      
      // Modus wechseln
      const newMode = discoverViewMode === 'list' ? 'swipe' : 'list';
      switchDiscoverView(newMode);
      save(LS.discoverView, newMode);
      syncToggleState();
      
      // Haptic Feedback (falls unterstützt)
      if(navigator.vibrate) navigator.vibrate(10);
    };
  }
  
  // Legacy Toggle Handler (für Kompatibilität)
  if(toggleDiscoverView){
    toggleDiscoverView.onclick = () => {
      const newMode = discoverViewMode === 'list' ? 'swipe' : 'list';
      switchDiscoverView(newMode);
      save(LS.discoverView, newMode);
      syncToggleState();
    };
  }
  if(toggleDiscoverViewTopbar){
    toggleDiscoverViewTopbar.onclick = () => {
      const newMode = discoverViewMode === 'list' ? 'swipe' : 'list';
      switchDiscoverView(newMode);
      save(LS.discoverView, newMode);
      syncToggleState();
    };
  }
  
  // Micro-Hint beim ersten Start (nur einmal anzeigen)
  const fabHintShown = load('fabHintShown', false);
  if(fabModeToggle && fabHint && !fabHintShown){
    // Zeige FAB nur in Discover-View
    function showFabInDiscover(){
      const currentView = document.querySelector('.view.active');
      if(currentView && currentView.id === 'v-discover'){
        fabModeToggle.style.display = 'flex';
        // Zeige Hint nach kurzer Verzögerung
        setTimeout(() => {
          if(fabHint) fabHint.classList.add('show');
        }, 500);
        // Verstecke Hint nach 2 Sekunden
        setTimeout(() => {
          if(fabHint) fabHint.classList.remove('show');
          save('fabHintShown', true);
        }, 2500);
      } else {
        fabModeToggle.style.display = 'none';
      }
    }
    
    // Beim ersten Laden
    showFabInDiscover();
    
    // Beim View-Wechsel
    const originalShowView = window.showView;
    if(originalShowView){
      window.showView = function(viewId){
        originalShowView(viewId);
        setTimeout(showFabInDiscover, 100);
      };
    }
  } else if(fabModeToggle){
    // Hint bereits gezeigt - zeige FAB nur in Discover
    function showFabInDiscover(){
      const currentView = document.querySelector('.view.active');
      if(currentView && currentView.id === 'v-discover'){
        fabModeToggle.style.display = 'flex';
      } else {
        fabModeToggle.style.display = 'none';
      }
    }
    showFabInDiscover();
    
    // Beim View-Wechsel
    const originalShowView = window.showView;
    if(originalShowView){
      window.showView = function(viewId){
        originalShowView(viewId);
        setTimeout(showFabInDiscover, 100);
      };
    }
  }
  
  // Initialer Zustand setzen
  setTimeout(() => {
    syncToggleState();
    if(fabModeToggle){
      const currentView = document.querySelector('.view.active');
      if(currentView && currentView.id === 'v-discover'){
        fabModeToggle.style.display = 'flex';
      }
    }
  }, 200);
  
  // Initiale Ansicht beim ersten Laden setzen
  if(discoverViewMode === 'swipe'){
    switchDiscoverView('swipe');
  } else {
    switchDiscoverView('list');
  }
  
  // List Card für Discover-Seite (Premium horizontales Design)
  function createDiscoverListCard(o){
    const data = normalizeOffer(o);
    const card = document.createElement('div');
    card.className = 'dish-card';
    
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    
    // Favorit-Status prüfen
    const dishKey = data.id;
    const isFav = dishFavs.has(dishKey);
    
    // Entfernung anzeigen (Gehzeit oder Distanz)
    let distanceDisplay = '';
    if(data.walkingTimeText){
      distanceDisplay = `<div class="distance-badge" style="color:var(--brand); background:rgba(242,183,5,0.1);">
        <i data-lucide="navigation" style="width:12px;height:12px;"></i> ${esc(data.walkingTimeText)}
      </div>`;
    } else if(data.distanceKm != null){
      distanceDisplay = `<div class="distance-badge">
        <i data-lucide="map-pin" style="width:12px;height:12px;"></i> ${Number(data.distanceKm).toFixed(1)} km
      </div>`;
    }
    
    // Social-Proof: "Heute schon Xx bestellt" (optional, zwischen Provider und Footer)
    const socialProof = data.todayOrderCount > 0 ? `<div style="margin-top:4px; padding:4px 8px; background:rgba(255,204,0,0.1); border-radius:6px; font-size:11px; font-weight:600; color:#b8860b; display:inline-flex; align-items:center; gap:4px; width:fit-content;"><i data-lucide="users" style="width:12px;height:12px;"></i> <span>${data.todayOrderCount}x heute</span></div>` : '';
    
    card.innerHTML = `
      <div class="dish-image-box" style="position:relative; overflow:hidden;">
        <img src="${esc(imgSrc)}" alt="${esc(data.dish||'')}" style="width:100%; height:100%; object-fit:cover;" />
        <!-- Overlay-Icons auf dem Bild (Herz + Share) -->
        <div style="position:absolute; top:12px; right:12px; display:flex; gap:8px; z-index:5;">
          <button class="btn-icon-overlay" onclick="event.stopPropagation(); toggleDishFav('${dishKey}'); const btn=this.querySelector('i'); setTimeout(()=>{const isFav=dishFavs.has('${dishKey}'); btn.style.fill=isFav?'currentColor':''; btn.style.color=isFav?'#e74c3c':'#666'; if(typeof lucide !== 'undefined') lucide.createIcons();}, 10);" title="Favorit" style="width:40px; height:40px; border-radius:50%; background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.15); transition:transform 0.2s ease;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
            <i data-lucide="heart" style="width:20px;height:20px;${isFav ? 'fill:currentColor; color:#e74c3c;' : 'color:#666;'}"></i>
          </button>
          <button class="btn-icon-overlay" onclick="event.stopPropagation(); const o=offers.find(x=>x.id==='${data.id}'); if(o) shareInviteLink(o);" title="Teilen" style="width:40px; height:40px; border-radius:50%; background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.15); transition:transform 0.2s ease;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
            <i data-lucide="share-2" style="width:20px;height:20px; color:#666;"></i>
          </button>
        </div>
      </div>
      <div class="dish-details">
        <div>
          <div class="dish-header">
            <h3 class="dish-name">${esc(data.dish||'Gericht')} <span class="dish-price" style="font-size:18px; color:var(--brand); font-weight:900; margin-left:8px;">${euro(data.price)}</span></h3>
          </div>
          <div class="dish-provider" style="display:flex; align-items:center; gap:6px; margin-top:4px;">
            <i data-lucide="store" style="width:14px;height:14px; color:#666;"></i>
            <span>${esc(data.providerName||'Anbieter')}</span>
            ${data.pickupWindow ? `<span style="margin-left:8px; display:flex; align-items:center; gap:4px; color:#666; font-size:12px;"><i data-lucide="clock" style="width:12px;height:12px;"></i> ${esc(data.pickupWindow)}</span>` : ''}
            ${data.dineInPossible ? `<i data-lucide="utensils" style="width:14px;height:14px; color:#1f9d55; margin-left:4px;" title="Vor Ort"></i>` : ''}
            ${!data.dineInPossible && data.hasPickupCode ? `<i data-lucide="shopping-bag" style="width:14px;height:14px; color:#666; margin-left:4px;" title="Zum Mitnehmen"></i>` : ''}
          </div>
          ${socialProof}
        </div>
        <div class="dish-footer">
          ${distanceDisplay}
        </div>
      </div>
    `;
    
    // Klick auf Karte öffnet immer Detailansicht (nicht direkt Bestellung)
    card.onclick = (e)=>{
      if(e.target.closest('.btn-icon')) return; // Button-Handler übernimmt
      openOffer(data.id); // Immer Detailansicht öffnen
    };
    
    return card;
  }

  function offerCard(o, opts={}){
    const data = normalizeOffer(o);
    const interactive = opts.interactive !== false;
    const card=document.createElement('div');
    card.className='card';
    if(opts.context === 'start' || opts.context === 'customer'){
      card.classList.add('playful');
    }
    if(interactive){
      card.onclick=()=>openOffer(data.id);
    } else {
      card.style.cursor='default';
    }

    // Image
    const img=document.createElement('div');
    img.className='img';
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    img.innerHTML = `<img alt="${esc(data.dish||'')}" src="${esc(imgSrc)}" />`;

    // Heart Icon (Favorit) - rechts oben (kein Text, nur Icon)
    const dishKey = data.id;
    const heart=document.createElement('button');
    heart.className='card-heart'+(dishFavs.has(dishKey)?' on':'');
    heart.type='button';
    heart.innerHTML = dishFavs.has(dishKey) ? iconMarkup('heart', {fill:true}) : iconMarkup('heart');
    heart.onclick=(e)=>{ e.stopPropagation(); toggleDishFav(dishKey); };
    if(interactive){ card.appendChild(heart); }

    // Body
    const body=document.createElement('div');
    body.className='body';
    
    // Titelzeile: Dish name (max 2 Zeilen)
    const titleRow = document.createElement('div');
    titleRow.className='card-title-row';
    const title = document.createElement('h3');
    title.className='card-title';
    title.textContent = data.dish || 'Gericht';
    titleRow.appendChild(title);
    body.appendChild(titleRow);
    
    // Anbieter: Kurzform mit Store-Icon
    const provider = document.createElement('p');
    provider.className='card-provider';
    provider.innerHTML = `${iconMarkup('store')} <span>${esc(data.providerName || 'Anbieter')}</span>`;
    body.appendChild(provider);
    
    // Pickup-Badges (obligatorisch, max 3, nach Anbieter, vor Preis)
    // Reihenfolge: Vor Ort → Zum Mitnehmen → Abholcode
    // Nur anwendbare Badges anzeigen
    const pickupBadges = [];
    
    // 1. Vor Ort (wenn dineInPossible)
    if(data.dineInPossible) {
      pickupBadges.push({class:'dine', text:'Vor Ort', icon:'utensils'});
    }
    
    // 2. Zum Mitnehmen (immer anzeigen, außer wenn nur Vor Ort möglich)
    // Wenn dineInPossible false ist, dann ist es definitiv "Zum Mitnehmen"
    // Wenn dineInPossible true ist, kann es beides sein
    if(!data.dineInPossible) {
      // Nur Zum Mitnehmen möglich
      pickupBadges.push({class:'pickup', text:'Zum Mitnehmen', icon:'shopping-bag'});
    } else if(pickupBadges.length < 3) {
      // Beides möglich, aber max 3 Badges
      pickupBadges.push({class:'pickup', text:'Zum Mitnehmen', icon:'shopping-bag'});
    }
    
    // 3. Abholnummer (wenn verfügbar und noch Platz)
    if(data.hasPickupCode && pickupBadges.length < 3) {
      pickupBadges.push({class:'code', text:'Abholnummer', icon:'ticket'});
    }
    
    // Max 3 Badges sicherstellen
    if(pickupBadges.length > 3) {
      pickupBadges.splice(3);
    }
    
    if(pickupBadges.length > 0){
      const badgesRow = document.createElement('div');
      badgesRow.className='card-status-badges';
      pickupBadges.forEach(badge => {
        const badgeEl = document.createElement('span');
        badgeEl.className = `card-status-badge ${badge.class}`;
        badgeEl.innerHTML = `${iconMarkup(badge.icon)} <span>${esc(badge.text)}</span>`;
        badgesRow.appendChild(badgeEl);
      });
      body.appendChild(badgesRow);
    }
    
    // Preis: Groß & prominent, Markenfarbe
    const price = document.createElement('div');
    price.className='card-price';
    price.textContent = euro(data.price);
    body.appendChild(price);
    
    // Info-Zeile als Icon-Badges (eine Zeile, max 4 Icons, nur Icons + Zahlen)
    const infoRow = document.createElement('div');
    infoRow.className='card-info-badges';
    
    // clock: timeRange
    if(data.pickupWindow){
      const timeBadge = document.createElement('span');
      timeBadge.className='card-info-badge';
      timeBadge.innerHTML = `${iconMarkup('clock')} <span>${esc(data.pickupWindow)}</span>`;
      infoRow.appendChild(timeBadge);
    }
    
    // map-pin: distance
    if(data.distanceKm != null){
      const distBadge = document.createElement('span');
      distBadge.className='card-info-badge';
      distBadge.innerHTML = `${iconMarkup('map-pin')} <span>${Number(data.distanceKm).toFixed(1)}</span>`;
      infoRow.appendChild(distBadge);
    }
    
    // No-Limits: Keine Mengenangaben mehr - Status wird über active gesteuert
    
    // food type: leaf (Vegan), carrot (Vegetarian), drumstick (Meat), fish (Fish)
    const foodTypeIcon = data.category === 'Vegan' ? 'leaf' : 
                         data.category === 'Vegetarisch' ? 'carrot' : 
                         data.category === 'Mit Fleisch' ? 'drumstick' : 
                         data.category === 'Fisch' ? 'fish' : '';
    if(foodTypeIcon){
      const typeBadge = document.createElement('span');
      typeBadge.className='card-info-badge';
      typeBadge.innerHTML = iconMarkup(foodTypeIcon);
      infoRow.appendChild(typeBadge);
    }
    
    // Max 4 Icons pro Info-Zeile
    if(infoRow.children.length > 4){
      while(infoRow.children.length > 4){
        infoRow.removeChild(infoRow.lastChild);
      }
    }
    
    if(infoRow.children.length > 0){
      body.appendChild(infoRow);
    }
    
    // Actions: Nur ein Primary CTA "Bestellen"
    if(interactive){
      const actions=document.createElement('div');
      actions.className='card-actions';
      
      const orderBtn=document.createElement('button');
      orderBtn.type='button';
      orderBtn.className='card-action primary';
      orderBtn.innerHTML = `${iconMarkup('shopping-cart')} <span>Bestellen</span>`;
      orderBtn.disabled = !data.hasPickupCode;
      orderBtn.onclick=(e)=>{ e.stopPropagation(); handleOrderClick(data); };
      
      actions.appendChild(orderBtn);
      body.appendChild(actions);
    }

    card.appendChild(img);
    card.appendChild(body);
    
    // Icons aktualisieren (für Heart Icon)
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
    
    return card;
  }

  function providerCard(o, opts={}){
    const data = normalizeOffer(o);
    const interactive = opts.interactive !== false;
    const showActions = opts.showActions === true;
    const isToday = data.day === (opts.todayKey || isoDate(new Date()));
    const statusLine = data.hasPickupCode ? (isToday ? 'Online-Ticket · Heute' : 'Online-Ticket') : '';
    const card=document.createElement('div');
    card.className='card';
    card.style.cursor = interactive ? 'pointer' : 'default';
    if(interactive){
      card.onclick=()=>openProviderOffer(data.id);
    }

    const profile = normalizeProviderProfile(provider.profile || {});
    const imgSrc = data.imageUrl || data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    const windowText = data.pickupWindow || profile.mealWindow || '';

    const img=document.createElement('div');
    img.className='img';
    img.innerHTML = `
      <img alt="${esc(data.dish||'Gericht')}" src="${esc(imgSrc)}" />
      ${data.active===false?'<div class="badge inactive">Inaktiv</div>':''}
      ${data.hasPickupCode?'<div class="badge code">Ticket</div>':''}
      ${data.dineInPossible?'<div class="badge dine">Vor Ort</div>':''}
    `;

    const body=document.createElement('div');
    body.className='body';
    body.innerHTML = `
      <p class="title">${esc(data.dish||'Gericht')}</p>
      <p class="sub">Essenszeit: ${esc(windowText || '—')}</p>
      ${statusLine ? `<div class="tag">${esc(statusLine)}</div>` : ''}
      <div class="meta">
        <div class="price">${euro(data.price)}</div>
        <div class="right">
          <div>${esc(data.category||'')}</div>
        </div>
      </div>
    `;

    const info=document.createElement('div');
    info.className='info-row';
    const addInfo = (icon, text)=>{
      const item=document.createElement('div');
      item.className='info-item';
      item.innerHTML = `${iconMarkup(icon)}<span>${esc(text)}</span>`;
      info.appendChild(item);
    };
    if(data.hasPickupCode) addInfo('ticket', 'Online-Ticket');
    if(data.dineInPossible) addInfo('utensils', 'Vor Ort');
    if(info.childElementCount){ body.appendChild(info); }

    if(showActions){
      const actions=document.createElement('div');
      actions.className='card-actions';

      const actBtn=document.createElement('button');
      actBtn.type='button';
      actBtn.className='card-action';
      actBtn.innerHTML = `${iconMarkup('action')}<span>Aktionen</span>`;
      actBtn.onclick=(e)=>{ e.stopPropagation(); openProviderOffer(data.id); };

      const shareBtn=document.createElement('button');
      shareBtn.type='button';
      shareBtn.className='card-action';
      shareBtn.innerHTML = `${iconMarkup('share')}<span>Teilen</span>`;
      shareBtn.onclick=(e)=>{ e.stopPropagation(); shareOffer(data); };

      const printBtn=document.createElement('button');
      printBtn.type='button';
      printBtn.className='card-action';
      printBtn.innerHTML = `${iconMarkup('print')}<span>Drucken</span>`;
      printBtn.onclick=(e)=>{ e.stopPropagation(); printOffer(data); };

      actions.appendChild(actBtn);
      actions.appendChild(shareBtn);
      actions.appendChild(printBtn);
      body.appendChild(actions);
    }

    card.appendChild(img);
    card.appendChild(body);
    return card;
  }

  function toggleProviderFav(providerId){
    if(!providerId) return;
    if(providerFavs.has(providerId)) providerFavs.delete(providerId); else providerFavs.add(providerId);
    const arr = Array.from(providerFavs);
    save(LS.providerFavs, arr);
    // keep legacy key for compatibility
    save(LS.favs, arr);
    renderDiscover();
    renderStart();
    renderFavorites();
    updateSheetFavs();
  }

  function toggleDishFav(offerId){
    if(!offerId) return;
    if(dishFavs.has(offerId)) dishFavs.delete(offerId); else dishFavs.add(offerId);
    save(LS.dishFavs, Array.from(dishFavs));
    renderDiscover();
    renderStart();
    renderFavorites();
    updateSheetFavs();
  }
  
  // Favoriten-Karte mit "In die Mittagsbox" Button
  function createFavoriteCard(o){
    const data = normalizeOffer(o);
    const card = document.createElement('div');
    card.className = 'card';
    card.style.position = 'relative';
    
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    
    // Entfernen-Button (X oben rechts)
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'card-heart';
    removeBtn.style.position = 'absolute';
    removeBtn.style.top = '12px';
    removeBtn.style.right = '12px';
    removeBtn.style.zIndex = '10';
    removeBtn.style.background = 'rgba(255,255,255,0.95)';
    removeBtn.style.border = 'none';
    removeBtn.style.borderRadius = '50%';
    removeBtn.style.width = '36px';
    removeBtn.style.height = '36px';
    removeBtn.style.display = 'flex';
    removeBtn.style.alignItems = 'center';
    removeBtn.style.justifyContent = 'center';
    removeBtn.style.cursor = 'pointer';
    removeBtn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
    removeBtn.innerHTML = iconMarkup('x');
    removeBtn.onclick = (e) => {
      e.stopPropagation();
      toggleDishFav(data.id);
    };
    
    // Image
    const img = document.createElement('div');
    img.className = 'img';
    img.innerHTML = `<img alt="${esc(data.dish||'Gericht')}" src="${esc(imgSrc)}" />`;
    
    // Body
    const body = document.createElement('div');
    body.className = 'body';
    body.innerHTML = `
      <p class="title">${esc(data.dish||'Gericht')}</p>
      <p class="sub">${esc(data.providerName||'Anbieter')}</p>
      <div class="meta" style="margin-top:12px; margin-bottom:16px;">
        <div class="price" style="font-size:24px; font-weight:900; color:var(--brand);">${euro(data.price)}</div>
      </div>
    `;
    
    // "In die Mittagsbox" Button
    const addToCartBtn = document.createElement('button');
    addToCartBtn.type = 'button';
    addToCartBtn.className = 'btn-primary';
    addToCartBtn.style.width = '100%';
    addToCartBtn.style.minHeight = '48px';
    addToCartBtn.style.fontSize = '16px';
    addToCartBtn.style.fontWeight = '700';
    addToCartBtn.style.marginTop = '8px';
    addToCartBtn.innerHTML = `${iconMarkup('shopping-basket')} <span>Heute essen</span>`;
    addToCartBtn.onclick = (e) => {
      e.stopPropagation();
      addFavoriteToCart(o);
    };
    body.appendChild(addToCartBtn);
    
    card.appendChild(removeBtn);
    card.appendChild(img);
    card.appendChild(body);
    
    // Klick auf Karte öffnet Details
    card.onclick = () => {
      openOffer(data.id);
    };
    
    return card;
  }
  
  // Favorit zur Mittagsbox hinzufügen
  function addFavoriteToCart(o){
    const data = normalizeOffer(o);
    
    // Prüfe ob Gericht Abholcode hat
    if(!data.hasPickupCode){
      showToast('Dieses Gericht hat keinen Abholcode. Bitte wähle ein anderes Gericht.', 3000);
      return;
    }
    
    // Bestätigung
    const confirmed = confirm(`Dieses Gericht für heute wählen?\n\n${esc(data.dish||'Gericht')}\n${euro(data.price)}\n\nNach der Zahlung erhältst du deine Abholnummer.`);
    if(!confirmed) return;
    
    // Zur Mittagsbox hinzufügen
    if(addToCart(o)){
      showToast('Gericht zur Mittagsbox hinzugefügt! 🧺', 2000);
      updateHeaderBasket();
      
      // Zur Mittagsbox navigieren (dort kann der Nutzer dann zur Kasse gehen)
      setTimeout(() => {
        showCart();
      }, 500);
    } else {
      showToast('Fehler beim Hinzufügen. Bitte erneut versuchen.', 3000);
    }
  }

  function renderFavorites(){
    const provGrid=document.getElementById('favProviders');
    const provEmpty=document.getElementById('emptyFavProviders');
    const dishGrid=document.getElementById('favDishes');
    const dishEmpty=document.getElementById('emptyFavDishes');
    const favEmptyState = document.getElementById('favEmptyState');
    const favContent = document.getElementById('favContent');
    if(!provGrid || !dishGrid || !provEmpty || !dishEmpty) return;

    const candidates = offers
      .filter(o => o.active !== false && providerFavs.has(o.providerId))
      .sort((a,b)=>String(b.day||'').localeCompare(String(a.day||'')));
    const bestByProvider = new Map();
    candidates.forEach(o=>{
      if(!bestByProvider.has(o.providerId)) bestByProvider.set(o.providerId, o);
    });
    const providerList = Array.from(bestByProvider.values());

    const dishList = offers
      .filter(o => o.active !== false && dishFavs.has(o.id))
      .sort((a,b)=>String(b.day||'').localeCompare(String(a.day||'')));

    // Empty State: Wenn beide Listen leer sind, zeige zentrierten Empty State
    const hasAnyFavorites = providerList.length > 0 || dishList.length > 0;
    
    if(favEmptyState){
      favEmptyState.style.display = hasAnyFavorites ? 'none' : 'flex';
      // Stelle sicher, dass Flex-Layout aktiv ist
      if(!hasAnyFavorites){
        favEmptyState.style.flexDirection = 'column';
        favEmptyState.style.alignItems = 'center';
        favEmptyState.style.textAlign = 'center';
      }
    }
    if(favContent){
      favContent.style.display = hasAnyFavorites ? 'block' : 'none';
    }
    
    // Provider Section - Optional Chaining für Fehlerbehebung
    provGrid.innerHTML='';
    const sectionProviders = document.getElementById('sectionProviders');
    if(sectionProviders) sectionProviders.style.display = providerList.length > 0 ? 'block' : 'none';
    provEmpty.style.display = providerList.length ? 'none' : 'block';
    providerList.forEach(o=>{
      if(o?.id){
        try {
          provGrid.appendChild(offerCard(o));
        } catch(err){
          console.error('Error rendering provider favorite:', err, o);
        }
      }
    });

    // Dish Section - Optional Chaining für Fehlerbehebung
    dishGrid.innerHTML='';
    const sectionDishes = document.getElementById('sectionDishes');
    if(sectionDishes) sectionDishes.style.display = dishList.length > 0 ? 'block' : 'none';
    dishEmpty.style.display = dishList.length ? 'none' : 'block';
    dishList.forEach(o=>{
      if(o?.id){
        try {
          dishGrid.appendChild(createFavoriteCard(o));
        } catch(err){
          console.error('Error rendering dish favorite:', err, o);
        }
      }
    });
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }

  // Legacy: genPickupCode (wird durch generatePickupCode ersetzt)
  function genPickupCode(){
    return generatePickupCode();
  }

  function renderOrders(){
    // Orders aus localStorage laden
    orders = loadOrders();
    
    const box = document.getElementById('ordersList');
    const filters = document.getElementById('ordersFilters');
    if(!box) return;
    if(filters){
      filters.innerHTML='';
      [
        {id:'offen', label:'Offen'},
        {id:'abgeholt', label:'Abgeholt'},
        {id:'alle', label:'Alle'}
      ].forEach(f=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(ordersFilter===f.id?' on':'');
        b.textContent=f.label;
        b.onclick=()=>{ ordersFilter=f.id; renderOrders(); };
        filters.appendChild(b);
      });
    }
    if(!orders.length){
      box.textContent = 'Noch keine Bestellungen.';
      return;
    }
    const fmt = (ts)=>{
      const d = new Date(ts);
      if(Number.isNaN(d.getTime())) return '';
      return fmtDay(d);
    };
    const list = orders.filter(o=>{
      if(ordersFilter==='alle') return true;
      // Map status for filter matching
      const status = o.status || 'offen';
      if(ordersFilter === 'offen'){
        // Show PAID orders (not picked up)
        return status === 'PAID';
      }
      if(ordersFilter === 'abgeholt'){
        // Show PICKED_UP or COMPLETED orders
        return status === 'PICKED_UP' || status === 'COMPLETED' || o.pickupStatus === 'PICKED_UP';
      }
      return status === ordersFilter;
    });
    list.sort((a,b)=>{
      if(ordersFilter === 'alle'){
        const sa = a.status || 'offen';
        const sb = b.status || 'offen';
        // Sortierung: PAID > PAYMENT_PENDING > CREATED > andere
        const priority = { 'PAID': 1, 'PAYMENT_PENDING': 2, 'CREATED': 3, 'offen': 4 };
        const pa = priority[sa] || 5;
        const pb = priority[sb] || 5;
        if(pa !== pb) return pa - pb;
      }
      return (b.createdAt||0) - (a.createdAt||0);
    });
    if(!list.length){
      box.textContent = 'Keine passenden Bestellungen.';
      return;
    }
    box.innerHTML = list.map(o=>{
      // Status-Anzeige
      const status = o.status || 'offen';
      // Check for PICKED_UP status (from pickupStatus field or status)
      // Single source of truth: Order record
      const isPickedUp = status === 'PICKED_UP' || status === 'COMPLETED' || o.pickupStatus === 'PICKED_UP' || status === 'abgeholt';
      const statusLabel = isPickedUp ? 'Abgeholt ✅' :
                         status === 'CREATED' ? 'Erstellt' :
                         status === 'PAYMENT_PENDING' ? 'Zahlung ausstehend' :
                         status === 'PAID' ? 'Bezahlt' :
                         status === 'CANCELLED' ? 'Abgebrochen' :
                         status;
      const isDone = isPickedUp;
      const code = o.pickupCode || o.code || '';
      // Code nur anzeigen wenn PAID (Guard)
      const showCode = status === 'PAID' && code;
      
      return `
      <div class="order-item ${isDone ? 'done' : ''}">
        <div class="order-top">
          <div>
            <div style="font-weight:900">${esc(o.providerName || 'Anbieter')}</div>
            <div class="hint">${esc(o.dishName || o.summary || '')}</div>
          </div>
          <div class="order-right">
            ${showCode ? `<button class="order-code" type="button" data-id="${esc(o.id||'')}" data-code="${esc(code)}">${esc(code)}</button>` : ''}
            <div class="status-pill ${isDone ? 'done' : 'open'}">${esc(statusLabel)}</div>
          </div>
        </div>
        <div class="hint" style="margin-top:6px;">
          ${o.total ? `Gesamt: ${euro(o.totalCents ? (o.totalCents / 100) : (o.total || 0))} · ` : ''}${o.etaTime ? `Abholzeit: ${esc(o.etaTime)} · ` : ''}${fmt(o.createdAt)}
        </div>
      </div>
    `;
    }).join('');

    box.querySelectorAll('.order-code').forEach(btn=>{
      btn.onclick=()=> {
        const orderId = btn.getAttribute('data-id') || '';
        showPickupCode(orderId); // Navigiere zu AbholcodeScreen statt codeSheet
      };
    });
  }

  function openCodeSheet(orderId){
    const order = orders.find(o=>o.id===orderId);
    if(!order) return;
    activeOrderId = orderId;
    document.getElementById('codeText').textContent = order.code || '';
    document.getElementById('codeStatus').textContent = order.status === 'abgeholt' ? 'Status: abgeholt' : 'Status: offen';
    document.getElementById('btnToggleOrderStatus').textContent = order.status === 'abgeholt' ? 'Als offen markieren' : 'Als abgeholt markieren';
    document.getElementById('codeProvider').textContent = order.providerName || 'Anbieter';
    document.getElementById('codeSummary').textContent = order.summary || '';
    document.getElementById('codePickupWindow').textContent = order.pickupWindow ? `Essenszeit: ${order.pickupWindow}` : 'Essenszeit: –';
    document.getElementById('codePickupTime').textContent = order.pickupTime ? order.pickupTime : 'offen';
    
    // Logo rendern (falls vorhanden)
    const logoEl = document.getElementById('codeProviderLogo');
    if(logoEl){
      const providerOffer = offers.find(o=>o.providerName === order.providerName);
      if(providerOffer && providerOffer.providerLogo){
        logoEl.innerHTML = `<img src="${providerOffer.providerLogo}" alt="Logo" />`;
      } else {
        logoEl.innerHTML = `<img src="assets/provider-placeholder.png" alt="Logo" />`;
      }
    }
    
    document.getElementById('codeBd').classList.add('active');
    document.getElementById('codeSheet').classList.add('active');
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }
  function closeCodeSheet(){
    document.getElementById('codeBd').classList.remove('active');
    document.getElementById('codeSheet').classList.remove('active');
    activeOrderId = null;
  }

  // --- Offer sheet ---
  let activeOfferId=null;
  let activeProviderOfferId=null;
  // Navigation History für Back-Button
  let navigationHistory = [];
  
  function openOffer(id){
    const raw = offers.find(x=>x.id===id);
    if(!raw) return;
    const o = normalizeOffer(raw);
    activeOfferId=id;
    
    // History speichern (inkl. Scroll-Position)
    navigationHistory.push({
      view: mode === 'start' ? 'start' : 'discover',
      locationQuery: locationQuery,
      activeCat: activeCat,
      activeDay: activeDay,
      activeFilter: activeDiscoverFilter,
      scrollY: window.scrollY
    });

    const sImg = document.getElementById('sImg');
    const sDish = document.getElementById('sDish');
    const sProvider = document.getElementById('sProvider');
    const sPrice = document.getElementById('sPrice');
    const sCat = document.getElementById('sCat');
    const sWindow = document.getElementById('sWindow');
    
    if(sImg) sImg.src = o.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    if(sDish) sDish.textContent = o.dish || '';
    // Provider mit Icon
    const sProviderEl = document.getElementById('sProvider');
    if(sProviderEl){
      const providerSpan = sProviderEl.querySelector('span');
      if(providerSpan) providerSpan.textContent = o.providerName || 'Anbieter';
    }
    // Preis wird nicht mehr angezeigt (öffentliche Seite)
    // if(sPrice) sPrice.textContent = euro(o.price);
    if(sCat) sCat.textContent = o.category || '';
    if(sWindow) sWindow.textContent = o.pickupWindow || '';
    
    // Status Badge (dynamisch basierend auf Abholcode)
    const statusBadgeEl = document.getElementById('sStatusBadge');
    if(statusBadgeEl){
      if(o.hasPickupCode){
        // MIT Abholnummer: Status "Online bezahlen & Abholnummer"
        statusBadgeEl.innerHTML = '<span style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px; background:rgba(46,125,50,.12); border-radius:8px; color:#2e7d32; font-size:14px; font-weight:600;">🟢 Online bezahlen & Abholnummer</span>';
      } else {
        // OHNE Abholcode: Status "Vor Ort erhältlich"
        statusBadgeEl.innerHTML = '<span style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px; background:rgba(0,0,0,.06); border-radius:8px; color:#666; font-size:14px; font-weight:600;">⚪ Vor Ort erhältlich</span>';
      }
    }

    // Badges Row (max 3)
    const badgesEl = document.getElementById('sBadges');
    if(badgesEl){
      badgesEl.innerHTML = '';
      const badges = [];
      if(o.dineInPossible) badges.push({class:'dine', text:'Vor Ort', icon:'utensils'});
      if(!o.dineInPossible || badges.length < 3) badges.push({class:'pickup', text:'Zum Mitnehmen', icon:'shopping-bag'});
      if(o.hasPickupCode && badges.length < 3) badges.push({class:'code', text:'Abholnummer', icon:'ticket'});
      
      badges.slice(0, 3).forEach(badge => {
        const badgeEl = document.createElement('span');
        badgeEl.className = `card-status-badge ${badge.class}`;
        badgeEl.innerHTML = `${iconMarkup(badge.icon)} <span>${esc(badge.text)}</span>`;
        badgesEl.appendChild(badgeEl);
      });
    }
    
    // Info Row (Icons: clock, map-pin, food icon)
    const infoRowEl = document.getElementById('sInfoRow');
    if(infoRowEl){
      infoRowEl.innerHTML = '';
      if(o.pickupWindow){
        const day = o.day ? new Date(o.day) : new Date();
        const dateStr = fmtDateWithTime(day, o.pickupWindow);
        const timeEl = document.createElement('div');
        timeEl.style.display = 'flex';
        timeEl.style.alignItems = 'center';
        timeEl.style.gap = '6px';
        timeEl.innerHTML = `${iconMarkup('clock')} <span>${esc(dateStr)}</span>`;
        infoRowEl.appendChild(timeEl);
      }
      if(o.distanceKm != null){
        const distEl = document.createElement('div');
        distEl.style.display = 'flex';
        distEl.style.alignItems = 'center';
        distEl.style.gap = '6px';
        distEl.innerHTML = `${iconMarkup('map-pin')} <span>${Number(o.distanceKm).toFixed(1)} km</span>`;
        infoRowEl.appendChild(distEl);
      }
      // Food type icon (exactly one)
      const foodTypeIcon = o.category === 'Vegan' ? 'leaf' : 
                           o.category === 'Vegetarisch' ? 'carrot' : 
                           o.category === 'Fisch' ? 'fish' :
                           o.category === 'Mit Fleisch' ? 'drumstick' : '';
      if(foodTypeIcon){
        const foodEl = document.createElement('div');
        foodEl.innerHTML = iconMarkup(foodTypeIcon);
        infoRowEl.appendChild(foodEl);
      }
    }
    
    // Address Card
    const addr = buildAddress({address:o.address, street:o.providerStreet, zip:o.providerZip, city:o.providerCity});
    const maps = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
    const addressFullEl = document.getElementById('sAddressFull');
    if(addressFullEl){
      const fullAddr = [
        o.providerName || '',
        o.providerStreet || '',
        o.providerZip || '',
        o.providerCity || ''
      ].filter(Boolean).join(', ');
      addressFullEl.textContent = fullAddr || addr || '-';
    }
    
    const btnOpenRoute = document.getElementById('btnOpenRoute');
    if(btnOpenRoute){
      btnOpenRoute.onclick = () => {
        window.open(maps, '_blank');
      };
    }

    // Allergens
    const aw = document.getElementById('sAllergensWrap');
    if(o.allergens && o.allergens.length){
      aw.style.display='block';
      document.getElementById('sAllergens').textContent = o.allergens.join(', ');
    } else aw.style.display='none';

    // Extras
    const ew = document.getElementById('sExtrasWrap');
    if(o.extras && o.extras.length){
      ew.style.display='block';
      document.getElementById('sExtras').textContent = o.extras.map(e=>`${e.name} (+${euro(e.price)})`).join(' · ');
    } else ew.style.display='none';

    // Reuse
    const rw = document.getElementById('sReuseWrap');
    if(o.reuse && o.reuse.enabled){
      rw.style.display='block';
      document.getElementById('sReuse').textContent = `Pfand ${euro(o.reuse.deposit)}`;
    } else rw.style.display='none';

    // Primary CTA (dynamisch basierend auf Abholcode)
    const primaryCTA = document.getElementById('btnPrimaryCTA');
    const primaryCTAText = document.getElementById('btnPrimaryCTAText');
    // btnOpenRoute wurde bereits oben deklariert (Zeile 4580)
    
    if(primaryCTA && primaryCTAText){
      // Reset states
      primaryCTA.disabled = false;
      primaryCTA.className = 'btn-primary';
      primaryCTA.classList.remove('loading', 'success');
      
      // Check if offer is active/available
      const isActive = o.active !== false;
      const todayKey = isoDate(new Date());
      const isToday = o.day === todayKey;
      const isAvailable = isActive && isToday;
      
      if(!isAvailable){
        // Disabled state with reason
        primaryCTA.disabled = true;
        if(!isActive){
          primaryCTAText.textContent = 'Angebot nicht verfügbar';
        } else if(!isToday){
          primaryCTAText.textContent = 'Angebot nicht mehr verfügbar';
        } else {
          primaryCTAText.textContent = 'Nicht verfügbar';
        }
        primaryCTA.onclick = null;
      } else if(o.hasPickupCode){
        // MIT Abholcode: CTA "In die Mittagsbox"
        primaryCTAText.textContent = 'In die Mittagsbox';
        primaryCTA.onclick = () => {
          // Loading state
          primaryCTA.disabled = true;
          primaryCTA.classList.add('loading');
          primaryCTAText.textContent = 'Wird hinzugefügt...';
          
          // Navigate to cart/checkout
          setTimeout(() => {
            if(addToCart(o)){
              // Success state
              primaryCTA.classList.remove('loading');
              primaryCTA.classList.add('success');
              primaryCTAText.textContent = 'Erfolgreich!';
              showToast('Gericht zur Mittagsbox hinzugefügt! 🧺');
              
              // Redirect to cart
              setTimeout(() => {
                showCart();
                // Reset button after navigation
                setTimeout(() => {
                  primaryCTA.disabled = false;
                  primaryCTA.classList.remove('success');
                  primaryCTAText.textContent = 'In die Mittagsbox';
                }, 500);
              }, 300);
            } else {
              // Error: reset to default
              primaryCTA.disabled = false;
              primaryCTA.classList.remove('loading');
              primaryCTAText.textContent = 'Jetzt online bestellen';
              showToast('Fehler beim Hinzufügen. Bitte erneut versuchen.');
            }
          }, 200);
        };
      } else {
        // OHNE Abholcode: CTA "Route öffnen"
        primaryCTAText.textContent = 'Route öffnen';
        primaryCTA.onclick = () => {
          // Open route in maps (no loading state needed)
          const profile = normalizeProviderProfile(provider.profile || {});
          const address = `${profile.street || ''}, ${profile.zip || ''} ${profile.city || ''}`.trim();
          const maps = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
          window.open(maps, '_blank');
        };
      }
    }
    
    // Route Button in Address Card (nur bei OHNE Abholcode sichtbar)
    if(btnOpenRoute){
      if(!o.hasPickupCode){
        btnOpenRoute.style.display = 'block';
        btnOpenRoute.onclick = () => {
          const profile = normalizeProviderProfile(provider.profile || {});
          const address = `${profile.street || ''}, ${profile.zip || ''} ${profile.city || ''}`.trim();
          const maps = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
          window.open(maps, '_blank');
        };
      } else {
        btnOpenRoute.style.display = 'none';
      }
    }

    updateSheetFavs();

    document.getElementById('bd').classList.add('active');
    document.getElementById('sheet').classList.add('active');
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }

  function updateSheetFavs(){
    const providerBtn = document.getElementById('btnFav');
    const dishBtn = document.getElementById('btnDishFav');
    if(!activeOfferId){
      if(providerBtn) providerBtn.textContent='Anbieter speichern';
      if(dishBtn) dishBtn.textContent='Gericht speichern';
      return;
    }
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    const providerKey = o.providerId;
    const dishKey = o.id;
    if(providerBtn){
      const label = providerKey && providerFavs.has(providerKey) ? 'Anbieter entfernen' : 'Anbieter speichern';
      providerBtn.innerHTML = `${iconMarkup('heart')}<span>${esc(label)}</span>`;
    }
    if(dishBtn){
      const label = dishKey && dishFavs.has(dishKey) ? 'Gericht entfernen' : 'Gericht speichern';
      dishBtn.innerHTML = `${iconMarkup('heart')}<span>${esc(label)}</span>`;
    }
  }

  function closeSheet(){
    document.getElementById('bd').classList.remove('active');
    document.getElementById('sheet').classList.remove('active');
    
    // Zurück zur vorherigen Ansicht (inkl. Scroll-Position)
    if(navigationHistory.length > 0){
      const prev = navigationHistory.pop();
      locationQuery = prev.locationQuery || '';
      activeCat = prev.activeCat || null;
      activeDay = prev.activeDay || isoDate(new Date());
      activeDiscoverFilter = prev.activeFilter || 'near';
      
      if(prev.view === 'start'){
        showStart();
      } else {
        showDiscover();
      }
      
      // Scroll-Position wiederherstellen
      if(prev.scrollY !== undefined){
        setTimeout(()=>{
          window.scrollTo({top: prev.scrollY, behavior: 'auto'});
        }, 100);
      }
    }
  }
  
  // --- Match-Screen (nach Rechts-Swipe) ---
  let currentMatchOffer = null;
  
  function showMatchModal(offer){
    if(!offer) return;
    currentMatchOffer = offer;
    const data = normalizeOffer(offer);
    
    // Modal öffnen
    document.getElementById('matchBd').classList.add('active');
    document.getElementById('matchSheet').classList.add('active');
    
    // Daten füllen
    const dishImageEl = document.getElementById('matchDishImage');
    const dishNameEl = document.getElementById('matchDishName');
    const providerNameEl = document.getElementById('matchProviderName');
    const distanceEl = document.getElementById('matchDistance');
    const fastWegEl = document.getElementById('matchFastWeg');
    
    if(dishImageEl){
      const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
      dishImageEl.innerHTML = `<img src="${esc(imgSrc)}" alt="${esc(data.dish||'')}" style="width:100%; height:100%; object-fit:cover;" />`;
    }
    if(dishNameEl) dishNameEl.textContent = data.dish || 'Gericht';
    if(providerNameEl) providerNameEl.textContent = data.providerName || 'Anbieter';
    if(distanceEl){
      const distance = data.distanceKm != null ? `${Math.round(data.distanceKm * 1000)}m` : '';
      distanceEl.textContent = distance ? `Nur ${distance} von dir entfernt` : 'In deiner Nähe';
    }
    
    // Fast weg Badge (wenn ausverkauft oder fast ausverkauft)
    if(fastWegEl){
      // No-Limits: Keine "Fast weg" Logik mehr - Status wird über active gesteuert
      fastWegEl.style.display = 'none';
    }
    
    // Konfetti-Animation
    triggerMatchConfetti();
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(() => lucide.createIcons(), 50);
    }
  }
  
  function closeMatchModal(){
    document.getElementById('matchBd').classList.remove('active');
    document.getElementById('matchSheet').classList.remove('active');
    currentMatchOffer = null;
  }
  
  function triggerMatchConfetti(){
    const canvas = document.getElementById('matchConfetti');
    if(!canvas) return;
    
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    
    const particles = [];
    const colors = ['#FFB800', '#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1'];
    
    for(let i = 0; i < 50; i++){
      particles.push({
        x: canvas.width / 2,
        y: canvas.height / 2,
        vx: (Math.random() - 0.5) * 10,
        vy: (Math.random() - 0.5) * 10 - 5,
        color: colors[Math.floor(Math.random() * colors.length)],
        size: Math.random() * 6 + 4,
        life: 1
      });
    }
    
    function animate(){
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      particles.forEach((p, i) => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.2; // Gravity
        p.life -= 0.02;
        
        if(p.life > 0){
          ctx.globalAlpha = p.life;
          ctx.fillStyle = p.color;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
          ctx.fill();
        } else {
          particles.splice(i, 1);
        }
      });
      
      if(particles.length > 0){
        requestAnimationFrame(animate);
      }
    }
    animate();
  }
  
  // Match Modal Handlers
  const btnMatchReserve = document.getElementById('btnMatchReserve');
  if(btnMatchReserve){
    btnMatchReserve.onclick = () => {
      if(currentMatchOffer){
        closeMatchModal();
        // Direkt zum Checkout
        const data = normalizeOffer(currentMatchOffer);
        if(data.hasPickupCode){
          handleOrderClick(currentMatchOffer);
        } else {
          openOffer(currentMatchOffer.id);
        }
      }
    };
  }
  
  const btnMatchLater = document.getElementById('btnMatchLater');
  if(btnMatchLater){
    btnMatchLater.onclick = () => {
      if(currentMatchOffer){
        // Zu Favoriten hinzufügen
        toggleDishFav(currentMatchOffer.id);
        closeMatchModal();
        showToast('Gericht zu Favoriten hinzugefügt');
      }
    };
  }
  
  // Backdrop Handler
  const matchBd = document.getElementById('matchBd');
  if(matchBd){
    matchBd.onclick = () => {
      closeMatchModal();
    };
  }
  
  // Android Hardware-Back unterstützen
  window.addEventListener('popstate', function(e){
    // AGB Onboarding Modal schließen
    if(document.getElementById('agbOnboardingSheet') && document.getElementById('agbOnboardingSheet').classList.contains('active')){
      closeAgbOnboardingModal();
      e.preventDefault();
      return;
    }
    // Fullscreen Code Modal schließen
    if(document.getElementById('fullscreenCode') && document.getElementById('fullscreenCode').classList.contains('active')){
      closeFullscreenCode();
      e.preventDefault();
      history.pushState(null, '', location.pathname);
      return;
    }
    // Pickup Confirmation Sheet schließen
    if(document.getElementById('pickupConfirmSheet') && document.getElementById('pickupConfirmSheet').classList.contains('active')){
      closePickupConfirmSheet();
      e.preventDefault();
      history.pushState(null, '', location.pathname);
      return;
    }
    // Create Flow Sheet schließen
    if(document.getElementById('createFlowSheet') && document.getElementById('createFlowSheet').classList.contains('active')){
      closeCreateFlowSheet();
      e.preventDefault();
      history.pushState(null, '', location.pathname);
      return;
    }
    // FAQ Sheet schließen
    if(document.getElementById('faqSheet') && document.getElementById('faqSheet').classList.contains('active')){
      closeFaqSheet();
      e.preventDefault();
      history.pushState(null, '', location.pathname);
      return;
    }
    // Login Modal schließen
    if(document.getElementById('loginSheet') && document.getElementById('loginSheet').classList.contains('active')){
      closeLoginSheet();
      e.preventDefault();
      history.pushState(null, '', location.pathname);
      return;
    }
    // Provider Login Modal schließen
    if(document.getElementById('providerLoginSheet') && document.getElementById('providerLoginSheet').style.display !== 'none'){
      closeProviderLoginModal();
      e.preventDefault();
      history.pushState(null, '', location.pathname);
      return;
    }
    // Wizard schließen
    if(document.getElementById('wizard') && document.getElementById('wizard').classList.contains('active')){
      closeWizard();
      e.preventDefault();
      history.pushState(null, '', location.pathname);
      return;
    }
    // Sheet schließen
    if(document.getElementById('sheet') && document.getElementById('sheet').classList.contains('active')){
      closeSheet();
      e.preventDefault();
      history.pushState(null, '', location.pathname);
      return;
    }
    // Onboarding back navigation
    const currentView = document.querySelector('.view.active');
    if(currentView && currentView.id.startsWith('v-provider-onboarding')){
      if(currentView.id === 'v-provider-onboarding-preview'){
        showOnboardingBusiness();
        e.preventDefault();
        history.pushState(null, '', location.pathname);
        return;
      } else if(currentView.id === 'v-provider-onboarding-business'){
        showOnboardingSignup();
        e.preventDefault();
        history.pushState(null, '', location.pathname);
        return;
      } else if(currentView.id === 'v-provider-onboarding-signup'){
        showOnboardingFirstDish(!!onboardingDraftDish);
        e.preventDefault();
        history.pushState(null, '', location.pathname);
        return;
      } else if(currentView.id === 'v-provider-onboarding-first-dish'){
        showOnboardingEntry(!!onboardingDraftDish);
        e.preventDefault();
        history.pushState(null, '', location.pathname);
        return;
      } else if(currentView.id === 'v-provider-onboarding-entry'){
        // Animation für 3-Punkt-Erklärung
        setTimeout(() => {
          const points = document.querySelectorAll('#onboardingExplanationPoints .onboarding-point');
          points.forEach((point, index) => {
            setTimeout(() => {
              point.style.opacity = '1';
              point.style.transform = 'translateY(0)';
            }, index * 200);
          });
          // Icons aktualisieren
          if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 100);
        }, 100);
        // Exit onboarding, go to login or customer mode
        if(provider.loggedIn){
          showProviderHome();
        } else {
          setMode('customer');
          showProfile();
        }
        e.preventDefault();
        history.pushState(null, '', location.pathname);
        return;
      }
    }
    
    // In-App Navigation: Zurück zu vorheriger View innerhalb der App
    // Prüfe ob wir in einer Customer-View sind
    if(currentView){
      const viewId = currentView.id;
      if(viewId === 'v-fav'){
        showDiscover();
        e.preventDefault();
        return;
      } else if(viewId === 'v-cart'){
        showDiscover();
        e.preventDefault();
        return;
      } else if(viewId === 'v-orders'){
        showProfile();
        e.preventDefault();
        return;
      } else if(viewId === 'v-profile'){
        showDiscover();
        e.preventDefault();
        return;
      } else if(viewId === 'v-discover'){
        showStart();
        e.preventDefault();
        return;
      } else if(viewId === 'v-start'){
        // Bleib auf Start oder gehe zu Discover
        showStart();
        e.preventDefault();
        return;
      }
    }
    
    // Provider Views
    if(mode === 'provider'){
      const providerView = currentView ? currentView.id : '';
      if(providerView === 'v-provider-profile'){
        showProviderHome();
        e.preventDefault();
        return;
      } else if(providerView === 'v-provider-pickups'){
        showProviderHome();
        e.preventDefault();
        return;
      } else if(providerView === 'v-provider-cookbook'){
        showProviderHome();
        e.preventDefault();
        return;
      } else if(providerView === 'v-provider-billing'){
        showProviderProfile();
        e.preventDefault();
        return;
      }
    }
  });

  function openProviderOffer(id){
    const raw = offers.find(x=>x.id===id);
    if(!raw) return;
    const o = normalizeOffer(raw);
    activeProviderOfferId = id;

    const preview = document.getElementById('pPreview');
    preview.innerHTML = '';
    preview.appendChild(offerCard(o, {interactive:false}));

    document.getElementById('pStatus').textContent = o.active===false ? 'Ausverkauft' : 'Noch da';
    document.getElementById('pWindow').textContent = o.pickupWindow || '-';
    
    // No-Limits: Prominenter "Ausverkauft" / "Noch da" Toggle
    const toggleBtn = document.getElementById('btnToggleOffer');
    if(toggleBtn){
      if(o.active === false){
        toggleBtn.textContent = 'Wieder verfügbar';
        toggleBtn.style.background = '#4caf50';
        toggleBtn.style.color = '#fff';
      } else {
        toggleBtn.textContent = 'Ausverkauft';
        toggleBtn.style.background = '#E34D4D';
        toggleBtn.style.color = '#fff';
      }
    }

    document.getElementById('pbd').classList.add('active');
    document.getElementById('psheet').classList.add('active');
  }

  function closeProviderSheet(){
    document.getElementById('pbd').classList.remove('active');
    document.getElementById('psheet').classList.remove('active');
  }

  function buildShareText(o){
    const dish = o.dish || o.title || 'Gericht';
    const profile = normalizeProviderProfile(provider.profile || {});
    const providerName = o.providerName || profile.name || 'Anbieter';
    const pickup = o.pickupWindow || profile.mealWindow || '—';
    return `${providerName}\nHeute zu Mittag: ${dish}\n${euro(o.price)}\n${pickup}\nPowered by Mittagio`;
  }

  function setPrintView(html){
    const pv = document.getElementById('printView');
    if(!pv) return;
    pv.innerHTML = html;
  }
  function clearPrintView(){
    const pv = document.getElementById('printView');
    if(!pv) return;
    pv.innerHTML = '';
  }
  window.addEventListener('afterprint', clearPrintView);

  function printHtml(html){
    setPrintView(html);
    window.print();
    setTimeout(clearPrintView, 300);
  }

  function buildOfferPrintHtml(o){
    const data = normalizeOffer(o);
    const profile = normalizeProviderProfile(provider.profile || {});
    const name = data.providerName || profile.name || 'Anbieter';
    const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity}) || buildAddress(profile);
    const badges = [];
    if(data.hasPickupCode) badges.push('Ticket');
    if(data.dineInPossible) badges.push('Vor Ort');
    return `
      <div class="print-card">
        <div style="display:flex;align-items:center;gap:12px;">
          ${profile.logoData ? `<img src="${profile.logoData}" alt="Logo" style="width:56px;height:56px;border-radius:12px;object-fit:cover" />` : ''}
          <div>
            <h1>${esc(name)}</h1>
            <div class="print-muted">${esc(addr || '')}</div>
          </div>
        </div>
        <h2>${esc(data.dish || 'Gericht')}</h2>
        <div class="print-row">
          <div><b>Preis:</b> ${euro(data.price || 0)}</div>
          <div><b>Essenszeit:</b> ${esc(data.pickupWindow || profile.mealWindow || '')}</div>
        </div>
        <div style="margin-top:8px;">
          ${badges.map(b=>`<span class="print-badge">${esc(b)}</span>`).join(' ')}
        </div>
      </div>
    `;
  }

  function buildWeekCardHtml(){
    const profile = normalizeProviderProfile(provider.profile || {});
    const days = [];
    for(let i=0;i<5;i++){
      const d = new Date(); d.setDate(d.getDate()+i);
      days.push(isoDate(d));
    }
    const dayBlocks = days.map(key=>{
      const items = (week[key]||[])
        .filter(x=>x.providerId===providerId() && x.active !== false)
        .map(entry=>{
          const cb = cookbook.find(c=>c.id===entry.cookbookId);
          const name = cb?.dish || entry.dish || 'Gericht';
          const price = cb?.price || 0;
          const windowText = cb?.pickupWindow || profile.mealWindow || '';
          return `
            <div class="print-row">
              <div>
                <div>${esc(name)}</div>
                <div class="print-muted">${esc(windowText)}</div>
              </div>
              <div>${euro(price)}</div>
            </div>
          `;
        });
      const label = key ? fmtDay(new Date(key)) : key;
      return `
        <div class="print-card">
          <h2>${esc(label)}</h2>
          ${items.length ? items.join('') : '<div class="print-muted">Keine Gerichte geplant.</div>'}
        </div>
      `;
    }).join('');

    return `
      <div class="print-card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <div>
            <h1>${esc(profile.name || 'Anbieter')}</h1>
            <div class="print-muted">${esc(buildAddress(profile) || '')}</div>
            <div class="print-muted">Essenszeit: ${esc(profile.mealWindow || '')}</div>
            <div class="print-muted" style="margin-top:6px;"><b>Unsere Gerichte – nächste Tage</b></div>
          </div>
          ${profile.logoData ? `<img src="${profile.logoData}" alt="Logo" style="width:72px;height:72px;border-radius:14px;object-fit:cover" />` : ''}
        </div>
      </div>
      <div class="print-grid">
        ${dayBlocks}
      </div>
      <div class="print-card" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div>
          <div style="font-weight:900">Mittagio</div>
          <div class="print-muted">Dein Mittag. Lokal. Frisch. Digital.</div>
        </div>
        <div style="text-align:center;">
          <div class="pickup-code-display">Abholnummer</div>
          <div class="print-muted">Ein Tap genügt</div>
        </div>
      </div>
    `;
  }

  function printOffer(o){
    if(!o) return;
    printHtml(buildOfferPrintHtml(o));
  }

  function printCookbookEntry(entry){
    if(!entry) return;
    const profile = normalizeProviderProfile(provider.profile || {});
    const offer = normalizeOffer({
      dish: entry.dish,
      category: entry.category,
      price: entry.price,
      pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
      providerName: profile.name || provider.email || 'Anbieter',
      providerStreet: profile.street||'',
      providerZip: profile.zip||'',
      providerCity: profile.city||'',
      providerLogoData: profile.logoData||'',
      hasPickupCode: !!entry.hasPickupCode,
      dineInPossible: !!entry.dineInPossible,
      allergens: entry.allergens||[],
      extras: entry.extras||[],
      reuse: entry.reuse||{enabled:false,deposit:0}
    });
    printHtml(buildOfferPrintHtml(offer));
  }

  function printWeekCard(){
    printHtml(buildWeekCardHtml());
  }

  // Share Payload für Offer Details
  let sharePayload = { subject: '', body: '', url: '' };
  
  function openShareSheet(subject, body, url=location.href, subtitle=''){
    sharePayload = { subject, body, url };
    
    // Dynamischen Untertitel setzen
    const subtitleEl = document.getElementById('shareSheetSubtitle');
    if(subtitleEl){
      subtitleEl.textContent = subtitle || 'Empfiehl dieses Mittagsangebot weiter';
    }
    
    document.getElementById('shareBd').classList.add('active');
    document.getElementById('shareSheet').classList.add('active');
  }

  function closeShareSheet(){
    document.getElementById('shareBd').classList.remove('active');
    document.getElementById('shareSheet').classList.remove('active');
  }
  
  // Create Flow Sheet
  function openCreateFlowSheet(){
    const sheet = document.getElementById('createFlowSheet');
    const hint = document.getElementById('createFlowDateHint');
    if(sheet && hint){
      if(createFlowPreselectedDate){
        const d = new Date(createFlowPreselectedDate);
        const weekday = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'][d.getDay()];
        const dateStr = `${d.getDate()}.${String(d.getMonth()+1).padStart(2,'0')}.`;
        hint.textContent = `Für: ${weekday}, ${dateStr}`;
        hint.style.display = 'block';
      } else {
        hint.style.display = 'none';
      }
      document.getElementById('createFlowBd').classList.add('active');
      sheet.classList.add('active');
    }
  }
  
  function closeCreateFlowSheet(){
    document.getElementById('createFlowBd').classList.remove('active');
    document.getElementById('createFlowSheet').classList.remove('active');
    createFlowPreselectedDate = null;
  }
  
  // Create Flow Handlers - Beide öffnen Master-Flow
  const btnCreateFromCookbook = document.getElementById('btnCreateFromCookbook');
  if(btnCreateFromCookbook){
    btnCreateFromCookbook.onclick = () => {
      closeCreateFlowSheet();
      // Navigate to cookbook - user selects entry there, then "Inserieren" opens Master-Flow
      showProviderCookbook();
    };
  }
  
  const btnCreateNewDish = document.getElementById('btnCreateNewDish');
  if(btnCreateNewDish){
    btnCreateNewDish.onclick = () => {
      closeCreateFlowSheet();
      // Unified Flow: openDishFlow mit Datum
      openDishFlow(createFlowPreselectedDate);
    };
  }
  
  // Offer More Menu
  function openOfferMoreMenu(offerId){
    const offer = offers.find(o => o.id === offerId);
    if(!offer) return;
    
    const actions = [
      {label: 'Bearbeiten', action: () => {
        closeCreateFlowSheet(); // Falls offen
        startListingFlow({editOfferId: offerId});
      }},
      {label: 'Duplizieren', action: () => {
        const newOffer = {...offer, id: cryptoId(), createdAt: Date.now()};
        offers.unshift(newOffer);
        save(LS.offers, offers);
        renderProviderHome();
        renderDiscover();
        showToast('Inserat dupliziert');
      }},
      {label: 'Pausieren', action: () => {
        offer.active = false;
        save(LS.offers, offers);
        renderProviderHome();
        renderDiscover();
        showToast('Inserat pausiert');
      }},
      {label: 'Löschen', action: () => {
        if(confirm('Inserat wirklich löschen?')){
          const idx = offers.findIndex(o => o.id === offerId);
          if(idx >= 0){
            offers.splice(idx, 1);
            save(LS.offers, offers);
            renderProviderHome();
            renderDiscover();
            showToast('Inserat gelöscht');
          }
        }
      }}
    ];
    
    // Simple prompt-based menu (später kann ein Sheet verwendet werden)
    const choice = prompt(`Aktion für "${offer.dish || offer.title}":\n1. Bearbeiten\n2. Duplizieren\n3. Pausieren\n4. Löschen\n\nNummer eingeben:`);
    const idx = parseInt(choice) - 1;
    if(idx >= 0 && idx < actions.length){
      actions[idx].action();
    }
  }
  
  // Toast helper
  function showToast(message){
    // Simple snackbar-style toast
    let toast = document.getElementById('toast');
    if(!toast){
      toast = document.createElement('div');
      toast.id = 'toast';
      toast.style.cssText = 'position:fixed; bottom:90px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.85); color:#fff; padding:12px 20px; border-radius:12px; font-size:14px; z-index:100; opacity:0; transition:opacity .3s; pointer-events:none;';
      document.body.appendChild(toast);
    }
    toast.textContent = message;
    toast.style.opacity = '1';
    setTimeout(() => {
      toast.style.opacity = '0';
    }, 3000);
  }

  async function copyShareLink(){
    const url = sharePayload.url || location.href;
    if(navigator.clipboard && navigator.clipboard.writeText){
      try{ 
        await navigator.clipboard.writeText(url);
        alert('Link kopiert!');
        return true;
      }catch{}
    }
    prompt('Link kopieren:', url);
    return false;
  }
  
  function shareViaWhatsApp(subject, body, url){
    const text = `${subject}\n\n${body}\n\n👉 Jetzt anschauen:\n${url}`;
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
    window.open(whatsappUrl, '_blank');
  }
  
  function shareViaInstagram(subject, body, url){
    // Instagram unterstützt keine direkten Share-Links, daher Link kopieren + Hinweis
    const text = `${subject}\n\n${body}\n\n👉 Jetzt anschauen:\n${url}`;
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).then(() => {
        showToast('Text kopiert! Füge ihn in deinen Instagram-Post ein.');
      }).catch(() => {
        prompt('Text für Instagram kopieren:', text);
      });
    } else {
      prompt('Text für Instagram kopieren:', text);
    }
  }

  function shareOffer(o, useWebShare = true){
    if(!o) return;
    const data = normalizeOffer(o);
    const url = `${location.origin}${location.pathname}#offer/${o.id}`;
    
    // Schöner Share-Text: "Schau mal, was es heute bei [Metzger] gibt! [Link]"
    const providerName = data.providerName || 'Anbieter';
    const dishName = data.dish || 'Gericht';
    const shareText = `Schau mal, was es heute bei ${providerName} gibt! ${dishName} für ${euro(data.price)}. ${url}`;
    
    // Web Share API (wenn verfügbar)
    if(navigator.share){
      navigator.share({
        title: `${dishName} bei ${providerName}`,
        text: shareText,
        url: url
      }).then(() => {
        showToast('Geteilt!');
      }).catch((err) => {
        // Fallback: Link kopieren
        if(err.name !== 'AbortError'){
          copyToClipboard(shareText);
          showToast('Link kopiert!');
        }
      });
      return;
    }
    
    // Fallback: Link kopieren + Toast
    copyToClipboard(shareText);
    showToast('Link kopiert!');
  }
  
  // Helper: Link in Zwischenablage kopieren
  function copyToClipboard(text){
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).catch(() => {
        // Fallback für ältere Browser
        fallbackCopyToClipboard(text);
      });
    } else {
      fallbackCopyToClipboard(text);
    }
  }
  
  function fallbackCopyToClipboard(text){
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
      document.execCommand('copy');
    } catch(err) {
      console.error('Fallback copy failed:', err);
    }
    document.body.removeChild(textArea);
  }
  
  // Web Share API für Kunden (Bestätigungsseite)
  function shareOrderConfirmation(order){
    if(!order) return;
    const dishName = order.dishName || 'Gericht';
    const providerName = order.providerName || 'Anbieter';
    
    if(navigator.share){
      navigator.share({
        title: 'Mein Mittagessen heute!',
        text: `Schlange stehen gespart! Hab mir gerade ${dishName} bei ${providerName} gesichert. 🍖📱 #mittagio`,
        url: location.href
      }).then(() => {
        showToast('Geteilt!');
      }).catch((err) => {
        console.log('Share failed:', err);
      });
    } else {
      // Fallback: Link kopieren
      const text = `Schlange stehen gespart! Hab mir gerade ${dishName} bei ${providerName} gesichert. 🍖📱 #mittagio ${location.href}`;
      navigator.clipboard.writeText(text).then(() => {
        showToast('Link kopiert!');
      });
    }
  }
  
  // Web Share API für Anbieter (Heute teilen)
  function shareProviderOffer(offer){
    if(!offer) return;
    const data = normalizeOffer(offer);
    const dishName = data.dish || 'Gericht';
    const price = euro(data.price || 0);
    
    if(navigator.share){
      navigator.share({
        title: `${dishName} - ${price}`,
        text: `Heute bei mir: ${dishName} für ${price}. Nur online vorbestellbar auf Mittagio.de`,
        url: `${location.origin}${location.pathname}#offer/${offer.id}`
      }).then(() => {
        showToast('Geteilt!');
      }).catch((err) => {
        console.log('Share failed:', err);
      });
    } else {
      // Fallback: Share Sheet
      shareOffer(offer);
    }
  }

  function addToCart(o){
    if(!o || !o.hasPickupCode){
      alert('Ohne Abholcode nur ansehen.');
      return false;
    }
    // Multi-Vendor erlaubt (keine Warnung mehr, nur Info im Korb)
    if(!cart){ cart = { providerId:o.providerId, providerName:o.providerName, items:[], pickupTime:'' }; }
    const idx = cart.items.findIndex(i=>i.offerId===o.id);
    if(idx>=0) cart.items[idx].qty += 1; else cart.items.push({offerId:o.id, qty:1});
    save(LS.cart, cart);
    updateHeaderBasket();
    return true;
  }

  function handleOrderClick(o){
    // KEIN Login-Zwang: Gast kann direkt bestellen
    if(addToCart(o)){
      showCart();
    } else {
      openOffer(o.id);
    }
  }

  const btnFav = document.getElementById('btnFav');
  if(btnFav) btnFav.onclick=()=>{
    if(!activeOfferId) return;
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    toggleProviderFav(o.providerId);
  };
  const btnDishFav = document.getElementById('btnDishFav');
  if(btnDishFav) btnDishFav.onclick=()=>{
    if(!activeOfferId) return;
    toggleDishFav(activeOfferId);
  };
  // Share Button im Header (Offer Detail Page)
  const btnShareHeader = document.getElementById('btnShareHeader');
  if(btnShareHeader) btnShareHeader.onclick=()=>{
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    shareOffer(o);
  };
  
  // Share Button im Body (legacy, kann entfernt werden)
  const btnShare = document.getElementById('btnShare');
  if(btnShare) btnShare.onclick=()=>{
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    shareOffer(o);
  };
  
  // Share Sheet Actions
  const btnShareWhatsApp = document.getElementById('btnShareWhatsApp');
  if(btnShareWhatsApp) btnShareWhatsApp.onclick=()=>{
    shareViaWhatsApp(sharePayload.subject, sharePayload.body, sharePayload.url);
    closeShareSheet();
  };
  
  const btnShareInstagram = document.getElementById('btnShareInstagram');
  if(btnShareInstagram) btnShareInstagram.onclick=()=>{
    shareViaInstagram(sharePayload.subject, sharePayload.body, sharePayload.url);
    closeShareSheet();
  };
  
  const btnShareCopy = document.getElementById('btnShareCopy');
  if(btnShareCopy) btnShareCopy.onclick=()=>{
    copyShareLink();
    closeShareSheet();
  };
  
  const btnCodeClose = document.getElementById('btnCodeClose');
  if(btnCodeClose) btnCodeClose.onclick=()=> closeCodeSheet();
  const btnToggleOrderStatus = document.getElementById('btnToggleOrderStatus');
  if(btnToggleOrderStatus) btnToggleOrderStatus.onclick=()=>{
    if(!activeOrderId) return;
    const idx = orders.findIndex(o=>o.id===activeOrderId);
    if(idx<0) return;
    orders[idx].status = orders[idx].status === 'abgeholt' ? 'offen' : 'abgeholt';
    save(LS.orders, orders);
    renderOrders();
    openCodeSheet(activeOrderId);
  };
  
  // --- Login Modal ---
  function openLoginSheet(){
    document.getElementById('loginBd').classList.add('active');
    document.getElementById('loginSheet').classList.add('active');
    // Focus auf E-Mail-Input
    setTimeout(()=>{
      const emailInput = document.getElementById('loginModalEmail');
      if(emailInput) emailInput.focus();
    }, 300);
  }
  
  function closeLoginSheet(){
    document.getElementById('loginBd').classList.remove('active');
    document.getElementById('loginSheet').classList.remove('active');
  }
  
  // Login Modal Backdrop Handler
  const loginBd = document.getElementById('loginBd');
  if(loginBd){
    loginBd.onclick = () => {
      closeLoginSheet();
    };
  }
  
  // Login Modal Handler
  const btnLoginModalLogin = document.getElementById('btnLoginModalLogin');
  if(btnLoginModalLogin){
    btnLoginModalLogin.onclick=()=>{
      const email = document.getElementById('loginModalEmail').value.trim();
      const pass = document.getElementById('loginModalPass').value.trim();
      if(!email || !pass){
        alert('Bitte E-Mail und Passwort eingeben.');
        return;
      }
      customer.loggedIn = true;
      customer.name = customer.name || email.split('@')[0];
      customer.email = email;
      save(LS.customer, customer);
      updateProfileView();
      closeLoginSheet();
      // Nach Login zur Discover-Seite
      setMode('customer');
      showDiscover();
    };
  }
  
  const btnLoginModalDemo = document.getElementById('btnLoginModalDemo');
  if(btnLoginModalDemo){
    btnLoginModalDemo.onclick=()=>{
      customer.loggedIn = true;
      customer.name = customer.name || 'Mike';
      save(LS.customer, customer);
      updateProfileView();
      closeLoginSheet();
      // Nach Demo-Login zur Discover-Seite
      setMode('customer');
      showDiscover();
    };
  }

  applyStaticIcons();
  const locBtn = document.getElementById('btnLocationPin');
  if(locBtn){
    locBtn.innerHTML = iconMarkup('location');
    locBtn.onclick=()=>{
      alert('Standort gesetzt. Du kannst jederzeit wechseln.');
    };
  }
  const startLocBtn = document.getElementById('btnStartLocationPin');
  if(startLocBtn){
    startLocBtn.innerHTML = iconMarkup('location');
    startLocBtn.onclick=()=>{
      alert('Standort gesetzt. Du kannst jederzeit wechseln.');
    };
  }
  const startNearBtn = document.getElementById('btnStartNear');
  if(startNearBtn){
    startNearBtn.onclick=()=>{
      alert('Zeige Angebote in deiner Nähe.');
      renderStart();
    };
  }
  
  // Discover Standort-Button
  const discoverLocationBtn = document.getElementById('btnDiscoverLocation');
  if(discoverLocationBtn){
    discoverLocationBtn.onclick=()=>{
      const newLoc = prompt('Standort eingeben (Ort oder PLZ):', locationQuery || '');
      if(newLoc !== null){
        locationQuery = newLoc.trim();
        renderDiscover();
      }
    };
  }

  const btnAddCart = document.getElementById('btnAddCart');
  if(btnAddCart){
    btnAddCart.onclick=()=>{
      const o = offers.find(x=>x.id===activeOfferId);
      if(!o) return;
      if(!addToCart(o)) return;
      closeSheet();
      showCart();
    };
  }

  // Header-Basket aktualisieren (Badge mit Anzahl)
  function updateHeaderBasket(){
    const bottomNavBasketBadge = document.getElementById('bottomNavBasketBadge');
    if(!bottomNavBasketBadge) return;
    
    const cart = load(LS.cart, []);
    const itemCount = cart && cart.items ? cart.items.reduce((sum, it) => sum + it.qty, 0) : cart.length;
    
    if(itemCount > 0){
      bottomNavBasketBadge.textContent = itemCount > 99 ? '99+' : itemCount;
      bottomNavBasketBadge.style.display = 'flex';
    } else {
      bottomNavBasketBadge.style.display = 'none';
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }
  
  // --- Cart ---
  function renderCart(){
    const box=document.getElementById('cartBox');
    const btn=document.getElementById('btnCheckout');
    const note=document.getElementById('cartNote');

    if(!cart || !cart.items.length){
      // Empty State: Picknick-Motiv
      box.innerHTML = `
        <div style="text-align:center; padding:60px 20px;">
          <div style="width:140px; height:140px; margin:0 auto 24px; background:linear-gradient(135deg, rgba(255,215,0,0.1) 0%, rgba(255,184,0,0.15) 100%); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:80px;">
            🧺
          </div>
          <h3 style="font-size:22px; font-weight:900; margin-bottom:12px; color:#111; font-family:'Inter', 'Montserrat', sans-serif;">Dein Korb ist noch leer – Zeit für ein Match!</h3>
          <p style="font-size:15px; color:#666; margin-bottom:32px; line-height:1.6; max-width:320px; margin-left:auto; margin-right:auto;">Swipe dich durch leckere Gerichte und fülle deine Mittagsbox.</p>
          <button class="btn-primary" type="button" onclick="showDiscover();" style="width:100%; max-width:280px; margin:0 auto; min-height:52px; font-size:16px; font-weight:700;">
            <i data-lucide="compass" style="width:20px;height:20px;"></i> <span>Jetzt Essen swipen</span>
          </button>
        </div>
      `;
      btn.style.display='none';
      note.style.display='none';
      if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
      updateHeaderBasket();
      return;
    }

    let total=0;
    let canCheckout = true;
    const firstOffer = cart.items.length ? offers.find(x=>x.id===cart.items[0].offerId) : null;
    const firstOfferNormalized = firstOffer ? normalizeOffer(firstOffer) : null;
    const windowText = firstOfferNormalized && firstOfferNormalized.pickupWindow ? firstOfferNormalized.pickupWindow : '';
    const lines = cart.items.map(it=>{
      const o = offers.find(x=>x.id===it.offerId);
      if(!o) return '';
      const normalized = normalizeOffer(o);
      if(!normalized.hasPickupCode) canCheckout = false;
      const lineTotal = Number(normalized.price||0) * it.qty;
      total += lineTotal;
      return `
        <div class="cart-line">
          <div class="cart-left">${esc(normalized.dish || normalized.title || 'Gericht')}</div>
          <div class="cart-qty">
            <button class="qty-btn" type="button" data-action="dec" data-id="${esc(o.id)}">-</button>
            <div>${it.qty}</div>
            <button class="qty-btn" type="button" data-action="inc" data-id="${esc(o.id)}">+</button>
          </div>
          <div class="cart-price">${euro(lineTotal)}</div>
        </div>
      `;
    }).filter(Boolean);

    // Standard-Zeit-Slots im 15-Minuten-Takt (11:30, 12:00, 12:15, etc.)
    const TIME_SLOTS = ['11:30', '11:45', '12:00', '12:15', '12:30', '12:45', '13:00', '13:15', '13:30', '13:45', '14:00'];
    
    // Filtere Zeiten basierend auf aktueller Uhrzeit (mindestens 15 Min in Zukunft)
    const now = new Date();
    const currentMinutes = now.getHours() * 60 + now.getMinutes();
    const availableSlots = TIME_SLOTS.filter(slot => {
      const [h, m] = slot.split(':').map(Number);
      const slotMinutes = h * 60 + m;
      return slotMinutes >= currentMinutes + 15; // Mindestens 15 Min Vorlauf
    });
    
    // Wenn keine Slots verfügbar, zeige alle (für spätere Zeiten)
    const slotsToShow = availableSlots.length > 0 ? availableSlots : TIME_SLOTS.slice(0, 6);
    
    // Speichere TIME_SLOTS global für Checkout
    window.TIME_SLOTS = TIME_SLOTS;
    window.currentMinutes = currentMinutes;
    
    // Generiere Time-Chips
    const timeChips = slotsToShow.map(t => 
      `<button class="cart-time-chip ${cart.pickupTime === t ? 'selected' : ''}" type="button" data-time="${t}" style="padding:10px 16px; border-radius:12px; border:2px solid ${cart.pickupTime === t ? '#FFD700' : '#e7e1d5'}; background:${cart.pickupTime === t ? '#FFD700' : '#fff'}; color:${cart.pickupTime === t ? '#2D3436' : '#666'}; font-weight:${cart.pickupTime === t ? '900' : '600'}; font-size:14px; cursor:pointer; transition:all 0.2s ease;">${t} Uhr</button>`
    ).join('');
    
    // Multi-Vendor-Check: Prüfe ob verschiedene Anbieter im Korb sind
    const uniqueProviders = new Set();
    cart.items.forEach(it => {
      const o = offers.find(x => x.id === it.offerId);
      if(o) uniqueProviders.add(o.providerId);
    });
    const hasMultipleProviders = uniqueProviders.size > 1;
    const multiVendorWarning = hasMultipleProviders ? `
      <div style="margin-bottom:16px; padding:12px 16px; background:rgba(255,215,0,0.15); border-left:4px solid #FFD700; border-radius:8px;">
        <div style="font-weight:700; font-size:14px; color:#2D3436; margin-bottom:4px; display:flex; align-items:center; gap:6px;">
          <i data-lucide="alert-triangle" style="width:16px;height:16px; color:#FFD700;"></i>
          Abholung an verschiedenen Standorten
        </div>
        <div style="font-size:13px; color:#666; line-height:1.5;">Du hast Essen von ${uniqueProviders.size} verschiedenen Anbietern. Plane genug Zeit für die Abholung ein!</div>
      </div>
    ` : '';
    
    // Gruppiere Items nach Anbieter
    const itemsByProvider = new Map();
    cart.items.forEach(it => {
      const o = offers.find(x => x.id === it.offerId);
      if(!o) return;
      const providerId = o.providerId;
      if(!itemsByProvider.has(providerId)){
        itemsByProvider.set(providerId, {
          provider: normalizeOffer(o),
          items: []
        });
      }
      itemsByProvider.get(providerId).items.push({offer: o, qty: it.qty});
    });
    
    // Rendere Items gruppiert nach Anbieter
    let groupedLines = '';
    itemsByProvider.forEach((group, providerId) => {
      const provider = group.provider;
      const providerLines = group.items.map(({offer, qty}) => {
        const normalized = normalizeOffer(offer);
        const lineTotal = Number(normalized.price||0) * qty;
        return `
          <div class="cart-line" style="padding-left:${hasMultipleProviders ? '20px' : '0'};">
            <div class="cart-left">${esc(normalized.dish || normalized.title || 'Gericht')}</div>
            <div class="cart-qty">
              <button class="qty-btn" type="button" data-action="dec" data-id="${esc(offer.id)}">-</button>
              <div>${qty}</div>
              <button class="qty-btn" type="button" data-action="inc" data-id="${esc(offer.id)}">+</button>
            </div>
            <div class="cart-price">${euro(lineTotal)}</div>
          </div>
        `;
      }).join('');
      
      groupedLines += `
        <div style="margin-bottom:${hasMultipleProviders ? '20px' : '0'};">
          <div style="font-size:16px; font-weight:900; margin-bottom:12px; display:flex; align-items:center; gap:8px; cursor:pointer;" onclick="openProviderQuickView('${esc(providerId)}');">
            <i data-lucide="store" style="width:18px;height:18px; color:#666;"></i>
            <span>${esc(provider.providerName || 'Anbieter')}</span>
            <i data-lucide="chevron-right" style="width:16px;height:16px; color:#999; margin-left:auto;"></i>
          </div>
          ${providerLines}
        </div>
      `;
    });
    
    box.innerHTML = `
      ${multiVendorWarning}
      ${groupedLines}
      ${windowText ? `
        <div class="cart-window-badge" style="margin-top:16px;">
          <i data-lucide="clock"></i>
          <span>Essenszeit: ${esc(windowText)}</span>
        </div>
      ` : ''}
      <div class="row" style="margin-top:20px;"><span style="font-weight:700; font-size:15px;">Wann holst du dein Essen ab?</span></div>
      <div class="cart-time-chips" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-top:12px; margin-bottom:12px;">
        ${timeChips}
      </div>
      ${hasMultipleProviders ? `<div class="hint" style="margin-top:8px; font-size:12px; color:#666;">Diese Zeit gilt für alle gewählten Standorte.</div>` : ''}
      ${hasMultipleProviders ? `
        <div style="margin-top:16px; padding:12px 16px; background:rgba(31,157,85,0.1); border-left:4px solid #1f9d55; border-radius:8px;">
          <div style="font-weight:700; font-size:13px; color:#1f9d55; margin-bottom:6px; display:flex; align-items:center; gap:6px;">
            <i data-lucide="navigation" style="width:16px;height:16px;"></i>
            Optimale Abhol-Route verfügbar
          </div>
          <button type="button" onclick="openGoogleMapsRoute();" style="margin-top:8px; padding:8px 16px; background:#1f9d55; color:#fff; border:none; border-radius:8px; font-weight:700; font-size:13px; cursor:pointer; transition:transform 0.2s ease;" onmouseover="this.style.transform='scale(1.02)';" onmouseout="this.style.transform='scale(1)';">
            Route starten
          </button>
        </div>
      ` : ''}
      <div class="row" style="margin-top:24px; padding-top:20px; border-top:2px solid #eee; position:relative;"><span style="font-size:18px; font-weight:900;">Gesamt</span><b style="font-size:20px; color:var(--brand);">${euro(total)}</b>
        <!-- Mülleimer-Icon oben rechts (dezentes Design) -->
        <button type="button" id="clearCartIcon" class="cart-clear-icon" style="position:absolute; top:20px; right:0; width:36px; height:36px; border-radius:50%; border:none; background:rgba(0,0,0,0.05); display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.2s ease; color:#666;" onmouseover="this.style.background='rgba(227,77,77,0.1)'; this.style.color='#e74c3c';" onmouseout="this.style.background='rgba(0,0,0,0.05)'; this.style.color='#666';" title="Mittagsbox leeren">
          <i data-lucide="trash-2" style="width:18px;height:18px;"></i>
        </button>
      </div>
    `;

    // Warenkorb leeren mit Sicherheitsabfrage (Bottom-Sheet)
    const clearCartBtn = document.getElementById('clearCartIcon');
    if(clearCartBtn){
      clearCartBtn.onclick=(e)=>{
        e.preventDefault();
        e.stopPropagation();
        // Bottom-Sheet für Bestätigung öffnen
        const confirmSheet = document.createElement('div');
        confirmSheet.style.cssText = 'position:fixed; bottom:0; left:0; right:0; background:#fff; border-radius:24px 24px 0 0; padding:24px; box-shadow:0 -4px 20px rgba(0,0,0,0.15); z-index:1000; max-width:480px; margin:0 auto;';
        confirmSheet.innerHTML = `
          <div style="text-align:center; margin-bottom:20px;">
            <div style="width:64px; height:64px; margin:0 auto 16px; background:rgba(227,77,77,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center;">
              <i data-lucide="trash-2" style="width:32px;height:32px; color:#e74c3c;"></i>
            </div>
            <h3 style="font-size:20px; font-weight:900; margin:0 0 8px; color:#2D3436;">Mittagsbox wirklich leeren?</h3>
            <p style="font-size:14px; color:#666; margin:0; line-height:1.5;">Alle Gerichte werden entfernt.</p>
          </div>
          <div style="display:flex; gap:12px;">
            <button type="button" id="confirmClearCart" style="flex:1; min-height:52px; background:#e74c3c; color:#fff; border:none; border-radius:16px; font-weight:700; font-size:16px; cursor:pointer;">Ja, leeren</button>
            <button type="button" id="cancelClearCart" style="flex:1; min-height:52px; background:#f0f0f0; color:#666; border:none; border-radius:16px; font-weight:700; font-size:16px; cursor:pointer;">Abbrechen</button>
          </div>
        `;
        document.body.appendChild(confirmSheet);
        if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
        
        // Backdrop
        const backdrop = document.createElement('div');
        backdrop.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:999;';
        document.body.appendChild(backdrop);
        
        const closeSheet = () => {
          document.body.removeChild(confirmSheet);
          document.body.removeChild(backdrop);
        };
        
        document.getElementById('confirmClearCart').onclick = () => {
          cart = null;
          save(LS.cart, cart);
          renderCart();
          updateHeaderBasket();
          closeSheet();
          showToast('Mittagsbox geleert', 2000);
        };
        
        document.getElementById('cancelClearCart').onclick = closeSheet;
        backdrop.onclick = closeSheet;
      };
    }
    
    // Quick-Time-Chips Handler
    box.querySelectorAll('.cart-time-chip').forEach(chip=>{
      chip.onclick=()=>{
        const time = chip.getAttribute('data-time');
        cart.pickupTime = time;
        save(LS.cart, cart);
        renderCart();
      };
    });
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);

    box.querySelectorAll('.qty-btn').forEach(btnEl=>{
      btnEl.onclick=()=>{
        const id = btnEl.getAttribute('data-id');
        const action = btnEl.getAttribute('data-action');
        const idx = cart.items.findIndex(i=>i.offerId===id);
        if(idx<0) return;
        if(action==='inc') cart.items[idx].qty += 1;
        if(action==='dec') cart.items[idx].qty -= 1;
        if(cart.items[idx].qty <= 0) cart.items.splice(idx,1);
        save(LS.cart, cart);
        renderCart();
      };
    });

    btn.style.display='block';
    btn.disabled = !canCheckout;
    
    // Trust-Icons anzeigen
    const trustIcons = document.getElementById('cartTrustIcons');
    if(trustIcons){
      trustIcons.style.display = canCheckout ? 'flex' : 'none';
      if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
    }
    
    // Note anzeigen
    if(note){
      note.style.display = canCheckout ? 'block' : 'none';
    }
    // CTA-Text: Zahlung ist Pflicht (Stripe Checkout, Gastzahlung)
    if(canCheckout){
      // Alle Items haben hasPickupCode = true → Stripe Checkout (Gastzahlung, Zahlung Pflicht)
      btn.innerHTML = `${iconMarkup('card')}<span>Weiter zur Zahlung</span>`;
    } else {
      // Kein Payment möglich → Button deaktiviert
      btn.innerHTML = `${iconMarkup('alert-circle')}<span>Zahlung nicht möglich</span>`;
    }
    
    // Header-Basket aktualisieren
    updateHeaderBasket();
    note.style.display='block';
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }

  const btnCheckout = document.getElementById('btnCheckout');
  // --- Checkout Navigation ---
  function showCheckout(){
    if(!cart || !cart.items || !cart.items.length){
      showCart();
      return;
    }
    
    // Prüfe ob Payment möglich ist
    const hasPayment = cart.items.every(it=>{
      const o = offers.find(x=>x.id===it.offerId);
      return o && normalizeOffer(o).hasPickupCode;
    });
    
    if(!hasPayment){
      alert('Diese Bestellung enthält Gerichte ohne Abholcode. Bitte wähle Angebote mit Abholcode aus.');
      return;
    }
    
    // Gesamtpreis berechnen
    let total = 0;
    cart.items.forEach(it=>{
      const o = offers.find(x=>x.id===it.offerId);
      if(o){
        const normalized = normalizeOffer(o);
        total += Number(normalized.price||0) * it.qty;
      }
    });
    
    if(total <= 0){
      alert('Bitte wähle mindestens ein Gericht aus.');
      return;
    }
    
    // Checkout-View rendern
    renderCheckout(total);
    
    // View anzeigen
    showView(views.checkout);
    setCustomerNavActive('cart'); // Cart bleibt aktiv
    
    // History für Back-Button
    if(!isNavigatingBack){
      navigationHistory.push({
        view: 'cart',
        locationQuery: locationQuery || '',
        activeCat: activeCat || null,
        activeDay: activeDay || isoDate(new Date()),
        activeFilter: activeDiscoverFilter || 'near',
        scrollY: window.scrollY
      });
      history.pushState({view: 'checkout'}, '', '#checkout');
    }
  }
  
  function renderCheckout(total){
    // Zeitauswahl im 15-Minuten-Takt rendern
    const TIME_SLOTS = window.TIME_SLOTS || ['11:30', '11:45', '12:00', '12:15', '12:30', '12:45', '13:00', '13:15', '13:30', '13:45', '14:00'];
    const currentMinutes = window.currentMinutes || (new Date().getHours() * 60 + new Date().getMinutes());
    let selectedTime = cart && cart.pickupTime ? cart.pickupTime : '';
    
    // Auto-Auswahl: Nächster verfügbarer Slot (wenn noch keine Zeit gewählt)
    if(!selectedTime){
      const availableSlots = TIME_SLOTS.filter(t => {
        const [h, m] = t.split(':').map(Number);
        return (h * 60 + m) >= currentMinutes + 15;
      });
      if(availableSlots.length > 0){
        selectedTime = availableSlots[0];
        if(!cart) cart = {items: []};
        cart.pickupTime = selectedTime;
        save(LS.cart, cart);
      }
    }
    
    const checkoutTimeSlots = document.getElementById('checkoutTimeSlots');
    if(checkoutTimeSlots){
      checkoutTimeSlots.innerHTML = TIME_SLOTS.map(t => {
        const [h, m] = t.split(':').map(Number);
        const slotMinutes = h * 60 + m;
        const isAvailable = slotMinutes >= currentMinutes + 15;
        const isSelected = selectedTime === t;
        return `<button type="button" class="time-slot-btn ${isSelected ? 'selected' : ''} ${!isAvailable ? 'disabled' : ''}" data-time="${t}" style="padding:12px; border-radius:12px; border:2px solid ${isSelected ? '#FFD700' : '#e7e1d5'}; background:${isSelected ? '#FFD700' : '#fff'}; color:${isSelected ? '#2D3436' : isAvailable ? '#666' : '#ccc'}; font-weight:${isSelected ? '900' : '600'}; font-size:14px; cursor:${isAvailable ? 'pointer' : 'not-allowed'}; transition:all 0.2s ease; opacity:${isAvailable ? '1' : '0.5'};">
          ${t}
        </button>`;
      }).join('');
      
      // Handler für Time-Slots
      checkoutTimeSlots.querySelectorAll('.time-slot-btn:not(.disabled)').forEach(btn => {
        btn.onclick = () => {
          const time = btn.getAttribute('data-time');
          if(!cart) cart = {items: []};
          cart.pickupTime = time;
          save(LS.cart, cart);
          
          // Custom Input ausblenden
          const customInputWrapper = document.getElementById('customTimeInputWrapper');
          if(customInputWrapper) customInputWrapper.style.display = 'none';
          const customInput = document.getElementById('checkoutPickupTimeCustom');
          if(customInput) customInput.value = '';
          
          // UI aktualisieren
          checkoutTimeSlots.querySelectorAll('.time-slot-btn').forEach(b => {
            const isSelected = b.getAttribute('data-time') === time;
            b.classList.toggle('selected', isSelected);
            b.style.borderColor = isSelected ? '#FFD700' : '#e7e1d5';
            b.style.background = isSelected ? '#FFD700' : '#fff';
            b.style.color = isSelected ? '#2D3436' : '#666';
            b.style.fontWeight = isSelected ? '900' : '600';
          });
          
          const hiddenInput = document.getElementById('checkoutPickupTime');
          if(hiddenInput) hiddenInput.value = time;
        };
      });
    }
    
    // "Andere Uhrzeit wählen" Button Handler
    const btnOtherTime = document.getElementById('btnOtherTime');
    const customTimeInputWrapper = document.getElementById('customTimeInputWrapper');
    const customTimeInput = document.getElementById('checkoutPickupTimeCustom');
    if(btnOtherTime && customTimeInputWrapper && customTimeInput){
      btnOtherTime.onclick = () => {
        const isVisible = customTimeInputWrapper.style.display !== 'none';
        customTimeInputWrapper.style.display = isVisible ? 'none' : 'block';
        if(!isVisible){
          customTimeInput.focus();
          // Alle Slots deselektieren
          if(checkoutTimeSlots){
            checkoutTimeSlots.querySelectorAll('.time-slot-btn').forEach(b => {
              b.classList.remove('selected');
              b.style.borderColor = '#e7e1d5';
              b.style.background = '#fff';
              b.style.color = '#666';
              b.style.fontWeight = '600';
            });
          }
          // Wenn bereits eine Custom-Zeit gesetzt ist, diese anzeigen
          if(cart && cart.pickupTime && !TIME_SLOTS.includes(cart.pickupTime)){
            // Format für time-Input: HH:MM
            const timeParts = cart.pickupTime.replace(' Uhr', '').split(':');
            if(timeParts.length === 2){
              customTimeInput.value = `${timeParts[0].padStart(2, '0')}:${timeParts[1].padStart(2, '0')}`;
            }
          }
        }
      };
      
      customTimeInput.onchange = () => {
        const customTime = customTimeInput.value;
        if(customTime){
          // Validierung: Zwischen 11:30 und 14:00
          const [h, m] = customTime.split(':').map(Number);
          const timeMinutes = h * 60 + m;
          const minMinutes = 11 * 60 + 30; // 11:30
          const maxMinutes = 14 * 60; // 14:00
          
          if(timeMinutes >= minMinutes && timeMinutes <= maxMinutes){
            // Format: "HH:MM Uhr"
            const formattedTime = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')} Uhr`;
            if(!cart) cart = {items: []};
            cart.pickupTime = formattedTime;
            save(LS.cart, cart);
            const hiddenInput = document.getElementById('checkoutPickupTime');
            if(hiddenInput) hiddenInput.value = formattedTime;
            showToast('Zeit gespeichert ✓', 1500);
          } else {
            showToast('Bitte wähle eine Zeit zwischen 11:30 und 14:00 Uhr', 3000);
            customTimeInput.value = '';
          }
        }
      };
    }
    
    // Hidden Input setzen
    const hiddenInput = document.getElementById('checkoutPickupTime');
    if(hiddenInput && selectedTime) hiddenInput.value = selectedTime;
    const summaryEl = document.getElementById('checkoutSummary');
    if(!summaryEl) return;
    
    // Bestellübersicht rendern
    let summaryHTML = '<div style="font-weight:700; font-size:16px; margin-bottom:16px; color:#2D3436;">Bestellübersicht</div>';
    cart.items.forEach(it=>{
      const o = offers.find(x=>x.id===it.offerId);
      if(o){
        const normalized = normalizeOffer(o);
        const lineTotal = Number(normalized.price||0) * it.qty;
        summaryHTML += `
          <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid rgba(0,0,0,.08);">
            <div>
              <div style="font-weight:600; font-size:15px; color:#2D3436;">${esc(normalized.dish||'Gericht')} × ${it.qty}</div>
              <div style="font-size:13px; color:#666; margin-top:4px;">${esc(normalized.providerName||'Anbieter')}</div>
            </div>
            <div style="font-weight:700; font-size:16px; color:#2D3436;">${euro(lineTotal)}</div>
          </div>
        `;
      }
    });
    summaryHTML += `
      <div style="display:flex; justify-content:space-between; align-items:center; padding-top:16px; margin-top:16px; border-top:2px solid #2D3436;">
        <div style="font-weight:900; font-size:18px; color:#2D3436;">Gesamt</div>
        <div style="font-weight:900; font-size:24px; color:#FFB800;">${euro(total)}</div>
      </div>
    `;
    summaryEl.innerHTML = summaryHTML;
    
    // Apple Pay / Google Pay Buttons prüfen (wenn verfügbar)
    const btnApplePay = document.getElementById('btnApplePay');
    const btnGooglePay = document.getElementById('btnGooglePay');
    if(btnApplePay){
      // Prüfe ob Apple Pay verfügbar ist (in Production: window.ApplePaySession?.canMakePayments())
      btnApplePay.style.display = 'none'; // MVP: Ausgeblendet, in Production aktivieren
    }
    if(btnGooglePay){
      // Prüfe ob Google Pay verfügbar ist
      btnGooglePay.style.display = 'none'; // MVP: Ausgeblendet, in Production aktivieren
    }
    
    // Standard Payment Button Handler
    const btnStandardPayment = document.getElementById('btnStandardPayment');
    if(btnStandardPayment){
      btnStandardPayment.onclick = () => {
        processCheckoutPayment(total);
      };
    }
    
    // Back Button
    const btnCheckoutBack = document.getElementById('btnCheckoutBack');
    if(btnCheckoutBack){
      btnCheckoutBack.onclick = () => {
        showCart();
      };
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(() => lucide.createIcons(), 50);
    }
  }
  
  function processCheckoutPayment(total){
    // Name validieren
    const nameInput = document.getElementById('checkoutName');
    const name = nameInput ? nameInput.value.trim() : '';
    if(!name){
      alert('Bitte gib deinen Namen für die Abholung ein.');
      if(nameInput) nameInput.focus();
      return;
    }
    
    // Abholzeit auslesen
    const pickupTimeSelect = document.getElementById('checkoutPickupTime');
    const pickupTime = pickupTimeSelect ? pickupTimeSelect.value : 'asap';
    const pickupTimeText = pickupTime === 'asap' ? 'So schnell wie möglich' : `${pickupTime} Uhr`;
    
    // E-Mail (optional)
    const emailInput = document.getElementById('checkoutEmail');
    const email = emailInput ? emailInput.value.trim() : '';
    
    // Cart mit neuen Daten aktualisieren
    cart.pickupTime = pickupTimeText;
    cart.customerName = name;
    cart.customerEmail = email;
    save(LS.cart, cart);
    
    // Order mit Status CREATED erstellen
    const orderCreated = createOrderFromCart(cart, 'CREATED');
    if(!orderCreated){
      alert('Fehler beim Erstellen der Bestellung.');
      return;
    }
    
    // Order wird auf PAYMENT_PENDING gesetzt
    updateOrder(orderCreated.id, { status: 'PAYMENT_PENDING' });
    
    // Stripe Checkout starten
    startStripeCheckout(total, cart, orderCreated.id);
  }
  
  if(btnCheckout){
    btnCheckout.onclick=()=>{
      showCheckout();
    };
  }
  
  /**
   * Create order from cart
   * @param {Object} cartData
   * @param {'CREATED'|'PAYMENT_PENDING'} initialStatus
   * @returns {Order|null}
   */
  function createOrderFromCart(cartData, initialStatus){
    if(!cartData || !cartData.items || !cartData.items.length) return null;
    
    const firstOffer = cartData.items.length ? offers.find(x=>x.id===cartData.items[0].offerId) : null;
    const firstOfferNormalized = firstOffer ? normalizeOffer(firstOffer) : null;
    
    // Gesamtpreis berechnen (in Cents)
    let totalCents = 0;
    const items = cartData.items.map(it=>{
      const o = offers.find(x=>x.id===it.offerId);
      if(!o) return null;
      const normalized = normalizeOffer(o);
      const unitPriceCents = Math.round(Number(normalized.price||0) * 100);
      const lineTotalCents = unitPriceCents * it.qty;
      totalCents += lineTotalCents;
      return {
        dishId: o.id,
        dishName: normalized.dish || normalized.title || 'Gericht',
        quantity: it.qty,
        unitPriceCents: unitPriceCents
      };
    }).filter(Boolean);
    
    const now = Date.now();
    /** @type {Order} */
    const order = {
      id: cryptoId(),
      createdAt: now,
      updatedAt: now,
      dishId: items[0]?.dishId || '',
      offerId: items[0]?.dishId || '', // Same as dishId for MVP
      dishName: items.map(i => `${i.dishName} x ${i.quantity}`).join(', '),
      providerId: cartData.providerId || '',
      providerName: cartData.providerName || 'Anbieter',
      providerAddress: firstOfferNormalized ? buildAddress({
        address: firstOfferNormalized.address,
        street: firstOfferNormalized.providerStreet,
        zip: firstOfferNormalized.providerZip,
        city: firstOfferNormalized.providerCity
      }) : '',
      quantity: cartData.items.reduce((sum, it) => sum + it.qty, 0),
      unitPrice: items[0]?.unitPriceCents || 0,
      total: totalCents,
      fulfillType: firstOfferNormalized && firstOfferNormalized.dineInPossible ? 'DINE_IN' : 'PICKUP',
      etaTime: cartData.pickupTime || '',
      status: initialStatus,
      currency: 'EUR',
      stripeCheckoutSessionId: undefined,
      stripePaymentIntentId: undefined,
      receiptEmail: undefined,
      pickupCode: undefined, // Nur bei PAID (Guard in addOrder)
      pickupCodeActivatedAt: undefined, // Nur bei PAID
      pickupDate: undefined, // Wird bei PAID gesetzt
      pickupWindow: firstOfferNormalized && firstOfferNormalized.pickupWindow ? firstOfferNormalized.pickupWindow : '',
      dishLetter: undefined, // Wird bei PAID gesetzt
      runningNumber: undefined, // Wird bei PAID gesetzt
      isGuest: true,
      // Legacy-Felder für Kompatibilität
      summary: items.map(i => `${i.dishName} x ${i.quantity}`).join(', '),
      code: null,
      pickupTime: cartData.pickupTime || '',
      pickupWindow: firstOfferNormalized && firstOfferNormalized.pickupWindow ? firstOfferNormalized.pickupWindow : '',
      unitPriceCents: items[0]?.unitPriceCents || 0,
      totalCents: totalCents,
      paymentIntentId: null
    };
    
    return addOrder(order);
  }
  
  // --- Stripe Checkout (Gastzahlung, Zahlung Pflicht) ---
  /**
   * Start Stripe Checkout flow
   * @param {number} total - Total amount in EUR (not cents)
   * @param {Object} cartData - Cart data
   * @param {string} orderId - Order ID
   */
  function startStripeCheckout(total, cartData, orderId){
    // TODO: Replace with real Stripe integration
    // In Production:
    //   1. Backend-Endpoint: POST /api/create-checkout-session
    //   2. Request Body: { orderId, items: cartData.items, total, pickupTime, ... }
    //   3. Backend erstellt Stripe Checkout Session (mode: 'payment', allow_promotion_codes: true)
    //   4. Session-URL erhalten: session.url
    //   5. window.location.href = session.url; (öffnet Stripe Checkout)
    //   6. Nach Zahlung: Stripe leitet zurück zu success_url?session_id=xxx
    //   7. Webhook bestätigt Zahlung → handleCheckoutSuccess(session_id)
    
    // MVP Demo: Simuliere Stripe Checkout
    const sessionId = 'demo_session_' + cryptoId();
    
    // Speichere session_id in Order (wird später bei Success verwendet)
    updateOrder(orderId, {
      stripeCheckoutSessionId: sessionId
    });
    
    // Demo: Simuliere erfolgreiche Zahlung
    // In Production: window.location.href = session.url;
    if(confirm(`Stripe Checkout würde jetzt geöffnet.\n\nGesamtbetrag: ${euro(total)}\n\nGastzahlung möglich (E-Mail nur für Zahlungsbeleg, kein Login erforderlich).\n\nDemo: Zahlung erfolgreich simulieren?`)){
      // Simuliere Success-Return
      handleCheckoutSuccess(sessionId, orderId);
    } else {
      // Simuliere Cancel
      handleCheckoutCancel(orderId);
    }
  }
  
  /**
   * Handle Stripe Checkout Success Return
   * Route: /checkout/success?session_id=xxx OR ?orderId=xxx
   * @param {string} [sessionId] - Stripe session ID (optional)
   * @param {string} [orderId] - Order ID (optional, if sessionId not available)
   */
  function handleCheckoutSuccess(sessionId, orderId){
    // TODO: In Production, verify payment via Webhook
    // For now: MVP assumes payment is successful if we reach this point
    
    let order = null;
    
    // Find order: priority: orderId > sessionId
    if(orderId){
      order = getOrderById(orderId);
    } else if(sessionId){
      // Find order by session_id
      const ordersList = loadOrders();
      order = ordersList.find(o => o.stripeCheckoutSessionId === sessionId);
    }
    
    // Fehler-UI: Bestellung nicht gefunden
    if(!order){
      console.error('Order not found for checkout success', { sessionId, orderId });
      // Zeige Fehler-UI
      const errorView = document.createElement('div');
      errorView.className = 'panel';
      errorView.style.padding = '40px 20px';
      errorView.style.textAlign = 'center';
      errorView.innerHTML = `
        <div style="font-size:48px; margin-bottom:20px;">⚠️</div>
        <h3 style="margin-bottom:12px;">Bestellung nicht gefunden</h3>
        <p class="hint" style="margin-bottom:24px;">Die Bestellung konnte nicht gefunden werden.</p>
        <button class="btn" type="button" onclick="showDiscover()" style="width:100%; min-height:44px;">
          <i data-lucide="compass"></i> Zur Entdecken-Seite
        </button>
      `;
      document.body.appendChild(errorView);
      showView(null); // Hide all views
      if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
      return;
    }
    
    // Wenn Order noch nicht PAID: auf PAID setzen und Code generieren
    if(order.status !== 'PAID'){
      if(order.status !== 'PAYMENT_PENDING'){
        console.warn('Order status is not PAYMENT_PENDING:', order.status);
      }
      
      // Mark as PAID and generate pickup code
      completePayment(order.id, {
        stripeCheckoutSessionId: sessionId || order.stripeCheckoutSessionId,
        paymentIntentId: 'pi_' + cryptoId(), // Would come from Stripe webhook
        receiptEmail: 'customer@example.com' // Would come from Stripe
      });
    } else {
      // Bereits PAID: direkt zu Abholcode navigieren
      showPickupCode(order.id);
    }
  }
  
  /**
   * Handle Stripe Checkout Cancel
   * Route: /checkout/cancel?orderId=xxx OR ?session_id=xxx
   * @param {string} [orderId] - Order ID (optional)
   * @param {string} [sessionId] - Stripe session ID (optional)
   */
  function handleCheckoutCancel(orderId, sessionId){
    let order = null;
    
    // Find order: priority: orderId > sessionId
    if(orderId){
      order = getOrderById(orderId);
    } else if(sessionId){
      const ordersList = loadOrders();
      order = ordersList.find(o => o.stripeCheckoutSessionId === sessionId);
    }
    
    if(!order){
      // Fallback: direkt zum Warenkorb
      showCart();
      return;
    }
    
    // Set status to CANCELLED
    updateOrder(order.id, {
      status: 'CANCELLED'
    });
    
    // UI: "Zahlung abgebrochen" + Button "Zurück zum Warenkorb"
    // Navigate back to cart
    showCart();
    
    // Zeige Info (optional, kann auch weggelassen werden)
    setTimeout(() => {
      const cartBox = document.getElementById('cartBox');
      if(cartBox){
        const infoDiv = document.createElement('div');
        infoDiv.className = 'hint';
        infoDiv.style.cssText = 'background:#fff3cd; border:1px solid #ffc107; border-radius:12px; padding:12px; margin-bottom:16px; text-align:center;';
        infoDiv.innerHTML = 'ℹ️ Zahlung abgebrochen';
        cartBox.insertBefore(infoDiv, cartBox.firstChild);
      }
    }, 100);
  }
  
  /**
   * Complete payment (set status to PAID and generate pickup code)
   * @param {string} orderId
   * @param {Object} paymentData
   * @param {string} [paymentData.stripeCheckoutSessionId]
   * @param {string} [paymentData.paymentIntentId]
   * @param {string} [paymentData.receiptEmail]
   */
  function completePayment(orderId, paymentData){
    const order = getOrderById(orderId);
    if(!order){
      console.error('Order not found:', orderId);
      return;
    }
    
    // Get offer to determine day and pickup window
    const offer = offers.find(o => o.id === order.dishId || o.id === order.offerId);
    const pickupDate = offer ? offer.day : isoDate(new Date());
    const pickupWindow = offer ? (offer.pickupWindow || '') : (order.pickupWindow || '');
    
    // Assign pickup code (deterministic, mock)
    // Single source of truth: Order record
    const {dishLetter, runningNumber, pickupCode} = assignPickupCode({
      providerId: order.providerId,
      pickupDate: pickupDate,
      dishId: order.dishId || order.offerId
    });
    const now = Date.now();
    
    // Order auf PAID setzen (pickupCode wird hier gesetzt, da status=PAID)
    const updatedOrder = updateOrder(orderId, {
      status: 'PAID',
      stripeCheckoutSessionId: paymentData.stripeCheckoutSessionId,
      stripePaymentIntentId: paymentData.paymentIntentId,
      receiptEmail: paymentData.receiptEmail,
      pickupCode: pickupCode,
      pickupCodeActivatedAt: now,
      pickupDate: pickupDate,
      pickupWindow: pickupWindow,
      dishLetter: dishLetter,
      runningNumber: runningNumber,
      // Legacy-Felder für Kompatibilität
      code: pickupCode,
      paymentStatus: 'PAID',
      paymentIntentId: paymentData.paymentIntentId
    });
    
    if(!updatedOrder){
      console.error('Failed to update order');
      return;
    }
    
    // Warenkorb leeren
    cart = null;
    save(LS.cart, cart);
    renderCart();
    
    // Orders aktualisieren
    orders = loadOrders();
    renderOrders();
    
    // Navigiere zu AbholcodeScreen mit Animation
    showPickupCode(updatedOrder.id);
    
    // Animation: "Zahlung bestätigt – Dein Gericht wird reserviert!"
    setTimeout(() => {
      const pickupCodeView = document.getElementById('v-pickup-code');
      if(pickupCodeView){
        const animationEl = document.createElement('div');
        animationEl.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(0,0,0,0.9); color:#fff; padding:24px 32px; border-radius:20px; font-size:18px; font-weight:700; z-index:10000; text-align:center; box-shadow:0 8px 32px rgba(0,0,0,0.3);';
        animationEl.textContent = '✓ Zahlung bestätigt – Dein Gericht wird reserviert!';
        document.body.appendChild(animationEl);
        setTimeout(() => {
          animationEl.style.transition = 'opacity 0.3s';
          animationEl.style.opacity = '0';
          setTimeout(() => animationEl.remove(), 300);
        }, 1500);
      }
    }, 100);
  }

  // --- Start actions ---
  const startCustomerBtn = document.getElementById('btnStartCustomer');
  if(startCustomerBtn){
    startCustomerBtn.onclick=()=>{
      setMode('customer');
    };
  }
  const startProviderBtn = document.getElementById('btnStartProvider');
  if(startProviderBtn){
    startProviderBtn.onclick=()=>{
      setMode('provider');
    };
  }

  // --- Profile View ("Mein Mittagio") - Zalando-Prinzip ---
  function updateProfileView(){
    const isLoggedIn = customer.loggedIn;
    const firstName = customer.name ? customer.name.split(' ')[0] : '';
    const fullName = customer.name || 'Gast';
    
    // Initialen für Avatar
    const initials = fullName.split(' ').map(n => n[0]?.toUpperCase() || '').join('').slice(0, 2) || '?';
    
    // Header-Card (Identität)
    const headerCard = document.getElementById('profileHeaderCard');
    if(headerCard){
      if(isLoggedIn){
        headerCard.innerHTML = `
          <div style="display:flex; align-items:center; gap:16px;">
            <div style="width:64px; height:64px; border-radius:50%; background:linear-gradient(135deg, #FFD700 0%, #FFB800 100%); display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:900; color:#2D3436; box-shadow:0 4px 12px rgba(255,215,0,0.3); flex-shrink:0;">
              ${initials}
            </div>
            <div style="flex:1; min-width:0;">
              <div style="font-weight:900; font-size:22px; margin-bottom:4px; color:#2D3436; line-height:1.2;">Hallo ${esc(firstName || 'Kunde')} 👋</div>
              <div class="hint" style="font-size:14px; color:#666; line-height:1.4;">Dein persönlicher Mittagsbereich</div>
            </div>
          </div>
        `;
      } else {
        headerCard.innerHTML = `
          <div style="display:flex; align-items:center; gap:16px;">
            <div style="width:64px; height:64px; border-radius:50%; background:linear-gradient(135deg, rgba(255,215,0,0.2) 0%, rgba(255,184,0,0.1) 100%); display:flex; align-items:center; justify-content:center; font-size:24px; flex-shrink:0;">
              👤
            </div>
            <div style="flex:1; min-width:0;">
              <div style="font-weight:900; font-size:22px; margin-bottom:4px; color:#2D3436; line-height:1.2;">Willkommen bei Mittagio 👋</div>
              <div class="hint" style="font-size:14px; color:#666; line-height:1.4; margin-bottom:12px;">Bestelle schneller und finde deine Abholcodes wieder.</div>
              <button class="btn-primary" type="button" id="btnProfileCreateAccount" style="width:100%; max-width:200px; min-height:44px; font-weight:700;">
                Profil anlegen
              </button>
            </div>
          </div>
        `;
        const btn = document.getElementById('btnProfileCreateAccount');
        if(btn) btn.onclick = () => {
          const email = prompt('E-Mail-Adresse:');
          if(email){
            customer.loggedIn = true;
            customer.email = email;
            customer.name = email.split('@')[0];
            if(!customer.dietaryPreferences) customer.dietaryPreferences = { vegan: false, vegetarian: false, glutenFree: false, lactoseFree: false };
            save(LS.customer, customer);
            updateProfileView();
          }
        };
      }
    }
    
    // Quick-History (Aktive Tickets)
    const ticketsSection = document.getElementById('profileTicketsSection');
    const ticketsList = document.getElementById('profileActiveTicketsList');
    const allOrders = loadOrders();
    const hasOrders = Array.isArray(allOrders) && allOrders.length > 0; // Bug-Fix: Sauber definiert
    
    // Heutige aktive Tickets (PAID, nicht PICKED_UP)
    const today = isoDate(new Date());
    const activeTickets = allOrders.filter(o => 
      o.status === 'PAID' && 
      o.pickupDate === today && 
      (!o.pickupCodeActivatedAt || o.pickupCodeActivatedAt === null) // Noch nicht abgeholt
    );
    
    if(ticketsSection && ticketsList){
      if(activeTickets.length > 0){
        ticketsSection.style.display = 'block';
        ticketsList.innerHTML = activeTickets.map(order => {
          const code = order.pickupCode || '–';
          return `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:16px; background:#f8f9fa; border-radius:16px; border:2px solid rgba(255,215,0,0.2); cursor:pointer; transition:all 0.2s ease;" onclick="showPickupCode('${esc(order.id)}');" onmouseover="this.style.borderColor='rgba(255,215,0,0.5)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.borderColor='rgba(255,215,0,0.2)'; this.style.transform='translateY(0)';">
              <div style="flex:1; min-width:0;">
                <div style="font-weight:900; font-size:18px; color:#2D3436; margin-bottom:4px; font-family:monospace; letter-spacing:2px;">${esc(code)}</div>
                <div style="font-size:13px; color:#666; display:flex; align-items:center; gap:6px;">
                  <i data-lucide="store" style="width:14px;height:14px;"></i>
                  <span>${esc(order.providerName || 'Anbieter')}</span>
                </div>
              </div>
              <i data-lucide="chevron-right" style="width:20px;height:20px; color:#999; flex-shrink:0;"></i>
            </div>
          `;
        }).join('');
      } else {
        ticketsSection.style.display = 'none';
      }
    }
    
    // Ernährungs-Zentrale (Präferenzen)
    const dietSection = document.getElementById('profileDietSwitches');
    if(dietSection){
      if(!customer.dietaryPreferences) customer.dietaryPreferences = { vegan: false, vegetarian: false, glutenFree: false, lactoseFree: false };
      const prefs = customer.dietaryPreferences;
      
      const switches = [
        { key: 'vegan', label: 'Vegan', icon: 'leaf', desc: 'Nur vegane Gerichte anzeigen' },
        { key: 'vegetarian', label: 'Vegetarisch', icon: 'sprout', desc: 'Nur vegetarische Gerichte anzeigen' },
        { key: 'glutenFree', label: 'Glutenfrei', icon: 'wheat-off', desc: 'Nur glutenfreie Gerichte anzeigen' },
        { key: 'lactoseFree', label: 'Laktosefrei', icon: 'milk-off', desc: 'Nur laktosefreie Gerichte anzeigen' }
      ];
      
      dietSection.innerHTML = switches.map(s => {
        const isActive = prefs[s.key] || false;
        return `
          <div style="display:flex; align-items:center; justify-content:space-between; padding:16px; background:${isActive ? 'rgba(255,215,0,0.1)' : '#f8f9fa'}; border-radius:16px; border:2px solid ${isActive ? '#FFD700' : 'transparent'}; transition:all 0.2s ease;">
            <div style="flex:1; min-width:0;">
              <div style="display:flex; align-items:center; gap:10px; margin-bottom:4px;">
                <i data-lucide="${s.icon}" style="width:20px;height:20px; color:${isActive ? '#FFD700' : '#666'};"></i>
                <span style="font-weight:700; font-size:15px; color:#2D3436;">${esc(s.label)}</span>
              </div>
              <div style="font-size:12px; color:#666; line-height:1.4;">${esc(s.desc)}</div>
            </div>
            <label style="position:relative; width:52px; height:32px; cursor:pointer; flex-shrink:0;">
              <input type="checkbox" ${isActive ? 'checked' : ''} style="opacity:0; position:absolute; width:0; height:0;" onchange="toggleDietaryPreference('${s.key}', this.checked);">
              <span style="position:absolute; top:0; left:0; right:0; bottom:0; background:${isActive ? '#FFD700' : '#ccc'}; border-radius:999px; transition:all 0.3s ease;">
                <span style="position:absolute; top:2px; left:${isActive ? '22px' : '2px'}; width:28px; height:28px; background:#fff; border-radius:50%; box-shadow:0 2px 4px rgba(0,0,0,0.2); transition:all 0.3s ease;"></span>
              </span>
            </label>
          </div>
        `;
      }).join('');
    }
    
    // Business-Card: Provider-Login Button
    const businessCard = document.getElementById('profileBusinessCard');
    const btnProviderBusinessLogin = document.getElementById('btnProviderBusinessLogin');
    const btnProviderBusinessLoginText = document.getElementById('btnProviderBusinessLoginText');
    if(businessCard && btnProviderBusinessLogin && btnProviderBusinessLoginText){
      if(provider.loggedIn){
        // Eingeloggt: "Zum Dashboard" Button
        btnProviderBusinessLoginText.textContent = 'Zum Dashboard';
        btnProviderBusinessLogin.innerHTML = `<i data-lucide="layout-dashboard" style="width:20px;height:20px;"></i> <span>Zum Dashboard</span>`;
        btnProviderBusinessLogin.onclick = () => {
          setMode('provider');
          showProviderHome();
        };
      } else {
        // Nicht eingeloggt: "Jetzt als Anbieter einloggen" Button
        btnProviderBusinessLoginText.textContent = 'Jetzt als Anbieter einloggen';
        btnProviderBusinessLogin.innerHTML = `<i data-lucide="log-in" style="width:20px;height:20px;"></i> <span>Jetzt als Anbieter einloggen</span>`;
        btnProviderBusinessLogin.onclick = () => {
          showProviderLoginModal();
        };
      }
    }
    
    // Support & Vertrauen
    const supportSection = document.getElementById('profileSupportList');
    if(supportSection){
      const supportItems = [
        { icon: 'help-circle', label: 'Hilfe & Kontakt', action: 'openHelp' },
        { icon: 'shield', label: 'Datenschutz', action: 'showDatenschutz' },
        { icon: 'file-text', label: 'Impressum', action: 'showImpressum' }
      ];
      
      if(isLoggedIn){
        supportItems.push({ icon: 'log-out', label: 'Abmelden', action: 'logout', danger: true });
      }
      
      supportSection.innerHTML = supportItems.map(item => `
        <button class="rowbtn" type="button" onclick="handleSupportAction('${item.action}');" style="width:100%; padding:16px 0; border:none; background:none; text-align:left; cursor:pointer; border-bottom:1px solid var(--border); transition:background 0.2s ease;" onmouseover="this.style.background='#f8f9fa';" onmouseout="this.style.background='none';">
          <div style="display:flex; align-items:center; gap:12px;">
            <i data-lucide="${item.icon}" style="width:20px;height:20px; color:${item.danger ? '#e74c3c' : '#666'};"></i>
            <span style="font-weight:${item.danger ? '700' : '600'}; font-size:15px; color:${item.danger ? '#e74c3c' : '#2D3436'};">${esc(item.label)}</span>
          </div>
          <i data-lucide="chevron-right" style="width:18px;height:18px; color:#999; margin-left:auto;"></i>
        </button>
      `).join('');
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }
  
  // Ernährungs-Präferenz Toggle
  function toggleDietaryPreference(key, value){
    if(!customer.dietaryPreferences) customer.dietaryPreferences = { vegan: false, vegetarian: false, glutenFree: false, lactoseFree: false };
    customer.dietaryPreferences[key] = value;
    save(LS.customer, customer);
    updateProfileView();
    
    // Feed sofort neu rendern mit Filter
    if(typeof renderDiscover === 'function'){
      renderDiscover();
    }
  }
  
  // Support-Actions Handler
  function handleSupportAction(action){
    if(action === 'openHelp'){
      // TODO: Hilfe-Seite öffnen
      alert('Hilfe & Kontakt: info@mittagio.de');
    } else if(action === 'showDatenschutz'){
      showView(views.legalDatenschutz);
    } else if(action === 'showImpressum'){
      showView(views.legalImpressum);
    } else if(action === 'logout'){
      if(confirm('Möchtest du dich wirklich abmelden?')){
        customer.loggedIn = false;
        customer.name = null;
        customer.email = null;
        save(LS.customer, customer);
        updateProfileView();
      }
    }
  }
  
  // Provider Login Modal
  function showProviderLoginModal(){
    document.getElementById('providerLoginBd').style.display = 'block';
    document.getElementById('providerLoginSheet').style.display = 'block';
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(() => lucide.createIcons(), 50);
    }
  }
  
  function closeProviderLoginModal(){
    document.getElementById('providerLoginBd').style.display = 'none';
    document.getElementById('providerLoginSheet').style.display = 'none';
    // Felder leeren
    const emailField = document.getElementById('providerLoginEmail');
    const passField = document.getElementById('providerLoginPass');
    if(emailField) emailField.value = '';
    if(passField) passField.value = '';
  }
  
  // Provider Login Handler
  const btnProviderLoginModal = document.getElementById('btnProviderLoginModal');
  if(btnProviderLoginModal){
    btnProviderLoginModal.onclick = () => {
      const email = document.getElementById('providerLoginEmail').value.trim();
      const pass = document.getElementById('providerLoginPass').value.trim();
      if(!email || !pass){
        showToast('Bitte E-Mail und Passwort eingeben.', 2000);
        return;
      }
      // Login durchführen
      provider.loggedIn = true;
      provider.email = email;
      save(LS.provider, provider);
      closeProviderLoginModal();
      showToast('Erfolgreich eingeloggt! 🎉', 2000);
      // Profil aktualisieren (Button ändert sich zu "Zum Dashboard")
      updateProfileView();
      // Optional: Direkt zum Dashboard
      setTimeout(() => {
        setMode('provider');
        showProviderHome();
      }, 500);
    };
  }
  
  // Enter-Taste im Login-Modal
  const providerLoginEmail = document.getElementById('providerLoginEmail');
  const providerLoginPass = document.getElementById('providerLoginPass');
  if(providerLoginEmail && providerLoginPass){
    [providerLoginEmail, providerLoginPass].forEach(field => {
      field.onkeydown = (e) => {
        if(e.key === 'Enter'){
          e.preventDefault();
          if(btnProviderLoginModal) btnProviderLoginModal.click();
        }
      };
    });
  }

  // Logout-Handler (wenn vorhanden)
  const btnUnifiedLogout = document.getElementById('btnUnifiedLogout');
  if(btnUnifiedLogout){
    btnUnifiedLogout.onclick=()=>{
      customer.loggedIn = false;
      customer.name = null;
      customer.email = null;
      save(LS.customer, customer);
      updateProfileView();
      showProfile();
    };
  }

  // Provider Switch (wenn vorhanden)
  const btnSwitchToProvider = document.getElementById('btnSwitchToProvider');
  if(btnSwitchToProvider){
    btnSwitchToProvider.onclick=()=>{
      if(!provider.loggedIn){
        setMode('provider');
      } else {
        showProviderHome();
      }
    };
  }

  // --- Hybrid Onboarding System ---
  let onboardingDraftDish = load(LS.onboardingDraft, null);
  
  function showOnboardingEntry(hasDraft = false){
    showView(views.providerOnboardingEntry);
    
    // Show returning banner if draft exists
    const entryPanel = document.querySelector('#v-provider-onboarding-entry .panel');
    if(hasDraft && onboardingDraftDish && entryPanel){
      const banner = document.createElement('div');
      banner.style.cssText = 'margin-bottom:24px; padding:16px; background:#f0f7f0; border-radius:12px; border:1px solid #4caf50;';
      banner.innerHTML = `
        <div style="font-weight:600; font-size:16px; margin-bottom:8px; color:#2e7d32;">Du hast ein Gericht vorbereitet</div>
        <div style="font-size:14px; line-height:1.4; margin-bottom:12px; color:#666;">Möchtest du weitermachen?</div>
        <div style="display:flex; gap:8px;">
          <button class="btn secondary" type="button" id="btnOnboardingResume" style="flex:1; min-height:44px;">Weiter bearbeiten</button>
          <button class="btn ghost" type="button" id="btnOnboardingDiscard" style="flex:1; min-height:44px;">Verwerfen</button>
        </div>
      `;
      entryPanel.insertBefore(banner, entryPanel.firstChild);
      
      const btnResume = document.getElementById('btnOnboardingResume');
      const btnDiscard = document.getElementById('btnOnboardingDiscard');
      if(btnResume) btnResume.onclick = () => showOnboardingFirstDish(true);
      if(btnDiscard) btnDiscard.onclick = () => {
        onboardingDraftDish = null;
        save(LS.onboardingDraft, null);
        showOnboardingEntry(false);
      };
    }
  }
  
  function showOnboardingFirstDish(prefill = false){
    showView(views.providerOnboardingFirstDish);
    
    // Push state for browser back button
    history.pushState({onboarding: 'first-dish'}, '', location.pathname);
    
    if(prefill && onboardingDraftDish){
      const dishName = document.getElementById('onboardingDishName');
      const timeStart = document.getElementById('onboardingPickupTimeStart');
      const timeEnd = document.getElementById('onboardingPickupTimeEnd');
      const photoPreview = document.getElementById('onboardingPhotoPreview');
      const photoPreviewImg = document.getElementById('onboardingPhotoPreviewImg');
      
      if(dishName) dishName.value = onboardingDraftDish.dishName || '';
      if(timeStart) timeStart.value = onboardingDraftDish.pickupTimeStart || '';
      if(timeEnd) timeEnd.value = onboardingDraftDish.pickupTimeEnd || '';
      if(onboardingDraftDish.photoData && photoPreview && photoPreviewImg){
        photoPreview.style.display = 'block';
        photoPreviewImg.src = onboardingDraftDish.photoData;
      }
    }
    
    // Photo upload handler (recreate each time to avoid duplicates)
    const existingInput = document.getElementById('onboardingPhotoInput');
    if(existingInput) existingInput.remove();
    
    const photoInput = document.createElement('input');
    photoInput.id = 'onboardingPhotoInput';
    photoInput.type = 'file';
    photoInput.accept = 'image/*';
    photoInput.style.display = 'none';
    document.body.appendChild(photoInput);
    
    // Profi-Galerie System
    const foodLibrary = {
      klassiker: [
        {id: 'schnitzel', name: 'Schnitzel', url: 'https://images.unsplash.com/photo-1562967914-608f82629710?auto=format&fit=crop&w=800&q=80', allergens: ['Gluten', 'Ei']},
        {id: 'bratwurst', name: 'Bratwurst', url: 'https://images.unsplash.com/photo-1528607929212-2636ec44253e?auto=format&fit=crop&w=800&q=80', allergens: ['Gluten']},
        {id: 'roulade', name: 'Roulade', url: 'https://images.unsplash.com/photo-1546833999-b9f581a1996d?auto=format&fit=crop&w=800&q=80', allergens: ['Gluten']}
      ],
      deftig: [
        {id: 'gulasch', name: 'Gulasch', url: 'https://images.unsplash.com/photo-1563379091339-03246963d19c?auto=format&fit=crop&w=800&q=80', allergens: []},
        {id: 'braten', name: 'Braten', url: 'https://images.unsplash.com/photo-1544025162-d76694265947?auto=format&fit=crop&w=800&q=80', allergens: []},
        {id: 'kassler', name: 'Kassler', url: 'https://images.unsplash.com/photo-1544025162-d76694265947?auto=format&fit=crop&w=800&q=80', allergens: []}
      ],
      eintoepfe: [
        {id: 'linsensuppe', name: 'Linsensuppe', url: 'https://images.unsplash.com/photo-1547592166-23ac45744acd?auto=format&fit=crop&w=800&q=80', allergens: []},
        {id: 'erbsensuppe', name: 'Erbsensuppe', url: 'https://images.unsplash.com/photo-1547592166-23ac45744acd?auto=format&fit=crop&w=800&q=80', allergens: []},
        {id: 'kartoffelsuppe', name: 'Kartoffelsuppe', url: 'https://images.unsplash.com/photo-1547592166-23ac45744acd?auto=format&fit=crop&w=800&q=80', allergens: []}
      ],
      modern: [
        {id: 'bowl', name: 'Bowl', url: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=800&q=80', allergens: []},
        {id: 'wrap', name: 'Wrap', url: 'https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=800&q=80', allergens: ['Gluten']},
        {id: 'salat', name: 'Salat', url: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=800&q=80', allergens: []}
      ]
    };
    
    let selectedProPhoto = null;
    let recentProPhotos = JSON.parse(localStorage.getItem('mittagio_recent_pro_photos') || '[]');
    
    // Profi-Galerie Funktionen (global, damit onclick funktioniert)
    window.openProPhotoGallery = function(){
      document.getElementById('proPhotoBd').style.display = 'block';
      document.getElementById('proPhotoSheet').style.display = 'flex';
      window.renderProPhotoGallery('all');
    };
    
    window.closeProPhotoGallery = function(){
      document.getElementById('proPhotoBd').style.display = 'none';
      document.getElementById('proPhotoSheet').style.display = 'none';
    };
    
    window.renderProPhotoGallery = function(category){
      const gridEl = document.getElementById('proPhotoGrid');
      if(!gridEl) return;
      
      // Kategorien-Tabs aktualisieren
      document.querySelectorAll('.pro-photo-category-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.category === category);
        tab.style.background = tab.dataset.category === category ? '#FFB800' : '#f5f5f5';
        tab.style.color = tab.dataset.category === category ? '#2D3436' : '#666';
      });
      
      // Zuletzt genutzt anzeigen (wenn vorhanden)
      const recentEl = document.getElementById('proPhotoRecent');
      const recentGridEl = document.getElementById('proPhotoRecentGrid');
      if(recentEl && recentGridEl){
        if(recentProPhotos.length > 0 && category === 'all'){
          recentEl.style.display = 'block';
          recentGridEl.innerHTML = recentProPhotos.slice(0, 4).map(photo => {
            return `
              <div onclick="selectProPhoto('${photo.id}', '${esc(photo.url)}', '${esc(photo.category)}');" style="aspect-ratio:1; border-radius:12px; overflow:hidden; cursor:pointer; border:2px solid #FFB800;">
                <img src="${esc(photo.url)}" alt="${esc(photo.name)}" style="width:100%; height:100%; object-fit:cover;" />
              </div>
            `;
          }).join('');
        } else {
          recentEl.style.display = 'none';
        }
      }
      
      // Galerie rendern
      let photos = [];
      if(category === 'all'){
        Object.values(foodLibrary).flat().forEach(p => photos.push({...p, category: Object.keys(foodLibrary).find(k => foodLibrary[k].includes(p))}));
      } else {
        photos = foodLibrary[category] || [];
      }
      
      gridEl.innerHTML = photos.map(photo => {
        return `
          <div onclick="selectProPhoto('${photo.id}', '${esc(photo.url)}', '${category}');" style="aspect-ratio:1; border-radius:12px; overflow:hidden; cursor:pointer; border:2px solid #e7e1d5; transition:all 0.2s;" onmouseover="this.style.borderColor='#FFB800'; this.style.transform='scale(1.05)';" onmouseout="this.style.borderColor='#e7e1d5'; this.style.transform='scale(1)';">
            <img src="${esc(photo.url)}" alt="${esc(photo.name)}" style="width:100%; height:100%; object-fit:cover;" />
          </div>
        `;
      }).join('');
    };
    
    window.selectProPhoto = function(photoId, photoUrl, category){
      selectedProPhoto = {id: photoId, url: photoUrl, category: category, isStockPhoto: true};
      
      // Zu "Zuletzt genutzt" hinzufügen
      recentProPhotos = recentProPhotos.filter(p => p.id !== photoId);
      recentProPhotos.unshift({id: photoId, url: photoUrl, category: category, name: foodLibrary[category]?.find(p => p.id === photoId)?.name || 'Gericht'});
      recentProPhotos = recentProPhotos.slice(0, 10);
      localStorage.setItem('mittagio_recent_pro_photos', JSON.stringify(recentProPhotos));
      
      // Preview anzeigen
      const previewEl = document.getElementById('onboardingPhotoPreview');
      const previewImgEl = document.getElementById('onboardingPhotoPreviewImg');
      const watermarkEl = document.getElementById('onboardingPhotoWatermark');
      
      if(previewEl && previewImgEl){
        previewEl.style.display = 'block';
        previewImgEl.src = photoUrl;
        previewImgEl.style.filter = 'brightness(1.05) contrast(1.1) saturate(1.2)';
        if(watermarkEl) watermarkEl.style.display = 'block';
      }
      
      window.closeProPhotoGallery();
      showToast('Profi-Foto ausgewählt. Wir markieren es als Serviervorschlag.');
    };
    
    // Kategorien-Tab Handler
    document.querySelectorAll('.pro-photo-category-tab').forEach(tab => {
      tab.onclick = () => {
        window.renderProPhotoGallery(tab.dataset.category);
      };
    });
    
    // Profi-Galerie Button Handler
    const btnOnboardingChooseProPhoto = document.getElementById('btnOnboardingChooseProPhoto');
    if(btnOnboardingChooseProPhoto){
      btnOnboardingChooseProPhoto.onclick = () => {
        window.openProPhotoGallery();
      };
    }
    
    const btnAddPhoto = document.getElementById('btnOnboardingAddPhoto');
    if(btnAddPhoto){
      btnAddPhoto.onclick = () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.capture = 'environment';
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if(!file) return;
          
          // Kamera-Guide Overlay (SVG)
          const reader = new FileReader();
          reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
              // Automatischer Zuschnitt (1:1 oder 4:5)
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              const size = Math.min(img.width, img.height);
              canvas.width = size;
              canvas.height = size;
              ctx.drawImage(img, (img.width - size) / 2, (img.height - size) / 2, size, size, 0, 0, size, size);
              
              // Image Processing Filter
              const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
              const data = imageData.data;
              for(let i = 0; i < data.length; i += 4){
                data[i] = Math.min(255, data[i] * 1.05); // brightness
                data[i + 1] = Math.min(255, data[i + 1] * 1.05);
                data[i + 2] = Math.min(255, data[i + 2] * 1.05);
                // contrast & saturate (vereinfacht)
                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                data[i] = avg + (data[i] - avg) * 1.1;
                data[i + 1] = avg + (data[i + 1] - avg) * 1.1;
                data[i + 2] = avg + (data[i + 2] - avg) * 1.1;
              }
              ctx.putImageData(imageData, 0, 0);
              
              const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
              const previewEl = document.getElementById('onboardingPhotoPreview');
              const previewImgEl = document.getElementById('onboardingPhotoPreviewImg');
              const watermarkEl = document.getElementById('onboardingPhotoWatermark');
              
              if(previewEl && previewImgEl){
                previewEl.style.display = 'block';
                previewImgEl.src = dataUrl;
                previewImgEl.style.filter = 'brightness(1.05) contrast(1.1) saturate(1.2)';
                if(watermarkEl) watermarkEl.style.display = 'none';
              }
              
              selectedProPhoto = null; // Eigenes Foto, kein Stock-Photo
            };
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        };
        input.click();
      };
    }
    
    // Legacy: photoInput.onchange (falls vorhanden - prüfe ob Element existiert)
    const existingPhotoInput = document.getElementById('photoInput');
    if(existingPhotoInput){
      existingPhotoInput.onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const dataUrl = await toDataUrl(file);
        const photoPreview = document.getElementById('onboardingPhotoPreview');
        const photoPreviewImg = document.getElementById('onboardingPhotoPreviewImg');
        if(photoPreview && photoPreviewImg){
          photoPreview.style.display = 'block';
          photoPreviewImg.src = dataUrl;
        }
        if(!onboardingDraftDish) onboardingDraftDish = {};
        onboardingDraftDish.photoData = dataUrl;
        save(LS.onboardingDraft, onboardingDraftDish);
      };
    }
    
    // Warn before leaving if changes exist
    let hasChanges = false;
    const inputs = ['onboardingDishName', 'onboardingPickupTimeStart', 'onboardingPickupTimeEnd'];
    inputs.forEach(id => {
      const el = document.getElementById(id);
      if(el){
        el.oninput = () => { hasChanges = true; };
      }
    });
    
    window.onbeforeunload = (e) => {
      if(hasChanges && onboardingDraftDish){
        e.preventDefault();
        e.returnValue = '';
      }
    };
  }
  
  function showOnboardingSignup(){
    showView(views.providerOnboardingSignup);
    history.pushState({onboarding: 'signup'}, '', location.pathname);
  }
  
  function showOnboardingBusiness(){
    showView(views.providerOnboardingBusiness);
    history.pushState({onboarding: 'business'}, '', location.pathname);
  }
  
  function showOnboardingPreview(dishId){
    showView(views.providerOnboardingPreview);
    history.pushState({onboarding: 'preview'}, '', location.pathname);
    
    // Load saved dish and show preview
    const savedDish = dishId ? cookbook.find(c => c.id === dishId) : cookbook.find(c => c.providerId === providerId());
    const previewCard = document.getElementById('onboardingPreviewCard');
    if(previewCard && (savedDish || onboardingDraftDish)){
      const dish = savedDish || {
        dish: onboardingDraftDish.dishName,
        category: 'Vegetarisch',
        photoData: onboardingDraftDish.photoData || null
      };
      
      const preview = offerCard({
        id: dish.id || 'preview',
        dish: dish.dish,
        category: dish.category || 'Vegetarisch',
        price: 0, // No price in preview
        pickupWindow: savedDish?.pickupWindow || `${onboardingDraftDish?.pickupTimeStart || '11:30'} – ${onboardingDraftDish?.pickupTimeEnd || '14:30'}`,
        imageUrl: dish.photoData || dish.imageUrl || '',
        providerName: provider.profile?.name || 'Dein Betrieb',
        hasPickupCode: false, // No abholcode in preview
        dineInPossible: false
      }, {interactive: false});
      
      previewCard.innerHTML = '';
      previewCard.appendChild(preview);
      
      // Disable all interactive elements in preview
      preview.querySelectorAll('button, a').forEach(el => {
        el.style.pointerEvents = 'none';
        el.style.opacity = '0.5';
      });
      
      // Update icons
      if(typeof lucide !== 'undefined'){
        setTimeout(() => lucide.createIcons(), 50);
      }
    }
  }
  
  // Onboarding Event Handlers
  const btnOnboardingEntryStart = document.getElementById('btnOnboardingEntryStart');
  if(btnOnboardingEntryStart) {
    btnOnboardingEntryStart.onclick = () => {
      // Direkt ins Kochbuch führen (erstes Gericht erstellen)
      showOnboardingFirstDish(false);
    };
  }
  
  const btnOnboardingEntryLater = document.getElementById('btnOnboardingEntryLater');
  if(btnOnboardingEntryLater) btnOnboardingEntryLater.onclick = () => {
    if(provider.loggedIn){
      showProviderHome();
    } else {
      showView(views.providerLogin);
    }
  };
  
  const btnOnboardingFirstDishBack = document.getElementById('btnOnboardingFirstDishBack');
  if(btnOnboardingFirstDishBack) btnOnboardingFirstDishBack.onclick = () => {
    const dishName = document.getElementById('onboardingDishName')?.value.trim();
    const timeStart = document.getElementById('onboardingPickupTimeStart')?.value;
    const timeEnd = document.getElementById('onboardingPickupTimeEnd')?.value;
    
    // Check if user has made changes
    if(dishName || timeStart || timeEnd || onboardingDraftDish?.photoData){
      if(confirm('Später weitermachen?\n\nDein Gericht ist noch nicht gespeichert.')){
        showOnboardingEntry(!!onboardingDraftDish);
      }
    } else {
      showOnboardingEntry(!!onboardingDraftDish);
    }
  };
  
  const btnOnboardingFirstDishNext = document.getElementById('btnOnboardingFirstDishNext');
  if(btnOnboardingFirstDishNext) btnOnboardingFirstDishNext.onclick = () => {
    const dishName = document.getElementById('onboardingDishName')?.value.trim();
    const timeStart = document.getElementById('onboardingPickupTimeStart')?.value;
    const timeEnd = document.getElementById('onboardingPickupTimeEnd')?.value;
    
    if(!dishName || !timeStart || !timeEnd){
      alert('Bitte fülle alle Pflichtfelder aus.');
      return;
    }
    
    // Save draft
    onboardingDraftDish = {
      dishName,
      pickupTimeStart: timeStart,
      pickupTimeEnd: timeEnd,
      photoData: onboardingDraftDish?.photoData || null
    };
    save(LS.onboardingDraft, onboardingDraftDish);
    
    // Check if user wants to leave
    showOnboardingSignup();
  };
  
  const btnOnboardingSignupCreate = document.getElementById('btnOnboardingSignupCreate');
  if(btnOnboardingSignupCreate) btnOnboardingSignupCreate.onclick = () => {
    const email = document.getElementById('onboardingEmail')?.value.trim();
    const password = document.getElementById('onboardingPassword')?.value.trim();
    
    if(!email || !password || password.length < 8){
      alert('Bitte gib eine gültige E-Mail und ein Passwort (mind. 8 Zeichen) ein.');
      return;
    }
    
    // Create account
    provider.loggedIn = true;
    provider.email = email;
    provider.onboardingCompleted = false; // Will be set to true after preview
    save(LS.provider, provider);
    
    // Save dish to cookbook
    if(onboardingDraftDish){
      const newDish = {
        id: cryptoId(),
        providerId: providerId(),
        dish: onboardingDraftDish.dishName,
        category: 'Vegetarisch',
        price: 0, // No price in onboarding
        pickupWindow: `${onboardingDraftDish.pickupTimeStart} – ${onboardingDraftDish.pickupTimeEnd}`,
        photoData: onboardingDraftDish.photoData || '',
        hasPickupCode: false, // No abholcode in onboarding
        dineInPossible: false,
        allergens: [],
        extras: [],
        reuse: {enabled: false, deposit: 0},
        createdAt: Date.now(),
        lastUsed: null
      };
      cookbook.push(newDish);
      save(LS.cookbook, cookbook);
      
      // Clear draft after successful save
      onboardingDraftDish = null;
      save(LS.onboardingDraft, null);
      
      // Proceed to business screen
      showOnboardingBusiness();
    }
  };
  
  const btnOnboardingSignupLater = document.getElementById('btnOnboardingSignupLater');
  if(btnOnboardingSignupLater) btnOnboardingSignupLater.onclick = () => {
    // Keep draft, go to login
    showView(views.providerLogin);
  };
  
  const btnOnboardingBusinessBack = document.getElementById('btnOnboardingBusinessBack');
  if(btnOnboardingBusinessBack) btnOnboardingBusinessBack.onclick = () => showOnboardingSignup();
  
  const btnOnboardingBusinessNext = document.getElementById('btnOnboardingBusinessNext');
  if(btnOnboardingBusinessNext) btnOnboardingBusinessNext.onclick = () => {
    const businessName = document.getElementById('onboardingBusinessName')?.value.trim();
    const cityOrAddress = document.getElementById('onboardingCityOrAddress')?.value.trim();
    
    if(!businessName || !cityOrAddress){
      alert('Bitte fülle alle Felder aus.');
      return;
    }
    
    // Save provider profile basics
    if(!provider.profile) provider.profile = {};
    provider.profile.name = businessName;
    const parsed = parseAddress(cityOrAddress);
    provider.profile.street = parsed.street || cityOrAddress;
    provider.profile.zip = parsed.zip || '';
    provider.profile.city = parsed.city || cityOrAddress;
    save(LS.provider, provider);
    
    // Get the saved dish ID
    const savedDish = cookbook.find(c => c.providerId === providerId() && c.dish === onboardingDraftDish?.dishName);
    if(savedDish){
      showOnboardingPreview(savedDish.id);
    } else {
      // Fallback: show preview with draft data
      showOnboardingPreview(null);
    }
  };
  
  // Tap-Demo Funktion (interaktiver Moment im Onboarding)
  function triggerTapDemo(){
    const demoCode = document.getElementById('demoPickupCode');
    const message = document.getElementById('tapDemoMessage');
    if(!demoCode || !message) return;
    
    // Grüner Flash-Effekt
    demoCode.style.background = '#4caf50';
    demoCode.style.color = '#fff';
    demoCode.style.transform = 'scale(0.95)';
    demoCode.style.borderColor = '#4caf50';
    
    // Nach 200ms zurück
    setTimeout(() => {
      demoCode.style.background = '#fff';
      demoCode.style.color = '#2D3436';
      demoCode.style.transform = 'scale(1)';
      demoCode.style.borderColor = '#FFD700';
    }, 200);
    
    // Nachricht anzeigen
    message.style.display = 'block';
    
    // Haptic Feedback
    if('vibrate' in navigator){
      navigator.vibrate([50, 30, 50]);
    }
  }
  
  const btnOnboardingPreviewDashboard = document.getElementById('btnOnboardingPreviewDashboard');
  if(btnOnboardingPreviewDashboard) btnOnboardingPreviewDashboard.onclick = () => {
    provider.onboardingCompleted = true;
    save(LS.provider, provider);
    // Direkt ins Kochbuch führen (erstes Gericht sehen)
    showProviderCookbook();
  };
  
  const btnOnboardingPreviewEdit = document.getElementById('btnOnboardingPreviewEdit');
  if(btnOnboardingPreviewEdit) btnOnboardingPreviewEdit.onclick = () => {
    // Restore draft from saved dish
    const savedDish = cookbook.find(c => c.providerId === providerId());
    if(savedDish){
      onboardingDraftDish = {
        dishName: savedDish.dish,
        pickupTimeStart: savedDish.pickupWindow?.split(' – ')[0] || '11:30',
        pickupTimeEnd: savedDish.pickupWindow?.split(' – ')[1] || '14:30',
        photoData: savedDish.photoData || null
      };
      save(LS.onboardingDraft, onboardingDraftDish);
    }
    showOnboardingFirstDish(true);
  };
  
  // Browser back button handling for onboarding (integrated in existing popstate handler)
  // The existing popstate handler already handles wizard and sheets
  // We add onboarding handling there

  // --- Provider entry ---
  const btnProvBack = document.getElementById('btnProvBack');
  if(btnProvBack){
    btnProvBack.onclick=()=>{ setMode('customer'); showProfile(); };
  }

  const btnProvLogin = document.getElementById('btnProvLogin');
  if(btnProvLogin){
    btnProvLogin.onclick=()=>{
      const email = document.getElementById('provEmail').value.trim();
      const pass = document.getElementById('provPass').value.trim();
      if(!email || !pass){ alert('Bitte E-Mail und Passwort eingeben.'); return; }
      provider.loggedIn = true;
      provider.email = email;
      save(LS.provider, provider);
      showProviderHome();
    };
  }

  const btnProvLogout = document.getElementById('btnProvLogout');
  if(btnProvLogout){
    btnProvLogout.onclick=()=>{
      provider.loggedIn=false;
      save(LS.provider, provider);
      setMode('customer');
      showProfile();
    };
  }

  // Rechtliches
  // --- AGB Onboarding Modal (1-Screen) ---
  function openAgbOnboardingModal(callback){
    const content = document.getElementById('agbOnboardingContent');
    if(!content) return;
    
    content.innerHTML = `
      <h2 style="font-size:20px; font-weight:900; margin-bottom:16px;">AGB (Kurzfassung)</h2>
      <div style="line-height:1.7; font-size:14px; max-height:60vh; overflow-y:auto; padding-right:8px;">
        <p><strong>Mittagio ist Plattform, nicht Verkäufer</strong></p>
        <p>Mittagio vermittelt Mittagsangebote lokaler Anbieter. Vertragspartner bei Bestellungen ist ausschließlich der jeweilige Anbieter.</p>
        
        <p style="margin-top:16px;"><strong>Kosten:</strong></p>
        <ul style="padding-left:20px; margin:8px 0;">
          <li>4,99 € zzgl. MwSt. pro Veröffentlichung</li>
          <li>0,89 € zzgl. MwSt. pro Online-Bestellung inkl. aller Bank- & Zahlungsgebühren (pro Bestellung, egal wie viele Gerichte)</li>
        </ul>
        
        <p style="margin-top:16px;"><strong>Abholcode:</strong></p>
        <p>Abholcode = Zahlungs- & Abholnachweis. Abwicklungsgebühr fällt auch bei Nicht-Abholung an.</p>
        
        <p style="margin-top:16px;"><strong>Verantwortung:</strong></p>
        <p>Anbieter ist verantwortlich für Inhalte/Speisen/gesetzliche Vorgaben.</p>
        
        <p style="margin-top:16px;"><strong>Support:</strong></p>
        <p><a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a></p>
      </div>
    `;
    
    document.getElementById('agbOnboardingBd').classList.add('active');
    document.getElementById('agbOnboardingSheet').classList.add('active');
    
    const acceptBtn = document.getElementById('btnAgbOnboardingAccept');
    const cancelBtn = document.getElementById('btnAgbOnboardingCancel');
    if(acceptBtn) acceptBtn.onclick = () => {
      closeAgbOnboardingModal();
      if(callback) callback(true);
    };
    if(cancelBtn) cancelBtn.onclick = () => {
      closeAgbOnboardingModal();
      if(callback) callback(false);
    };
  }
  
  function closeAgbOnboardingModal(){
    document.getElementById('agbOnboardingBd').classList.remove('active');
    document.getElementById('agbOnboardingSheet').classList.remove('active');
  }
  
  // --- Legal Sheets (Impressum, AGB, Datenschutz) ---
  function openLegalSheet(type){
    const content = document.getElementById('legalContent');
    if(!content) return;
    
    let html = '';
    let title = '';
    
    if(type === 'impressum'){
      title = 'Impressum';
      html = `
        <h3 style="margin:0 0 20px;">Impressum</h3>
        <div style="line-height:1.8;">
          <p style="font-weight:700; margin-bottom:12px;">Verantwortlich für den Inhalt:</p>
          <p>
            Mittagio<br>
            Inhaber: Mike Quach<br>
            Langäcker 2<br>
            73635 Rudersberg<br>
            Deutschland
          </p>
          <p style="margin-top:16px;">
            <strong>E-Mail:</strong> <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a>
          </p>
          <p style="margin-top:20px; padding-top:20px; border-top:1px solid #eee; font-size:13px; color:#666;">
            <strong>Unternehmensform:</strong> Einzelunternehmen<br>
            <strong>Umsatzsteuer-ID:</strong> nicht vorhanden (§19 UStG)
          </p>
          <p style="margin-top:16px; padding-top:16px; border-top:1px solid #eee; font-size:13px; color:#666;">
            <strong>Plattformhinweis:</strong><br>
            Mittagio vermittelt Mittagsangebote lokaler Anbieter. Vertragspartner bei Bestellungen ist ausschließlich der jeweilige Anbieter.
          </p>
        </div>
      `;
    } else if(type === 'agb'){
      title = 'Allgemeine Geschäftsbedingungen (Kunden)';
      html = `
        <h3 style="margin:0 0 20px;">Allgemeine Geschäftsbedingungen (Kunden)</h3>
        <div style="line-height:1.8; font-size:14px;">
          <p style="margin-bottom:16px;"><strong>1. Geltungsbereich</strong></p>
          <p style="margin-bottom:20px;">Diese Allgemeinen Geschäftsbedingungen (AGB) gelten für die Nutzung der Plattform Mittagio durch Kunden. Mittagio betreibt eine Plattform zur Vermittlung von Mittagsangeboten lokaler Anbieter.</p>
          
          <p style="margin-bottom:16px;"><strong>2. Rolle von Mittagio</strong></p>
          <p style="margin-bottom:20px;">Mittagio ist kein Restaurant und kein Lieferdienst. Mittagio vermittelt ausschließlich zwischen Kunden und Anbietern. Der Kaufvertrag kommt direkt zwischen dem Kunden und dem jeweiligen Anbieter zustande.</p>
          
          <p style="margin-bottom:16px;"><strong>3. Nutzung der Plattform</strong></p>
          <p style="margin-bottom:20px;">Die Nutzung ist grundsätzlich ohne Registrierung möglich. Kunden können Mittagsangebote auswählen und vorbestellen. Ein Anspruch auf Verfügbarkeit bestimmter Angebote besteht nicht.</p>
          
          <p style="margin-bottom:16px;"><strong>4. Bestellung & Abholung</strong></p>
          <p style="margin-bottom:20px;">Mit Abschluss der Bestellung erhält der Kunde einen Abholcode. Der Abholcode ist beim Anbieter vorzuzeigen. Die Abholung erfolgt innerhalb der vom Anbieter angegebenen Essenszeit.</p>
          
          <p style="margin-bottom:16px;"><strong>5. Preise & Bezahlung</strong></p>
          <p style="margin-bottom:20px;">Alle Preise werden vom Anbieter festgelegt. Die Bezahlung erfolgt direkt beim Anbieter vor Ort, sofern nicht anders angegeben. Mittagio erhebt aktuell keine Gebühren vom Kunden.</p>
          
          <p style="margin-bottom:16px;"><strong>6. Stornierung</strong></p>
          <p style="margin-bottom:20px;">Stornierungen sind abhängig von den Regelungen des jeweiligen Anbieters. Ein Anspruch auf Stornierung oder Rückerstattung über Mittagio besteht nicht.</p>
          
          <p style="margin-bottom:16px;"><strong>7. Haftung</strong></p>
          <p style="margin-bottom:20px;">Mittagio haftet nicht für Qualität, Menge oder Beschaffenheit der Speisen, Ausfälle, Verspätungen oder Änderungen durch den Anbieter, sowie Allergene oder Unverträglichkeiten. Für diese Punkte ist ausschließlich der jeweilige Anbieter verantwortlich.</p>
          
          <p style="margin-bottom:16px;"><strong>8. Verfügbarkeit</strong></p>
          <p style="margin-bottom:20px;">Mittagio bemüht sich um eine hohe Verfügbarkeit der Plattform, übernimmt jedoch keine Garantie für eine jederzeit unterbrechungsfreie Nutzung.</p>
          
          <p style="margin-bottom:16px;"><strong>9. Änderungen der AGB</strong></p>
          <p style="margin-bottom:20px;">Mittagio behält sich vor, diese AGB anzupassen, wenn sich Funktionen oder rechtliche Rahmenbedingungen ändern.</p>
          
          <p style="margin-bottom:16px;"><strong>10. Kontakt</strong></p>
          <p style="margin-bottom:20px;">Bei Fragen zur Nutzung der Plattform: <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a></p>
          
          <p style="margin-top:24px; padding-top:20px; border-top:1px solid #eee; font-size:12px; color:#666;">
            <strong>Stand:</strong> Januar 2026
          </p>
        </div>
      `;
    } else if(type === 'datenschutz'){
      title = 'Datenschutzerklärung';
      html = `
        <h3 style="margin:0 0 20px;">Datenschutzerklärung</h3>
        <div style="line-height:1.8; font-size:14px;">
          <p style="margin-bottom:16px;"><strong>1. Verantwortlicher</strong></p>
          <p style="margin-bottom:20px;">
            Verantwortlich für die Datenverarbeitung ist:<br><br>
            <strong>Mittagio</strong><br>
            Inhaber: Mike Quach<br>
            Langäcker 2<br>
            73635 Rudersberg<br>
            Deutschland<br><br>
            <strong>E-Mail:</strong> <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a>
          </p>
          
          <p style="margin-bottom:16px;"><strong>2. Allgemeines</strong></p>
          <p style="margin-bottom:20px;">Der Schutz deiner persönlichen Daten ist uns wichtig. Wir verarbeiten personenbezogene Daten nur im notwendigen Umfang und gemäß den geltenden Datenschutzgesetzen (DSGVO).</p>
          
          <p style="margin-bottom:16px;"><strong>3. Welche Daten wir verarbeiten</strong></p>
          <p style="margin-bottom:12px;"><strong>a) Bei der Nutzung der Plattform</strong></p>
          <p style="margin-bottom:20px;">Beim Besuch von Mittagio werden technisch notwendige Daten verarbeitet, z. B.:</p>
          <ul style="margin:0 0 20px 20px; padding-left:0;">
            <li style="margin-bottom:8px;">IP-Adresse (gekürzt/anonymisiert, sofern möglich)</li>
            <li style="margin-bottom:8px;">Datum und Uhrzeit des Zugriffs</li>
            <li style="margin-bottom:8px;">Browsertyp / Betriebssystem</li>
            <li style="margin-bottom:8px;">aufgerufene Seiten</li>
          </ul>
          <p style="margin-bottom:20px;">Diese Daten sind technisch erforderlich, um die Plattform bereitzustellen.</p>
          
          <p style="margin-bottom:12px;"><strong>b) Bei einer Bestellung</strong></p>
          <p style="margin-bottom:12px;">Wenn du ein Mittagsangebot bestellst, verarbeiten wir:</p>
          <ul style="margin:0 0 12px 20px; padding-left:0;">
            <li style="margin-bottom:8px;">ausgewähltes Gericht</li>
            <li style="margin-bottom:8px;">Anbieter</li>
            <li style="margin-bottom:8px;">Abholzeit (ungefähr)</li>
            <li style="margin-bottom:8px;">generierter Abholcode</li>
          </ul>
          <p style="margin-bottom:20px;">
            👉 Keine Pflicht zur Registrierung<br>
            👉 Keine Zahlungsdaten (Bezahlung erfolgt ggf. vor Ort beim Anbieter)
          </p>
          
          <p style="margin-bottom:12px;"><strong>c) Lokale Speicherung (PWA)</strong></p>
          <p style="margin-bottom:20px;">Bestellungen und Abholcodes werden lokal auf deinem Gerät gespeichert (z. B. im LocalStorage), damit du sie auch offline wieder anzeigen kannst. Diese Daten werden nicht automatisch an uns übertragen.</p>
          
          <p style="margin-bottom:16px;"><strong>4. Weitergabe von Daten</strong></p>
          <p style="margin-bottom:20px;">Deine Daten werden nur an den jeweiligen Anbieter weitergegeben, soweit dies zur Abwicklung deiner Bestellung erforderlich ist.</p>
          <p style="margin-bottom:20px;">Eine Weitergabe an Dritte erfolgt nicht, außer:</p>
          <ul style="margin:0 0 20px 20px; padding-left:0;">
            <li style="margin-bottom:8px;">es besteht eine gesetzliche Verpflichtung</li>
            <li style="margin-bottom:8px;">oder du hast ausdrücklich eingewilligt</li>
          </ul>
          
          <p style="margin-bottom:16px;"><strong>5. Cookies & Tracking</strong></p>
          <p style="margin-bottom:20px;">Mittagio verwendet keine Tracking-Cookies und kein Nutzer-Tracking zu Werbezwecken.</p>
          <p style="margin-bottom:20px;">Es werden ausschließlich technisch notwendige Speichermechanismen verwendet (z. B. für App-Funktionen).</p>
          
          <p style="margin-bottom:16px;"><strong>6. Hosting</strong></p>
          <p style="margin-bottom:20px;">Die Plattform wird über externe Hosting-Anbieter betrieben. Dabei können technisch notwendige Zugriffsdaten (z. B. IP-Adresse) verarbeitet werden, um den sicheren Betrieb zu gewährleisten.</p>
          
          <p style="margin-bottom:16px;"><strong>7. Deine Rechte</strong></p>
          <p style="margin-bottom:12px;">Du hast jederzeit das Recht auf:</p>
          <ul style="margin:0 0 12px 20px; padding-left:0;">
            <li style="margin-bottom:8px;">Auskunft über deine gespeicherten Daten</li>
            <li style="margin-bottom:8px;">Berichtigung unrichtiger Daten</li>
            <li style="margin-bottom:8px;">Löschung deiner Daten</li>
            <li style="margin-bottom:8px;">Einschränkung der Verarbeitung</li>
            <li style="margin-bottom:8px;">Widerspruch gegen die Verarbeitung</li>
          </ul>
          <p style="margin-bottom:20px;">Anfragen bitte per E-Mail an: <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a></p>
          
          <p style="margin-bottom:16px;"><strong>8. Änderungen dieser Datenschutzerklärung</strong></p>
          <p style="margin-bottom:20px;">Diese Datenschutzerklärung kann angepasst werden, wenn sich Funktionen oder gesetzliche Vorgaben ändern.</p>
          <p style="margin-bottom:20px;">Es gilt jeweils die auf dieser Seite veröffentlichte Version.</p>
          
          <p style="margin-top:24px; padding-top:20px; border-top:1px solid #eee; font-size:12px; color:#666;">
            <strong>9. Stand</strong><br>
            Stand: Januar 2026
          </p>
        </div>
      `;
    }
    
    content.innerHTML = html;
    document.getElementById('legalBd').classList.add('active');
    document.getElementById('legalSheet').classList.add('active');
  }
  
  function closeLegalSheet(){
    document.getElementById('legalBd').classList.remove('active');
    document.getElementById('legalSheet').classList.remove('active');
  }
  
  // FAQ Sheet
  function openFaqSheet(){
    const content = document.getElementById('faqSheetContent');
    if(!content) return;
    
    const allFaq = `
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Wie funktioniert Mittagio?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Du findest Mittagsangebote in deiner Stadt, optional bezahlst du online und holst zur gewählten Zeit ab.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Was ist der Abholcode?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Deine Abholnummer für die Mittagspause. Du erhältst sie nach erfolgreicher Online-Zahlung.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Muss ich online bezahlen?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Nein. Online-Zahlung ist optional. Eine Abholnummer gibt's nur bei Online-Zahlung.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Kann ich ohne Abholcode bestellen?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Nein. Angebote ohne Abholcode kannst du nur ansehen.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Wann kann ich abholen?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Innerhalb der Essenszeit. Wähle eine ungefähre Abholzeit in deiner Mittagsbox.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Kann ich für mehrere Personen bestellen?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Ja. Du kannst mehrere Gerichte in einem Vorgang bestellen (eine Abholnummer).</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Vor Ort essen möglich?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Wenn das Badge „Vor Ort" angezeigt wird, kannst du vor Ort essen.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Teilen</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Teile Angebote per WhatsApp, Instagram oder Website.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Kontakt</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Bei Fragen schreib uns an <a href="mailto:info@mittagio.de" style="color:var(--muted);">info@mittagio.de</a></p>
      </details>
    `;
    
    content.innerHTML = allFaq;
    document.getElementById('faqBd').classList.add('active');
    document.getElementById('faqSheet').classList.add('active');
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined') setTimeout(()=> lucide.createIcons(), 50);
  }
  
  function closeFaqSheet(){
    document.getElementById('faqBd').classList.remove('active');
    document.getElementById('faqSheet').classList.remove('active');
  }
  
  // Legal Links (alte IDs)
  const btnImpressum = document.getElementById('btnImpressum');
  if(btnImpressum) btnImpressum.onclick=()=>{ openLegalSheet('impressum'); };
  const btnAGB = document.getElementById('btnAGB');
  if(btnAGB) btnAGB.onclick=()=>{ openLegalSheet('agb'); };
  const btnDatenschutz = document.getElementById('btnDatenschutz');
  if(btnDatenschutz) btnDatenschutz.onclick=()=>{ openLegalSheet('datenschutz'); };
  
  // Profile Legal Links - öffnen statische Seiten
  const btnProfileImpressum = document.getElementById('btnProfileImpressum');
  if(btnProfileImpressum) btnProfileImpressum.onclick=(e)=>{ e.preventDefault(); showLegalPage('impressum'); };
  const btnProfileAGB = document.getElementById('btnProfileAGB');
  if(btnProfileAGB) btnProfileAGB.onclick=(e)=>{ e.preventDefault(); showLegalPage('agb-kurz'); };
  const btnProfileDatenschutz = document.getElementById('btnProfileDatenschutz');
  if(btnProfileDatenschutz) btnProfileDatenschutz.onclick=(e)=>{ e.preventDefault(); showLegalPage('datenschutz'); };
  
  // FAQ Expand Button (Text Link) - öffnet Modal
  const btnProfileShowMoreFaq = document.getElementById('btnProfileShowMoreFaq');
  if(btnProfileShowMoreFaq){
    btnProfileShowMoreFaq.onclick = (e) => {
      e.preventDefault();
      openFaqSheet();
    };
  }

  // Provider nav handlers
  document.getElementById('providerNav').addEventListener('click',(e)=>{
    const b = e.target.closest('button');
    if(!b) return;
    const go = b.dataset.pgo;
    if(go==='provider-home') showProviderHome();
    if(go==='provider-pickups') showProviderPickups();
    if(go==='provider-cookbook') showProviderCookbook();
    if(go==='provider-profile') showProviderProfile();
  });

  // Customer nav handlers - Robuster Event-Delegation-Ansatz
  document.addEventListener('click', function(e){
    // Prüfe ob Klick innerhalb von customerNav
    const nav = document.getElementById('customerNav');
    if(!nav || !nav.contains(e.target)) return;
    
    // Finde den Button (auch wenn auf Icon/Text geklickt wurde)
    let target = e.target;
    let btn = null;
    
    while(target && target !== nav){
      if(target.tagName === 'BUTTON' && target.classList.contains('navbtn')){
        btn = target;
        break;
      }
      target = target.parentElement;
    }
    
    if(!btn || !btn.dataset.go) return;
    
    const go = btn.dataset.go;
    e.preventDefault();
    e.stopPropagation();
    
    console.log('Navigation clicked:', go, 'mode:', mode);
    
    try {
      if(go==='discover'){
        if(mode === 'start'){
          showStart();
        } else {
          showDiscover();
        }
      } else if(go==='fav'){
        showFav();
      } else if(go==='orders'){
        showOrders();
      } else if(go==='profile'){
        showProfile();
      }
    } catch(err){
      console.error('Navigation error:', err, go);
      alert('Navigation-Fehler: ' + err.message);
    }
  }, true); // useCapture für frühere Event-Erfassung

  // --- Provider Dashboard (Home) - FINAL MVP ---
  let createFlowPreselectedDate = null; // Für Date-Preselect aus Today/Week
  
  // Zeit-Tracker Animation
  function animateTimeTracker(element, startHours, startMinutes, endHours, endMinutes){
    const duration = 1500; // 1.5 Sekunden
    const startTime = Date.now();
    const totalStartMinutes = startHours * 60 + startMinutes;
    const totalEndMinutes = endHours * 60 + endMinutes;
    const diff = totalEndMinutes - totalStartMinutes;
    
    function update(){
      const elapsed = Date.now() - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const easeOut = 1 - Math.pow(1 - progress, 3); // Ease-out cubic
      const currentMinutes = Math.round(totalStartMinutes + diff * easeOut);
      const currentHours = Math.floor(currentMinutes / 60);
      const currentMinutesRemainder = currentMinutes % 60;
      
      element.textContent = `${currentHours}h ${currentMinutesRemainder}min`;
      
      if(progress < 1){
        requestAnimationFrame(update);
      } else {
        element.textContent = `${endHours}h ${endMinutes}min`;
      }
    }
    
    update();
  }
  
  function renderProviderHome(){
    const profile = normalizeProviderProfile(provider.profile || {});
    const todayKey = isoDate(new Date());
    const mineAll = offers.filter(o => o.providerId === providerId());
    const mineActive = mineAll.filter(o => o.active !== false);
    const mineToday = mineActive.filter(o => o.day === todayKey);
    
    // Provider Identity Card
    const logoWrap = document.getElementById('provCardLogo');
    if(logoWrap){
      if(profile.logoData){
        logoWrap.innerHTML = `<img src="${esc(profile.logoData)}" alt="Logo" style="width:100%; height:100%; object-fit:cover; border-radius:14px;" />`;
      } else {
        const initials = (profile.name || provider.email || 'A').charAt(0).toUpperCase();
        logoWrap.innerHTML = `<div style="width:100%; height:100%; background:linear-gradient(135deg, var(--brand), var(--brand2)); display:flex; align-items:center; justify-content:center; border-radius:14px; font-size:24px; font-weight:900; color:#111;">${esc(initials)}</div>`;
      }
    }
    const nameEl = document.getElementById('provCardName');
    if(nameEl) nameEl.textContent = profile.name || provider.email || 'Anbieter';
    const addrEl = document.getElementById('provCardAddr');
    if(addrEl){
      const addr = buildAddress(profile);
      if(addr){
        addrEl.textContent = esc(addr);
        addrEl.style.color = 'var(--muted)';
      } else {
        addrEl.textContent = 'Adresse hinzufügen';
        addrEl.style.color = 'var(--brand)';
      }
    }
    
    const btnProviderEditProfile = document.getElementById('btnProviderEditProfile');
    if(btnProviderEditProfile){
      btnProviderEditProfile.textContent = buildAddress(profile) ? 'Profil bearbeiten' : 'Adresse hinzufügen';
      btnProviderEditProfile.onclick = () => {
        showProviderProfile();
      };
    }
    
      // KPI Cards (Dark Mode Styling)
      const activeOffersCount = mineActive.length;
      const todayPickups = loadOrders().filter(o => {
        const offer = offers.find(off => off.id === o.dishId || off.providerId === o.providerId);
        return offer && offer.providerId === providerId() && offer.day === todayKey && o.status === 'PAID';
      }).length;
      const cookbookCount = cookbook.length;
      
      // Zeit-Gewinn berechnen (Anzahl Abholungen * 3 Minuten)
      const allTimePickups = loadOrders().filter(o => {
        const offer = offers.find(off => off.id === o.dishId || off.providerId === o.providerId);
        return offer && offer.providerId === providerId() && o.status === 'PICKED_UP';
      }).length;
      const timeSavedMinutes = allTimePickups * 3;
      const timeSavedHours = Math.floor(timeSavedMinutes / 60);
      const timeSavedMinutesRemainder = timeSavedMinutes % 60;
      
      // Zeit-Gewinn-Tracker Widget aktualisieren
      const providerTimeTracker = document.getElementById('providerTimeTracker');
      const providerTimeSaved = document.getElementById('providerTimeSaved');
      if(providerTimeTracker && providerTimeSaved){
        // Animation beim ersten Laden: Von 0 hochzählen
        const isFirstLoad = !providerTimeSaved.dataset.animated;
        if(isFirstLoad && timeSavedHours === 0 && timeSavedMinutesRemainder === 0){
          // Animiertes Hochzählen von 0
          animateTimeTracker(providerTimeSaved, 0, 0, timeSavedHours, timeSavedMinutesRemainder);
          providerTimeSaved.dataset.animated = 'true';
        } else {
          providerTimeSaved.textContent = `${timeSavedHours}h ${timeSavedMinutesRemainder}min`;
        }
      }
      
      const kpiInserateCount = document.getElementById('kpiInserateCount');
      if(kpiInserateCount) {
        kpiInserateCount.textContent = activeOffersCount;
        kpiInserateCount.parentElement.style.background = '#2d2d2d';
        kpiInserateCount.parentElement.style.color = '#fff';
      }
      const kpiAbholungenCount = document.getElementById('kpiAbholungenCount');
      if(kpiAbholungenCount) {
        kpiAbholungenCount.textContent = todayPickups;
        kpiAbholungenCount.parentElement.style.background = '#2d2d2d';
        kpiAbholungenCount.parentElement.style.color = '#fff';
      }
      const kpiKochbuchCount = document.getElementById('kpiKochbuchCount');
      if(kpiKochbuchCount) {
        kpiKochbuchCount.textContent = cookbookCount;
        kpiKochbuchCount.parentElement.style.background = '#2d2d2d';
        kpiKochbuchCount.parentElement.style.color = '#fff';
      }
    
    // KPI Card Handlers
    const kpiCardInserate = document.getElementById('kpiCardInserate');
    if(kpiCardInserate) kpiCardInserate.onclick = () => {
      // Scroll to Active Offers section
      const activeOffers = document.getElementById('providerActiveOffers');
      if(activeOffers){
        activeOffers.scrollIntoView({behavior: 'smooth', block: 'start'});
      }
    };
    const kpiCardAbholungen = document.getElementById('kpiCardAbholungen');
    if(kpiCardAbholungen) kpiCardAbholungen.onclick = () => {
      showProviderPickups();
    };
    const kpiCardKochbuch = document.getElementById('kpiCardKochbuch');
    if(kpiCardKochbuch) kpiCardKochbuch.onclick = () => {
      showProviderCookbook();
    };
    
    // TODAY Card
    const providerTodayCard = document.getElementById('providerTodayCard');
    const providerTodayTitle = document.getElementById('providerTodayTitle');
    const providerTodayContent = document.getElementById('providerTodayContent');
    if(providerTodayCard && providerTodayTitle && providerTodayContent){
      const today = new Date();
      const weekday = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'][today.getDay()];
      const dateStr = `${today.getDate()}.${String(today.getMonth()+1).padStart(2,'0')}.`;
      providerTodayTitle.textContent = `Heute · ${weekday}, ${dateStr}`;
      
      if(mineToday.length > 0){
        const withCodeToday = mineToday.filter(o => o.hasPickupCode).length;
        const nextPickup = loadOrders().filter(o => {
          const offer = offers.find(off => off.id === o.dishId || off.providerId === o.providerId);
          return offer && offer.providerId === providerId() && offer.day === todayKey && o.status === 'PAID';
        }).sort((a,b) => (a.etaTime || '').localeCompare(b.etaTime || ''))[0];
        
        let html = `
          <div style="margin-bottom:12px;">
            <a href="#" id="providerTodayInserateLink" style="display:block; padding:10px; background:#f8f7f3; border-radius:12px; text-decoration:none; color:inherit; margin-bottom:8px;">
              <div style="font-weight:600; font-size:14px;">Inserate heute: ${mineToday.length}</div>
            </a>
            <a href="#" id="providerTodayPickupsLink" style="display:block; padding:10px; background:#f8f7f3; border-radius:12px; text-decoration:none; color:inherit;">
              <div style="font-weight:600; font-size:14px;">Abholungen heute: ${todayPickups}</div>
            </a>
        `;
        if(nextPickup && nextPickup.etaTime){
          const pickupCount = loadOrders().filter(o => {
            const offer = offers.find(off => off.id === o.dishId || off.providerId === o.providerId);
            return offer && offer.providerId === providerId() && offer.day === todayKey && o.status === 'PAID' && o.etaTime === nextPickup.etaTime;
          }).length;
          html += `
            <div style="margin-top:8px; padding:10px; background:#f8f7f3; border-radius:12px;">
              <div style="font-weight:600; font-size:14px;">Nächste Abholung: ${esc(nextPickup.etaTime)} (${pickupCount} ${pickupCount === 1 ? 'Code' : 'Codes'})</div>
            </div>
          `;
        }
        html += `</div>`;
        providerTodayContent.innerHTML = html;
        
        const providerTodayInserateLink = document.getElementById('providerTodayInserateLink');
        if(providerTodayInserateLink) providerTodayInserateLink.onclick = (e) => {
          e.preventDefault();
          // Scroll to Active Offers section (falls vorhanden)
          const activeOffers = document.getElementById('providerActiveOffers');
          if(activeOffers){
            activeOffers.scrollIntoView({behavior: 'smooth', block: 'start'});
          }
        };
        const providerTodayPickupsLink = document.getElementById('providerTodayPickupsLink');
        if(providerTodayPickupsLink) providerTodayPickupsLink.onclick = (e) => {
          e.preventDefault();
          showProviderPickups();
        };
      } else {
        providerTodayContent.innerHTML = `
          <div style="font-weight:600; font-size:16px; margin-bottom:8px; text-align:center;">Keine Inserate heute</div>
          <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:var(--muted); text-align:center;">
            Erstelle dein erstes Inserat für heute.
          </div>
          <button class="btn secondary" type="button" id="btnProviderTodayAddDish" style="width:100%; min-height:44px;">
            Inserat für heute erstellen
          </button>
        `;
        const btnProviderTodayAddDish = document.getElementById('btnProviderTodayAddDish');
        if(btnProviderTodayAddDish) btnProviderTodayAddDish.onclick = () => {
          // Unified Flow: Direkt mit Heute-Datum
          openDishFlow(todayKey);
        };
      }
    }
    
    // Active Offers Mini List (max 3, expandable)
    const providerActiveOffers = document.getElementById('providerActiveOffers');
    const providerActiveOffersList = document.getElementById('providerActiveOffersList');
    if(providerActiveOffers && providerActiveOffersList){
      const showAll = providerActiveOffers.dataset.showAll === 'true';
      const activeList = showAll ? mineActive : mineActive.slice(0, 3);
      if(activeList.length > 0){
        providerActiveOffers.style.display = 'block';
        providerActiveOffersList.innerHTML = activeList.map(o => {
          // Status-Badge: "LIVE · Online bezahlt" oder "LIVE · Vor Ort"
          let statusBadge = '';
          if(o.active !== false){
            if(o.hasPickupCode){
              statusBadge = '<span style="font-size:11px; padding:2px 8px; background:rgba(46,125,50,.12); border-radius:6px; color:#2e7d32; font-weight:600;">🟢 LIVE · Online bezahlt</span>';
            } else {
              statusBadge = '<span style="font-size:11px; padding:2px 8px; background:rgba(0,0,0,.06); border-radius:6px; color:#666; font-weight:600;">⚪ LIVE · Vor Ort</span>';
            }
          }
          
          // Verzehrart-Badges
          const badges = [];
          if(o.hasPickupCode) badges.push('<span style="font-size:11px; padding:2px 6px; background:rgba(255,204,0,.15); border-radius:6px; color:var(--brand);">Ticket</span>');
          if(o.dineInPossible) badges.push('<span style="font-size:11px; padding:2px 6px; background:rgba(31,157,85,.15); border-radius:6px; color:var(--brand2);">Vor Ort</span>');
          if(!o.dineInPossible && !o.hasPickupCode) badges.push('<span style="font-size:11px; padding:2px 6px; background:rgba(0,0,0,.06); border-radius:6px;">To Go</span>');
          
          // No-Limits: Prominenter "Ausverkauft" / "Noch da" Toggle direkt in der Liste
          const isActive = o.active !== false;
          const toggleBtn = isActive 
            ? `<button class="btn" type="button" data-offer-id="${esc(o.id)}" onclick="event.stopPropagation(); toggleOfferSoldOut('${esc(o.id)}');" style="background:#E34D4D; color:#fff; font-weight:700; padding:6px 12px; font-size:12px; min-height:32px; border-radius:8px; border:none; flex-shrink:0;">Ausverkauft</button>`
            : `<button class="btn" type="button" data-offer-id="${esc(o.id)}" onclick="event.stopPropagation(); toggleOfferSoldOut('${esc(o.id)}');" style="background:#4caf50; color:#fff; font-weight:700; padding:6px 12px; font-size:12px; min-height:32px; border-radius:8px; border:none; flex-shrink:0;">Wieder verfügbar</button>`;
          
          return `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 0; border-bottom:1px solid var(--border);">
              <div style="flex:1; min-width:0;" data-offer-id="${esc(o.id)}" style="cursor:pointer;">
                <div style="font-weight:600; font-size:14px; line-height:1.3; margin-bottom:4px;">${esc(o.dish || o.title || 'Gericht')}</div>
                <div style="font-size:12px; color:var(--muted); margin-bottom:6px;">${esc(o.pickupWindow || o.time || '')}</div>
                <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
                  ${statusBadge}
                  ${badges.join('')}
                </div>
              </div>
              <div style="display:flex; gap:8px; align-items:center; flex-shrink:0;">
                ${toggleBtn}
                <button class="btn ghost" type="button" data-offer-id="${esc(o.id)}" style="padding:8px; min-width:36px;" onclick="event.stopPropagation(); openOfferMoreMenu('${esc(o.id)}');">
                  ⋯
                </button>
              </div>
            </div>
          `;
        }).join('');
        
        // Tap on offer item
        providerActiveOffersList.querySelectorAll('[data-offer-id]').forEach(el => {
          if(el.tagName !== 'BUTTON'){
            el.onclick = () => {
              const offerId = el.dataset.offerId;
              startListingFlow({editOfferId: offerId});
            };
          }
        });
        
        const btnProviderShowAllOffers = document.getElementById('btnProviderShowAllOffers');
        if(btnProviderShowAllOffers){
          if(mineActive.length > 3){
            btnProviderShowAllOffers.style.display = 'inline-block';
            btnProviderShowAllOffers.onclick = (e) => {
              e.preventDefault();
              providerActiveOffers.dataset.showAll = 'true';
              renderProviderHome();
            };
          } else {
            btnProviderShowAllOffers.style.display = 'none';
          }
        }
      } else {
        providerActiveOffers.style.display = 'none';
      }
    }
    
    // Quick-Kill-Widget Handler
    const btnQuickKill = document.getElementById('btnQuickKill');
    if(btnQuickKill){
      btnQuickKill.onclick = () => {
        if(confirm('Möchtest du wirklich alle aktiven Inserate für heute schließen?')){
          const todayKey = isoDate(new Date());
          mineToday.forEach(o => {
            const offer = offers.find(off => off.id === o.id);
            if(offer){
              offer.active = false;
              save(LS.offers, offers);
            }
          });
          showToast('Alle Inserate für heute geschlossen');
          renderProviderHome();
        }
      };
    }
    
    // Week Preview
    renderProviderWeekPreviewNew();
    
    // Post-Onboarding Dashboard State (if just completed onboarding)
    const providerEmptyDashboard = document.getElementById('providerEmptyDashboard');
    if(providerEmptyDashboard){
      const hasAnyData = mineActive.length > 0 || cookbook.length > 0;
      const justCompletedOnboarding = provider.onboardingCompleted && !provider.onboardingShown && cookbook.length > 0;
      
      if(justCompletedOnboarding){
        // Show post-onboarding state
        providerEmptyDashboard.style.display = 'block';
        providerEmptyDashboard.innerHTML = `
          <div style="font-weight:600; font-size:18px; margin-bottom:8px; line-height:1.3;">Gericht erstellt</div>
          <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:var(--muted);">
            Dein Gericht ist gespeichert. Veröffentliche es, um sichtbar zu werden.
          </div>
          <button class="btn-primary" type="button" id="btnPostOnboardingPublish" style="width:100%; min-height:56px; margin-bottom:12px;">
            Gericht veröffentlichen
          </button>
          <button class="btn secondary" type="button" id="btnPostOnboardingPlan" style="width:100%; min-height:44px;">
            Weiter planen
          </button>
        `;
        
        const btnPublish = document.getElementById('btnPostOnboardingPublish');
        const btnPlan = document.getElementById('btnPostOnboardingPlan');
        if(btnPublish){
          const savedDish = cookbook.find(c => c.providerId === providerId());
          if(savedDish){
            btnPublish.onclick = () => {
              openDishFlow(); // Unified Flow: Heute
            };
          }
        }
        if(btnPlan) btnPlan.onclick = () => showProviderCookbook();
        
        // Mark onboarding as shown
        provider.onboardingShown = true;
        save(LS.provider, provider);
      } else {
        // Normal empty state
        providerEmptyDashboard.style.display = hasAnyData ? 'none' : 'block';
        if(!hasAnyData){
          providerEmptyDashboard.innerHTML = `
            <div style="font-weight:600; font-size:18px; margin-bottom:8px; line-height:1.3;">Willkommen bei Mittagio</div>
            <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:var(--muted);">
              Starte mit deinem ersten Gericht.
            </div>
            <button class="btn secondary" type="button" id="btnProviderEmptyAddDish" style="width:100%; min-height:44px;">
              Gericht hinzufügen
            </button>
          `;
        }
        
        const btnProviderEmptyAddDish = document.getElementById('btnProviderEmptyAddDish');
        if(btnProviderEmptyAddDish) btnProviderEmptyAddDish.onclick = () => {
          // Unified Flow: Ohne Datum = Heute
          openDishFlow();
        };
      }
    }
    
    // FAB
    const fabProviderAddOffer = document.getElementById('fabProviderAddOffer');
    const fabProviderAddOfferLabel = document.getElementById('fabProviderAddOfferLabel');
    if(fabProviderAddOffer){
      fabProviderAddOffer.onclick = () => {
        // Unified Flow: Ohne Datum = Heute
        openDishFlow();
      };
      fabProviderAddOffer.onmouseenter = () => {
        if(fabProviderAddOfferLabel) fabProviderAddOfferLabel.style.opacity = '1';
      };
      fabProviderAddOffer.onmouseleave = () => {
        if(fabProviderAddOfferLabel) fabProviderAddOfferLabel.style.opacity = '0';
      };
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined') setTimeout(()=> lucide.createIcons(), 50);
  }

  // Week Preview (7 Tage)
  function renderProviderWeekPreviewNew(){
    const dayWrap = document.getElementById('providerWeekDays');
    const dayContent = document.getElementById('providerWeekDayContent');
    if(!dayWrap || !dayContent) return;
    
    const today = new Date();
    let selectedDay = providerWeekDay || isoDate(today);
    
    dayWrap.innerHTML = '';
    for(let i=0; i<7; i++){
      const d = new Date(today);
      d.setDate(d.getDate() + i);
      const key = isoDate(d);
      const b = document.createElement('button');
      b.className = 'day' + (selectedDay === key ? ' active' : '');
      const weekday = ['So','Mo','Di','Mi','Do','Fr','Sa'][d.getDay()];
      const dateStr = `${d.getDate()}.${String(d.getMonth()+1).padStart(2,'0')}.`;
      b.textContent = i === 0 ? 'Heute' : `${weekday}, ${dateStr}`;
      b.onclick = () => {
        providerWeekDay = key;
        renderProviderWeekPreviewNew();
      };
      dayWrap.appendChild(b);
    }
    
    // Day Content
    const offersForDay = offers.filter(o => o.providerId === providerId() && o.active !== false && o.day === selectedDay);
    const weekEntries = (week[selectedDay] || []).filter(x => x.providerId === providerId() && x.active !== false);
    const totalPlanned = offersForDay.length + weekEntries.length;
    
    if(totalPlanned > 0){
      dayContent.innerHTML = `
        <div style="padding:12px; background:#f8f7f3; border-radius:12px; margin-bottom:12px;">
          <div style="font-weight:600; font-size:14px; margin-bottom:8px;">${totalPlanned} ${totalPlanned === 1 ? 'Inserat' : 'Inserate'} geplant</div>
          <div style="font-size:13px; color:var(--muted); margin-bottom:12px;">${offersForDay.length} aktiv, ${weekEntries.length} im Wochenplan</div>
        </div>
        <button class="btn secondary" type="button" id="btnProviderWeekAddDish" style="width:100%; min-height:44px;">
          Inserat für diesen Tag hinzufügen
        </button>
      `;
      const btnProviderWeekAddDish = document.getElementById('btnProviderWeekAddDish');
      if(btnProviderWeekAddDish) btnProviderWeekAddDish.onclick = () => {
        createFlowPreselectedDate = selectedDay;
        openCreateFlowSheet();
      };
    } else {
      dayContent.innerHTML = `
        <div style="font-weight:600; font-size:16px; margin-bottom:8px; text-align:center;">Keine Inserate geplant</div>
        <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:var(--muted); text-align:center;">
          Erstelle ein Inserat für diesen Tag.
        </div>
        <button class="btn secondary" type="button" id="btnProviderWeekAddDishEmpty" style="width:100%; min-height:44px;">
          Inserat für diesen Tag erstellen
        </button>
      `;
      const btnProviderWeekAddDishEmpty = document.getElementById('btnProviderWeekAddDishEmpty');
      if(btnProviderWeekAddDishEmpty) btnProviderWeekAddDishEmpty.onclick = () => {
        createFlowPreselectedDate = selectedDay;
        openCreateFlowSheet();
      };
    }
  }
  
  // Legacy function (für Kompatibilität)
  function renderProviderWeekPreview(){
    const dayWrap = document.getElementById('provWeekDays');
    const list = document.getElementById('provWeekPreview');
    if(!dayWrap || !list) return;

    dayWrap.innerHTML = '';
    for(let i=0;i<5;i++){
      const d = new Date(); d.setDate(d.getDate()+i);
      const key = isoDate(d);
      const b = document.createElement('button');
      b.className = 'day' + (providerWeekDay===key ? ' active' : '');
      b.textContent = fmtDay(d);
      b.onclick=()=>{ providerWeekDay = key; renderProviderWeekPreview(); };
      dayWrap.appendChild(b);
    }

    const items = (week[providerWeekDay]||[]).filter(x=>x.providerId===providerId() && x.active !== false);
    if(!items.length){
      list.innerHTML = `
        <div>Keine Inserate geplant.</div>
        <div style="height:8px"></div>
        <button class="btn secondary" type="button" id="btnWeekAdd">Inserat hinzufügen</button>
      `;
      const addBtn = document.getElementById('btnWeekAdd');
      if(addBtn) addBtn.onclick=()=> startListingFlow({});
      return;
    }
    list.innerHTML = items.map(i=>`• ${esc(i.dish)}`).join('<br>');
  }

  function renderWeekPlan(){
    const dayWrap = document.getElementById('weekDays');
    const list = document.getElementById('weekList');
    if(!dayWrap || !list) return;

    dayWrap.innerHTML = '';
    for(let i=0;i<5;i++){
      const d = new Date(); d.setDate(d.getDate()+i);
      const key = isoDate(d);
      const b = document.createElement('button');
      b.className = 'day' + (weekPlanDay===key ? ' active' : '');
      b.textContent = fmtDay(d);
      b.onclick=()=>{ weekPlanDay = key; renderWeekPlan(); };
      dayWrap.appendChild(b);
    }

    const dayEntries = week[weekPlanDay] || [];
    const providerEntries = dayEntries
      .map((entry, idx)=>({entry, idx}))
      .filter(x=>x.entry.providerId===providerId());

    if(!providerEntries.length){
      list.innerHTML = `
        <div style="font-weight:600; font-size:16px; margin-bottom:8px;">Keine Inserate geplant</div>
        <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:var(--muted);">
          Plane deine Woche und erstelle Inserate.
        </div>
        <button class="btn secondary" type="button" id="btnWeekEmptyAdd" style="width:100%; min-height:44px;">
          Inserat erstellen
        </button>
      `;
      const btnWeekEmptyAdd = document.getElementById('btnWeekEmptyAdd');
      if(btnWeekEmptyAdd) btnWeekEmptyAdd.onclick = () => {
        createFlowPreselectedDate = weekPlanDay;
        openCreateFlowSheet();
      };
      // Hide PDF button in empty state
      const btnWeekPdf = document.getElementById('btnWeekPdf');
      if(btnWeekPdf) btnWeekPdf.style.display = 'none';
      return;
    }

    // Show PDF button only when there are entries
    const btnWeekPdf = document.getElementById('btnWeekPdf');
    if(btnWeekPdf) btnWeekPdf.style.display = 'block';
    
    list.innerHTML = '';
    providerEntries.forEach(({entry, idx})=>{
      const cb = cookbook.find(c=>c.id===entry.cookbookId);
      const name = cb?.dish || entry.dish || 'Gericht';
      const price = cb?.price || 0;
      const isActive = entry.active !== false;

      const item = document.createElement('div');
      item.className = 'cookbook-item';
      item.innerHTML = `
        <div style="font-weight:900">${esc(name)}</div>
        <div class="hint">${euro(price)} - ${isActive ? 'Aktiv' : 'Inaktiv'}</div>
      `;

      const actions = document.createElement('div');
      actions.className = 'cookbook-actions';

      const edit = document.createElement('button');
      edit.type='button';
      edit.className='ans';
      edit.textContent='Bearbeiten';
      edit.onclick=()=>{ if(entry.cookbookId) startWizard('cookbook', {editId: entry.cookbookId}); };

      const toggle = document.createElement('button');
      toggle.type='button';
      toggle.className='ans';
      toggle.textContent = isActive ? 'Deaktivieren' : 'Aktivieren';
      toggle.onclick=()=>{
        const updated = (week[weekPlanDay]||[]).map((x,i)=> i===idx ? {...x, active: !(x.active !== false)} : x);
        if(updated.length) week[weekPlanDay]=updated; else delete week[weekPlanDay];
        save(LS.week, week);
        renderWeekPlan();
        renderProviderWeekPreview();
      };

      const share = document.createElement('button');
      share.type='button';
      share.className='ans';
      share.textContent='Teilen';
      share.onclick=()=>{ shareOffer({dish:name, price}); };

      const print = document.createElement('button');
      print.type='button';
      print.className='ans';
      print.textContent='Drucken';
      print.onclick=()=>{
        const profile = normalizeProviderProfile(provider.profile || {});
        const offer = normalizeOffer({
          providerId: providerId(),
          providerName: profile.name || provider.email || 'Anbieter',
          providerStreet: profile.street||'',
          providerZip: profile.zip||'',
          providerCity: profile.city||'',
          providerLogoData: profile.logoData||'',
          dish: name,
          category: cb?.category || 'Vegetarisch',
          price: Number(price||0),
          pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
          hasPickupCode: !!cb?.hasPickupCode,
          dineInPossible: !!cb?.dineInPossible,
          imageUrl: cb?.photoData || ''
        });
        printOffer(offer);
      };

      actions.appendChild(edit);
      actions.appendChild(toggle);
      actions.appendChild(share);
      actions.appendChild(print);
      item.appendChild(actions);
      list.appendChild(item);
    });
  }

  function pickupCodeCount(dish){
    const base = String(dish||'').split('').reduce((sum, ch)=>sum + ch.charCodeAt(0), 0);
    return 2 + (base % 4); // 2..5
  }

  // Build pickup list (single list, no grouping)
  // Single source of truth: Order record (ordersStore)
  function buildPickupList(){
    const todayKey = isoDate(new Date());
    const providerIdVal = providerId();
    
    // Load from shared ordersStore (localStorage)
    const ordersList = loadOrders();
    
    // Filter: providerId + pickupDate + status=PAID (default "Offen")
    const todayOrders = ordersList.filter(o => {
      // Must be for this provider
      if(o.providerId !== providerIdVal) return false;
      
      // Must be PAID with pickupCode
      if(o.status !== 'PAID' || !o.pickupCode) return false;
      
      // Check pickupDate (from order - single source of truth)
      const orderPickupDate = o.pickupDate;
      if(orderPickupDate){
        return orderPickupDate === todayKey;
      }
      
      // Fallback: check offer.day (for legacy orders)
      const offer = offers.find(off => off.id === o.dishId || off.id === o.offerId);
      return offer && offer.day === todayKey;
    });
    
    if(!todayOrders.length) return [];
    
    // Map orders to pickup items (simple list, no grouping)
    return todayOrders.map(order => {
      // Check status (single source of truth: Order record)
      const isPickedUp = order.status === 'PICKED_UP' || order.status === 'COMPLETED' || order.pickupStatus === 'PICKED_UP';
      
      return {
        orderId: order.id,
        code: order.pickupCode || order.code || '',
        dishName: order.dishName || 'Gericht',
        pickupTime: order.pickupWindow || order.etaTime || '',
        status: isPickedUp ? 'PICKED_UP' : 'OPEN',
        order: order
      };
    });
  }

  function renderProviderPickups(){
    const subheader = document.getElementById('provPickupsSubheader');
    const filterEl = document.getElementById('provPickupFilter');
    const empty = document.getElementById('provPickupsEmpty');
    const listEl = document.getElementById('provPickupsList');
    if(!subheader || !filterEl || !empty || !listEl) return;

    // Subheader: "Heute · {weekday, date}"
    const today = new Date();
    const weekday = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'][today.getDay()];
    const dateStr = `${today.getDate()}.${String(today.getMonth()+1).padStart(2,'0')}.`;
    subheader.textContent = `Heute · ${weekday}, ${dateStr}`;

    // Get all pickups
    const allPickups = buildPickupList();
    
    // Filter pickups
    const filteredPickups = allPickups.filter(p => {
      if(pickupFilter === 'offen') return p.status === 'OPEN';
      if(pickupFilter === 'abgeholt') return p.status === 'PICKED_UP';
      return true;
    });

    // Filter Toggle
    filterEl.innerHTML='';
    [
      {id:'offen', label:'Bezahlt'},
      {id:'abgeholt', label:'Abgeholt'}
    ].forEach(f=>{
      const b=document.createElement('button');
      b.type='button';
      b.className='ans'+(pickupFilter===f.id?' on':'');
      b.textContent=f.label;
      b.onclick=()=>{ pickupFilter=f.id; renderProviderPickups(); };
      filterEl.appendChild(b);
    });

    // Empty States
    if(!allPickups.length){
      empty.style.display='block';
      empty.innerHTML = `
        <div style="font-weight:600; font-size:16px; margin-bottom:8px;">Keine Abholungen</div>
        <div style="font-size:14px; line-height:1.4; color:var(--muted);">Heute gibt es noch keine Abholungen.</div>
      `;
      listEl.style.display='none';
      return;
    }
    
    if(!filteredPickups.length){
      empty.style.display='block';
      if(pickupFilter === 'offen'){
        empty.innerHTML = `
          <div style="font-weight:600; font-size:16px; margin-bottom:8px;">Alles erledigt</div>
          <div style="font-size:14px; line-height:1.4; color:var(--muted);">Alle Abholungen sind abgeschlossen.</div>
        `;
      } else {
        empty.innerHTML = `
          <div style="font-weight:600; font-size:16px; margin-bottom:8px;">Keine abgeholten Bestellungen</div>
          <div style="font-size:14px; line-height:1.4; color:var(--muted);">Noch keine Bestellungen als abgeholt markiert.</div>
        `;
      }
      listEl.style.display='none';
      return;
    }
    
    empty.style.display='none';
    listEl.style.display='none'; // Grid hat Priorität

    // Sort pickups: Zuerst nach Abholzeit (früheste zuerst), dann nach Code-Reihenfolge
    const list = [...filteredPickups];
    list.sort((a, b) => {
      // Priorität 1: Abholzeit (früheste zuerst)
      const aTime = a.pickupTime || a.etaTime || '';
      const bTime = b.pickupTime || b.etaTime || '';
      if(aTime && bTime){
        // Parse time (z.B. "11:30" -> 1130)
        const parseTime = (timeStr) => {
          const match = String(timeStr).match(/(\d{1,2}):(\d{2})/);
          if(!match) return 9999; // Späteste Zeit
          return parseInt(match[1], 10) * 100 + parseInt(match[2], 10);
        };
        const aTimeNum = parseTime(aTime);
        const bTimeNum = parseTime(bTime);
        if(aTimeNum !== bTimeNum) return aTimeNum - bTimeNum;
      }
      
      // Priorität 2: Code-Reihenfolge (1A, 1B, 1C, 2A, 2B, 2C, 10A, 10B...)
      const parseCode = (code) => {
        const match = String(code || '').match(/^(\d+)([A-Z])$/);
        if(!match) return {num: 9999, letter: 'Z'};
        return {num: parseInt(match[1], 10), letter: match[2]};
      };
      const aCode = parseCode(a.code);
      const bCode = parseCode(b.code);
      
      if(aCode.num !== bCode.num) return aCode.num - bCode.num;
      return aCode.letter.localeCompare(bCode.letter);
    });

    // Render Grid (Theken-Grid) - Große Kacheln
    const gridEl = document.getElementById('provPickupsGrid');
    if(gridEl){
      gridEl.style.display = filteredPickups.length > 0 ? 'grid' : 'none';
      gridEl.innerHTML = '';
      
      list.forEach(p=>{
        const isPickedUp = p.status === 'PICKED_UP';
        const tile = document.createElement('div');
        tile.className = 'pickup-tile' + (isPickedUp ? ' picked-up' : '');
        
        // Farbleitsystem: Gelb/Orange für neue, Grau für abgeholt
        const bgColor = isPickedUp ? '#2d2d2d' : '#FFB800';
        const textColor = isPickedUp ? 'rgba(255,255,255,0.5)' : '#2D3436';
        const borderColor = isPickedUp ? 'rgba(255,255,255,0.1)' : 'rgba(255,184,0,0.5)';
        
        // Theken-Optimierung: Größere Kacheln für 1m Entfernung
        tile.style.cssText = `
          aspect-ratio: 1;
          background:${bgColor};
          border:4px solid ${borderColor};
          border-radius:24px;
          display:flex;
          flex-direction:column;
          align-items:center;
          justify-content:center;
          padding:24px;
          cursor:${isPickedUp ? 'default' : 'pointer'};
          transition:all 0.2s ease;
          box-shadow:0 6px 24px rgba(0,0,0,0.3);
          min-height:180px;
        `;
        
        tile.innerHTML = `
          <div style="font-size:72px; font-weight:900; font-family:monospace; color:${textColor}; margin-bottom:16px; line-height:1; letter-spacing:2px;">
            ${esc(p.code)}
          </div>
          <div style="font-size:16px; font-weight:700; color:${textColor}; text-align:center; margin-bottom:8px; line-height:1.3;">
            ${esc(p.dishName)}
          </div>
          <div style="font-size:13px; color:${textColor}; opacity:0.8; text-align:center;">
            ${esc(p.pickupTime || '')}
          </div>
        `;
        
        if(!isPickedUp){
          // Micro-Interaction: Scale-Effekt bei Klick
          tile.style.cursor = 'pointer';
          tile.addEventListener('mousedown', () => {
            tile.style.transform = 'scale(0.95)';
          });
          tile.addEventListener('mouseup', () => {
            tile.style.transform = 'scale(1)';
          });
          tile.addEventListener('mouseleave', () => {
            tile.style.transform = 'scale(1)';
          });
          
          // Tap-to-Complete: Ein-Hand-Check-in (USP)
          tile.onclick = () => {
            // Haptisches Feedback
            if(navigator.vibrate){
              navigator.vibrate([50, 30, 50]);
            }
            
            // Visuelles Feedback: Grüner Flash (Smooth-Move Animation)
            const originalBg = tile.style.background;
            const originalBorder = tile.style.borderColor;
            tile.style.background = '#4caf50';
            tile.style.borderColor = '#4caf50';
            tile.style.transform = 'scale(0.92)';
            tile.style.transition = 'all 0.3s ease-out';
            
            // Nach 200ms: Smooth-Move aus der Liste (Fade-out)
            setTimeout(() => {
              tile.style.opacity = '0';
              tile.style.transform = 'scale(0.8) translateY(-20px)';
            }, 200);
            
            // Markiere als abgeholt
            const order = getOrderById(p.orderId);
            if(order){
              updateOrder(p.orderId, {
                status: 'PICKED_UP',
                pickupStatus: 'PICKED_UP',
                completedAt: Date.now()
              });
              
              // Toast (kurz)
              showToast(`✓ ${p.code}`, 2000);
              
              // Neu rendern nach Animation
              setTimeout(() => {
                renderProviderPickups();
              }, 400);
            }
          };
        }
        
        gridEl.appendChild(tile);
      });
    }
    
    // Render list (Legacy, falls Grid nicht verfügbar)
    listEl.innerHTML='';
    listEl.style.display = gridEl ? 'none' : (filteredPickups.length > 0 ? 'block' : 'none');
    list.forEach(p=>{
      const isPickedUp = p.status === 'PICKED_UP';
      const row = document.createElement('div');
      row.className = 'pickup-row' + (isPickedUp ? ' picked-up' : '');
      row.style.cssText = 'display:flex; align-items:center; gap:16px; padding:16px; border-bottom:1px solid var(--border); ' + (isPickedUp ? 'opacity:0.5; background:#f8f8f8;' : 'cursor:pointer;');
      row.innerHTML = `
        <div style="font-size:48px; font-weight:900; font-family:monospace; color:var(--brand); min-width:90px; text-align:center; line-height:1; letter-spacing:2px;">
          ${esc(p.code)}
        </div>
        <div style="flex:1; min-width:0;">
          <div style="font-weight:600; font-size:16px; line-height:1.3; margin-bottom:6px;">${esc(p.dishName)}</div>
          <div style="font-size:14px; color:var(--muted); margin-bottom:6px;">${esc(p.pickupTime || '')}</div>
          <div style="font-size:13px; color:${isPickedUp ? 'var(--muted)' : '#2e7d32'}; font-weight:500; display:flex; align-items:center; gap:4px;">
            ${isPickedUp ? '✅ Abgeholt' : '🟢 Bezahlt'}
          </div>
        </div>
      `;
      if(!isPickedUp){
        row.onclick = () => {
          // Tap-to-Complete: Ein-Hand-Check-in (USP)
          // Haptisches Feedback
          if(navigator.vibrate){
            navigator.vibrate([50, 30, 50]);
          }
          
          // Visuelles Feedback: Grüner Flash
          const originalBg = row.style.background;
          row.style.background = '#4caf50';
          row.style.transition = 'all 0.3s ease-out';
          setTimeout(() => {
            row.style.opacity = '0';
            row.style.transform = 'translateX(-20px)';
          }, 200);
          
          const order = getOrderById(p.orderId);
          if(order){
            updateOrder(p.orderId, {
              status: 'PICKED_UP',
              pickupStatus: 'PICKED_UP',
              completedAt: Date.now()
            });
            showToast(`✓ ${p.code}`, 2000);
            setTimeout(() => renderProviderPickups(), 400);
          }
        };
      }
      listEl.appendChild(row);
    });
  }
  
  // Pickup Confirmation Sheet
  let currentPickupConfirmOrderId = null;
  
  function openPickupConfirmSheet(orderId, code, dishName){
    currentPickupConfirmOrderId = orderId;
    const codeEl = document.getElementById('pickupConfirmCode');
    const dishEl = document.getElementById('pickupConfirmDish');
    if(codeEl) codeEl.textContent = code;
    if(dishEl) dishEl.textContent = dishName;
    
    document.getElementById('pickupConfirmBd').classList.add('active');
    document.getElementById('pickupConfirmSheet').classList.add('active');
  }
  
  function closePickupConfirmSheet(){
    document.getElementById('pickupConfirmBd').classList.remove('active');
    document.getElementById('pickupConfirmSheet').classList.remove('active');
    currentPickupConfirmOrderId = null;
  }
  
  // Pickup Confirmation Handlers
  const btnPickupConfirmYes = document.getElementById('btnPickupConfirmYes');
  if(btnPickupConfirmYes){
    btnPickupConfirmYes.onclick = () => {
      if(!currentPickupConfirmOrderId) return;
      
      const order = getOrderById(currentPickupConfirmOrderId);
      if(!order) return;
      
      // Mark as picked up (status = PICKED_UP)
      // Single source of truth: Order record in ordersStore
      updateOrder(currentPickupConfirmOrderId, {
        status: 'PICKED_UP', // Use PICKED_UP as status
        pickupStatus: 'PICKED_UP',
        completedAt: Date.now()
      });
      
      closePickupConfirmSheet();
      renderProviderPickups();
      
      // Show toast
      showToast(`Abholung ${order.pickupCode || order.code || ''} bestätigt`);
    };
  }
  
  const btnPickupConfirmNo = document.getElementById('btnPickupConfirmNo');
  if(btnPickupConfirmNo){
    btnPickupConfirmNo.onclick = () => {
      closePickupConfirmSheet();
    };
  }

  function showPickupUndo(key){
    pickupUndoKey = key;
    const snack = document.getElementById('pickupUndo');
    if(!snack) return;
    const label = document.getElementById('pickupUndoLabel');
    if(label) label.textContent = 'Abholung markiert';
    const btn = document.getElementById('pickupUndoBtn');
    if(btn){
      btn.onclick=()=>{
        if(pickupUndoKey && pickupDone.has(pickupUndoKey)){
          pickupDone.delete(pickupUndoKey);
          save(LS.pickupDone, Array.from(pickupDone));
          renderProviderPickups();
        }
        hidePickupUndo();
      };
    }
    snack.classList.add('active');
    if(pickupUndoTimer) clearTimeout(pickupUndoTimer);
    pickupUndoTimer = setTimeout(hidePickupUndo, 5000);
  }

  function hidePickupUndo(){
    const snack = document.getElementById('pickupUndo');
    if(!snack) return;
    snack.classList.remove('active');
    pickupUndoKey = null;
  }

  function renderProviderProfile(){
    const p = normalizeProviderProfile(provider.profile || {});
    const addr = buildAddress(p);
    const parsed = parseAddress(p.address || '');
    const city = p.city || parsed.city || '';
    const name = p.name || provider.email || '';
    
    // Kontaktkarte rendern (nur wenn Daten vorhanden)
    const contactCardEl = document.getElementById('providerContactCardContent');
    if(contactCardEl){
      const hasData = name || addr || p.mealWindow || p.phone || p.email;
      if(hasData){
        let html = '<div style="display:flex; align-items:flex-start; gap:16px;">';
        
        // Logo (wenn vorhanden)
        if(p.logoData){
          html += `<div class="plogo" style="width:64px; height:64px; border-radius:16px; flex-shrink:0; overflow:hidden;">
            <img src="${p.logoData}" alt="Logo" style="width:100%; height:100%; object-fit:cover;" />
          </div>`;
        }
        
        html += '<div style="flex:1; min-width:0;">';
        
        // Name (wenn vorhanden)
        if(name){
          html += `<div style="font-weight:900; font-size:18px; line-height:1.3; margin-bottom:8px;">${esc(name)}</div>`;
        }
        
        // Adresse (wenn vorhanden)
        if(addr){
          html += `<div style="font-size:14px; color:var(--muted); margin-bottom:6px; display:flex; align-items:center; gap:6px;">
            ${iconMarkup('map-pin', {size:16})} <span>${esc(addr)}</span>
          </div>`;
        }
        
        // Abholzeiten (wenn vorhanden)
        if(p.mealWindow){
          html += `<div style="font-size:14px; color:var(--muted); margin-bottom:6px; display:flex; align-items:center; gap:6px;">
            ${iconMarkup('clock', {size:16})} <span>${esc(p.mealWindow)}</span>
          </div>`;
        }
        
        // Telefon (wenn vorhanden)
        if(p.phone){
          html += `<div style="font-size:14px; color:var(--muted); margin-bottom:6px; display:flex; align-items:center; gap:6px;">
            ${iconMarkup('phone', {size:16})} <span>${esc(p.phone)}</span>
          </div>`;
        }
        
        // E-Mail (wenn vorhanden)
        if(p.email){
          html += `<div style="font-size:14px; color:var(--muted); display:flex; align-items:center; gap:6px;">
            ${iconMarkup('mail', {size:16})} <span>${esc(p.email)}</span>
          </div>`;
        }
        
        html += '</div></div>';
        contactCardEl.innerHTML = html;
        
        // Icons aktualisieren
        if(typeof lucide !== 'undefined'){
          setTimeout(() => lucide.createIcons(), 50);
        }
      } else {
        contactCardEl.innerHTML = '';
      }
    }
  }

  function renderBilling(){
    // Kosten-Info-Box (ganz oben) - Neue Terminologie
    const costInfoEl = document.getElementById('billingCostInfo');
    if(costInfoEl){
      costInfoEl.innerHTML = `
        <div style="font-weight:600; font-size:16px; margin-bottom:12px; color:#2e7d32;">Gebühren – kurz erklärt</div>
        <div style="font-size:14px; line-height:1.6; color:#333; margin-bottom:8px;">
          <div style="margin-bottom:8px;">
            <strong>Inseratsgebühr: 4,99 €</strong> (einmalig pro Gericht)
          </div>
          <div>
            <strong>All-In Erfolgsgebühr: 0,89 €</strong> pro verkaufter Abholnummer<br>
            <span style="font-size:12px; color:#666; font-style:italic;">
              Beinhaltet bereits alle Bank-, Stripe- und Verwaltungsgebühren
            </span>
          </div>
        </div>
        <div style="margin-top:12px; padding:12px; background:rgba(31,157,85,0.1); border-radius:12px; border-left:4px solid #1f9d55;">
          <div style="font-size:13px; color:#2D3436; font-weight:600; margin-bottom:4px;">💡 Wichtig:</div>
          <div style="font-size:12px; color:#666; line-height:1.5;">
            Alle Beträge sind Netto-Auszahlungen inkl. abgegoltenen Transaktionsgebühren.
          </div>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <a href="#/datenschutz" onclick="showLegalPage('datenschutz'); return false;" style="font-size:13px; color:var(--brand); text-decoration:none;">Datenschutz</a>
        </div>
      `;
    }
    
    const amountEl = document.getElementById('billingAmount');
    const lastEl = document.getElementById('billingLast');
    const filtersEl = document.getElementById('billingFilters');
    const monthEl = document.getElementById('billingMonth');
    const listEl = document.getElementById('billingList');
    if(!amountEl || !lastEl || !filtersEl || !monthEl || !listEl) return;

    // Demo-Daten: Berechnung nach Formel (Verkaufspreis - 0,89 € pro Abholnummer)
    // Beispiel: 18 Verkäufe à 8,50 € = 153,00 € Gesamt
    // Gebühren: 18 × 0,89 € = 16,02 €
    // Auszahlung: 153,00 € - 16,02 € = 136,98 €
    const demo = [
      {range:'06.01.–12.01.2026', sales:18, total:153.00, fee:16.02, payout:136.98, status:'Nächste Auszahlung geplant'},
      {range:'30.12.–05.01.2026', sales:12, total:102.00, fee:10.68, payout:91.32, status:'Auszahlung erfolgt'}
    ];

    amountEl.textContent = euro(demo[0].payout);
    lastEl.textContent = `Letzte Auszahlung: ${demo[1].range} · ${euro(demo[1].payout)}`;

    const filters = [
      {id:'today', label:'Heute'},
      {id:'week', label:'Woche'},
      {id:'month', label:'Monat'},
      {id:'custom', label:'Benutzerdefiniert'}
    ];
    filtersEl.innerHTML = '';
    filters.forEach(f=>{
      const b=document.createElement('button');
      b.type='button';
      b.className='ans'+(billingFilter===f.id?' on':'');
      b.textContent=f.label;
      b.onclick=()=>{ billingFilter = f.id; renderBilling(); };
      filtersEl.appendChild(b);
    });

    monthEl.value = billingMonth;
    monthEl.onchange = ()=>{ billingMonth = monthEl.value; renderBilling(); };

    listEl.innerHTML = demo.map(d=>`
      <div class="cookbook-item">
        <div style="font-weight:900">${esc(d.range)}</div>
        <div class="cookbook-facts">
          Abholnummern verkauft: ${d.sales} · Gesamtumsatz: ${euro(d.total)}<br>
          All-In Erfolgsgebühren: ${euro(d.fee)} · <b>Auszahlung: ${euro(d.payout)}</b><br>
          <span style="font-size:11px; color:#666;">Netto-Auszahlung inkl. abgegoltenen Transaktionsgebühren</span><br>
          Status: ${esc(d.status)}
        </div>
        <div class="cookbook-actions">
          <button class="card-action" type="button" data-icon="print">PDF-Download</button>
        </div>
      </div>
    `).join('');
    listEl.querySelectorAll('button').forEach(btn=>{
      btn.onclick=()=> alert('PDF-Download (Demo).');
    });
    applyStaticIcons();
  }

  const btnProvFaq = document.getElementById('btnProvFaq');
  if(btnProvFaq){
    btnProvFaq.onclick=()=>{
      // Navigiere zu FAQ (öffnet FAQ Sheet)
      openFaqSheet();
    };
  }

  const btnBilling = document.getElementById('btnBilling');
  if(btnBilling){
    btnBilling.onclick=()=>{
      showView(views.providerBilling);
      renderBilling();
      // Browser-Verlauf aktualisieren
      history.pushState({view: 'provider-billing', mode: mode}, '', location.pathname);
    };
  }
  const btnBillingBack = document.getElementById('btnBillingBack');
  if(btnBillingBack){
    btnBillingBack.onclick=()=> showProviderProfile();
  }

  const rowProfileOverview = document.getElementById('rowProfileOverview');
  if(rowProfileOverview){
    rowProfileOverview.onclick=()=>{
      // Profilübersicht: Wir sind bereits auf der Profil-Seite
      // Scroll nach oben für bessere UX
      window.scrollTo({top: 0, behavior: 'smooth'});
    };
  }
  
  // Profil bearbeiten Button (neu im "Mein Profil" Abschnitt)
  const btnProfileEdit = document.getElementById('btnProfileEdit');
  if(btnProfileEdit){
    btnProfileEdit.onclick=()=>{
      startWizard('provider');
    };
  }

  const btnProvShareOffer = document.getElementById('btnProvShareOffer');
  if(btnProvShareOffer){
    btnProvShareOffer.onclick=()=>{
      const first = offers.find(o=>o.providerId===providerId());
      if(first) {
        try {
          shareOffer(first);
        } catch(err) {
          console.error('Share error:', err);
          showToast('Teilen kommt als nächstes.');
        }
      } else {
        showToast('Noch keine Inserate zum Teilen.');
      }
    };
  }
  const btnProvWeekPdf = document.getElementById('btnProvWeekPdf');
  if(btnProvWeekPdf){
    btnProvWeekPdf.onclick=()=> printWeekCard();
  }
  // Provider Support (nur im Anbieter-Dashboard, support@mittagio.de)
  const btnProvSupport = document.getElementById('btnProvSupport');
  if(btnProvSupport){
    btnProvSupport.onclick=()=>{
      window.location.href = 'mailto:support@mittagio.de';
    };
  }

  // Legal Pages Navigation (statische Seiten)
  function showLegalPage(page){
    const pageMap = {
      'impressum': 'v-legal-impressum',
      'agb-kurz': 'v-legal-agb-kurz',
      'datenschutz': 'v-legal-datenschutz'
    };
    const viewId = pageMap[page];
    if(viewId){
      showView(viewId);
      window.scrollTo({top:0, behavior:'smooth'});
    }
  }
  
  function goBackFromLegalPage(){
    // Zurück zur Profil-Seite (Kunde oder Anbieter)
    if(mode === 'provider'){
      showProviderProfile();
    } else {
      showProfile();
    }
  }

  // Provider Legal Links - öffnen statische Seiten
  const btnLegalImprint = document.getElementById('btnLegalImprint');
  if(btnLegalImprint){
    btnLegalImprint.onclick=()=>{
      showLegalPage('impressum');
    };
  }
  const btnLegalPrivacy = document.getElementById('btnLegalPrivacy');
  if(btnLegalPrivacy){
    btnLegalPrivacy.onclick=()=>{
      showLegalPage('datenschutz');
    };
  }
  const btnLegalTerms = document.getElementById('btnLegalTerms');
  if(btnLegalTerms){
    btnLegalTerms.onclick=()=>{
      showLegalPage('agb-kurz');
    };
  }

  // --- Provider actions (alte Buttons entfernt, jetzt über Create Flow Sheet) ---
  // btnNewListing und btnFromCookbook werden nicht mehr verwendet
  const btnNewListing = document.getElementById('btnNewListing');
  if(btnNewListing) btnNewListing.style.display = 'none';
  const btnFromCookbook = document.getElementById('btnFromCookbook');
  if(btnFromCookbook) btnFromCookbook.style.display = 'none';
  
  // Kochbuch: "+ Gericht hinzufügen" öffnet IMMER Unified Flow
  const btnCookbookAdd = document.getElementById('btnCookbookAdd');
  if(btnCookbookAdd) btnCookbookAdd.onclick=()=> openDishFlow();
  // btnProvSetup wurde entfernt - jetzt btnProfileEdit verwendet
  // btnOpenWeekPlan wird nicht mehr verwendet (Week Preview ist jetzt im Dashboard)
  const btnOpenWeekPlan = document.getElementById('btnOpenWeekPlan');
  if(btnOpenWeekPlan) btnOpenWeekPlan.style.display = 'none';
  const btnPickupsFaq = document.getElementById('btnPickupsFaq');
  if(btnPickupsFaq){
    btnPickupsFaq.onclick=()=>{
      showProviderProfile();
      const box = document.getElementById('provFaqBox');
      if(box) box.style.display = 'block';
    };
  }

  const btnEditOffer = document.getElementById('btnEditOffer');
  if(btnEditOffer){
    btnEditOffer.onclick=()=>{
      if(!activeProviderOfferId) return;
      closeProviderSheet();
      startListingFlow({editOfferId: activeProviderOfferId});
    };
  }
  // No-Limits: Toggle-Funktion für "Ausverkauft" / "Noch da"
  function toggleOfferSoldOut(offerId){
    const idx = offers.findIndex(x=>x.id===offerId);
    if(idx<0) return;
    const wasActive = offers[idx].active !== false;
    offers[idx].active = !wasActive;
    save(LS.offers, offers);
    
    // Toast-Feedback
    showToast(wasActive ? 'Als ausverkauft markiert' : 'Wieder verfügbar', 2000);
    
    // Neu rendern
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
  }
  
  const btnToggleOffer = document.getElementById('btnToggleOffer');
  if(btnToggleOffer){
    btnToggleOffer.onclick=()=>{
      if(!activeProviderOfferId) return;
      toggleOfferSoldOut(activeProviderOfferId);
      closeProviderSheet();
    };
  }
  const btnShareOffer = document.getElementById('btnShareOffer');
  if(btnShareOffer){
    btnShareOffer.onclick=()=>{
      if(!activeProviderOfferId) return;
      const o = offers.find(x=>x.id===activeProviderOfferId);
      if(!o) return;
      shareOffer(o);
    };
  }
  const btnPrintOffer = document.getElementById('btnPrintOffer');
  if(btnPrintOffer){
    btnPrintOffer.onclick=()=>{
      if(!activeProviderOfferId) return;
      const o = offers.find(x=>x.id===activeProviderOfferId);
      if(!o) return;
      printOffer(o);
    };
  }

  const btnWeekBack = document.getElementById('btnWeekBack');
  if(btnWeekBack){
    btnWeekBack.onclick=()=> showProviderHome();
  }
  const btnWeekPdf = document.getElementById('btnWeekPdf');
  if(btnWeekPdf){
    btnWeekPdf.onclick=()=>{
    printWeekCard();
  };

  // Provider ID (for demo)
  function providerId(){
    // stable per email
    const e = provider.email || 'provider';
    return 'prov_' + btoa(unescape(encodeURIComponent(e))).slice(0,16);
  }

  // --- Cookbook ---
  function renderCookbook(){
    const box = document.getElementById('cookbookList');
    const tabs = document.getElementById('cookbookTabs');
    const sortBox = document.getElementById('cookbookSorts');
    const search = document.getElementById('cookbookSearch');
    if(!box) return;

    let updated = false;
    cookbook = cookbook.map(entry=>{
      const out = {...entry};
      if(!out.createdAt){ out.createdAt = Date.now(); updated = true; }
      if(out.lastUsed === undefined){ out.lastUsed = null; updated = true; }
      return out;
    });
    if(updated) save(LS.cookbook, cookbook);

    if(search){
      if(search.value !== cookbookQuery) search.value = cookbookQuery || '';
      search.oninput=()=>{ cookbookQuery = search.value; renderCookbook(); };
    }

    if(tabs){
      tabs.innerHTML='';
      [
        {id:'drafts', label:'Entwürfe'},
        {id:'dishes', label:'Gerichte'}
      ].forEach(t=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(cookbookTab===t.id?' on':'');
        b.textContent=t.label;
        b.onclick=()=>{ cookbookTab=t.id; renderCookbook(); };
        tabs.appendChild(b);
      });
    }

    if(sortBox){
      sortBox.innerHTML='';
      [
        {id:'recent', label:'Zuletzt verwendet'},
        {id:'alpha', label:'Alphabetisch'},
        {id:'priceAsc', label:'Preis aufsteigend'},
        {id:'priceDesc', label:'Preis absteigend'}
      ].forEach(f=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(cookbookSort===f.id?' on':'');
        b.textContent=f.label;
        b.onclick=()=>{ cookbookSort=f.id; renderCookbook(); };
        sortBox.appendChild(b);
      });
    }

    const mine = cookbook.filter(x=>x.providerId===providerId());
    const q = String(cookbookQuery||'').trim().toLowerCase();
    const filtered = mine.filter(x => !q || String(x.dish||'').toLowerCase().includes(q));

    if(!filtered.length){
      box.innerHTML = `
        <div style="text-align:center; padding:40px 20px;">
          <div style="font-weight:600; font-size:16px; margin-bottom:8px;">Keine Gerichte</div>
          <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:var(--muted);">
            Erstelle dein erstes Gericht im Kochbuch.
          </div>
          <button class="btn secondary" type="button" id="btnCookbookEmptyAdd" style="width:100%; min-height:44px;">
            Gericht hinzufügen
          </button>
        </div>
      `;
      const btnCookbookEmptyAdd = document.getElementById('btnCookbookEmptyAdd');
      if(btnCookbookEmptyAdd) btnCookbookEmptyAdd.onclick = () => {
        openDishFlow();
      };
      return;
    }

    const sortRecent = (a,b)=>(b.lastUsed||b.createdAt) - (a.lastUsed||a.createdAt);
    const sortAlpha = (a,b)=>String(a.dish||'').localeCompare(String(b.dish||''));
    const sortPriceAsc = (a,b)=>(Number(a.price||0) - Number(b.price||0));
    const sortPriceDesc = (a,b)=>(Number(b.price||0) - Number(a.price||0));
    const sortFn = cookbookSort==='alpha' ? sortAlpha : (cookbookSort==='priceAsc' ? sortPriceAsc : (cookbookSort==='priceDesc' ? sortPriceDesc : sortRecent));

    const dishes = filtered.filter(x=>x.lastUsed);
    const drafts = filtered.filter(x=>!x.lastUsed);
    dishes.sort(sortFn);
    drafts.sort(sortFn);

    const list = cookbookTab === 'drafts' ? drafts : dishes;
    const formatDayLabel = (iso)=>{
      if(!iso) return '—';
      const d = new Date(iso);
      if(Number.isNaN(d.getTime())) return iso;
      const today = isoDate(new Date());
      const tomorrow = isoDate(new Date(Date.now()+86400000));
      if(iso===today) return 'Heute';
      if(iso===tomorrow) return 'Morgen';
      return fmtDay(d);
    };

    const buildItem = (entry, isDraft)=>{
      const item=document.createElement('div');
      item.className='cookbook-item';

      const lastOnline = offers
        .filter(o=>o.providerId===providerId() && o.dish===entry.dish)
        .map(o=>o.day)
        .sort()
        .slice(-1)[0];
      const sales = offers.filter(o=>o.providerId===providerId() && o.dish===entry.dish).length * 3;

      // Optional: Bild anzeigen (falls vorhanden)
      const imageHtml = entry.photoData ? `<img src="${esc(entry.photoData)}" alt="${esc(entry.dish)}" style="width:100%; height:120px; object-fit:cover; border-radius:12px; margin-bottom:8px;" />` : '';
      // Optional: Kategorie-Badge
      const categoryBadge = entry.category ? `<span style="font-size:11px; padding:2px 6px; background:rgba(0,0,0,.06); border-radius:6px; color:var(--muted);">${esc(entry.category)}</span>` : '';
      
      item.innerHTML = `
        ${imageHtml}
        <div style="font-weight:900; font-size:16px; margin-bottom:4px;">${esc(entry.dish||'Gericht')}</div>
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
          ${categoryBadge}
          <span class="hint" style="font-size:13px;">${euro(entry.price||0)}</span>
        </div>
        <div class="cookbook-facts" style="font-size:12px; color:var(--muted);">
          ${isDraft ? 'Entwurf seit:' : 'Letzte Veröffentlichung:'}
          <b>${esc(formatDayLabel(isDraft ? entry.createdAt : lastOnline))}</b>
        </div>
      `;

      const actions=document.createElement('div');
      actions.className='cookbook-actions';
      actions.style.cssText = 'display:flex; align-items:center; gap:8px; margin-top:12px;';

      // Button: "Inserieren" (öffnet Master-Flow vorbefüllt)
      const insertBtn=document.createElement('button');
      insertBtn.type='button';
      insertBtn.className='ans';
      insertBtn.textContent='Inserieren';
      insertBtn.dataset.icon = 'plus';
      insertBtn.onclick=()=>{ startListingFlow({dishId: entry.id, date: createFlowPreselectedDate || isoDate(new Date())}); };
      actions.appendChild(insertBtn);

      // Button: "📅 In Wochenplan" (öffnet Master-Flow mit weekplan-context)
      const weekPlanBtn=document.createElement('button');
      weekPlanBtn.type='button';
      weekPlanBtn.className='ans';
      weekPlanBtn.textContent='📅 In Wochenplan';
      weekPlanBtn.onclick=()=>{ startListingFlow({dishId: entry.id, source: 'weekplan', date: createFlowPreselectedDate || isoDate(new Date())}); };
      actions.appendChild(weekPlanBtn);

      // Menü: "⋯" (Einstellungen: bearbeiten/pausieren/archivieren/löschen)
      const menuBtn=document.createElement('button');
      menuBtn.type='button';
      menuBtn.className='btn ghost';
      menuBtn.textContent='⋯';
      menuBtn.style.cssText = 'padding:8px; min-width:36px; font-size:18px;';
      menuBtn.onclick=(e)=>{
        e.stopPropagation();
        // Simple menu (später kann ein Sheet verwendet werden)
        const menuActions = [
          {label: 'Bearbeiten', action: () => startWizard('cookbook', {editId: entry.id})},
          {label: 'Pausieren', action: () => {
            // TODO: Implement pause/archive
            alert('Pausieren (TODO)');
          }},
          {label: 'Archivieren', action: () => {
            // TODO: Implement archive
            alert('Archivieren (TODO)');
          }},
          {label: 'Löschen', action: () => {
            if(confirm(`"${entry.dish}" wirklich löschen?`)){
              const idx = cookbook.findIndex(c => c.id === entry.id);
              if(idx >= 0){
                cookbook.splice(idx, 1);
                save(LS.cookbook, cookbook);
                renderCookbook();
                showToast('Gericht gelöscht');
              }
            }
          }}
        ];
        const choice = prompt(`Aktion für "${entry.dish}":\n${menuActions.map((a,i) => `${i+1}. ${a.label}`).join('\n')}\n\nNummer eingeben:`);
        const idx = parseInt(choice) - 1;
        if(idx >= 0 && idx < menuActions.length){
          menuActions[idx].action();
        }
      };
      actions.appendChild(menuBtn);
      item.appendChild(actions);
      return item;
    };

    box.innerHTML = '';
    if(!list.length){
      box.innerHTML = `<div class="hint">Keine ${cookbookTab==='drafts' ? 'Entwürfe' : 'Gerichte'} vorhanden.</div>`;
      return;
    }
    list.forEach(entry=> box.appendChild(buildItem(entry, cookbookTab==='drafts')));
    applyStaticIcons();
  }

  function publishCookbookEntry(entryId){
    const entry = cookbook.find(c=>c.id===entryId && c.providerId===providerId());
    if(!entry) return;

    const profile = normalizeProviderProfile(provider.profile || {});
    const offer = normalizeOffer({
      id: cryptoId(),
      providerId: providerId(),
      providerName: profile.name || provider.email || 'Anbieter',
      providerStreet: profile.street||'',
      providerZip: profile.zip||'',
      providerCity: profile.city||'',
      providerLogoData: profile.logoData||'',
      dish: entry.dish||'',
      category: entry.category||'Vegetarisch',
      price: Number(entry.price||0),
      pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
      hasPickupCode: !!entry.hasPickupCode,
      dineInPossible: !!entry.dineInPossible,
      allergens: entry.allergens||[],
      extras: entry.extras||[],
      reuse: entry.reuse||{enabled:false,deposit:0},
      imageUrl: entry.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
      day: isoDate(new Date())
    });

    if(!offer.providerStreet){
      alert('Bitte zuerst Anbieterprofil ausfüllen (Adresse).');
      return;
    }

    offers.unshift(offer);
    save(LS.offers, offers);

    const idx = cookbook.findIndex(c=>c.id===entryId);
    if(idx>=0){ cookbook[idx].lastUsed = Date.now(); }
    save(LS.cookbook, cookbook);

    renderCookbook();
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
    renderStart();
    alert('Inserat veröffentlicht.');
  }

  function publishWeekEntry(dayKey, entry){
    const cb = cookbook.find(c=>c.id===entry.cookbookId);
    if(!cb){
      alert('Gericht nicht gefunden.');
      return;
    }

    const profile = normalizeProviderProfile(provider.profile || {});
    const offer = normalizeOffer({
      id: cryptoId(),
      providerId: providerId(),
      providerName: profile.name || provider.email || 'Anbieter',
      providerStreet: profile.street||'',
      providerZip: profile.zip||'',
      providerCity: profile.city||'',
      providerLogoData: profile.logoData||'',
      dish: cb.dish||entry.dish||'',
      category: cb.category||'Vegetarisch',
      price: Number(cb.price||0),
      pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
      hasPickupCode: !!cb.hasPickupCode,
      dineInPossible: !!cb.dineInPossible,
      allergens: cb.allergens||[],
      extras: cb.extras||[],
      reuse: cb.reuse||{enabled:false,deposit:0},
      imageUrl: cb.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
      day: dayKey
    });

    if(!offer.providerStreet){
      alert('Bitte zuerst Anbieterprofil ausfüllen (Adresse).');
      return;
    }

    offers.unshift(offer);
    save(LS.offers, offers);

    const idx = cookbook.findIndex(c=>c.id===entry.cookbookId);
    if(idx>=0){ cookbook[idx].lastUsed = Date.now(); }
    save(LS.cookbook, cookbook);

    renderWeekPlan();
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
    renderStart();
    alert('Inserat veröffentlicht.');
  }

  // --- Wizard engine (Provider profile / Listing / Cookbook / Week) ---
  let w = { kind:null, step:0, data:{}, ctx:{} };

  const ALLERGENS_14 = [
    {name:'Gluten', short:'GL'},
    {name:'Krebstiere', short:'KR'},
    {name:'Eier', short:'EI'},
    {name:'Fisch', short:'FI'},
    {name:'Erdnüsse', short:'EN'},
    {name:'Soja', short:'SO'},
    {name:'Milch', short:'MI'},
    {name:'Schalenfrüchte', short:'SF'},
    {name:'Sellerie', short:'SE'},
    {name:'Senf', short:'SN'},
    {name:'Sesam', short:'SS'},
    {name:'Sulfite', short:'SU'},
    {name:'Lupinen', short:'LU'},
    {name:'Weichtiere', short:'WE'}
  ];

  function openWizard(){
    const wbd = document.getElementById('wbd');
    const wizard = document.getElementById('wizard');
    if(wbd) wbd.classList.add('active');
    if(wizard) wizard.classList.add('active');
    // Push state for browser back button
    history.pushState({wizard: true}, '', location.pathname);
  }
  function closeWizard(){
    document.getElementById('wbd').classList.remove('active');
    document.getElementById('wizard').classList.remove('active');
  }

  /**
   * UNIFIED DISH FLOW - Zentrale Funktion für alle Inserats-Buttons
   * Egal ob "Schnellschuss" für heute oder Wochenplan - immer derselbe Flow!
   * 
   * @param {string} [defaultDate] - Preselected date (ISO format, z.B. "2026-01-26")
   *                                  Wenn null/undefined: Heute
   *                                  Wenn vom Wochenplan: Gewählter Tag
   */
  function openDishFlow(defaultDate = null){
    // Normalisiere Datum: null/undefined = Heute
    const date = defaultDate || isoDate(new Date());
    
    // Öffne Master-Flow mit Datum
    startListingFlow({date: date});
  }
  
  /**
   * MASTER INSERATSFLOW - Einziger Entry-Point
   * Wird IMMER verwendet für:
   * - Inserat erstellen
   * - Gericht hinzufügen (Kochbuch)
   * - Gericht hinzufügen (Wochenplan)
   * KEINE Sonderflows bauen!
   * 
   * @param {Object} context
   * @param {string} [context.source] - "cookbook" | "new" | undefined
   * @param {string} [context.dishId] - Kochbuch-Eintrag ID (wenn aus Kochbuch)
   * @param {string} [context.date] - Preselected date (ISO format)
   * @param {string} [context.editOfferId] - Offer ID (wenn bearbeiten)
   */
  function startListingFlow(context = {}){
    // Always use listing wizard (Master Flow)
    startWizard('listing', context);
  }

  function startWizard(kind, ctx={}){
    w = { kind, step:0, data:{}, ctx };

    if(kind==='provider'){
      w.data = normalizeProviderProfile(JSON.parse(JSON.stringify(provider.profile||{})));
      buildProviderStep();
    }
    if(kind==='cookbook'){
      // Cookbook editing only (not for creating new dishes)
      // For creating new dishes, use startListingFlow() instead
      if(ctx.editId){
        const existing = cookbook.find(c=>c.id===ctx.editId);
        if(existing){ w.data = JSON.parse(JSON.stringify(existing)); }
      }
      if(!w.data || !w.data.providerId){
        w.data = {
          providerId: providerId(),
          dish:'', category:'Vegetarisch', price:0,
          allergens:[],
          extras:[],
          reuse:{enabled:false, deposit:0},
          photoData:'',
          hasPickupCode:false,
          dineInPossible:false,
          createdAt: Date.now(),
          lastUsed: null
        };
      }
      w.data.providerId = providerId();
      w.data.category = w.data.category || 'Vegetarisch';
      w.data.price = Number(w.data.price||0);
      w.data.allergens = Array.isArray(w.data.allergens) ? w.data.allergens : [];
      w.data.extras = Array.isArray(w.data.extras) ? w.data.extras : [];
      if(!w.data.reuse) w.data.reuse = {enabled:false, deposit:0};
      w.data.photoData = w.data.photoData || '';
      w.data.hasPickupCode = !!w.data.hasPickupCode;
      w.data.dineInPossible = !!w.data.dineInPossible;
      w.data.createdAt = w.data.createdAt || Date.now();
      if(w.data.lastUsed === undefined) w.data.lastUsed = null;
      buildCookbookStep();
    }
    if(kind==='listing'){
      // MASTER INSERATSFLOW - Always the same flow
      const profile = normalizeProviderProfile(provider.profile || {});
      
      // Case 1: Edit existing offer
      if(ctx.editOfferId){
        const existing = offers.find(o=>o.id===ctx.editOfferId);
        if(existing){
          const o = normalizeOffer(existing);
          w.data = {
            providerId: o.providerId || providerId(),
            dish: o.dish||'',
            category: o.category||'Vegetarisch',
            price: Number(o.price||0),
            pickupWindow: o.pickupWindow || profile.mealWindow || DEFAULT_MEAL_WINDOW,
            hasPickupCode: !!o.hasPickupCode,
            dineInPossible: !!o.dineInPossible,
            allergens: Array.isArray(o.allergens) ? [...o.allergens] : [],
            extras: Array.isArray(o.extras) ? JSON.parse(JSON.stringify(o.extras)) : [],
            reuse: o.reuse ? JSON.parse(JSON.stringify(o.reuse)) : {enabled:false, deposit:0},
            photoData: o.imageUrl || '',
            day: o.day,
            active: o.active !== false,
            cookbookId: null
          };
        }
      } 
      // Case 2: From cookbook (context.dishId or ctx.fromCookbookId)
      else if(ctx.dishId || ctx.fromCookbookId){
        const cookbookId = ctx.dishId || ctx.fromCookbookId;
        const x = cookbook.find(c=>c.id===cookbookId);
        if(x){
          // Prefill from cookbook entry
          w.data = {
            providerId: providerId(),
            dish: x.dish || '',
            category: x.category || 'Vegetarisch',
            price: Number(x.price||0),
            pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
            hasPickupCode: !!x.hasPickupCode,
            dineInPossible: !!x.dineInPossible,
            allergens: Array.isArray(x.allergens) ? [...x.allergens] : [],
            extras: Array.isArray(x.extras) ? JSON.parse(JSON.stringify(x.extras)) : [],
            reuse: x.reuse ? JSON.parse(JSON.stringify(x.reuse)) : {enabled:false, deposit:0},
            photoData: x.photoData || '',
            cookbookId: x.id,
            day: ctx.date || createFlowPreselectedDate || isoDate(new Date())
          };
        } else {
          // Fallback: new dish
          w.data = {
            providerId: providerId(),
            dish:'', category:'Vegetarisch', price:0,
            pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
            hasPickupCode:false,
            dineInPossible:false,
            allergens:[],
            extras:[],
            reuse:{enabled:false, deposit:0},
            photoData:'',
            cookbookId:null,
            day: ctx.date || createFlowPreselectedDate || isoDate(new Date())
          };
        }
      } 
      // Case 3: New dish (default)
      else {
        w.data = {
          providerId: providerId(),
          dish:'', category:'Vegetarisch', price:0,
          pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
          hasPickupCode:true, // Default: ON
          dineInPossible:false,
          allergens:[],
          extras:[],
          reuse:{enabled:false, deposit:0},
          photoData:'',
          cookbookId:null,
          day: ctx.date || createFlowPreselectedDate || isoDate(new Date())
        };
      }
      
      // Normalize data
      w.data.providerId = w.data.providerId || providerId();
      w.data.category = w.data.category || 'Vegetarisch';
      w.data.price = Number(w.data.price||0);
      w.data.pickupWindow = w.data.pickupWindow || profile.mealWindow || DEFAULT_MEAL_WINDOW;
      w.data.cookbookId = w.data.cookbookId || null;
      // Date preselect support
      if(ctx.date || createFlowPreselectedDate){
        w.data.day = ctx.date || createFlowPreselectedDate;
      } else if(!w.data.day){
        w.data.day = isoDate(new Date());
      }
      w.data.hasPickupCode = !!w.data.hasPickupCode;
      w.data.dineInPossible = !!w.data.dineInPossible;
      w.data.allergens = Array.isArray(w.data.allergens) ? w.data.allergens : [];
      w.data.extras = Array.isArray(w.data.extras) ? w.data.extras : [];
      if(!w.data.reuse) w.data.reuse = {enabled:false, deposit:0};
      buildListingStep();
    }
    if(kind==='week'){
      // Legacy: schedule cookbook item to a date
      // Should use startListingFlow({dishId, date}) instead
      const x = cookbook.find(c=>c.id===ctx.fromCookbookId);
      if(!x){ alert('Bitte erst ein Gericht im Kochbuch speichern.'); return; }
      w.data = { cookbookId:x.id, date: isoDate(new Date()) };
      buildWeekStep();
    }

    openWizard();
  }

  // Common wizard buttons
  const wBackBtn = document.getElementById('wBack');
  const wNextBtn = document.getElementById('wNext');
  const defaultWizardNext = ()=>{ w.step += 1; rebuildWizard(); };
  function setWizardNextDefault(){ wNextBtn.onclick = defaultWizardNext; }

  wBackBtn.onclick=()=>{
    if(w.step===0){ closeWizard(); return; }
    w.step -= 1;
    rebuildWizard();
  };
  setWizardNextDefault();

  function setWizardHeader(title, stepText){
    document.getElementById('wTitle').textContent = title;
    document.getElementById('wStep').textContent = stepText;
  }
  function setWizardQuestion(q, help=''){ 
    document.getElementById('wQ').textContent = q;
    document.getElementById('wHelp').textContent = help;
  }
  function setWizardContent(node){
    const c = document.getElementById('wContent');
    c.innerHTML='';
    c.appendChild(node);
  }

  function rebuildWizard(){
    if(w.kind==='provider') return buildProviderStep();
    if(w.kind==='cookbook') return buildCookbookStep();
    if(w.kind==='listing') return buildListingStep();
    if(w.kind==='week') return buildWeekStep();
  }

  function saveProviderProfileFromWizard(){
    const parsed = parseAddress(w.data.address || '');
    const street = parsed.street || w.data.street || '';
    const zip = parsed.zip || w.data.zip || '';
    const city = parsed.city || w.data.city || '';
    const address = parsed.address || buildAddress({street, zip, city});

    provider.profile = {
      name: w.data.name||'',
      address,
      street,
      zip,
      city,
      mealWindow: w.data.mealWindow || DEFAULT_MEAL_WINDOW,
      logoData: w.data.logoData||''
    };
    save(LS.provider, provider);
    renderProviderProfile();
    renderProviderHome();
  }

  // --- Provider onboarding (step-by-step, no form) ---
  function buildProviderStep(){
    setWizardNextDefault();
    const total = 5;
    const stepText = `Schritt ${Math.min(w.step+1,total)} von ${total}`;
    setWizardHeader('Anbieter-Profil', stepText);

    if(w.step >= total){
      saveProviderProfileFromWizard();
      closeWizard();
      alert('Profil ist bereit.');
      return;
    }

    if(w.step===0){
      setWizardQuestion('Wie heißt dein Betrieb?', 'Du kannst den Namen jederzeit ändern.');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field';
      input.placeholder='z.B. Metzgerei Müller';
      input.value = w.data.name || '';
      input.oninput=()=>{ w.data.name=input.value; };
      box.appendChild(input);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===1){
      setWizardQuestion('Adresse deines Betriebs?', 'Auto-Vervollständigung folgt (Demo).');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field';
      input.placeholder='Musterstrasse 12, 73614 Schorndorf';
      input.value = w.data.address || buildAddress(w.data) || '';
      input.oninput=()=>{ w.data.address=input.value; };
      box.appendChild(input);
      const h=document.createElement('div'); h.className='hint'; h.textContent='Tipp: Straße, PLZ, Ort - getrennt mit Komma.';
      box.appendChild(h);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===2){
      setWizardQuestion('Wann können Gäste dein Essen genießen?', 'Standard aus Profil, optional anpassen.');
      if(!w.data.mealWindow) w.data.mealWindow = DEFAULT_MEAL_WINDOW;

      const current = w.data.mealWindow || DEFAULT_MEAL_WINDOW;
      const split = current.includes('–') ? current.split('–') : current.split('-');
      const startDefault = split[0] ? split[0].trim() : '11:30';
      const endDefault = split[1] ? split[1].trim() : '14:00';
      if(!w.data.mealStart) w.data.mealStart = startDefault;
      if(!w.data.mealEnd) w.data.mealEnd = endDefault;

      const box=document.createElement('div');
      const summary=document.createElement('div');
      summary.className='panel';
      summary.innerHTML = `<b>${esc(current)}</b><div class="hint">Standard aus Profil</div>`;
      box.appendChild(summary);

      const actions=document.createElement('div');
      actions.className='answers';
      const toggle=document.createElement('button');
      toggle.type='button';
      toggle.className='ans';
      toggle.textContent = w.data.mealCustom ? 'Fertig' : 'Essenszeit ändern';
      toggle.onclick=()=>{
        w.data.mealCustom = !w.data.mealCustom;
        rebuildWizard();
      };
      actions.appendChild(toggle);
      box.appendChild(actions);

      if(w.data.mealCustom){
        const updateMealWindow = ()=>{
          if(w.data.mealStart && w.data.mealEnd){
            w.data.mealWindow = `${w.data.mealStart} – ${w.data.mealEnd}`;
          }
        };

        const startLabel=document.createElement('div'); startLabel.className='hint'; startLabel.textContent='Start';
        const startRow=document.createElement('div'); startRow.className='answers';
        ['10:30','11:00','11:30','12:00'].forEach(t=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.mealStart===t?' on':'');
          b.textContent=t;
          b.onclick=()=>{ w.data.mealStart=t; updateMealWindow(); rebuildWizard(); };
          startRow.appendChild(b);
        });

        const endLabel=document.createElement('div'); endLabel.className='hint'; endLabel.textContent='Ende';
        const endRow=document.createElement('div'); endRow.className='answers';
        ['13:00','13:30','14:00','14:30'].forEach(t=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.mealEnd===t?' on':'');
          b.textContent=t;
          b.onclick=()=>{ w.data.mealEnd=t; updateMealWindow(); rebuildWizard(); };
          endRow.appendChild(b);
        });

        box.appendChild(document.createElement('div')).style.height='10px';
        box.appendChild(startLabel);
        box.appendChild(startRow);
        box.appendChild(document.createElement('div')).style.height='8px';
        box.appendChild(endLabel);
        box.appendChild(endRow);
      }

      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===3){
      setWizardQuestion('Logo hochladen?', 'Optional, später jederzeit austauschbar.');
      const wrap = document.createElement('div');
      const btns=document.createElement('div');
      btns.className='answers';

      const up=document.createElement('button');
      up.className='ans';
      up.type='button';
      up.textContent='Logo auswählen';
      up.onclick=async()=>{
        const file = await pickImage();
        if(!file) return;
        w.data.logoData = await toDataUrl(file);
        rebuildWizard();
      };

      const skip=document.createElement('button');
      skip.className='ans';
      skip.type='button';
      skip.textContent='Später';
      skip.onclick=()=>{ w.data.logoData=''; rebuildWizard(); };

      btns.appendChild(up);
      btns.appendChild(skip);
      wrap.appendChild(btns);

      if(w.data.logoData){
        const prev=document.createElement('div');
        prev.style.marginTop='10px';
        prev.innerHTML = `<div class="hint">Vorschau:</div><div class="plogo" style="width:60px;height:60px;border-radius:14px"><img src="${w.data.logoData}" alt="Logo" /></div>`;
        wrap.appendChild(prev);
      }

      setWizardContent(wrap);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===4){
      setWizardQuestion('Profil ist bereit', 'Kurz prüfen, dann loslegen.');
      const box=document.createElement('div');
      const addr = buildAddress(w.data);
      const logo = w.data.logoData ? `<img src="${w.data.logoData}" alt="Logo" />` : `<img src="assets/provider-placeholder.png" alt="Logo" />`;

      const summary=document.createElement('div');
      summary.className='panel';
      summary.innerHTML = `
        <div style="display:flex;gap:10px;align-items:center;">
          <div class="plogo" style="width:52px;height:52px;border-radius:14px">${logo}</div>
          <div>
            <div style="font-weight:950">${esc(w.data.name || 'Betrieb')}</div>
            <div class="hint">${esc(addr || 'Adresse fehlt')}</div>
          </div>
        </div>
        <div class="row"><span>Essenszeit</span><b>${esc(w.data.mealWindow || DEFAULT_MEAL_WINDOW)}</b></div>
      `;

      const cta=document.createElement('button');
      cta.className='btn';
      cta.type='button';
      cta.textContent='Erstes Gericht erstellen';
      cta.onclick=()=>{
        saveProviderProfileFromWizard();
        closeWizard();
        startWizard('listing');
      };

      box.appendChild(summary);
      box.appendChild(cta);
      setWizardContent(box);
      wNextBtn.textContent='Fertig';
      return;
    }
  }

  // --- Listing wizard (Punkt 6 final) ---
  function updateListingPreviewContent(target){
    target.innerHTML = '';
    const title = document.createElement('div');
    title.className = 'hint';
    title.textContent = 'Live-Vorschau';
    target.appendChild(title);
    
    // Badge und Subline für Online-Zahlung + Abholcode
    if(w.data.hasPickupCode){
      const badgeContainer = document.createElement('div');
      badgeContainer.style.cssText = 'margin-bottom:12px; padding:12px; background:#f0f7f0; border-radius:12px; border:1px solid #4caf50;';
      const badge = document.createElement('div');
      badge.style.cssText = 'font-weight:600; font-size:14px; color:#2e7d32; margin-bottom:4px; display:flex; align-items:center; gap:6px;';
      badge.innerHTML = '🟢 Online bezahlt · Abholung mit Abholnummer';
      const subline = document.createElement('div');
      subline.style.cssText = 'font-size:12px; color:#666;';
      subline.textContent = 'Zahlung läuft direkt über Mittagio';
      badgeContainer.appendChild(badge);
      badgeContainer.appendChild(subline);
      target.appendChild(badgeContainer);
    }
    
    target.appendChild(offerCard(previewOfferFromWizard(), {interactive:false}));
    if(w.data.hasPickupCode){
      const note = document.createElement('div');
      note.className = 'mini';
      note.textContent = 'Beispiel-Abholnummer: A3';
      target.appendChild(note);
    }
  }

  function attachListingPreview(box){
    const wrap = document.createElement('div');
    wrap.id = 'listingPreview';
    wrap.style.marginTop = '12px';
    updateListingPreviewContent(wrap);
    box.appendChild(wrap);
  }

  function refreshListingPreview(){
    const wrap = document.getElementById('listingPreview');
    if(wrap){ updateListingPreviewContent(wrap); }
  }

  // ============================================================
  // MASTER INSERATSFLOW
  // Wird IMMER verwendet für:
  // - Inserat erstellen
  // - Gericht hinzufügen (Kochbuch)
  // - Gericht hinzufügen (Wochenplan)
  // KEINE Sonderflows bauen!
  // ============================================================
  function buildListingStep(){
    setWizardNextDefault();
    const total = 9; // Erhöht: Mehrweg nach Preis, Datum-Bestätigung, Extras getrennt
    setWizardHeader('Inserat erstellen', `Schritt ${Math.min(w.step+1,total)} von ${total}`);
    const profile = normalizeProviderProfile(provider.profile || {});
    if(!w.data.pickupWindow){ w.data.pickupWindow = profile.mealWindow || DEFAULT_MEAL_WINDOW; }

    if(w.step===0){
      setWizardQuestion('Kategorie?', 'Wähle eine Kategorie.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      CATEGORIES.forEach(c=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(w.data.category===c?' on':'');
        b.textContent=c;
        b.onclick=()=>{ w.data.category=c; rebuildWizard(); };
        ans.appendChild(b);
      });
      box.appendChild(ans);
      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===1){
      // MASTER FLOW: Always start with dish name input (no "Aus Kochbuch/Neu" switch)
      // If context.dishId is provided, prefill from cookbook
      setWizardQuestion('Gericht', 'Wie heißt das Gericht?');
      const box=document.createElement('div');
      
      // Check if we should prefill from cookbook
      const cookbookEntry = w.data.cookbookId ? cookbook.find(c => c.id === w.data.cookbookId) : null;
      const isFromCookbook = !!cookbookEntry;
      
      const input=document.createElement('input');
      input.className='field';
      input.placeholder='z.B. Kürbissuppe';
      input.value=w.data.dish||'';
      input.oninput=()=>{
        w.data.dish = input.value;
        const hit = DISH_SUGGESTIONS.find(d => d.name.toLowerCase() === input.value.trim().toLowerCase());
        if(hit){ w.data.category = hit.category; }
        refreshListingPreview();
      };
      
      const suggest=document.createElement('div');
      suggest.className='answers';
      DISH_SUGGESTIONS.slice(0,6).forEach(s=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans';
        b.textContent=s.name;
        b.onclick=()=>{ w.data.dish = s.name; w.data.category = s.category; rebuildWizard(); };
        suggest.appendChild(b);
      });
      
      box.appendChild(document.createElement('div')).style.height='8px';
      box.appendChild(input);
      box.appendChild(document.createElement('div')).style.height='8px';
      box.appendChild(suggest);
      
      // Show hint if from cookbook
      if(isFromCookbook){
        const hint=document.createElement('div');
        hint.className='hint';
        hint.style.marginTop='12px';
        hint.textContent='✓ Aus Kochbuch geladen';
        box.appendChild(hint);
      }

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===2){
      setWizardQuestion('Preis pro Portion?', 'Preset wählen oder frei eingeben.');
      const box=document.createElement('div');
      const presets=document.createElement('div'); presets.className='answers';
      [4.5,5.5,6.5,7.5,8.5].forEach(val=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(Number(w.data.price)===val?' on':'');
        b.textContent=`${val.toFixed(2).replace('.',',')} €`;
        b.onclick=()=>{ w.data.price=val; rebuildWizard(); };
        presets.appendChild(b);
      });
      const input=document.createElement('input');
      input.className='field';
      input.inputMode='decimal';
      input.placeholder='0,00';
      input.value = formatPriceInput(w.data.price);
      input.oninput=()=>{ w.data.price = parsePriceInput(input.value); refreshListingPreview(); };
      box.appendChild(presets);
      box.appendChild(document.createElement('div')).style.height='8px';
      box.appendChild(input);
      
      // Mehrweg-Badge Toggle (prominent nach Preis)
      box.appendChild(document.createElement('div')).style.height='20px';
      const reuseSection=document.createElement('div');
      reuseSection.style.cssText='padding:16px; background:rgba(31,157,85,0.08); border-radius:16px; border:2px solid rgba(31,157,85,0.2);';
      if(!w.data.reuse) w.data.reuse = {enabled:false, deposit:0};
      
      const reuseHeader=document.createElement('div');
      reuseHeader.style.cssText='display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;';
      reuseHeader.innerHTML=`
        <div style="display:flex; align-items:center; gap:8px;">
          <i data-lucide="leaf" style="width:20px;height:20px; color:#1f9d55;"></i>
          <span style="font-weight:700; font-size:15px; color:#2D3436;">Mehrweg möglich?</span>
        </div>
        <label style="position:relative; width:52px; height:32px; cursor:pointer;">
          <input type="checkbox" ${w.data.reuse.enabled ? 'checked' : ''} style="opacity:0; position:absolute; width:0; height:0;" onchange="w.data.reuse.enabled=this.checked; if(this.checked && !w.data.reuse.deposit) w.data.reuse.deposit=2; rebuildWizard();">
          <span style="position:absolute; top:0; left:0; right:0; bottom:0; background:${w.data.reuse.enabled ? '#1f9d55' : '#ccc'}; border-radius:999px; transition:all 0.3s ease;">
            <span style="position:absolute; top:2px; left:${w.data.reuse.enabled ? '22px' : '2px'}; width:28px; height:28px; background:#fff; border-radius:50%; box-shadow:0 2px 4px rgba(0,0,0,0.2); transition:all 0.3s ease;"></span>
          </span>
        </label>
      `;
      reuseSection.appendChild(reuseHeader);
      
      if(w.data.reuse.enabled){
        const reusePreview=document.createElement('div');
        reusePreview.style.cssText='padding:12px; background:#fff; border-radius:12px; display:flex; align-items:center; gap:8px; border:2px solid #1f9d55;';
        reusePreview.innerHTML=`
          <i data-lucide="leaf" style="width:18px;height:18px; color:#1f9d55;"></i>
          <span style="font-weight:700; font-size:14px; color:#1f9d55;">Mehrweg</span>
          <span style="font-size:13px; color:#666; margin-left:auto;">Pfand: ${euro(w.data.reuse.deposit || 2)}</span>
        `;
        reuseSection.appendChild(reusePreview);
        
        // Pfand-Betrag (vereinfacht: nur Presets)
        box.appendChild(document.createElement('div')).style.height='12px';
        const depositLabel=document.createElement('div');
        depositLabel.className='hint';
        depositLabel.textContent='Pfand-Betrag';
        const depositPresets=document.createElement('div');
        depositPresets.className='answers';
        [2,3,5].forEach(val=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.reuse.deposit===val?' on':'');
          b.textContent=`${val} €`;
          b.onclick=()=>{ w.data.reuse.deposit=val; rebuildWizard(); };
          depositPresets.appendChild(b);
        });
        reuseSection.appendChild(depositLabel);
        reuseSection.appendChild(depositPresets);
      }
      
      box.appendChild(reuseSection);
      
      attachListingPreview(box);
      setWizardContent(box);
      if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===3){
      // Datum bestätigen (Default: Heute oder gewählter Wochentag)
      const dateLabel = w.data.day === isoDate(new Date()) ? 'Heute' : fmtDay(new Date(w.data.day));
      setWizardQuestion('Datum bestätigen', `Veröffentlichung für: ${dateLabel}`);
      const box=document.createElement('div');
      const summary=document.createElement('div');
      summary.className='panel';
      summary.style.cssText='padding:20px; text-align:center;';
      summary.innerHTML = `
        <div style="font-size:24px; font-weight:900; color:#2D3436; margin-bottom:8px;">${esc(dateLabel)}</div>
        <div class="hint" style="font-size:14px;">${esc(w.data.pickupWindow || DEFAULT_MEAL_WINDOW)}</div>
      `;
      const hint=document.createElement('div');
      hint.className='hint';
      hint.style.marginTop='12px';
      hint.textContent='Datum kann im nächsten Schritt geändert werden.';
      box.appendChild(summary);
      box.appendChild(hint);
      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===4){
      setWizardQuestion('Abholzeit', 'Aus Profil übernommen.');
      const box=document.createElement('div');
      const summary=document.createElement('div');
      summary.className='panel';
      summary.innerHTML = `<b>${esc(w.data.pickupWindow || DEFAULT_MEAL_WINDOW)}</b><div class="hint">Aus Profil übernommen</div>`;
      const hint=document.createElement('div');
      hint.className='hint';
      hint.textContent='Änderung der Essenszeit ist im Profil möglich.';
      box.appendChild(summary);
      box.appendChild(hint);
      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===5){
      setWizardQuestion('Extras', 'Optional hinzufügen.');
      const box=document.createElement('div');
      if(!Array.isArray(w.data.extras)) w.data.extras=[];

      const extrasAns=document.createElement('div'); extrasAns.className='answers';
      ['Beilagensalat','Extrasosse','Sonstiges'].forEach(name=>{
        const active = w.data.extras.some(e=>e.name===name);
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(active?' on':'');
        b.textContent=name;
        b.onclick=()=>{
          const idx = w.data.extras.findIndex(e=>e.name===name);
          if(idx>=0) w.data.extras.splice(idx,1);
          else w.data.extras.push({name, price:0});
          rebuildWizard();
        };
        extrasAns.appendChild(b);
      });
      box.appendChild(extrasAns);

      if(w.data.extras.length){
        box.appendChild(document.createElement('div')).style.height='12px';
        w.data.extras.forEach(extra=>{
          const label=document.createElement('div');
          label.className='hint';
          label.textContent=extra.name;
          const input=document.createElement('input');
          input.className='field';
          input.inputMode='decimal';
          input.placeholder='Preis in EUR (z.B. 2,00)';
          input.value = formatPriceInput(extra.price);
          input.oninput=()=>{ extra.price = parsePriceInput(input.value); refreshListingPreview(); };
          box.appendChild(document.createElement('div')).style.height='8px';
          box.appendChild(label);
          box.appendChild(input);
        });
      }

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===6){
      setWizardQuestion('Allergene?', 'Optional auswählen.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      const has = w.data.hasAllergens || (Array.isArray(w.data.allergens) && w.data.allergens.length);
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(has?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!has?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.hasAllergens=true; if(!Array.isArray(w.data.allergens)) w.data.allergens=[]; rebuildWizard(); };
      no.onclick=()=>{ w.data.hasAllergens=false; w.data.allergens=[]; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);

      if(has){
        const list=document.createElement('div'); list.className='answers';
        ALLERGENS_14.forEach(a=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.allergens.includes(a.short)?' on':'');
          b.textContent=`${a.short} ${a.name}`;
          b.onclick=()=>{
            const i=w.data.allergens.indexOf(a.short);
            if(i>=0) w.data.allergens.splice(i,1); else w.data.allergens.push(a.short);
            rebuildWizard();
          };
          list.appendChild(b);
        });
        box.appendChild(document.createElement('div')).style.height='8px';
        box.appendChild(list);
      }

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===7){
      setWizardQuestion('Foto', 'Pflicht: Foto mit automatischem Filter & Zuschnitt.');
      const box=document.createElement('div');
      
      if(!w.data.photoData){
        const ans=document.createElement('div'); ans.className='answers';
        const cam=document.createElement('button'); cam.type='button'; cam.className='ans'; cam.textContent='Kamera';
        cam.onclick=async()=>{ 
          const f=await pickImage({capture:true}); 
          if(!f) return; 
          const dataUrl = await toDataUrl(f);
          await openPhotoEditor(dataUrl);
        };
        const gal=document.createElement('button'); gal.type='button'; gal.className='ans'; gal.textContent='Galerie';
        gal.onclick=async()=>{ 
          const f=await pickImage(); 
          if(!f) return; 
          const dataUrl = await toDataUrl(f);
          await openPhotoEditor(dataUrl);
        };
        ans.appendChild(cam); ans.appendChild(gal);
        box.appendChild(ans);
      } else {
        // Foto bereits vorhanden - Editor öffnen
        const preview=document.createElement('div');
        preview.style.marginTop='10px';
        preview.innerHTML = `
          <div class="hint">Aktuelles Foto:</div>
          <div style="border-radius:16px;overflow:hidden;border:1px solid #eee;margin-top:8px">
            <img src="${w.data.photoData}" alt="" style="width:100%;height:200px;object-fit:cover;display:block">
          </div>
        `;
        box.appendChild(preview);
        
        const editBtn=document.createElement('button');
        editBtn.className='btn secondary';
        editBtn.type='button';
        editBtn.textContent='Foto bearbeiten';
        editBtn.style.marginTop='12px';
        editBtn.onclick=async()=> await openPhotoEditor(w.data.photoData);
        box.appendChild(editBtn);
        
        const removeBtn=document.createElement('button');
        removeBtn.className='btn ghost';
        removeBtn.type='button';
        removeBtn.textContent='Foto entfernen';
        removeBtn.style.marginTop='8px';
        removeBtn.onclick=()=>{ w.data.photoData=''; rebuildWizard(); };
        box.appendChild(removeBtn);
      }
      
      // Live-Vorschau "So erscheint es in der App"
      const livePreview=document.createElement('div');
      livePreview.style.marginTop='20px';
      livePreview.style.padding='16px';
      livePreview.style.background='#f8f7f3';
      livePreview.style.borderRadius='16px';
      livePreview.innerHTML = `
        <div class="hint" style="margin-bottom:8px;font-weight:700;">So erscheint es in der App:</div>
        <div class="discover-hero-card" style="margin:0;cursor:default;">
          <div class="discover-hero-image">
            <img src="${w.data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70'}" alt="" />
          </div>
          <div class="discover-hero-content">
            <div class="discover-hero-title">${esc(w.data.dish||'Gericht')}</div>
            <div class="discover-hero-price">${euro(w.data.price||0)}</div>
          </div>
        </div>
      `;
      box.appendChild(livePreview);

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===8){
      setWizardQuestion('Abschluss', 'Veröffentlichen oder speichern.');
      const box=document.createElement('div');
      attachListingPreview(box);

      const options=document.createElement('div');
      options.style.marginTop='10px';
      const codeLabel=document.createElement('div');
      codeLabel.className='hint';
      codeLabel.textContent='Abholcode & Online-Zahlung';
      const codeRow=document.createElement('div'); codeRow.className='answers';
      const codeYes=document.createElement('button'); codeYes.type='button'; codeYes.className='ans'+(w.data.hasPickupCode?' on':''); codeYes.textContent='Ja';
      const codeNo=document.createElement('button'); codeNo.type='button'; codeNo.className='ans'+(!w.data.hasPickupCode?' on':''); codeNo.textContent='Nein';
      codeYes.onclick=()=>{ w.data.hasPickupCode=true; rebuildWizard(); };
      codeNo.onclick=()=>{ w.data.hasPickupCode=false; rebuildWizard(); };
      codeRow.appendChild(codeYes); codeRow.appendChild(codeNo);
      
      // Optionaler Hinweis bei deaktiviertem Abholcode (nicht blockierend)
      if(!w.data.hasPickupCode){
        const hintBox = document.createElement('div');
        hintBox.style.cssText = 'margin-top:12px; padding:12px; background:#f8f8f8; border-radius:12px; border:1px solid #e0e0e0;';
        hintBox.innerHTML = `
          <div style="font-size:13px; line-height:1.5; color:#666; margin-bottom:8px;">
            Tipp: Mit Abholnummer zahlen Kunden online und du hast weniger Aufwand.
          </div>
          <button class="btn secondary" type="button" style="width:100%; min-height:44px; font-size:14px;" onclick="w.data.hasPickupCode=true; rebuildWizard();">
            Abholnummer aktivieren
          </button>
        `;
        options.appendChild(hintBox);
      }

      const dineLabel=document.createElement('div');
      dineLabel.className='hint';
      dineLabel.textContent='Vor Ort essen möglich';
      const dineRow=document.createElement('div'); dineRow.className='answers';
      const dineYes=document.createElement('button'); dineYes.type='button'; dineYes.className='ans'+(w.data.dineInPossible?' on':''); dineYes.textContent='Ja';
      const dineNo=document.createElement('button'); dineNo.type='button'; dineNo.className='ans'+(!w.data.dineInPossible?' on':''); dineNo.textContent='Nein';
      dineYes.onclick=()=>{ w.data.dineInPossible=true; rebuildWizard(); };
      dineNo.onclick=()=>{ w.data.dineInPossible=false; rebuildWizard(); };
      dineRow.appendChild(dineYes); dineRow.appendChild(dineNo);

      options.appendChild(codeLabel);
      options.appendChild(codeRow);
      options.appendChild(document.createElement('div')).style.height='6px';
      options.appendChild(dineLabel);
      options.appendChild(dineRow);
      box.appendChild(options);

      const actions=document.createElement('div');
      actions.style.marginTop='10px';

      // Kosten-Info-Blöcke vor dem Button
      const costInfo = document.createElement('div');
      costInfo.style.cssText = 'margin-top:16px; margin-bottom:16px;';
      
      // Block 1: Veröffentlichung
      const block1 = document.createElement('div');
      block1.style.cssText = 'padding:12px; background:#f8f8f8; border-radius:12px; margin-bottom:12px;';
      block1.innerHTML = `
        <div style="font-weight:600; font-size:14px; margin-bottom:4px;">Veröffentlichung</div>
        <div style="font-size:16px; font-weight:700; color:var(--brand);">4,99 € + MwSt. pro Veröffentlichung</div>
      `;
      
      // Block 2: Online-Zahlung inkl. Abholcode
      if(w.data.hasPickupCode){
        const block2 = document.createElement('div');
        block2.style.cssText = 'padding:12px; background:#f0f7f0; border-radius:12px; border:1px solid #4caf50;';
        block2.innerHTML = `
          <div style="font-weight:600; font-size:14px; margin-bottom:8px; color:#2e7d32;">Online-Zahlung inkl. Abholcode</div>
          <ul style="margin:0; padding-left:20px; font-size:13px; line-height:1.6; color:#333;">
            <li>Kunde bezahlt online</li>
            <li>Geld ist sicher</li>
            <li>Keine Kasse · kein Bargeld</li>
          </ul>
          <div style="margin-top:8px; font-size:11px; color:#666; font-style:italic;">
            Für jede Online-Bestellung fällt eine Abwicklungsgebühr an (inkl. aller Zahlungsgebühren).
          </div>
        `;
        costInfo.appendChild(block2);
      }
      
      costInfo.appendChild(block1);
      box.appendChild(costInfo);

      const btnPub=document.createElement('button');
      btnPub.className='btn';
      btnPub.type='button';
      btnPub.textContent = 'Jetzt veröffentlichen';
      btnPub.style.cssText = 'width:100%; min-height:56px; font-size:16px; font-weight:600; margin-top:8px;';
      btnPub.onclick=()=>{
        const o = previewOfferFromWizard();
        closeWizard();
        // Zeige Monetarisierungs-Modal vor Veröffentlichung
        showPublishFeeModal(o);
      };

      const btnSave=document.createElement('button');
      btnSave.className='btn secondary';
      btnSave.type='button';
      btnSave.textContent='Im Kochbuch speichern';
      btnSave.onclick=()=>{
        saveToCookbookFromWizard();
        closeWizard();
        showProviderCookbook();
      };

      const btnWeek=document.createElement('button');
      btnWeek.className='btn ghost';
      btnWeek.type='button';
      btnWeek.textContent='Zum Wochenplan hinzufügen';
      btnWeek.onclick=()=>{
        saveToCookbookFromWizard(true);
        const cb = cookbook.filter(x=>x.providerId===providerId()).slice(-1)[0];
        // Week plan: Use Master-Flow instead
        if(cb) startListingFlow({dishId: cb.id});
      };

      actions.appendChild(btnPub);
      actions.appendChild(btnSave);
      actions.appendChild(btnWeek);
      box.appendChild(actions);

      setWizardContent(box);
      wNextBtn.textContent='Schließen';
      wNextBtn.onclick=()=>{ closeWizard(); showProviderHome(); };
      return;
    }
  }

  function previewOfferFromWizard(){
    const p = normalizeProviderProfile(provider.profile||{});
    const pickupWindow = w.data.pickupWindow || p.mealWindow || DEFAULT_MEAL_WINDOW;
    return {
      id: 'preview',
      providerId: providerId(),
      providerName: p.name || provider.email || 'Anbieter',
      providerStreet: p.street||'',
      providerZip: p.zip||'',
      providerCity: p.city||'',
      providerLogoData: p.logoData||'',
      dish: w.data.dish||'Gericht',
      category: w.data.category||'Vegetarisch',
      price: Number(w.data.price||0),
      pickupWindow,
      imageUrl: w.data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
      hasPickupCode: !!w.data.hasPickupCode,
      dineInPossible: !!w.data.dineInPossible,
      allergens: w.data.allergens||[],
      extras: w.data.extras||[],
      reuse: w.data.reuse||{enabled:false,deposit:0},
      day: w.data.day || isoDate(new Date()),
      active: w.data.active !== false
    };
  }

  function publishOffer(o){
    const existingId = w.ctx && w.ctx.editOfferId ? w.ctx.editOfferId : null;
    const id = existingId || cryptoId();
    const out = {...o, id, day: o.day || w.data.day || isoDate(new Date()), active: o.active !== false};
    // ensure provider address exists
    if(!out.providerStreet){
      alert('Bitte zuerst Anbieterprofil ausfüllen (Adresse).');
      return;
    }
    if(existingId){
      const idx = offers.findIndex(x=>x.id===existingId);
      if(idx>=0){
        const prev = offers[idx];
        offers[idx] = {...prev, ...out, id: prev.id, day: out.day, active: out.active};
      } else {
        offers.unshift(out);
      }
    } else {
      offers.unshift(out);
    }
    save(LS.offers, offers);
    
    // Reset createFlowPreselectedDate
    createFlowPreselectedDate = null;
    // restore default next button handler
    setWizardNextDefault();
    
    // Ostereier: Feuerwerk-Icon bei erstem Inserat
    const isFirstOffer = !existingId && offers.filter(o => o.providerId === providerId()).length === 1;
    if(isFirstOffer){
      showToast('🎉 Dein erstes Inserat ist live!', 4000);
    } else {
      showToast(existingId ? 'Inserat aktualisiert' : 'Inserat veröffentlicht');
    }
    
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
    renderStart();
  }

  function saveToCookbookFromWizard(keepOpen=false){
    const now = Date.now();
    const base = {
      id: cryptoId(),
      providerId: providerId(),
      dish: w.data.dish||'',
      category: w.data.category||'Vegetarisch',
      price: Number(w.data.price||0),
      allergens: w.data.allergens||[],
      extras: w.data.extras||[],
      reuse: w.data.reuse||{enabled:false,deposit:0},
      photoData: w.data.photoData||'',
      hasPickupCode: !!w.data.hasPickupCode,
      dineInPossible: !!w.data.dineInPossible,
      createdAt: now,
      lastUsed: null
    };
    if(w.ctx && w.ctx.editId){
      const idx = cookbook.findIndex(c=>c.id===w.ctx.editId);
      if(idx>=0){
        const prev = cookbook[idx];
        cookbook[idx] = {
          ...prev,
          ...base,
          id: prev.id,
          createdAt: prev.createdAt || now,
          lastUsed: prev.lastUsed ?? null
        };
      } else {
        cookbook.push(base);
      }
    } else {
      cookbook.push(base);
    }
    save(LS.cookbook, cookbook);
    if(!keepOpen){ renderCookbook(); }
  }

  // Cookbook wizard (add recipe)
  function buildCookbookStep(){
    setWizardNextDefault();
    // reuse listing steps subset: category, photo, name, allergens, extras, reuse, price, preview/save
    const total = 8;
    setWizardHeader('Kochbuch', `${Math.min(w.step+1,total)}/${total}`);

    if(w.step===0){
      setWizardQuestion('Kategorie?', 'Tippe eine Kategorie.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      ['Vegan','Vegetarisch','Fleisch','Salat'].forEach(c=>{
        const b=document.createElement('button'); b.type='button'; b.className='ans'+(w.data.category===c?' on':''); b.textContent=c;
        b.onclick=()=>{ w.data.category=c; rebuildWizard(); };
        ans.appendChild(b);
      });
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===1){
      setWizardQuestion('Foto speichern?', 'Optional (für schnelleres Wiederverwenden).');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      const b1=document.createElement('button'); b1.type='button'; b1.className='ans'; b1.textContent='Foto auswählen';
      b1.onclick=async()=>{ const f=await pickImage(); if(!f) return; w.data.photoData = await toDataUrl(f); rebuildWizard(); };
      const b2=document.createElement('button'); b2.type='button'; b2.className='ans'; b2.textContent='Ohne';
      b2.onclick=()=>{ w.data.photoData=''; rebuildWizard(); };
      ans.appendChild(b1); ans.appendChild(b2);
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===2){
      setWizardQuestion('Gerichtname?', 'Wie im Kochbuch.');
      const box=document.createElement('div');
      const input=document.createElement('input'); input.className='field'; input.placeholder='z.B. Lasagne'; input.value=w.data.dish||'';
      input.oninput=()=>{ w.data.dish=input.value; };
      box.appendChild(input);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===3){
      setWizardQuestion('Allergene?', 'Optional, antippen.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      if(!Array.isArray(w.data.allergens)) w.data.allergens=[];
      ALLERGENS_14.forEach(a=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(w.data.allergens.includes(a.short)?' on':'');
        b.textContent=`${a.short} ${a.name}`;
        b.onclick=()=>{
          const i=w.data.allergens.indexOf(a.short);
          if(i>=0) w.data.allergens.splice(i,1); else w.data.allergens.push(a.short);
          rebuildWizard();
        };
        ans.appendChild(b);
      });
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===4){
      // Extras
      setWizardQuestion('Extras?', 'Optional.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(w.data.extras?.length?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!w.data.extras?.length?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.extras = w.data.extras?.length ? w.data.extras : [{name:'Beilagensalat', price:2.0}]; rebuildWizard(); };
      no.onclick=()=>{ w.data.extras=[]; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===5){
      // reuse
      setWizardQuestion('Mehrweg / Pfand?', 'Optional.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      if(!w.data.reuse) w.data.reuse={enabled:false,deposit:0};
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(w.data.reuse.enabled?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!w.data.reuse.enabled?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.reuse.enabled=true; if(!w.data.reuse.deposit) w.data.reuse.deposit=5; rebuildWizard(); };
      no.onclick=()=>{ w.data.reuse.enabled=false; w.data.reuse.deposit=0; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===6){
      setWizardQuestion('Standardpreis?', 'Nur Zahl - Komma nicht nötig.');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field'; input.inputMode='numeric'; input.placeholder='z.B. 799';
      input.value = w.data.price ? String(Math.round(w.data.price*100)) : '';
      input.oninput=()=>{ w.data.price = smartNumberToEuro(input.value); };
      box.appendChild(input);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===7){
      setWizardQuestion('Speichern?', 'Damit du später mit 2 Taps inserierst.');
      const box=document.createElement('div');
      const prev = {
        id:'preview',
        providerId:providerId(),
        providerName: provider.profile.name || provider.email || 'Anbieter',
        providerStreet:'',providerZip:'',providerCity:'',providerLogoData: provider.profile.logoData||'',
        dish:w.data.dish||'Gericht',
        category:w.data.category||'Vegetarisch',
        price:Number(w.data.price||0),
        pickupWindow:'',
        imageUrl: w.data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
        hasPickupCode:false,
        allergens:w.data.allergens||[],
        extras:w.data.extras||[],
        reuse:w.data.reuse||{enabled:false,deposit:0},
        day: isoDate(new Date())
      };
      box.appendChild(offerCard(prev, {interactive:false}));
      const btn=document.createElement('button');
      btn.className='btn';
      btn.type='button';
      btn.textContent = w.ctx && w.ctx.editId ? 'Änderungen speichern' : 'Im Kochbuch speichern';
      btn.onclick=()=>{
        saveToCookbookFromWizard();
        closeWizard();
        renderCookbook();
        alert('Gespeichert.');
      };
      box.appendChild(btn);
      setWizardContent(box);
      wNextBtn.textContent='Fertig';
      wNextBtn.onclick=()=>{ closeWizard(); showProviderCookbook(); };
      return;
    }
  }

  // Weekplan wizard (simple date choose)
  function buildWeekStep(){
    setWizardNextDefault();
    setWizardHeader('Wochenplan', '1/1');
    setWizardQuestion('Für welchen Tag?', 'Wähle einen Tag und füge das Gericht hinzu.');

    const box=document.createElement('div');
    const ans=document.createElement('div'); ans.className='answers';

    for(let i=0;i<5;i++){
      const d=new Date(); d.setDate(d.getDate()+i);
      const key=isoDate(d);
      const b=document.createElement('button');
      b.type='button';
      b.className='ans'+(w.data.date===key?' on':'');
      b.textContent = i===0?'Heute':(i===1?'Morgen':fmtDay(d));
      b.onclick=()=>{ w.data.date=key; rebuildWizard(); };
      ans.appendChild(b);
    }
    box.appendChild(ans);

    const btn=document.createElement('button');
    btn.className='btn';
    btn.type='button';
    btn.textContent='Zum Wochenplan hinzufügen';
    btn.onclick=()=>{
      const cb = cookbook.find(c=>c.id===w.data.cookbookId);
      if(!cb){ alert('Gericht nicht gefunden'); return; }
      const entry = { providerId:providerId(), dish:cb.dish, cookbookId:cb.id, active:true };
      if(!week[w.data.date]) week[w.data.date]=[];
      week[w.data.date].push(entry);
      save(LS.week, week);
      
      // Automatisch als Angebot veröffentlichen, damit Kunden es sehen
      publishWeekEntry(w.data.date, entry);
      
      closeWizard();
      renderProviderHome();
    };

    box.appendChild(document.createElement('div')).style.height='10px';
    box.appendChild(btn);

    setWizardContent(box);
    wNextBtn.textContent='Fertig';
    wNextBtn.onclick=()=>{ closeWizard(); showProviderHome(); };
  }

  // --- Input helpers (thumb-friendly) ---
  function formatPriceInput(value){
    const num = Number(value||0);
    return num.toFixed(2).replace('.',',');
  }
  function parsePriceInput(raw){
    const cleaned = String(raw||'').trim().replace(',', '.').replace(/[^0-9.]/g,'');
    const num = parseFloat(cleaned);
    if(Number.isNaN(num)) return 0;
    return Math.round(num*100)/100;
  }
  function smartNumberToEuro(raw){
    const digits = String(raw||'').replace(/\D/g,'');
    if(!digits) return 0;
    const cents = parseInt(digits,10);
    return Math.round((cents/100)*100)/100;
  }
  function smartNumber(raw){
    const digits = String(raw||'').replace(/\D/g,'');
    if(!digits) return 0;
    return parseInt(digits,10);
  }

  // Image picker
  function pickImage(opts={}){
    return new Promise(resolve=>{
      const input=document.createElement('input');
      input.type='file';
      input.accept='image/*';
      if(opts.capture) input.capture='environment';
      input.onchange=()=> resolve(input.files && input.files[0] ? input.files[0] : null);
      input.click();
    });
  }
  function toDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload=()=>resolve(r.result);
      r.onerror=reject;
      r.readAsDataURL(file);
    });
  }
  
  // Fotoeditor mit Filter & Zuschnitt
  // Foto-KI: Analysiert Foto mit GPT-4o Vision API
  async function analyzeFoodPhoto(imageDataUrl){
    try {
      // TODO: In Production: Echte GPT-4o Vision API Integration
      // Beispiel-Request:
      // const response = await fetch('https://api.openai.com/v1/chat/completions', {
      //   method: 'POST',
      //   headers: {
      //     'Authorization': `Bearer ${OPENAI_API_KEY}`,
      //     'Content-Type': 'application/json'
      //   },
      //   body: JSON.stringify({
      //     model: 'gpt-4o',
      //     messages: [{
      //       role: 'user',
      //       content: [
      //         { type: 'text', text: 'Analysiere dieses Food-Foto und extrahiere: Name des Gerichts, geschätzter Preis in EUR, Hauptzutaten (Liste). Antworte im JSON-Format: {name, price, ingredients: []}. KEINE Mengenschätzungen oder Kalorien.' },
      //         { type: 'image_url', image_url: { url: imageDataUrl } }
      //       ]
      //     }]
      //   })
      // });
      // const data = await response.json();
      // return JSON.parse(data.choices[0].message.content);
      
      // Demo: Simuliere KI-Analyse (wird später durch echte API ersetzt)
      await new Promise(resolve => setTimeout(resolve, 1500)); // Simuliere API-Latenz
      
      // Mock-Daten basierend auf häufigsten Gerichten
      const mockAnalysis = {
        name: 'Schnitzel mit Pommes',
        price: 8.50,
        ingredients: ['Schweinefleisch', 'Eier', 'Mehl', 'Semmelbrösel', 'Kartoffeln', 'Öl'],
        calories: 650
      };
      
      return mockAnalysis;
    } catch(err){
      console.error('Foto-KI Fehler:', err);
      return null;
    }
  }
  
  // Auto-Tagging: Vergleicht Zutaten mit 14 Hauptallergenen
  function tagAllergensFromIngredients(ingredients){
    const allergenMap = {
      'A': ['gluten', 'weizen', 'roggen', 'gerste', 'hafer', 'dinkel'],
      'B': ['krebstiere', 'krebs', 'garnelen', 'shrimps'],
      'C': ['eier', 'ei', 'eigelb', 'eiweiß'],
      'D': ['fisch', 'lachs', 'thunfisch', 'forelle'],
      'E': ['erdnüsse', 'erdnuss'],
      'F': ['soja', 'sojabohnen', 'tofu'],
      'G': ['milch', 'milchprodukte', 'käse', 'butter', 'sahne', 'joghurt'],
      'H': ['schalenfrüchte', 'mandeln', 'haselnüsse', 'walnüsse', 'cashew'],
      'I': ['sellerie'],
      'J': ['senf'],
      'K': ['sesam'],
      'L': ['schwefeldioxid', 'sulfite'],
      'M': ['lupinen'],
      'N': ['weichtiere', 'muscheln', 'austern']
    };
    
    const detectedAllergens = [];
    const ingredientsLower = ingredients.map(i => i.toLowerCase());
    
    Object.keys(allergenMap).forEach(code => {
      const keywords = allergenMap[code];
      if(keywords.some(keyword => ingredientsLower.some(ing => ing.includes(keyword)))){
        detectedAllergens.push(code);
      }
    });
    
    return detectedAllergens;
  }
  
  async function openPhotoEditor(imageDataUrl){
    return new Promise(async (resolve)=>{
      const editor = document.createElement('div');
      editor.className='backdrop active';
      editor.style.zIndex='50';
      
      const editorContent = document.createElement('div');
      editorContent.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:24px;padding:24px;max-width:90vw;max-height:90vh;overflow:auto;z-index:51;box-shadow:0 8px 32px rgba(0,0,0,.2);';
      
      // Foto-KI Analyse starten (im Hintergrund)
      const aiAnalysisPromise = analyzeFoodPhoto(imageDataUrl);
      
      const img = new Image();
      img.src = imageDataUrl;
      img.onload = async ()=>{
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const size = 400;
        canvas.width = size;
        canvas.height = size;
        
        // Quadratischer Zuschnitt (zentriert)
        const sourceSize = Math.min(img.width, img.height);
        const sourceX = (img.width - sourceSize) / 2;
        const sourceY = (img.height - sourceSize) / 2;
        
        // Filter: Helligkeit + Kontrast (Image Enhancement)
        ctx.filter = 'brightness(1.1) contrast(1.15) saturate(1.1)';
        ctx.drawImage(img, sourceX, sourceY, sourceSize, sourceSize, 0, 0, size, size);
        
        const processedDataUrl = canvas.toDataURL('image/jpeg', 0.85);
        
        // Warte auf KI-Analyse
        const aiResult = await aiAnalysisPromise;
        
        // Wenn KI-Analyse erfolgreich, fülle Felder automatisch
        if(aiResult && w && w.data){
          if(aiResult.name && !w.data.dish) w.data.dish = aiResult.name;
          if(aiResult.price && !w.data.price) w.data.price = aiResult.price;
          if(aiResult.ingredients && aiResult.ingredients.length > 0){
            // Allergene automatisch taggen
            const allergens = tagAllergensFromIngredients(aiResult.ingredients);
            if(allergens.length > 0 && !w.data.allergens){
              w.data.allergens = allergens;
              w.data.hasAllergens = true;
            }
          }
          
          // Zeige Toast mit KI-Ergebnissen
          showToast(`KI-Analyse: ${aiResult.name || 'Gericht erkannt'} (${aiResult.calories || '?'} kcal)`);
        }
        
        const acceptBtn = document.createElement('button');
        acceptBtn.className='btn';
        acceptBtn.textContent='Übernehmen';
        acceptBtn.onclick=()=>{
          w.data.photoData = processedDataUrl;
          editor.remove();
          rebuildWizard();
          resolve(processedDataUrl);
        };
        
        const cancelBtn = document.createElement('button');
        cancelBtn.className='btn secondary';
        cancelBtn.textContent='Abbrechen';
        cancelBtn.style.marginLeft='8px';
        cancelBtn.onclick=()=>{
          editor.remove();
          resolve(null);
        };
        
        editorContent.innerHTML = `
          <h3 style="margin:0 0 16px;font-size:18px;font-weight:900;">Foto bearbeiten</h3>
          <div style="border-radius:16px;overflow:hidden;border:1px solid #eee;margin-bottom:16px;background:#f5f5f5">
            <img src="${processedDataUrl}" alt="" style="width:100%;max-width:400px;display:block" />
          </div>
          <div class="hint" style="margin-bottom:16px;">✓ Automatisch optimiert: Helligkeit + Kontrast<br>✓ Quadratischer Zuschnitt (wie in der App)</div>
        `;
        
        const btnRow = document.createElement('div');
        btnRow.style.display='flex';
        btnRow.style.gap='8px';
        btnRow.appendChild(acceptBtn);
        btnRow.appendChild(cancelBtn);
        editorContent.appendChild(btnRow);
        
        editor.onclick=(e)=>{
          if(e.target === editor){
            editor.remove();
            resolve(null);
          }
        };
        
        editor.appendChild(editorContent);
        document.body.appendChild(editor);
      };
    });
  }

  // --- Pickup Code Screen Event Handlers ---
  const btnPickupCodeBack = document.getElementById('btnPickupCodeBack');
  if(btnPickupCodeBack){
    btnPickupCodeBack.onclick = () => {
      showOrders(); // Zurück zu Tickets
    };
  }
  
  const btnCopyCode = document.getElementById('btnCopyCode');
  if(btnCopyCode){
    btnCopyCode.onclick = async () => {
      if(!currentPickupOrderId) return;
      const order = getOrderById(currentPickupOrderId);
      if(!order) return;
      // Code nur kopieren wenn PAID
      if(order.status !== 'PAID'){
        alert('Abholcode wird nach erfolgreicher Zahlung generiert.');
        return;
      }
      const code = order.pickupCode || order.code || '';
      if(!code) return;
      
      // Clipboard API nutzen
      try{
        if(navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(code);
          btnCopyCode.innerHTML = '<i data-lucide="check"></i> Kopiert!';
          setTimeout(()=>{
            btnCopyCode.innerHTML = '<i data-lucide="copy"></i> Code kopieren';
            if(typeof lucide !== 'undefined') lucide.createIcons();
          }, 2000);
          if(typeof lucide !== 'undefined') lucide.createIcons();
          return;
        }
      } catch(e){
        // Fallback
      }
      
      // Fallback: select + copy
      const textarea = document.createElement('textarea');
      textarea.value = code;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      try{
        document.execCommand('copy');
        btnCopyCode.innerHTML = '<i data-lucide="check"></i> Kopiert!';
        setTimeout(()=>{
          btnCopyCode.innerHTML = '<i data-lucide="copy"></i> Code kopieren';
          if(typeof lucide !== 'undefined') lucide.createIcons();
        }, 2000);
        if(typeof lucide !== 'undefined') lucide.createIcons();
      } catch(e){
        // Fehler
      }
      document.body.removeChild(textarea);
    };
  }
  
  // --- Fullscreen Code Modal Functions ---
  let wakeLock = null;
  
  /**
   * Open fullscreen code modal
   * @param {string} code - Pickup code (without spaces)
   */
  function openFullscreenCode(code){
    if(!code) return;
    
    const modal = document.getElementById('fullscreenCode');
    const valueEl = document.getElementById('fullscreenCodeValue');
    const backdrop = document.getElementById('fullscreenCodeBd');
    
    if(!modal || !valueEl) return;
    
    // Code mit Zwischenräumen formatieren: "A  B  1  2  C"
    const formattedCode = code.split('').join('  ');
    valueEl.textContent = formattedCode;
    
    // Modal anzeigen
    modal.classList.add('active');
    if(backdrop) backdrop.classList.add('active');
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(() => lucide.createIcons(), 50);
    }
    
    // Optional: WakeLock API (MVP+)
    if(navigator.wakeLock){
      navigator.wakeLock.request('screen').then(lock => {
        wakeLock = lock;
      }).catch(err => {
        console.log('WakeLock not available:', err);
      });
    }
    
    // Esc schließt Modal
    const handleKeyDown = (e) => {
      if(e.key === 'Escape'){
        closeFullscreenCode();
        document.removeEventListener('keydown', handleKeyDown);
      }
    };
    document.addEventListener('keydown', handleKeyDown);
  }
  
  /**
   * Close fullscreen code modal
   */
  function closeFullscreenCode(){
    const modal = document.getElementById('fullscreenCode');
    const backdrop = document.getElementById('fullscreenCodeBd');
    
    if(modal) modal.classList.remove('active');
    if(backdrop) backdrop.classList.remove('active');
    
    // WakeLock freigeben
    if(wakeLock){
      wakeLock.release().catch(err => {
        console.log('WakeLock release error:', err);
      });
      wakeLock = null;
    }
  }
  
  const btnShowFullscreenCode = document.getElementById('btnShowFullscreenCode');
  if(btnShowFullscreenCode){
    btnShowFullscreenCode.onclick = () => {
      if(!currentPickupOrderId) return;
      const order = getOrderById(currentPickupOrderId);
      if(!order) return;
      // Code nur anzeigen wenn PAID
      if(order.status === 'PAID'){
        const code = order.pickupCode || order.code || '';
        if(code) openFullscreenCode(code);
      } else {
        alert('Abholcode wird nach erfolgreicher Zahlung generiert.');
      }
    };
  }
  
  const btnOpenRoute = document.getElementById('btnOpenRoute');
  if(btnOpenRoute){
    btnOpenRoute.onclick = () => {
      if(!currentPickupOrderId) return;
      const order = getOrderById(currentPickupOrderId);
      if(!order) return;
      const address = order.providerAddress || '';
      if(address){
        // Route öffnen (öffnet Maps mit providerAddress)
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
        window.open(mapsUrl, '_blank');
      } else {
        alert('Adresse nicht verfügbar.');
      }
    };
  }
  
  const btnToOrders = document.getElementById('btnToOrders');
  if(btnToOrders){
    btnToOrders.onclick = () => {
      showOrders(); // Zu Tickets
    };
  }
  
  // Fullscreen Code Modal: Tap anywhere to close
  const fullscreenCodeBd = document.getElementById('fullscreenCodeBd');
  if(fullscreenCodeBd){
    fullscreenCodeBd.onclick = () => {
      closeFullscreenCode();
    };
  }
  
  const fullscreenCodeClose = document.querySelector('.fullscreen-code-close');
  if(fullscreenCodeClose){
    fullscreenCodeClose.onclick = () => {
      closeFullscreenCode();
    };
  }
  
  // --- boot ---
  // Testdaten erstellen (nur wenn keine vorhanden oder für Demo)
  // Alte seed() Funktion - wird durch seedExampleData() ersetzt
  // seed(); // Auskommentiert, da seedExampleData() die neuen Beispieldaten lädt
  
  // Neue Beispieldaten laden (10 Anbieter, je 3 Gerichte, je 10 Abholcodes)
  // Nur wenn keine Offers vorhanden oder für Demo
  if(offers.length === 0 || true){ // true für Demo - immer neu generieren
    seedExampleData();
  }
  offers = offers.map(normalizeOffer);
  save(LS.offers, offers);
  
  // Orders laden
  orders = loadOrders();
  
  // --- Route Handler: Checkout Success/Cancel + Abholcode ---
  // Routes:
  //   /checkout/success?session_id=xxx OR ?orderId=xxx
  //   /checkout/cancel?orderId=xxx OR ?session_id=xxx
  //   /abholcode/:orderId (via URL hash or query param)
  {
    const urlParams = new URLSearchParams(window.location.search);
    const path = window.location.pathname;
    const hash = window.location.hash;
    
    // Success Route: /checkout/success
    if(path.includes('/checkout/success') || urlParams.has('session_id') || (urlParams.has('success') && urlParams.has('orderId'))){
      const sessionId = urlParams.get('session_id');
      const orderId = urlParams.get('orderId');
      
      if(sessionId || orderId){
        handleCheckoutSuccess(sessionId, orderId);
        // Clean URL (remove query params)
        window.history.replaceState({}, '', window.location.pathname);
      }
    }
    
    // Cancel Route: /checkout/cancel
    if(path.includes('/checkout/cancel') || (urlParams.has('cancel') && (urlParams.has('orderId') || urlParams.has('session_id')))){
      const orderId = urlParams.get('orderId');
      const sessionId = urlParams.get('session_id');
      if(orderId || sessionId){
        handleCheckoutCancel(orderId, sessionId);
        // Clean URL
        window.history.replaceState({}, '', window.location.pathname);
      }
    }
    
    // Legal Pages Routes: /impressum, /agb-kurz, /datenschutz
    if(hash){
      const legalRoutes = {
        '#/impressum': 'impressum',
        '#/agb-kurz': 'agb-kurz',
        '#/datenschutz': 'datenschutz'
      };
      if(legalRoutes[hash]){
        showLegalPage(legalRoutes[hash]);
      }
    }
    
    // Hash-Change Listener für Legal Pages
    window.addEventListener('hashchange', function(){
      const hash = window.location.hash;
      const legalRoutes = {
        '#/impressum': 'impressum',
        '#/agb-kurz': 'agb-kurz',
        '#/datenschutz': 'datenschutz'
      };
      if(legalRoutes[hash]){
        showLegalPage(legalRoutes[hash]);
      }
    });
    
    // Abholcode Route: /abholcode/:orderId
    // Support: /abholcode?orderId=xxx OR hash #abholcode/:orderId
    if(path.includes('/abholcode') || hash.includes('#abholcode/') || urlParams.has('abholcode')){
      let orderId = null;
      
      // Try hash first: #abholcode/:orderId
      if(hash.includes('#abholcode/')){
        orderId = hash.split('#abholcode/')[1]?.split('?')[0]?.split('#')[0];
      }
      
      // Try query param: ?abholcode=xxx or ?orderId=xxx
      if(!orderId){
        orderId = urlParams.get('abholcode') || urlParams.get('orderId');
      }
      
      if(orderId){
        showPickupCode(orderId);
        // Clean URL
        window.history.replaceState({}, '', window.location.pathname);
      }
    }
  } // Ende Route Handler Block
  
  // Initialisierung startet
  renderChips();

  // init nav bindings
  if(mode==='provider' && !provider.loggedIn) mode='customer';
  if(mode==='start') mode='customer';
  setMode(mode);
  
  updateProfileView();
  
  if(mode === 'customer'){
    setTimeout(()=>{
      if(typeof renderDiscover !== 'undefined'){
        renderDiscover();
      }
      if(typeof lucide !== 'undefined'){
        setTimeout(()=> lucide.createIcons(), 150);
      }
    }, 100);
  }
  
  if(mode === 'start'){
    setTimeout(()=>{
      if(typeof renderStart !== 'undefined'){
        renderStart();
      }
    }, 200);
  }
} // Fehlende schließende Klammer
</script>

<script>
  // Icon-Initialisierung (immer, nicht nur bei Service Worker)
  function initIcons(){
    if(typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function'){
      lucide.createIcons();
    } else {
      // Warte bis Lucide geladen ist (max. 2 Sekunden)
      let attempts = 0;
      const checkLucide = setInterval(()=>{
        attempts++;
        if(typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function'){
          lucide.createIcons();
          clearInterval(checkLucide);
        } else if(attempts > 20){ // Nach 2 Sekunden aufgeben
          clearInterval(checkLucide);
        }
      }, 100);
    }
  }

  // Beispieldaten laden: 10 Anbieter mit je 3 Gerichten und 10 Abholcodes
  // WICHTIG: seedExampleData() NACH seed() aufrufen, damit die neuen Daten nicht überschrieben werden
  // seedExampleData() wird am Ende aufgerufen (siehe unten)
  
  // Test-Funktion global verfügbar machen (in Browser-Konsole: testPickupCodeLogic() aufrufen)
  if(typeof testPickupCodeLogic !== 'undefined'){
    window.testPickupCodeLogic = testPickupCodeLogic;
  }

  // PWA (optional)
  // TEMPORÄR DEAKTIVIERT ZUM TESTEN
  if(false && 'serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      // Service Worker-Pfad relativ zum aktuellen Verzeichnis
      const swPath = document.querySelector('base') ? 'sw.js' : './sw.js';
      navigator.serviceWorker.register(swPath).catch(()=>{});
      // Icons initialisieren
      initIcons();
      // Profile-View aktualisieren
      if(typeof updateProfileView !== 'undefined'){
        updateProfileView();
      }
      // Startseite rendern, falls im start-Mode
      if(typeof mode !== 'undefined' && mode === 'start' && typeof renderStart !== 'undefined'){
        setTimeout(()=>{
          renderStart();
          initIcons();
        }, 100);
      }
    });
  } else {
    // Fallback: Icons auch ohne Service Worker initialisieren
    window.addEventListener('load', ()=>{
      initIcons();
      // Profile-View aktualisieren
      if(typeof updateProfileView !== 'undefined'){
        updateProfileView();
      }
      // Startseite rendern, falls im start-Mode
      if(typeof mode !== 'undefined' && mode === 'start' && typeof renderStart !== 'undefined'){
        setTimeout(()=>{
          renderStart();
          initIcons();
        }, 100);
      }
    });
  }

  // Icons nach jedem View-Wechsel aktualisieren
  if(typeof showView !== 'undefined'){
    const originalShowView = showView;
    showView = function(id){
      originalShowView(id);
      setTimeout(()=> initIcons(), 50);
    };
  }
</script>
</body>
</html>
