  <!doctype html>
<html lang="de">
<head>
  <base href="/mittagio/app/">
  <meta charset="utf-8" />
  <!-- Mobile-Optimierung: viewport für App-like Darstellung (viewport-fit=cover für Notch/Safe-Area) -->
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=5,user-scalable=yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Mittagio</title>
  <meta name="theme-color" content="#FFD700" />
  <!-- Init-Gate: kein Flackern beim Hard-Reload – Body erst nach View-Switch sichtbar -->
  <style>body{visibility:hidden;}</style>
  <!-- WhatsApp/Link-Vorschau: Standard-OG (provider-spezifisch ggf. per Server) -->
  <meta property="og:title" content="Mittagio – Wochenplan" />
  <meta property="og:description" content="Unser Wochenplan ist online! Entdecke Gerichte und bestelle mit Abholnummer." />
  <meta property="og:image" content="https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&amp;fit=crop&amp;w=1200&amp;q=80" />
  <meta property="og:type" content="website" />
  <!-- Build: 2026-02-04 -->
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="assets/icons/icon-192.png" />
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png" />
  <script>if(typeof history!=='undefined'&&history.scrollRestoration)history.scrollRestoration='manual';</script>
  <script src="https://unpkg.com/lucide@0.460.0/dist/umd/lucide.min.js" onload="if(typeof lucide !== 'undefined') try { lucide.createIcons(); } catch(e) { console.warn('Lucide init:', e); }"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Montserrat:wght@400;600;700;900&family=Kalam:wght@400;700&family=Permanent+Marker&family=Nunito:wght@600;700;800&family=Quicksand:wght@500;600;700&display=swap');
    :root{
      /* Mittagio High-End Farbpalette */
      --bg:#F7F6F0; /* Standard-Hintergrund */
      --bg-polaroid:#E8E0D6; /* Gebleichte Eiche (Polaroid-Discovery Hintergrund) */
      --card:#FFFFFF;
      --text:#334155;   /* Slate Grey - edler als reines Schwarz */
      --muted:#6b6b6b;
      --border:#e7e1d5;
      --shadow:0 10px 24px rgba(0,0,0,.08);
      --shadow2:0 16px 40px rgba(0,0,0,.14);
      --radius:24px;     /* rounded-3xl for messenger vibe */
      --brand:#FFD700;   /* Mittagio Gold - Primär (Korb, Abholnummer-Buttons) */
      --brand2:#2ECC71;  /* Erfolgs-Grün - Profit (Netto-Umsatz) */
      --brand3:#27AE60;  /* Mehrweg-Grün - Dezent (Blatt-Icon) */
      --sticker-green:#27AE60; /* Preis-Sticker & Mehrweg-Badge (Polaroid-Card) */
      --danger:#E34D4D;
      --font-polaroid-marker:'Permanent Marker', 'Kalam', cursive;
      
      /* Design Tokens - PWA Light */
      /* Radius */
      --r-sm: 10px;
      --r-md: 14px;
      --r-lg: 18px;
      --r-xl: 24px;
      --r-full: 999px;
      
      /* Spacing */
      --s-1: 4px;
      --s-2: 8px;
      --s-3: 12px;
      --s-4: 16px;
      --s-5: 20px;
      --s-6: 24px;
      --s-8: 32px;
      --card-padding: 20px; /* Einheitliches Padding für alle Karten (Anbieter & Kunde) */
      
      /* Typography */
      --font-title: 18px;
      --font-title-lg: 20px;
      --font-body: 14px;
      --font-body-lg: 16px;
      --font-meta: 12px;
      --font-meta-sm: 13px;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;
      
      /* Colors (Light) */
      --color-bg: #FFFFFF;
      --color-surface: #FFFFFF;
      --color-border: #EAEAEA;
      --color-text: #1A1A1A;
      --color-text-secondary: #6B6B6B;
      --color-brand-yellow: #FFD700;  /* Mittagio Gold */
      --color-emerald: #10b981;       /* High-Tech-Gastro Akzent (Inseratsflow, Pills) */
      --color-success-green: #2ECC71;  /* Erfolgs-Grün - Profit */
      --color-eco-green: #27AE60;      /* Mehrweg-Grün - Dezent */
      --color-slate-text: #334155;     /* Slate Grey - Texte */
      --color-soft-yellow-bg: rgba(255, 204, 0, 0.15);
      --color-soft-green-bg: rgba(31, 157, 85, 0.12);
      --color-soft-grey-bg: rgba(0, 0, 0, 0.06);
      
      /* Icon Sizes */
      --icon-inline: 16px;
      --icon-inline-lg: 18px;
      --icon-header: 20px;
      --icon-header-lg: 22px;
      --icon-nav: 22px;
      --icon-nav-lg: 24px;
      
      /* Button Heights */
      --btn-height-min: 44px;
      --btn-height-md: 48px;
      
      /* Badge */
      --badge-height: 24px;
      --badge-px: 10px;
      --badge-px-lg: 12px;
    }
    *{box-sizing:border-box}

    /* ========== TRENNUNG KUNDE / ANBIETER (PFLICHT) ==========
     * Jede layout-kritische Regel (height, overflow, scroll) MUSS einen der beiden Scopes haben:
     * - NUR ANBIETER: body.provider-mode ... oder [id^="v-provider-"] ...
     * - NUR KUNDE:    body:not(.provider-mode) ...
     * Keine gemeinsamen Regeln für #app/main/body mit height/overflow – sonst bricht eine Seite die andere.
     * ========== */

    /* VIEW-SWITCH: nur aktive View sichtbar (gemeinsam) */
    #app .view:not(.active){ display:none !important; min-height:0 !important; visibility:hidden !important; }
    #app .view.active{ display:block !important; }
    body.provider-mode #app .view.active{ min-height:100dvh; min-height:100vh; }
    #app .view.active#v-pickup-code{ display:flex !important; }
    #app .view.active[id^="v-provider-"]{ display:block !important; }
    #app .view.active#v-provider-week{ display:flex !important; }
    .backdrop:not(.active){ display:none !important; opacity:0 !important; }
    .sheet:not(.active){ visibility:hidden !important; pointer-events:none !important; }

    html,body{height:100%; margin:0; padding:0; overflow-x:hidden}
    body{
      margin:0; padding:0;
      font-family:'Inter', 'Montserrat', system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-size:16px; line-height:1.5;
      background:var(--bg); color:var(--text);
      -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none;
      touch-action: pan-y pinch-zoom; overscroll-behavior-y: none;
    }
    body.provider-mode{ overflow-y:hidden; }

    body:not(.provider-mode) #providerStatusIndicator,
    body:not(.provider-mode) #statusIndicatorDot { display: none !important; }
    a{color:inherit}

    /* App shell: NUR unkritische Gemeinsamkeiten (kein height/overflow für beide) */
    .app,#app{ display:flex; flex-direction:column; box-sizing:border-box; overflow-x:hidden; }
    .app main,#app main{ display:block; }
    .app{ padding-bottom:calc(78px + env(safe-area-inset-bottom, 0px)); }

    /* ========== NUR ANBIETER (body.provider-mode) – keine Regel hier darf Kunde betreffen ========== */
    body.provider-mode .app, body.provider-mode #app{ min-height:100dvh; height:100dvh; max-height:100dvh; overflow:hidden; }
    body.provider-mode .app main, body.provider-mode #app main{ flex:1; min-height:0; overflow-y:auto; -webkit-overflow-scrolling:touch; }

    /* ========== NUR KUNDE (body:not(.provider-mode)) – keine Regel hier darf Anbieter betreffen ========== */
    body:not(.provider-mode) .app, body:not(.provider-mode) #app{ min-height:100%; min-height:100dvh; }
    body:not(.provider-mode) .app main, body:not(.provider-mode) #app main{ min-height:auto; overflow-y:visible; -webkit-overflow-scrolling:touch; }
    .topbar{
      position:sticky; top:0; z-index:10;
      background:rgba(247,246,240,.92);
      backdrop-filter:saturate(160%) blur(8px);
      -webkit-backdrop-filter:saturate(160%) blur(8px);
      border-bottom:1px solid var(--border);
      padding-top:env(safe-area-inset-top, 0px);
      padding-left:env(safe-area-inset-left, 0);
      padding-right:env(safe-area-inset-right, 0);
    }
    .topbar-inner{max-width:980px; margin:0 auto; padding:12px 16px; display:flex; align-items:center; gap:10px;}
    .header-basket-btn{
      position:relative;
      background:none;
      border:none;
      cursor:pointer;
      padding:8px;
      transition:transform 0.2s ease, filter 0.3s ease;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .header-basket-btn:hover{
      transform:scale(1.1);
    }
    .header-basket-btn:active{
      transform:scale(0.95);
    }
    .header-basket-btn.bounce{
      animation:basketBounce 0.5s ease;
    }
    .header-basket-btn.glow{
      filter:drop-shadow(0 0 12px rgba(255,215,0,0.8));
    }
    @keyframes basketBounce{
      0%, 100%{transform:scale(1);}
      50%{transform:scale(1.2);}
    }
    .header-basket-badge{
      position:absolute;
      top:4px;
      right:4px;
      width:18px;
      height:18px;
      background:#FFD700;
      color:#2D3436;
      border-radius:50%;
      font-size:11px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
      border:2px solid #fff;
      box-shadow:0 2px 8px rgba(0,0,0,0.15);
    }
    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
      cursor:pointer;
      transition:opacity 0.2s ease;
    }
    .brand:hover{
      opacity:0.8;
    }
    .brand:active{
      opacity:0.6;
    }
    .brand-badge{
      width:38px; height:38px; border-radius:12px;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      box-shadow:0 8px 18px rgba(0,0,0,.16);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .brand-badge img{width:100%; height:100%; object-fit:cover; display:block}
    .brand-name{font-weight:900; letter-spacing:.06em; font-size:20px; white-space:nowrap}
    .spacer{flex:1}

    .chiprow{
      max-width:980px; margin:0 auto; padding:6px 14px 8px;
      display:flex; gap:8px; overflow:auto; -webkit-overflow-scrolling:touch;
    }
    
    /* Verzehrart-Buttons: Active-State mit gelber Hintergrundfarbe */
    .verzehrmodus-checkout-btn.active,
    .verzehrmodus-cart-btn.active{
      background:#FFD700 !important;
      border-color:#FFD700 !important;
      color:#2D3436 !important;
      font-weight:900 !important;
    }
    .verzehrmodus-checkout-btn:not(.active),
    .verzehrmodus-cart-btn:not(.active){
      background:#fff !important;
      border-color:#e7e1d5 !important;
      color:#666 !important;
      font-weight:600 !important;
    }
    .verzehrmodus-checkout-btn:hover:not(.active),
    .verzehrmodus-cart-btn:hover:not(.active){
      border-color:#FFD700 !important;
      background:#fffbf0 !important;
    }
    
    /* Pickup Card Styles (Anbieter: helles Layout) */
    .pickup-card {
      background: #fff;
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 16px;
      padding: 16px;
      position: relative;
      overflow: hidden;
      transition: all 0.2s;
      cursor: pointer;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    }
    .pickup-card:active {
      transform: scale(0.98);
    }
    .pickup-card.status-done {
      opacity: 0.6;
      background: #f8f7f2;
    }
    .pickup-card.status-paid {
      border-color: rgba(34, 197, 94, 0.3);
    }
    .pickup-card.just-done {
      animation: pickupDoneAnim 0.4s ease forwards;
    }
    @keyframes pickupDoneAnim {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 1; background: #2ecc71; }
      100% { transform: scale(0.95); opacity: 0; }
    }
    
    .chip{
      flex:0 0 auto;
      border:1px solid var(--border);
      background:#f8f7f3;
      padding:10px 16px;
      border-radius:999px;
      font-size:14px;
      font-weight:800;
      color:#222;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .chip.active{
      border-color:rgba(31,157,85,.45);
      background:rgba(31,157,85,.12);
      box-shadow:0 10px 22px rgba(31,157,85,.12)
    }

    .pickup-group{
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      padding:10px;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .pickup-group + .pickup-group{margin-top:10px}
    .pickup-head{display:flex; align-items:center; justify-content:space-between; gap:8px; font-weight:900}
    .pickup-sub{font-size:12px; color:var(--muted)}
    .code-chip{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px; border:1px solid var(--border);
      background:#fff; font-size:12px; font-weight:900;
      margin:4px 6px 0 0; box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .code-chip.done{background:rgba(31,157,85,.12); border-color:rgba(31,157,85,.4); color:#1f9d55; text-decoration:line-through}

    /* Abholnummer Card Animation (Pulse/Shimmer) */
    /* Match-Screen Animationen */
    @keyframes scaleIn {
      0% { transform: scale(0); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    @keyframes slideUp {
      0% { transform: translateY(20px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    @keyframes abholnummerPulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
      }
      50% {
        transform: scale(1.01);
        box-shadow: 0 25px 30px -5px rgba(255,204,0,0.15), 0 15px 15px -5px rgba(255,204,0,0.08);
      }
    }
    @keyframes abholnummerShimmer {
      0% {
        background-position: -200% 0;
      }
      100% {
        background-position: 200% 0;
      }
    }
    .ticket-card-pulse {
      animation: abholnummerPulse 2s ease-in-out infinite;
    }
    .ticket-card-pulse::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: abholnummerShimmer 3s ease-in-out infinite;
    }

    .dayrow{
      max-width:980px; margin:0 auto; padding:0 14px 12px;
      display:flex; gap:8px; overflow:auto; -webkit-overflow-scrolling:touch;
    }
    .day{
      flex:0 0 auto;
      border:none;
      background:#fff;
      padding:12px 16px;
      border-radius:999px;
      font-size:14px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      border:1px solid var(--border);
    }
    .day.active{background:rgba(242,183,5,.14); border-color:rgba(242,183,5,.55)}

    body:not(.provider-mode) main{ max-width:980px; margin:0 auto; padding:16px; }
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    @media (min-width:820px){ .grid{grid-template-columns:1fr 1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:20px;
      overflow:hidden;
      box-shadow:0 4px 16px rgba(0,0,0,.08);
      cursor:pointer;
      position:relative;
      margin-bottom:16px;
    }
    /* Polaroid-Discovery: Weißer Rand – schmaler an den Seiten, breiter unter dem Text */
    .card.polaroid{
      background:#FFFFFF;
      border:none;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
      padding:0 6px 20px 6px; /* schmaler seitlich, breiter unten */
      display:flex;
      flex-direction:column;
      align-items:stretch;
      width:100%;
      max-width:100%;
      margin:0 auto;
      overflow:hidden;
      background:linear-gradient(135deg, #f5f1eb 0%, #ede8e0 100%);
      box-sizing:border-box;
    }
    @media (max-width: 480px) {
      .card.polaroid {
        padding:0 5px 16px 5px;
      }
    }
    .card.playful{
      border-color:rgba(242,183,5,.38);
      box-shadow:0 12px 26px rgba(242,183,5,.18);
    }
    .card.playful .body{
      background:linear-gradient(180deg,#fff, #fff4e6);
    }
    .card.playful .price{color:#b26b00}
    .card.playful .tag{background:rgba(242,183,5,.25)}
    .img{aspect-ratio:16/9; height:auto; min-height:120px; max-height:140px; background:#eee; position:relative; overflow:hidden; border-radius:20px 20px 0 0}
    .img img{width:100%; height:100%; object-fit:cover; display:block}
    /* Polaroid: Foto nimmt exakt 50% der Kachelhöhe ein */
    .card.polaroid .img{
      width:100%;
      height:50%; /* Exakt 50% der Kartenhöhe */
      min-height:140px;
      max-height:140px;
      border-radius:0;
      position:relative;
      overflow:hidden;
      flex-shrink:0;
    }
    
    /* Badge-Overlay oben links auf dem Bild */
    .badge-overlay {
      position: absolute;
      top: 8px;
      left: 8px;
      display: flex;
      gap: 6px;
      z-index: 10;
    }
    
    /* Der einzelne kreisrunde Badge-Button */
    .badge-icon {
      width: 28px;
      height: 28px;
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    /* Bild innerhalb des Badges */
    .badge-icon img {
      width: 18px;
      height: 18px;
      object-fit: contain;
    }
    
    /* 3 Säulen: Modern Badges (Icon + Text) */
    .pillar-bars {
      display: flex;
      gap: 12px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(0,0,0,0.05);
    }
    .pillar-badge {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      opacity: 0.4;
      filter: grayscale(1);
      transition: all 0.3s ease;
    }
    .pillar-badge.active {
      opacity: 1;
      filter: grayscale(0);
    }
    
    .pillar-icon-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f0f0f0;
      color: #666;
      font-size: 14px;
      transition: all 0.3s;
    }
    .pillar-badge.active.green .pillar-icon-circle { background: rgba(39, 174, 96, 0.15); color: #27AE60; }
    .pillar-badge.active.yellow .pillar-icon-circle { background: rgba(255, 215, 0, 0.2); color: #1a1a1a; }
    .pillar-badge.active.blue .pillar-icon-circle { background: rgba(52, 152, 219, 0.15); color: #3498db; }
    
    .pillar-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #999;
      text-align: center;
    }
    .pillar-badge.active .pillar-label { color: #333; }
    
    /* Detailseite Gericht: 5 Icons + ⓘ wie Inseratsflow, Emerald-Glow [cite: 2026-02-16] */
    #sheet .detail-power-bar { display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap; padding: 12px 20px 20px; border-bottom: 1px solid rgba(0,0,0,0.03); }
    #sheet .detail-power-bar .detail-pillar-btn {
      min-width: 44px; min-height: 44px; width: 44px; height: 44px; border-radius: 12px; display: inline-flex; align-items: center; justify-content: center; font-size: 20px;
      border: 2px solid rgba(0,0,0,0.08); background: rgba(0,0,0,0.04); cursor: pointer; transition: background 0.2s, box-shadow 0.2s, transform 0.1s; -webkit-tap-highlight-color: transparent;
    }
    #sheet .detail-power-bar .detail-pillar-btn.active { background: #fff; border-color: #10b981; box-shadow: 0 2px 10px rgba(16,185,129,0.3); color: #1a1a1a; }
    #sheet .detail-power-bar .detail-pillar-btn:not(.active) { opacity: 0.6; filter: grayscale(0.4); }
    #sheet .detail-power-bar .detail-pillar-btn:active { transform: scale(0.92); }
    #sheet .detail-power-bar .detail-legend-btn { min-width: 36px; min-height: 36px; width: 36px; height: 36px; border: none; background: transparent; color: #94a3b8; font-size: 14px; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; -webkit-tap-highlight-color: transparent; }
    
    .card.polaroid .img img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .provider-logo{
      display:flex; align-items:center; gap:8px;
      padding:12px 14px 0;
    }
    .plogo{
      width:28px; height:28px; border-radius:8px;
      background:#f2f2f2;
      overflow:hidden;
      border:1px solid var(--border);
      flex:0 0 auto;
    }
    .plogo img{width:100%; height:100%; object-fit:cover; display:block}
    .pname{font-size:14px; font-weight:900; color:#222; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; line-height:1.3}

    .body{padding:16px}
    .title{font-weight:950; font-size:18px; margin:0; line-height:1.3}
    .sub{margin:4px 0 0; color:#444; font-size:14px; line-height:1.4}
    
    /* Refactored Card Styles - weniger Text, mehr Icons */
    .card-heart{
      position:absolute; top:12px; right:12px; z-index:5;
      width:36px; height:36px; border-radius:50%;
      border:none; background:rgba(255,255,255,.9);
      backdrop-filter:blur(8px); display:flex;
      align-items:center; justify-content:center;
      cursor:pointer; transition:all .2s;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
    }
    .card-heart:hover{background:rgba(255,255,255,1); transform:scale(1.05)}
    .card-heart.on{background:rgba(255,204,0,.2)}
    .card-heart i{width:18px; height:18px; color:#999}
    .card-heart.on i{color:#e74c3c; fill:currentColor}
    
    .card-title-row{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:8px; margin-bottom:6px;
    }
    .card-title{
      font-weight:900; font-size:17px; margin:0;
      line-height:1.3; flex:1; min-width:0;
      display:-webkit-box; -webkit-line-clamp:2; line-clamp:2;
      -webkit-box-orient:vertical; overflow:hidden;
      color:#111;
    }
    .card-provider{
      font-size:13px; color:#666; margin:0 0 8px;
      line-height:1.3; font-weight:500;
      display:flex; align-items:center; gap:6px;
    }
    .card-provider .ico-inline{
      width:16px; height:16px; flex-shrink:0;
      color:var(--muted);
    }
    .card-provider .ico-inline svg{
      width:16px; height:16px;
    }
    .card-price{
      font-size:24px; font-weight:950; color:var(--brand);
      margin:0 0 10px; line-height:1;
    }
    .card-info-badges{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-bottom:10px; align-items:center;
    }
    .card-info-badge{
      display:inline-flex; align-items:center; gap:4px;
      font-size:13px; font-weight:600; color:#666;
      white-space:nowrap;
    }
    .card-info-badge .ico-inline{
      width:16px; height:16px; flex-shrink:0;
      color:var(--muted);
    }
    .card-info-badge .ico-inline svg{
      width:16px; height:16px;
    }
    .card-status-badges{
      display:flex; gap:6px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .card-status-badge{
      display:inline-flex; align-items:center; gap:4px;
      padding:4px 10px; border-radius:999px;
      font-size:11px; font-weight:600;
      background:rgba(0,0,0,.06); color:#666;
      white-space:nowrap;
    }
    .card-status-badge .ico-inline{
      width:14px; height:14px; flex-shrink:0;
    }
    .card-status-badge .ico-inline svg{
      width:14px; height:14px;
    }
    /* Abholnummer Badge: leicht hervorgehoben (Markenfarbe Gelb) */
    .card-status-badge.code{
      background:rgba(255,204,0,.2); color:#b8860b;
      font-weight:700;
    }
    .card-status-badge.code .ico-inline{color:#b8860b}
    /* Badge-Styles Abholnummer */
    .card-status-badge.dine{
      background:rgba(31,157,85,.12); color:#1f9d55;
    }
    .card-status-badge.dine .ico-inline{color:#1f9d55}
    /* Zum Mitnehmen Badge: neutrale weiche Füllung */
    .card-status-badge.pickup{
      background:rgba(0,0,0,.06); color:#666;
    }
    /* Konzept-Icons: Mehrweg, Essen vor Ort, Abholnummer (einheitliche Größe) */
    .concept-icon{ width:22px; height:22px; object-fit:contain; vertical-align:middle; flex-shrink:0; }
    .concept-icon-lg{ width:28px; height:28px; object-fit:contain; vertical-align:middle; flex-shrink:0; }
    .concept-icon-xl{ width:36px; height:36px; object-fit:contain; vertical-align:middle; flex-shrink:0; }

    .meta{display:flex; justify-content:space-between; align-items:flex-end; gap:12px; margin-top:12px}
    .price{font-weight:950; font-size:18px; color:#0f5c4c}
    .right{ text-align:right; font-size:13px; color:var(--muted); line-height:1.4 }
    .meta-line{display:flex; align-items:center; gap:6px; justify-content:flex-end}
    .tag{display:inline-block; margin-top:6px; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:900; background:rgba(242,183,5,.18)}

    .badge{
      position:absolute; top:12px; left:12px;
      background:rgba(17,17,17,.72);
      color:#fff;
      font-size:12px; font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      box-shadow:0 10px 22px rgba(0,0,0,.18);
      line-height:1.3;
    }
    .badge.code{left:auto; right:12px; background:rgba(31,157,85,.9)}
    .badge.dine{background:rgba(242,183,5,.9); color:#111}
    .badge.inactive{background:rgba(0,0,0,.45)}

    .heart{
      position:absolute; top:12px; right:12px;
      width:36px; height:36px; border-radius:999px;
      border:none; cursor:pointer;
      background:rgba(255,255,255,.92);
      box-shadow:0 10px 22px rgba(0,0,0,.16);
      font-size:16px;
      color:#bbb;
      display:flex; align-items:center; justify-content:center;
    }
    .heart.on{color:var(--danger)}

    /* Bottom nav - Glassmorphism Mittagio-Bar */
    .nav-badge{
      position:absolute; top:4px; right:8px;
      width:18px; height:18px;
      background:#FFD700; color:#2D3436;
      border-radius:50%; font-size:11px; font-weight:900;
      display:flex; align-items:center; justify-content:center;
      border:2px solid #fff; box-shadow:0 2px 8px rgba(0,0,0,0.15);
      z-index:10;
    }
    .navbtn.bounce{
      animation:basketBounce 0.5s ease;
    }
    .navbtn.glow{
      filter:drop-shadow(0 0 12px rgba(255,215,0,0.8));
    }
    @keyframes basketBounce{
      0%, 100%{transform:scale(1);}
      50%{transform:scale(1.15);}
    }
    .bottom{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      height:calc(60px + env(safe-area-inset-bottom, 20px));
      padding-bottom:env(safe-area-inset-bottom, 20px);
      padding-left:env(safe-area-inset-left, 0);
      padding-right:env(safe-area-inset-right, 0);
      background:rgba(255,255,255,.85);
      backdrop-filter:saturate(180%) blur(20px);
      -webkit-backdrop-filter:saturate(180%) blur(20px);
      border-top:1px solid rgba(231,225,213,.3);
      display:flex;
      box-shadow:0 -4px 20px rgba(0,0,0,.05);
    }
    .navbtn{
      flex:1; border:none; background:none; cursor:pointer;
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
      color:#777; font-size:11px; font-weight:600;
      padding:8px 4px; transition:color .2s;
      position:relative;
      -webkit-tap-highlight-color: transparent;
    }
    .navbtn * {
      pointer-events: none;
    }
    .navbtn .ico{font-size:22px; display:inline-flex; align-items:center; justify-content:center}
    .navbtn .ico svg{width:22px; height:22px; stroke-width:2}
    /* Bottom Navigation Icons: 22-24px */
    .navbtn.active{color:var(--brand)}
    .navbtn.active .ico svg{color:var(--brand); stroke:var(--brand)}
    .navbtn.active{color:var(--brand); font-weight:900}
    .navbtn .badge-notification{
      position:absolute; top:8px; right:calc(50% - 20px);
      width:8px; height:8px; border-radius:50%;
      background:var(--brand); border:2px solid rgba(255,255,255,.85);
    }

    /* Views */
    /* Confetti Animation */
  @keyframes confetti-fall {
    0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
    100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
  }
  .confetti {
    position: fixed; width: 10px; height: 10px; background: #FFD700;
    top: -20px; z-index: 2000; pointer-events: none;
    animation: confetti-fall 3s linear forwards;
  }
  @keyframes success-checkmark-pulse {
    0%, 100% { transform: scale(1); box-shadow: 0 8px 24px rgba(16,185,129,0.25); }
    50% { transform: scale(1.05); box-shadow: 0 12px 32px rgba(16,185,129,0.35); }
  }
  #inseratSuccessSheet .inserat-success-checkmark { animation: success-checkmark-pulse 1.5s ease-in-out infinite; }

  .success-card-preview {
    background: #fff;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    border: 1px solid rgba(0,0,0,0.04);
    margin: 20px 0;
    text-align: left;
  }
  .success-card-img {
    width: 100%; height: 120px; object-fit: cover;
  }
  .success-card-body {
    padding: 16px;
  }
    .view.active{display:block}
    /* Abholnummer-Ansicht benötigt flex-Layout */
    .view.active#v-pickup-code{display:flex !important}

    /* Kundenseiten: Einheitlicher Style von Seite 1 (Discovery) – Farben & Look */
    .customer-view{
      background:var(--bg-polaroid);
      min-height:100vh;
      padding:0 12px 0;
      padding-bottom:calc(100px + env(safe-area-inset-bottom, 0px));
    }
    .customer-view .panel{
      background:rgba(255,255,255,0.95);
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
      border:1px solid rgba(0,0,0,0.06);
      border-radius:20px;
      box-shadow:0 4px 16px rgba(0,0,0,.06);
    }
    .customer-view .section-title{ color:#334155; }
    .customer-view .hint{ color:#64748b; }
    /* Topbar in Kundekontext: gleicher warmer Ton wie Seite 1 */
    .topbar.customer-context{
      background:rgba(232,224,214,0.92);
      border-bottom-color:rgba(0,0,0,0.08);
    }
    /* Provider-FAB und Abholnummer-Overlay in Kundenansicht nie anzeigen (auch beim Runterscrollen) */
    body:not(.provider-mode) #fabProviderAddOffer,
    body:not(.provider-mode) #fabProviderAddOfferLabel { display: none !important; }
    #fabProviderAddOfferLabel { display: none !important; }

    /* Sheets / modals – Safe-Area für moderne Handys (S25, iPhone, Pixel) */
    .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.6); opacity:0; pointer-events:none; transition:opacity .2s; z-index:2000}
    .backdrop.active{opacity:1; pointer-events:auto}
    /* Modals: nur sichtbar wenn .active – verhindert leeren Screen auf allen Anbieter-Seiten */
    #quickPostBd:not(.active),
    #publishFeeBd:not(.active),
    #inseratSuccessBd:not(.active),
    #saveSuccessSheetBd:not(.active),
    #abholnummerExplainBd:not(.active){ display:none !important; opacity:0 !important; pointer-events:none !important; }
    #pricingFairnessBd:not(.active){ display:none !important; opacity:0 !important; pointer-events:none !important; }
    #pricingFairnessOverlay:not(.active){ display:none !important; }
    #pricingFairnessOverlay.active{ display:block !important; }
    #quickPostSheet:not(.active),
    #publishFeeSheet:not(.active),
    #inseratSuccessSheet:not(.active),
    #saveSuccessSheet:not(.active),
    #abholnummerExplainSheet:not(.active){ visibility:hidden !important; pointer-events:none !important; }
    .sheet{
      position:fixed; left:0; right:0; bottom:-120%; z-index:2001;
      background:#fff; border-radius:22px 22px 0 0;
      box-shadow:var(--shadow2);
      transition:bottom .28s ease;
      max-height:92vh; overflow:auto;
      padding-left:env(safe-area-inset-left, 0);
      padding-right:env(safe-area-inset-right, 0);
      padding-bottom:env(safe-area-inset-bottom, 0);
    }
    .sheet.active{bottom:0}
    #publishFeeSheet.active,
    #saveSuccessSheet.active,
    #abholnummerExplainSheet.active{ bottom:0 !important; visibility:visible !important; }
    .abholnummer-explain-hero{ display:flex; overflow-x:auto; overflow-y:hidden; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; gap:0; scrollbar-width:none; }
    .abholnummer-explain-hero::-webkit-scrollbar{ display:none; }
    .abholnummer-explain-slide{ flex:0 0 100%; min-width:100%; scroll-snap-align:start; scroll-snap-stop:always; padding:0 24px 20px; box-sizing:border-box; }
    .abholnummer-explain-slide-img{ width:100%; aspect-ratio:4/3; border-radius:16px; object-fit:cover; background:#f1f3f5; }
    .abholnummer-explain-slide-body{ padding:16px 0; }
    .abholnummer-explain-slide-title{ margin:0 0 8px; font-size:20px; font-weight:900; color:#1a1a1a; }
    .abholnummer-explain-slide-sub{ margin:0; font-size:15px; color:#64748b; line-height:1.5; }
    .abholnummer-explain-dots{ display:flex; justify-content:center; gap:8px; padding:12px 0 20px; }
    .abholnummer-explain-dot{ width:8px; height:8px; border-radius:50%; background:#cbd5e1; border:none; padding:0; cursor:pointer; transition:background 0.2s; }
    .abholnummer-explain-dot.active{ background:#FFD700; }
    .handle{width:46px; height:5px; background:#ddd; border-radius:999px; margin:10px auto 6px}
    .sheet-img{height:260px; background:#eee}
    .sheet-img img{width:100%; height:100%; object-fit:cover; display:block}
    .sheet-body{padding:12px 14px 18px}
    .row{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px 0; border-top:1px solid #eee; font-size:15px; line-height:1.4}
    .btn{
      width:100%; border:none; cursor:pointer;
      border-radius:999px; padding:16px 20px; font-weight:950; font-size:16px;
      background:var(--brand); color:#111;
      line-height:1.4;
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn.secondary{background:#fff; border:1px solid var(--border)}
    .btn.ghost{background:#f8f7f3; border:1px solid var(--border)}
    .mini{font-size:13px; color:var(--muted); margin-top:8px; line-height:1.5}
    
    /* Primary CTA (Yellow, Dark Text, 56-64px) */
    .btn-primary{
      width:100%; border:none; cursor:pointer;
      border-radius:999px; padding:16px 20px; font-weight:950; font-size:16px;
      background:#f2b705; color:#111;
      line-height:1.4;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-height:56px; max-height:64px;
      transition: transform 0.1s cubic-bezier(0.4,0,0.2,1), box-shadow 0.1s ease, background 0.15s;
    }
    .btn-primary:hover{
      box-shadow:0 10px 28px rgba(242,183,5,0.35);
      transform:translateY(-1px);
    }
    .btn-primary:active{
      background:#e6b800;
      transform:scale(0.96);
      box-shadow:none;
      filter:brightness(0.95);
    }
    .btn-primary:disabled{
      opacity:.6; cursor:not-allowed; background:#f2b705;
    }
    .btn-primary.loading{
      opacity:.7; cursor:wait;
    }
    .btn-primary.success{
      background:#2e7d32; color:#fff;
    }

    .card-actions{display:flex; gap:8px; margin-top:12px}
    .card-action{
      flex:1; padding:0 16px; min-height:44px;
      border-radius:12px; border:none;
      background:#fff; font-weight:900; font-size:15px;
      cursor:pointer; transition:transform .1s, background .15s;
      display:flex; align-items:center; justify-content:center; gap:6px;
      text-align:center;
    }
    .card-action:active{transform:scale(.97)}
    .card-action.primary{
      background:var(--brand); color:#111;
      border:1px solid var(--brand);
      min-height:44px;
    }
    .card-action.primary:active{background:#e6b800}
    .card-action.ghost{background:#f8f7f3; border:1px solid var(--border)}
    .card-action:disabled{opacity:.5; cursor:not-allowed; background:#f5f5f5}

    /* Profile cards */
    .panel{background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:0 4px 16px rgba(0,0,0,.08); padding:var(--card-padding, 20px); margin-bottom:16px}
    .panel h3{margin:0 0 10px; font-size:18px; font-weight:900; line-height:1.3}
    .section-title{font-weight:900; font-size:20px; margin:12px 0 8px; line-height:1.3}
    .rowlist{display:flex; flex-direction:column; gap:8px}
    .rowbtn{
      width:100%; border:1px solid var(--border); background:#fff; cursor:pointer;
      border-radius:14px; padding:12px; text-align:left; font-weight:900;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .rowbtn-left{display:flex; align-items:center; gap:10px; min-width:0}
    .rowbtn-ico{
      width:36px; height:36px; border-radius:10px; flex:0 0 auto;
      border:1px solid var(--border); background:#f8f7f3;
      display:flex; align-items:center; justify-content:center;
    }
    .rowbtn-ico svg{width:16px; height:16px}
    .rowbtn-text{min-width:0}
    .rowbtn-text span{display:block; font-weight:600; font-size:13px; color:var(--muted); margin-top:4px; line-height:1.4}
    .rowbtn .chev{font-size:20px; color:var(--muted)}
    .rowgroup-title{font-size:13px; font-weight:900; color:var(--muted); margin-top:8px; line-height:1.4}
    .profile-head{display:flex; align-items:center; gap:12px}
    .profile-head .plogo{width:56px; height:56px; border-radius:50%}
    .profile-meta{display:flex; flex-direction:column; gap:4px}
    .profile-chip{display:inline-flex; align-items:center; gap:6px; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900; background:#fff}
    .profile-actions{margin-top:10px}
    .profile-actions .btn{width:auto; margin-top:0}
    .row-group{margin-top:12px}
    .row-group .rowgroup-title{margin:0 0 8px}
    .row-muted{font-size:12px; color:var(--muted)}

    .tabrow{display:flex; gap:8px; flex-wrap:wrap}
    .tabrow .ans{font-size:12px; padding:8px 10px}
    /* Kochbuch: MASTER-SPEC MagazinKochbuch – nur Pills, Magazin-Karte, Action-Bar (siehe docs/KOCHBUCH_KONZEPT.md) */
    #v-provider-cookbook .cookbook-action-bar{ max-width:500px; margin:0 auto; box-sizing:border-box; }
    #v-provider-cookbook .cookbook-bar-btn{ min-height:52px; border-radius:20px; font-size:10px; font-weight:800; letter-spacing:0.06em; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; border:none; transition:transform 0.12s; flex:1; min-width:0; }
    #v-provider-cookbook .cookbook-bar-btn:active{ transform:scale(0.97); }
    /* Kochbuch Magazin-Karte: feste Größe wie Magazin – keine Größenänderung beim Swipen/Blättern */
    #v-provider-cookbook .cookbook-magazine-card{ transition:box-shadow 0.2s ease; min-height:420px; }
    #v-provider-cookbook .cookbook-magazine-card .cookbook-magazine-img-wrap{ height:240px; min-height:240px; flex-shrink:0; overflow:hidden; position:relative; }
    #v-provider-cookbook .cookbook-magazine-dots{ display:flex; justify-content:center; gap:6px; margin-top:12px; flex-shrink:0; }
    #v-provider-cookbook .cookbook-magazine-dots .cookbook-dot{ width:8px; height:8px; border-radius:50%; background:rgba(0,0,0,0.15); transition:background 0.2s; }
    #v-provider-cookbook .cookbook-magazine-dots .cookbook-dot.on{ background:#10b981; }
    #v-provider-cookbook .cookbook-swipe-hint{ font-size:12px; color:#94a3b8; text-align:center; margin-top:8px; padding:6px 12px; }
    #v-provider-cookbook .cookbook-magazine-card:hover{ box-shadow:0 24px 48px rgba(0,0,0,0.15); }
    #v-provider-cookbook .cookbook-magazine-card:active{ box-shadow:0 20px 40px rgba(0,0,0,0.12); }
    #v-provider-cookbook .cookbook-bar-secondary{ background:rgba(255,255,255,0.5); color:#475569; border:2px solid rgba(255,255,255,0.6); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); }
    #v-provider-cookbook .cookbook-bar-primary{ background:#FACC15; color:#1a1a1a; box-shadow:0 4px 16px rgba(250,204,21,0.4); }
    /* Kochbuch: Kategorie-Pills wie Kundenseite (Discover) – kleiner, einheitliches Layout */
    #v-provider-cookbook .cookbook-category-pills{ display:flex; gap:10px; overflow-x:auto; padding:8px 16px 12px; -webkit-overflow-scrolling:touch; scrollbar-width:none; scroll-snap-type:x mandatory; }
    #v-provider-cookbook .cookbook-category-pills::-webkit-scrollbar{ display:none; }
    #v-provider-cookbook .cookbook-category-pills .cookbook-cat-pill{ flex:0 0 auto; scroll-snap-align:center; min-height:44px; min-width:auto; padding:10px 18px; border-radius:22px; font-size:14px; font-weight:700; border:none; background:#e5e7eb; color:#64748b; cursor:pointer; transition:transform 0.15s, background 0.2s; display:inline-flex; align-items:center; justify-content:center; -webkit-tap-highlight-color:transparent; }
    #v-provider-cookbook .cookbook-category-pills .cookbook-cat-pill:hover{ color:#1D1D1F; }
    #v-provider-cookbook .cookbook-category-pills .cookbook-cat-pill.on{ background:#10b981; border:none; color:#fff; box-shadow:0 2px 12px rgba(16,185,129,0.4); }
    #v-provider-cookbook .cookbook-category-pills .cookbook-cat-pill:active{ transform:scale(0.96); }
    #v-provider-cookbook #btnCookbookEmptyAdd{ background:#FACC15 !important; color:#1a1a1a !important; box-shadow:0 4px 20px rgba(250,204,21,0.4) !important; }
    /* Kochbuch Action-Sheet */
    #cookbookActionSheetBd{ z-index:999; }
    .cookbook-action-sheet{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:#fff;
      border-radius:20px 20px 0 0;
      padding:16px 20px calc(20px + env(safe-area-inset-bottom, 0));
      box-shadow:0 -4px 24px rgba(0,0,0,.12);
      border-top:1px solid rgba(0,0,0,0.06);
      z-index:1000;
    }
    .cookbook-action-sheet-handle{ width:40px; height:4px; background:rgba(0,0,0,0.15); border-radius:2px; margin:0 auto 16px; }
    .cookbook-action-sheet-title{ font-weight:800; font-size:18px; color:#1a1a1a; margin-bottom:16px; text-align:center; }
    .cookbook-action-sheet-btn{ width:100%; min-height:52px; border-radius:14px; background:#fff; border:1px solid rgba(0,0,0,0.06); color:#1a1a1a; font-weight:700; font-size:15px; margin-bottom:10px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; box-shadow:0 2px 8px rgba(0,0,0,0.03); }
    .cookbook-action-sheet-btn-yellow{ background:#FACC15; color:#1a1a1a; border:none; box-shadow:0 2px 12px rgba(250,204,21,0.3); }
    .cookbook-action-sheet-btn-primary{ background:#007AFF; color:#fff; border:none; box-shadow:0 2px 12px rgba(0,122,255,0.35); }
    .cookbook-action-sheet-btn-danger{ color:#dc2626; border-color:rgba(220,38,38,0.3); }
    .cookbook-week-sheet.cookbook-week-visible{ transform:translateY(0); }
    #cookbookWeekSheetBd.cookbook-week-bd-visible{ opacity:1; }
    #cookbookWeekSheet .cookbook-week-day-btn{ animation:cookbookWeekStagger 0.35s ease-out backwards; }
    #cookbookWeekSheet .cookbook-week-day-btn:nth-child(1){ animation-delay:0.03s; }
    #cookbookWeekSheet .cookbook-week-day-btn:nth-child(2){ animation-delay:0.06s; }
    #cookbookWeekSheet .cookbook-week-day-btn:nth-child(3){ animation-delay:0.09s; }
    #cookbookWeekSheet .cookbook-week-day-btn:nth-child(4){ animation-delay:0.12s; }
    #cookbookWeekSheet .cookbook-week-day-btn:nth-child(5){ animation-delay:0.15s; }
    #cookbookWeekSheet .cookbook-week-day-btn:nth-child(6){ animation-delay:0.18s; }
    #cookbookWeekSheet .cookbook-week-day-btn:nth-child(7){ animation-delay:0.21s; }
    @keyframes cookbookWeekStagger{ from{ opacity:0; transform:translateY(12px); } to{ opacity:1; transform:translateY(0); } }
    .cookbook-victory-overlay{ position:fixed; inset:0; z-index:1100; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.9); backdrop-filter:blur(8px); animation:cookbookVictoryFade 0.2s ease-out; }
    /* Success-Check: Spring (500, 15) – leichtes Nachfedern */
    .cookbook-victory-overlay .check-wrap{ width:72px; height:72px; border-radius:50%; background:rgba(255,222,0,0.2); border:3px solid var(--prov-brand); display:flex; align-items:center; justify-content:center; animation:cookbookVictoryPop 0.48s cubic-bezier(0.34, 1.4, 0.64, 1) forwards; }
    .cookbook-victory-overlay .check-wrap span{ font-size:40px; color:#1a1a1a; }
    @keyframes cookbookVictoryPop{ 0%{ transform:scale(0.8); opacity:0.9; } 70%{ transform:scale(1.05); } 100%{ transform:scale(1); opacity:1; } }
    @keyframes cookbookVictoryFade{ from{ opacity:0; } to{ opacity:1; } }
    .toast-soft-error{ background:#FF9500 !important; color:#fff !important; }
    .shake-horizontal{ animation:shakeH 0.3s ease-in-out; }
    @keyframes shakeH{ 0%,100%{ transform:translateX(0); } 20%{ transform:translateX(-5px); } 40%{ transform:translateX(5px); } 60%{ transform:translateX(-5px); } 80%{ transform:translateX(5px); } }
    .cart-line{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 0; border-top:1px solid #eee}
    .cart-left{font-weight:700; flex:1; min-width:0}
    .cart-qty{display:flex; align-items:center; gap:6px}
    .qty-btn{border:1px solid var(--border); background:#fff; border-radius:999px; width:28px; height:28px; cursor:pointer; font-weight:900; transition:all .15s}
    .qty-btn:active{transform:scale(.95); background:#f5f5f5}
    .cart-price{font-weight:900; min-width:60px; text-align:right}
    /* Essenszeit Badge */
    .cart-window-badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 12px; border-radius:12px;
      background:rgba(255,204,0,.1); color:#b8860b;
      font-size:13px; font-weight:700; margin:8px 0;
    }
    .cart-window-badge i{width:16px; height:16px}
    /* Quick-Time-Chips */
    .cart-time-chips{
      display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px;
    }
    .cart-time-chip{
      padding:8px 14px; border-radius:12px;
      border:1px solid #ddd; background:#fff;
      font-size:13px; font-weight:600; color:#666;
      cursor:pointer; transition:all .15s;
    }
    .cart-time-chip:active{transform:scale(.96); background:#f5f5f5}
    .cart-time-chip.selected{
      background:var(--brand); color:#000; border-color:var(--brand);
    }
    /* Warenkorb leeren Button */
    .cart-clear-btn{
      display:inline-block; margin-top:12px;
      padding:8px 16px; border-radius:10px;
      background:#f5f5f5; color:#666;
      font-size:13px; font-weight:600;
      text-decoration:none; cursor:pointer;
      transition:all .15s;
    }
    .cart-clear-btn:hover{background:#eee}
    .cart-clear-btn:active{transform:scale(.98)}
    .order-item{border:1px solid var(--border); border-radius:14px; padding:10px; background:#fff; box-shadow:0 6px 14px rgba(0,0,0,.06)}
    .order-item.done{opacity:.65}
    .order-item + .order-item{margin-top:10px}
    .order-top{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .order-right{display:flex; flex-direction:column; align-items:flex-end; gap:6px}
    .order-code{
      border:1px solid var(--border); 
      background:#fff; 
      border-radius:10px; 
      padding:6px 10px; 
      font-weight:900; 
      cursor:pointer;
      transition:transform 0.1s ease;
    }
    .order-code:active{
      transform:scale(0.95);
    }
    .status-pill{display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; font-size:11px; font-weight:900; border:1px solid var(--border)}
    .status-pill.open{background:rgba(242,183,5,.12); color:#b37b00}
    .status-pill.done{background:rgba(31,157,85,.12); color:#1f9d55}
    .code-full{font-size:42px; font-weight:950; text-align:center; margin:10px 0}

    /* Pickup Card (Theken-Ansicht 2.0) */
    .pickup-card{
      background:#fff;
      border-radius:16px;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
      position:relative;
      overflow:hidden;
      transition:all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
      cursor:pointer;
      border-left:6px solid #e5e7eb; /* Default */
      display:flex;
      flex-direction:column;
      min-height:160px;
    }
    .pickup-card:active{ transform:scale(0.96); }
    .pickup-card.status-open{ border-left-color:#FFD700; }
    .pickup-card.status-paid{ border-left-color:#2ecc71; } /* Bezahlt & Bereit */
    .pickup-card.status-done{ opacity:0.6; filter:grayscale(100%); border-left-color:#999; box-shadow:none; background:#f9f9f9; }
    
    .pickup-card-header{
      padding:16px 16px 0;
      display:flex; justify-content:space-between; align-items:flex-start;
    }
    .pickup-card-code{
      font-size:42px; font-weight:900; line-height:1; color:#1a1a1a; letter-spacing:-0.03em;
    }
    .pickup-card-time{
      font-size:13px; font-weight:700; color:#666; background:#f0f2f5; padding:4px 8px; border-radius:8px;
    }
    .pickup-card-body{
      padding:12px 16px 16px;
      flex:1; display:flex; flex-direction:column; justify-content:flex-end;
    }
    .pickup-card-dish{
      font-size:16px; font-weight:700; line-height:1.3; color:#333; margin-bottom:4px;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
    }
    .pickup-card-customer{
      font-size:13px; color:#888; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .pickup-card-badge{
      position:absolute; top:12px; right:12px;
      background:#2ecc71; color:#fff; font-size:11px; font-weight:800; padding:4px 8px; border-radius:6px;
      box-shadow:0 2px 6px rgba(46,204,113,0.3);
    }
    
    /* Animation für Erledigt */
    @keyframes check-pop {
      0% { transform:scale(0); opacity:0; }
      50% { transform:scale(1.2); opacity:1; }
      100% { transform:scale(1); opacity:1; }
    }
    .check-overlay{
      position:absolute; inset:0; background:rgba(46,204,113,0.9);
      display:flex; align-items:center; justify-content:center;
      opacity:0; pointer-events:none; transition:opacity 0.2s;
    }
    .pickup-card.just-done .check-overlay{ opacity:1; }
    .pickup-card.just-done .check-icon{ animation:check-pop 0.3s ease-out forwards; }
    .quick-ticket{
      position:fixed; inset:0; z-index:31;
      background:linear-gradient(135deg, var(--brand) 0%, #FFD700 100%);
      display:flex; align-items:center; justify-content:center;
      transform:translateY(100%); transition:transform .3s cubic-bezier(.4,0,.2,1);
      padding:20px;
    }
    .quick-ticket.active{transform:translateY(0)}
    .quick-ticket-close{
      position:absolute; top:20px; right:20px;
      width:44px; height:44px; border-radius:50%;
      background:rgba(255,255,255,.2); backdrop-filter:blur(10px);
      border:2px solid rgba(255,255,255,.3);
      color:#fff; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      transition:background .2s;
    }
    .quick-ticket-close:hover{background:rgba(255,255,255,.3)}
    .quick-ticket-close i{width:24px; height:24px}
    .quick-ticket-content{
      width:100%; max-width:400px; text-align:center;
      color:#111;
    }
    .quick-ticket-header{
      margin-bottom:40px;
    }
    .quick-ticket-logo{
      width:80px; height:80px; border-radius:20px;
      background:#fff; border:4px solid rgba(255,255,255,.5);
      margin:0 auto 16px; overflow:hidden;
      box-shadow:0 8px 24px rgba(0,0,0,.2);
    }
    .quick-ticket-logo img{
      width:100%; height:100%; object-fit:cover;
    }
    .quick-ticket-provider{
      font-size:26px; font-weight:900; margin-bottom:10px; line-height:1.3;
    }
    .quick-ticket-time{
      font-size:15px; opacity:.8; font-weight:600; line-height:1.4;
    }
    .quick-ticket-code{
      background:#fff; border-radius:var(--radius);
      padding:32px 24px; margin-bottom:24px;
      box-shadow:0 12px 32px rgba(0,0,0,.2);
    }
    .quick-ticket-code-label{
      font-size:12px; font-weight:700; text-transform:uppercase;
      letter-spacing:.1em; color:var(--muted); margin-bottom:12px;
    }
    .quick-ticket-code-value{
      font-size:72px; font-weight:950; line-height:1;
      color:#111; font-family:'Inter', monospace;
      letter-spacing:.05em;
    }
    .quick-ticket-details{
      background:rgba(255,255,255,.3); backdrop-filter:blur(10px);
      border-radius:var(--radius); padding:20px;
      margin-bottom:20px;
    }
    .quick-ticket-detail-item{
      margin-bottom:16px;
    }
    .quick-ticket-detail-item:last-child{margin-bottom:0}
    .quick-ticket-detail-label{
      font-size:13px; font-weight:700; opacity:.7; margin-bottom:6px; line-height:1.4;
    }
    .quick-ticket-detail-value{
      font-size:17px; font-weight:900; line-height:1.4;
    }
    .quick-ticket-status{
      font-size:14px; font-weight:700; opacity:.8; line-height:1.4;
      margin-bottom:24px;
    }
    .quick-ticket-actions .btn{
      background:#fff; color:#111; box-shadow:0 8px 24px rgba(0,0,0,.2);
    }

    .print-view{display:none}
    @media print{
      body{background:#fff; color:#000}
      body > *:not(#printView){display:none !important}
      #printView{display:block}
      #printView .print-card{
        border:1px solid #ddd; border-radius:12px; padding:16px; margin-bottom:12px;
      }
      #printView h1{margin:0 0 8px; font-size:20px}
      #printView h2{margin:12px 0 6px; font-size:16px}
      #printView .print-row{display:flex; justify-content:space-between; gap:12px; margin-top:6px}
      #printView .print-muted{color:#555; font-size:12px}
      #printView .print-badge{display:inline-block; padding:4px 8px; border:1px solid #999; border-radius:999px; font-size:11px; font-weight:700}
      #printView .print-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
      #printView .pickup-code-display{width:120px; height:120px; border:2px solid var(--brand); border-radius:12px; background:#fff; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; color:#2D3436}
    }
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .bigbtn{
      border:none; cursor:pointer;
      border-radius:18px; padding:14px;
      background:linear-gradient(135deg,rgba(242,183,5,.18),rgba(31,157,85,.12));
      border:1px solid var(--border);
      text-align:left;
      font-weight:950;
    }
    .bigbtn span{display:block; font-weight:700; font-size:12px; color:var(--muted); margin-top:6px}

    /* Provider app header */
    .prov-pill{
      display:inline-flex; align-items:center; gap:8px;
      background:#fff; border:1px solid var(--border);
      padding:9px 12px; border-radius:999px;
      font-weight:950; font-size:13px;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .prov-pill::after {
      content: '';
      display: none;
    }
    .provider-header{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .provider-logo.compact{padding:0}
    .header-actions{display:flex; gap:8px; flex-wrap:wrap}
    .header-actions .btn{width:auto; margin-top:0}

    .snackbar{
      position:fixed; left:50%; bottom:90px; transform:translateX(-50%);
      background:#111; color:#fff; border-radius:999px; padding:10px 14px;
      display:flex; align-items:center; gap:10px; box-shadow:0 10px 24px rgba(0,0,0,.22);
      opacity:0; pointer-events:none; transition:opacity .2s ease;
      z-index:40; font-size:13px; font-weight:900;
    }
    .snackbar.active{opacity:1; pointer-events:auto}
    .snackbar button{
      border:none; background:#fff; color:#111; border-radius:999px; padding:6px 10px;
      font-size:12px; font-weight:900; cursor:pointer;
    }

    /* Wizard */
    .wizard{
      background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow);
      padding:12px;
    }
    .w-top{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .w-title{font-weight:950}
    .w-step{font-size:12px; color:var(--muted)}
    .w-q{margin:12px 0 10px; font-size:18px; font-weight:950; line-height:1.2}
    .w-help{margin:0 0 10px; color:var(--muted); font-size:13px}
    .answers{display:flex; flex-wrap:wrap; gap:8px}
    .ans{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-weight:950;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .ans.on{border-color:rgba(31,157,85,.4); background:rgba(31,157,85,.10)}
    .field{width:100%; padding:14px 16px; border-radius:14px; border:1px solid var(--border); font-size:16px; background:#fbfaf7; line-height:1.5}
    .w-actions{display:flex; gap:10px; margin-top:12px}
    .w-actions button{flex:1}

    /* Inseratflow: Über Provider-Bottom-Nav (z-index 999) legen */
    /* Wizard/InseratCard: Backdrop unter Sheet, damit Klicks die Karte treffen (nicht Backdrop) */
    #wbd.active { z-index: 999 !important; background: radial-gradient(ellipse at center, rgba(254,243,199,0.35) 0%, rgba(251,191,36,0.08) 35%, rgba(0,0,0,0.65) 100%); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
    #createFlowBd.active { z-index: 1000 !important; }
    #wizard.sheet--kitchen.active { z-index: 1001 !important; }
    #createFlowSheet.sheet--kitchen.active { z-index: 1000 !important; }
    /* Inseratflow: High-End Glassmorphism (Master) – backdrop-blur-2xl, bg-white/70, border-white/40, shadow-2xl */
    #createFlowSheet.sheet--kitchen,
    #wizard.sheet--kitchen{
      background:rgba(255,255,255,0.7) !important;
      backdrop-filter:blur(24px); -webkit-backdrop-filter:blur(24px);
      border-radius:28px 28px 0 0;
      border:1px solid rgba(255,255,255,0.4);
      border-bottom:none;
      box-shadow:0 -12px 40px rgba(0,0,0,0.12), 0 4px 24px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.9);
      max-height:90vh !important;
      height: 90vh !important;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      margin-left:12px; margin-right:12px;
      max-width:calc(100% - 24px);
    }
    #createFlowSheet.sheet--kitchen .handle,
    #wizard.sheet--kitchen .handle{ background:rgba(0,0,0,0.15); width:40px; margin:8px auto 4px; }
    #createFlowSheet.sheet--kitchen .sheet-body{
      padding:20px 20px 28px;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
    }
    #createFlowSheet.sheet--kitchen .create-flow-title{
      font-weight:800; font-size:20px; color:#1a1a1a; margin-bottom:8px; line-height:1.3;
    }
    #createFlowSheet.sheet--kitchen .create-flow-hint{
      font-size:13px; font-weight:600; color:#475569; margin-top:10px; margin-left:auto; margin-right:auto; padding:10px 16px; background:#f1f5f9; border-radius:12px; display:inline-flex; align-items:center; justify-content:center; gap:8px; letter-spacing:0.02em;
    }
    #createFlowSheet.sheet--kitchen .create-flow-btns{
      display:flex; flex-direction:column; gap:12px; margin-top:20px;
    }
    /* Express-Start: Emerald (#10b981) – Neues Gericht erstellen */
    #createFlowSheet.sheet--kitchen .btn-create-primary{
      width:100%; min-height:56px; border-radius:16px; font-weight:800; font-size:17px; border:none;
      background:var(--prov-brand); color:#1a1a1a; cursor:pointer; display:flex; align-items:center; justify-content:center;
      padding:0 20px; gap:12px; transition:transform .15s, box-shadow .15s;
      box-shadow:0 4px 16px rgba(255,222,0,0.35);
    }
    #createFlowSheet.sheet--kitchen .btn-create-primary .plus-char{ font-size:22px; font-weight:900; }
    #createFlowSheet.sheet--kitchen .btn-create-primary:active{ transform:scale(0.98); }
    /* Bottom Sheet: Spring-Animation beim Aufgleiten */
    #createFlowSheet.sheet--kitchen{ transition: bottom .35s cubic-bezier(0.34, 1.56, 0.64, 1); }
    /* Skeleton für Kochbuch-Karten (Shimmer beim Laden) */
    .create-flow-skeleton-card{
      background:#fff; border-radius:16px; border:1px solid #f1f3f5; overflow:hidden;
      display:flex; flex-direction:column; min-height:140px;
    }
    .create-flow-skeleton-card .skeleton-img{
      height:80px; width:100%; background:linear-gradient(95deg, #e2e8f0 0%, #f1f5f9 50%, #e2e8f0 100%);
      background-size:200% 100%; animation: wizardShimmer 1.2s ease-in-out infinite;
    }
    .create-flow-skeleton-card .skeleton-text{ padding:10px; }
    .create-flow-skeleton-card .skeleton-line{ height:12px; border-radius:6px; background:#e2e8f0; margin-bottom:8px; }
    .create-flow-skeleton-card .skeleton-line:last-child{ width:60%; margin-bottom:0; }
    .create-flow-cookbook-card-enter{ animation: createFlowCardFade 0.3s ease-out forwards; }
    @keyframes createFlowCardFade{ from{ opacity:0; transform:translateY(4px); } to{ opacity:1; transform:translateY(0); } }
    .create-flow-renner-scroll .renner-card{ flex:0 0 auto; width:160px; scroll-snap-align:start; background:#fff; border-radius:16px; border:1px solid #f1f3f5; overflow:hidden; box-shadow:0 2px 12px rgba(0,0,0,0.06); display:flex; flex-direction:column; cursor:pointer; transition:transform 0.15s, box-shadow 0.15s; }
    .create-flow-renner-scroll .renner-card:active{ transform:scale(0.98); }
    .create-flow-renner-scroll .renner-card-img{ height:100px; width:100%; background:#f1f3f5; object-fit:cover; }
    .create-flow-renner-scroll .renner-card-icons{ display:flex; align-items:center; gap:6px; padding:8px 10px; background:#f8fafc; border-bottom:1px solid #f1f3f5; font-size:14px; }
    .create-flow-renner-scroll .renner-card-body{ padding:10px; flex:1; display:flex; flex-direction:column; gap:6px; }
    .create-flow-renner-scroll .renner-card-name{ font-size:14px; font-weight:900; color:#1a1a1a; line-height:1.2; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .create-flow-renner-scroll .renner-card-fact{ font-size:11px; font-weight:600; color:#64748b; line-height:1.3; }
    .create-flow-renner-scroll .renner-card-btn{ width:100%; min-height:40px; border-radius:12px; border:none; background:var(--prov-brand); color:#1a1a1a; font-size:13px; font-weight:800; cursor:pointer; margin-top:4px; }
    #createFlowSheet.sheet--kitchen .btn-create-secondary{
      width:100%; min-height:52px; border-radius:14px; font-weight:700; font-size:15px;
      border:1px solid rgba(0,0,0,0.1); background:#fff; color:#1a1a1a;
      cursor:pointer; display:flex; align-items:center; justify-content:flex-start; padding:0 20px; gap:12px;
      transition:background .15s, border-color .15s; box-shadow:0 2px 8px rgba(0,0,0,.06);
    }
    #createFlowSheet.sheet--kitchen .btn-create-secondary:active{ background:#f8f9fa; }
    /* Wizard: app-like – Inserat-Flow weiter oben, weniger Abstand oben */
    #wizard.sheet--kitchen .sheet-body.wizard-sheet-body{
      padding:8px 20px 0;
      overflow:hidden;
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      padding-bottom: env(safe-area-inset-bottom, 20px);
    }
    @keyframes wizardContentEnter{ from{ opacity:0; transform:translateY(6px); } to{ opacity:1; transform:translateY(0); } }
    #wizard.sheet--kitchen #wContent > *{
      animation:wizardContentEnter 0.32s cubic-bezier(0.34, 1.2, 0.64, 1) forwards;
      transition: transform 0.25s cubic-bezier(0.34, 1.2, 0.64, 1);
    }
    #wizard.sheet--kitchen .wizard{
      background:rgba(255,255,255,0.7);
      backdrop-filter:blur(24px); -webkit-backdrop-filter:blur(24px);
      border:1px solid rgba(255,255,255,0.4);
      border-radius:24px;
      padding:16px 20px 20px;
      box-shadow:0 12px 40px rgba(0,0,0,0.08), 0 4px 16px rgba(0,0,0,0.04), inset 0 1px 0 rgba(255,255,255,0.95);
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      position: relative;
    }
    #wizard.sheet--kitchen .wizard-progress-dots{
      display:flex;
      justify-content:center;
      gap:6px;
      margin-bottom:8px;
      flex-shrink:0;
    }
    #wizard.sheet--kitchen .wizard-dot{
      width:6px;
      height:6px;
      border-radius:50%;
      background:rgba(0,0,0,0.12);
      transition:background .25s ease, transform .25s ease, width .25s ease;
    }
    #wizard.sheet--kitchen .wizard-dot.active{
      background:var(--prov-brand);
      transform:scale(1.15);
      width:16px;
      border-radius:3px;
    }
    #wizard.sheet--kitchen .wizard-scroll{
      flex:1;
      min-height:0;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      scroll-behavior:smooth;
      margin:0 -20px;
      padding:0 20px 24px; /* Fußzeile entfernt – Platz nur für Safe Area */
    }
    #wizard.sheet--kitchen .w-actions{
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      flex-shrink:0;
      padding:16px 20px calc(16px + env(safe-area-inset-bottom, 20px));
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-top: 1px solid rgba(0, 0, 0, 0.06);
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.03);
      border-radius: 0 0 20px 20px;
      z-index: 10;
      display: flex; gap: 12px;
    }
    #wizard.sheet--kitchen .w-actions button{
      flex:1;
      height:54px; 
      border-radius:16px; 
      font-weight:800; 
      font-size:16px; 
      letter-spacing:0.01em;
      border:none;
      cursor:pointer;
      transition: transform 0.1s, background-color 0.2s;
    }
    #wizard.sheet--kitchen .w-actions button.secondary{ 
      background:rgba(0,0,0,0.05); 
      color:#64748b; 
      font-weight: 700;
    }
    #wizard.sheet--kitchen .w-actions button:not(.secondary){ 
      background:var(--prov-brand); 
      color:#1a1a1a; 
      box-shadow:0 4px 16px rgba(255,222,0,0.4);
      font-weight: 900;
      text-transform: uppercase;
      font-size: 15px;
      letter-spacing: 0.05em;
    }
    #wizard.sheet--kitchen .w-actions button:active{
      transform: scale(0.97);
    }
    /* Liquid Panel / High-End Glassmorphism (Inseratsflow) – Optik wie Referenz */
    #wizard.sheet--kitchen .glass-express-step0,
    #wizard.sheet--kitchen .inserat-universal-mask,
    #wizard.sheet--kitchen .listing-glass-panel,
    #wizard.sheet--kitchen .s25-floating-panel{
      --glass-bg: rgba(255,255,255,0.95);
      --glass-border: rgba(255,255,255,0.6);
      --emerald: #10b981;
      --signal-yellow: #FACC15;
      --radius-panel: 2.4rem;
      border-radius: var(--radius-panel);
      background: var(--glass-bg);
      backdrop-filter: blur(40px) saturate(140%);
      -webkit-backdrop-filter: blur(40px) saturate(140%);
      border: 1px solid var(--glass-border);
      box-shadow: 0 24px 48px rgba(0,0,0,0.12), 0 8px 24px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.8);
      overflow: hidden;
      max-width: 420px;
      max-height: 92vh;
      display: flex;
      flex-direction: column;
      z-index: 100;
    }
    /* Foto randlos oben im Rahmen (S25 Ultra-Liquid) */
    #wizard.sheet--kitchen .glass-express-step0.s25-floating-panel,
    #wizard.sheet--kitchen .listing-glass-panel.s25-floating-panel{
      border-top-left-radius: 0; border-top-right-radius: 0;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-photo-tile,
    #wizard.sheet--kitchen .glass-express-step0 .photo-header{
      height: 240px; min-height: 200px; background: #e8ecf0; border-radius: 0; flex-shrink: 0;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-photo-tile .inserat-photo-remove,
    #wizard.sheet--kitchen .glass-express-step0 .inserat-photo-tile .inserat-photo-change{
      position: absolute; bottom: 14px; right: 14px; padding: 12px 18px; min-height: 48px; border-radius: 999px;
      background: rgba(0,0,0,0.55); border: none; color: #fff; font-size: 12px; font-weight: 800;
      text-transform: uppercase; letter-spacing: 0.03em; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.25); transition: transform 0.12s ease, box-shadow 0.2s ease; -webkit-tap-highlight-color: transparent;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-photo-tile .inserat-photo-change:hover{ color: #fff; }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-photo-tile .inserat-photo-change:active{ transform: scale(0.98); }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-photo-tile .inserat-photo-placeholder{
      position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px;
      background: linear-gradient(160deg, rgba(248,247,242,0.98) 0%, rgba(241,245,249,0.95) 100%);
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-photo-tile .inserat-photo-placeholder .inserat-photo-placeholder-icon{
      font-size: 48px; opacity: 0.5;
    }
    #wizard.sheet--kitchen .glass-express-step0{
      padding-bottom: 0;
      --gex-gap: 12px;
      --gex-block: 20px;
    }
    /* Magnet-Input: pulsierende Emerald-Linie – „Tipp mich an!“ */
    @keyframes magnet-pulse{
      0%, 100%{ border-bottom-color: rgba(16,185,129,0.5); }
      50%{ border-bottom-color: var(--emerald); }
    }
    @keyframes magnet-pulse-idle{
      0%, 100%{ border-bottom-color: rgba(16,185,129,0.15); }
      50%{ border-bottom-color: rgba(16,185,129,0.4); }
    }
    #wizard.sheet--kitchen .glass-express-step0 #step-name input,
    #wizard.sheet--kitchen .glass-express-step0 .liquid-input,
    #wizard.sheet--kitchen .glass-express-step0 .liquid-input-focus{
      width: 100%; min-height: 48px; background: transparent; border: none; border-bottom: 2px solid rgba(0,0,0,0.05);
      padding: 12px 0 10px 0; outline: none; font-weight: 800; color: #1a1a1a;
      transition: border-color 0.3s ease, box-shadow 0.3s ease; box-sizing: border-box;
    }
    #wizard.sheet--kitchen .glass-express-step0 #step-name input:focus,
    #wizard.sheet--kitchen .glass-express-step0 .liquid-input-focus:focus{
      animation: magnet-pulse 1.2s ease-in-out infinite;
    }
    #wizard.sheet--kitchen .glass-express-step0 #step-name input.magnet-input,
    #wizard.sheet--kitchen .glass-master-panel #step-name input.magnet-input{
      border-bottom: 2px solid rgba(0,0,0,0.05);
      animation: magnet-pulse-idle 2.5s ease-in-out infinite;
    }
    #wizard.sheet--kitchen .glass-express-step0 #step-name input.magnet-input:focus,
    #wizard.sheet--kitchen .glass-master-panel #step-name input.magnet-input:focus{
      animation: magnet-pulse 1.2s ease-in-out infinite;
    }
    /* High-End Airbnb-Style: Gericht + Beschreibung – WOW-Eingaben */
    #wizard.sheet--kitchen .glass-express-step0 #step-name.inserat-name-airbnb,
    #wizard.sheet--kitchen .liquid-master-panel #step-name.inserat-name-airbnb{
      padding: 0; margin-bottom: 4px; border: none; background: transparent;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-airbnb-field-wrap,
    #wizard.sheet--kitchen .liquid-master-panel .inserat-airbnb-field-wrap{
      margin-bottom: 20px;
    }
    #wizard.sheet--kitchen .glass-express-step0 #step-name .inserat-airbnb-dish,
    #wizard.sheet--kitchen .liquid-master-panel #step-name .inserat-airbnb-dish{
      width: 100%; min-height: 56px; padding: 18px 20px 14px;
      font-size: 1.75rem; font-weight: 700; letter-spacing: -0.02em; color: #1a1a1a;
      background: #fff; border: none; border-bottom: 2px solid rgba(0,0,0,0.06);
      border-radius: 0; outline: none; transition: border-color 0.2s ease, box-shadow 0.2s ease;
      box-sizing: border-box;
    }
    #wizard.sheet--kitchen .glass-express-step0 #step-name .inserat-airbnb-dish::placeholder,
    #wizard.sheet--kitchen .liquid-master-panel #step-name .inserat-airbnb-dish::placeholder{
      color: #94a3b8; font-weight: 600;
    }
    #wizard.sheet--kitchen .glass-express-step0 #step-name .inserat-airbnb-dish:focus,
    #wizard.sheet--kitchen .liquid-master-panel #step-name .inserat-airbnb-dish:focus{
      border-bottom-color: #1a1a1a; box-shadow: 0 2px 0 0 #1a1a1a;
    }
    /* Beschreibung: kleiner, dezent, hebt sich nicht ab */
    #wizard.sheet--kitchen .glass-express-step0 #step-name .inserat-airbnb-desc-wrap,
    #wizard.sheet--kitchen .liquid-master-panel #step-name .inserat-airbnb-desc-wrap{
      margin-bottom: 4px; margin-top: -4px;
    }
    #wizard.sheet--kitchen .glass-express-step0 #step-name .inserat-airbnb-desc,
    #wizard.sheet--kitchen .liquid-master-panel #step-name .inserat-airbnb-desc,
    #wizard.sheet--kitchen .glass-express-step0 #step-name input.inserat-desc-input,
    #wizard.sheet--kitchen .liquid-master-panel #step-name input.inserat-desc-input{
      width: 100%; min-height: 36px; padding: 8px 20px 6px;
      font-size: 0.8rem; font-weight: 400; font-style: normal; color: #94a3b8;
      background: transparent; border: none; border-bottom: 1px solid rgba(0,0,0,0.05);
      border-radius: 0; outline: none; transition: border-color 0.2s ease;
      box-sizing: border-box;
    }
    #wizard.sheet--kitchen .glass-express-step0 #step-name .inserat-airbnb-desc::placeholder,
    #wizard.sheet--kitchen .liquid-master-panel #step-name .inserat-airbnb-desc::placeholder,
    #wizard.sheet--kitchen .glass-express-step0 #step-name .inserat-desc-input::placeholder,
    #wizard.sheet--kitchen .liquid-master-panel #step-name .inserat-desc-input::placeholder{
      color: #cbd5e1;
    }
    #wizard.sheet--kitchen .glass-express-step0 #step-name .inserat-airbnb-desc:focus,
    #wizard.sheet--kitchen .liquid-master-panel #step-name .inserat-airbnb-desc:focus{
      border-bottom-color: rgba(0,0,0,0.12); color: #64748b;
    }
    #wizard.sheet--kitchen .glass-express-step0 #step-name input:first-of-type{
      font-size: 1.75rem; text-align: left;
    }
    #wizard.sheet--kitchen .glass-express-step0 #step-name input:last-of-type,
    #wizard.sheet--kitchen .glass-express-step0 #step-name .inserat-desc-input,
    #wizard.sheet--kitchen .liquid-master-panel #step-name .inserat-desc-input{
      font-size: 0.8rem; color: #94a3b8; text-align: left; margin-top: 0;
      font-weight: 400; font-style: normal; background: transparent;
    }
    #wizard.sheet--kitchen .glass-express-step0 #step-name .inserat-desc-input::placeholder,
    #wizard.sheet--kitchen .liquid-master-panel #step-name .inserat-desc-input::placeholder{
      color: #cbd5e1;
    }
    /* price-display: elegant, System-Sans / Inter, Bold [cite: Native-Feel] */
    #wizard.sheet--kitchen .glass-express-step0 #step-price .inserat-price-input,
    #wizard.sheet--kitchen .glass-express-step0 .price-display{
      font-size: 2.75rem; font-weight: 800; font-family: system-ui, -apple-system, "Inter", sans-serif;
      text-align: center; color: #111;
    }
    /* Pills: haptisch, voll rund (Kategorien + Extras) – app-like :active */
    #wizard.sheet--kitchen .glass-express-step0 #step-cat button,
    #wizard.sheet--kitchen .glass-express-step0 .extra-pill{
      padding: 10px 20px; border-radius: 999px; background: rgba(0,0,0,0.05); font-weight: 700;
      transition: transform 0.12s ease, background 0.2s ease; cursor: pointer; border: none;
      -webkit-tap-highlight-color: transparent;
    }
    #wizard.sheet--kitchen .glass-express-step0 #step-cat button:active,
    #wizard.sheet--kitchen .glass-express-step0 .extra-pill:active{ transform: scale(0.98); }
    #wizard.sheet--kitchen .glass-express-step0 #step-cat button[style*="#10b981"],
    #wizard.sheet--kitchen .glass-express-step0 .extra-pill.active{
      background: var(--emerald) !important; color: #fff !important; transform: scale(1.05);
    }
    #wizard.sheet--kitchen .glass-express-step0 #step-cat button.active:active,
    #wizard.sheet--kitchen .glass-express-step0 .extra-pill.active:active{ transform: scale(0.98); }
    #wizard.sheet--kitchen .glass-express-step0 #step-extras .extra-pill{
      padding: 8px 16px; border-radius: 999px; font-size: 0.75rem; font-weight: 700; background: rgba(0,0,0,0.05);
    }
    #wizard.sheet--kitchen .glass-express-step0 .glass-pill{
      -webkit-tap-highlight-color:transparent;
      backdrop-filter:blur(14px); -webkit-backdrop-filter:blur(14px);
      transition: border-color 0.2s, background 0.2s, transform 0.12s ease;
      box-shadow:0 2px 8px rgba(0,0,0,0.04);
    }
    #wizard.sheet--kitchen .glass-express-step0 .glass-pill:active{ transform:scale(0.97); }
    #wizard.sheet--kitchen .glass-express-step0 .glass-express-field{
      border:2px solid rgba(255,255,255,0.65); background:rgba(255,255,255,0.55);
      backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
      box-shadow:0 2px 8px rgba(0,0,0,0.03);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    #wizard.sheet--kitchen .glass-express-step0 .glass-express-field:focus{
      outline:none; border-color:var(--prov-brand); box-shadow:0 0 0 3px rgba(255,222,0,0.2);
    }
    #wizard.sheet--kitchen .glass-express-step0 .smart-confirm-bar{
      margin-top:4px;
      padding-top:16px;
      padding-bottom:16px;
      gap:10px;
    }
    #wizard.sheet--kitchen .glass-express-step0 .listing-umsatz-potenzial{
      margin-top:var(--gex-block);
      margin-bottom:4px;
    }
    #wizard.sheet--kitchen .glass-express-step0 .btn-glass-secondary{
      min-height:50px;
      backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);
    }
    #wizard.sheet--kitchen .w-actions button.listing-express-primary{
      background:var(--prov-brand) !important; color:#1a1a1a !important; font-weight:800 !important;
      box-shadow:0 4px 16px rgba(255,222,0,0.4);
      min-height:54px;
      border-radius:16px;
    }
    #wizard.sheet--kitchen .w-actions button.btn-glass-secondary{ background:rgba(255,255,255,0.4); }
    /* Inserat Step 0: daumenfreundlich, alle Ziele mind. 48px */
    #wizard.sheet--kitchen #wContent .field{
      min-height: 52px !important;
      padding: 0 18px !important;
      font-size: 18px !important;
      -webkit-tap-highlight-color: transparent;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    #wizard.sheet--kitchen #wContent .field:focus{
      outline: none;
      border-color: var(--prov-brand);
      box-shadow: 0 0 0 3px rgba(255,222,0,0.2);
    }
    #wizard.sheet--kitchen #wContent button[type="button"]{
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.12s ease, background 0.2s, border-color 0.2s;
    }
    #wizard.sheet--kitchen #wContent button[type="button"]:active{
      transform: scale(0.97);
    }
    #wizard.sheet--kitchen .wizard-footer{
      margin-top: 8px;
      text-align:center; 
      font-size:9px; 
      font-weight:700; 
      color:#9ca3af; 
      text-transform:uppercase; 
      letter-spacing:0.03em;
      flex-shrink: 0;
    }
    /* High-End Universal-Flow: Kategorie horizontal, Smart-Tiles, Pricing-Weiche */
    #wizard.sheet--kitchen .inserat-cat-scroll::-webkit-scrollbar{ height:6px; }
    #wizard.sheet--kitchen .inserat-cat-scroll::-webkit-scrollbar-thumb{ background:rgba(0,0,0,0.15); border-radius:3px; }
    #wizard.sheet--kitchen .inserat-cat-tile:active{ transform:scale(0.98); }
    #wizard.sheet--kitchen .inserat-smart-tiles button:active{ transform:scale(0.96); }
    /* High-End Spring (stiffness 300, damping 20, mass 0.8) – 3 Säulen sofort sichtbar als Glas-Hüllen */
    #wizard.sheet--kitchen .inserat-three-pillars button{
      transition: transform 0.32s cubic-bezier(0.34, 1.2, 0.64, 1), border-color 0.2s, background 0.2s;
    }
    #wizard.sheet--kitchen .inserat-three-pillars button:active{ transform:scale(0.95); }
    #wizard.sheet--kitchen .inserat-photo-tile .inserat-photo-remove:hover,
    #wizard.sheet--kitchen .inserat-photo-tile .inserat-photo-change:hover{ color:#fff; }
    /* 3 Säulen: 🍴 🧾 🔄 + Zeit als eine Karte (app-like) */
    #wizard.sheet--kitchen .glass-express-step0 #step-logistics,
    #wizard.sheet--kitchen .glass-express-step0 .logistics-bar.inserat-logistics-card{
      display: flex; flex-direction: column; align-items: stretch;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-logistics-card-inner,
    #wizard.sheet--kitchen .glass-express-step0 .power-bar{
      display: flex; align-items: center; justify-content: space-between; flex-wrap: nowrap; gap: 16px;
      background: rgba(255,255,255,0.4); border-radius: 20px; padding: 16px 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06); margin-top: 8px;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-extras-wrap,
    #wizard.sheet--kitchen .glass-express-step0 .inserat-allergen-wrap{
      display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-allergen-pill{
      padding: 8px 16px; border-radius: 999px; font-size: 0.8rem; font-weight: 700;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-allergen-dropdown,
    #wizard.sheet--kitchen .glass-express-step0 .inserat-extras-dropdown{
      background: rgba(255,255,255,0.4); border-radius: 16px; padding: 16px; border: 1px solid rgba(255,255,255,0.5);
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-photo-tile{
      width: 100%; overflow: hidden; cursor: pointer; position: relative;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-scroll-area{
      padding: 28px 24px; overflow-y: auto; flex: 1; min-height: 0; -webkit-overflow-scrolling: touch;
      display: flex; flex-direction: column; gap: 22px;
      background: #fff;
    }
    #wizard.sheet--kitchen .glass-express-step0.s25-floating-panel .inserat-scroll-area{
      padding: 26px 24px; gap: 20px;
    }
    #wizard.sheet--kitchen .glass-express-step0 #step-name{ margin-bottom: 0; }
    #wizard.sheet--kitchen .glass-express-step0 #step-cat{
      display: flex; gap: 8px; overflow-x: auto; padding: 0; margin: 0; -webkit-overflow-scrolling: touch;
    }
    #wizard.sheet--kitchen .glass-express-step0 #step-price{
      text-align: center; margin: 0; padding: 0; margin-bottom: 2px;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-price-row{
      display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-price-input{
      width: 50%; max-width: 180px; background: transparent; border: none; padding: 16px; outline: none;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-price-euro{ font-size: 2rem; font-weight: 900; color: #ccc; margin-left: 10px; }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-earnings{
      font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin: 0;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-umsatzprognose{
      color: #94a3b8; font-weight: 700; text-transform: none; letter-spacing: 0;
    }
    /* Transparenz-Tooltip Umsatzprognose (gläsern, Fade-In & Slide-Up) */
    #wizard.sheet--kitchen .glass-express-step0 .inserat-prognose-wrap{
      position: relative; margin-top: 10px; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 6px;
    }
    #wizard.sheet--kitchen .glass-express-step0 .info-trigger{
      color: #94a3b8; cursor: pointer; font-size: 1rem; line-height: 1; padding: 2px; -webkit-tap-highlight-color: transparent;
    }
    #wizard.sheet--kitchen .glass-express-step0 .glass-tooltip{
      display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(10px);
      width: 220px; max-width: calc(100vw - 48px); margin-bottom: 8px; padding: 12px;
      border-radius: 1rem; font-size: 0.7rem; color: #475569; line-height: 1.35;
      background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      pointer-events: none; z-index: 20;
    }
    #wizard.sheet--kitchen .glass-express-step0 .glass-tooltip.prognose-tooltip-visible{
      display: block; animation: tooltip-slide 0.3s ease-out forwards;
    }
    @keyframes tooltip-slide{
      from{ opacity: 0; transform: translateX(-50%) translateY(10px); }
      to{ opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-logistics-btn{
      font-size: 24px; background: none; border: none; cursor: pointer; padding: 8px; min-width: 44px; min-height: 44px;
      transition: transform 0.12s ease, filter 0.2s; -webkit-tap-highlight-color: transparent;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-logistics-btn:active{ transform: scale(0.95); }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-logistics-btn.active{ transform: scale(1.1); filter: grayscale(0); }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-logistics-btn.active:active{ transform: scale(0.95); }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-logistics-btn.inactive{ filter: grayscale(1); opacity: 0.35; transform: scale(0.9); }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-pickup-time-dropdown{
      width: 100%; display: flex; justify-content: center; padding: 12px 0 4px;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-pickup-time-row{ display: flex; align-items: center; justify-content: center; gap: 10px; }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-pickup-time-input{
      padding: 10px 14px; border-radius: 12px; border: 2px solid rgba(0,0,0,0.08); font-size: 16px; font-weight: 700;
      background: #fff; color: #1a1a1a;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-pickup-time-trigger{
      font-size: 24px; background: none; border: none; cursor: pointer; padding: 8px; min-width: 44px; min-height: 44px;
      display: flex; align-items: center; justify-content: center; transition: transform 0.12s ease; -webkit-tap-highlight-color: transparent;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-pickup-time-trigger:active{ transform: scale(0.98); }
    #wizard.sheet--kitchen .glass-express-step0 #step-allergens{ margin: 0; }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-allergen-trigger{
      width: 100%; text-align: left; font-size: 0.9rem; font-weight: 700; color: #334155;
      padding: 14px 16px; border: none; background: rgba(0,0,0,0.04); cursor: pointer; border-radius: 12px;
      min-height: 48px; display: flex; align-items: center; justify-content: space-between;
      transition: transform 0.12s ease; -webkit-tap-highlight-color: transparent;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-allergen-trigger:active{ transform: scale(0.98); }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-allergen-trigger:hover{ color: #64748b; }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-allergen-inner{
      display: flex; flex-direction: column; gap: 8px; padding: 16px 0;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-allergen-row,
    #wizard.sheet--kitchen .liquid-master-panel .inserat-allergen-row{
      display: flex; align-items: center; gap: 8px; width: 100%; min-height: 44px; padding: 10px 14px;
      border-radius: 12px; font-size: 0.95rem; font-weight: 600; cursor: pointer; border: 1px solid rgba(255,255,255,0.6);
      background: rgba(255,255,255,0.4); color: #64748b; text-align: left;
      transition: transform 0.12s ease, background 0.2s, color 0.2s; -webkit-tap-highlight-color: transparent;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-allergen-row .inserat-allergen-emo,
    #wizard.sheet--kitchen .liquid-master-panel .inserat-allergen-row .inserat-allergen-emo{ font-size: 1rem; display: inline; }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-allergen-row .inserat-allergen-code,
    #wizard.sheet--kitchen .liquid-master-panel .inserat-allergen-row .inserat-allergen-code{ font-weight: 800; display: inline; color: inherit; }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-allergen-row .inserat-allergen-name,
    #wizard.sheet--kitchen .liquid-master-panel .inserat-allergen-row .inserat-allergen-name{ display: inline; color: inherit; }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-allergen-row.active,
    #wizard.sheet--kitchen .liquid-master-panel .inserat-allergen-row.active{ background: #10b981; color: #fff; }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-allergen-row:active,
    #wizard.sheet--kitchen .liquid-master-panel .inserat-allergen-row:active{ transform: scale(0.98); }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-action-section{
      padding: 24px 24px calc(20px + env(safe-area-inset-bottom, 24px));
      background: rgba(255,255,255,0.98); border-top: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 -8px 32px rgba(0,0,0,0.06); flex-shrink: 0;
      display: flex; flex-direction: column; gap: 12px;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-btn-primary{
      width: 100%; min-height: 56px; padding: 18px 24px; border-radius: 24px; font-size: 16px; font-weight: 800; border: none; cursor: pointer;
      text-transform: uppercase; letter-spacing: 0.02em; line-height: 1.3;
      transition: transform 0.15s ease; -webkit-tap-highlight-color: transparent;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-btn-primary.inserat-btn-emerald{
      background: #10b981; color: #fff; box-shadow: 0 10px 30px rgba(16,185,129,0.35);
    }
    #wizard[data-flow="listing"] .inserat-btn-primary.is-loading { pointer-events: none; }
    #wizard[data-flow="listing"] .inserat-btn-spinner {
      display: inline-block; width: 22px; height: 22px; border: 3px solid rgba(255,255,255,0.35);
      border-top-color: #fff; border-radius: 50%; animation: inserat-spin 0.7s linear infinite;
    }
    @keyframes inserat-spin { to { transform: rotate(360deg); } }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-btn-primary .inserat-cta-main{
      text-transform: none;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-btn-primary .inserat-cta-sub{
      display: block; font-size: 0.75rem; font-weight: 700; text-transform: none; letter-spacing: 0; opacity: 0.95; margin-top: 4px;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-btn-primary,
    #wizard.sheet--kitchen .glass-express-step0 .inserat-btn-secondary { transition: transform 0.1s cubic-bezier(0.4,0,0.2,1), box-shadow 0.1s ease; }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-btn-primary:active{ transform: scale(0.96); box-shadow: none; filter: brightness(0.95); }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-btn-secondary{
      width: 100%; min-height: 56px; padding: 16px 24px; border-radius: 24px; font-size: 14px; font-weight: 800; cursor: pointer;
      transition: transform 0.15s ease; -webkit-tap-highlight-color: transparent;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-btn-secondary.inserat-btn-yellow-border{
      border: 2px solid #FACC15; background: rgba(250,204,21,0.08); color: #1a1a1a;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-btn-secondary .inserat-cta-main{ display: block; }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-btn-secondary .inserat-cta-sub{ display: block; font-size: 0.75rem; font-weight: 700; text-transform: none; letter-spacing: 0; opacity: 0.9; margin-top: 4px; }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-btn-secondary:active{ transform: scale(0.96); box-shadow: none; filter: brightness(0.95); }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-action-section.inserat-action-pricing button:first-of-type{
      background: #10b981 !important; color: #fff !important; border: none;
      padding: 18px 24px; min-height: 56px; border-radius: 24px; font-weight: 800; text-transform: uppercase; font-size: 1rem;
      box-shadow: 0 10px 30px rgba(16,185,129,0.35); transition: transform 0.15s ease;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-action-section.inserat-action-pricing button:first-of-type:active{ transform: scale(0.98); }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-action-section.inserat-action-pricing button:nth-of-type(2){
      background: rgba(250,204,21,0.08) !important; border: 2px solid #FACC15 !important; color: #1a1a1a !important;
      padding: 16px 24px; min-height: 56px; border-radius: 24px; font-weight: 800; font-size: 0.875rem;
      transition: transform 0.15s ease;
    }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-action-section.inserat-action-pricing button:nth-of-type(2):active{ transform: scale(0.98); }
    #wizard.sheet--kitchen .glass-express-step0 .inserat-master-flow > section button{
      border-radius: 2rem;
    }
    #wizard.sheet--kitchen .inserat-pickup-time-trigger:active{ opacity:0.9; }
    /* Tastatur-Check: Preis-Feld – fester Bereich, kein Layout-Sprung bei Zahlentastatur */
    #wizard.sheet--kitchen .inserat-price-wrap{ min-height:72px; contain:layout; }
    #wizard.sheet--kitchen .inserat-price-field{ scroll-margin-bottom:100px; }

    /* Onboarding Views: App-like Sticky Layout */
    .onboarding-view {
      background: var(--provider-bg) !important;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .onboarding-view .panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 24px 20px 100px !important; /* Space for sticky footer */
      max-width: 500px;
      margin: 0 auto;
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
    }
    .onboarding-actions {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 16px 20px calc(16px + env(safe-area-inset-bottom, 20px));
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-top: 1px solid rgba(0, 0, 0, 0.06);
      display: flex;
      gap: 12px;
      z-index: 100;
    }
    .onboarding-actions button {
      flex: 1;
      height: 56px;
      border-radius: 16px;
      font-weight: 800;
      font-size: 16px;
      border: none;
      cursor: pointer;
      transition: transform 0.1s;
    }
    .onboarding-actions button.btn-primary {
      background: var(--brand);
      color: #1a1a1a;
      box-shadow: 0 4px 14px rgba(255, 215, 0, 0.4);
    }
    .onboarding-actions button.secondary {
      background: rgba(0, 0, 0, 0.05);
      color: #64748b;
    }
    .onboarding-actions button:active {
      transform: scale(0.97);
    }
    
    /* Dashboard KPIs & Cards */
    .provider-kpi-card {
      background: #fff;
      padding: 20px;
      border-radius: 24px;
      border: 1px solid rgba(0,0,0,0.04);
      box-shadow: 0 4px 12px rgba(0,0,0,0.02);
      transition: transform 0.1s, box-shadow 0.2s;
    }
    .provider-kpi-card:active {
      transform: scale(0.98);
      box-shadow: 0 2px 8px rgba(0,0,0,0.01);
    }
    .provider-kpi-icon {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }
    
    /* FAB NUR Dashboard: rechts (explizit left:auto), Animation Buttons */
    .fab-provider {
      position: fixed;
      left: auto !important;
      bottom: calc(90px + env(safe-area-inset-bottom, 0px));
      right: 20px;
      height: 60px;
      padding: 0 24px;
      border-radius: 30px;
      background: #1a1a1a;
      color: #fff;
      border: none;
      box-shadow: 0 12px 32px rgba(0,0,0,0.25);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
      font-size: 16px;
      z-index: 1000;
      transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .fab-provider:active {
      transform: scale(0.92);
    }
    .fab-provider i {
      width: 24px;
      height: 24px;
      stroke-width: 3;
    }
    /* Plus-Button Anbieter: kühles Blau (--prov-brand), weißes Plus */
    .provider-add-plus-btn,
    #fabProviderAddOffer.fab-provider-plus {
      background: var(--prov-brand) !important;
      color: #fff !important;
      border: none !important;
      animation: fab-pulse-prov 2s ease-in-out infinite;
    }
    .provider-add-plus-btn .plus-char,
    #fabProviderAddOffer.fab-provider-plus .plus-char { color: #fff !important; font-weight:900; text-shadow: 0 1px 2px rgba(0,0,0,0.15); }
    /* FAB: nur runder Plus-Button, rechts (applike) */
    #fabProviderAddOffer.fab-provider-plus {
      width: 56px;
      height: 56px;
      min-width: 56px;
      padding: 0;
      border-radius: 50%;
      justify-content: center;
    }
    /* Stolz-Edition: FAB gelb mit weißem Rand, animiert (applike) */
    @keyframes fab-plus-float {
      0%, 100% { transform: scale(1); box-shadow: 0 4px 20px rgba(0,0,0,0.2), 0 8px 24px rgba(0,0,0,0.12); }
      50% { transform: scale(1.06); box-shadow: 0 6px 26px rgba(255,222,0,0.4), 0 10px 30px rgba(0,0,0,0.15); }
    }
    #fabProviderAddOffer.fab-provider-plus {
      background: #ffde00 !important;
      border: 4px solid #fff !important;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2), 0 8px 24px rgba(0,0,0,0.12) !important;
      animation: fab-plus-float 2.2s ease-in-out infinite;
    }
    #fabProviderAddOffer.fab-provider-plus .plus-char { color: #1a1a1a !important; text-shadow: none !important; }
    #fabProviderAddOffer.fab-provider-plus:active,
    .provider-add-plus-btn:active { animation: none; transform: scale(0.96); }
    /* REGEL: Gelbes Plus – einheitlich in der ganzen App für „Hinzufügen“ (Anbieter erkennt sofort: hier kann ich was hinzufügen) */
    .prov-add-plus-icon {
      width: 64px; height: 64px; min-width: 64px; min-height: 64px;
      background: #ffde00;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 32px; font-weight: 300; line-height: 1;
      color: #1a1a1a;
      box-shadow: 0 4px 16px rgba(255,222,0,0.45);
    }
    .prov-add-plus-trigger { display: inline-flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; padding: 8px; }
    .prov-add-plus-trigger:active { transform: scale(0.98); }
    @keyframes fab-pulse-prov {
      0%, 100% { box-shadow: 0 4px 20px rgba(14,165,233,0.45), 0 8px 24px rgba(0,0,0,0.15); }
      50% { box-shadow: 0 4px 28px rgba(14,165,233,0.6), 0 8px 32px rgba(0,0,0,0.2); }
    }
    .provider-add-plus-btn {
      display: inline-flex !important;
      align-items: center;
      justify-content: center;
      gap: 10px;
      min-height: 52px;
      padding: 0 20px;
      border-radius: 14px;
      font-weight: 800;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.15s;
    }

    @media (min-width: 501px) {
      .fab-provider {
        right: calc(20px + env(safe-area-inset-right, 0));
        left: auto;
      }
    }
    #wizard.sheet--kitchen .w-top{ margin-bottom:12px; }
    #wizard.sheet--kitchen .w-title{ font-weight:800; font-size:14px; color:#9ca3af; text-transform:uppercase; letter-spacing:0.05em; }
    #wizard.sheet--kitchen .w-step{ font-size:12px; color:#64748b; font-weight:600; margin-top:2px; }
    #wizard.sheet--kitchen .w-q{
      font-size:22px; font-weight:900; color:#1a1a1a; line-height:1.2; margin:0 0 8px; letter-spacing:-0.02em;
    }
    #wizard.sheet--kitchen .w-help{ font-size:15px; color:#64748b; margin:0 0 24px; line-height:1.5; }
    #wizard.sheet--kitchen #wContent{
      flex:1;
      min-height:0;
      margin-bottom:0;
      scroll-margin-top:16px;
    }
    #wizard.sheet--kitchen .panel{ scroll-behavior:smooth; }
    #wizard.sheet--kitchen #wContent .answers{
      display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;
    }
    #wizard.sheet--kitchen #wContent .field{
      margin-top:0; margin-bottom:8px;
    }
    #wizard.sheet--kitchen #wContent input[type="checkbox"]{
      accent-color:var(--brand);
    }
    #wizard.sheet--kitchen .hint{ color:#64748b; font-size:13px; }
    #wizard.sheet--kitchen .panel{
      background:#f8f9fa; border:1px solid rgba(0,0,0,0.08); color:#1a1a1a;
      border-radius:12px; padding:14px; margin-top:12px;
    }
    #wizard.sheet--kitchen .panel .hint{ color:#64748b; }
    #wizard.sheet--kitchen .ans{
      background:#fff; border:1px solid rgba(0,0,0,0.12); color:#1a1a1a;
      padding:12px 16px; border-radius:14px; font-weight:700;
      min-height:44px;
      box-sizing:border-box;
      transition:background .15s, border-color .15s;
    }
    #wizard.sheet--kitchen #wContent .ans.ans--thumb{
      min-height:72px; min-width:72px;
    }
    #wizard.sheet--kitchen .ans:hover{ background:#f8f9fa; border-color:rgba(0,0,0,0.18); }
    #wizard.sheet--kitchen .ans.on{
      border-color:var(--brand); background:rgba(255,215,0,0.15); color:#1a1a1a;
    }
    #wizard.sheet--kitchen .field{
      background:#fff; border:1px solid rgba(0,0,0,0.12); color:#1a1a1a;
      border-radius:12px; padding:14px 16px; font-size:16px;
    }
    #wizard.sheet--kitchen .field::placeholder{ color:#94a3b8; }
    #wizard.sheet--kitchen .btn.ghost{
      background:#f8f9fa; border:1px solid rgba(0,0,0,0.1); color:#1a1a1a;
    }
    #wizard.sheet--kitchen .mini{ color:#64748b; font-size:12px; }
    /* Vorschau-Bereich (kein Livebild): kompakt, klar */
    #wizard.sheet--kitchen #listingPreview{
      margin-top:20px; padding-top:16px; border-top:1px solid rgba(0,0,0,0.08);
    }
    #wizard.sheet--kitchen #listingPreview .hint{
      font-size:12px; font-weight:600; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:10px;
    }
    #wizard.sheet--kitchen #listingPreview .listing-preview-badge{
      background:rgba(46,125,50,0.1); border:1px solid rgba(46,125,50,0.3); border-radius:12px; padding:12px;
    }
    #wizard.sheet--kitchen #listingPreview .listing-preview-badge div{ color:#2e7d32; font-weight:700; }
    #wizard.sheet--kitchen #listingPreview .listing-preview-subline{ color:#64748b; }
    #wizard.sheet--kitchen .listing-reuse-preview{
      background:rgba(31,157,85,0.08) !important; border:1px solid rgba(46,175,80,0.25) !important;
      border-radius:12px; padding:12px;
    }
    #wizard.sheet--kitchen .listing-reuse-preview span{ color:#1a1a1a; }
    #wizard.sheet--kitchen .listing-hint-box{
      background:#f8f9fa !important; border:1px solid rgba(0,0,0,0.08) !important;
      border-radius:12px; padding:12px;
    }
    #wizard.sheet--kitchen .listing-hint-box div{ color:#1a1a1a !important; }
    #wizard.sheet--kitchen .listing-cost-block{
      background:#f8f9fa !important; border:1px solid rgba(0,0,0,0.08); border-radius:12px; padding:14px;
    }
    #wizard.sheet--kitchen .listing-cost-block div{ color:#1a1a1a; }
    #wizard.sheet--kitchen .listing-cost-block .listing-cost-muted{ color:#64748b; }
    #wizard.sheet--kitchen .listing-cost-block.listing-cost-green{
      background:rgba(46,125,50,0.1) !important; border:1px solid rgba(46,125,50,0.3);
    }
    #wizard.sheet--kitchen .listing-cost-block.listing-cost-green div{ color:#2e7d32; }
    #wizard.sheet--kitchen .listing-datum-summary .listing-datum-day{ color:#1a1a1a; font-weight:800; }
    #wizard.sheet--kitchen .listing-datum-summary .hint{ color:#64748b; }

    /* Inseratflow: Sticky Bottom – Glas, Emerald-Button (JETZT INSERIEREN) */
    .listing-sticky-footer{
      position:sticky; bottom:0; left:0; right:0;
      margin:16px -20px 0; padding:14px 20px 20px;
      padding-bottom:calc(20px + env(safe-area-inset-bottom, 0));
      background:linear-gradient(to top, rgba(255,255,255,0.92) 60%, rgba(255,255,255,0.85));
      backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
      box-shadow:0 -4px 24px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.8);
      border-radius:24px 24px 0 0;
      border-top:1px solid rgba(255,255,255,0.5);
    }
    /* Potenzial heute: groß Emerald, 4,99 € daneben klein */
    .revenue-card-enter{
      animation: revenueCardBounce 0.45s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    @keyframes revenueCardBounce{
      0%{ opacity:0; transform:translateY(12px); }
      60%{ opacity:1; transform:translateY(-2px); }
      100%{ opacity:1; transform:translateY(0); }
    }
    /* Bild-Platzhalter: Shimmer/Skeleton während Laden */
    .wizard-img-skeleton::after{
      content:''; position:absolute; inset:0;
      background:linear-gradient(95deg, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%);
      background-size:200% 100%; animation:wizardShimmer 1.2s ease-in-out infinite;
    }
    @keyframes wizardShimmer{ 0%{ background-position:200% 0; } 100%{ background-position:-200% 0; } }

    /* ========== INSERATSFLOW (TOTALER RESET & SILICON VALLEY) ========== */
    /* Sheet: feste Höhe + Flex, damit innen nur .inserat-scroll-area scrollt */
    #wizard[data-flow="listing"].sheet--kitchen.active {
      max-height: 100dvh !important;
      height: 100vh !important;
      height: 100dvh !important;
      overflow: hidden !important;
      display: flex !important;
      flex-direction: column !important;
    }
    #wizard[data-flow="listing"].sheet--kitchen .sheet-body.wizard-sheet-body {
      flex: 1; min-height: 0; overflow: hidden;
      padding: 0 !important;
    }
    #wizard[data-flow="listing"].sheet--kitchen .wizard {
      padding: 0 !important;
    }
    /* Neutralisierung des alten Wizards [cite: 2026-02-14] */
    #wizard[data-flow="listing"].sheet--kitchen .wizard-scroll {
      overflow: hidden !important; 
      flex: 1; min-height: 0;
      display: flex !important; 
      flex-direction: column !important; 
      padding: 0 !important;
    }
    #wizard[data-flow="listing"] .w-actions { display: none !important; }
    
    /* Universal-X: Frosted-Glass Schließen-Button (einziger Ausstieg neben Backdrop) [cite: 2026-02-16 S25] */
    .close-wizard-x{
      position:absolute; top:15px; right:15px; width:40px; height:40px;
      background:rgba(0,0,0,0.3); backdrop-filter:blur(12px) saturate(180%); -webkit-backdrop-filter:blur(12px) saturate(180%);
      border-radius:50%; display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,255,255,0.2); cursor:pointer; z-index:100;
      transition:transform 0.1s cubic-bezier(0.4,0,0.2,1), box-shadow 0.1s ease;
    }
    .close-wizard-x:active{ transform:scale(0.96); box-shadow:none; filter:brightness(0.95); }
    .close-wizard-x::before,.close-wizard-x::after{
      content:''; position:absolute; width:16px; height:2px; background:#fff; border-radius:1px;
    }
    .close-wizard-x::before{ transform:rotate(45deg); }
    .close-wizard-x::after{ transform:rotate(-45deg); }
    
    /* High-End Liquid Panel [cite: 2026-01-29, 2026-02-02] – Listing: Screen füllend, randlos */
    .liquid-master-panel {
      flex: 1; display: flex; flex-direction: column; overflow: hidden;
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(45px) saturate(160%);
      -webkit-backdrop-filter: blur(45px) saturate(160%);
      border-radius: 3rem; margin: 10px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 20px 50px rgba(0,0,0,0.15);
    }
    #wizard[data-flow="listing"].sheet--kitchen .liquid-master-panel {
      margin: 0; border-radius: 0; border-left: none; border-right: none; border-bottom: none;
      min-height: 0; flex: 1;
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
    }
    #wizard[data-flow="listing"].sheet--kitchen .wizard-scroll #wContent{
      flex: 1; min-height: 0; height: 100%; display: flex; flex-direction: column;
    }
    #wizard[data-flow="listing"].sheet--kitchen .wizard-scroll #wContent > .liquid-master-panel{
      flex: 1; min-height: 0; overflow: hidden; display: flex; flex-direction: column;
    }
    
    /* Bereich-Steuerung: Nur Mitte scrollt [cite: 2026-02-14] */
    .liquid-master-panel .scroll-content,
    .liquid-master-panel .inserat-scroll-area {
      flex: 1; min-height: 0; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch;
    }
    #wizard[data-flow="listing"] .inserat-scroll-area { padding: 24px 20px; font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif; }
    /* App-like: ein Bildschirm, klare Sektionen [cite: Plan Inseratsflow] */
    .liquid-master-panel .inserat-scroll-area {
      --inserat-section-gap: 28px;
    }
    .liquid-master-panel .inserat-section {
      margin-bottom: var(--inserat-section-gap, 28px);
    }
    .liquid-master-panel .inserat-section-label {
      font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.1em;
      margin: 0 0 8px; display: block;
    }
    .liquid-master-panel .fixed-footer,
    .liquid-master-panel .inserat-action-section {
      flex-shrink: 0; padding: 20px;
      padding-bottom: calc(15px + env(safe-area-inset-bottom, 0px));
      background: rgba(255, 255, 255, 0.5);
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 -8px 32px rgba(0,0,0,0.06);
    }
    
    /* Magnet-Pulse Animation */
    @keyframes magnet-pulse {
      0%, 100% { border-bottom-color: rgba(16,185,129,0.5); }
      50% { border-bottom-color: var(--emerald); }
    }
    .liquid-master-panel #step-name input.magnet-input:focus {
      animation: magnet-pulse 1.2s ease-in-out infinite;
    }
    
    /* Guided Interaction: Pulsieren des Foto-Bereichs bei leerer Karte [cite: 2026-01-29] */
    @keyframes inserat-card-photo-pulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(16,185,129,0.25); }
      50% { opacity: 0.92; box-shadow: 0 0 0 8px rgba(16,185,129,0.08); }
    }
    #wizard[data-flow="listing"] .photo-header.inserat-card-photo-pulse,
    #wizard[data-flow="listing"] .inserat-photo-tile.inserat-card-photo-pulse {
      animation: inserat-card-photo-pulse 1.8s ease-in-out infinite;
    }
    /* InseratCard klickbar: explizit pointer-events, damit keine Überlagerung Klicks schluckt */
    #wizard[data-flow="listing"] #wContent > .liquid-master-panel,
    #wizard[data-flow="listing"] .liquid-master-panel.inserat-card { pointer-events: auto; }
    #wizard[data-flow="listing"] .liquid-master-panel .photo-header,
    #wizard[data-flow="listing"] .liquid-master-panel .inserat-power-bar,
    #wizard[data-flow="listing"] .liquid-master-panel .inserat-cat-price-row,
    #wizard[data-flow="listing"] .liquid-master-panel .inserat-action-section,
    #wizard[data-flow="listing"] .liquid-master-panel .inserat-scroll-area { pointer-events: auto; }
    /* Goldene Sammelkarte: Header-Bild Ratio 3:2, No-Scroll S25 [cite: 2026-02-14, 2026-02-16] */
    .liquid-master-panel .photo-header,
    .liquid-master-panel .inserat-photo-tile.photo-header {
      width: 100%; aspect-ratio: 3/2; max-height: min(260px, 38vh); flex-shrink: 0;
      height: auto; min-height: 0;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      transition: max-height 0.25s ease;
    }
    .liquid-master-panel .photo-header img,
    .liquid-master-panel .inserat-photo-tile.photo-header img {
      width: 100%; height: 100%; object-fit: cover; display: block;
    }
    /* Keyboard-Avoidance: Header schrumpft bei aktivem Input (Titel/Preis) [cite: 2026-02-16] */
    #wizard[data-flow="listing"] .liquid-master-panel.inserat-keyboard-active .photo-header,
    #wizard[data-flow="listing"] .liquid-master-panel.inserat-keyboard-active .inserat-photo-tile.photo-header {
      max-height: 120px !important; aspect-ratio: 3/2;
    }
    #wizard[data-flow="listing"].sheet--kitchen .liquid-master-panel .photo-header,
    #wizard[data-flow="listing"].sheet--kitchen .liquid-master-panel .inserat-photo-tile.photo-header {
      border-radius: 0 0 24px 24px; width: 100%;
    }
    .liquid-master-panel .photo-header.inserat-photo-tile .inserat-photo-placeholder,
    .liquid-master-panel .photo-header:not(:has(img[src])) {
      background: #f8fafc; display: flex; align-items: center; justify-content: center; gap: 15px; overflow: hidden;
    }
    /* Header-Morph: selection-overlay für Allergene/Extras im Header (Frosted Glass) */
    #wizard[data-flow="listing"] .photo-header .selection-overlay {
      position: absolute; inset: 0; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 8px; padding: 20px 45px 20px 20px; opacity: 0; pointer-events: none; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); overflow-y: auto; z-index: 15;
    }
    #wizard[data-flow="listing"] .photo-header.is-selecting .selection-overlay {
      opacity: 1; pointer-events: auto; backdrop-filter: blur(25px) saturate(160%); -webkit-backdrop-filter: blur(25px) saturate(160%); background: rgba(255,255,255,0.2);
    }
    #wizard[data-flow="listing"] .photo-header img { transition: transform 0.4s, filter 0.4s; }
    #wizard[data-flow="listing"] .photo-header.is-selecting img { transform: scale(1.1); filter: brightness(0.7) blur(25px); }
    #wizard[data-flow="listing"] .photo-header.is-selecting .inserat-photo-placeholder { filter: blur(25px); opacity: 0.8; }
    #wizard[data-flow="listing"] .photo-header .selection-overlay-inner {
      display: grid; grid-template-columns: 1fr 1fr; justify-items: center; align-items: center; gap: 8px; width: 100%;
    }
    #wizard[data-flow="listing"] .photo-header .selection-overlay .extra-pill,
    #wizard[data-flow="listing"] .photo-header .selection-overlay .inserat-allergen-pill {
      padding: 8px 14px; border-radius: 999px; font-size: 13px; font-weight: 700; border: 2px solid rgba(0,0,0,0.08); background: rgba(255,255,255,0.5); color: #475569; cursor: pointer; transition: background 0.2s, color 0.2s; -webkit-tap-highlight-color: transparent;
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    }
    #wizard[data-flow="listing"] .photo-header .selection-overlay .extra-pill.active,
    #wizard[data-flow="listing"] .photo-header .selection-overlay .inserat-allergen-pill.active { background: #10b981; color: #fff; border-color: rgba(16,185,129,0.4); box-shadow: 0 2px 10px rgba(16,185,129,0.3); }
    #wizard[data-flow="listing"] .photo-header .selection-overlay-inner.selection-overlay-inner--time { display: flex; align-items: center; justify-content: center; }
    /* Foto ändern / FOTO HINZUFÜGEN: Glass-Pill, unten zentriert [cite: 2026-02-16] */
    #wizard[data-flow="listing"] .liquid-master-panel .photo-header .inserat-photo-change,
    #wizard[data-flow="listing"] .liquid-master-panel .inserat-photo-tile.photo-header .inserat-photo-change {
      position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
      z-index: 10;
      border-radius: 30px;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
      color: #fff;
      padding: 8px 16px;
      border: none;
      font-size: 14px; font-weight: 700;
      cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
      transition: transform 0.12s ease, box-shadow 0.2s ease;
    }
    #wizard[data-flow="listing"] .liquid-master-panel .photo-header .inserat-photo-change:hover,
    #wizard[data-flow="listing"] .liquid-master-panel .photo-header .inserat-photo-change:active { color: #fff; }
    #wizard[data-flow="listing"] .liquid-master-panel .photo-header .inserat-photo-change:active { transform: translateX(-50%) scale(0.98); }
    /* Pricing-Label über Buttons: dezenter Puls; auf schmalen Displays kleiner [cite: 2026-02-16] */
    .pricing-info-label { cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; font-size: 12px; font-weight: 500; color: #94a3b8; margin-bottom: 8px; -webkit-tap-highlight-color: transparent; animation: gentle-pulse 3s infinite ease-in-out; }
    @media (max-width: 400px) {
      #wizard[data-flow="listing"] .pricing-info-label { font-size: 11px; }
    }
    /* No-Scroll UI (S25): Karte + Buttons ohne Scrollen sichtbar [cite: 2026-02-14] */
    @media (max-height: 700px) {
      #wizard[data-flow="listing"] .liquid-master-panel .photo-header,
      #wizard[data-flow="listing"] .liquid-master-panel .inserat-photo-tile.photo-header { height: 140px !important; min-height: 140px !important; }
      #wizard[data-flow="listing"] .liquid-master-panel.inserat-keyboard-active .photo-header,
      #wizard[data-flow="listing"] .liquid-master-panel.inserat-keyboard-active .inserat-photo-tile.photo-header { height: 100px !important; min-height: 100px !important; }
      #wizard[data-flow="listing"] .liquid-master-panel .inserat-power-bar { padding: 8px 16px; }
      #wizard[data-flow="listing"] .liquid-master-panel .inserat-section { padding-top: 8px; padding-bottom: 8px; }
      #wizard[data-flow="listing"] .liquid-master-panel #step-name input.inserat-detail-style-title { font-size: 20px !important; }
      #wizard[data-flow="listing"] .liquid-master-panel .inserat-price-section input.inserat-price-fintech { font-size: 3rem !important; }
    }
    @keyframes gentle-pulse { 0% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.02); opacity: 1; text-shadow: 0 0 8px rgba(16,185,129,0.2); } 100% { transform: scale(1); opacity: 0.8; } }
    /* Interactive Leberkäse-Onboarding [cite: 2026-02-14, 2026-02-16] */
    #wizard[data-flow="listing"] .inserat-onboarding-overlay {
      position: absolute; inset: 0; z-index: 20; display: flex; align-items: center; justify-content: center; padding: 24px; box-sizing: border-box;
      background: rgba(255,255,255,0.4); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
      transition: opacity 0.3s ease; pointer-events: auto;
    }
    #wizard[data-flow="listing"] .inserat-onboarding-overlay.is-dismissed { opacity: 0; pointer-events: none; }
    #wizard[data-flow="listing"] .inserat-onboarding-card {
      background: #fff; border-radius: 24px; padding: 28px 24px; max-width: 320px; text-align: center;
      box-shadow: 0 20px 50px rgba(0,0,0,0.12), 0 0 0 1px rgba(0,0,0,0.04);
    }
    #wizard[data-flow="listing"] .inserat-onboarding-card p { margin: 0 0 20px; font-size: 17px; font-weight: 700; color: #1a1a1a; line-height: 1.4; }
    #wizard[data-flow="listing"] .inserat-onboarding-card .inserat-onboarding-btn { width: 100%; min-height: 52px; border-radius: 16px; border: none; background: #10b981; color: #fff; font-size: 16px; font-weight: 800; cursor: pointer; box-shadow: 0 10px 30px rgba(16,185,129,0.35); -webkit-tap-highlight-color: transparent; }
    #wizard[data-flow="listing"] .inserat-onboarding-card .inserat-onboarding-btn:active { transform: scale(0.98); }
    #wizard[data-flow="listing"] .inserat-onboarding-price-pulse input.inserat-price-fintech { animation: onboarding-price-pulse 2s ease-in-out infinite; }
    @keyframes onboarding-price-pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(16,185,129,0.2); } 50% { box-shadow: 0 0 0 6px rgba(16,185,129,0.15); } }
    #wizard[data-flow="listing"] .pricing-info-label.inserat-onboarding-tooltip { position: relative; }
    #wizard[data-flow="listing"] .pricing-info-label.inserat-onboarding-tooltip::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); margin-bottom: 6px; padding: 6px 10px; background: #1a1a1a; color: #fff; font-size: 11px; font-weight: 600; border-radius: 8px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    #wizard[data-flow="listing"] .pricing-info-label.inserat-onboarding-tooltip:hover::after { opacity: 1; }
    /* Smart-Photo: Vorschaubilder (3 Standard-Bilder / imageMap) */
    .photo-suggestion {
      width: 60px; height: 60px; border-radius: 12px; object-fit: cover; border: 2px solid transparent;
      transition: all 0.2s ease; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .photo-suggestion:active { transform: scale(0.9); border-color: #10b981; }
    /* Status-Leiste: Pills direkt unter dem Bild (🍴 Vor Ort, 🔄 Mehrweg) */
    .inserat-status-bar {
      display: flex; gap: 12px; padding: 12px 20px; flex-shrink: 0;
      background: rgba(255,255,255,0.6); border-bottom: 1px solid rgba(0,0,0,0.04);
      justify-content: center; align-items: center;
    }
    .inserat-status-bar .status-pill {
      display: inline-flex; align-items: center; justify-content: center; gap: 6px;
      padding: 8px 16px; border-radius: 999px; font-size: 14px; font-weight: 700;
      border: 2px solid transparent; min-height: 44px; cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      -webkit-tap-highlight-color: transparent;
    }
    .inserat-status-bar .status-pill.active {
      background: #10b981; color: #fff; box-shadow: 0 4px 14px rgba(16,185,129,0.4);
    }
    .inserat-status-bar .status-pill.inactive {
      background: rgba(0,0,0,0.06); color: #64748b; filter: grayscale(0.5);
    }
    .inserat-status-bar .status-pill:active { transform: scale(0.98); }
    /* Listing-Flow: Unified – nur 🍴 🔄 Pills, Emerald wenn aktiv */
    #wizard[data-flow="listing"] .inserat-status-bar.inserat-unified-pills .status-pill {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      padding: 10px 18px; border-radius: 999px; font-size: 14px; font-weight: 700;
      border: 2px solid transparent; min-height: 44px; cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      -webkit-tap-highlight-color: transparent;
    }
    #wizard[data-flow="listing"] .inserat-status-bar.inserat-unified-pills .status-pill.active {
      background: #10b981; color: #fff; box-shadow: 0 4px 14px rgba(16,185,129,0.4);
    }
    #wizard[data-flow="listing"] .inserat-status-bar.inserat-unified-pills .status-pill.inactive {
      background: rgba(0,0,0,0.06); color: #64748b;
    }
    #wizard[data-flow="listing"] .inserat-status-bar.inserat-unified-pills .status-pill:active { transform: scale(0.98); }
    /* Goldene Sammelkarte: Power-Bar – aktive Icons weiß + Emerald-Border/Shadow, 44x44 [cite: 2026-01-27, 2026-02-16] */
    #wizard[data-flow="listing"] .inserat-power-bar.inserat-unified-pills .status-pill.active { background: #fff; color: #0f766e; border: 2px solid #10b981; box-shadow: 0 2px 12px rgba(16,185,129,0.35); }
    #wizard[data-flow="listing"] .inserat-power-bar.inserat-unified-pills .status-pill.inactive { background: rgba(0,0,0,0.06); color: #64748b; border: 2px solid transparent; }
    #wizard[data-flow="listing"] .inserat-power-bar .func-icon-btn { width: 44px; height: 44px; min-width: 44px; min-height: 44px; border-radius: 12px; display: inline-flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid rgba(0,0,0,0.08); background: rgba(0,0,0,0.04); transition: background 0.2s, color 0.2s, transform 0.1s cubic-bezier(0.4,0,0.2,1); cursor: pointer; -webkit-tap-highlight-color: transparent; }
    #wizard[data-flow="listing"] .inserat-power-bar .func-icon-btn.active { background: #fff; color: #0f766e; border-color: #10b981; box-shadow: 0 2px 12px rgba(16,185,129,0.35); }
    #wizard[data-flow="listing"] .inserat-power-bar .func-icon-btn:active { transform: scale(0.9); }
    /* Power-Bar Icon-Only (S25): 44x44px Touch-Targets, space-between [cite: 2026-02-16] */
    #wizard[data-flow="listing"] .inserat-power-bar.inserat-unified-pills {
      justify-content: space-between; padding-left: 16px; padding-right: 16px;
    }
    #wizard[data-flow="listing"] .inserat-power-bar .status-pill {
      min-width: 44px; min-height: 44px; padding: 8px; justify-content: center;
      transition: transform 0.1s cubic-bezier(0.4,0,0.2,1);
    }
    #wizard[data-flow="listing"] .inserat-power-bar .status-pill:active { transform: scale(0.9); }
    #wizard[data-flow="listing"] .inserat-power-bar .power-bar-legend-trigger:hover,
    #wizard[data-flow="listing"] .inserat-power-bar .power-bar-legend-trigger:focus { color: #64748b; }
    /* #psheet: No-Scroll – Karte ist das Interface. Position von .sheet (fixed) bleibt, Popover bezieht sich auf #psheet. */
    #psheet .universal-dish-card.psheet-card { width: 100%; background: #fff; border-radius: 16px; overflow: hidden; border: 1px solid rgba(0,0,0,0.06); }
    #psheet .psheet-photo-header { border-radius: 0; }
    #psheet .psheet-price-sticker { position: absolute; bottom: 8px; right: 8px; padding: 6px 12px; border-radius: 999px; font-weight: 900; font-size: 14px; background: rgba(255,215,0,0.95); color: #1a1a1a; box-shadow: 0 2px 8px rgba(255,215,0,0.3); z-index: 10; }
    #psheet .psheet-power-bar.inserat-power-bar.inserat-unified-pills {
      display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 10px 16px;
      padding: 12px 16px; border-bottom: 1px solid rgba(0,0,0,0.04); flex-shrink: 0; background: rgba(0,0,0,0.02);
    }
    #psheet .psheet-power-bar .status-pill {
      min-width: 44px; min-height: 44px; padding: 8px; display: inline-flex; align-items: center; justify-content: center;
      border-radius: 12px; border: 2px solid rgba(0,0,0,0.08); background: rgba(0,0,0,0.04);
      font-size: 18px; transition: transform 0.1s cubic-bezier(0.4,0,0.2,1);
    }
    #psheet .psheet-power-bar .status-pill.active { background: #10b981; color: #fff; border-color: rgba(16,185,129,0.4); box-shadow: 0 4px 14px rgba(16,185,129,0.4); }
    #psheet .psheet-power-bar .status-pill.inactive { opacity: 0.6; filter: grayscale(0.4); }
    #psheet .psheet-power-bar .func-icon-btn {
      width: 44px; height: 44px; min-width: 44px; min-height: 44px; border-radius: 12px;
      display: inline-flex; align-items: center; justify-content: center; font-size: 20px;
      border: 2px solid rgba(0,0,0,0.08); background: rgba(0,0,0,0.04);
    }
    #psheet .psheet-power-bar .func-icon-btn.active { background: #10b981; color: #fff; border-color: rgba(16,185,129,0.4); box-shadow: 0 2px 10px rgba(16,185,129,0.3); }
    #psheet .psheet-power-bar .power-bar-legend-trigger { min-width: 44px; min-height: 44px; display: inline-flex; align-items: center; justify-content: center; color: #94a3b8; font-size: 14px; border: none; background: transparent; font-family: inherit; margin: 0; }
    #psheet .psheet-power-bar button.status-pill,
    #psheet .psheet-power-bar button.func-icon-btn { font-family: inherit; margin: 0; }
    #psheet .psheet-card-title { margin: 0 0 12px; font-size: 24px; font-weight: 800; color: #0f172a; letter-spacing: -0.03em; line-height: 1.2; }
    #psheet .psheet-price-block { margin-top: 8px; }
    #psheet .psheet-price-block .psheet-price-value { font-size: 4rem; font-weight: 900; color: #1a1a1a; }
    #psheet .psheet-price-block .inserat-price-euro-sup { font-size: 1.5rem; font-weight: 900; color: #1a1a1a; vertical-align: super; margin-left: 4px; }
    #psheet .psheet-body { display: flex; flex-direction: column; gap: 0; flex: 1; min-height: 0; }
    #psheet .psheet-card-body .psheet-info-line { font-size: 15px; font-weight: 700; color: #64748b; margin: 0; }
    #psheet .psheet-share-on-image { position: absolute; top: 12px; right: 12px; z-index: 11; width: 40px; height: 40px; border-radius: 50%; border: none; background: rgba(255,255,255,0.95); box-shadow: 0 2px 10px rgba(0,0,0,0.12); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: transform 0.1s; }
    #psheet .psheet-share-on-image:active { transform: scale(0.92); }
    /* Fullscreen Interactive Card: Psheet füllt den gesamten Bildschirm (ohne Ränder) */
    #psheet.sheet.active { inset: 0; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; max-height: none; border-radius: 0; box-shadow: none; }
    #psheet .handle { display: none; }
    #psheet .sheet-body.psheet-body { display: flex; flex-direction: column; min-height: 100%; padding: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    #psheet .psheet-photo-header { height: 38vh; min-height: 200px; flex-shrink: 0; }
    /* Decision Zone: Mit Abholnummer (Grün) + Nur Inserat (Gelb) – fixiert am unteren Rand */
    #psheet .psheet-footer-sticky.psheet-decision-zone { display: flex !important; flex-direction: column; gap: 12px; padding: 16px 20px; padding-bottom: max(16px, env(safe-area-inset-bottom)); border-top: 1px solid rgba(0,0,0,0.06); background: rgba(255,255,255,0.98); flex-shrink: 0; }
    #psheet .psheet-btn-decision { width: 100%; min-height: 52px; border-radius: 16px; font-size: 16px; font-weight: 800; border: none; cursor: pointer; transition: opacity 0.25s ease, transform 0.2s, box-shadow 0.2s; }
    #psheet .psheet-btn-decision.psheet-btn-green { background: #10b981; color: #fff; box-shadow: 0 4px 14px rgba(16,185,129,0.4); }
    #psheet .psheet-btn-decision.psheet-btn-green:active { transform: scale(0.98); }
    #psheet .psheet-btn-decision.psheet-btn-green.psheet-ready { animation: psheet-gentle-pulse 2s ease-in-out infinite; }
    #psheet .psheet-btn-decision.psheet-btn-yellow { background: #FFD700; color: #1a1a1a; box-shadow: 0 4px 16px rgba(255,215,0,0.35); }
    #psheet .psheet-btn-decision.psheet-btn-yellow:active { transform: scale(0.98); }
    #psheet .psheet-btn-decision.psheet-incomplete { opacity: 0.5; pointer-events: none; }
    @keyframes psheet-gentle-pulse { 0%, 100% { box-shadow: 0 4px 14px rgba(16,185,129,0.4); } 50% { box-shadow: 0 6px 20px rgba(16,185,129,0.5); } }
    /* Edit-Modus: 1px Emerald-Glow + leichter Pulse auf editierbaren Feldern */
    #psheet .psheet-card.psheet-edit-mode { box-shadow: 0 0 0 1px #10b981, 0 4px 24px rgba(16,185,129,0.15); border-radius: 16px; transition: box-shadow 0.25s ease; }
    #psheet .psheet-card.psheet-edit-mode .psheet-price-btn,
    #psheet .psheet-card.psheet-edit-mode .psheet-power-bar [data-psheet-icon] { animation: psheet-field-pulse 2s ease-in-out infinite; }
    @keyframes psheet-field-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.85; } }
    /* Pill-Bounce beim Icon-Klick (Elastic) */
    #psheet .psheet-power-bar .status-pill.psheet-pill-bounce,
    #psheet .psheet-power-bar .func-icon-btn.psheet-pill-bounce { animation: psheet-pill-bounce 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
    @keyframes psheet-pill-bounce { 0% { transform: scale(1) translateY(0); } 30% { transform: scale(1.08) translateY(-6px); } 60% { transform: scale(1.02) translateY(-2px); } 100% { transform: scale(1) translateY(0); } }
    /* One-Tap Price: Overlay mit 4rem-Zahlenblock, Rest abgedunkelt */
    .psheet-price-overlay { position: fixed; inset: 0; z-index: 2010; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
    .psheet-price-overlay-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.5); }
    .psheet-price-overlay-inner { position: relative; background: #fff; border-radius: 24px; padding: 32px; width: 100%; max-width: 320px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 16px; }
    .psheet-price-overlay-label { font-size: 12px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; }
    .psheet-price-input { font-size: 4rem; font-weight: 900; color: #0f172a; border: 2px solid #e2e8f0; border-radius: 16px; padding: 16px 20px; text-align: center; width: 100%; box-sizing: border-box; }
    .psheet-price-input:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 3px rgba(16,185,129,0.2); }
    .psheet-price-overlay-close { min-height: 48px; border-radius: 14px; background: #10b981; color: #fff; border: none; font-size: 16px; font-weight: 800; cursor: pointer; }
    /* Inline Title (Fintech-Style): Midnight Blue, Emerald-Fokus, Smart-Height [cite: 2026-02-16] */
    #psheet .dish-title-input { color: #0f172a; font-weight: 800; font-size: 1.6rem; line-height: 1.2; border: none; border-bottom: 2px solid transparent; transition: all 0.2s ease-out; padding: 5px 0; background: transparent; width: 100%; box-sizing: border-box; font-family: inherit; min-height: 1.5em; resize: none; }
    #psheet .dish-title-input::placeholder { color: #94a3b8; }
    #psheet .dish-title-input:focus { border-bottom-color: #10b981; background: rgba(16,185,129,0.05); outline: none; transform: scale(1.02); box-shadow: 0 4px 12px rgba(16,185,129,0.12); }
    /* Category-Pill: Companion-Bounce, Sync mit Titel-Fokus [cite: 2026-02-16] */
    #psheet .category-pill { transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); display: inline-block; padding: 4px 12px; border-radius: 20px; background: #f1f5f9; font-size: 0.85rem; font-weight: 600; color: #64748b; margin-top: 6px; }
    #psheet .dish-title-input:focus + .category-pill { transform: translateY(-5px); background: #fff; color: #0f172a; box-shadow: 0 4px 12px rgba(16,185,129,0.2); }
    @keyframes pill-jiggle { 0% { transform: translateY(-5px) scale(1); } 50% { transform: translateY(-7px) scale(1.05); } 100% { transform: translateY(-5px) scale(1); } }
    #psheet .category-pill.jiggle { animation: pill-jiggle 0.15s ease-out; }
    #psheet .dish-title-input:not(:focus) + .category-pill { transform: translateY(0); }
    /* Price-Button: Harmonic Pulse beim Tippen [cite: 2026-02-16] */
    #psheet .price-button-yellow { transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); transform-origin: right center; }
    @keyframes price-pulse { 0% { transform: scale(1) translateX(0); filter: brightness(1); } 50% { transform: scale(1.05) translateX(3px); filter: brightness(1.1); } 100% { transform: scale(1) translateX(0); filter: brightness(1); } }
    #psheet .price-button-yellow.jiggle { animation: price-pulse 0.15s ease-out; }
    /* Universal-X: Pop-Away Exit [cite: 2026-02-16] */
    #psheet .universal-x { position: absolute; top: 12px; right: 12px; z-index: 15; width: 44px; height: 44px; border-radius: 50%; border: none; background: rgba(255,255,255,0.95); color: #64748b; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: transform 0.2s ease; }
    #psheet .universal-x:hover { color: #1a1a1a; }
    @keyframes x-pop-away { 0% { transform: scale(1); opacity: 1; } 30% { transform: scale(0.8); opacity: 1; } 60% { transform: scale(1.3); opacity: 0.5; } 100% { transform: scale(0); opacity: 0; } }
    #psheet .universal-x.exit-active { animation: x-pop-away 0.3s forwards cubic-bezier(0.34, 1.56, 0.64, 1); pointer-events: none; }
    #psheet .sheet-body.psheet-body { position: relative; }
    #psheet .psheet-legend-popover { position: absolute; left: 0; right: 0; bottom: 0; top: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 20; display: flex; align-items: center; justify-content: center; padding: 20px; }
    #psheet .psheet-legend-inner { background: #fff; border-radius: 16px; padding: 20px; max-width: 320px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
    #psheet .psheet-legend-print { display: block; width: 100%; margin-bottom: 8px; padding: 12px 16px; background: #10b981; color: #fff; border: none; border-radius: 12px; font-weight: 800; font-size: 14px; cursor: pointer; }
    #psheet .psheet-legend-close { display: block; width: 100%; padding: 12px; background: transparent; color: #64748b; border: 1px solid #e2e8f0; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; }
    /* Save-Scope-Dialog: Nur aktuell vs. Kochbuch [cite: Asset-Logik] */
    .save-scope-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1998; }
    .save-scope-sheet { position: fixed; left: 50%; bottom: 0; transform: translateX(-50%); width: 100%; max-width: 400px; background: #fff; border-radius: 20px 20px 0 0; padding: 24px 20px max(env(safe-area-inset-bottom), 20px); box-shadow: 0 -10px 40px rgba(0,0,0,0.15); z-index: 1999; display: flex; flex-direction: column; gap: 12px; }
    .save-scope-title { margin: 0 0 8px; font-size: 16px; font-weight: 800; color: #0f172a; }
    .save-scope-btn { min-height: 48px; border-radius: 14px; border: none; font-size: 15px; font-weight: 800; cursor: pointer; width: 100%; }
    .save-scope-btn-current { background: #f1f5f9; color: #0f172a; }
    .save-scope-btn-cookbook { background: #10b981; color: #fff; }
    .save-scope-cancel { background: transparent; color: #64748b; border: none; font-size: 14px; font-weight: 700; cursor: pointer; padding: 12px; }
    #psheet .psheet-state-badge.card-state-badge { position: absolute; top: 12px; left: 12px; padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.03em; z-index: 12; display: flex; align-items: center; gap: 6px; }
    #psheet .psheet-state-badge.card-state-live { background: rgba(255,255,255,0.95); color: #1a1a1a; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    #psheet .psheet-state-badge.card-state-live::before { content: ''; width: 8px; height: 8px; background: #22c55e; border-radius: 50%; }
    #psheet .psheet-state-badge.card-state-planned { background: rgba(59,130,246,0.9); color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    #psheet .universal-dish-card.psheet-card .psheet-photo-header { cursor: pointer; }
    #psheet .universal-dish-card.psheet-card .psheet-card-body { cursor: default; }
    /* Titel + Kategorie links, Preis rechts (Fullscreen Interactive Card) */
    #psheet .psheet-card-title-row { display: flex; align-items: flex-start; justify-content: space-between; gap: 16px; padding: 20px 20px 16px; flex-wrap: wrap; }
    #psheet .psheet-card-title-wrap { flex: 1; min-width: 0; }
    #psheet .psheet-card-title { margin: 0 0 8px; font-size: 24px; font-weight: 900; color: #0f172a; letter-spacing: -0.03em; line-height: 1.2; }
    #psheet .psheet-category-pill { display: inline-block; padding: 6px 12px; border-radius: 999px; font-size: 13px; font-weight: 700; color: #64748b; background: rgba(0,0,0,0.06); }
    #psheet .psheet-price-btn { flex-shrink: 0; min-height: 48px; padding: 12px 20px; border-radius: 16px; font-size: 18px; font-weight: 900; color: #1a1a1a; background: #FFD700; border: none; cursor: pointer; box-shadow: 0 4px 16px rgba(255,215,0,0.35); transition: transform 0.1s, box-shadow 0.15s; }
    #psheet .psheet-price-btn:active { transform: scale(0.98); }
    /* Icon-Leiste anklickbar (für Header-Morphing) */
    #psheet .psheet-power-bar .status-pill,
    #psheet .psheet-power-bar .func-icon-btn,
    #psheet .psheet-power-bar .power-bar-legend-trigger { cursor: pointer; -webkit-tap-highlight-color: transparent; }
    #psheet .psheet-power-bar .status-pill:active,
    #psheet .psheet-power-bar .func-icon-btn:active { transform: scale(0.92); }
    /* Titel wie Detailseite (h2#sDish): 24px, 950, Abstand 0 0 8px, gleiche Typo */
    .inserat-unified-title-wrap {
      padding-bottom: 0;
    }
    .inserat-unified-title-wrap .inserat-detail-style-title {
      margin: 0 0 8px;
      font-size: 24px; font-weight: 800; color: #0f172a; letter-spacing: -0.03em; line-height: 1.2;
      width: 100%; border: none; border-bottom: 2px solid rgba(0,0,0,0.08);
      background: transparent; padding: 4px 0 8px; outline: none;
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
    }
    .inserat-unified-title-wrap .inserat-detail-style-title:focus {
      border-bottom-color: #10b981;
      animation: magnet-pulse 1.2s ease-in-out infinite;
    }
    .inserat-unified-title-wrap .inserat-detail-style-title::placeholder { color: #94a3b8; }
    /* Listing: Titel exakt wie Detailkarte #sDish (24px, 950) – überschreibt glass-express input:first-of-type */
    #wizard[data-flow="listing"].sheet--kitchen .liquid-master-panel #step-name input.inserat-detail-style-title,
    #wizard[data-flow="listing"].sheet--kitchen .glass-express-step0 #step-name input.inserat-detail-style-title {
      font-size: 24px !important;
      font-weight: 800 !important;
      color: #0f172a !important;
      letter-spacing: -0.03em;
      line-height: 1.2;
    }
    /* Beschreibung wie Detailseite sProviderName: 16px, 700, Abstand darunter 24px */
    #wizard[data-flow="listing"] .inserat-unified-title-wrap .inserat-airbnb-desc-wrap {
      margin-top: 0; margin-bottom: 24px;
    }
    #wizard[data-flow="listing"] .inserat-unified-title-wrap .inserat-desc-input,
    #wizard[data-flow="listing"] .inserat-unified-title-wrap .inserat-airbnb-desc {
      font-size: 16px; font-weight: 700; color: #1a1a1a;
    }
    #wizard[data-flow="listing"] .inserat-unified-title-wrap .inserat-desc-input::placeholder,
    #wizard[data-flow="listing"] .inserat-unified-title-wrap .inserat-airbnb-desc::placeholder {
      color: #64748b;
    }
    /* Kategorie-Pills: wie Detailseite sAllergensCodes / Karten-Text – 14px, 700, #1a1a1a, gleiche Optik */
    /* Goldene Sammelkarte: Kategorie + Preis in einer Zeile, Preis gelbe Pill rechts [cite: 2026-02-16] */
    #wizard[data-flow="listing"] .inserat-cat-price-row {
      display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 12px;
      margin-bottom: 16px;
    }
    #wizard[data-flow="listing"] .inserat-price-pill-wrap {
      display: inline-flex; align-items: center; flex-shrink: 0;
      padding: 8px 14px; border-radius: 999px; background: rgba(255,215,0,0.95); box-shadow: 0 2px 8px rgba(255,215,0,0.3);
    }
    #wizard[data-flow="listing"] .inserat-price-pill-input {
      width: 56px; border: none; background: transparent; font-size: 16px; font-weight: 900; color: #1a1a1a;
      padding: 0; outline: none;
    }
    #wizard[data-flow="listing"] .inserat-price-pill-input::placeholder { color: rgba(0,0,0,0.4); }
    #wizard[data-flow="listing"] .inserat-price-pill-euro { font-size: 14px; font-weight: 800; color: #1a1a1a; margin-left: 2px; }
    #wizard[data-flow="listing"] .inserat-desc-italic,
    #wizard[data-flow="listing"] .inserat-airbnb-desc.inserat-desc-italic { font-style: italic; color: #64748b; }
    #wizard[data-flow="listing"].sheet--kitchen .inserat-cat-pills .extra-pill {
      font-size: 13px; font-weight: 700; color: #1a1a1a;
      padding: 8px 14px; border-radius: 999px; background: rgba(0,0,0,0.04);
      border: none; min-height: 40px;
    }
    #wizard[data-flow="listing"].sheet--kitchen .inserat-cat-pill.active,
    #wizard[data-flow="listing"].sheet--kitchen .inserat-cat-pills .extra-pill.active {
      background: #10b981 !important; color: #fff !important;
      box-shadow: 0 4px 14px rgba(16,185,129,0.4);
    }
    /* Preis-Sektion: wie sPriceSticker – 14px, 900 (ohne Fintech-Klasse) */
    #wizard[data-flow="listing"] .inserat-price-section .inserat-price-input:not(.inserat-price-fintech),
    #wizard[data-flow="listing"] .inserat-price-section .price-display:not(.inserat-price-fintech) {
      font-size: 14px !important; font-weight: 900 !important; color: #1a1a1a !important;
    }
    /* Fintech-Preis (S25): massive Zahl 4rem, Hochzahl-€ */
    #wizard[data-flow="listing"] .inserat-price-section input.inserat-price-fintech {
      width: 140px; max-width: 60%; background: transparent !important;
      border: none !important; border-bottom: 2px solid rgba(0,0,0,0.08) !important;
      border-radius: 0 !important; padding: 12px 0 10px !important; outline: none !important;
      font-size: 4rem !important; font-weight: 900 !important; color: #1a1a1a !important;
      text-align: center; transition: border-color 0.3s ease;
    }
    #wizard[data-flow="listing"] .inserat-price-section .inserat-price-euro-sup { font-size: 1.5rem; font-weight: 900; color: #1a1a1a; vertical-align: super; margin-left: 4px; }
    #wizard[data-flow="listing"] .inserat-price-section input.inserat-price-fintech:focus {
      border-bottom-color: #10b981 !important;
      animation: magnet-pulse 1.2s ease-in-out infinite;
    }
    /* Umsatzprognose: wie sInfoHint – 12px, 600, #94a3b8 */
    #wizard[data-flow="listing"] .inserat-prognose-wrap.inserat-umsatzprognose p {
      font-size: 12px; font-weight: 600; color: #94a3b8;
    }
    /* Funktions-Icons am Ende: schwebend, gläsernes Dropdown */
    .inserat-func-icons {
      display: flex; gap: 16px; padding: 20px; justify-content: center; align-items: center;
      flex-shrink: 0;
    }
    .inserat-func-icons .func-icon-btn {
      width: 48px; height: 48px; border-radius: 14px;
      background: rgba(255,255,255,0.7); backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.5);
      display: flex; align-items: center; justify-content: center; font-size: 24px;
      cursor: pointer; transition: transform 0.12s; -webkit-tap-highlight-color: transparent;
    }
    .inserat-func-icons .func-icon-btn:active { transform: scale(0.95); }
    .inserat-func-icons .func-icon-btn.active {
      background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.4);
    }
    
    /* Kein Wizard-Chrome im Listing – nur Panel */
    #wizard[data-flow="listing"].sheet--kitchen .wizard-progress-dots,
    #wizard[data-flow="listing"].sheet--kitchen .w-top,
    #wizard[data-flow="listing"].sheet--kitchen .w-q,
    #wizard[data-flow="listing"].sheet--kitchen .w-help {
      display: none !important;
    }
    /* Handle + Sheet dezent (app-like ein Screen) */
    #wizard[data-flow="listing"].sheet--kitchen .handle{
      width: 40px; height: 4px; background: rgba(0,0,0,0.2); border-radius: 999px; margin: 8px auto 6px;
    }
    #wizard[data-flow="listing"].sheet--kitchen.active{
      box-shadow: 0 -2px 24px rgba(0,0,0,0.08); border-top: 1px solid rgba(255,255,255,0.6);
    }

    /* Einheitliches Support-Layout: Anbieter + Inseratsflow (Buttons, Panels, Abstände wie Support-Sheet) */
    :root{
      --support-border:#e5e7eb;
      --support-border-radius:12px;
      --support-padding:16px;
      --support-padding-lg:24px;
    }
    /* Provider-App: Systemweite Design-Vorgabe – Warmes Beige, Dein Gelb, Weiß */
    :root{
      --provider-bg: #F8F7F2;
      --provider-surface: #ffffff;
      --provider-surface-alt: #f0f0eb;
      --provider-border: rgba(0,0,0,0.06);
      --provider-text: #1a1a1a;
      --provider-text-muted: #64748b;
      --provider-shadow: 0 4px 20px rgba(0,0,0,0.05);
      --provider-radius: 20px;
      --prov-brand: #FFDE00;
      --prov-success: #FFDE00;
      --prov-danger: #ef4444;
      --premium-anthracite: #1a1a1a;
      --premium-anthracite-soft: #334155;
      --glass-bg: rgba(255,255,255,0.75);
      --glass-border: rgba(255,255,255,0.4);
      --glass-shadow: 0 8px 32px rgba(0,0,0,0.06);
      --glass-inner-glow: inset 0 1px 0 rgba(255,255,255,0.8);
      --card-radius-premium: 24px;
      --card-shadow-soft: 0 4px 20px rgba(0,0,0,0.05);
      --card-shadow-hover: 0 12px 40px rgba(0,0,0,0.08);
    }
    /* Provider: einheitlich Warmes Beige #F8F7F2 – kein Farbsprung zwischen Dashboard/Wochenplan/Inserat */
    body.provider-mode [id^="v-provider-"].view{ position:relative; background: var(--provider-bg) !important; }
    body.provider-mode #v-provider-home,
    body.provider-mode #v-provider-pickups,
    body.provider-mode #v-provider-profile,
    body.provider-mode #v-provider-billing{ background: var(--provider-bg) !important; }
    /* Kochbuch & Wochenplan: Warmes Glassmorphism-Hintergrund */
    body.provider-mode #v-provider-cookbook,
    body.provider-mode #v-provider-week{ background: linear-gradient(180deg, rgba(254,243,199,0.25) 0%, #F5F5F7 35%, #F5F5F7 100%) !important; }
    body.provider-mode #v-provider-home > *,
    body.provider-mode #v-provider-week > *,
    body.provider-mode [id^="v-provider-"].view.active > *{ position:relative; z-index:1; }
    
    /* Modern App-Like CSS for Provider */
    .prov-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      padding: 12px 20px 16px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    
    .prov-title {
      margin: 0;
      font-size: 24px;
      font-weight: 950;
      letter-spacing: -0.03em;
      color: #1a1a1a;
    }
    
    /* App-Header Abholungen/Wochenplan/Kochbuch */
    body.provider-mode .prov-page-header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255,255,255,0.8) !important;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,0.2);
      padding: calc(8px + env(safe-area-inset-top, 0)) 20px 12px 20px;
    }
    .prov-page-header .prov-page-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .prov-page-header .prov-page-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }
    /* Einheitlich: alle Anbieter-Header (Meine Küche, Abholungen, Wochenplan, Kochbuch) */
    .prov-page-header .prov-page-header-icon {
      width: 44px;
      height: 44px;
      background: var(--prov-brand);
      color: #1a1a1a;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(255, 222, 0, 0.25);
      flex-shrink: 0;
    }
    .prov-page-header .prov-page-header-icon i,
    .prov-page-header .prov-page-header-icon svg {
      width: 24px;
      height: 24px;
      color: #fff;
    }
    .prov-page-header .prov-page-header-title {
      margin: 0;
      font-size: 20px;
      font-weight: 900;
      letter-spacing: -0.03em;
      color: #1a1a1a;
    }
    .prov-page-header .prov-page-header-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    .prov-page-header .prov-page-header-actions button,
    .prov-page-header .prov-page-header-action {
      background: rgba(0,0,0,0.06);
      border: none;
      width: 44px;
      height: 44px;
      min-width: 44px;
      min-height: 44px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #1a1a1a;
      cursor: pointer;
    }
    .prov-page-header .prov-page-header-actions button:active {
      transform: scale(0.96);
    }
    
    .prov-card {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: var(--card-radius-premium, 24px);
      padding: var(--card-padding, 20px);
      border: 1px solid var(--glass-border);
      box-shadow: var(--card-shadow-soft), var(--glass-inner-glow);
      margin-bottom: 20px;
      transition: transform 0.22s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s ease;
      max-width: 100%;
      min-width: 0;
      box-sizing: border-box;
    }
    .prov-card:active {
      transform: scale(0.98);
      box-shadow: 0 2px 12px rgba(0,0,0,0.04), var(--glass-inner-glow);
    }
    
    .prov-stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0;
      margin-top: 12px;
    }
    
    .prov-stat-item {
      text-align: center;
      padding: 12px 8px;
      border-right: 1px solid #eee;
    }
    .prov-stat-item:last-child {
      border-right: none;
    }
    .prov-stat-value {
      display: block;
      font-size: 24px;
      font-weight: 950;
      color: #1a1a1a;
      line-height: 1;
    }
    .prov-stat-label {
      font-size: 10px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #9ca3af;
      margin-top: 6px;
      display: block;
    }
    
    .prov-badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    .prov-badge-live { background: rgba(255, 222, 0, 0.2); color: #1a1a1a; font-weight: 700; }
    .prov-badge-draft { background: rgba(100, 116, 139, 0.1); color: #64748b; }
    .prov-badge-abholer { background: rgba(255, 222, 0, 0.2); color: #1a1a1a; }
    
    .prov-action-btn {
      background: var(--provider-surface);
      border: 1px solid var(--provider-border);
      padding: 16px;
      border-radius: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .prov-action-btn:active { transform: scale(0.96); }
    .prov-action-icon {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content:center;
    }
    
    [id^="v-provider-"]{
      background:var(--provider-bg) !important;
      font-family: 'Inter', sans-serif;
    }
    /* Einheitlicher Sticky-Header für Anbieter-Subseiten */
    .provider-header-bar{
      background:#fff !important;
      position:sticky; top:0; z-index:50;
      border-bottom:1px solid rgba(0,0,0,0.06);
      padding:16px 20px;
      margin:-20px -20px 24px -20px;
      display:flex; align-items:center; justify-content:center;
    }
    .provider-header-bar h1{ margin:0; font-size:18px; font-weight:700; color:#1a1a1a !important; }
    .provider-header-bar .btn-back{ position:absolute; left:10px; color:#0A84FF; font-size:16px; padding:8px; display:flex; align-items:center; gap:4px; background:none; border:none; cursor:pointer; }
    /* Legal-Anbieter-Seiten: gleiches helles Layout */
    #v-legal-impressum-provider,
    #v-legal-faq-provider,
    #v-legal-datenschutz-provider,
    #v-legal-inserat-info-provider{
      background:var(--provider-bg) !important;
    }
    #v-legal-impressum-provider .panel,
    #v-legal-faq-provider .panel,
    #v-legal-datenschutz-provider .panel,
    #v-legal-inserat-info-provider .panel{
      background:#fff !important;
      color:#1a1a1a !important;
      border:1px solid rgba(0,0,0,0.06) !important;
      box-shadow:0 2px 12px rgba(0,0,0,0.06) !important;
    }
    #v-legal-impressum-provider .panel h1,
    #v-legal-faq-provider .panel h1,
    #v-legal-datenschutz-provider .panel h1,
    #v-legal-inserat-info-provider .panel h1,
    #v-legal-inserat-info-provider .panel h2{ color:#1a1a1a !important; }
    #v-legal-impressum-provider .panel div,
    #v-legal-impressum-provider .panel p,
    #v-legal-faq-provider .panel div,
    #v-legal-faq-provider .panel p,
    #v-legal-datenschutz-provider .panel div,
    #v-legal-datenschutz-provider .panel p,
    #v-legal-inserat-info-provider .panel div,
    #v-legal-inserat-info-provider .panel p{ color:#334155 !important; }
    /* Anbieter Infoseite Inseratsflow: Grid 5 Spalten Desktop, 1–2 Spalten Mobile */
    .inserat-info-grid{ display:grid !important; grid-template-columns:repeat(5, 1fr); gap:20px 16px; max-width:100%; }
    @media (max-width: 900px){ .inserat-info-grid{ grid-template-columns:repeat(2, 1fr) !important; } }
    @media (max-width: 480px){ .inserat-info-grid{ grid-template-columns:1fr !important; } }
    #v-legal-impressum-provider .panel a,
    #v-legal-faq-provider .panel a,
    #v-legal-datenschutz-provider .panel a{ color:#0A84FF !important; }
    #v-legal-agb-provider{ background:var(--provider-bg) !important; }
    [id^="v-provider-"] .panel{
      background:var(--provider-surface) !important;
      color:var(--provider-text) !important;
      border:2px solid var(--provider-border) !important;
      box-shadow:none !important;
      border-radius:var(--support-border-radius) !important;
      padding:var(--card-padding, 20px) !important;
    }
    [id^="v-provider-"] .panel div,
    [id^="v-provider-"] .panel span,
    [id^="v-provider-"] .panel label{
      color:var(--provider-text) !important;
    }
    [id^="v-provider-"] .panel .hint,
    [id^="v-provider-"] .provider-profile-section-title{
      color:var(--provider-text-muted) !important;
    }
    /* Provider-Login-View: „Als Gastronom anmelden“ sehr weit oben */
    #v-provider-login{
      display:flex; flex-direction:column; align-items:stretch;
      padding-top:calc(16px + env(safe-area-inset-top, 0)); padding-left:20px; padding-right:20px; padding-bottom:40px;
      min-height:100vh; box-sizing:border-box;
    }
    #v-provider-login .panel{
      margin-top:0 !important; margin-bottom:0 !important; max-width:400px; align-self:center; width:100%;
    }
    /* Status-Banner: nur dieser bleibt grün mit Weißtext (Support-Layout) */
    #providerStatusBanner{
      background:linear-gradient(135deg, #2e7d32 0%, #1f5f23 100%) !important;
      color:#fff !important;
      border:2px solid #1f5f23 !important;
      box-shadow:none !important;
      border-radius:var(--support-border-radius) !important;
    }
    #providerStatusBanner *{ color:#fff !important; }
    /* Kunden-Nachfrage: heller Hintergrund, dunkle Schrift (lesbar) */
    #providerCustomerDemand{
      background:#fffbf0 !important;
      border:1px solid #e6c200 !important;
      color:var(--provider-text) !important;
      border-radius:6px !important;
    }
    #providerCustomerDemand #providerRequestCount{ color:var(--provider-text) !important; font-weight:800 !important; }
    #providerCustomerDemand .btn-primary{ background:#2e7d32 !important; color:#fff !important; }
    #providerPersonalSpar,
    #providerPersonalSpar *{
      background:var(--provider-surface-alt) !important;
      color:var(--provider-text) !important;
      border-color:var(--provider-border) !important;
    }
    #providerPersonalSpar strong{ color:var(--provider-text) !important; }
    [id^="v-provider-"] h1,[id^="v-provider-"] h2,[id^="v-provider-"] h3{
      color:var(--provider-text) !important;
    }
    #v-provider-home .provider-home-header,
    #v-provider-home .provider-home-header *,
    #v-provider-home h1{
      color:var(--provider-text) !important;
    }
    #v-provider-home .provider-home-header div:first-child{
      color:var(--provider-text-muted) !important;
    }
    [id^="v-provider-"] #provPickupsSubheader,
    [id^="v-provider-"] .hint{
      color:var(--provider-text-muted) !important;
    }
    #providerStatusIndicator{
      background:var(--provider-surface) !important;
      border:2px solid var(--provider-border) !important;
      box-shadow:0 1px 3px rgba(0,0,0,.08) !important;
      border-radius:var(--support-border-radius) !important;
    }
    #statusIndicatorText{ color:var(--provider-text) !important; }
    /* KPI-Karten: dunkle Schrift, lesbar */
    #kpiCardTagesessen,
    #kpiCardAbholungen,
    #kpiCardKochbuch{
      background:var(--provider-surface) !important;
      border:2px solid var(--provider-border) !important;
      border-radius:var(--support-border-radius) !important;
    }
    #kpiCardTagesessen div:first-child,
    #kpiCardAbholungen div:first-child,
    #kpiCardKochbuch div:first-child{
      color:var(--provider-text) !important;
    }
    #kpiCardTagesessen div:last-child,
    #kpiCardAbholungen div:last-child,
    #kpiCardKochbuch div:last-child{
      color:var(--provider-text-muted) !important;
    }
    #providerTimeTracker,
    #providerTimeTracker *{
      color:var(--provider-text) !important;
      background:var(--provider-surface) !important;
      border-color:var(--provider-border) !important;
    }
    #providerTimeTracker div:first-child,
    #providerTimeTracker div:last-child{
      color:var(--provider-text-muted) !important;
    }
    #providerTimeTracker #providerTimeSaved{ color:var(--provider-text) !important; }
    #providerTodayShare,
    #providerTodayShare .btn{ color:var(--provider-text) !important; background:var(--provider-surface) !important; border-color:var(--provider-border) !important; }
    /* Buttons im Provider-Bereich: Support-Layout (wie Support-Sheet) */
    [id^="v-provider-"] .btn,
    [id^="v-provider-"] .btn-primary,
    [id^="v-provider-"] button[class*="btn"]{
      border-radius:var(--support-border-radius) !important;
      min-height:48px !important;
      font-weight:700 !important;
      font-size:15px !important;
      padding:var(--support-padding) var(--support-padding-lg) !important;
      box-shadow:none !important;
      transition:border-color .15s, background .15s !important;
      -webkit-tap-highlight-color:transparent;
    }
    [id^="v-provider-"] .btn:active,
    [id^="v-provider-"] .btn-primary:active,
    [id^="v-provider-"] button[class*="btn"]:active{
      transform:scale(0.98) !important;
    }
    [id^="v-provider-"] .btn.secondary,
    [id^="v-provider-"] .btn.ghost{
      background:#fff !important;
      border:2px solid var(--support-border) !important;
      color:var(--provider-text) !important;
    }
    [id^="v-provider-"] .btn:not(.secondary):not(.ghost),
    [id^="v-provider-"] .btn-primary{
      border:2px solid transparent !important;
    }
    /* Bottom-Nav Provider: hell, modern */
    #providerNav{
      background:rgba(255,255,255,0.98) !important;
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
      border-top:1px solid var(--provider-border) !important;
      box-shadow:0 -2px 16px rgba(0,0,0,.06) !important;
    }
    #providerNav .navbtn{ color:var(--provider-text-muted); }
    #providerNav .navbtn.active{ color:var(--prov-brand); }
    #providerNav .navbtn.active .ico svg{ color:var(--prov-brand); stroke:var(--prov-brand); }
    /* Provider Nav Light: Stolz-Edition – Gelb (#ffde00) aktiv, inaktive Tabs 20 % Opacity */
    .provider-nav-light .navbtn{ color:#1a1a1a; font-weight:600; flex:1; min-width:0; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; }
    .provider-nav-light .navbtn{ border-top:2px solid transparent; }
    .provider-nav-light .navbtn:not(.active){ opacity:0.2; }
    .provider-nav-light .navbtn.active{ color:#ffde00; font-weight:700; border-top-color:#ffde00; opacity:1; }
    .provider-nav-light .navbtn.active .ico svg{ color:#ffde00 !important; stroke:#ffde00 !important; }
    /* Schwebende Bottom-Bar (Pille): dunkler Hintergrund, aktiver Tab = gelbe Box */
    .provider-nav-pill .navbtn{ color:rgba(255,255,255,0.4); border-top:none; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; flex:1; min-width:0; }
    .provider-nav-pill .navbtn .ico{ width:44px; height:44px; border-radius:16px; display:flex; align-items:center; justify-content:center; transition:background 0.2s, box-shadow 0.2s; }
    .provider-nav-pill .navbtn:not(.active) .ico{ background:transparent; }
    .provider-nav-pill .navbtn.active{ color:#ffde00; opacity:1; }
    .provider-nav-pill .navbtn.active .ico{ background:#ffde00; width:48px; height:48px; border-radius:16px; box-shadow:0 4px 16px rgba(255,222,0,0.35); }
    .provider-nav-pill .navbtn.active .ico svg{ color:#1a1a1a !important; stroke:#1a1a1a !important; }
    .provider-nav-pill .navbtn .ico + div{ font-size:10px; font-weight:900; text-transform:uppercase; letter-spacing:0.02em; }
    /* Schwebende Bar: Abstand vom Rand (FloatingAppDashboard bottom-10 left-10 right-10) */
    #providerNavWrap.provider-nav-wrap-pill{ bottom:2.5rem !important; left:2.5rem !important; right:2.5rem !important; max-width:32rem; margin-left:auto; margin-right:auto; z-index:100 !important; }
    #providerNavWrap #providerNav{ min-height:80px; }
    @media (max-width: 420px){
      #providerNavWrap.provider-nav-wrap-pill{ left:1rem !important; right:1rem !important; bottom:1.5rem !important; }
    }
    [id^="v-provider-"] .panel h1,[id^="v-provider-"] .panel h2,[id^="v-provider-"] .panel h3,[id^="v-provider-"] .panel .section-title{ color:var(--provider-text) !important; }
    [id^="v-provider-"] .panel .hint{ color:var(--provider-text-muted) !important; }
    /* Dynamisch eingefügter Inhalt: immer lesbar */
    #providerActiveOffersList,
    #providerActiveOffersList *,
    #providerTodayContent,
    #providerTodayContent *,
    #providerWeekDayContent,
    #providerWeekDayContent *{
      color:var(--provider-text) !important;
    }
    #providerActiveOffersList [style*="color:var(--muted)"],
    #providerTodayContent .hint,
    #providerWeekDayContent .hint{
      color:var(--provider-text-muted) !important;
    }
    /* FAB: Stolz gelb, Schatten */
    #fabProviderAddOffer{
      background:#ffde00 !important;
      border:4px solid #fff !important;
      box-shadow:0 4px 20px rgba(0,0,0,0.2), 0 8px 24px rgba(0,0,0,0.12) !important;
      transition:transform .15s ease, box-shadow .15s ease;
    }
    #fabProviderAddOffer .plus-char{ color:#1a1a1a !important; }
    #fabProviderAddOffer:active{ transform:scale(0.95); }
    /* Provider Dashboard CTA: Hover/Active Scale (App-Style) */
    .provider-dashboard-cta:hover{ transform:scale(0.98); }
    .provider-dashboard-cta:active{ transform:scale(0.95); }

    /* FAB nur Dashboard: fest rechts über Bottom-Nav (applike Plus-Button), immer visuell rechts */
    #fabProviderAddOffer{
      position: fixed !important;
      left: auto !important;
      right: calc(16px + env(safe-area-inset-right, 0)) !important;
      bottom: calc(130px + env(safe-area-inset-bottom, 20px)) !important;
      margin-left: 0 !important;
      direction: ltr;
    }
    #fabProviderAddOfferLabel{ right:calc(16px + env(safe-area-inset-right, 0)) !important; }
    #providerStatusIndicator{
      top:calc(16px + env(safe-area-inset-top, 0)) !important;
      right:calc(16px + env(safe-area-inset-right, 0)) !important;
    }

    /* FAQ accordion */
    .faq{margin-top:12px}
    details{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 14px rgba(0,0,0,.06);padding:14px 16px}
    details+details{margin-top:10px}
    summary{cursor:pointer;font-weight:950;font-size:15px;line-height:1.4}
    summary:focus-visible{outline:2px solid var(--accent,#0A84FF);outline-offset:2px;border-radius:8px}
    summary::-webkit-details-marker{display:none}
    #v-legal-faq details summary::-webkit-details-marker,
    #v-legal-faq-provider details summary::-webkit-details-marker{display:none}
    #v-legal-faq details summary::marker,
    #v-legal-faq-provider details summary::marker{content:''}
    details p{margin:10px 0 0;color:var(--muted);font-size:14px;line-height:1.6}
    .profile-faq-accordion details summary::-webkit-details-marker{display:none}

    /* helper */
    .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.25}

    .loc-row{display:flex; gap:8px; align-items:center}
    .pin-btn{
      border:1px solid var(--border); background:#fff; border-radius:14px;
      width:44px; height:44px; cursor:pointer; font-size:18px;
      display:flex; align-items:center; justify-content:center;
    }
    .ico-inline{display:inline-flex; align-items:center}
    .ico-inline svg{width:14px; height:14px; stroke:currentColor}
    .info-row{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; font-size:12px; color:var(--muted)}
    .info-item{
      display:inline-flex; align-items:center; gap:6px;
      background:#f8f7f3; border:1px solid var(--border);
      padding:5px 10px; border-radius:999px;
      font-size:13px; line-height:1.4;
    }

    /* Onboarding */
    .onboarding-step{
      max-width:600px; margin:0 auto;
    }
    .onboarding-header{
      display:flex; justify-content:space-between; align-items:flex-start;
    }
    .onboarding-progress{
      font-size:12px; font-weight:900; color:var(--muted);
      text-transform:uppercase; letter-spacing:.05em;
    }
    .onboarding-logo-preview:hover{
      border-color:var(--brand); background:#fff4e6;
    }
    .onboarding-logo-preview img{
      display:block;
    }
    .time-btn.active{
      background:var(--brand); border-color:var(--brand);
    }
    .onboarding-summary-item:last-child{
      margin-bottom:0;
    }

    /* Social Feed - Story-Leiste */
    .stories-container{
      padding:16px 14px 20px;
      max-width:980px; margin:0 auto;
    }
    .stories-scroll{
      display:flex; gap:16px; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:4px;
    }
    .story-item{
      flex:0 0 auto; display:flex; flex-direction:column; align-items:center; gap:8px;
      cursor:pointer;
    }
    .story-avatar{
      width:64px; height:64px; border-radius:50%;
      border:3px solid var(--brand);
      padding:2px; background:#fff;
      overflow:hidden; position:relative;
    }
    .story-avatar img{
      width:100%; height:100%; object-fit:cover; border-radius:50%;
    }
    .story-name{
      font-size:12px; font-weight:700; color:var(--text);
      max-width:64px; text-align:center; overflow:hidden; text-overflow:ellipsis;
      line-height:1.3;
    }

    /* Discover Page - App-like UX (PWA, Light Mode) */
    /* Toggle-Switch für Discover-View */
    .discover-view-toggle{
      margin-left:auto; /* Rechts ausrichten in Quick-Filters */
    }
    /* View-Toggle im Topbar */
    .discover-view-toggle-topbar{
      display:none;
    }
    
    /* Floating Action Button (FAB) für Modus-Wechsel */
    .fab-mode-toggle{
      position:fixed; bottom:calc(80px + env(safe-area-inset-bottom, 16px) + 20px); right:16px;
      width:56px; height:56px; border-radius:50%;
      background:rgba(255,255,255,.85);
      backdrop-filter:saturate(180%) blur(20px);
      -webkit-backdrop-filter:saturate(180%) blur(20px);
      border:1px solid rgba(231,225,213,.3);
      box-shadow:0 8px 24px rgba(0,0,0,.12), 0 0 0 1px rgba(0,0,0,.04);
      display:none; align-items:center; justify-content:center;
      cursor:pointer; z-index:25;
      transition:transform .2s ease, box-shadow .2s ease, background .2s ease;
      user-select:none;
    }
    .fab-mode-toggle:hover{
      transform:scale(1.05);
      box-shadow:0 12px 32px rgba(0,0,0,.16), 0 0 0 1px rgba(0,0,0,.06);
      background:rgba(255,255,255,.95);
    }
    .fab-mode-toggle:active{
      transform:scale(.95);
    }
    .fab-mode-toggle.pulsing{
      animation:fabPulse .4s ease-out;
    }
    @keyframes fabPulse{
      0%{transform:scale(1);}
      50%{transform:scale(1.15); box-shadow:0 12px 40px rgba(255,184,0,.3), 0 0 0 1px rgba(255,184,0,.2);}
      100%{transform:scale(1);}
    }
    .fab-mode-toggle i{
      width:24px; height:24px;
      color:#2D3436;
      transition:transform .2s ease;
    }
    .fab-mode-toggle.active i{
      transform:rotate(180deg);
    }
    
    /* Micro-Hint (Sprechblase beim ersten Start) */
    .fab-hint{
      position:absolute; bottom:calc(100% + 12px); right:0;
      background:#2D3436; color:#fff;
      padding:10px 14px; border-radius:12px;
      font-size:13px; font-weight:600; white-space:nowrap;
      box-shadow:0 4px 16px rgba(0,0,0,.2);
      opacity:0; pointer-events:none;
      transform:translateY(8px);
      transition:opacity .3s ease, transform .3s ease;
    }
    .fab-hint.show{
      opacity:1; transform:translateY(0);
    }
    .fab-hint::after{
      content:''; position:absolute; top:100%; right:20px;
      width:0; height:0;
      border-left:6px solid transparent;
      border-right:6px solid transparent;
      border-top:6px solid #2D3436;
    }
    .discover-calendar-wrapper{
      padding:6px 0 4px;
      border-top:1px solid rgba(0,0,0,.04);
      max-width:100%;
      margin:0 auto;
      box-sizing:border-box;
    }
    .discover-calendar-scroll{
      display:flex;
      gap:8px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding:0 14px;
      scrollbar-width:none;
    }
    .discover-calendar-scroll::-webkit-scrollbar{display:none}
    .toggle-switch{
      position:relative;
      width:64px;
      height:32px;
      background:#e0e0e0;
      border-radius:16px;
      border:none;
      cursor:pointer;
      transition:background 0.3s ease;
      display:flex;
      align-items:center;
      padding:4px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    .toggle-switch.active{
      background:var(--brand);
    }
    .toggle-icon{
      position:absolute;
      width:24px;
      height:24px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:opacity 0.3s ease, transform 0.3s ease;
      z-index:2;
    }
    .toggle-icon-list{
      left:4px;
      opacity:1;
    }
    .toggle-icon-match{
      right:4px;
      opacity:0.5;
    }
    .toggle-switch.active .toggle-icon-list{
      opacity:0.5;
    }
    .toggle-switch.active .toggle-icon-match{
      opacity:1;
    }
    .toggle-icon svg{
      width:18px;
      height:18px;
      stroke-width:2.5;
    }
    .toggle-slider{
      position:absolute;
      width:24px;
      height:24px;
      background:#fff;
      border-radius:50%;
      transition:transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:0 2px 4px rgba(0,0,0,0.2);
      left:4px;
      z-index:3;
    }
    .toggle-switch.active .toggle-slider{
      transform:translateX(32px);
    }
    /* Status-Ampel Animationen */
    @keyframes pulse-green {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }
    @keyframes blink-red {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    @keyframes pulse-yellow {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }
    @keyframes pulse-green-dot {
      0%, 100% { 
        opacity: 1; 
        transform: scale(1);
        box-shadow: 0 0 12px rgba(39,174,96,0.8);
      }
      50% { 
        opacity: 0.8; 
        transform: scale(1.2);
        box-shadow: 0 0 20px rgba(39,174,96,1);
      }
    }
    
    /* Status-Ampel: Nur im Provider-Modus sichtbar */
    #providerStatusIndicator {
      display: none;
    }
    body.provider-mode #providerStatusIndicator {
      display: flex !important;
    }
    /* Anbieter-Ansichten: Topbar ausblenden, Inhalt beginnt oben ohne Leerraum */
    body.provider-mode .topbar { display: none !important; }
    body.provider-mode main { padding-top: 0 !important; margin-top: 0 !important; padding-left: 16px; padding-right: 16px; padding-bottom: 0 !important; box-sizing: border-box; }
    body.provider-mode main > [id^="v-provider-"].view.active { margin-top: 0 !important; padding-top: 0 !important; }
    /* Kein leerer Screen beim Nach-oben-Scrollen: Overscroll/Rubber-Band deaktivieren */
    body.provider-mode { overscroll-behavior-y: none; -webkit-overflow-scrolling: touch; overflow-x: hidden; }
    /* Nuclear: Im Provider-Modus nur die aktive Provider-View sichtbar – alle anderen main-Kinder aus dem Layout */
    /* Alle main-Kinder ausblenden außer aktive Provider-View + FAB (FAB bleibt sichtbar) */
    body.provider-mode main > *:not([id^="v-provider-"].view.active):not(#fabProviderAddOffer) { display: none !important; }
    /* Anbieter-Views: kein Extra-Platz oben – Inhalt beginnt sofort (Safe-Area nur im Header) */
    body.provider-mode [id^="v-provider-"] { padding-top: 0 !important; margin-top: 0 !important; }
    body.provider-mode [id^="v-provider-"].view.active { padding-top: 0 !important; }
    
    /* Discover Header - Sticky, immer über Kategorie- und Tage-Leiste (z-index > 90) */
    .discover-header-sticky{
      position:sticky; top:0; z-index:100;
      background:rgba(255,255,255,.98); backdrop-filter:blur(20px);
      border-bottom:1px solid rgba(0,0,0,.06);
      box-shadow:0 2px 8px rgba(0,0,0,.04);
    }
    
    /* Ebene 1: Standortsuche (ganz oben) */
    .discover-location-search-row{
      padding:10px 16px 8px; max-width:100%; margin:0 auto;
      box-sizing:border-box;
    }
    .discover-location-search-input{
      width:100%; padding:12px 16px; border-radius:12px;
      border:1px solid rgba(0,0,0,.1); background:#fff;
      font-size:15px; font-weight:500; color:#333;
      outline:none; box-sizing:border-box;
    }
    .discover-location-search-input::placeholder{
      color:#999; font-weight:400;
    }
    .discover-location-search-input:focus{
      border-color:var(--brand); box-shadow:0 0 0 3px rgba(255,215,0,0.1);
    }
    /* Location-Autofill Suggestions */
    .location-suggestion-item{
      padding:10px 12px;
      cursor:pointer;
      border-bottom:1px solid rgba(0,0,0,0.05);
      transition:background 0.2s ease;
    }
    .location-suggestion-item:hover{
      background:rgba(0,0,0,0.05);
    }
    .location-suggestion-item:active{
      background:rgba(0,0,0,0.1);
    }
    .location-suggestion-item{
      padding:10px 12px;
      cursor:pointer;
      border-bottom:1px solid rgba(0,0,0,0.05);
      transition:background 0.2s ease;
    }
    .location-suggestion-item:hover{
      background:rgba(0,0,0,0.05);
    }
    .location-suggestion-item:active{
      background:rgba(0,0,0,0.1);
    }
    
    /* Ebene 2: Aktueller Standort zentriert (klickbar) */
    .discover-location-row{
      display:flex; justify-content:center; align-items:center;
      padding:6px 10px; max-width:100%; margin:0 auto;
      box-sizing:border-box;
    }
    .discover-location-pill-clickable{
      display:flex; align-items:center; gap:6px;
      padding:8px 14px; border-radius:20px;
      background:rgba(0,0,0,.04); border:1px solid rgba(0,0,0,.08);
      font-size:14px; font-weight:600; color:#333;
      cursor:pointer; transition:all 0.2s ease;
      border:none; background:transparent;
    }
    .discover-location-pill-clickable:hover{
      background:rgba(0,0,0,.06);
    }
    .discover-location-pill-clickable i{
      width:16px; height:16px; color:#666;
    }
    
    /* Ebene 2: Quick-Filter Buttons nebeneinander */
    .discover-quick-filters-row{
      display:flex; align-items:center; justify-content:center; gap:6px;
      padding:0 10px 6px; max-width:100%; margin:0 auto;
      box-sizing:border-box;
    }
    
    .quick-filter-btn{
      display:flex; align-items:center; gap:6px;
      padding:10px 16px; border-radius:24px;
      border:1px solid rgba(0,0,0,.1);
      background:#fff; color:#333;
      font-size:14px; font-weight:600;
      cursor:pointer; transition:all 0.2s ease;
      white-space:nowrap;
      box-shadow:0 2px 4px rgba(0,0,0,.05);
    }
    .quick-filter-btn i{
      width:18px; height:18px; flex-shrink:0;
    }
    .quick-filter-btn:hover{
      background:#f8f8f8;
      transform:translateY(-1px);
      box-shadow:0 4px 8px rgba(0,0,0,.08);
    }
    .quick-filter-btn.active{
      background:var(--brand);
      color:#2D3436; border-color:var(--brand);
      font-weight:700;
      box-shadow:0 4px 12px rgba(255,204,0,0.3);
    }
    
    .discover-header{
      position:relative;
    }
    /* Kompakte Standort-Pill (44-48px) - zentriert */
    .discover-location-pill{
      display:flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:24px;
      background:rgba(0,0,0,.04); border:1px solid rgba(0,0,0,.08);
      height:44px; box-sizing:border-box;
      max-width:280px; width:100%;
    }
    .discover-location-icon-left{
      width:18px; height:18px; flex-shrink:0; opacity:.7;
      color:#666;
    }
    .discover-location-input{
      flex:1; border:none; background:transparent;
      font-size:15px; font-weight:500; color:#333;
      outline:none; min-width:0;
    }
    .discover-location-input::placeholder{
      color:#999; font-weight:400;
    }
    .discover-location-btn{
      width:32px; height:32px; border-radius:50%;
      border:none; background:transparent;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; transition:background .2s;
      flex-shrink:0;
    }
    .discover-location-btn:hover{
      background:rgba(0,0,0,.05);
    }
    .discover-location-btn i{
      width:18px; height:18px; color:#666;
    }
    
    /* Filter-Leiste: Kategorien (schmal, dezent, farbige Icons) - Fixiert oben */
    .discover-categories-wrapper{
      padding:6px 0 8px;
      border-top:1px solid rgba(0,0,0,.04);
      max-width:980px; margin:0 auto;
      position:sticky;
      top:0;
      background:#fff;
      z-index:50;
      box-shadow:0 2px 8px rgba(0,0,0,0.02);
    }
    .discover-categories-scroll{
      display:flex; gap:6px; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding:0 10px; scrollbar-width:none;
    }
    .discover-categories-scroll::-webkit-scrollbar{display:none}
    .discover-category-chip{
      flex:0 0 auto; padding:6px 12px;
      height:32px; border-radius:16px; border:1px solid rgba(0,0,0,.08);
      font-size:12px; font-weight:600;
      display:flex; align-items:center; gap:6px;
      background:#f8f8f8; color:#333;
      cursor:pointer; transition:all 0.2s ease;
      background:#f1f5f9; color:#64748b;
      cursor:pointer; transition:all .2s;
      white-space:nowrap;
      display:flex; align-items:center; justify-content:center; gap:3px;
    }
    .discover-category-chip i{
      width:12px; height:12px; flex-shrink:0;
      opacity:0.7;
    }
    .discover-category-chip span{
      font-size:11px;
    }
    .discover-category-chip.active{
      background:var(--brand); color:#000;
      border-color:var(--brand);
      font-weight:900;
      box-shadow:0 2px 6px rgba(255,204,0,.3);
    }
    .discover-category-chip:not(.active){
      border-color:rgba(0,0,0,.08);
      background:#f1f5f9;
    }
    .discover-category-chip:active{
      transform:scale(.96);
    }
    /* S25 / Applike: Thumb-Zone, große Touch-Ziele (min 44–48px) */
    #v-discover .discover-header-pills{
      display:flex; gap:10px; overflow-x:auto; -webkit-overflow-scrolling:touch; scroll-snap-type:x mandatory;
      padding:8px 16px 12px; scrollbar-width:none;
    }
    #v-discover .discover-header-pills::-webkit-scrollbar{ display:none; }
    #v-discover .discover-header-pills .discover-category-chip{
      flex:0 0 auto; scroll-snap-align:center; min-height:44px; min-width:auto;
      background:#e5e7eb; color:#64748b; border:none; padding:10px 18px; border-radius:22px; font-size:14px; font-weight:700;
      cursor:pointer; transition:transform 0.15s, background 0.2s; -webkit-tap-highlight-color:transparent;
    }
    #v-discover .discover-header-pills .discover-category-chip:active{ transform:scale(0.96); }
    #v-discover .discover-header-pills .discover-category-chip.active{
      background:#2563eb; color:#fff; box-shadow:0 2px 12px rgba(37,99,235,0.4);
    }
    #v-discover #discoverDaysBar{ display:flex; gap:8px; overflow-x:auto; -webkit-overflow-scrolling:touch; padding:0 16px 4px; scrollbar-width:none; }
    #v-discover #discoverDaysBar::-webkit-scrollbar{ display:none; }
    #v-discover #discoverDaysBar .cust-chip{ min-height:44px; min-width:65px; width:65px; padding:10px 8px; font-size:13px; border-radius:20px; flex:0 0 65px; box-sizing:border-box; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    #v-discover .cust-card{ width:95%; margin:10px auto; margin-bottom:0; -webkit-tap-highlight-color:transparent; transition:transform 0.15s, box-shadow 0.2s; }
    #v-discover .cust-card:active{ transform:scale(0.99); box-shadow:0 2px 12px rgba(0,0,0,0.06); }
    /* Discovery: Restaurant-Karte (Anbieter-Block) + Tiles darunter */
    #v-discover .discover-restaurant-card{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; margin:0 0 12px 0; border-radius:16px;
      background:#fff; border:1px solid rgba(0,0,0,0.06); box-shadow:0 2px 12px rgba(0,0,0,0.06);
      cursor:pointer; -webkit-tap-highlight-color:transparent; transition:transform 0.15s, box-shadow 0.2s;
    }
    #v-discover .discover-restaurant-card:active{ transform:scale(0.99); }
    #v-discover .discover-restaurant-card .restaurant-name{ font-size:16px; font-weight:800; color:#1a1a1a; }
    #v-discover .discover-restaurant-card .restaurant-meta{ font-size:12px; color:#64748b; font-weight:600; margin-top:2px; }
    #v-discover .discover-tiles-grid{
      display:grid; grid-template-columns:1fr; gap:12px; margin-bottom:20px; padding:0 0 8px;
    }
    #v-discover .discover-tiles-grid .cust-card{ width:100%; margin:0; }
    #v-discover .discover-block{ margin-bottom:24px; }
    #v-discover .status-container{ display:flex; gap:6px; margin-top:8px; flex-wrap:nowrap; overflow-x:auto; }
    .discover-radius-row{ position:relative; }
    .discover-radius-pill{
      display:inline-flex; align-items:center; justify-content:center; min-height:48px; min-width:48px; padding:10px 16px;
      border-radius:24px; border:1px solid #e5e7eb; background:#fff; color:#1a1a1a; font-size:14px; font-weight:700;
      cursor:pointer; -webkit-tap-highlight-color:transparent;
    }
    .discover-radius-opt{
      display:block; width:100%; min-height:48px; padding:14px 18px; border:none; background:none; text-align:left;
      font-size:15px; font-weight:600; color:#1a1a1a; cursor:pointer; border-radius:12px;
    }
    .discover-radius-opt:hover{ background:#f1f3f5; }
    .discover-radius-opt:active{ background:#e5e7eb; }
    /* Switch-Button: Thumb-Zone unten Mitte (S25) */
    .discover-view-switch{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:calc(76px + env(safe-area-inset-bottom, 24px));
      min-height:56px; padding:14px 24px; display:flex; align-items:center; justify-content:center; gap:10px;
      background:#fff; border:2px solid #e5e7eb; border-radius:28px;
      font-size:16px; font-weight:800; color:#1a1a1a; cursor:pointer;
      box-shadow:0 6px 24px rgba(0,0,0,0.12); z-index:90;
      transition:transform 0.15s, box-shadow 0.2s; -webkit-tap-highlight-color:transparent;
    }
    .discover-view-switch:active{ transform:translateX(-50%) scale(0.97); box-shadow:0 2px 12px rgba(0,0,0,0.1); }
    /* Karte: Pins mit großem Touch-Ziel (S25), mind. 56px */
    .discover-map-canvas .discover-pin{
      position:absolute; display:flex; flex-direction:column; align-items:center; justify-content:center;
      min-width:56px; min-height:56px; padding:12px; box-sizing:border-box; cursor:pointer;
      transform:translate(-50%,-100%); filter:drop-shadow(0 2px 10px rgba(0,0,0,0.2));
      -webkit-tap-highlight-color:transparent;
    }
    .discover-map-canvas .discover-pin-emoji{ font-size:28px; margin-bottom:4px; line-height:1; }
    .discover-map-canvas .discover-pin-price{
      background:#fff; padding:6px 12px; border-radius:14px; font-size:14px; font-weight:800; color:#1a1a1a;
      border:2px solid #2563eb; white-space:nowrap;
    }
    /* Pin-Drawer: Applike Slide-Up + Backdrop (S25) */
    .discover-pin-drawer{
      transition:transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
      will-change:transform;
    }
    .discover-pin-drawer:not(.open){ transform:translateY(100%); pointer-events:none; }
    .discover-pin-drawer.open{ transform:translateY(0); pointer-events:auto; }
    #discoverPinDrawerBackdrop{
      transition:opacity 0.3s ease, visibility 0.3s;
    }
    #discoverPinDrawerBackdrop.open{ opacity:1; visibility:visible; }
    #discoverPinDrawerBackdrop:not(.open){ opacity:0; visibility:hidden; pointer-events:none; }
    
    /* Kalender (horizontal swipebar, ohne Überschrift, distinct style) */
    .discover-calendar{
      padding:0 0 14px;
      max-width:980px; margin:0 auto;
      border-top:1px solid rgba(0,0,0,.06);
      margin-top:4px;
      padding-top:10px;
    }
    .discover-calendar-scroll{
      display:flex; gap:6px; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding:0 10px; scrollbar-width:none;
    }
    .discover-calendar-scroll::-webkit-scrollbar{display:none}
    .discover-day{
      flex:0 0 auto; padding:8px 14px;
      border-radius:16px; border:1.5px solid rgba(0,0,0,.15);
      font-size:13px; font-weight:600;
      background:#fff; color:#666;
      cursor:pointer; transition:all .2s;
      white-space:nowrap;
      min-width:50px; text-align:center;
    }
    .discover-day.active{
      background:var(--brand); color:#000;
      border-color:var(--brand);
      box-shadow:0 2px 6px rgba(255,204,0,.25);
      font-weight:900;
    }
    .discover-day:active{
      transform:scale(.96);
    }
    
    /* Quick-Filter Pill (große Kapsel) */
    .discover-quick-filter-pill{
      transition:all 0.2s ease;
    }
    .discover-quick-filter-pill.active{
      background:var(--brand) !important;
      border-color:var(--brand) !important;
      color:#1a1a1a !important;
      font-weight:900 !important;
      box-shadow:0 2px 6px rgba(255,204,0,.3);
    }
    .discover-quick-filter-pill:active{
      transform:scale(.96);
    }
    
    /* Navigation: "Zur Liste wechseln" Button (sticky) */
    .discover-list-toggle-row{
      position:sticky; top:0; z-index:50;
      padding:8px 10px; background:rgba(255,255,255,0.95);
      backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px);
      border-bottom:1px solid rgba(0,0,0,.06);
      box-shadow:0 2px 8px rgba(0,0,0,.05);
      transition:box-shadow 0.2s ease;
    }
    .discover-list-toggle-row.scrolled{
      box-shadow:0 4px 12px rgba(0,0,0,.1);
    }
    .btn-list-toggle{
      width:100%; padding:12px 20px; border-radius:999px;
      border:1px solid rgba(0,0,0,.1); background:#fff;
      font-size:14px; font-weight:600; color:#333;
      cursor:pointer; transition:all 0.2s ease;
      display:flex; align-items:center; justify-content:center; gap:8px;
      box-shadow:0 2px 6px rgba(0,0,0,.08);
    }
    .btn-list-toggle:hover{
      background:#f8f8f8; transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(0,0,0,.12);
    }
    .btn-list-toggle:active{
      transform:translateY(0);
      box-shadow:0 2px 4px rgba(0,0,0,.1);
    }
    .btn-list-toggle i{
      width:18px; height:18px;
    }
    
    /* Angebots-Liste Container (kompakt, vertikal) */
    .discover-offers{
      max-width:980px; margin:0 auto; padding:12px 10px;
      display:flex; flex-direction:column; gap:6px;
      box-sizing:border-box;
    }
    /* Polaroid-Karten: Zufällige Rotation für natürlichen Look */
    .card.polaroid{
      transform:rotate(0deg);
      transition:transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card.polaroid:nth-child(3n+1){
      transform:rotate(-1deg);
    }
    .card.polaroid:nth-child(3n+2){
      transform:rotate(0.8deg);
    }
    .card.polaroid:nth-child(3n+3){
      transform:rotate(-0.5deg);
    }
    .card.polaroid:hover{
      transform:rotate(0deg) scale(1.03);
      box-shadow:0 6px 20px rgba(0,0,0,0.15), 0 4px 10px rgba(0,0,0,0.1);
      z-index:10;
    }
    /* Kompakte Horizontale Gericht-Karte (Slim-Card) - High Performance */
    /* Entscheidungs-Kacheln (2x2 Grid) */
    .decision-tiles-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      padding: 16px;
    }
    
    @media (min-width: 640px) {
      .decision-tiles-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }
    }
    
    @media (min-width: 1024px) {
      .decision-tiles-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
      }
    }
    
    .dish-card {
      display: flex;
      min-height: 88px;
      max-height: 100px;
      padding: 8px;
      background: #ffffff;
      border-radius: 14px;
      overflow: visible;
      border: 1px solid rgba(0,0,0,0.05);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      margin-bottom: 6px; /* Abstand zwischen Karten */
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
      max-width: 100%;
      box-sizing: border-box;
      width: 100%; /* Volle Breite für vertikale Liste */
    }
    .dish-card:active {
      transform: scale(0.98);
    }
    .dish-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    /* Linke Seite: Bild - Kompakt als Thumbnail (max. 100px quadratisch) */
    .dish-image-box {
      width: 100px;
      min-width: 100px;
      height: 100px;
      max-width: 100px;
      max-height: 100px;
      flex-shrink: 0;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border-radius: 12px;
    }
    .dish-image-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
    }
    /* Rechte Seite: Details (kompakt, ohne extra Padding) */
    .dish-details {
      flex: 1;
      padding: 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-width: 0;
    }
    /* Obere Zeile: Name & Preis */
    .dish-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
    }
    .dish-name {
      font-size: 20px; /* Erhöht für bessere Lesbarkeit */
      font-weight: 900; /* Kräftiger */
      color: #111;
      line-height: 1.3; /* Verbesserter Zeilenabstand */
      margin: 0;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Montserrat', 'Segoe UI', sans-serif;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    /* Favoriten Grid-Kachel: Basis (Jiggle + relative für X-Button) */
    .fav-grid-card {
      position: relative;
      background: #fff !important;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    /* Jiggle-Effekt: Leichtes, dauerhaftes Wackeln (Rotation ±1.2°) */
    @keyframes jiggle {
      0%, 100% {
        transform: rotate(-1.2deg);
      }
      25% {
        transform: rotate(1.2deg);
      }
      50% {
        transform: rotate(-1.2deg);
      }
      75% {
        transform: rotate(1.2deg);
      }
    }
    
    /* Jiggle-Animation nur auf .fav-grid-card anwenden */
    .fav-grid-card {
      animation: fadeIn 0.3s ease-out, jiggle 3s ease-in-out infinite;
    }
    
    /* Exit-Animation: Kachel skaliert auf 0 und verschwindet, andere rücken flüssig nach */
    @keyframes removeCard {
      0% {
        opacity: 1;
        transform: scale(1) rotate(0deg);
      }
      100% {
        opacity: 0;
        transform: scale(0) rotate(0deg);
      }
    }
    
    .fav-grid-card.removing {
      animation: removeCard 0.25s ease-out forwards;
    }
    
    /* Skeleton Loading Animation (Pulse) */
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    .skeleton-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    .skeleton-bg {
      background-color: #e2e8f0; /* slate-200 */
    }
    .skeleton-bg-light {
      background-color: #f1f5f9; /* slate-100 */
    }
    
    /* Favoriten-Icon Bounce */
    @keyframes favBounce {
      0%, 100% { transform: scale(1); }
      25% { transform: scale(1.3); }
      50% { transform: scale(0.9); }
      75% { transform: scale(1.15); }
    }
    .fav-icon-bounce {
      animation: favBounce 0.5s ease-out;
    }
    @keyframes cartIconGlow {
      0%, 100% { filter: brightness(1); transform: scale(1); }
      50% { filter: brightness(1.4); transform: scale(1.15); }
    }
    .cart-icon-glow {
      animation: cartIconGlow 0.5s ease-out;
    }
    /* Flug-Animation: Thumbnail fliegt in die Mittagsbox */
    .fly-thumbnail {
      position: fixed;
      z-index: 10001;
      pointer-events: none;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    }
    .fly-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    
    /* Favoriten-Grid: Radikale Verkleinerung S25/iPhone – 4 Kacheln ohne Scroll */
    #v-fav #favDishes.fav-dishes-grid,
    #v-fav #favDishes {
      display: grid !important;
      grid-template-columns: 1fr 1fr !important;
      gap: 12px !important;
      padding: 0 16px !important;
      max-width: 100%;
    }
    #v-fav .fav-grid-card {
      height: 100%;
      min-height: 220px !important;
      max-height: none;
      max-width: 170px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      border-radius: 16px !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
      border: 1px solid rgba(0,0,0,0.06);
      overflow: hidden;
    }
    #v-fav .fav-grid-card .fav-card-img-wrap {
      width: 100%;
      height: 110px !important;
      flex-shrink: 0;
      overflow: hidden;
      background: #f0f0f0;
    }
    #v-fav .fav-grid-card .fav-card-img-wrap img {
      width: 100%;
      height: 110px !important;
      object-fit: cover;
    }
    #v-fav .fav-grid-card .fav-card-body {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      padding: 6px 8px 8px;
    }
    #v-fav .fav-grid-card .fav-card-title {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 12px !important;
    }
    /* Preis-Badge Favoriten: klein & dezent (radikale Verkleinerung) */
    #v-fav .fav-card-price-sticker {
      position: absolute;
      bottom: 5px;
      right: 5px;
      padding: 2px 6px !important;
      border-radius: 4px !important;
      background: rgba(0,0,0,0.6) !important;
      font-weight: 700;
      font-size: 0.75rem !important;
      color: #fff;
      z-index: 10;
    }
    /* Säulen-Mini: nur Emojis, zentriert */
    #v-fav .saeulen-mini {
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 4px 0;
    }
    #v-fav .saeulen-mini .emoji-icon {
      font-size: 1.1rem;
      opacity: 0.5;
    }
    #v-fav .saeulen-mini .emoji-icon.active {
      opacity: 1;
    }
    #v-fav .abholnummer-highlight {
      background: var(--brand);
      padding: 2px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
    }
    /* Favoriten-Header: schlank & verspielt – "Deine Favoriten heute ⚡" */
    .fav-header-wrap {
      background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,250,240,0.96) 100%) !important;
    }
    .fav-header-title {
      font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
      font-weight: 700 !important;
      letter-spacing: 0.02em !important;
    }
    /* Share-Button: Icon ohne Rahmen, schwebt rechts neben Text */
    #btnFavShareHeader {
      border: none !important;
      background: transparent !important;
      box-shadow: none !important;
    }
    #v-fav #favContent {
      padding: 8px 8px 20px !important;
    }
    #v-fav .fav-grid-card .btn {
      min-height: 36px !important;
      font-size: 12px !important;
      border-radius: 10px !important;
    }
    /* Meins: letzte Bestellzeile ohne unteren Rand */
    #profileOrderHistoryList .profile-order-item:last-child,
    #profileOrderHistoryMore .profile-order-item:last-child {
      border-bottom: none !important;
    }
    
    /* Responsive Grid für Provider-Favoriten */
    @media (min-width: 768px) {
      #favProviders {
        grid-template-columns: repeat(auto-fill, minmax(256px, 1fr)) !important;
        gap: 20px !important;
        justify-items: center !important;
      }
    }
    @media (max-width: 480px) {
      #favProviders {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
        justify-items: center !important;
      }
    }
    
    /* Responsive Discovery-Liste: Vertikale Liste für alle Bildschirmgrößen (kompakt) */
    @media (max-width: 374px) {
      .discover-offers {
        padding: 10px 8px !important;
        gap: 5px !important;
      }
    }
    /* Provider-Layout: Optimiert für kleine Bildschirme (Samsung S25, ~360-412px) */
    @media (max-width: 420px) {
      [id^="v-provider-"]{ padding:16px 12px !important; }
      [id^="v-provider-"] h1{ font-size:26px !important; }
      [id^="v-provider-"] .panel{ padding:14px !important; border-radius:16px !important; }
      #providerStatusIndicator{ top:12px; right:12px; padding:6px 10px; }
      #providerStatusIndicator span{ font-size:11px; }
      /* KPI Cards 3er-Grid → kleinere Schrift */
      #kpiCardTagesessen, #kpiCardAbholungen, #kpiCardKochbuch{ padding:14px 10px !important; }
      #kpiCardTagesessen div:first-child, #kpiCardAbholungen div:first-child, #kpiCardKochbuch div:first-child{ font-size:26px !important; }
      /* Provider-Nav: kompakter */
      #providerNav .navbtn{ font-size:10px; padding:8px 4px; }
      #providerNav .navbtn .ico svg{ width:20px; height:20px; }
    }
    @media (max-width: 360px) {
      [id^="v-provider-"]{ padding:12px 10px !important; }
      [id^="v-provider-"] h1{ font-size:24px !important; }
      #kpiCardTagesessen div:first-child, #kpiCardAbholungen div:first-child, #kpiCardKochbuch div:first-child{ font-size:22px !important; }
    }
    @media (min-width: 768px) {
      .discover-offers {
        padding: 16px 12px !important;
        gap: 8px !important;
      }
    }
    .dish-price {
      font-size: 16px;
      font-weight: 700;
      color: #111;
      white-space: nowrap;
    }
    /* Mittlere Zeile: Anbieter */
    .dish-provider {
      font-size: 13px;
      color: #666;
      font-weight: 500;
      margin-top: 4px;
    }
    /* Untere Zeile: Meta & Buttons */
    .dish-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
    }
    .distance-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 700;
      color: #444;
      background: #f0f0f0;
      padding: 4px 10px;
      border-radius: 8px;
      white-space: nowrap;
    }
    .action-group {
      display: flex;
      gap: 8px;
    }
    .btn-icon {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: 1px solid #f0f0f0;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #111;
      transition: all 0.2s ease;
      cursor: pointer;
      flex-shrink: 0;
    }
    .btn-icon:hover {
      background: #f9f9f9;
    }
    .btn-icon.heart-btn:hover {
      color: #ff4757;
      border-color: #ffdce0;
    }
    .btn-icon.heart-btn.active {
      color: #ff4757;
      background: #ffdce0;
      border-color: #ff4757;
    }
    .discover-list-badge{
      display:inline-flex; align-items:center; gap:3px;
      padding:4px 8px; border-radius:6px;
      font-size:10px; font-weight:700;
      background:rgba(0,0,0,.05); color:#666;
    }
    .discover-list-badge .ico-inline{
      width:14px; height:14px; flex-shrink:0;
    }
    .discover-list-badge .ico-inline svg{
      width:14px; height:14px;
    }
    .discover-list-badge.code{
      background:rgba(255,204,0,.15); color:#b8860b;
    }
    .discover-list-badge.dine{
      background:rgba(31,157,85,.1); color:#1f9d55;
    }
    .discover-list-badge.pickup{
      background:rgba(0,0,0,.05); color:#666;
    }
    .discover-list-actions{
      margin-top:auto; padding-top:8px;
    }
    .discover-list-btn{
      width:100%; padding:10px 14px; border-radius:10px;
      border:none; font-weight:900; font-size:14px;
      cursor:pointer; transition:transform .1s, background .15s;
      text-align:center; background:var(--brand); color:#111;
      display:flex; align-items:center; justify-content:center; gap:6px;
    }
    .discover-list-btn .ico-inline{
      width:18px; height:18px; flex-shrink:0;
    }
    .discover-list-btn .ico-inline svg{
      width:18px; height:18px;
    }
    .discover-list-btn:active{
      transform:scale(.97);
      background:#e6b800;
    }
    
    /* Anbieterbereich: Layout main – einheitlich #F2F2F7, kein Hintergrundbild */
    html, body{ min-height:100vh; min-height:100dvh; }
    body.provider-mode main{
      min-height:100vh; min-height:100dvh; min-height:100svh; display:block; overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch; max-width:100%; box-sizing:border-box;
      overflow-anchor:none;
      position:relative;
      background:#F2F2F7;
    }
    body.provider-mode main:has(#v-provider-home.view.active){
      overflow:hidden !important;
      height:100vh !important; height:100dvh !important; min-height:0;
    }
    body.provider-mode main:has(#v-provider-home.view.active) > #v-provider-home.view.active{
      height:100% !important; min-height:100% !important;
    }
    body.provider-mode main > *:not(#fabProviderAddOffer){ position: relative; z-index: 1; }
    body.provider-mode [id^="v-provider-"].view.active{ min-height:100vh; min-height:100dvh; display:block !important; visibility:visible !important; opacity:1 !important; scroll-margin-top:0; position:relative; width:100%; max-width:100%; overflow-x:hidden; box-sizing:border-box; }
    /* Erster Viewport sofort gefüllt: Inhalt oben verankern, keine Animation die verschiebt */
    body.provider-mode [id^="v-provider-"].view.active{ animation:none !important; transform:translateY(0) !important; }
    /* Header/Inhalt der Anbieter-Views immer sichtbar; Header = Glassmorphism */
    body.provider-mode [id^="v-provider-"].view.active .prov-header,
    body.provider-mode [id^="v-provider-"].view.active header:first-child{ visibility:visible !important; opacity:1 !important; min-height:60px; background:rgba(255,255,255,0.8) !important; backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); display:block !important; border-bottom:1px solid rgba(255,255,255,0.2) !important; }
    body.provider-mode [id^="v-provider-"].view.active#v-provider-week{ display:flex !important; flex-direction:column !important; }
    /* Meine Küche: View füllt main (height:100%), Wrap = absoluter Scroll-Bereich (immer sichtbar + scrollbar) */
    #v-provider-home.view.active{
      position:relative !important;
      height:100% !important; min-height:0 !important; max-height:100% !important;
      background:#fff;
      display:block !important;
      padding:0 !important; margin:0 !important;
      width:100%; box-sizing:border-box;
      overflow:hidden !important;
    }
    /* Dashboard: absoluter Scroll-Container – füllt die View, Inhalt immer sichtbar und scrollbar */
    #v-provider-home .dashboard-floating-wrap{
      position:absolute !important; top:0 !important; left:0 !important; right:0 !important; bottom:0 !important;
      display:flex; flex-direction:column; gap:20px;
      overflow-y:auto !important; overflow-x:hidden !important;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior-y:contain;
      min-height:0;
      padding:0 16px calc(24px + 72px + env(safe-area-inset-bottom, 0)); padding-left:max(16px, env(safe-area-inset-left, 0)); padding-right:max(16px, env(safe-area-inset-right, 0));
      padding-top:env(safe-area-inset-top, 0);
      width:100%; max-width:100%; margin:0; box-sizing:border-box;
      background:#fff;
      border-radius:0;
      box-shadow:none;
      border:none;
    }
    /* Drei Kästen (KPIs, Angebote, Wochenplan): schwebend. Header kein Kasten – schlanke Leiste. */
    #v-provider-home .dashboard-kasten{
      background:#fff;
      border-radius:24px;
      box-shadow:0 4px 24px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04);
      border:1px solid rgba(0,0,0,0.04);
      overflow:hidden;
    }
    /* Header „Meine Küche“: Layout + Stil wie Wochenplan/Kochbuch (prov-page-header) */
    #v-provider-home .dashboard-kasten-header{
      position:sticky; top:0; z-index:100;
      border-radius:0 !important;
      box-shadow:none !important;
      border:none !important;
    }
    #v-provider-home .dashboard-kasten-header.prov-page-header{
      background:rgba(255,255,255,0.8) !important;
      backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
      border-bottom:1px solid rgba(255,255,255,0.2) !important;
      padding:calc(8px + env(safe-area-inset-top, 0)) 20px 12px 20px;
    }
    #v-provider-home .dashboard-kasten-header .prov-header-inner{ padding:0; }
    #v-provider-home .dashboard-kasten-header .prov-title,
    #v-provider-home .dashboard-kasten-header .prov-page-header-title{ font-size:20px !important; font-weight:900 !important; }
    /* KPI-Kasten: Glas-Lesbarkeit (Text-Schatten) + veredelte Zahlen + Trennlinie */
    #v-provider-home .dashboard-kasten-kpis{
      padding:18px max(16px, env(safe-area-inset-left, 0)) 18px max(16px, env(safe-area-inset-right, 0));
      position:relative;
    }
    #v-provider-home .dashboard-kasten-kpis::after{
      content:''; position:absolute; left:16px; right:16px; bottom:0; height:1px;
      background:linear-gradient(to right, transparent, rgba(0,0,0,0.08), transparent);
    }
    #v-provider-home .dashboard-kasten-kpis .kpi-label{
      font-size:10px !important; font-weight:900 !important;
      color:rgba(0,0,0,0.4) !important; text-transform:uppercase;
      letter-spacing:0.12em; margin-bottom:4px !important;
    }
    #v-provider-home .dashboard-kasten-kpis [id^="dashboard"]{
      font-size:24px !important; font-weight:900 !important;
      text-shadow:0 1px 2px rgba(255,255,255,0.8);
      filter:drop-shadow(0 1px 2px rgba(0,0,0,0.06));
      transition:transform 0.15s ease;
    }
    #v-provider-home .dashboard-kasten-kpis [id^="kpi"]:active [id^="dashboard"]{
      transform:scale(1.05);
    }
    #v-provider-home .dashboard-kasten-kpis #dashboardTagesessenCount{ color:#1a1a1a !important; }
    #v-provider-home .dashboard-kasten-kpis #dashboardAbholungenCount{ color:#3b82f6 !important; }
    #v-provider-home .dashboard-kasten-kpis #dashboardUmsatzToday{ color:#16a34a !important; }
    #v-provider-home .dashboard-kasten-angebote{
      padding:14px 16px; padding-left:max(16px, env(safe-area-inset-left, 0)); padding-right:max(16px, env(safe-area-inset-right, 0));
      max-width:100%; box-sizing:border-box;
    }
    #v-provider-home .dashboard-floating-wrap{ max-width:100%; min-width:0; padding-left:max(16px, env(safe-area-inset-left, 0)); padding-right:max(16px, env(safe-area-inset-right, 0)); box-sizing:border-box; }
    #v-provider-home .dashboard-kasten-angebote .provider-week-title{ font-size:16px !important; }
    #v-provider-home .dashboard-kasten-wochenplan{
      padding:14px 16px; padding-left:max(16px, env(safe-area-inset-left, 0)); padding-right:max(16px, env(safe-area-inset-right, 0));
      padding-bottom:18px;
    }
    #v-provider-home .dashboard-kasten-wochenplan .provider-week-title{ font-size:16px !important; }
    #v-provider-home.view.active .prov-header,
    #v-provider-home.view.active .dashboard-kasten{
      position:relative; z-index:1; min-height:0; overflow:visible; flex-shrink:0;
    }
    /* Dashboard-Wrap: Block-Layout, main scrollt */
    #v-provider-home #providerActiveListingsSection{ margin-bottom:0; }
    #v-provider-home #providerActiveListingsSection .provider-week-title{ margin-bottom:12px; }
    #v-provider-home #providerActiveListings{ display:flex; flex-wrap:wrap; gap:16px; max-width:100%; min-width:0; box-sizing:border-box; }
    #v-provider-home #providerActiveListings .prov-card{ flex:1 1 min(100%, 280px); position:relative; z-index:1; cursor:pointer; pointer-events:auto; }
    #v-provider-home .prov-card img{ max-width:100%; height:auto; object-fit:cover; display:block; pointer-events:none; }
    #v-provider-home .prov-card .price-pill{ pointer-events:none; }
    #v-provider-home .prov-card > div{ max-width:100%; box-sizing:border-box; }
    /* Drei Säulen (🍴🧾🔄) direkt unter dem Bild – clean, keine Schiefertafel */
    #v-provider-home .prov-card .card-pillars{ display:flex; gap:12px; margin:0 0 12px; flex-shrink:0; }
    #v-provider-home .prov-card .card-pillars .pillar-mini{ flex-shrink:0; }
    #v-provider-home .dashboard-kasten-wochenplan .provider-week-title{ margin:0 0 16px; }
    #v-provider-home .provider-week-footer{
      padding-top:20px; padding-bottom:0;
    }
    #v-provider-home .provider-week-footer #btnProviderWeekFooter{ min-height:48px; }
    #v-provider-home .prov-stats-grid{ margin-top:12px; gap:0; }
    #v-provider-home .prov-stat-item{
      padding:12px 4px; border-right:1px solid #eee;
    }
    #v-provider-home .prov-stat-item:last-child{ border-right:none; }
    #v-provider-pickups{ min-height:100vh; min-height:100dvh; background:#f8fafc; width:100%; box-sizing:border-box; }
    #v-provider-pickups.view.active{ display:flex !important; flex-direction:column !important; height:100vh; height:100dvh; max-height:100vh; max-height:100dvh; overflow:hidden; }
    #v-provider-pickups.view.active > header{ position:relative; z-index:1; flex-shrink:0; }
    #v-provider-pickups.view.active > div{ position:relative; z-index:1; min-height:0; flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; }
    #v-provider-profile{ min-height:100vh; min-height:100dvh; width:100%; box-sizing:border-box; background:#F9FAFB !important; }
    #v-provider-profile.view.active{ display:flex !important; flex-direction:column !important; }
    #v-provider-profile.view.active > header,
    #v-provider-profile.view.active > div{ position:relative; z-index:1; min-height:0; overflow:visible; }
    /* Ebene 1: Business-Dashboard (Master-Prompt) – #22C55E, 16px Radius */
    #v-provider-profile .provider-profile-header-rebuild{ background:transparent; padding:12px 20px; padding-top:calc(12px + env(safe-area-inset-top, 0)); border-bottom:none; display:flex; align-items:center; justify-content:space-between; flex-shrink:0; }
    #v-provider-profile .provider-profile-logo{ font-size:18px; font-weight:950; letter-spacing:-0.03em; cursor:pointer; color:#1a1a1a; }
    #v-provider-profile .provider-profile-logo .logo-io{ color:#6B7280; }
    #v-provider-profile .provider-profile-gear-btn{ width:40px; height:40px; border:none; background:transparent; cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0; box-shadow:none; color:#6B7280; }
    #v-provider-profile .provider-profile-gear-btn i{ stroke:#6B7280; }
    #v-provider-profile .provider-profile-tiles-wrap{ padding:0 0 24px; }
    #v-provider-profile .provider-profile-content-rebuild{ flex:1; overflow-y:auto; padding:20px; padding-bottom:calc(100px + env(safe-area-inset-bottom)); max-width:500px; margin:0 auto; width:100%; box-sizing:border-box; }
    #v-provider-profile .provider-profile-main-rebuild{ display:flex; flex-direction:column; gap:24px; }
    #v-provider-profile .provider-focus-card{ background:#fff; border-radius:16px; overflow:hidden; box-shadow:0 1px 3px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04); }
    #v-provider-profile .provider-focus-card-inserat{ padding:0 0 20px; }
    #v-provider-profile .provider-focus-card-img-wrap{ width:100%; padding-bottom:56%; position:relative; overflow:hidden; border-radius:16px 16px 0 0; background:#f1f3f5; height:0; }
    #v-provider-profile .provider-focus-card-img-wrap img{ position:absolute; left:0; top:0; width:100%; height:100%; object-fit:cover; }
    #v-provider-profile .provider-focus-card-pillars{ display:flex; justify-content:center; align-items:center; gap:12px; padding:12px 0; font-size:20px; }
    #v-provider-profile .provider-focus-card-title{ margin:0 20px 8px; font-size:17px; font-weight:800; color:#1a1a1a; line-height:1.3; }
    #v-provider-profile .provider-focus-badge{ display:inline-block; margin:0 20px 16px; padding:4px 12px; border-radius:8px; font-size:10px; font-weight:800; text-transform:uppercase; letter-spacing:0.05em; }
    #v-provider-profile .provider-focus-badge-green{ background:#22C55E; color:#fff; }
    #v-provider-profile .provider-focus-btn{ display:block; width:calc(100% - 40px); margin:0 20px; min-height:52px; border-radius:16px; font-size:15px; font-weight:800; border:none; cursor:pointer; background:#22C55E; color:#fff; transition:transform 0.12s; }
    #v-provider-profile .provider-focus-btn:active{ transform:scale(0.98); }
    #v-provider-profile .provider-focus-card-abholnummer{ padding:24px 20px; text-align:center; }
    #v-provider-profile .provider-focus-abholnummer-number{ font-size:2.5rem; font-weight:800; font-family:ui-monospace, monospace; color:#1a1a1a; letter-spacing:0.02em; margin-bottom:8px; }
    #v-provider-profile .provider-focus-card-info{ margin:0; font-size:14px; color:#6B7280; line-height:1.45; }
    #v-provider-profile .provider-focus-card-abrechnung{ padding:20px; display:flex; align-items:center; gap:16px; cursor:pointer; transition:background 0.2s; }
    #v-provider-profile .provider-focus-card-abrechnung:active{ background:#f3f4f6; }
    #v-provider-profile .provider-focus-card-icon{ font-size:28px; }
    /* Support & Hilfe: Erste-Hilfe-Karten + Accordion + Mike [Self-Service] */
    .provider-support-page .provider-support-section-title{ margin:0 0 12px; font-size:15px; font-weight:800; color:#6B7280; text-transform:uppercase; letter-spacing:0.04em; }
    .provider-support-error-cards{ display:flex; flex-direction:column; gap:12px; margin-bottom:20px; }
    .provider-support-error-card{ display:flex; align-items:center; gap:14px; padding:16px 20px; background:#fff; border-radius:16px; border:1px solid #E5E7EB; box-shadow:0 1px 3px rgba(0,0,0,0.04); cursor:pointer; text-align:left; font-family:inherit; transition:transform 0.15s, box-shadow 0.15s; }
    .provider-support-error-card:active{ transform:scale(0.98); }
    .provider-support-error-icon{ font-size:24px; }
    .provider-support-error-label{ font-size:15px; font-weight:800; color:#1a1a1a; }
    .provider-support-solution-box{ padding:16px 20px; margin-bottom:20px; background:#F0FDF4; border-radius:16px; border:1px solid #BBF7D0; }
    .provider-support-solution-text{ margin:0 0 12px; font-size:14px; line-height:1.6; color:#166534; font-weight:600; }
    .provider-support-mail-btn{ width:100%; min-height:44px; padding:0 16px; font-size:14px; font-weight:800; color:#15803d; background:#fff; border:1px solid #22C55E; border-radius:12px; cursor:pointer; }
    .provider-support-accordion{ display:flex; flex-direction:column; gap:0; background:#fff; border-radius:16px; overflow:hidden; border:1px solid #E5E7EB; box-shadow:0 1px 3px rgba(0,0,0,0.04); margin-bottom:24px; }
    .provider-support-accordion-item{ border-bottom:1px solid #F3F4F6; }
    .provider-support-accordion-item:last-child{ border-bottom:none; }
    .provider-support-accordion-trigger{ width:100%; display:flex; align-items:center; justify-content:space-between; gap:12px; padding:16px 20px; background:transparent; border:none; font-size:15px; font-weight:700; color:#1a1a1a; cursor:pointer; text-align:left; font-family:inherit; }
    .provider-support-accordion-trigger:active{ background:#F9FAFB; }
    .provider-support-accordion .accordion-content{ max-height:0; overflow:hidden; transition:max-height 300ms ease-out, padding 300ms ease; background-color:#F9FAFB; }
    .provider-support-accordion .accordion-content.open{ max-height:500px; padding:16px 20px; border-top:1px solid #E5E7EB; }
    .provider-support-accordion .accordion-content p{ margin:0; font-size:14px; line-height:1.6; color:#6B7280; }
    .provider-support-accordion .chevron-icon{ flex-shrink:0; color:#9ca3af; transition:transform 0.3s ease; }
    .provider-support-accordion .chevron-icon.rotated{ transform:rotate(180deg); }
    .provider-support-contact-block{ margin-top:8px; }
    .provider-support-mike-btn{ width:100%; min-height:56px; border-radius:16px; font-size:16px; font-weight:800; border:none; cursor:pointer; background:#22C55E; color:#fff; display:flex; align-items:center; justify-content:center; gap:8px; transition:transform 0.12s; }
    .provider-support-mike-btn:active{ transform:scale(0.98); }
    .provider-support-mike-hint{ margin:12px 0 0; font-size:13px; color:#6B7280; line-height:1.5; text-align:center; }
    .provider-support-legal-links{ background:#fff; border-radius:16px; overflow:hidden; border:1px solid #E5E7EB; box-shadow:0 1px 3px rgba(0,0,0,0.04); margin-bottom:24px; }
    .provider-support-legal-row{ display:flex; justify-content:space-between; align-items:center; padding:16px 20px; color:#1a1a1a; font-size:15px; font-weight:700; text-decoration:none; border-bottom:1px solid #F3F4F6; transition:background 0.2s; }
    .provider-support-legal-row:last-child{ border-bottom:none; }
    .provider-support-legal-row:active{ background:#F9FAFB; }
    /* Horizontaler Slider: 7 Screens mit Snap-Effekt [cite: 2026-01-29] */
    #v-provider-profile .provider-profile-hero{ display:flex; overflow-x:auto; overflow-y:hidden; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; gap:16px; padding:16px 20px 24px; padding-left:calc(20px + env(safe-area-inset-left, 0)); padding-right:calc(20px + env(safe-area-inset-right, 0)); scrollbar-width:none; flex-shrink:0; }
    #v-provider-profile .provider-profile-hero::-webkit-scrollbar{ display:none; }
    #v-provider-profile .provider-profile-hero-slide{ flex:0 0 calc(100% - 32px); min-width:calc(100% - 32px); scroll-snap-align:start; scroll-snap-stop:always; border-radius:16px; overflow:hidden; background:#FFFFFF; box-shadow:0 1px 3px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04); display:flex; flex-direction:column; min-height:260px; box-sizing:border-box; }
    #v-provider-profile .provider-profile-hero-slide:not(:has(.provider-profile-hero-slide-img)){ padding:20px; }
    #v-provider-profile .provider-profile-hero-slide-img{ width:100%; aspect-ratio:16/10; object-fit:cover; background:#f1f3f5; }
    #v-provider-profile .provider-profile-hero-slide-body{ padding:20px; flex:1; display:flex; flex-direction:column; gap:12px; }
    #v-provider-profile .provider-profile-hero-slide-title{ margin:0; font-size:18px; font-weight:900; color:#1a1a1a; line-height:1.3; font-family:system-ui,-apple-system,sans-serif; }
    #v-provider-profile .provider-profile-hero-slide-sub{ margin:0; font-size:13px; color:#64748b; line-height:1.45; }
    #v-provider-profile .provider-profile-hero-badge{ display:inline-block; font-size:10px; font-weight:800; text-transform:uppercase; letter-spacing:0.06em; color:#64748b; margin-bottom:4px; }
    #v-provider-profile .provider-profile-hero-cta{ min-height:52px; border-radius:14px; font-size:15px; font-weight:800; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; font-family:system-ui,-apple-system,sans-serif; transition:transform 0.12s, box-shadow 0.2s; }
    #v-provider-profile .provider-profile-hero-cta:active{ transform:scale(0.98); }
    #v-provider-profile .provider-profile-hero-cta--yellow{ background:#FFD700; color:#1a1a1a; box-shadow:0 4px 16px rgba(255,215,0,0.35); }
    #v-provider-profile .provider-profile-hero-cta--emerald{ background:#10b981; color:#fff; box-shadow:0 4px 16px rgba(16,185,129,0.25); }
    #v-provider-profile .provider-profile-hero-icon-wrap{ width:56px; height:56px; border-radius:16px; background:#f1f3f5; display:flex; align-items:center; justify-content:center; font-size:28px; margin-bottom:8px; }
    #v-provider-cookbook{ min-height:100vh; min-height:100dvh; width:100%; box-sizing:border-box; }
    #v-provider-cookbook.view.active{ display:flex !important; flex-direction:column !important; height:100vh; height:100dvh; max-height:100vh; max-height:100dvh; overflow:hidden; }
    #v-provider-cookbook.view.active > header{ position:relative; z-index:1; flex-shrink:0; }
    #v-provider-cookbook.view.active > div{ position:relative; z-index:1; min-height:0; flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; }
    /* Kochbuch: gleicher Header-Stil wie Meine Küche/Abholungen (kein eigener Override) */
    #v-provider-cookbook #cookbookScrollWrap{ background:transparent; }
    #v-provider-cookbook .cookbook-category-pills{ background:transparent; }
    #v-provider-cookbook .cookbook-action-bar{ background:rgba(255,255,255,0.7) !important; backdrop-filter:blur(24px); -webkit-backdrop-filter:blur(24px); border-top:1px solid rgba(255,255,255,0.4) !important; box-shadow:0 -4px 24px rgba(0,0,0,0.06); }

    /* Wochenplan: nur auf der Wochenplan-Seite sichtbar; Layout nur wenn .active */
    #v-provider-week.view{ display:none; }
    #v-provider-week.view.active{
      display:flex !important; flex-direction:column !important; min-height:100vh; min-height:100dvh; height:100vh; height:100dvh;
      padding:0; padding-bottom:calc(80px + env(safe-area-inset-bottom, 0)); background:transparent; box-sizing:border-box;
      overflow:visible; visibility:visible !important; opacity:1 !important; position:relative;
    }
    /* Wochenplan-Header: gleicher Stil wie prov-page-header (Größen/Farben/Schriften) */
    #v-provider-week .week-header-compact{
      flex-shrink:0; min-height:56px;
      background:rgba(255,255,255,0.8) !important; backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
      border-bottom:1px solid rgba(255,255,255,0.2);
      padding:calc(8px + env(safe-area-inset-top, 0)) 20px 12px 20px;
      display:flex; flex-direction:column; justify-content:center; align-items:center; gap:2px;
    }
    #v-provider-week .week-header-compact h1,
    #v-provider-week .week-header-compact .prov-page-header-title{ margin:0; font-size:20px; font-weight:900; color:#1a1a1a; letter-spacing:-0.03em; }
    #v-provider-week .week-header-subtitle{ margin:0; font-size:12px; font-weight:600; color:#64748b; }
    #v-provider-week .week-plan-wrap{
      flex:1; min-height:0; display:flex; flex-direction:column; max-width:500px; margin:0 auto; width:100%; padding:0 20px 16px; box-sizing:border-box;
    }
    #v-provider-week .week-list-scroll{ flex:1; min-height:120px; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:8px 0 16px; }
    #v-provider-week .week-dayrow{ display:flex; flex-wrap:wrap; gap:8px; overflow-x:auto; -webkit-overflow-scrolling:touch; padding:0 0 16px; margin-bottom:16px; border-bottom:1px solid #f1f3f5; }
    #v-provider-week .week-thumb-zone{ flex-shrink:0; padding:16px 20px; padding-bottom:calc(24px + env(safe-area-inset-bottom, 0)); background:rgba(255,255,255,0.7); backdrop-filter:blur(24px); -webkit-backdrop-filter:blur(24px); border-top:1px solid rgba(255,255,255,0.4); }

    /* ============================================================
       MODERNE SMARTPHONES (S25, Galaxy S25, iPhone 15/16, Pixel 8)
       Daumenfreundlich: Touch-Ziele mind. 48px, Safe-Area, einhändig
       ============================================================ */
    @media (max-width:430px) and (min-height:700px){
      /* App: Safe-Area unten für Gestenleiste */
      .app{ padding-bottom:calc(78px + env(safe-area-inset-bottom, 20px)) !important; }
      .customer-view{ padding-bottom:calc(78px + env(safe-area-inset-bottom, 20px)) !important; }
      
      /* Bottom Nav: höher für S25-Gesten, Touch mind. 48px */
      .bottom{
        height:calc(64px + env(safe-area-inset-bottom, 20px)) !important;
        padding-bottom:env(safe-area-inset-bottom, 20px) !important;
      }
      .navbtn{
        min-height:48px; padding:10px 8px !important;
        font-size:12px !important; font-weight:600;
      }
      .navbtn .ico svg{ width:24px !important; height:24px !important; }
      
      /* Provider: kein Platz oben – Inhalt beginnt sofort (Safe-Area nur im ersten Header) */
      [id^="v-provider-"]{
        padding-top:0 !important; margin-top:0 !important;
        padding-left:calc(20px + env(safe-area-inset-left, 0)) !important;
        padding-right:calc(20px + env(safe-area-inset-right, 0)) !important;
      }
      #v-provider-home .prov-header,
      #providerProfileHeader,
      #v-provider-cookbook > header,
      #v-provider-pickups > header,
      #v-provider-week .week-header-compact{
        padding-top:calc(12px + env(safe-area-inset-top, 0)) !important;
      }
      #providerProfileHeader{ padding-bottom:10px !important; }
      #v-provider-cookbook > header{ padding-bottom:14px !important; }
      #v-provider-cookbook > header h1{ margin-bottom:12px !important; }
      #v-provider-pickups > header{ padding-bottom:14px !important; padding-left:20px !important; padding-right:20px !important; }
      #v-provider-week .week-header-compact{ background:rgba(255,255,255,0.8) !important; }
      #v-provider-week .prov-page-header{ padding-top:calc(10px + env(safe-area-inset-top, 0)) !important; }
      #v-provider-home{ padding:0 16px 0 !important; padding-top:0 !important; }
      #v-provider-home h1{ font-size:20px !important; }
      
      /* KPI Cards: 3er Grid, Touch-freundlich */
      #v-provider-home [style*="grid-template-columns:repeat(3"]{ gap:10px !important; }
      #kpiCardTagesessen, #kpiCardAbholungen, #kpiCardKochbuch{
        padding:16px 10px !important; border-radius:16px !important;
        min-height:72px; display:flex; flex-direction:column; justify-content:center;
      }
      #kpiCardTagesessen div[style*="font-size:20px"],
      #kpiCardAbholungen div[style*="font-size:32px"],
      #kpiCardKochbuch div[style*="font-size:32px"]{
        font-size:26px !important;
      }
      
      #providerTimeTracker{ padding:18px !important; }
      #providerTimeTracker div[style*="font-size:36px"]{ font-size:30px !important; }
      #providerPersonalSpar{ padding:16px !important; }
      
      #v-provider-pickups, #v-provider-cookbook, #v-provider-profile{
        padding:0 16px 100px !important;
      }
      #v-provider-cookbook{ padding-bottom:0 !important; }
      #v-provider-profile{
        padding:0 20px calc(90px + env(safe-area-inset-bottom, 0)) !important;
      }
      #v-provider-pickups h3, #v-provider-cookbook h1, #v-provider-profile h1{
        font-size:20px !important;
      }
      /* Wochenplan: nur wenn .active (nicht auf Kochbuch/anderen Seiten) */
      #v-provider-week.view{ display:none !important; }
      #v-provider-week.view.active{
        display:flex !important; flex-direction:column !important; min-height:100vh !important; min-height:100dvh !important;
        padding:0 !important; padding-bottom:calc(80px + env(safe-area-inset-bottom, 0)) !important;
        background:transparent !important;
        overflow:hidden !important; position:relative;
      }
      #v-provider-week .week-header-compact{
        flex-shrink:0; background:#fff; border-bottom:1px solid rgba(0,0,0,0.06); position:sticky; top:0; z-index:50;
        padding-top:calc(10px + env(safe-area-inset-top, 0)); padding-right:20px; padding-bottom:16px; padding-left:20px; min-height:52px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px;
      }
      #v-provider-week .week-header-compact h1,
      #v-provider-week .week-header-compact .prov-page-header-title{ margin:0; font-size:20px; font-weight:900; letter-spacing:-0.03em; color:#1a1a1a; }
      #v-provider-week .week-header-subtitle{ margin:0; font-size:12px; font-weight:600; color:#64748b; letter-spacing:0.02em; }
      #v-provider-week .week-plan-wrap{
        flex:1; display:flex; flex-direction:column; min-height:0; max-width:500px; margin:0 auto; width:100%;
        padding:0 20px 16px; box-sizing:border-box;
      }
      #v-provider-week .week-list-scroll{ flex:1; min-height:0; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:8px 0 16px; }
      #v-provider-week .week-thumb-zone{
        flex-shrink:0; padding:16px 20px; padding-bottom:calc(24px + env(safe-area-inset-bottom, 0));
        background:#fff; border-top:1px solid #e2e8f0; margin:0 -20px 0; padding-left:20px; padding-right:20px;
      }
      /* Wochenplan (weiteres Layout) */
      #v-provider-week .week-dayrow{ display:flex; flex-wrap:wrap; gap:8px; overflow-x:auto; -webkit-overflow-scrolling:touch; padding:0 0 16px; margin-bottom:16px; border-bottom:1px solid #f1f3f5; }
/* Wochenplan: Tag-Kacheln alle gleich groß */
#v-provider-week .week-day-pill{ flex:0 0 auto; width:56px; min-width:56px; height:52px; min-height:52px; padding:0 6px; border-radius:14px; border:1px solid rgba(255,255,255,0.6); background:rgba(255,255,255,0.5); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); font-size:12px; font-weight:800; color:#64748b; cursor:pointer; transition:all 0.2s; line-height:1.2; text-align:center; white-space:nowrap; display:inline-flex; align-items:center; justify-content:center; box-sizing:border-box; }
#v-provider-week .week-indicator-dot{ background:transparent; border:none; padding:4px; cursor:pointer; border-radius:50%; }
#v-provider-week .week-indicator-dot:focus{ outline:none; box-shadow:0 0 0 2px var(--prov-brand); }
    #v-provider-week .week-day-pill.active{ background:rgba(16,185,129,0.12); border-color:#10b981; color:#1a1a1a; }
    #v-provider-week .week-day-pill.week-day-pill-today{ background:rgba(255,255,255,0.6); border-color:rgba(16,185,129,0.35); font-weight:900; box-shadow:0 1px 3px rgba(0,0,0,0.06); }
    #v-provider-week .week-day-pill.week-day-pill-today.active{ border-color:#10b981; background:rgba(16,185,129,0.12); }
      #v-provider-week .week-status-block{ display:flex; justify-content:space-between; align-items:center; padding:12px 16px; min-height:48px; background:rgba(255,255,255,0.7); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px); border-radius:14px; margin-bottom:14px; border:1px solid rgba(255,255,255,0.5); box-shadow:0 1px 3px rgba(0,0,0,0.04); flex-wrap:nowrap; }
      #v-provider-week .week-status-online{ display:flex; align-items:center; gap:8px; font-weight:800; font-size:14px; color:#1a1a1a; }
      #v-provider-week .week-status-draft{ display:flex; align-items:center; gap:8px; font-weight:800; font-size:14px; color:#64748b; }
      #v-provider-week .week-status-dot{ width:10px; height:10px; border-radius:50%; }
#v-provider-week .week-meal-card-wrap{
      transition: transform 0.22s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s ease;
      border-radius: var(--card-radius-premium, 24px);
      margin-bottom: 14px;
      background: var(--glass-bg);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      box-shadow: var(--card-shadow-soft), var(--glass-inner-glow);
      border: 1px solid var(--glass-border);
    }
    #v-provider-week .week-meal-card-wrap:active{ transform: scale(0.98); box-shadow: 0 2px 12px rgba(0,0,0,0.04), var(--glass-inner-glow); }
    /* Success-Shimmer: Tag geplant/online – dezent goldener Streifen */
    #v-provider-week .week-meal-card-wrap.week-card-live::after{
      content:''; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
      background: linear-gradient(105deg, transparent 0%, rgba(255,222,0,0.08) 40%, rgba(212,168,83,0.12) 50%, rgba(255,222,0,0.08) 60%, transparent 100%);
      background-size: 200% 100%; animation: cardSuccessShimmer 2s ease-out 1;
    }
    @keyframes cardSuccessShimmer{
      0%{ background-position: 200% 0; opacity:0; }
      30%{ opacity:1; }
      100%{ background-position: -100% 0; opacity:0; }
    }
    #v-provider-week .week-meal-card{
      display:flex; align-items:center; gap:12px; padding:16px 20px;
      background: transparent; border-radius: inherit; margin-bottom:0;
      color: var(--premium-anthracite, #1a1a1a);
    }
    #v-provider-week .week-meal-name{ font-weight:900; font-size:16px; color: var(--premium-anthracite, #1a1a1a); }
    #v-provider-week .week-meal-badges{ font-size:16px !important; }
    #v-provider-week .week-meal-badges span{ font-size:1.1em; }
    /* Status-Visualisierung Wochenplan: Power-Bar (🍴🕒🧾🔄), No-Scroll, nur in der Karte [cite: Gold-Assets] */
    #v-provider-week .week-power-bar{ display:flex; align-items:center; gap:6px; margin-top:8px; font-size:18px; line-height:1; flex-wrap:nowrap; }
    #v-provider-week .week-power-bar .week-power-icon{ display:inline-flex; align-items:center; justify-content:center; min-width:28px; height:28px; border-radius:8px; transition: opacity 0.2s, box-shadow 0.2s, filter 0.2s; }
    #v-provider-week .week-power-bar .week-power-icon.week-power-icon-ok{ color:#059669; filter: drop-shadow(0 0 6px rgba(16,185,129,0.4)); }
    #v-provider-week .week-power-bar .week-power-icon.week-power-icon-muted{ opacity:0.4; filter: grayscale(0.6); }
    #v-provider-week .week-power-bar .week-power-icon.week-power-time-missing{ animation: weekTimePulse 1.5s ease-in-out infinite; opacity:0.9; color:#94a3b8; filter: drop-shadow(0 0 4px rgba(250,204,21,0.35)); }
    #v-provider-week .week-power-bar .week-power-icon.week-power-time-ok{ color:#059669; filter: drop-shadow(0 0 6px rgba(16,185,129,0.5)); }
    @keyframes weekTimePulse{ 0%,100%{ opacity:0.75; transform:scale(1); } 50%{ opacity:1; transform:scale(1.08); } }
    #v-provider-week .week-meal-card-wrap.week-card-live .week-power-bar{ box-shadow: 0 0 0 1px rgba(16,185,129,0.2), 0 2px 12px rgba(16,185,129,0.15); border-radius:12px; padding:4px 8px; margin-top:8px; }
    #v-provider-week .week-meal-card-wrap.week-card-live{ box-shadow: var(--card-shadow-soft), 0 0 0 1px rgba(16,185,129,0.12), 0 0 24px -4px rgba(16,185,129,0.2); animation: weekCardLiveGlow 2.5s ease-in-out infinite; }
    @keyframes weekCardLiveGlow{ 0%,100%{ box-shadow: var(--card-shadow-soft), 0 0 0 1px rgba(16,185,129,0.12), 0 0 24px -4px rgba(16,185,129,0.2); } 50%{ box-shadow: var(--card-shadow-soft), 0 0 0 1px rgba(16,185,129,0.2), 0 0 28px -2px rgba(16,185,129,0.28); } }
      #v-provider-week .week-meal-meta{ font-size:13px; color:#64748b; margin-top:4px; display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
      #v-provider-week .week-meal-online{ display:inline-flex; align-items:center; gap:4px; font-size:12px; font-weight:700; color:#1a1a1a; }
      #v-provider-week .week-meal-actions{ display:flex; align-items:center; gap:6px; }
      #v-provider-week .week-add-more{ width:100%; margin-top:8px; min-height:56px; padding:16px; border-radius:16px; border:none; background:var(--prov-brand); color:#1a1a1a; font-size:16px; font-weight:800; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(255,222,0,0.35); }
      #v-provider-week .week-add-more:hover{ background:#0d9668; }
      #v-provider-week .week-add-more:active{ transform:scale(0.98); }
      #v-provider-week .week-empty-state #btnWeekEmptyAdd.provider-add-plus-btn{ min-height:56px; background:var(--prov-brand); color:#1a1a1a; font-weight:800; border:none; box-shadow:0 4px 12px rgba(255,222,0,0.35); }
      #v-provider-week .week-empty-state #btnWeekEmptyAdd.provider-add-plus-btn .plus-char{ color:#fff; }
      #v-provider-week .week-empty-state{ text-align:center; padding:32px 20px; }
      #v-provider-week .week-empty-state .week-empty-title{ font-size:18px; font-weight:900; color:#1a1a1a; margin-bottom:8px; }
      #v-provider-week .week-empty-state .week-empty-hint{ font-size:14px; color:#64748b; line-height:1.5; margin-bottom:24px; }
      #v-provider-week .week-actions-bar{ display:flex; align-items:center; gap:10px; margin-top:0; padding-top:16px; padding-bottom:4px; border-top:1px solid #e2e8f0; flex-wrap:nowrap; }
    #v-provider-week .week-actions-bar .btn{ min-height:48px; flex:1; min-width:0; display:inline-flex; align-items:center; justify-content:center; gap:8px; font-size:14px; font-weight:700; border-radius:14px; }
    #v-provider-week .week-actions-bar .btn[aria-label="Aktualisieren"]{ flex:0 0 auto; min-width:48px; }
      /* S25 Thumb-Zone: Date-Picker Snap-Carousel */
      #v-provider-week .week-dayrow{ scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; }
      #v-provider-week .week-day-pill{ scroll-snap-align:center; scroll-snap-stop:always; width:56px; min-width:56px; }
      /* Wochenplan: Gericht-Kacheln einheitliche Mindesthöhe */
      #v-provider-week .week-meal-card-wrap{ position:relative; overflow:hidden; border-radius: var(--card-radius-premium, 24px); margin-bottom:14px; min-height:72px; }
      /* Swipe-Card: Premium 24px + Glass beibehalten */
      #v-provider-week .week-meal-card-swipe{ display:flex; align-items:stretch; transition:transform 0.2s ease-out; touch-action:pan-y; }
      #v-provider-week .week-meal-card-swipe .week-meal-card{ flex:1; margin-bottom:0; min-width:0; position:relative; z-index:1; background:transparent; border-radius:inherit; }
      /* Swipe-Exit: Karte gleitet sanft aus dem Bild beim Löschen/Kopieren */
      #v-provider-week .week-meal-card-wrap.week-meal-card-exit{ transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.25s ease; pointer-events:none; }
      #v-provider-week .week-meal-card-wrap.week-meal-card-exit.week-meal-card-exit-left .week-meal-card-swipe .week-meal-card{ transform: translateX(-120%); }
      #v-provider-week .week-meal-card-wrap.week-meal-card-exit.week-meal-card-exit-right .week-meal-card-swipe .week-meal-card{ transform: translateX(120%); }
      #v-provider-week .week-meal-card-wrap.week-meal-card-exit .week-meal-card-swipe .week-meal-card{ transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
      #v-provider-week .week-meal-card-wrap.week-meal-card-exit{ opacity:0; }
      #v-provider-week .week-swipe-actions{ display:flex; flex-direction:column; gap:4px; position:absolute; top:0; bottom:0; width:80px; align-items:center; justify-content:center; font-size:11px; font-weight:800; color:#fff; }
      #v-provider-week .week-swipe-actions.left{ left:0; background:#2563eb; }
      #v-provider-week .week-swipe-actions.right{ right:0; background:#ef4444; }
      /* Aktivierung: großer Button – Loading + Success-Checkmark (Premium) */
      #v-provider-week .week-activate-block{ padding:16px 0; margin-top:8px; }
      #v-provider-week .week-activate-btn{
        width:100%; min-height:56px; border-radius:18px; font-size:16px; font-weight:800; border:none;
        background: var(--prov-brand); color:#1a1a1a; cursor:pointer;
        display:flex; align-items:center; justify-content:center; gap:10px;
        box-shadow:0 4px 16px rgba(255,222,0,0.35);
        transition: background 0.3s, transform 0.2s, opacity 0.3s;
      }
      #v-provider-week .week-activate-btn:active{ transform:scale(0.98); }
      #v-provider-week .week-activate-btn.loading{ pointer-events:none; color:transparent; position:relative; }
      #v-provider-week .week-activate-btn.loading::after{
        content:''; position:absolute; width:24px; height:24px; border:3px solid rgba(255,255,255,0.3); border-top-color:#fff; border-radius:50%; animation: weekActivateSpin 0.7s linear infinite;
      }
      #v-provider-week .week-activate-btn.success{ background:#059669; pointer-events:none; }
      #v-provider-week .week-activate-btn.success .week-activate-btn-text{ opacity:0; }
      #v-provider-week .week-activate-btn.success::after{ content:''; position:absolute; width:14px; height:22px; border: solid #fff; border-width: 0 3px 3px 0; transform: rotate(45deg) scale(0); animation: weekActivateCheck 0.35s cubic-bezier(0.34,1.56,0.64,1) 0.1s forwards; margin-top: -4px; }
      @keyframes weekActivateSpin{ to{ transform: rotate(360deg); } }
      @keyframes weekActivateCheck{ to{ transform: rotate(45deg) scale(1); } }
      /* Sortiermodus: Drag-Handle, Reihenfolge ändern */
      #v-provider-week .week-sort-bar{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background:rgba(14,165,233,0.1); border-radius:14px; margin-bottom:16px; border:1px solid rgba(14,165,233,0.25); }
      #v-provider-week .week-sort-bar .week-sort-done{ min-height:44px; padding:0 18px; font-size:15px; font-weight:800; border-radius:12px; background:var(--prov-brand); color:#1a1a1a; border:none; cursor:pointer; }
      #v-provider-week .week-meal-card-wrap[draggable="true"]{ cursor:grab; }
      #v-provider-week .week-meal-card-wrap[draggable="true"]:active{ cursor:grabbing; }
      #v-provider-week .week-meal-card-wrap.week-drag-over{ box-shadow:0 0 0 2px var(--prov-brand); border-radius:16px; }
      #v-provider-week .week-meal-card-drag-handle{ width:24px; height:24px; color:#94a3b8; flex-shrink:0; margin-right:10px; }
      #v-provider-week .week-status-block .week-activate-inline{ min-height:44px; padding:0 18px; font-size:14px; font-weight:800; border-radius:12px; background:var(--prov-brand); color:#1a1a1a; border:none; cursor:pointer; box-shadow:0 2px 12px rgba(255,222,0,0.35); }
      #v-provider-week .week-status-block .week-activate-inline:active{ transform:scale(0.98); }
      #v-provider-week .week-status-activate-hint{ font-size:11px; color:#64748b; margin-top:6px; line-height:1.3; }
      /* Applike: Header mit Untertitel, Safe-Area oben; Zeile für Titel + Fertig (Edit-Mode) */
      #v-provider-week .week-header-compact{ padding:calc(8px + env(safe-area-inset-top, 0)) 20px 12px 20px; min-height:56px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px; background:rgba(255,255,255,0.8) !important; border-bottom:1px solid rgba(255,255,255,0.2); }
      #v-provider-week .week-header-row{ display:flex; align-items:center; justify-content:space-between; width:100%; max-width:100%; gap:12px; }
      #v-provider-week .week-header-row > div:first-child{ min-width:0; text-align:left; }
      #v-provider-week .week-header-done-btn{ flex-shrink:0; min-height:44px; padding:0 18px; font-size:15px; font-weight:800; border-radius:12px; background:var(--prov-brand); color:#1a1a1a; border:none; cursor:pointer; box-shadow:0 2px 12px rgba(255,222,0,0.35); }
      #v-provider-week .week-header-done-btn:active{ transform:scale(0.98); }
      #v-provider-week .week-header-compact h1,
      #v-provider-week .week-header-compact .prov-page-header-title{ margin:0; font-size:20px; font-weight:900; }
      /* Übersicht: kompakte Tageskarten (nur Lesen), app-first */
      #v-provider-week .week-overview-scroll{ flex:1; min-height:0; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:12px 20px 20px; }
      /* Wochenplan Übersicht: Tages-Kacheln einheitlich */
      #v-provider-week .week-overview-day{ background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: var(--card-radius-premium, 24px); border:1px solid rgba(255,255,255,0.6); padding:14px 16px; margin-bottom:12px; min-height:72px; box-shadow: var(--card-shadow-soft), var(--glass-inner-glow); position:relative; overflow:hidden; }
      #v-provider-week .week-overview-day.week-day-online::before{ content:''; position:absolute; inset:0; background: linear-gradient(105deg, transparent 0%, rgba(255,222,0,0.08) 45%, rgba(212,168,83,0.12) 55%, transparent 100%); background-size: 200% 100%; animation: weekSuccessShimmer 1.5s ease-out 1; pointer-events:none; }
      @keyframes weekSuccessShimmer{ 0%{ background-position: 200% 0; } 100%{ background-position: -200% 0; } }
      #v-provider-week .week-overview-day-label{ font-size:13px; font-weight:800; color:#64748b; margin-bottom:8px; display:flex; align-items:center; gap:8px; }
      #v-provider-week .week-overview-day-label .week-overview-badge{ font-size:10px; font-weight:800; padding:2px 8px; border-radius:8px; }
      #v-provider-week .week-overview-day-label .week-overview-badge.online{ background:#dcfce7; color:#166534; }
      #v-provider-week .week-overview-day-label .week-overview-badge.draft{ background:#f1f5f9; color:#64748b; }
      #v-provider-week .week-overview-dishes{ font-size:15px; font-weight:700; color:#1a1a1a; line-height:1.45; }
      #v-provider-week .week-overview-dishes.empty{ color:#94a3b8; font-weight:600; }
      #v-provider-week .week-overview-cta-wrap{ padding:16px 20px calc(24px + env(safe-area-inset-bottom)); background:#fff; border-top:1px solid #e2e8f0; flex-shrink:0; }
      /* Küchentauglich: Emerald, große Touch-Fläche */
      #v-provider-week .week-overview-cta-wrap .week-edit-primary{ width:100%; min-height:56px; border-radius:16px; font-size:17px; font-weight:800; border:none; background:var(--prov-brand); color:#1a1a1a; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; box-shadow:0 4px 16px rgba(255,222,0,0.35); }
      #v-provider-week .week-overview-cta-wrap .week-edit-primary:active{ transform:scale(0.98); }
      /* Wochen-Indikator: Status-Punkte (Grün=aktiv, Gelb=Planung, Grau=leer) */
      #v-provider-week .week-indicator-row{ display:flex; justify-content:center; gap:10px; padding:8px 0 12px; flex-wrap:wrap; }
      #v-provider-week .week-indicator-dot{ width:10px; height:10px; border-radius:50%; flex-shrink:0; border:none; padding:0; cursor:pointer; background:inherit; }
      #v-provider-week .week-indicator-dot.week-dot-active{ background:var(--prov-brand); }
      #v-provider-week .week-indicator-dot.week-dot-draft{ background:#eab308; }
      #v-provider-week .week-indicator-dot.week-dot-empty{ background:#e2e8f0; }
      /* Feiertag: dezent mit Schloss */
      #v-provider-week .week-day-pill.week-day-pill-holiday{ opacity:0.85; }
      #v-provider-week .week-day-pill.week-day-pill-holiday::after{ content:''; display:inline-block; width:12px; height:12px; margin-left:4px; background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Crect x='3' y='11' width='18' height='11' rx='2'/%3E%3Cpath d='M7 11V7a5 5 0 0110 0v4'/%3E%3C/svg%3E") no-repeat center; background-size:12px 12px; vertical-align:middle; }
      /* Master-Aktivierung: Sammel-Button */
      #v-provider-week .week-master-activate-bar{ margin-top:12px; padding:14px 16px; background:rgba(255,222,0,0.12); border:1px solid rgba(255,222,0,0.35); border-radius:14px; }
      #v-provider-week .week-master-activate-bar .week-master-btn{ width:100%; min-height:56px; border-radius:14px; font-size:16px; font-weight:800; border:none; background:var(--prov-brand); color:#1a1a1a; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; box-shadow:0 4px 12px rgba(255,222,0,0.35); }
      #v-provider-week .week-master-activate-bar .week-master-btn:active{ transform:scale(0.98); }
      #v-provider-week .week-overview-scroll{ -webkit-overflow-scrolling:touch; }
      #v-provider-week .week-overview-cta-wrap .week-edit-primary{ min-height:56px; }
      /* ========== KW-Board (High-End Wochenplan) ========== */
      #v-provider-week .kw-board-header{ padding:12px 20px 8px; padding-top:calc(12px + env(safe-area-inset-top, 0)); background:rgba(255,255,255,0.75); backdrop-filter:blur(24px); -webkit-backdrop-filter:blur(24px); border-bottom:1px solid rgba(255,255,255,0.4); flex-shrink:0; }
      #v-provider-week .kw-carousel{ display:flex; gap:10px; overflow-x:auto; -webkit-overflow-scrolling:touch; scroll-snap-type:x mandatory; padding:8px 0 12px; scrollbar-width:none; }
      #v-provider-week .kw-carousel::-webkit-scrollbar{ display:none; }
      #v-provider-week .kw-pill{ flex:0 0 auto; min-width:72px; scroll-snap-align:center; scroll-snap-stop:always; min-height:48px; padding:10px 14px; border-radius:16px; border:1px solid rgba(255,255,255,0.6); background:rgba(255,255,255,0.5); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); font-size:14px; font-weight:800; color:#64748b; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; justify-content:center; }
      #v-provider-week .kw-pill.active{ background:rgba(16,185,129,0.12); border-color:#10b981; color:#10b981; }
      #v-provider-week .kw-progress-wrap{ padding:0 20px 12px; }
      #v-provider-week .kw-progress{ height:4px; border-radius:999px; background:#e2e8f0; overflow:hidden; }
      #v-provider-week .kw-progress-fill{ height:100%; border-radius:999px; background:var(--prov-brand); transition:width 0.3s ease; }
      #v-provider-week .kw-board-scroll{ flex:1; min-height:0; overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch; padding:20px 20px calc(160px + env(safe-area-inset-bottom, 0)); }
      #v-provider-week .kw-grid{ display:grid; grid-template-columns:repeat(7, 1fr); gap:10px; max-width:100%; width:100%; margin:0 auto; box-sizing:border-box; }
      @media (max-width:640px){
        #v-provider-week .kw-grid{ grid-template-columns:1fr; gap:12px; width:100%; max-width:100%; padding:0; }
        #v-provider-week .kw-board-scroll{ padding:12px 16px calc(120px + env(safe-area-inset-bottom, 0)); padding-left:max(16px, env(safe-area-inset-left)); padding-right:max(16px, env(safe-area-inset-right)); }
        #v-provider-week .kw-day-card{ width:100%; max-width:100%; box-sizing:border-box; min-width:0; padding:12px; }
        #v-provider-week .kw-slots{ min-width:0; width:100%; box-sizing:border-box; }
        #v-provider-week .kw-slot-empty{ min-width:0; width:100%; box-sizing:border-box; }
        #v-provider-week #kwBoardWrap{ overflow-x:hidden; max-width:100%; }
        #v-provider-week .kw-board-header{ padding-left:max(16px, env(safe-area-inset-left)); padding-right:max(16px, env(safe-area-inset-right)); }
      }
      @media (max-width:768px){ #v-provider-week .kw-grid{ grid-template-columns:1fr; } }
      #v-provider-week #kwBoardWrap{ overflow-x:hidden; max-width:100%; }
      #v-provider-week .kw-day-card{ background:rgba(255,255,255,0.7); backdrop-filter:blur(24px); -webkit-backdrop-filter:blur(24px); border-radius:24px; border:1px solid rgba(255,255,255,0.5); box-shadow:0 8px 32px rgba(0,0,0,0.06), 0 0 0 1px rgba(0,0,0,0.03); padding:12px; min-height:140px; display:flex; flex-direction:column; gap:8px; transition:transform 0.2s ease, box-shadow 0.2s ease; }
      #v-provider-week .kw-day-card:active{ transform:scale(0.98); }
      #v-provider-week .kw-day-card.kw-day-has-live{ box-shadow:0 8px 32px rgba(0,0,0,0.06), 0 0 0 1px rgba(16,185,129,0.35); }
      #v-provider-week .kw-day-label{ font-size:11px; font-weight:800; color:#64748b; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:4px; }
      #v-provider-week .kw-day-date{ font-size:13px; font-weight:700; color:#1a1a1a; }
      #v-provider-week .kw-slots{ display:flex; flex-direction:column; gap:8px; flex:1; min-height:0; }
      #v-provider-week .kw-slot{ border-radius:14px; overflow:hidden; min-height:56px; position:relative; cursor:pointer; transition:background 0.2s; }
      #v-provider-week .kw-slot-main{ display:flex; gap:12px; align-items:center; padding:10px; background:rgba(255,255,255,0.6); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); border-radius:14px; border:1px solid rgba(255,255,255,0.5); min-height:80px; }
      #v-provider-week .kw-slot-main .kw-slot-thumb{ width:64px; height:64px; border-radius:14px; background:#e2e8f0; flex-shrink:0; background-size:cover; background-position:center; position:relative; }
      #v-provider-week .kw-slot-main .kw-slot-body{ flex:1; min-width:0; }
      #v-provider-week .kw-slot-main .kw-slot-name{ font-size:14px; font-weight:800; color:#1a1a1a; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
      #v-provider-week .kw-slot-main .kw-slot-price{ font-size:15px; font-weight:900; color:#1a1a1a; margin-top:2px; }
      #v-provider-week .kw-slot-override-badges{ position:absolute; top:4px; right:4px; display:flex; gap:2px; font-size:12px; }
      #v-provider-week .kw-slot-empty{ min-height:52px; border:2px dashed #e2e8f0; border-radius:14px; background:rgba(248,250,252,0.6); display:flex; align-items:center; justify-content:center; color:#cbd5e1; font-size:24px; font-weight:200; letter-spacing:0.08em; transition:color 0.2s, border-color 0.2s, background 0.2s; cursor:pointer; font-family:inherit; padding:0; margin:0; width:100%; box-sizing:border-box; -webkit-appearance:none; appearance:none; }
      #v-provider-week .kw-slot-empty:active{ color:#94a3b8; border-color:#cbd5e1; background:rgba(241,245,249,0.9); }
      #v-provider-week .kw-slot-small{ display:flex; align-items:center; gap:8px; padding:8px 10px; background:rgba(255,255,255,0.6); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); border-radius:12px; border:1px solid rgba(255,255,255,0.5); }
      #v-provider-week .kw-slot-small .kw-slot-thumb{ width:40px; height:40px; border-radius:10px; background:#e2e8f0; flex-shrink:0; background-size:cover; background-position:center; position:relative; }
      #v-provider-week .kw-slot-small .kw-slot-name{ font-size:13px; font-weight:700; color:#1a1a1a; }
      #v-provider-week .kw-slot-small .kw-slot-price{ font-size:13px; font-weight:800; color:#1a1a1a; margin-left:auto; }
      #v-provider-week .kw-slot-main .price-pill{ padding:6px 12px; font-size:15px; }
      #v-provider-week .kw-slot-small .price-pill{ padding:4px 10px; font-size:13px; }
      #v-provider-week .kw-slot-power{ margin-top:6px; font-size:14px; }
      #v-provider-week .kw-slot-power .week-power-icon{ min-width:22px; height:22px; }
      #v-provider-week .kw-slot.kw-slot-live{ box-shadow:0 0 0 1px rgba(16,185,129,0.18), 0 2px 12px rgba(16,185,129,0.14); border-radius:14px; }
      #v-provider-week .week-meal-meta .price-pill{ padding:4px 10px; font-size:13px; }
      #v-provider-week .kw-slot{ transition:transform 0.2s ease; }
      #v-provider-week .kw-slot.kw-slot-swipe-delete{ background:rgba(239,68,68,0.08); }
      #v-provider-week .kw-cookbook-drag-strip{ display:flex; flex-wrap:wrap; align-items:center; gap:8px; padding:12px 0 16px; margin-bottom:8px; border-bottom:1px solid rgba(0,0,0,0.06); }
      #v-provider-week .kw-cookbook-drag-label{ font-size:13px; font-weight:700; color:#64748b; margin-right:4px; }
      #v-provider-week .kw-cookbook-drag-pill{ padding:8px 14px; border-radius:12px; background:rgba(255,255,255,0.8); border:1px solid rgba(16,185,129,0.35); color:#0f766e; font-size:13px; font-weight:700; cursor:grab; user-select:none; transition:transform 0.15s, box-shadow 0.15s; }
      #v-provider-week .kw-cookbook-drag-pill:active{ cursor:grabbing; }
      #v-provider-week .kw-cookbook-drag-pill:hover{ box-shadow:0 2px 12px rgba(16,185,129,0.2); transform:scale(1.02); }
      #v-provider-week .kw-slot.kw-slot-drop-over,
      #v-provider-week .kw-slot-empty.kw-slot-drop-over{ box-shadow:0 0 0 2px #10b981, 0 0 20px rgba(16,185,129,0.35); border-color:#10b981; background:rgba(16,185,129,0.06); }
      /* Verschieben-Sheet (Long-Press) */
      .kw-move-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:1100; display:flex; align-items:flex-end; justify-content:center; padding:0 20px  calc(80px + env(safe-area-inset-bottom)); animation:fadeIn 0.2s ease; }
      .kw-move-sheet{ background:#fff; border-radius:24px 24px 0 0; padding:24px 20px calc(20px + env(safe-area-inset-bottom)); width:100%; max-width:400px; max-height:70vh; overflow:auto; box-shadow:0 -8px 32px rgba(0,0,0,0.12); }
      .kw-move-title{ font-size:15px; font-weight:800; color:#1a1a1a; margin-bottom:16px; }
      .kw-move-days{ display:flex; flex-direction:column; gap:8px; margin-bottom:16px; }
      .kw-move-day-btn{ width:100%; min-height:52px; padding:14px 16px; border-radius:16px; border:2px solid #e2e8f0; background:#f8fafc; font-size:15px; font-weight:700; color:#1a1a1a; cursor:pointer; text-align:left; }
      .kw-move-day-btn:active{ transform:scale(0.98); }
      .kw-move-cancel{ width:100%; min-height:52px; border-radius:16px; border:2px solid #f1f3f5; background:#fff; font-size:15px; font-weight:700; color:#64748b; cursor:pointer; }
      /* Action-Bar (Drucken & Teilen) – schlank, Silicon-Valley-Style */
      #v-provider-week .kw-action-bar-fixed{ position:fixed; bottom:calc(64px + env(safe-area-inset-bottom, 20px)); left:20px; right:20px; margin:0 auto; max-width:400px; background:rgba(255,255,255,0.88); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px); border-radius:16px; padding:10px 12px; display:flex; align-items:center; gap:12px; z-index:998; box-shadow:0 4px 24px rgba(0,0,0,0.06), 0 0 0 1px rgba(0,0,0,0.03); }
      #v-provider-week .kw-action-bar-fixed .btn{ min-height:44px; flex:1; min-width:0; border-radius:12px; font-size:14px; font-weight:600; letter-spacing:0.01em; display:inline-flex; align-items:center; justify-content:center; gap:8px; border:none; background:rgba(0,0,0,0.04); color:#1a1a1a; cursor:pointer; transition:background 0.2s, transform 0.15s; }
      #v-provider-week .kw-action-bar-fixed .btn:hover{ background:rgba(0,0,0,0.07); }
      #v-provider-week .kw-action-bar-fixed .btn:active{ transform:scale(0.97); }
      #v-provider-week .kw-action-bar-fixed .btn i{ opacity:0.9; }
      /* Nur .kw-board-scroll scrollt – View und Body ohne Scroll, kein horizontales Ziehen */
      #v-provider-week.view.active{ overflow:hidden !important; height:100vh; height:100dvh; max-height:100dvh; overflow-x:hidden !important; }
      body.provider-week-active{ overflow:hidden !important; overflow-x:hidden !important; }
      /* Wochenplan fullscreen: Topbar ausblenden, main ohne horizontales Scroll – applike */
      body.provider-week-active .topbar{ display:none !important; }
      body.provider-week-active main{ padding-top:0 !important; padding-left:0 !important; padding-right:0 !important; max-width:none !important; overflow-x:hidden !important; }
      /* Tab-Nav bleibt fix sichtbar (z-index über Action-Bar) */
      body.provider-week-active #providerNavWrap{ position:fixed !important; bottom:0 !important; left:0 !important; right:0 !important; z-index:999 !important; }
      /* Dashboard: Dein Wochenplan – klare Trennung von KPIs, App-Kasten, S25-Safe */
      #providerWeekSection .prov-card{ padding:var(--card-padding, 20px); border-radius:24px; box-shadow:0 4px 20px rgba(0,0,0,0.06); border:none; background:#fff; }
      #providerWeekSection{ margin-top:28px; padding:24px 16px 24px; padding-left:max(16px, env(safe-area-inset-left)); padding-right:max(16px, env(safe-area-inset-right)); background:#fff; border-radius:28px; box-shadow:0 4px 24px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04); }
      #providerWeekSection .provider-week-title{ margin:0 0 24px; font-size:22px; font-weight:900; color:#1a1a1a; letter-spacing:-0.02em; }
      .provider-week-footer #btnProviderWeekFooter:active{ transform:scale(0.98); box-shadow:0 1px 6px rgba(0,0,0,0.08); }
      #providerWeekDays{ display:flex; gap:10px; overflow-x:auto; -webkit-overflow-scrolling:touch; padding:4px 0 24px; margin-bottom:24px; scroll-snap-type:x mandatory; }
      /* Dashboard + Wochenplan: Tag-Pills (Mo–So) alle gleich groß */
      #providerWeekDays .week-preview-pill{ flex:0 0 auto; width:52px; min-width:52px; height:52px; min-height:52px; padding:0 6px; border-radius:32px; border:2px solid #f1f3f5; background:#fff; font-size:10px; font-weight:900; color:#64748b; cursor:pointer; transition:all 0.2s; line-height:1.2; text-align:center; white-space:pre-line; scroll-snap-align:center; scroll-snap-stop:always; display:flex; flex-direction:column; align-items:center; justify-content:center; box-sizing:border-box; }
      #providerWeekDays .week-preview-pill::after{ content:''; width:8px; height:8px; border-radius:50%; margin-top:4px; background:#e2e8f0; border:none; transition:background 0.2s; }
      #providerWeekDays .week-preview-pill.has-online::after{ background:var(--prov-brand); box-shadow:0 0 0 2px rgba(255,222,0,0.35); }
      #providerWeekDays .week-preview-pill.has-listings:not(.has-online)::after{ background:#3b82f6; border:none; }
      #providerWeekDays .week-preview-pill.active{ background:#ffde00; border-color:#ffde00; color:#1a1a1a; box-shadow:0 2px 12px rgba(255,222,0,0.4); transform:scale(1.05); }
      #providerWeekDays .week-preview-pill.active::after{ background:#3b82f6; }
      #providerWeekDays .week-preview-pill.active.has-online::after{ background:var(--prov-brand); box-shadow:0 0 0 2px rgba(255,222,0,0.35); }
      /* Wochenplan 2.2: Dashboard-Pills minimalistisch – ohne Status-Punkt, Fokus auf Karten */
      #v-provider-home #providerWeekDays .week-preview-pill::after{ display:none !important; }
      #v-provider-home #providerWeekDays .week-preview-pill{ width:52px; min-width:52px; height:52px; min-height:52px; }
      /* Wochenplan im Dashboard auf dem Handy: Pills können umbrechen (flex-wrap), horizontaler Scroll bleibt möglich */
      #v-provider-home #providerWeekDays{ flex-wrap: wrap; gap: 8px; }
      .prov-stat-hint{ display:block; font-size:11px; font-weight:600; color:#94a3b8; margin-top:2px; line-height:1.2; }
      #v-provider-home .prov-stat-item:focus-visible,
      #v-provider-home button:focus-visible{ outline:2px solid var(--prov-brand,#0ea5e9); outline-offset:2px; }
      /* Design-System: tiefes Anthrazit für Texte in Provider-Bereich */
      #v-provider-home h1, #v-provider-home h2, #v-provider-home h3,
      #v-provider-home .prov-stat-value, #v-provider-home .prov-stat-label{ color: var(--premium-anthracite, #1a1a1a); }
      .provider-cookbook-tiles{ display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; }
      @media (min-width:420px){ .provider-cookbook-tiles{ grid-template-columns:repeat(4, 1fr); } }
      @media (min-width:520px){ .provider-cookbook-tiles{ display:flex; flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch; gap:10px; padding-bottom:4px; } .provider-cookbook-tiles .cookbook-tile{ flex:0 0 auto; min-width:110px; width:110px; } }
      #providerWeekDayContent{ min-height:100px; text-align:left; padding:0; }
      #providerWeekDayContent .week-preview-dishes{ display:flex; flex-direction:column; gap:14px; }
      #providerWeekDayContent .week-preview-section-label{ font-size:10px; font-weight:900; color:#9ca3af; text-transform:uppercase; letter-spacing:0.12em; margin-bottom:12px; padding:0 4px; }
      #providerWeekDayContent .week-preview-section-label-center{ text-align:center; margin-top:20px; margin-bottom:12px; }
      #providerWeekDayContent .week-preview-dish{ background:#fff; padding:20px 20px; min-height:56px; border-radius:40px; box-shadow:0 2px 12px rgba(0,0,0,0.04); display:flex; justify-content:space-between; align-items:center; border-left:12px solid transparent; cursor:pointer; transition:transform 0.15s, box-shadow 0.15s; gap:16px; }
      #providerWeekDayContent .week-preview-dish:active{ transform:scale(0.97); }
      #providerWeekDayContent .week-preview-dish.week-preview-dish-online{ border-left-color:var(--prov-brand); }
      #providerWeekDayContent .week-preview-dish-thumb{ width:56px; height:56px; min-width:56px; min-height:56px; border-radius:50%; overflow:hidden; border:2px solid #f3f4f6; background:#f1f3f5; flex-shrink:0; }
      #providerWeekDayContent .week-preview-dish-thumb img{ width:100%; height:100%; object-fit:cover; }
      #providerWeekDayContent .week-preview-dish-sold{ background:#f8fafc; border:1px dashed #e2e8f0; border-radius:20px; padding:12px 16px; min-width:60px; text-align:center; flex-shrink:0; }
      #providerWeekDayContent .week-preview-dish-sold span:first-child{ display:block; font-size:8px; font-weight:800; color:#9ca3af; text-transform:uppercase; letter-spacing:0.05em; }
      #providerWeekDayContent .week-preview-dish-sold .week-preview-dish-sold-num{ font-size:16px; font-weight:900; color:#1a1a1a; }
      #providerWeekDayContent .week-preview-dish-online .week-preview-dish-inner{ flex:1; min-width:0; display:flex; flex-direction:column; align-items:flex-start; gap:2px; }
      #providerWeekDayContent .week-preview-dish-time{ display:none; }
      #providerWeekDayContent .week-preview-dish-online .week-preview-dish-time{ display:none; }
      #providerWeekDayContent .week-preview-dish.week-preview-dish-geplant{ opacity:0.9; background:rgba(255,255,255,0.95); border:2px dashed #e2e8f0; border-left-width:8px; border-left-color:#e2e8f0; padding:24px 20px; min-height:60px; }
      #providerWeekDayContent .week-preview-dish.week-preview-dish-geplant .week-preview-dish-name{ color:#64748b; }
      #providerWeekDayContent .week-preview-dish-name{ font-size:20px; font-weight:900; color:#1a1a1a; line-height:1.2; }
      #providerWeekDayContent .week-preview-dish-meta{ display:flex; flex-direction:column; align-items:flex-end; gap:2px; }
      #providerWeekDayContent .week-preview-dish-status{ font-size:10px; font-weight:900; text-transform:uppercase; letter-spacing:0.05em; }
      #providerWeekDayContent .week-preview-dish-status.online{ display:none; }
      #providerWeekDayContent .week-preview-dish-status.geplant{ color:#94a3b8; }
      #providerWeekDayContent .week-preview-cta{ margin-top:24px; }
      #providerWeekDayContent .week-preview-cta .btn{ width:100%; min-height:48px; border-radius:14px; font-weight:700; border:2px solid #e5e7eb; background:#fff; color:#1a1a1a; }
      #providerWeekDayContent .week-preview-link{ display:inline-flex; align-items:center; gap:6px; font-size:14px; font-weight:700; color:#1a1a1a; margin-top:20px; margin-bottom:24px; cursor:pointer; color:var(--prov-brand,#0ea5e9); padding-bottom:env(safe-area-inset-bottom, 0); }
      #providerWeekDayContent .week-preview-gap-tip{ display:flex; align-items:center; justify-content:space-between; gap:12px; background:#eff6ff; border:1px solid #bfdbfe; padding:20px; border-radius:24px; margin-top:16px; box-shadow:0 0 0 1px rgba(59,130,246,0.08), 0 4px 20px rgba(59,130,246,0.12); }
      #providerWeekDayContent .week-preview-gap-tip-inner{ display:flex; align-items:center; gap:12px; }
      #providerWeekDayContent .week-preview-gap-tip-label{ font-size:9px; font-weight:900; text-transform:uppercase; letter-spacing:0.08em; color:#3b82f6; }
      #providerWeekDayContent .week-preview-gap-tip-title{ font-size:13px; font-weight:800; color:#1a1a1a; margin-top:2px; }
      #providerWeekDayContent .week-preview-gap-tip-stats{ font-size:11px; font-weight:700; color:#1a1a1a; margin-top:4px; }
      #providerWeekDayContent .week-preview-gap-tip .week-preview-gap-tip-btn{ background:#fff; padding:8px 14px; border-radius:12px; font-size:9px; font-weight:900; text-transform:uppercase; border:none; box-shadow:0 1px 4px rgba(0,0,0,0.06); cursor:pointer; color:#1a1a1a; }
      /* Leerer Tag – Direkt-Inserieren-Trigger (Wochenplan 3.0 „Keine Ausreden“) */
      #providerWeekDayContent .week-preview-empty-trigger{ background:rgba(255,255,255,0.5); border:2px dashed #e2e8f0; border-radius:40px; padding:32px 24px; display:flex; flex-direction:column; align-items:center; text-align:center; gap:16px; cursor:pointer; transition:background 0.2s, transform 0.1s; box-shadow:0 2px 12px rgba(0,0,0,0.04); }
      #providerWeekDayContent .week-preview-empty-trigger:active{ transform:scale(0.98); background:#fff; }
      #providerWeekDayContent .week-preview-empty-trigger .week-preview-empty-label{ font-size:10px; font-weight:900; color:#9ca3af; text-transform:uppercase; letter-spacing:0.12em; margin-bottom:4px; }
      #providerWeekDayContent .week-preview-empty-trigger .week-preview-empty-cta{ font-size:16px; font-weight:900; color:#1a1a1a; }
      #v-provider-profile .panel{ padding:18px !important; border-radius:16px !important; margin-bottom:16px !important; }
      #v-provider-profile .provider-profile-section-title{ margin-top:24px; margin-bottom:12px; }
      #v-provider-profile .provider-profile-section-title:first-of-type{ margin-top:0; }
      /* Meins: einheitliche Abstände der Menüzeilen (Daten, Präferenzen, Zahlung, FAQ) */
      #v-provider-profile .provider-profile-row{
        width:100%; display:flex; align-items:center; justify-content:space-between; padding:16px 18px; background:none; border:none;
        border-bottom:1px solid #f1f3f5; font-size:15px; font-weight:700; color:#1a1a1a; text-align:left; cursor:pointer;
      }
      #v-provider-profile .provider-profile-row-last{ border-bottom:none; }
      /* App-like: Menüzeilen mit klarem Abstand, Touch-freundlich */
      #v-provider-profile .provider-profile-row{
        min-height:56px !important; padding:18px 20px !important; font-size:16px !important;
      }
      #v-provider-profile .provider-profile-row-app{
        border-bottom:1px solid #f1f3f5; transition:background 0.15s ease;
      }
      #v-provider-profile .provider-profile-row-app:active{ background:#f8f9fa !important; }
      #v-provider-profile .provider-profile-row-app.provider-profile-row-last{ border-bottom:none; }
      #v-provider-profile .provider-profile-row i[data-lucide]{ width:20px !important; height:20px !important; }
      #v-provider-profile .provider-profile-logout-btn:active{ transform:scale(0.98); opacity:0.9; }
      #v-provider-profile .provider-profile-sub{ flex:1; min-height:0; overflow:hidden; }
      #v-provider-profile .provider-profile-sub > div[style*="overflow-y:auto"]{ flex:1; min-height:0; padding-bottom:calc(24px + env(safe-area-inset-bottom, 0)); }
      #v-provider-profile .provider-profile-sub{ background:#F2F2F7 !important; }
      #v-provider-profile #providerProfileMenuCard{ background:#fff; border-radius:16px; overflow:hidden; box-shadow:0 1px 3px rgba(0,0,0,0.06); }
      /* Einstellungen (Zahnrad): wie Kundenseite – Clean Card & Spacing */
      #v-provider-profile .provider-profile-sub .provider-settings-scroll{ padding:40px 16px calc(100px + env(safe-area-inset-bottom, 0)); display:flex; flex-direction:column; gap:20px; max-width:500px; margin:0 auto; width:100%; box-sizing:border-box; }
      #v-provider-profile .provider-settings-card{ background:#fff; border-radius:24px; overflow:hidden; border:1px solid rgba(0,0,0,0.04); box-shadow:0 8px 24px rgba(0,0,0,0.03); margin-bottom:0; }
      #v-provider-profile .provider-settings-identity .plogo{ width:56px !important; height:56px !important; border-radius:18px !important; }
      #v-provider-profile .provider-settings-card .provider-time-trigger{ width:100%; padding:24px; border-radius:16px; background:#f8fafc; border:1px solid rgba(0,0,0,0.06); cursor:pointer; text-align:center; transition:background 0.2s; }
      #v-provider-profile .provider-settings-card .provider-time-trigger:active{ background:#f1f3f5; }
      #v-provider-profile .provider-settings-card .provider-time-inline{ display:flex; align-items:center; gap:12px; margin-top:16px; }
      #v-provider-profile .provider-settings-card .provider-time-inline select{ width:100%; height:48px; padding:0 12px; border:none; border-bottom:2px solid #e5e7eb; border-radius:0; font-size:16px; font-weight:700; background:transparent; color:#1a1a1a; cursor:pointer; }
      #v-provider-profile .provider-settings-card .provider-time-inline select:focus{ outline:none; border-bottom-color:var(--brand,#FFD700); }
      #v-provider-profile .provider-settings-danger-footer .provider-footer-row{ display:flex; justify-content:space-between; align-items:center; padding:18px 20px; background:#fff; border:1px solid rgba(0,0,0,0.04); border-radius:24px; margin-bottom:12px; box-shadow:0 8px 24px rgba(0,0,0,0.03); cursor:pointer; font-size:16px; font-weight:700; color:#1a1a1a; text-decoration:none; color:inherit; }
      #v-provider-profile .provider-settings-danger-footer .provider-footer-row:active{ background:#f8f9fa; }
      #v-provider-profile .provider-settings-danger-footer .provider-footer-delete{ display:block; width:100%; padding:16px; font-size:14px; font-weight:800; color:#dc2626; background:transparent; border:none; cursor:pointer; text-align:center; }
      /* Floating Label System [cite: 2026-01-29]: Label klein und grau (#6B7280) über dem Text */
      #v-provider-profile .input-group{ position:relative; margin-bottom:24px; background:#FFFFFF; padding:12px 16px; border-bottom:1px solid #E5E7EB; }
      #v-provider-profile .input-group label{ display:block; font-size:10px; font-weight:700; color:#6B7280; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:4px; }
      #v-provider-profile .input-group input{ width:100%; border:none; font-size:16px; color:#111827; padding:0; outline:none; background:transparent; }
      #v-provider-profile .input-label{ position:absolute; top:20px; left:16px; font-size:10px; font-weight:700; color:#6B7280; text-transform:uppercase; letter-spacing:0.05em; transition:all 0.2s ease; pointer-events:none; }
      #v-provider-profile .input-field:focus ~ .input-label,
      #v-provider-profile .input-field:not(:placeholder-shown) ~ .input-label,
      #v-provider-profile .input-field.floating-filled ~ .input-label{ top:12px; font-size:10px; color:#6B7280; }
      #v-provider-profile .input-field{ width:100%; border:none; outline:none; font-size:16px; background:transparent; color:#111827; box-sizing:border-box; padding:0; }
      #v-provider-profile .input-field::placeholder{ color:transparent; }
      /* Zeit-Picker: 15-Minuten-Wheel-Anzeige [cite: 2026-01-29] */
      #v-provider-profile .time-picker-display{ font-size:24px; font-weight:600; color:#22C55E; text-align:center; padding:16px; background:#F0FDF4; border-radius:12px; }
      /* iOS-Style Toggles für 3 Säulen (🍴 🔄 🧾) in Grün #22C55E [cite: 2026-01-27] */
      #v-provider-profile .provider-settings-card .toggle-switch.active .toggle-slider{ transform:translateX(32px); }
      #v-provider-profile .provider-settings-card .toggle-switch{ background:#e5e7eb; }
      #v-provider-profile .provider-settings-card .toggle-switch.active{ background:#22C55E !important; }
      
      /* Provider Bottom Nav: Safe-Area, Touch 48px */
      #providerNav{
        height:calc(64px + env(safe-area-inset-bottom, 20px)) !important;
        padding-bottom:env(safe-area-inset-bottom, 20px) !important;
      }
      #providerNav .navbtn{
        min-height:52px; padding:12px 8px !important; font-size:12px !important;
        flex:1; min-width:0; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;
      }
      #providerNav .navbtn.active{ font-weight:700; }
      #providerNav .navbtn .ico svg{ width:24px !important; height:24px !important; }
      
      /* FAB nur Dashboard: rechts */
      #fabProviderAddOffer{
        left: auto !important;
        bottom:calc(130px + env(safe-area-inset-bottom, 20px)) !important;
        right:calc(20px + env(safe-area-inset-right, 0)) !important;
        width:56px !important; height:56px !important;
        min-width:56px; min-height:56px;
      }
      #fabProviderAddOfferLabel{ right:calc(20px + env(safe-area-inset-right, 0)) !important; }
      
      /* Sheets: max-height mit Safe-Area */
      .sheet{ max-height:calc(92vh - env(safe-area-inset-bottom, 0)) !important; }
      
      /* Buttons: Mindest-Touch 48px */
      .btn, .btn-primary, .btn-secondary{
        min-height:48px !important;
      }
      
      /* S25 / Daumenfreundlich: Inseratsflow & Create-Flow */
      #wizard.sheet--kitchen .w-actions button{
        min-height:52px !important;
        padding:14px 20px !important;
      }
      #wizard.sheet--kitchen .w-actions{
        padding:18px 20px calc(20px + env(safe-area-inset-bottom, 24px)) !important;
      }
      /* Notfall-Fix: Liquid-Panel auf Mobile – ein sauberes Glas-Panel, kein abgeschnittenes Chaos */
      #wizard.sheet--kitchen.active{
        max-height: 100dvh !important;
        height: 100dvh !important;
        height: 100vh !important;
      }
      #wizard[data-flow="listing"].sheet--kitchen.active{
        height: 100vh !important;
        height: 100dvh !important;
        overflow: hidden !important;
        display: flex !important;
        flex-direction: column !important;
      }
      #wizard.sheet--kitchen .liquid-panel,
      #wizard.sheet--kitchen .listing-glass-panel,
      #wizard.sheet--kitchen .glass-express-step0{
        z-index: 9999 !important;
        min-height: 0 !important;
        max-height: none !important;
        padding: 15px !important;
        box-sizing: border-box;
      }
      #wizard[data-flow="listing"].sheet--kitchen .liquid-master-panel,
      #wizard[data-flow="listing"].sheet--kitchen .glass-express-step0{
        padding: 0 !important;
      }
      #wizard.sheet--kitchen .glass-express-step0 .inserat-scroll-area{
        padding: 0 2px;
      }
      #wizard.sheet--kitchen .glass-express-step0 .photo-header,
      #wizard.sheet--kitchen .glass-express-step0 .inserat-photo-tile.photo-header{
        height: 180px !important;
        min-height: 180px !important;
      }
      #wizard.sheet--kitchen .sheet-body.wizard-sheet-body{
        padding: 0 !important;
      }
      #wizard.sheet--kitchen .wizard-scroll{
        padding-bottom: 100px !important;
        -webkit-overflow-scrolling: touch;
      }
      /* Inseratsflow Mobile: nur Mitte scrollen, Buttons fix mit Safe-Area */
      #wizard[data-flow="listing"].sheet--kitchen .wizard-scroll{
        overflow: hidden !important;
        padding-bottom: 0 !important;
      }
      #wizard[data-flow="listing"].sheet--kitchen .glass-express-step0 .inserat-action-section{
        padding: 20px 20px calc(20px + env(safe-area-inset-bottom, 24px)) !important;
      }
      #wizard.sheet--kitchen #wContent .ans{
        min-height:48px !important;
        padding:14px 18px !important;
        min-width:0;
      }
      #wizard.sheet--kitchen #wContent .ans.ans--thumb{
        min-height:72px !important;
        min-width:72px !important;
      }
      #wizard.sheet--kitchen #wContent .answers{
        gap:10px !important;
      }
      #wizard.sheet--kitchen .field{
        min-height:48px !important;
        padding:16px 18px !important;
      }
      #wizard.sheet--kitchen .wizard-scroll{
        padding-bottom:24px !important;
      }
      #wizard[data-flow="listing"].sheet--kitchen .wizard-scroll{
        padding-bottom: 0 !important;
      }
      #wizard.sheet--kitchen .handle{
        padding:12px 0 !important;
        margin:12px auto 8px !important;
        min-height:24px !important;
      }
      #createFlowSheet.sheet--kitchen .sheet-body{
        padding:20px 20px calc(24px + env(safe-area-inset-bottom, 24px)) !important;
      }
      #createFlowSheet.sheet--kitchen .btn-create-primary,
      #createFlowSheet.sheet--kitchen .btn-create-secondary{
        min-height:56px !important;
        padding:16px 20px !important;
      }
      
      /* Kochbuch: Pills wie Kundenseite beibehalten (min-height 44px) */
      #v-provider-cookbook .cookbook-action-sheet-btn{ min-height:52px !important; }
      
      .discover-offers{ padding:14px 12px !important; gap:12px !important; }
      .card.polaroid{ border-radius:18px !important; }
    }
    
    /* Extra kleine Phones (<375px, z.B. iPhone SE) */
    @media (max-width:374px){
      #v-provider-home{ padding:0 8px 0 !important; padding-top:0 !important; }
      #v-provider-home h1{ font-size:20px !important; }
      #kpiCardTagesessen, #kpiCardAbholungen, #kpiCardKochbuch{ padding:10px 6px !important; }
      #kpiCardTagesessen div[style*="font-size:20px"],
      #kpiCardAbholungen div[style*="font-size:32px"],
      #kpiCardKochbuch div[style*="font-size:32px"]{ font-size:22px !important; }
    }
    /* Bild-Container (Discover-Karten): Quadratisch, zentriert */
    .card .img{
      width:100%; margin:0 0 12px;
      display:flex; justify-content:center; align-items:center;
      background:transparent;
      position:relative;
    }
    /* Back Navigation – einheitlich: Icon + „Zurück“ */
    .btn-back{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
    }
    .btn-back i{ width:18px; height:18px; flex-shrink:0; }
    .back-button{
      position:absolute; top:12px; left:12px;
      min-width:40px; height:40px;
      border-radius:50%; border:none;
      background:rgba(255,255,255,.9);
      backdrop-filter:blur(10px);
      display:flex; align-items:center; justify-content:center; gap:8px;
      cursor:pointer; z-index:10;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
    }
    .back-button i{
      width:20px; height:20px;
    }

    /* Chat-Bubbles Feed */
    .feed-container{
      max-width:980px; margin:0 auto; padding:0 16px 20px;
    }
    .chat-bubble{
      background:#fff; border:1px solid var(--border);
      border-radius:var(--radius); padding:16px;
      margin-bottom:16px; box-shadow:0 4px 12px rgba(0,0,0,.06);
      position:relative;
    }
    .chat-bubble-header{
      display:flex; align-items:center; gap:12px; margin-bottom:12px;
    }
    .chat-bubble-avatar{
      width:44px; height:44px; border-radius:50%;
      overflow:hidden; flex:0 0 auto;
      border:2px solid var(--border);
    }
    .chat-bubble-avatar img{
      width:100%; height:100%; object-fit:cover;
    }
    .chat-bubble-meta{
      flex:1; min-width:0;
    }
    .chat-bubble-name{
      font-weight:900; font-size:17px; margin-bottom:4px; line-height:1.3;
    }
    .chat-bubble-time{
      font-size:13px; color:var(--muted);
      display:flex; align-items:center; gap:6px; line-height:1.4;
    }
    .chat-bubble-distance{
      position:absolute; top:16px; right:16px;
      font-size:12px; font-weight:700; color:var(--muted);
      background:#f8f7f3; padding:5px 10px; border-radius:999px;
    }
    .chat-bubble-message{
      font-size:16px; line-height:1.6; color:var(--text);
      margin-bottom:14px;
    }
    .chat-bubble-image{
      width:100%; border-radius:16px; overflow:hidden;
      margin-bottom:12px; max-height:300px; object-fit:cover;
    }
    .chat-bubble-actions{
      display:flex; gap:10px; margin-top:12px;
    }
    .chat-bubble-btn{
      flex:1; padding:12px; border-radius:12px;
      border:none; font-weight:900; font-size:14px;
      cursor:pointer; transition:transform .1s;
    }
    .chat-bubble-btn:active{transform:scale(.98)}
    .chat-bubble-btn-primary{
      background:var(--brand); color:#111;
    }
    .chat-bubble-btn-secondary{
      background:#f8f7f3; border:1px solid var(--border); color:var(--text);
    }
    .feed-empty{
      max-width:980px; margin:0 auto;
    }
    
    /* Pickup Card (Theken-Ansicht 2.0) */
    .pickup-card{
      background:#fff;
      border-radius:16px;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
      position:relative;
      overflow:hidden;
      transition:all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
      cursor:pointer;
      border-left:6px solid #e5e7eb; /* Default */
      display:flex;
      flex-direction:column;
      min-height:160px;
    }
    .pickup-card:active{ transform:scale(0.96); }
    .pickup-card.status-open{ border-left-color:#FFD700; }
    .pickup-card.status-paid{ border-left-color:#2ecc71; } /* Bezahlt & Bereit */
    .pickup-card.status-done{ opacity:0.6; filter:grayscale(100%); border-left-color:#999; box-shadow:none; background:#f9f9f9; }
    
    .pickup-card-header{
      padding:16px 16px 0;
      display:flex; justify-content:space-between; align-items:flex-start;
    }
    .pickup-card-code{
      font-size:42px; font-weight:900; line-height:1; color:#1a1a1a; letter-spacing:-0.03em;
    }
    .pickup-card-time{
      font-size:13px; font-weight:700; color:#666; background:#f0f2f5; padding:4px 8px; border-radius:8px;
    }
    .pickup-card-body{
      padding:12px 16px 16px;
      flex:1; display:flex; flex-direction:column; justify-content:flex-end;
    }
    .pickup-card-dish{
      font-size:16px; font-weight:700; line-height:1.3; color:#333; margin-bottom:4px;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
    }
    .pickup-card-customer{
      font-size:13px; color:#888; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .pickup-card-badge{
      position:absolute; top:12px; right:12px;
      background:#2ecc71; color:#fff; font-size:11px; font-weight:800; padding:4px 8px; border-radius:6px;
      box-shadow:0 2px 6px rgba(46,204,113,0.3);
    }
    
    /* Animation für Erledigt */
    @keyframes check-pop {
      0% { transform:scale(0); opacity:0; }
      50% { transform:scale(1.2); opacity:1; }
      100% { transform:scale(1); opacity:1; }
    }
    .check-overlay{
      position:absolute; inset:0; background:rgba(46,204,113,0.9);
      display:flex; align-items:center; justify-content:center;
      opacity:0; pointer-events:none; transition:opacity 0.2s;
    }
    .pickup-card.just-done .check-overlay{ opacity:1; }
    .pickup-card.just-done .check-icon{ animation:check-pop 0.3s ease-out forwards; }
    /* Sticky Categories Bar */
    .discover-categories-sticky {
      position: sticky;
      top: 60px; /* Header height approx */
      z-index: 90;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 12px 16px;
      overflow-x: auto;
      white-space: nowrap;
      display: flex;
      gap: 10px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      margin-bottom: 16px;
      scrollbar-width: none; /* Firefox */
    }
    .discover-categories-sticky::-webkit-scrollbar { display: none; }
    
    .cat-pill {
      padding: 8px 16px;
      border-radius: 20px;
      background: #f2f2f2;
      color: #666;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .cat-pill:active { transform: scale(0.95); }
    .cat-pill.active {
      background: #1a1a1a;
      color: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .cat-pill i { width: 16px; height: 16px; }

    /* Kalender/Day-Pills – moderner Look */
    .discover-days-sticky {
      gap: 10px;
      padding: 12px 16px;
      background: linear-gradient(180deg, rgba(255,248,240,0.98) 0%, rgba(247,246,240,0.95) 100%);
      border-bottom: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 2px 12px rgba(0,0,0,0.04);
    }
    .day-pill {
      flex-shrink: 0;
      min-width: 72px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 2px solid transparent;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      background: #fff;
      color: #64748b;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .day-pill:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 14px rgba(0,0,0,0.1);
      color: #334155;
    }
    .day-pill:active { transform: scale(0.97); }
    .day-pill.day-pill--today {
      background: linear-gradient(135deg, #FFD700 0%, #f2b705 100%);
      color: #1a1a1a;
      border-color: rgba(0,0,0,0.08);
      box-shadow: 0 4px 16px rgba(255,215,0,0.35);
    }
    .day-pill.day-pill--today:hover {
      box-shadow: 0 6px 20px rgba(255,215,0,0.45);
      transform: translateY(-2px);
    }
    .day-pill .day-pill-label { font-weight: 800; letter-spacing: -0.02em; }
    .day-pill .day-pill-date { font-size: 11px; font-weight: 600; opacity: 0.85; }

    /* Redesigned Offer Card (Modern App Style) */
    .offer-card-modern {
      background: #fff;
      border-radius: 24px;
      width: 95%;
      max-width: 95%;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
      margin-bottom: 24px;
      overflow: hidden;
      position: relative;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border: 1px solid rgba(0,0,0,0.02);
    }
    .offer-card-modern:active { transform: scale(0.98); }
    
    .ocm-image-container {
      position: relative;
      width: 100%;
      aspect-ratio: 4/3;
      background: #f0f0f0;
      overflow: hidden;
    }
    .ocm-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s ease;
    }
    
    .ocm-provider-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(8px);
      padding: 6px 12px 6px 6px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      font-size: 13px;
      font-weight: 700;
      color: #333;
      z-index: 2;
    }
    .ocm-provider-logo {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #eee;
      object-fit: cover;
    }
    
    .ocm-like-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      color: #333;
      z-index: 2;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .ocm-like-btn:active { transform: scale(0.8); }
    .ocm-like-btn.active { color: #e74c3c; fill: #e74c3c; }
    
    .ocm-price-tag {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: #1a1a1a;
      color: #fff;
      padding: 8px 14px;
      border-radius: 16px;
      font-weight: 800;
      font-size: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .ocm-content { padding: 16px 20px 20px; }
    .ocm-title {
      font-size: 18px;
      font-weight: 800;
      color: #1a1a1a;
      margin: 0 0 8px;
      line-height: 1.3;
    }
    .ocm-meta {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(0,0,0,0.05);
      font-size: 13px;
      color: #666;
      font-weight: 500;
    }
    .ocm-meta-item { display: flex; align-items: center; gap: 6px; }
    .ocm-meta-item i { width: 16px; height: 16px; color: #999; }
    /* Silicon-Valley Pills: dezente Pop-Animation beim Laden */
    .ocm-pills-row {
      animation: ocmPillPop 0.35s ease-out;
    }
    @keyframes ocmPillPop {
      from { opacity: 0; transform: scale(0.96); }
      to { opacity: 1; transform: scale(1); }
    }

    /* App-like Transitions & Feedback */
    .view {
      display: none;
      opacity: 0;
    }
    .view.active {
      display: block;
      opacity: 1;
      animation: viewIn 0.2s ease-out forwards;
    }
    .view.active#v-pickup-code {
      display: flex !important;
    }
    /* Applike: Wochenplan ohne Verschieben – nur Einblendung */
    #v-provider-week.active { animation: viewInFade 0.2s ease-out forwards; }
    @keyframes viewInFade { from { opacity: 0; } to { opacity: 1; } }
    @keyframes viewIn {
      from { transform: translateY(6px); }
      to { transform: translateY(0); }
    }
    
    /* Global Button Feedback */
    button:active, .btn:active, .btn-primary:active, .cat-pill:active, .day-pill:active, .ocm-like-btn:active, .chip:active {
      transform: scale(0.96) !important;
    }
    button, .btn, .btn-primary, .cat-pill, .day-pill, .ocm-like-btn, .chip {
      transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.2s, box-shadow 0.2s;
    }
    /* --- MODERN CUSTOMER UI --- */
    .customer-view {
      background: var(--bg);
      min-height: 100vh;
    }
    /* Meins, Mittagsbox, Favoriten: Inhaltsbereich füllt Viewport – kein Leerraum beim Runterscrollen */
    #v-profile > div:last-child,
    #v-cart > div:last-child,
    #v-fav > div:last-child {
      min-height: calc(100vh - 60px);
      box-sizing: border-box;
    }

    /* Modern Sticky Header */
    .cust-header-sticky {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: saturate(180%) blur(20px);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      border-bottom: 1px solid rgba(0,0,0,0.05);
      padding-top: env(safe-area-inset-top, 0px);
      padding-left: env(safe-area-inset-left, 0);
      padding-right: env(safe-area-inset-right, 0);
    }
    /* Kunde: Anbieter-Profil (Restaurant-Seite) – app-like, nicht gequetscht, S25-tauglich */
    #v-provider-detail-public {
      display: flex !important;
      flex-direction: column !important;
      min-height: 100vh;
      min-height: 100dvh;
      background: #f8f9fa !important;
    }
    #v-provider-detail-public .pub-prov-scroll {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 20px 16px calc(24px + env(safe-area-inset-bottom, 0));
    }
    #v-provider-detail-public .cust-header-sticky {
      flex-shrink: 0;
      background: #fff;
    }
    #v-provider-detail-public .pub-prov-back-btn,
    #v-provider-detail-public .pub-prov-fav-btn {
      min-width: 48px;
      min-height: 48px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    #v-provider-detail-public .pub-prov-back-btn:active,
    #v-provider-detail-public .pub-prov-fav-btn:active {
      transform: scale(0.96);
    }
    #v-provider-detail-public .pub-prov-hero {
      border: 1px solid rgba(0,0,0,0.04);
    }
    #v-provider-detail-public .pub-prov-section-title {
      font-size: 13px;
      font-weight: 800;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin: 0 0 14px;
    }
    #v-provider-detail-public .pub-prov-empty {
      text-align: center;
      padding: 28px 20px;
      font-size: 15px;
      font-weight: 600;
      color: #94a3b8;
      line-height: 1.5;
    }
    #v-provider-detail-public .pub-prov-offer-card {
      min-height: 56px;
      transition: transform 0.2s ease;
    }
    #v-provider-detail-public .pub-prov-offer-card:active {
      transform: scale(0.98);
    }
    #v-provider-detail-public .pub-prov-hero button:active {
      transform: scale(0.98);
    }
    @media (max-width: 430px) and (min-height: 700px) {
      #v-provider-detail-public .pub-prov-header-row { padding: 16px 16px !important; }
      #v-provider-detail-public .pub-prov-back-btn,
      #v-provider-detail-public .pub-prov-fav-btn { min-width: 52px; min-height: 52px; }
      #v-provider-detail-public #pubProvName { font-size: 20px !important; }
      #v-provider-detail-public .pub-prov-hero { padding: 28px 20px !important; }
      #v-provider-detail-public .pub-prov-scroll { padding: 20px 16px calc(28px + env(safe-area-inset-bottom, 0)) !important; }
      #v-provider-detail-public #pubProvTitle { font-size: 22px !important; }
      #v-provider-detail-public #pubProvAddress { font-size: 14px !important; }
    }

    /* Discovery Card - Modernized */
    .cust-card {
      background: #fff;
      border-radius: 24px;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.04);
      box-shadow: 0 8px 24px rgba(0,0,0,0.03);
      transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s;
      display: flex;
      flex-direction: column;
      margin-bottom: 16px;
    }
    .cust-card:active {
      transform: scale(0.97);
      box-shadow: 0 4px 12px rgba(0,0,0,0.02);
    }

    .cust-card-img {
      width: 100%;
      aspect-ratio: 16/10;
      object-fit: cover;
      background: #f1f3f5;
    }

    .cust-card-body {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .cust-card-title {
      font-size: 18px;
      font-weight: 850;
      color: #1a1a1a;
      letter-spacing: -0.02em;
      margin: 0;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .cust-card-meta {
      font-size: 13px;
      font-weight: 600;
      color: #64748b;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .cust-card-price {
      font-size: 16px;
      font-weight: 800;
      margin-top: 8px;
    }
    .cust-card-price.price-pill { margin-left: auto; }

    /* Favorites Grid (Strict 2x2 per FAVORITEN_LAYOUT_REGEL: gap 12px, border-radius 16px) */
    .fav-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      padding: 0 16px;
    }

    .fav-card {
      background: #fff;
      border-radius: 20px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(0,0,0,0.04);
      box-shadow: 0 4px 12px rgba(0,0,0,0.02);
      height: 100%; /* Homogene Höhe */
    }

    .fav-card-img {
      width: 100%;
      aspect-ratio: 1/1; /* Quadratisch laut Spec */
      object-fit: cover;
    }

    /* Segmented Control / Chips */
    .cust-chip-bar {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 12px 16px;
      scrollbar-width: none;
    }
    .cust-chip-bar::-webkit-scrollbar { display: none; }

    .cust-chip {
      flex: 0 0 auto;
      padding: 8px 16px;
      border-radius: 14px;
      background: #fff;
      border: 1px solid rgba(0,0,0,0.05);
      font-size: 14px;
      font-weight: 700;
      color: #64748b;
      transition: all 0.2s;
    }
    .cust-chip.active {
      background: #1a1a1a;
      color: #fff;
      border-color: #1a1a1a;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* Bottom Navigation Modernization */
    .bottom-nav {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: saturate(180%) blur(20px);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      border-top: 1px solid rgba(0,0,0,0.05);
      height: calc(70px + env(safe-area-inset-bottom, 0px));
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }

    .nav-item i {
      transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .nav-item.active i {
      transform: translateY(-2px) scale(1.1);
      color: var(--brand);
    }

    /* 3 Pillars in Card – kreisförmige Standard-Icons (Grün, Petrol, Gelb) direkt unter dem Bild */
    .card-pillars {
      display: flex;
      gap: 12px;
      margin-top: 12px;
      align-items: center;
    }
    .pillar-mini {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      background: #f1f3f5;
      opacity: 0.45;
      filter: grayscale(1);
    }
    .pillar-mini.active { opacity: 1; filter: grayscale(0); }
    .pillar-mini.active.green { background: rgba(39, 174, 96, 0.2); color: #27AE60; }
    .pillar-mini.active.yellow { background: rgba(255, 215, 0, 0.35); color: #1a1a1a; }
    .pillar-mini.active.petrol { background: rgba(13, 148, 136, 0.2); color: #0d9488; }
    /* Preis: systemweit gelbe Pill-Darstellung */
    .price-pill {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 999px;
      background: #FFD700;
      color: #1a1a1a;
      font-weight: 800;
      font-size: 16px;
      box-shadow: 0 2px 8px rgba(255, 215, 0, 0.25);
    }

    /* Button Refinement – fancy, klar, ein Haupt-CTA */
    .btn-cust-primary {
      height: 56px;
      min-height: 56px;
      border-radius: 18px;
      background: var(--brand);
      color: #1a1a1a;
      border: none;
      font-weight: 850;
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 8px 24px rgba(255, 215, 0, 0.28);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
    }
    .btn-cust-primary:hover {
      box-shadow: 0 12px 32px rgba(255, 215, 0, 0.35);
      transform: translateY(-1px);
    }
    .btn-cust-primary:active { transform: scale(0.97); }
    .btn-cust-primary:focus-visible {
      outline: 2px solid #1a1a1a;
      outline-offset: 2px;
    }

    /* --- END MODERN CUSTOMER UI --- */
  </style>
</head>
<body>
<div class="app" id="app">
  <div class="topbar" id="topbar">
      <div class="topbar-inner">
        <!-- View-Toggle wurde in den discover-header verschoben -->
      <div class="spacer"></div>
    </div>
  </div>

  <main>
    <!-- Öffentliche Wochenplan-Ansicht (Magic Link): #/plan/[Anbieter-ID] – Read-Only, 3 Säulen, nur Verkaufspreis -->
    <section class="view" id="v-plan-public" style="display:none; min-height:100vh; background:#f8fafc; padding:0 0 env(safe-area-inset-bottom, 0);">
      <header style="background:#fff; border-bottom:1px solid rgba(0,0,0,0.06); padding:16px 20px; position:sticky; top:0; z-index:50;">
        <div style="display:flex; align-items:center; gap:12px;">
          <div id="planPublicLogo" style="width:48px; height:48px; border-radius:14px; background:#f1f3f5; background-size:cover; background-position:center;"></div>
          <div>
            <h1 id="planPublicName" style="margin:0; font-size:20px; font-weight:900; color:#1a1a1a; letter-spacing:-0.02em;">Wochenplan</h1>
            <p style="margin:2px 0 0; font-size:13px; color:#64748b; font-weight:600;">Unser Wochenplan ist online!</p>
          </div>
        </div>
        <a href="#" id="planPublicBack" style="display:inline-flex; align-items:center; gap:6px; margin-top:16px; font-size:14px; font-weight:700; color:var(--brand,#FFD700); text-decoration:none;">← Zur App</a>
      </header>
      <div id="planPublicList" style="max-width:500px; margin:0 auto; padding:20px 16px 24px;"></div>
    </section>

    <!-- CUSTOMER: Discover - App-like UX (Final Spec) -->
    <section class="view customer-view active" id="v-discover">
      <!-- Modern Sticky Header (Standort + Filter stapeln, bleiben beim Scrollen fixiert) -->
      <header class="cust-header-sticky discover-header-sticky">
        <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px; gap:12px;">
          <div style="flex:1; min-width:0;"></div>
          <!-- Standort in der Mitte -->
          <div style="display:flex; align-items:center; gap:8px; min-width:0; justify-content:center; flex:0 1 auto;">
            <button type="button" id="btnDiscoverLocationGPS" aria-label="Standort per GPS" style="display:flex; align-items:center; justify-content:center; width:40px; height:40px; border-radius:12px; border:none; background:#f1f3f5; color:#1a1a1a; cursor:pointer; flex-shrink:0;">
              <i data-lucide="map-pin" style="width:20px;height:20px;"></i>
            </button>
            <button type="button" id="btnDiscoverLocationText" style="display:flex; flex-direction:column; background:none; border:none; padding:0; cursor:pointer; min-width:0; text-align:center;">
              <span style="font-size:11px; font-weight:800; color:#64748b; text-transform:uppercase; letter-spacing:0.05em;">Dein Standort</span>
              <span id="discoverCurrentLocation" style="font-size:15px; font-weight:700; color:#1a1a1a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Standort wählen...</span>
            </button>
          </div>
          <div style="flex:1; display:flex; align-items:center; justify-content:flex-end;">
            <span style="font-family:'Montserrat',sans-serif; font-weight:900; font-size:18px; color:#1a1a1a; letter-spacing:-0.03em;">mittagio</span>
          </div>
        </div>

        <!-- Standort-Dropdown (Bleibt funktional gleich, nur Design-Update) -->
        <div id="discoverLocationExpanded" style="display:none; position:fixed; z-index:99999; background:#fff; border-radius:24px; box-shadow:0 20px 40px rgba(0,0,0,0.15); border:1px solid rgba(0,0,0,0.05); overflow:hidden; min-width:300px; max-width:calc(100vw - 32px); top:80px; left:16px;">
          <div style="padding:24px;">
            <h3 style="margin:0 0 16px; font-size:18px; font-weight:850; letter-spacing:-0.02em;">Wo suchst du?</h3>
            <button type="button" id="discoverLocationBtnNadel" class="btn-cust-primary" style="width:100%; height:56px; border-radius:16px; margin-bottom:16px;">
              <i data-lucide="navigation" style="width:20px;height:20px;"></i>
              <span>Aktueller Standort</span>
            </button>
            <div style="font-size:12px; font-weight:700; color:#94a3b8; text-align:center; margin-bottom:16px; display:flex; align-items:center; gap:10px;">
              <div style="flex:1; height:1px; background:#f1f3f5;"></div><span>ODER</span><div style="flex:1; height:1px; background:#f1f3f5;"></div>
            </div>
            <input type="text" id="discoverLocationInput" placeholder="PLZ oder Stadt..." style="width:100%; height:52px; padding:0 16px; border-radius:14px; border:2px solid #f1f3f5; font-size:16px; background:#f8f9fa; color:#1a1a1a; outline:none; transition:border-color 0.2s; box-sizing:border-box;" />
            <div id="discoverLocationSuggestions" style="max-height:200px; overflow-y:auto; margin-top:8px;"></div>
            <button type="button" id="discoverLocationClose" style="margin-top:16px; width:100%; height:44px; background:none; border:none; font-size:14px; font-weight:700; color:#64748b; cursor:pointer;">Abbrechen</button>
          </div>
        </div>

        <!-- Sticky Bars: Kategorie-Pills (Eintopf, Vesper, Vegetarisch, Snack) + Hunger-Radius -->
        <div id="discoverCategoriesBar" class="discover-header-pills cust-chip-bar" style="padding-top:0; padding-bottom:8px;">
          <!-- Dynamisch: [ 🍲 Eintopf ] [ 🥩 Vesper ] [ 🥗 Vegetarisch ] [ 🥪 Snack ] -->
        </div>
        <div class="discover-radius-row" style="display:flex; align-items:center; gap:8px; padding:6px 16px 10px; flex-wrap:wrap;">
          <button type="button" id="discoverRadiusBtn" class="discover-radius-pill" aria-label="Hunger-Radius">
            <span id="discoverRadiusIcon">📍</span>
            <span id="discoverRadiusLabel">500m</span>
            <i data-lucide="chevron-down" id="discoverRadiusChevron" style="width:14px;height:14px;margin-left:2px;"></i>
          </button>
          <div id="discoverRadiusDropdown" style="display:none; position:absolute; top:100%; left:16px; margin-top:4px; background:#fff; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.12); border:1px solid rgba(0,0,0,0.06); z-index:100; min-width:120px; padding:6px;">
            <button type="button" data-radius="500" class="discover-radius-opt">500m</button>
            <button type="button" data-radius="1000" class="discover-radius-opt">1 km</button>
            <button type="button" data-radius="3000" class="discover-radius-opt">3 km</button>
            <button type="button" data-radius="5000" class="discover-radius-opt">5 km</button>
          </div>
        </div>
        <div id="discoverDaysBar" class="cust-chip-bar discover-calendar-sticky" style="padding-top:4px; padding-bottom:8px;">
          <!-- Dynamisch befüllt -->
        </div>
      </header>

      <!-- Listenansicht ("Speisekarte") + Karten-Container (Overlay) – S25 Safe-Area -->
      <main class="discover-main" style="position:relative; padding:16px; padding-bottom:calc(160px + env(safe-area-inset-bottom, 0));">
        <div id="discoverOffers" class="discover-offers-list" style="display:flex; flex-direction:column; gap:12px; padding:0 0 8px;">
          <!-- Dynamisch befüllt -->
        </div>

        <!-- Kartenansicht (Hunger-Radar) – Pins mit Preis + Emoji, Tap = Drawer -->
        <div id="discoverMap" class="discover-map-wrap" style="display:none; position:absolute; inset:0; top:0; bottom:80px; padding:16px; padding-bottom:100px;">
          <div id="discoverMapCanvas" class="discover-map-canvas" style="width:100%; height:100%; background:linear-gradient(180deg, #e8f4f8 0%, #f0f7fa 100%); border-radius:20px; position:relative; overflow:hidden;">
            <!-- Pins werden dynamisch eingefügt -->
          </div>
        </div>

        <!-- Pin-Drawer: Applike Bottom-Sheet (Slide-Up), Bild + 3 Säulen -->
        <div id="discoverPinDrawer" class="discover-pin-drawer" style="position:fixed; left:0; right:0; bottom:0; visibility:hidden; background:#fff; border-radius:24px 24px 0 0; box-shadow:0 -8px 32px rgba(0,0,0,0.18); z-index:200; padding:16px 20px calc(20px + env(safe-area-inset-bottom)); max-height:55vh; overflow-y:auto;">
          <div class="discover-pin-drawer-handle" style="width:44px; height:5px; background:#d1d5db; border-radius:3px; margin:0 auto 16px;"></div>
          <div id="discoverPinDrawerImageWrap" style="width:100%; height:180px; border-radius:16px; background:#f1f3f5; overflow:hidden;"><img id="discoverPinDrawerImage" alt="" style="width:100%; height:100%; object-fit:cover;"></div>
          <div id="discoverPinDrawerTitle" style="font-size:20px; font-weight:800; margin:14px 0 10px;"></div>
          <div id="discoverPinDrawerPillars" class="card-pillars" style="display:flex; gap:14px; margin-bottom:16px;"></div>
          <button type="button" class="btn-cust-primary" id="discoverPinDrawerBtn" style="width:100%; min-height:56px; border-radius:16px; font-size:16px; font-weight:800;">Gericht ansehen</button>
        </div>
        <div id="discoverPinDrawerBackdrop" style="position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:199; opacity:0; visibility:hidden;" onclick="closeDiscoverPinDrawer()"></div>

        <!-- Leerer Feed (Empty State): kein weißer Schirm – freundliche Ansage + Standort ändern -->
        <div id="discoverEmpty" style="display:none; text-align:center; padding:48px 24px 60px;">
          <div style="width:160px; height:160px; margin:0 auto 24px; border-radius:24px; overflow:hidden; box-shadow:0 8px 32px rgba(0,0,0,0.08); background:#f8f9fa;">
            <img src="https://images.unsplash.com/photo-1546069901-ba9599a7e63c?auto=format&amp;fit=crop&amp;w=400&amp;q=80" alt="" style="width:100%; height:100%; object-fit:cover;" loading="lazy" />
          </div>
          <h2 style="font-size:22px; font-weight:850; margin:0 0 12px; color:#1a1a1a; letter-spacing:-0.02em;">Hunger?</h2>
          <p style="font-size:15px; color:#64748b; line-height:1.6; margin-bottom:28px; max-width:320px; margin-left:auto; margin-right:auto;">Momentan gibt es keine aktiven Angebote in deiner Nähe. Schau später nochmal vorbei oder ändere deinen Standort.</p>
          <button class="btn-cust-primary" type="button" onclick="openDiscoverLocationSearch();" style="width:100%; max-width:280px; margin:0 auto;">
            <i data-lucide="map-pin" style="width:20px;height:20px;"></i>
            <span>Standort ändern</span>
          </button>
        </div>

        <!-- Switch-Button: unten Mitte – [ 🗺️ Karte ] in Liste, [ ☰ Liste ] in Karte -->
        <button type="button" id="discoverViewSwitchBtn" class="discover-view-switch" aria-label="Ansicht wechseln">
          <span id="discoverViewSwitchIcon">🗺️</span>
          <span id="discoverViewSwitchLabel">Karte</span>
        </button>
      </main>
    </section>

    <!-- Provider-Billing: einheitlich helles Layout -->
    <section class="view" id="v-provider-billing" style="min-height:100vh; padding:20px; padding-bottom:90px;">
      <div class="provider-header-bar">
        <h1>Finanzen & Abrechnung</h1>
        <button id="btnBillingBack" class="btn-back" type="button">
          <i data-lucide="chevron-left" style="width:24px; height:24px;"></i> Zurück
        </button>
      </div>

      <!-- Karte 1: Meine Kontodaten -->
      <div class="panel" id="billingCardKontodaten" style="border-radius:16px; padding:24px; margin-bottom:20px; box-shadow:0 2px 12px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04);">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
          <span style="font-size:15px; font-weight:700; color:#1a1a1a;">Meine Kontodaten</span>
          <span id="billingKontodatenStatus" style="font-size:12px; font-weight:700; padding:6px 12px; border-radius:20px; background:rgba(34,197,94,0.15); color:#16a34a;">Hinterlegt</span>
        </div>
        <div style="background:#f8f7f2; border-radius:12px; padding:16px 20px; margin-bottom:16px; border:1px solid rgba(0,0,0,0.06);">
          <div style="font-size:14px; color:#64748b; margin-bottom:4px;">Kartenvorschau</div>
          <div id="billingKartenvorschau" style="font-size:18px; font-weight:700; color:#1a1a1a; letter-spacing:2px;">•••• •••• •••• 1234</div>
        </div>
        <button type="button" id="btnBillingZahlungsmittel" style="width:100%; padding:14px; border-radius:12px; border:2px solid rgba(0,0,0,0.1); background:#fff; color:#0A84FF; font-weight:700; font-size:15px; cursor:pointer;">Zahlungsmittel ändern</button>
      </div>

      <!-- Karte 2: Tagesabrechnungen (Live-Umsatz heute) -->
      <div class="panel" id="billingCardTagesabrechnungen" style="border-radius:16px; padding:24px; margin-bottom:20px; box-shadow:0 2px 12px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04); background:#fff;">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
          <span style="font-size:15px; font-weight:700; color:#1a1a1a;">Tagesumsatz (heute)</span>
          <span id="billingTodayRevenue" style="font-size:18px; font-weight:950; color:#16a34a;">0,00 €</span>
        </div>
        <div id="billingTodayList" style="display:flex; flex-direction:column; gap:8px;">
          <!-- Heute verkaufte Abholnummern -->
        </div>
        <div id="billingTodayEmpty" class="hint" style="color:#64748b; text-align:center; padding:16px 0; display:none;">Noch keine Umsätze heute.</div>
      </div>

      <!-- Karte 3: Meine Abrechnungen -->
      <div class="panel" style="border-radius:16px; padding:24px; box-shadow:0 2px 12px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04);">
        <div style="font-size:15px; font-weight:700; color:#1a1a1a; margin-bottom:16px;">Meine Abrechnungen</div>
        <div id="billingList" style="display:flex; flex-direction:column; gap:0;">
          <!-- Zeilen: Datum, Posten, Betrag, PDF-Icon – wird von renderBilling befüllt -->
        </div>
        <div id="billingListEmpty" class="hint" style="color:#64748b; text-align:center; padding:32px 16px; display:none;">Noch keine Abrechnungen vorhanden.</div>
      </div>
    </section>

    <!-- Admin-Dashboard: /admin – Clean, modern, KPIs, Inserats-Feed, Buchhaltung, CSV-Export -->
    <section class="view" id="v-admin" style="min-height:100vh; padding:20px; padding-bottom:90px; background:#f8f7f2;">
      <div style="max-width:900px; margin:0 auto;">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:24px;">
          <h1 style="margin:0; font-size:24px; font-weight:900; color:#1a1a1a;">Admin</h1>
          <a href="#" onclick="location.hash=''; showDiscover(); return false;" style="display:inline-flex; align-items:center; gap:6px; font-size:14px; font-weight:700; color:#64748b; text-decoration:none;"><i data-lucide="chevron-left" style="width:18px;height:18px;"></i> Zurück</a>
        </div>
        <!-- KPI-Sektion -->
        <div id="adminKpis" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; margin-bottom:24px;">
          <div style="background:#fff; border-radius:16px; padding:20px; box-shadow:0 2px 12px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04);">
            <div style="font-size:12px; font-weight:700; color:#64748b; text-transform:uppercase; margin-bottom:4px;">Tagesumsatz</div>
            <div id="adminKpiUmsatz" style="font-size:28px; font-weight:900; color:#16a34a;">0,00 €</div>
          </div>
          <div style="background:#fff; border-radius:16px; padding:20px; box-shadow:0 2px 12px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04);">
            <div style="font-size:12px; font-weight:700; color:#64748b; text-transform:uppercase; margin-bottom:4px;">Aktive Inserate</div>
            <div id="adminKpiInserate" style="font-size:28px; font-weight:900; color:#1a1a1a;">0</div>
          </div>
          <div style="background:#fff; border-radius:16px; padding:20px; box-shadow:0 2px 12px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04);">
            <div style="font-size:12px; font-weight:700; color:#64748b; text-transform:uppercase; margin-bottom:4px;">Abholnummern gebucht</div>
            <div id="adminKpiAbholnummern" style="font-size:28px; font-weight:900; color:#3b82f6;">0</div>
          </div>
        </div>
        <!-- Inserats-Feed (Live-Angebote, 3 Säulen) -->
        <div style="background:#fff; border-radius:16px; padding:20px; margin-bottom:24px; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
          <div style="font-size:15px; font-weight:800; color:#1a1a1a; margin-bottom:16px;">Inserats-Feed (Live)</div>
          <div id="adminFeedList" style="display:flex; flex-direction:column; gap:12px;"></div>
        </div>
        <!-- Buchhaltungs-Tabelle + Summenzeile + CSV -->
        <div style="background:#fff; border-radius:16px; padding:20px; margin-bottom:24px; box-shadow:0 2px 12px rgba(0,0,0,0.06); overflow-x:auto;">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
            <div style="font-size:15px; font-weight:800; color:#1a1a1a;">Buchhaltung</div>
            <button type="button" id="adminBtnCsvExport" style="padding:10px 18px; border-radius:10px; border:none; background:#FFD700; color:#1a1a1a; font-weight:800; font-size:14px; cursor:pointer;">CSV-Export</button>
          </div>
          <table style="width:100%; border-collapse:collapse; font-size:14px;">
            <thead>
              <tr style="border-bottom:2px solid #e5e7eb;">
                <th style="text-align:left; padding:12px 8px; color:#64748b; font-weight:700;">Datum</th>
                <th style="text-align:left; padding:12px 8px; color:#64748b; font-weight:700;">Anbieter</th>
                <th style="text-align:left; padding:12px 8px; color:#64748b; font-weight:700;">Inserat-ID</th>
                <th style="text-align:right; padding:12px 8px; color:#64748b; font-weight:700;">Basis (4,99 €)</th>
                <th style="text-align:right; padding:12px 8px; color:#64748b; font-weight:700;">Abholnummer (0,89 €)</th>
                <th style="text-align:right; padding:12px 8px; color:#64748b; font-weight:700;">Gesamtbetrag</th>
              </tr>
            </thead>
            <tbody id="adminTableBody"></tbody>
            <tfoot>
              <tr id="adminTableSum" style="border-top:2px solid #1a1a1a; font-weight:800; background:#f8f7f2;"></tr>
            </tfoot>
          </table>
        </div>
      </div>
    </section>

    <!-- CUSTOMER: Favorites – Fokus auf HEUTE, 2x2 Grid, Pull-to-Reveal -->
    <section class="view customer-view" id="v-fav">
      <header class="cust-header-sticky">
        <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px;">
          <h1 style="font-size:20px; font-weight:950; letter-spacing:-0.03em; color:#1a1a1a; margin:0;">Deine Favoriten ⚡</h1>
          <button type="button" id="btnFavShareHeader" aria-label="Teilen" style="width:40px; height:40px; border-radius:12px; background:#f1f3f5; border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; color:#1a1a1a;">
            <i data-lucide="share-2" style="width:20px;height:20px;"></i>
          </button>
        </div>
      </header>

      <div style="padding-bottom:120px;">
        <!-- Empty State -->
        <div id="favEmptyState" style="display:none; flex-direction:column; align-items:center; text-align:center; padding:80px 20px;">
          <div style="width:120px; height:120px; margin-bottom:24px; background:rgba(255,215,0,0.1); border-radius:40px; display:flex; align-items:center; justify-content:center;">
            <i data-lucide="heart" style="width:48px; height:48px; color:#1a1a1a;"></i>
          </div>
          <h2 style="font-size:22px; font-weight:850; margin:0 0 12px; color:#1a1a1a; letter-spacing:-0.02em;">Deine Favoriten sind leer</h2>
          <p style="font-size:15px; color:#64748b; line-height:1.6; margin-bottom:32px; max-width:280px;">Sichere dir dein Mittagessen! Markiere Gerichte mit ❤️ – sie landen hier bei deinen Favoriten.</p>
          <button class="btn-cust-primary" type="button" onclick="showDiscover();" style="width:100%; max-width:260px; margin:0 auto; background:var(--brand); color:#1a1a1a;">
            <i data-lucide="compass" style="width:20px;height:20px;"></i>
            <span>Jetzt entdecken</span>
          </button>
        </div>
        
        <div id="favContent" style="display:none;">
          <!-- 2x2 Grid für Gerichte -->
          <div id="sectionDishesWrapper" style="padding:20px 0;">
            <h3 style="padding:0 20px; margin:0 0 16px; font-size:15px; font-weight:800; color:#64748b; text-transform:uppercase; letter-spacing:0.05em;">Gerichte in deiner Box</h3>
            <div id="favDishes" class="fav-grid">
              <!-- Dynamisch befüllt (fav-card) -->
            </div>
            
            <div id="emptyFavDishes" style="display:none; text-align:center; padding:40px 20px; margin:0 20px; background:#f8f9fa; border-radius:24px; border:2px dashed #e2e8f0;">
              <p style="font-size:14px; font-weight:700; color:#64748b; margin:0;">Noch keine Gerichte in der Box.</p>
            </div>
          </div>
          
          <!-- Trenner -->
          <div id="favProviderSeparator" style="height:32px; border-bottom:1px solid rgba(0,0,0,0.05); margin-bottom:32px;"></div>
          
          <!-- Lieblings-Anbieter -->
          <div id="sectionProvidersWrapper" style="padding:20px 0; border-top:1px solid rgba(0,0,0,0.03);">
            <h3 style="padding:0 20px; margin:0 0 16px; font-size:15px; font-weight:800; color:#64748b; text-transform:uppercase; letter-spacing:0.05em;">Deine Lieblings-Betriebe</h3>
            <div id="favProviders" style="display:flex; flex-direction:column; gap:12px; padding:0 20px;">
              <!-- Dynamisch befüllt -->
            </div>
          </div>
          
          <!-- Pull-to-Reveal: Nächste Tage erst nach Nach-unten-ziehen sichtbar -->
          <div id="favPullHint" style="display:none; text-align:center; padding:16px; margin-top:24px; font-size:13px; color:#999; font-weight:500;">
            Nach unten ziehen für Morgen &amp; Übermorgen
          </div>
          <div id="favUpcomingPreview" style="margin-top:16px; display:none; opacity:0; transition:opacity 0.3s ease;">
            <div class="section-title" style="margin-bottom:16px; font-size:18px; font-weight:800; color:#1a1a1a; padding:0 20px;">Morgen &amp; Übermorgen</div>
            <div id="favUpcomingDays" style="display:flex; flex-direction:column; gap:16px; padding:0 20px;"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- CUSTOMER: Orders (Applike: Sticky Header + Karten wie v-fav/v-cart) -->
    <section class="view customer-view" id="v-orders">
      <header class="cust-header-sticky">
        <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px;">
          <div>
            <h1 style="font-size:20px; font-weight:950; letter-spacing:-0.03em; color:#1a1a1a; margin:0;">Aktive Abholnummern</h1>
            <p style="font-size:13px; font-weight:600; color:#64748b; margin:4px 0 0;">Deine Bestellungen im Überblick</p>
          </div>
        </div>
      </header>

      <div style="padding:16px; padding-bottom:120px;">
        <div class="cust-chip-bar" id="ordersFilters" style="margin-bottom:20px; padding:0 0 12px 0;"></div>
        <!-- Empty State (sichtbar nur wenn keine Bestellungen) -->
        <div id="ordersEmptyState" style="display:flex; flex-direction:column; align-items:center; text-align:center; padding:48px 20px; background:#f8f9fa; border-radius:24px; border:2px dashed #e2e8f0;">
          <div style="width:80px; height:80px; margin-bottom:20px; background:rgba(255,215,0,0.12); border-radius:24px; display:flex; align-items:center; justify-content:center;">
            <i data-lucide="receipt" style="width:36px; height:36px; color:#1a1a1a;"></i>
          </div>
          <p style="font-size:16px; font-weight:700; color:#1a1a1a; margin:0 0 8px;">Noch keine Bestellungen</p>
          <p style="font-size:14px; color:#64748b; line-height:1.5; margin:0 0 24px;">Sichere dir dein Mittagessen in der Mittagsbox.</p>
          <button class="btn-cust-primary" type="button" onclick="showView('v-cart');" style="max-width:260px;">
            <i data-lucide="shopping-bag" style="width:18px;height:18px;"></i>
            <span>Zur Mittagsbox</span>
          </button>
        </div>
        <div id="ordersList" style="display:none;"></div>
      </div>
    </section>

    <!-- CUSTOMER: Cart -->
    <section class="view customer-view" id="v-cart">
      <header class="cust-header-sticky">
        <div style="display:flex; align-items:center; gap:10px; padding:12px 16px;">
          <i data-lucide="shopping-basket" style="width:24px;height:24px;color:#1a1a1a;flex-shrink:0;"></i>
          <h1 style="font-size:20px; font-weight:950; letter-spacing:-0.03em; color:#1a1a1a; margin:0;">Mittagsbox heute</h1>
        </div>
      </header>

      <div style="padding:16px; padding-bottom:120px; display:flex; flex-direction:column; gap:16px;">
        <!-- Aktive Abholnummern -->
        <div class="cust-card" id="cartActiveAbholnummern" style="padding:20px; border:2px dashed var(--brand); background:rgba(255,215,0,0.05); display:none;">
          <h3 style="margin:0 0 16px; font-size:16px; font-weight:850; color:#1a1a1a; display:flex; align-items:center; gap:10px;">
            <span>🧾</span> Aktive Abholnummern
          </h3>
          <div id="cartActiveAbholnummernList" style="display:flex; flex-direction:column; gap:12px;"></div>
        </div>
        
        <!-- Warenkorb Items -->
        <div class="cust-card" style="padding:20px;">
          <div id="cartBox" class="hint" style="text-align:center; padding:40px 0;">Deine Mittagsbox ist noch leer. Such dir was Leckeres aus.</div>
          
          <!-- Verzehrart -->
          <div id="cartVerzehrart" style="margin-top:20px; padding-top:20px; border-top:1px solid #f1f3f5; display:none;">
            <label style="display:block; font-weight:800; font-size:14px; margin-bottom:12px; color:#64748b; text-transform:uppercase;">Wo möchtest du essen?</label>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
              <button type="button" id="cartBtnVorOrt" class="cust-chip" style="height:48px; border-radius:14px; font-size:14px;">🍴 Vor Ort</button>
              <button type="button" id="cartBtnMitnehmen" class="cust-chip" style="height:48px; border-radius:14px; font-size:14px;">🔄 Mitnehmen</button>
            </div>
          </div>

          <button class="btn-cust-primary" id="btnCheckout" style="display:none; width:100%; margin-top:24px;">
            <span>Abholnummer sichern</span>
            <i data-lucide="arrow-right" style="width:20px;height:20px;"></i>
          </button>
        </div>

        <div id="cartTrustIcons" style="display:none; text-align:center; padding:0 20px;">
          <div style="display:inline-flex; align-items:center; gap:8px; padding:8px 16px; background:#f8f9fa; border-radius:99px; font-size:12px; font-weight:700; color:#64748b;">
            <span>🧾</span> Deine Abholnummer wird sofort generiert
          </div>
        </div>
      </div>
    </section>
    
    <!-- CUSTOMER: One-Page Checkout (Checkout-Turbo) -->
    <section class="view" id="v-checkout" style="min-height:100vh; background:var(--bg);">
      <div style="padding:16px; padding-bottom:calc(90px + env(safe-area-inset-bottom, 0px)); max-width:600px; margin:0 auto;">
        <div class="panel" style="padding:20px; border-radius:24px; box-shadow:0 4px 16px rgba(0,0,0,.08); background:rgba(255,255,255,0.95); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);">
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
            <button class="back-button btn-back" type="button" id="btnCheckoutBack" aria-label="Zurück" style="background:none; border:none; padding:8px; cursor:pointer; font-size:16px; font-weight:700; color:#2D3436;">
              <i data-lucide="chevron-left" style="width:22px;height:22px;"></i> Zurück
            </button>
            <div style="display:flex; align-items:center; gap:10px; flex:1;">
              <i data-lucide="shopping-basket" style="width:24px;height:24px;color:#2D3436;flex-shrink:0;"></i>
              <h3 style="margin:0; font-weight:900; font-size:24px; color:#2D3436;">Dein Mittagstisch</h3>
            </div>
          </div>
          
          <!-- Bestellübersicht -->
          <div id="checkoutSummary" style="margin-bottom:16px; padding:16px; background:#f8f9fa; border-radius:16px;">
            <!-- Wird dynamisch befüllt -->
          </div>
          
          <!-- Verzehrart (Vor Ort / Mitnehmen) -->
          <div id="checkoutVerzehrart" style="margin-bottom:24px;">
            <label style="display:block; font-weight:700; font-size:15px; margin-bottom:12px; color:#2D3436;">Wo möchtest du essen?</label>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
              <button type="button" id="checkoutBtnVorOrt" class="verzehrmodus-checkout-btn" data-mode="vor_ort" style="padding:14px 16px; border-radius:14px; border:2px solid #e7e1d5; background:#fff; color:#666; font-weight:600; font-size:15px; cursor:pointer; transition:all 0.2s ease;">🍴 Vor Ort</button>
              <button type="button" id="checkoutBtnMitnehmen" class="verzehrmodus-checkout-btn" data-mode="mitnehmen" style="padding:14px 16px; border-radius:14px; border:2px solid #e7e1d5; background:#fff; color:#666; font-weight:600; font-size:15px; cursor:pointer; transition:all 0.2s ease;">🔄 Mitnehmen</button>
            </div>
          </div>
          <!-- Verpackung (nur bei Mitnehmen) – Säule 3 🔄 -->
          <div id="checkoutVerpackung" style="display:none; margin-bottom:24px;">
            <label style="display:block; font-weight:700; font-size:15px; margin-bottom:12px; color:#2D3436;">Verpackung</label>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <button type="button" id="checkoutBtnEigenerBehaeltner" class="verpackung-btn" data-verpackung="eigener_behaeltner" style="padding:12px 14px; border-radius:12px; border:2px solid #e7e1d5; background:#fff; color:#666; font-weight:600; font-size:14px; cursor:pointer; transition:all 0.2s ease; text-align:center;">Eigener Behälter<br><span style="font-size:12px; font-weight:700; color:#27AE60;">0,00 €</span></button>
              <button type="button" id="checkoutBtnMehrweg" class="verpackung-btn" data-verpackung="mehrweg" style="padding:12px 14px; border-radius:12px; border:2px solid #e7e1d5; background:#fff; color:#666; font-weight:600; font-size:14px; cursor:pointer; transition:all 0.2s ease; text-align:center;">Mehrweg-System 🔄<br><span style="font-size:12px; font-weight:700; color:#64748b;">Pfand/Aufpreis</span></button>
            </div>
          </div>
          <!-- Abholzeit-Auswahl (15-Minuten-Takt) -->
          <div style="margin-bottom:24px;">
            <label style="display:block; font-weight:700; font-size:15px; margin-bottom:12px; color:#2D3436;">Wann holst du dein Essen ab?</label>
            <div id="checkoutTimeSlots" style="display:flex; flex-direction:row; flex-wrap:nowrap; overflow-x:auto; gap:10px; margin-bottom:12px; padding-bottom:8px; -webkit-overflow-scrolling:touch;">
              <!-- Wird dynamisch befüllt -->
            </div>
            <button type="button" id="btnOtherTime" class="time-chip-alternative" style="width:100%; min-height:44px; margin-top:8px; background:#f0f0f0; border:2px dashed #e7e1d5; border-radius:12px; color:#666; font-size:14px; font-weight:600; cursor:pointer; transition:all 0.2s ease; display:flex; align-items:center; justify-content:center; gap:8px;" onmouseover="this.style.borderColor='#FFD700'; this.style.background='rgba(255,215,0,0.1)'; this.style.color='#334155';" onmouseout="this.style.borderColor='#e7e1d5'; this.style.background='#f0f0f0'; this.style.color='#666';">
              <i data-lucide="clock" style="width:18px;height:18px;"></i>
              <span>🕒 Andere Zeit</span>
            </button>
            <div id="customTimeInputWrapper" style="display:none; margin-top:15px; padding:15px; background:#fff9e6; border-radius:12px; text-align:center;">
              <input type="time" id="checkoutPickupTimeCustom" min="11:00" max="14:30" style="width:100%; padding:14px; border:2px solid #FFD700; border-radius:12px; font-size:18px; font-weight:700; background:#fff; text-align:center; margin-bottom:8px;" />
              <p class="hint" style="font-size:12px; color:#666; margin:0; line-height:1.5;">Bitte zwischen 11:00 und 14:30 Uhr wählen</p>
            </div>
            <input type="hidden" id="checkoutPickupTime" value="" />
          </div>
          
          <!-- Kontaktdaten (minimal) -->
          <div style="margin-bottom:24px;">
            <label style="display:block; font-weight:700; font-size:15px; margin-bottom:12px; color:#2D3436;">Name (für Abholung)</label>
            <input type="text" id="checkoutName" placeholder="Dein Name" style="width:100%; padding:14px; border:2px solid #e7e1d5; border-radius:12px; font-size:16px; background:#fff;" />
          </div>
          
          <div style="margin-bottom:24px;">
            <label style="display:block; font-weight:700; font-size:15px; margin-bottom:12px; color:#2D3436;">E-Mail (optional, für Beleg)</label>
            <input type="email" id="checkoutEmail" placeholder="email@beispiel.de" style="width:100%; padding:14px; border:2px solid #e7e1d5; border-radius:12px; font-size:16px; background:#fff;" />
          </div>
          
          <!-- Zahlungsmethoden -->
          <div style="margin-bottom:24px;">
            <label style="display:block; font-weight:700; font-size:15px; margin-bottom:12px; color:#2D3436;">Zahlungsart</label>
            <div id="checkoutPaymentMethods" style="display:flex; flex-direction:column; gap:12px;">
              <!-- Apple Pay / Google Pay Buttons (wenn verfügbar) -->
              <button class="btn" type="button" id="btnApplePay" style="display:none; width:100%; min-height:56px; background:#000; color:#fff; border:none; border-radius:12px; font-size:16px; font-weight:700; margin-bottom:8px;">
                <span style="font-size:20px;">🍎</span> Apple Pay
              </button>
              <button class="btn" type="button" id="btnGooglePay" style="display:none; width:100%; min-height:56px; background:#4285F4; color:#fff; border:none; border-radius:12px; font-size:16px; font-weight:700; margin-bottom:8px;">
                <span style="font-size:20px;">G</span> Google Pay
              </button>
              <!-- Standard Zahlung -->
              <button class="btn" type="button" id="btnStandardPayment" style="width:100%; min-height:56px; background:#FFD700; color:#334155; border:none; border-radius:12px; font-size:16px; font-weight:800; box-shadow:0 4px 16px rgba(255,215,0,0.25);">
                <i data-lucide="credit-card"></i> <span>JETZT BEZAHLEN</span>
              </button>
            </div>
          </div>
          
          <div style="text-align:center; padding:12px 0; font-size:13px; font-weight:700; color:#64748b;">
            <span>🧾</span> Deine Abholnummer wird sofort generiert
          </div>
          
          <!-- Guest-Checkout Hinweis -->
          <div style="padding:16px; background:rgba(255,184,0,0.08); border-radius:12px; font-size:13px; color:#666; line-height:1.5; text-align:center; margin-top:20px;">
            Kein Account nötig. Nach dem Kauf kannst du optional ein Passwort festlegen, um Belege zu speichern.
          </div>
        </div>
      </div>
    </section>

    <!-- CUSTOMER: Pickup Code (Dynamisch generiert) -->
    <div id="pickupCodeContainer"></div>

    <!-- CUSTOMER: AbholBestätigung (Success-View nach Zahlung) -->
    <section class="view customer-view" id="v-order-success" style="display:none; padding:24px 16px calc(90px + env(safe-area-inset-bottom, 0px)); min-height:100vh; background:var(--bg);">
      <div class="panel" style="padding:28px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,.06); background:#fff; border:1px solid rgba(0,0,0,.02); max-width:420px; margin:0 auto;">
        <div style="text-align:center; margin-bottom:24px;">
          <span style="font-size:48px;">🧾</span>
          <h2 style="font-family:'Nunito',sans-serif; font-weight:800; font-size:20px; margin:16px 0 8px; color:#1a1a1a;">Zahlung erfolgreich</h2>
          <p class="hint" style="font-size:14px; color:#64748b; margin:0;">Zeige diese Nummer beim Abholen vor.</p>
        </div>
        <div id="orderSuccessSingleBlock" style="text-align:center; padding:20px; background:rgba(255,215,0,0.12); border-radius:16px; border:2px solid rgba(255,215,0,0.3); margin-bottom:24px;">
          <div style="font-size:13px; font-weight:700; color:#64748b; margin-bottom:6px;">Deine Nummer</div>
          <div id="orderSuccessAbholnummer" style="font-family:monospace; font-size:32px; font-weight:900; letter-spacing:4px; color:#1a1a1a;">#1A</div>
        </div>
        <div id="orderSuccessMultiBlock" style="display:none; margin-bottom:24px;"></div>
        <div id="orderSuccessSummary" style="display:flex; flex-direction:column; gap:12px; margin-bottom:24px;">
          <div id="orderSuccessZeit" style="display:flex; align-items:center; gap:10px; padding:12px 16px; background:#f8f9fa; border-radius:12px; font-size:15px; font-weight:600; color:#334155;"><span style="font-size:20px;">🕒</span> Abholung um 12:15 Uhr</div>
          <div id="orderSuccessModus" style="display:flex; align-items:center; gap:10px; padding:12px 16px; background:#f8f9fa; border-radius:12px; font-size:15px; font-weight:600; color:#334155;"><span style="font-size:20px;">🍴</span> Vor Ort</div>
          <div id="orderSuccessVerpackung" style="display:none; align-items:center; gap:10px; padding:12px 16px; background:#f8f9fa; border-radius:12px; font-size:15px; font-weight:600; color:#334155;"><span style="font-size:20px;">🔄</span> Mehrweg-System</div>
        </div>
        <p class="hint" style="text-align:center; font-size:13px; color:#94a3b8; margin:0 0 16px;">Der Anbieter wurde informiert und bereitet deine Bestellung vor.</p>
        <button type="button" id="btnOrderSuccessKollegen" style="width:100%; min-height:48px; padding:0 20px; border-radius:14px; border:2px solid #e5e7eb; background:#fff; color:#64748b; font-weight:700; font-size:15px; cursor:pointer; margin-bottom:12px; display:flex; align-items:center; justify-content:center; gap:8px;">
          <i data-lucide="users" style="width:20px;height:20px;"></i> Kollegen bescheid geben
        </button>
        <button type="button" id="btnOrderSuccessDone" style="width:100%; min-height:52px; padding:0 20px; border-radius:16px; border:none; background:#FFD700; color:#1a1a1a; font-weight:800; font-size:16px; cursor:pointer; box-shadow:0 4px 0 0 #d1b600;">Erledigt</button>
      </div>
    </section>

    <!-- CUSTOMER: Profile "Meins" – App-like: Abholnummer groß oben, dann Historie, Rest im Zahnrad-Menü -->
    <section class="view customer-view" id="v-profile">
      <header class="cust-header-sticky">
        <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px;">
          <h1 style="font-size:20px; font-weight:950; letter-spacing:-0.03em; color:#1a1a1a; margin:0;">Meins</h1>
          <div style="display:flex; align-items:center; gap:8px;">
            <button type="button" id="btnProfileProviderPortal" aria-label="Zum Anbieter-Portal" onclick="if(window.showProviderLoginModal) window.showProviderLoginModal();" style="width:40px; height:40px; border-radius:12px; background:rgba(255,215,0,0.25); border:none; display:flex; align-items:center; justify-content:center; cursor:pointer;">
              <i data-lucide="building" style="width:20px;height:20px;color:#1a1a1a;pointer-events:none;"></i>
            </button>
            <button type="button" id="btnProfileSettings" aria-label="Einstellungen" onclick="openProfileSettingsSheet()" style="width:40px; height:40px; border-radius:12px; background:#f1f3f5; border:none; display:flex; align-items:center; justify-content:center; cursor:pointer;">
              <i data-lucide="settings" style="width:20px;height:20px;color:#1a1a1a;"></i>
            </button>
            <button type="button" onclick="showView('v-discover')" style="width:40px; height:40px; border-radius:12px; background:#f1f3f5; border:none; display:flex; align-items:center; justify-content:center; cursor:pointer;">
              <i data-lucide="x" style="width:20px;height:20px;color:#1a1a1a;"></i>
            </button>
          </div>
        </div>
      </header>

      <div style="padding:40px 16px 120px; display:flex; flex-direction:column; gap:20px;">
        <!-- Kurz Identität (Avatar + Name), nur wenn eingeloggt -->
        <div class="cust-card" id="profileHeaderCard" style="padding:16px 20px; flex-direction:row; align-items:center; gap:12px; margin-bottom:0; background:none; border:none; box-shadow:none;">
          <!-- Wird dynamisch befüllt -->
        </div>

        <!-- Abholnummer GROSS oben (app-like) -->
        <div id="profileAbholnummerSection" style="display:none;">
          <div id="profileActiveAbholnummernList" style="display:flex; flex-direction:column; gap:16px;"></div>
        </div>

        <!-- Keine aktive Abholnummer: Hinweis -->
        <div id="profileNoAbholnummerHint" style="display:none; padding:24px; text-align:center; background:#f8f9fa; border-radius:20px; border:2px dashed #e2e8f0;">
          <div style="font-size:40px; margin-bottom:12px;">🧾</div>
          <div style="font-size:15px; font-weight:700; color:#64748b;">Heute keine Abholnummer</div>
          <div style="font-size:13px; color:#94a3b8; margin-top:4px;">Bestellungen erscheinen hier</div>
        </div>

        <!-- Meine Bestellungen / Food-Historie (immer sichtbar) -->
        <div class="cust-card" style="padding:20px; margin-bottom:0;">
          <h3 style="margin:0 0 16px; font-size:16px; font-weight:900; color:#1a1a1a;">Meine Bestellungen</h3>
          <div id="profileOrderHistoryList" style="display:flex; flex-direction:column; gap:8px;">
            <!-- Dynamisch befüllt -->
          </div>
          <button class="btn ghost" id="btnProfileShowAllOrders" style="width:100%; margin-top:12px; height:44px; font-size:14px; font-weight:700; color:#64748b; border:1px solid #f1f3f5; border-radius:12px;">Alle Bestellungen anzeigen</button>
        </div>

        <!-- Versteckte Bereiche für Zahnrad-Menü (Inhalt wird in Sheet geduplt / per ID referenziert) -->
        <div id="profileCollapseData" style="display:none;">
          <div style="margin-bottom:12px;">
            <label style="display:block; font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase; margin-bottom:4px;">E-Mail</label>
            <div id="profileDisplayEmail" style="font-size:14px; font-weight:600; color:#1a1a1a;">-</div>
          </div>
          <div>
            <label style="display:block; font-size:11px; font-weight:700; color:#94a3b8; text-transform:uppercase; margin-bottom:4px;">Passwort</label>
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <div style="font-size:14px; font-weight:600; color:#1a1a1a;">••••••••</div>
              <button onclick="showToast('Funktion in der Demo nicht verfügbar')" style="font-size:12px; font-weight:700; color:var(--brand2); background:none; border:none; padding:0; cursor:pointer;">Ändern</button>
            </div>
          </div>
        </div>
        <div id="profileDietCheckboxes" style="display:none;"></div>
        <div id="profileFavProvidersList" style="display:none;"></div>
        <div id="profileTopFaq" style="display:none;"></div>
      </div>
    </section>

    <!-- Zahnrad-Menü: Einstellungen, FAQ, Impressum etc. (Bottom Sheet) -->
    <div id="profileSettingsSheetBd" onclick="closeProfileSettingsSheet()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:9000; opacity:0; transition:opacity 0.2s; cursor:pointer;"></div>
    <div id="profileSettingsSheet" style="display:none; position:fixed; left:0; right:0; bottom:0; max-height:85vh; background:#fff; border-radius:24px 24px 0 0; box-shadow:0 -8px 32px rgba(0,0,0,0.12); z-index:9001; overflow:hidden; padding-bottom:env(safe-area-inset-bottom, 0);">
      <div style="padding:20px 20px 16px; border-bottom:1px solid #f1f3f5;">
        <div style="width:40px; height:4px; background:#e2e8f0; border-radius:2px; margin:0 auto 16px;"></div>
        <h2 style="margin:0; font-size:18px; font-weight:900; color:#1a1a1a;">Einstellungen & mehr</h2>
      </div>
      <div id="profileSettingsSheetScroll" style="overflow-y:auto; max-height:calc(85vh - 80px); padding:8px 16px 24px;">
        <div id="profileSettingsSheetData" style="display:none; padding:12px 0;">
          <div style="margin-bottom:12px;">
            <label style="display:block; font-size:11px; font-weight:700; color:#94a3b8; margin-bottom:4px;">E-Mail</label>
            <div id="profileDisplayEmailSheet" style="font-size:14px; font-weight:600; color:#1a1a1a;">-</div>
          </div>
          <div>
            <label style="display:block; font-size:11px; font-weight:700; color:#94a3b8; margin-bottom:4px;">Passwort</label>
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <div style="font-size:14px; font-weight:600; color:#1a1a1a;">••••••••</div>
              <button onclick="showToast('Funktion in der Demo nicht verfügbar')" style="font-size:12px; font-weight:700; color:var(--brand2); background:none; border:none; padding:0; cursor:pointer;">Ändern</button>
            </div>
          </div>
        </div>
        <div id="profileSettingsSheetDiet" style="display:none; padding:12px 0;">
          <p style="font-size:13px; color:#64748b; margin-bottom:12px;">Bevorzugt anzeigen</p>
          <div id="profileDietCheckboxesSheet" style="display:flex; flex-direction:column; gap:12px;"></div>
        </div>
        <div id="profileSettingsSheetFavs" style="display:none; padding:12px 0;">
          <div id="profileFavProvidersListSheet" style="display:flex; flex-direction:column; gap:8px;"></div>
        </div>
        <div id="profileSettingsSheetFaq" style="display:none; padding:12px 0;">
          <div id="profileTopFaqSheet" style="display:flex; flex-direction:column; gap:12px;"></div>
          <button onclick="closeProfileSettingsSheet(); showLegalPage('support');" style="width:100%; margin-top:12px; height:48px; background:#f1f3f5; border:none; border-radius:12px; color:#64748b; font-size:14px; font-weight:700; cursor:pointer;">Weitere Fragen (Support)</button>
        </div>
        <div style="display:flex; flex-direction:column; gap:4px;">
          <button onclick="toggleProfileSettingsSection('profileSettingsSheetData')" style="width:100%; padding:16px 20px; background:#f8f9fa; border:none; border-radius:14px; display:flex; align-items:center; gap:12px; cursor:pointer; text-align:left; font-size:15px; font-weight:700; color:#1a1a1a;">
            <i data-lucide="user" style="width:20px;height:20px;color:#64748b;"></i><span>Meine Daten</span><i data-lucide="chevron-down" class="profile-sheet-chevron" data-section="profileSettingsSheetData" style="width:18px;height:18px;color:#cbd5e1;margin-left:auto;"></i>
          </button>
          <button onclick="toggleProfileSettingsSection('profileSettingsSheetDiet')" style="width:100%; padding:16px 20px; background:#f8f9fa; border:none; border-radius:14px; display:flex; align-items:center; gap:12px; cursor:pointer; text-align:left; font-size:15px; font-weight:700; color:#1a1a1a;">
            <i data-lucide="utensils" style="width:20px;height:20px;color:#64748b;"></i><span>Mein Food-Profil</span><i data-lucide="chevron-down" class="profile-sheet-chevron" data-section="profileSettingsSheetDiet" style="width:18px;height:18px;color:#cbd5e1;margin-left:auto;"></i>
          </button>
          <button onclick="toggleProfileSettingsSection('profileSettingsSheetFavs')" style="width:100%; padding:16px 20px; background:#f8f9fa; border:none; border-radius:14px; display:flex; align-items:center; gap:12px; cursor:pointer; text-align:left; font-size:15px; font-weight:700; color:#1a1a1a;">
            <i data-lucide="heart" style="width:20px;height:20px;color:#ef4444;"></i><span>Meine Lieblinge</span><i data-lucide="chevron-down" class="profile-sheet-chevron" data-section="profileSettingsSheetFavs" style="width:18px;height:18px;color:#cbd5e1;margin-left:auto;"></i>
          </button>
          <button onclick="toggleProfileSettingsSection('profileSettingsSheetFaq')" style="width:100%; padding:16px 20px; background:#f8f9fa; border:none; border-radius:14px; display:flex; align-items:center; gap:12px; cursor:pointer; text-align:left; font-size:15px; font-weight:700; color:#1a1a1a;">
            <i data-lucide="help-circle" style="width:20px;height:20px;color:#64748b;"></i><span>FAQ & Support</span><i data-lucide="chevron-down" class="profile-sheet-chevron" data-section="profileSettingsSheetFaq" style="width:18px;height:18px;color:#cbd5e1;margin-left:auto;"></i>
          </button>
          <button onclick="closeProfileSettingsSheet(); showLegalPage('impressum');" style="width:100%; padding:16px 20px; background:#f8f9fa; border:none; border-radius:14px; display:flex; align-items:center; gap:12px; cursor:pointer; text-align:left; font-size:15px; font-weight:700; color:#1a1a1a;">
            <i data-lucide="info" style="width:20px;height:20px;color:#64748b;"></i><span>Impressum</span>
          </button>
          <button onclick="closeProfileSettingsSheet(); showLegalPage('agb-kurz');" style="width:100%; padding:16px 20px; background:#f8f9fa; border:none; border-radius:14px; display:flex; align-items:center; gap:12px; cursor:pointer; text-align:left; font-size:15px; font-weight:700; color:#1a1a1a;">
            <i data-lucide="file-text" style="width:20px;height:20px;color:#64748b;"></i><span>AGB</span>
          </button>
          <button onclick="closeProfileSettingsSheet(); showLegalPage('datenschutz');" style="width:100%; padding:16px 20px; background:#f8f9fa; border:none; border-radius:14px; display:flex; align-items:center; gap:12px; cursor:pointer; text-align:left; font-size:15px; font-weight:700; color:#1a1a1a;">
            <i data-lucide="shield" style="width:20px;height:20px;color:#64748b;"></i><span>Datenschutz</span>
          </button>
          <button onclick="closeProfileSettingsSheet(); (window.openProfilePwaTipSheet||function(){})();" style="width:100%; padding:16px 20px; background:#f8f9fa; border:none; border-radius:14px; display:flex; align-items:center; gap:12px; cursor:pointer; text-align:left; font-size:15px; font-weight:700; color:#1a1a1a;">
            <span style="font-size:20px;">📱</span><span>App herunterladen</span>
          </button>
          <button onclick="closeProfileSettingsSheet(); (window.showProviderLoginModal||function(){})();" style="width:100%; padding:16px 20px; background:rgba(255,215,0,0.2); border:none; border-radius:14px; display:flex; align-items:center; gap:12px; cursor:pointer; text-align:left; font-size:15px; font-weight:700; color:#1a1a1a;">
            <span style="font-size:20px;">🏢</span><span>Zum Anbieter-Portal</span>
          </button>
          <button onclick="closeProfileSettingsSheet(); handleSupportAction('logout');" style="width:100%; padding:16px 20px; background:#fef2f2; border:none; border-radius:14px; display:flex; align-items:center; gap:12px; cursor:pointer; text-align:left; font-size:15px; font-weight:700; color:#b91c1c;">
            <i data-lucide="log-out" style="width:20px;height:20px;"></i><span>Abmelden</span>
          </button>
        </div>
        <p style="text-align:center; font-size:11px; color:#cbd5e1; font-weight:700; margin-top:20px;">mittagio • made with ❤️ in Rudersberg</p>
      </div>
    </div>

    <section class="view" id="v-provider-detail-public">
      <header class="cust-header-sticky">
        <div class="pub-prov-header-row" style="display:flex; align-items:center; gap:12px; padding:14px 16px;">
          <button type="button" class="pub-prov-back-btn" onclick="showView('v-discover')" aria-label="Zurück" style="width:48px; height:48px; border-radius:14px; background:#fff; border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.06);">
            <i data-lucide="chevron-left" style="width:24px;height:24px;color:#1a1a1a;"></i>
          </button>
          <div style="flex:1; min-width:0;">
            <h1 id="pubProvName" style="font-size:20px; font-weight:950; color:#1a1a1a; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; letter-spacing:-0.02em;">Anbieter</h1>
          </div>
          <button type="button" class="pub-prov-fav-btn" id="btnToggleFavProvider" aria-label="Favorit" style="width:48px; height:48px; border-radius:14px; background:#fff; border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.06);">
            <i data-lucide="heart" style="width:22px;height:22px;color:#E34D4D;"></i>
          </button>
        </div>
      </header>

      <div class="pub-prov-scroll">
        <div style="display:flex; flex-direction:column; gap:24px; max-width:500px; margin:0 auto;">
          <!-- Anbieter Info Card (App-like Hero) -->
          <div class="cust-card pub-prov-hero" style="padding:28px 24px; display:flex; flex-direction:column; align-items:center; text-align:center; gap:16px; background:#fff; border:none; box-shadow:0 4px 20px rgba(0,0,0,0.06); border-radius:24px;">
            <div id="pubProvLogoWrap" style="width:88px; height:88px; border-radius:24px; background:#f1f3f5; display:flex; align-items:center; justify-content:center; font-size:40px; box-shadow:0 8px 24px rgba(0,0,0,0.06); overflow:hidden;">
              <span id="pubProvLogoEmoji">🏢</span>
            </div>
            <div>
              <h2 id="pubProvTitle" style="margin:0; font-size:24px; font-weight:950; color:#1a1a1a; letter-spacing:-0.03em;">Anbieter Name</h2>
              <div id="pubProvAddress" style="font-size:15px; color:#64748b; font-weight:600; margin-top:6px; line-height:1.4;">Straße, PLZ Ort</div>
            </div>
            <div style="display:flex; gap:10px; margin-top:4px; flex-wrap:wrap; justify-content:center;">
              <button type="button" onclick="openGoogleMapsRoute(currentPublicProviderId)" style="min-height:48px; padding:0 20px; border-radius:14px; border:none; background:#f1f3f5; font-size:14px; font-weight:700; color:#1a1a1a; display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
                <i data-lucide="map-pin" style="width:18px;height:18px;"></i> Route
              </button>
              <button type="button" id="pubProvShare" style="min-height:48px; padding:0 20px; border-radius:14px; border:none; background:#f1f3f5; font-size:14px; font-weight:700; color:#1a1a1a; display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
                <i data-lucide="share-2" style="width:18px;height:18px;"></i> Teilen
              </button>
            </div>
          </div>

          <!-- Tagesessen Sektion -->
          <div>
            <h3 class="pub-prov-section-title" style="display:flex; align-items:center; gap:8px;">
              <span>Tagesessen heute</span>
              <span style="padding:3px 10px; background:var(--brand); border-radius:8px; font-size:11px; color:#1a1a1a; font-weight:800;">LIVE</span>
            </h3>
            <div id="pubProvTodayOffers" style="display:flex; flex-direction:column; gap:12px;">
              <!-- Heute Angebote -->
            </div>
          </div>

          <!-- Wochenplan Sektion -->
          <div>
            <h3 class="pub-prov-section-title">Wochenplan</h3>
            <div id="pubProvWeekPlan" style="display:flex; flex-direction:column; gap:12px;">
              <!-- Wochenangebote -->
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PROVIDER: Login-Seite -->
    <section class="view" id="v-provider-login">
      <div class="panel">
        <h3>Anbieter-Login</h3>
        <div class="hint">Melde dich als Gastronom an</div>
        <input class="field" id="provEmail" type="email" placeholder="E-Mail-Adresse" autocomplete="email" style="margin-top:12px;" />
        <div style="height:10px"></div>
        <input class="field" id="provPass" type="password" placeholder="Passwort" autocomplete="current-password" />
        <button class="btn" type="button" id="btnProvLogin" style="margin-top:16px; background:#6b7280; color:#fff; border:none; transition:all 0.2s ease;" onmouseover="this.style.background='#4b5563';" onmouseout="this.style.background='#6b7280';">Einloggen</button>
        <button class="btn secondary btn-back" type="button" id="btnProvBack" style="margin-top:8px;"><i data-lucide="chevron-left" style="width:18px;height:18px;"></i> Zurück</button>
        <details class="hint" style="margin-top:16px; padding:12px; background:rgba(0,0,0,0.04); border-radius:12px; font-size:13px;">
          <summary style="cursor:pointer; font-weight:600; color:#64748b;">Hilfe? Demo-Zugang</summary>
          <p style="margin:8px 0 0; color:#64748b; line-height:1.5;">Zum Testen: Beliebige E-Mail und Passwort eingeben → Einloggen. (Später: Anmeldung per Firebase.)</p>
        </details>
      </div>
    </section>

    <!-- PROVIDER: Onboarding (ALT) -->
    <section class="view" id="v-provider-onboarding">
      <!-- Schritt 1: Betriebsname -->
      <div class="panel onboarding-step" data-step="1">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 1 von 5</div>
          <button class="btn ghost btn-back" type="button" id="btnOnboardingBack" style="width:auto; padding:8px 12px; margin-top:8px;">
            <i data-lucide="chevron-left" style="width:18px;height:18px;"></i> Zurück
          </button>
        </div>
        <h3 style="margin-top:16px;">Wie heißt dein Betrieb?</h3>
        <div class="hint">Gib den Namen deines Restaurants, Cafés oder Betriebs ein.</div>
        <input class="field" id="onboardingBusinessNameOld" type="text" placeholder="z.B. Metzgerei Kurz" style="margin-top:12px;" />
        <button class="btn" type="button" id="btnOnboardingStep1Next" style="margin-top:16px;">Weiter</button>
      </div>

      <!-- Schritt 2: Adresse -->
      <div class="panel onboarding-step" data-step="2" style="display:none;">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 2 von 5</div>
          <button class="btn ghost btn-back" type="button" id="btnOnboardingStep2Back" style="width:auto; padding:8px 12px; margin-top:8px;">
            <i data-lucide="chevron-left" style="width:18px;height:18px;"></i> Zurück
          </button>
        </div>
        <h3 style="margin-top:16px;">Adresse deines Betriebs</h3>
        <div class="hint">Wo können Gäste dein Essen abholen?</div>
        <div class="loc-row" style="margin-top:12px;">
          <input class="field" id="onboardingAddress" type="text" placeholder="Straße und Hausnummer" />
          <button class="pin-btn" type="button" id="btnOnboardingLocationPin" aria-label="Standort setzen"></button>
        </div>
        <input class="field" id="onboardingPostalCode" type="text" placeholder="PLZ" style="margin-top:10px;" />
        <input class="field" id="onboardingCity" type="text" placeholder="Stadt" style="margin-top:10px;" />
        <button class="btn" type="button" id="btnOnboardingStep2Next" style="margin-top:16px;">Weiter</button>
      </div>

      <!-- Schritt 3: Essenszeit -->
      <div class="panel onboarding-step" data-step="3" style="display:none;">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 3 von 5</div>
          <button class="btn ghost btn-back" type="button" id="btnOnboardingStep3Back" style="width:auto; padding:8px 12px; margin-top:8px;">
            <i data-lucide="chevron-left" style="width:18px;height:18px;"></i> Zurück
          </button>
        </div>
        <h3 style="margin-top:16px;">Wann können Gäste dein Essen genießen?</h3>
        <div class="hint">Wähle die Standard-Zeiten für deine Essensausgabe.</div>
        
        <div style="margin-top:16px;">
          <div class="hint" style="margin-bottom:6px;">Startzeit</div>
          <div class="w-actions">
            <button class="btn secondary time-btn" type="button" data-time="11:00">11:00</button>
            <button class="btn secondary time-btn" type="button" data-time="11:30">11:30</button>
            <button class="btn secondary time-btn" type="button" data-time="12:00">12:00</button>
            <button class="btn secondary time-btn" type="button" data-time="12:30">12:30</button>
          </div>
          <input class="field" id="onboardingMealStart" type="time" placeholder="Startzeit" style="margin-top:10px;" />
        </div>

        <div style="margin-top:16px;">
          <div class="hint" style="margin-bottom:6px;">Endzeit</div>
          <div class="w-actions">
            <button class="btn secondary time-btn" type="button" data-time="14:00">14:00</button>
            <button class="btn secondary time-btn" type="button" data-time="14:30">14:30</button>
            <button class="btn secondary time-btn" type="button" data-time="15:00">15:00</button>
            <button class="btn secondary time-btn" type="button" data-time="15:30">15:30</button>
          </div>
          <input class="field" id="onboardingMealEnd" type="time" placeholder="Endzeit" style="margin-top:10px;" />
        </div>

        <button class="btn" type="button" id="btnOnboardingStep3Next" style="margin-top:20px;">Weiter</button>
      </div>

      <!-- Schritt 4: Logo -->
      <div class="panel onboarding-step" data-step="4" style="display:none;">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 4 von 5</div>
          <button class="btn ghost btn-back" type="button" id="btnOnboardingStep4Back" style="width:auto; padding:8px 12px; margin-top:8px;">
            <i data-lucide="chevron-left" style="width:18px;height:18px;"></i> Zurück
          </button>
        </div>
        <h3 style="margin-top:16px;">Logo hochladen</h3>
        <div class="hint">Optional: Lade ein Logo für deinen Betrieb hoch. Du kannst das auch später machen.</div>
        
        <div style="margin-top:20px; text-align:center;">
          <div class="onboarding-logo-preview" id="onboardingLogoPreview" style="width:120px; height:120px; margin:0 auto; border-radius:18px; border:2px dashed var(--border); background:#f8f7f3; display:flex; align-items:center; justify-content:center; cursor:pointer; position:relative; overflow:hidden;">
            <div style="text-align:center; color:var(--muted); font-size:12px;">
              <div style="font-size:32px; margin-bottom:8px;">📷</div>
              <div>Logo hinzufügen</div>
            </div>
            <img id="onboardingLogoImg" style="display:none; width:100%; height:100%; object-fit:cover;" />
          </div>
          <input type="file" id="onboardingLogoInput" accept="image/*" style="display:none;" />
          <button class="btn secondary" type="button" id="btnOnboardingLogoRemove" style="margin-top:12px; display:none;">Logo entfernen</button>
        </div>

        <button class="btn" type="button" id="btnOnboardingStep4Next" style="margin-top:20px;">Weiter</button>
        <button class="btn ghost" type="button" id="btnOnboardingSkipLogo" style="margin-top:8px;">Überspringen</button>
      </div>

      <!-- Schritt 5: Zusammenfassung -->
      <div class="panel onboarding-step" data-step="5" style="display:none;">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 5 von 5</div>
        </div>
        <h3 style="margin-top:16px;">Profil ist bereit! 🎉</h3>
        <div class="hint">Hier ist eine Zusammenfassung deiner Angaben:</div>
        
        <div class="onboarding-summary" style="margin-top:20px; padding:16px; background:#f8f7f3; border-radius:14px; border:1px solid var(--border);">
          <div class="onboarding-summary-item" style="margin-bottom:12px;">
            <div style="font-weight:900; font-size:14px;" id="summaryBusinessName">–</div>
            <div class="hint" id="summaryAddress" style="margin-top:4px;">–</div>
          </div>
          <div class="onboarding-summary-item" style="margin-bottom:12px;">
            <div class="hint" style="margin-bottom:4px;">Essenszeit</div>
            <div style="font-weight:900;" id="summaryMealTime">–</div>
          </div>
          <div class="onboarding-summary-item" id="summaryLogoContainer" style="display:none;">
            <div class="hint" style="margin-bottom:4px;">Logo</div>
            <div id="summaryLogo" style="width:60px; height:60px; border-radius:12px; overflow:hidden; border:1px solid var(--border);">
              <img id="summaryLogoImg" style="width:100%; height:100%; object-fit:cover;" />
            </div>
          </div>
        </div>

        <button class="btn" type="button" id="btnOnboardingComplete" style="margin-top:24px;">Erstes Gericht erstellen</button>
        <button class="btn secondary" type="button" id="btnOnboardingEdit" style="margin-top:8px;">Angaben bearbeiten</button>
      </div>
    </section>

    <!-- PROVIDER: Onboarding Entry – Speed-Einstieg (unter 30 Sekunden zum Live-Inserat) -->
    <section class="view" id="v-provider-onboarding-entry" style="background:var(--provider-bg); min-height:100vh; padding:20px; display:flex; align-items:center; justify-content:center;">
      <div class="panel" id="onboardingEntryPanel" style="padding:32px 24px; max-width:440px; width:100%; background:#fff; border-radius:28px; box-shadow:0 12px 40px rgba(0,0,0,0.08); border:1px solid rgba(0,0,0,0.04);">
        <div style="width:64px; height:64px; background:var(--brand); border-radius:20px; display:flex; align-items:center; justify-content:center; margin:0 auto 24px; box-shadow:0 8px 20px rgba(255,215,0,0.3);">
          <i data-lucide="zap" style="width:32px; height:32px; color:#1a1a1a;"></i>
        </div>
        <h1 style="font-size:26px; font-weight:950; margin-bottom:12px; line-height:1.2; color:#1a1a1a; text-align:center; letter-spacing:-0.03em;">Sofort verkaufen.<br>Ohne Abo & Vertrag.</h1>
        <p style="font-size:15px; color:#64748b; margin-bottom:28px; text-align:center; line-height:1.5;">Einmalig 4,99 € pro Inserat – unabhängig von der Portionsmenge.</p>
        
        <div style="margin-bottom:24px;">
          <label style="display:block; font-size:13px; font-weight:700; color:#9ca3af; text-transform:uppercase; margin-bottom:8px; letter-spacing:0.03em;">Was bietest du heute an?</label>
          <div style="display:flex; gap:10px;">
            <input type="text" id="onboardingEntryDishInput" class="field" placeholder="z.B. Kürbissuppe …" autocomplete="off" style="flex:1; height:56px; padding:0 18px; font-size:17px; border-radius:16px; border:2px solid #eee;" />
            <button type="button" id="btnOnboardingEntryGo" style="flex-shrink:0; width:56px; height:56px; border-radius:16px; background:#1a1a1a; color:#fff; border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:transform 0.15s;">
              <i data-lucide="arrow-right" style="width:24px;height:24px;"></i>
            </button>
          </div>
        </div>
        
        <button class="btn-primary" type="button" id="btnOnboardingEntryStart" style="width:100%; min-height:60px; background:var(--brand); color:#1a1a1a; font-weight:900; font-size:17px; border:none; border-radius:18px; box-shadow:0 8px 24px rgba(255,215,0,0.4); margin-bottom:12px; display:flex; align-items:center; justify-content:center; gap:10px; cursor:pointer; transition:transform 0.2s, box-shadow 0.2s;">
          <span>Inserat starten</span>
          <i data-lucide="zap" style="width:20px;height:20px;"></i>
        </button>
        
        <button class="btn secondary" type="button" id="btnOnboardingEntryLater" style="width:100%; min-height:48px; background:transparent; color:#64748b; border:none; font-weight:700; font-size:14px; cursor:pointer;">
          Bereits Konto? Login
        </button>
        
        <p style="margin-top:24px; font-size:13px; color:#94a3b8; text-align:center; line-height:1.4;">
          <i data-lucide="clock" style="width:14px;height:14px;display:inline-block;vertical-align:middle;margin-right:4px;"></i> In unter 30 Sekunden live.
        </p>
      </div>
    </section>

    <section class="view onboarding-view" id="v-provider-onboarding-first-dish">
      <div class="panel">
        <h2 style="font-size:24px; font-weight:900; margin-bottom:8px; letter-spacing:-0.02em;">Erstes Gericht anlegen</h2>
        <p style="font-size:15px; color:#64748b; margin-bottom:24px;">Was bietest du heute an? Basis-Infos genügen.</p>
        
        <div style="margin-bottom:20px;">
          <label style="display:block; font-size:13px; font-weight:700; color:#9ca3af; text-transform:uppercase; margin-bottom:8px; letter-spacing:0.03em;">Gerichtname *</label>
          <input class="field" type="text" id="onboardingDishName" placeholder="z.B. Kürbissuppe" required style="width:100%; height:52px; border-radius:12px; border:1.5px solid #eee; padding:0 16px; font-size:16px;" />
        </div>

        <div style="margin-bottom:20px;">
          <label style="display:block; font-size:13px; font-weight:700; color:#9ca3af; text-transform:uppercase; margin-bottom:8px; letter-spacing:0.03em;">Preis (€) *</label>
          <input type="hidden" id="onboardingDishPrice" value="8.50" required />
          <div id="onboardingDishPriceControl" style="display:flex; align-items:center; justify-content:center; gap:12px;">
            <button type="button" class="btn secondary" id="btnOnboardingPriceMinus" style="min-width:52px; min-height:52px; font-size:20px; font-weight:800;">−</button>
            <span id="onboardingDishPriceDisplay" style="font-size:22px; font-weight:900; color:#1a1a1a; min-width:80px; text-align:center; font-variant-numeric:tabular-nums;">8,50 €</span>
            <button type="button" class="btn secondary" id="btnOnboardingPricePlus" style="min-width:52px; min-height:52px; font-size:20px; font-weight:800;">+</button>
          </div>
        </div>

        <div style="margin-bottom:20px;">
          <label style="display:block; font-size:13px; font-weight:700; color:#9ca3af; text-transform:uppercase; margin-bottom:8px; letter-spacing:0.03em;">Kategorie *</label>
          <div style="display:flex; gap:10px;">
            <label class="radio-pill">
              <input type="radio" name="dishDiet" value="Fleisch" required>
              <span style="min-width:80px; text-align:center;">Fleisch</span>
            </label>
            <label class="radio-pill">
              <input type="radio" name="dishDiet" value="Vegetarisch">
              <span style="min-width:80px; text-align:center;">Veggie</span>
            </label>
            <label class="radio-pill">
              <input type="radio" name="dishDiet" value="Vegan">
              <span style="min-width:80px; text-align:center;">Vegan</span>
            </label>
          </div>
        </div>

        <div style="margin-bottom:20px;">
          <label style="display:block; font-size:13px; font-weight:700; color:#9ca3af; text-transform:uppercase; margin-bottom:8px; letter-spacing:0.03em;">Beschreibung <span style="font-weight:400; color:#9ca3af; text-transform:none;">(optional)</span></label>
          <textarea class="field" id="onboardingDishDesc" rows="2" placeholder="z.B. mit frischen Kräutern" style="width:100%; border-radius:12px; border:1.5px solid #eee; padding:12px 16px; font-size:15px; resize:none;"></textarea>
        </div>
        
        <div style="display:flex; gap:12px; margin-bottom:20px;">
          <div style="flex:1;">
            <label style="display:block; font-size:13px; font-weight:700; color:#9ca3af; text-transform:uppercase; margin-bottom:8px;">Von</label>
            <input class="field" type="time" id="onboardingPickupTimeStart" required style="width:100%; height:52px; border-radius:12px; border:1.5px solid #eee; padding:0 16px; font-size:16px;" />
          </div>
          <div style="flex:1;">
            <label style="display:block; font-size:13px; font-weight:700; color:#9ca3af; text-transform:uppercase; margin-bottom:8px;">Bis</label>
            <input class="field" type="time" id="onboardingPickupTimeEnd" required style="width:100%; height:52px; border-radius:12px; border:1.5px solid #eee; padding:0 16px; font-size:16px;" />
          </div>
        </div>
        
        <div style="margin-bottom:24px;">
          <div style="display:flex; gap:12px; margin-bottom:12px;">
            <button class="btn secondary" type="button" id="btnOnboardingAddPhoto" style="flex:1; min-height:52px; background:white; color:#1a1a1a; font-weight:700; border:2px solid #eee; border-radius:14px; display:flex; align-items:center; justify-content:center; gap:8px;">
              <i data-lucide="camera" style="width:20px;height:20px;"></i><span>Kamera</span>
            </button>
            <button class="btn secondary" type="button" id="btnOnboardingChooseProPhoto" style="flex:1; min-height:52px; background:#1a1a1a; color:white; font-weight:700; border:none; border-radius:14px; display:flex; align-items:center; justify-content:center; gap:8px;">
              <i data-lucide="image" style="width:20px;height:20px;"></i><span>Galerie</span>
            </button>
          </div>
          <div id="onboardingPhotoPreview" style="display:none; margin-top:12px; position:relative;">
            <img id="onboardingPhotoPreviewImg" style="width:100%; max-height:200px; object-fit:cover; border-radius:16px; border:1px solid #eee;" />
          </div>
        </div>
      </div>

      <div class="onboarding-actions">
        <button class="secondary btn-back" type="button" id="btnOnboardingFirstDishBack"><i data-lucide="chevron-left" style="width:18px;height:18px;"></i> Zurück</button>
        <button class="btn-primary" type="button" id="btnOnboardingFirstDishNext">Weiter</button>
      </div>
    </section>

    <section class="view onboarding-view" id="v-provider-onboarding-signup">
      <div class="panel">
        <h2 style="font-size:24px; font-weight:900; margin-bottom:8px; letter-spacing:-0.02em;">Speichern & weitermachen</h2>
        <p style="font-size:15px; color:#64748b; margin-bottom:24px;">Erstelle ein kostenloses Konto, um dein Inserat zu sichern.</p>
        
        <div style="margin-bottom:20px;">
          <label style="display:block; font-size:13px; font-weight:700; color:#9ca3af; text-transform:uppercase; margin-bottom:8px; letter-spacing:0.03em;">E-Mail *</label>
          <input class="field" type="email" id="onboardingEmail" placeholder="deine@email.de" required autocomplete="email" style="width:100%; height:52px; border-radius:12px; border:1.5px solid #eee; padding:0 16px; font-size:16px;" />
        </div>
        
        <div style="margin-bottom:24px;">
          <label style="display:block; font-size:13px; font-weight:700; color:#9ca3af; text-transform:uppercase; margin-bottom:8px; letter-spacing:0.03em;">Passwort *</label>
          <input class="field" type="password" id="onboardingPassword" placeholder="Mindestens 8 Zeichen" required autocomplete="new-password" style="width:100%; height:52px; border-radius:12px; border:1.5px solid #eee; padding:0 16px; font-size:16px;" />
        </div>
        
        <div style="margin-top:auto; padding:16px; background:#f8f7f2; border-radius:16px; font-size:13px; color:#64748b; line-height:1.5; border:1px solid rgba(0,0,0,0.03);">
          <i data-lucide="shield-check" style="width:16px;height:16px;display:inline-block;vertical-align:middle;margin-right:4px;color:#1a1a1a;"></i>
          Inseratsgebühr fällt erst bei Veröffentlichung an. Keine versteckten Kosten.
        </div>
      </div>

      <div class="onboarding-actions">
        <button class="secondary" type="button" id="btnOnboardingSignupLater">Login</button>
        <button class="btn-primary" type="button" id="btnOnboardingSignupCreate">Konto erstellen</button>
      </div>
    </section>

    <section class="view onboarding-view" id="v-provider-onboarding-business">
      <div class="panel">
        <h2 style="font-size:24px; font-weight:900; margin-bottom:8px; letter-spacing:-0.02em;">Dein Betrieb</h2>
        <p style="font-size:15px; color:#64748b; margin-bottom:24px;">Fast fertig! Nur noch ein paar Details zu deinem Standort.</p>
        
        <div style="margin-bottom:20px;">
          <label style="display:block; font-size:13px; font-weight:700; color:#9ca3af; text-transform:uppercase; margin-bottom:8px; letter-spacing:0.03em;">Betriebsname *</label>
          <input class="field" type="text" id="onboardingBusinessName" placeholder="z.B. Metzgerei Kurz" required style="width:100%; height:52px; border-radius:12px; border:1.5px solid #eee; padding:0 16px; font-size:16px;" />
        </div>
        
        <div style="margin-bottom:24px;">
          <label style="display:block; font-size:13px; font-weight:700; color:#9ca3af; text-transform:uppercase; margin-bottom:8px; letter-spacing:0.03em;">Stadt oder Adresse *</label>
          <input class="field" type="text" id="onboardingCityOrAddress" placeholder="z.B. Stuttgart" required style="width:100%; height:52px; border-radius:12px; border:1.5px solid #eee; padding:0 16px; font-size:16px;" />
        </div>
        
        <div class="hint" style="font-size:14px; margin-bottom:24px; color:#64748b; line-height:1.5; padding:16px; background:white; border-radius:16px; border:1px solid #eee;">
          <i data-lucide="info" style="width:18px;height:18px;display:inline-block;vertical-align:middle;margin-right:8px;color:var(--brand);"></i>
          Diese Angaben kannst du später in deinem Profil jederzeit verfeinern.
        </div>
      </div>

      <div class="onboarding-actions">
        <button class="secondary btn-back" type="button" id="btnOnboardingBusinessBack"><i data-lucide="chevron-left" style="width:18px;height:18px;"></i> Zurück</button>
        <button class="btn-primary" type="button" id="btnOnboardingBusinessNext">Weiter</button>
      </div>
    </section>

    <section class="view onboarding-view" id="v-provider-onboarding-preview">
      <div class="panel">
        <h2 style="font-size:24px; font-weight:900; margin-bottom:8px; letter-spacing:-0.02em;">Vorschau</h2>
        <p style="font-size:15px; color:#64748b; margin-bottom:24px;">So erscheint dein Gericht für Kunden in der App.</p>
        
        <div style="margin-bottom:24px; padding:14px 16px; background:#f0f9ff; border-radius:16px; border:1px solid #bae6fd; display:flex; align-items:center; gap:12px;">
          <i data-lucide="eye" style="width:20px;height:20px;color:#0ea5e9;"></i>
          <div style="font-weight:700; font-size:14px; color:#0369a1;">Vorschau-Modus</div>
        </div>
        
        <div id="onboardingPreviewCard" style="margin-bottom:24px;">
          <!-- Wird dynamisch befüllt -->
        </div>
      </div>

      <div class="onboarding-actions">
        <button class="secondary" type="button" id="btnOnboardingPreviewEdit">Bearbeiten</button>
        <button class="btn-primary" type="button" id="btnOnboardingPreviewDashboard">Fertigstellen</button>
      </div>
    </section>

    <!-- PROVIDER APP - Dashboard 2.1: 4 schwebende Kästen (App-like) -->
    <section class="view prov-dashboard-stolz" id="v-provider-home">
      <div class="dashboard-floating-wrap">
        <!-- KASTEN 1: Meine Küche Header (Layout + Stil wie Wochenplan/Kochbuch) -->
        <header class="dashboard-kasten dashboard-kasten-header prov-header prov-header-stolz prov-page-header">
          <div class="prov-header-inner">
            <div class="prov-page-header-row">
              <div class="prov-page-header-left">
                <div class="prov-page-header-icon" aria-hidden="true">
                  <i data-lucide="home" style="width:24px; height:24px;"></i>
                </div>
                <h1 class="prov-page-header-title">Meine Küche</h1>
              </div>
              <button type="button" id="btnProviderHomeRefresh" title="Aktualisieren" aria-label="Daten neu laden" class="prov-page-header-action" style="background:rgba(0,0,0,0.06); border:none; min-width:44px; min-height:44px; width:44px; height:44px; border-radius:14px; display:flex; align-items:center; justify-content:center; color:#1a1a1a; cursor:pointer;">
                <i data-lucide="refresh-cw" style="width:20px; height:20px;"></i>
              </button>
            </div>
            <div id="providerHomeGreeting" style="display:none;"></div>
            <div id="providerHomeDate" style="display:none;" aria-hidden="true"></div>
          </div>
        </header>

        <!-- KASTEN 2: KPIs -->
        <div class="dashboard-kasten dashboard-kasten-kpis">
          <div class="prov-stats-stolz" style="display:flex; justify-content:space-between; align-items:flex-end; border:none; padding:0;">
            <div id="kpiTagesessen" role="button" tabindex="0" style="text-align:center; cursor:pointer; min-height:40px; flex:1;" onclick="document.getElementById('providerActiveListingsSection')?.scrollIntoView({behavior:'smooth'})" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault(); document.getElementById('providerActiveListingsSection')?.scrollIntoView({behavior:'smooth'});}" title="Tagesessen">
              <p id="kpiLabelTagesessen" class="kpi-label" style="margin:0 0 2px; font-size:8px; font-weight:800; color:#9ca3af; text-transform:uppercase; letter-spacing:0.05em;">Tagesessen</p>
              <p id="dashboardTagesessenCount" style="margin:0; font-size:16px; font-weight:900; color:#1a1a1a;">0</p>
            </div>
            <div id="kpiBestellungen" role="button" tabindex="0" style="text-align:center; padding:0 16px; border-left:1px solid #f3f4f6; border-right:1px solid #f3f4f6; cursor:pointer; min-height:40px; flex:1;" onclick="showProviderPickups()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault(); showProviderPickups();}" title="Abholnummer / Abholungen">
              <p id="kpiLabelAbholungen" class="kpi-label" style="margin:0 0 2px; font-size:8px; font-weight:800; color:#9ca3af; text-transform:uppercase; letter-spacing:0.05em;">Abholungen</p>
              <p id="dashboardAbholungenCount" style="margin:0; font-size:16px; font-weight:900; color:#3b82f6;">0</p>
            </div>
            <div id="kpiUmsatz" role="button" tabindex="0" style="text-align:right; cursor:pointer; min-height:40px; flex:1;" onclick="showProviderBilling()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault(); showProviderBilling();}" title="Tagesumsatz">
              <p id="kpiLabelUmsatz" class="kpi-label" style="margin:0 0 2px; font-size:8px; font-weight:800; color:#9ca3af; text-transform:uppercase; letter-spacing:0.05em;">Umsatz heute</p>
              <p id="dashboardUmsatzToday" style="margin:0; font-size:16px; font-weight:900; color:#16a34a;">0,00 €</p>
            </div>
          </div>
        </div>

        <!-- KASTEN 3: Aktive Angebote heute -->
        <div class="dashboard-kasten dashboard-kasten-angebote" id="providerActiveListingsSectionWrap">
          <div id="providerActiveListingsSection">
            <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px;">
              <h3 class="provider-week-title" style="margin:0;">Aktive Angebote heute</h3>
              <button type="button" id="btnProviderShareToday" title="Heutige Angebote teilen" aria-label="Angebote teilen" style="background:rgba(0,0,0,0.06); border:none; min-width:44px; min-height:44px; border-radius:14px; display:flex; align-items:center; justify-content:center; color:#1a1a1a; cursor:pointer;">
                <i data-lucide="share-2" style="width:20px; height:20px;"></i>
              </button>
            </div>
            <div id="providerActiveListingsEmptyCard" style="display:none; margin-top:8px;">
              <div class="prov-card" style="padding:32px 24px; text-align:center; border:2px dashed rgba(0,0,0,0.08); background:#fafafa; border-radius:24px;">
                <div style="font-size:15px; font-weight:700; color:#64748b; margin-bottom:8px;">Noch kein Gericht für heute</div>
                <p style="font-size:13px; color:#94a3b8; margin:0 0 20px;">Erstelle dein erstes Tagesangebot – dann siehst du es hier.</p>
                <div class="prov-add-plus-trigger" id="btnProviderFirstDishToday" role="button" tabindex="0" aria-label="Gericht für heute hinzufügen" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault(); document.getElementById('btnProviderFirstDishToday').click();}">
                  <span class="prov-add-plus-icon" aria-hidden="true">＋</span>
                </div>
              </div>
            </div>
            <div id="providerActiveListings" style="display:flex; flex-direction:column; gap:14px; margin-top:12px;">
              <!-- Dynamische Karten -->
            </div>
          </div>
        </div>

        <!-- KASTEN 4: Dein Wochenplan -->
        <div class="dashboard-kasten dashboard-kasten-wochenplan">
          <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px; margin-bottom:16px;">
            <h3 class="provider-week-title" style="margin:0;">Dein Wochenplan</h3>
            <button type="button" id="btnProviderShareWeekPlanTitle" title="Wochenplan teilen" aria-label="Wochenplan teilen" style="background:rgba(0,0,0,0.06); border:none; min-width:44px; min-height:44px; border-radius:14px; display:flex; align-items:center; justify-content:center; color:#1a1a1a; cursor:pointer;">
              <i data-lucide="share-2" style="width:20px; height:20px;"></i>
            </button>
          </div>
          <div class="provider-week-card" id="providerWeekCard" role="button" tabindex="0">
            <div id="providerWeekDays" class="provider-week-days"></div>
            <div id="providerWeekDayContent" class="provider-week-day-content"></div>
          </div>
          <div class="provider-week-footer" style="display:flex; flex-direction:column; gap:10px;">
            <button type="button" id="btnProviderWeekFooter" style="width:100%; min-height:48px; border-radius:26px; border:2px solid #e5e7eb; background:#fff; color:#1a1a1a; font-size:16px; font-weight:800; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; box-shadow:0 2px 12px rgba(0,0,0,0.06); transition:transform 0.1s, box-shadow 0.15s;" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault(); document.getElementById('btnProviderWeekFooter').click();}">
              <span>Zum Wochenplan</span>
              <i data-lucide="chevron-right" style="width:20px; height:20px;"></i>
            </button>
            <button type="button" id="btnProviderShareWeekPlan" title="Wochenplan teilen" style="display:none; width:100%; min-height:44px; border-radius:22px; border:2px solid #e5e7eb; background:#fff; color:#64748b; font-size:14px; font-weight:700; cursor:pointer; align-items:center; justify-content:center; gap:8px;">
              <i data-lucide="share-2" style="width:18px; height:18px;"></i>
              <span>Teilen</span>
            </button>
          </div>
        </div>

        <!-- Empty State -->
        <div id="providerEmptyDashboard" style="display:none; text-align:center; padding:60px 24px; background:white; border-radius:32px; border:1px solid rgba(0,0,0,0.04); box-shadow: 0 10px 30px rgba(0,0,0,0.05);">
          <div style="width:88px; height:88px; background:var(--prov-brand); border-radius:28px; margin:0 auto 24px; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 24px rgba(255,215,0,0.3);">
            <i data-lucide="sparkles" style="width:44px; height:44px; color:#1a1a1a;"></i>
          </div>
          <h3 style="font-size:24px; font-weight:950; color:#1a1a1a; margin-bottom:12px; letter-spacing:-0.03em;">Bereit für Gäste?</h3>
          <p style="color:#64748b; margin-bottom:32px; line-height:1.6; font-size:15px;">Erstelle dein erstes Inserat und werde sofort für Kunden in deiner Umgebung sichtbar.</p>
          <button class="btn-primary provider-add-plus-btn" id="btnProviderEmptyAddDish" style="width:100%; min-height:60px; border-radius:18px; font-size:16px;">
            <span class="plus-char" style="font-size:22px; line-height:1; color:#fff;">+</span>
            <span>Jetzt Gericht erstellen</span>
          </button>
        </div>

      </div>
    </section>

    <section class="view onboarding-view" id="v-provider-pickups">
      <header class="prov-page-header" id="v-provider-pickups-header">
        <div class="prov-page-header-row">
          <div class="prov-page-header-left">
            <div class="prov-page-header-icon">
              <i data-lucide="receipt" style="width:24px; height:24px;"></i>
            </div>
            <h1 class="prov-page-header-title">Abholungen</h1>
          </div>
          <div class="prov-page-header-actions">
            <button type="button" id="btnKitchenListPDF" aria-label="PDF">
              <i data-lucide="file-text" style="width:20px; height:20px;"></i>
            </button>
            <button type="button" id="btnKitchenListEmail" aria-label="E-Mail">
              <i data-lucide="mail" style="width:20px; height:20px;"></i>
            </button>
          </div>
        </div>
        <div class="answers" id="provPickupFilter" style="background:#f1f3f5; padding:4px; border-radius:14px; display:flex; gap:4px; border:none; box-shadow:none; margin-top:12px;">
          <!-- Wird dynamisch befüllt -->
        </div>
      </header>

      <div style="padding:12px 20px 20px; max-width:500px; margin:0 auto; flex:1;">
        <!-- Subheader Status -->
        <div id="provPickupsSubheader" style="margin-bottom:20px; font-size:13px; font-weight:700; color:#9ca3af; text-transform:uppercase; letter-spacing:0.05em;">
          <!-- Wird dynamisch befüllt -->
        </div>
        
        <!-- Empty States -->
        <div id="provPickupsEmpty" style="text-align:center; padding:80px 24px; display:none;">
          <div style="width:80px; height:80px; background:rgba(0,0,0,0.03); border-radius:50%; margin:0 auto 20px; display:flex; align-items:center; justify-content:center;">
            <i data-lucide="receipt" style="width:40px; height:40px; color:#cbd5e1;"></i>
          </div>
          <h3 style="font-size:18px; font-weight:800; color:#1a1a1a; margin-bottom:8px;">Noch keine Abholungen</h3>
          <p style="color:#64748b; font-size:15px; line-height:1.5;">Sobald Kunden bestellen, erscheinen sie hier in Echtzeit.</p>
        </div>
        
        <!-- Pickup Grid (Theken-Grid) -->
        <div id="provPickupsGrid" style="display:none; grid-template-columns:repeat(2, 1fr); gap:16px;">
          <!-- Wird dynamisch befüllt -->
        </div>
        
        <!-- Pickup List -->
        <div id="provPickupsList" style="display:none; flex-direction:column; gap:12px;">
          <!-- Wird dynamisch befüllt -->
        </div>
      </div>
    </section>

    <section class="view onboarding-view" id="v-provider-week">
      <header class="week-header-compact prov-page-header" id="weekHeaderCompact">
        <div class="prov-page-header-row week-header-row">
          <div class="prov-page-header-left">
            <div class="prov-page-header-icon">
              <i data-lucide="calendar" style="width:24px; height:24px;"></i>
            </div>
            <div>
              <h1 class="prov-page-header-title" id="weekHeaderTitle">Wochenplan</h1>
              <p class="week-header-subtitle" id="weekHeaderSubtitle">Deine Woche · Gerichte planen</p>
            </div>
          </div>
          <div class="week-header-actions" style="display:flex; align-items:center; gap:8px;">
            <button type="button" id="btnKwPdf" title="Drucken" aria-label="Drucken" style="background:rgba(0,0,0,0.06); border:none; min-width:44px; min-height:44px; border-radius:14px; display:flex; align-items:center; justify-content:center; color:#1a1a1a; cursor:pointer;">
              <i data-lucide="printer" style="width:20px; height:20px;"></i>
            </button>
            <button type="button" id="btnKwShare" title="Teilen" aria-label="Teilen" style="background:rgba(0,0,0,0.06); border:none; min-width:44px; min-height:44px; border-radius:14px; display:flex; align-items:center; justify-content:center; color:#1a1a1a; cursor:pointer;">
              <i data-lucide="share-2" style="width:20px; height:20px;"></i>
            </button>
          </div>
          <button type="button" class="week-header-done-btn" id="weekHeaderDoneBtn" style="display:none;" aria-label="Fertig">Fertig</button>
        </div>
      </header>

      <!-- KW-Board: KW-Carousel + 7-Tage-Grid + Action-Bar -->
      <div id="kwBoardWrap" style="display:flex; flex-direction:column; flex:1; min-height:0;">
        <div class="kw-board-header" id="kwBoardHeader">
          <div class="kw-carousel" id="kwCarousel" role="tablist"></div>
          <div class="kw-progress-wrap">
            <div class="kw-progress"><div class="kw-progress-fill" id="kwProgressFill" style="width:0%;"></div></div>
          </div>
        </div>
        <div id="kwBoardScroll" class="kw-board-scroll">
          <div class="kw-grid" id="kwGrid"></div>
        </div>
        <div class="kw-action-bar-fixed" id="kwActionBarFixed" style="display:none;">
          <!-- Drucken & Teilen sind in der Header-Zeile (week-header-actions) -->
        </div>
      </div>
    </section>

    <!-- Kochbuch: MASTER-SPEC MagazinKochbuch – nur Titel + Pills, Magazin-Karte, Bar BEARBEITEN | WOCHENPLAN | AUSWÄHLEN -->
    <section class="view" id="v-provider-cookbook" style="background:linear-gradient(180deg, rgba(254,243,199,0.2) 0%, #F5F5F7 30%);">
      <header class="prov-page-header" id="v-provider-cookbook-header">
        <div class="prov-page-header-row">
          <div class="prov-page-header-left" style="flex:1; min-width:0;">
            <div id="cookbookTitleWrap" style="display:flex; align-items:center; gap:12px; min-width:0;">
              <div class="prov-page-header-icon">
                <i data-lucide="book-open" style="width:24px; height:24px;"></i>
              </div>
              <h1 class="prov-page-header-title" id="cookbookHeaderTitle">Mein Kochbuch</h1>
            </div>
            <div id="cookbookSearchWrap" style="display:none; flex:1; min-width:0;">
              <input type="text" id="cookbookSearchInput" placeholder="Gericht suchen…" style="width:100%; height:40px; border-radius:12px; border:2px solid #e2e8f0; padding:0 14px; font-size:14px; font-weight:500; outline:none; box-sizing:border-box;" />
            </div>
          </div>
          <div class="prov-page-header-right" style="display:flex; align-items:center; gap:8px; flex-shrink:0;">
            <button type="button" id="cookbookBtnSearch" aria-label="Suchen" class="cookbook-header-btn" style="width:40px; height:40px; border-radius:50%; border:none; background:#F5F5F7; display:flex; align-items:center; justify-content:center; font-size:18px; cursor:pointer;">🔍</button>
            <div style="position:relative;">
              <button type="button" id="cookbookBtnSort" aria-label="Sortierung" class="cookbook-header-btn" style="width:40px; height:40px; border-radius:50%; border:none; background:#F5F5F7; display:flex; align-items:center; justify-content:center; font-size:16px; font-weight:700; cursor:pointer;">⇅</button>
              <div id="cookbookSortDropdown" style="display:none; position:absolute; right:0; top:100%; margin-top:6px; width:200px; background:#fff; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,0.12); border:1px solid rgba(0,0,0,0.06); padding:6px; z-index:100;"></div>
            </div>
          </div>
        </div>
        <div class="cookbook-category-pills" id="cookbookCategoryPills" role="tablist" aria-label="Kategorie filter"></div>
      </header>

      <div id="cookbookScrollWrap" style="flex:1; min-height:0; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:16px 20px calc(24px + env(safe-area-inset-bottom, 0)); max-width:500px; margin:0 auto; width:100%; box-sizing:border-box;">
        <div id="cookbookMagazine" style="display:flex; align-items:center; justify-content:center; min-height:320px;">
          <!-- Eine Karte (Magazin-Flip), dynamisch -->
        </div>
        <div id="cookbookList" style="display:none; gap:16px;"></div>

        <div id="cookbookEmpty" style="text-align:center; padding:80px 24px; display:none;">
          <div style="width:96px; height:96px; background:rgba(255,255,255,0.6); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px); border:1px solid rgba(255,255,255,0.5); border-radius:50%; margin:0 auto 24px; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 32px rgba(0,0,0,0.08); font-size:48px;">📖</div>
          <h2 style="font-size:24px; font-weight:800; color:#1D1D1F; margin-bottom:8px;">Dein Erfolgstagebuch ist noch leer.</h2>
          <p style="color:#86868B; font-size:14px; line-height:1.5; margin-bottom:32px; max-width:280px; margin-left:auto; margin-right:auto;">Inseriere dein erstes Gericht und wir füllen dein Kochbuch automatisch mit Bestsellern.</p>
          <button class="btn-primary" id="btnCookbookEmptyAdd" type="button" style="width:100%; min-height:56px; border-radius:24px; font-size:15px; font-weight:800; background:#FACC15; color:#1a1a1a; border:none; box-shadow:0 4px 20px rgba(250,204,21,0.4);">
            JETZT ERSTES GERICHT INSERIEREN
          </button>
        </div>
      </div>
    </section>

    <!-- Kochbuch: Bottom-Sheet "Jetzt live schalten" (Preis, Datum, Zeit, 4,99€-Button) -->
    <div class="backdrop" id="cookbookLiveSheetBd" style="display:none; background:rgba(0,0,0,0.5); z-index:1050;" onclick="closeCookbookLiveSheet()"></div>
    <div class="sheet sheet--kitchen" id="cookbookLiveSheet" style="max-width:480px; border-radius:28px 28px 0 0; overflow:hidden; z-index:1051;">
      <div class="handle"></div>
      <div class="sheet-body" style="padding:20px 20px calc(24px + env(safe-area-inset-bottom));">
        <h3 id="cookbookLiveSheetTitle" style="margin:0 0 8px; font-size:18px; font-weight:900; color:#1a1a1a;">Auswählen</h3>
        <p id="cookbookLiveSheetDish" style="margin:0 0 16px; font-size:15px; color:#64748b;"></p>
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:11px; font-weight:800; color:#64748b; text-transform:uppercase; margin-bottom:6px;">Preis (aus Kochbuch)</label>
          <div id="cookbookLiveSheetPrice" style="font-size:22px; font-weight:900; color:#1a1a1a;"></div>
        </div>
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:11px; font-weight:800; color:#64748b; text-transform:uppercase; margin-bottom:6px;">Datum</label>
          <div id="cookbookLiveSheetDateWrap" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
        </div>
        <div style="margin-bottom:20px;">
          <label style="display:block; font-size:11px; font-weight:800; color:#64748b; text-transform:uppercase; margin-bottom:6px;">Zeitfenster (aus Profil)</label>
          <div id="cookbookLiveSheetTime" style="font-size:16px; font-weight:700; color:#1a1a1a;"></div>
        </div>
        <button type="button" id="cookbookLiveSheetBtn" style="width:100%; min-height:56px; border-radius:16px; font-size:16px; font-weight:800; border:none; background:#FFD700; color:#1a1a1a; cursor:pointer; box-shadow:0 4px 16px rgba(255,215,0,0.4);">
          Jetzt für 4,99 € inserieren
        </button>
        <button type="button" class="btn secondary" style="width:100%; min-height:48px; margin-top:12px; border-radius:14px;" onclick="closeCookbookLiveSheet()">Abbrechen</button>
      </div>
    </div>

    <!-- Kochbuch: Bottom-Sheet "Wochenplan" (Mo–So, Backdrop-Blur, Stagger) -->
    <div class="backdrop cookbook-week-bd" id="cookbookWeekSheetBd" style="display:none; background:rgba(0,0,0,0.4); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); z-index:1050; transition:opacity 0.4s;" onclick="closeCookbookWeekSheet()"></div>
    <div class="sheet sheet--kitchen cookbook-week-sheet" id="cookbookWeekSheet" style="max-width:480px; border-radius:28px 28px 0 0; overflow:hidden; z-index:1051; transition:transform 0.4s cubic-bezier(0.4,0,0.2,1);">
      <div class="handle"></div>
      <div class="sheet-body" style="padding:20px 20px calc(24px + env(safe-area-inset-bottom));">
        <h3 style="margin:0 0 4px; font-size:18px; font-weight:900; color:#1a1a1a;">Wochenplan</h3>
        <p id="cookbookWeekSheetDish" style="margin:0 0 20px; font-size:14px; color:#64748b;"></p>
        <p style="margin:0 0 16px; font-size:13px; color:#64748b;">Tippe auf einen Tag – das Gericht wird dort eingetragen.</p>
        <div id="cookbookWeekSheetDays" style="display:flex; gap:10px; flex-wrap:wrap;"></div>
        <button type="button" class="btn secondary" style="width:100%; min-height:48px; margin-top:20px; border-radius:14px;" onclick="closeCookbookWeekSheet()">Schließen</button>
      </div>
    </div>

    <!-- FAB wird nur auf Dashboard per JS in main eingefügt; auf anderen Anbieter-Seiten nicht im DOM -->

    <!-- Wochenplan: Quick-Add Bottom-Sheet (Top 5 + Suche, Tap = zum Plan) -->
    <div class="backdrop" id="weekAddSheetBd" style="display:none; background:rgba(0,0,0,0.5);" onclick="closeWeekAddSheet()"></div>
    <div class="sheet sheet--kitchen" id="weekAddSheet" style="max-width:480px; border-radius:28px 28px 0 0; overflow:hidden; z-index:1100;">
      <div class="handle"></div>
      <div class="sheet-body" style="padding:20px 20px calc(24px + env(safe-area-inset-bottom));">
        <!-- Auswahl bei leerem Tag: zuerst "Aus Kochbuch" oder "Neues Gericht" (Frage 3 B) -->
        <div id="weekAddSheetChooser" style="display:none;">
          <div style="font-size:18px; font-weight:900; color:#1a1a1a; margin-bottom:8px;">Gericht hinzufügen</div>
          <p class="hint" style="margin-bottom:16px; font-size:13px; color:#64748b;">Woher soll das Gericht kommen?</p>
          <button type="button" class="btn primary" id="btnWeekAddFromCookbook" style="width:100%; min-height:52px; margin-bottom:12px; border-radius:14px; font-size:15px; font-weight:700;">Aus Kochbuch wählen</button>
          <button type="button" class="btn secondary" id="btnWeekAddNewDish" style="width:100%; min-height:52px; border-radius:14px; font-size:15px; font-weight:700; border:1px solid #FFDE00; color:#1a1a1a; background:transparent;">Neues Gericht anlegen</button>
        </div>
        <div id="weekAddSheetListWrap">
          <div id="weekAddSheetTitle" style="font-size:18px; font-weight:900; color:#1a1a1a; margin-bottom:8px;">Gericht zum Plan hinzufügen</div>
          <p class="hint" id="weekAddSheetHint" style="margin-bottom:12px; font-size:13px; color:#64748b;">Tap = sofort in den Wochenplan</p>
          <div style="font-size:12px; font-weight:800; color:#64748b; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:8px;">Schnell hinzufügen</div>
          <input type="search" id="weekAddSheetSearch" placeholder="… oder suchen" style="width:100%; padding:14px 16px; border:1px solid #e5e7eb; border-radius:14px; font-size:15px; margin-bottom:16px; box-sizing:border-box;" />
          <div id="weekAddSheetList" style="display:grid; grid-template-columns:repeat(2, 1fr); gap:12px; max-height:50vh; overflow-y:auto; -webkit-overflow-scrolling:touch;"></div>
          <button type="button" class="btn secondary" style="width:100%; min-height:48px; margin-top:12px; border-radius:14px; font-size:14px; font-weight:700; border:1px solid #FFDE00; color:#1a1a1a; background:transparent;" id="btnWeekAddMulti">Gericht auf mehrere Tage setzen</button>
          <button type="button" class="btn secondary" style="width:100%; min-height:48px; margin-top:16px; border-radius:14px;" onclick="closeWeekAddSheet()">Schließen</button>
        </div>
      </div>
    </div>

    <!-- Wochenplan: Zeit-Overlay (Abholzeit setzen – Karte „scharf“) -->
    <div class="backdrop" id="weekTimeOverlayBd" style="display:none; background:rgba(0,0,0,0.5); z-index:1101;" onclick="closeWeekTimeOverlay()"></div>
    <div class="sheet sheet--kitchen" id="weekTimeOverlay" style="max-width:400px; border-radius:20px 20px 0 0; overflow:hidden; z-index:1102;">
      <div class="handle"></div>
      <div class="sheet-body" style="padding:20px 20px calc(24px + env(safe-area-inset-bottom));">
        <h3 style="margin:0 0 8px; font-size:18px; font-weight:800; color:#1a1a1a;">Abholzeit setzen</h3>
        <p style="margin:0 0 20px; font-size:14px; color:#6B7280;">Erst mit Zeitfenster ist die Karte für den Tag freigegeben.</p>
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
          <div style="flex:1;"><label style="display:block; font-size:11px; font-weight:700; color:#9ca3af; margin-bottom:6px; text-transform:uppercase;">Start</label><select id="weekTimeOverlayStart" style="width:100%; height:48px; padding:0 12px; border:2px solid #E5E7EB; border-radius:12px; font-size:15px; font-weight:700; background:#fff; color:#1a1a1a; cursor:pointer;"></select></div>
          <span style="color:#9ca3af; font-weight:800;">–</span>
          <div style="flex:1;"><label style="display:block; font-size:11px; font-weight:700; color:#9ca3af; margin-bottom:6px; text-transform:uppercase;">Ende</label><select id="weekTimeOverlayEnd" style="width:100%; height:48px; padding:0 12px; border:2px solid #E5E7EB; border-radius:12px; font-size:15px; font-weight:700; background:#fff; color:#1a1a1a; cursor:pointer;"></select></div>
        </div>
        <button type="button" id="weekTimeOverlaySave" style="width:100%; min-height:52px; border-radius:16px; font-size:16px; font-weight:800; border:none; background:#22C55E; color:#fff; cursor:pointer;">Speichern</button>
        <button type="button" class="btn secondary" style="width:100%; min-height:48px; margin-top:12px; border-radius:14px;" onclick="closeWeekTimeOverlay()">Abbrechen</button>
      </div>
    </div>

    <!-- Kochbuch: Action-Sheet (Detailkarte: Bearbeiten oben gelb, Jetzt Inserieren unten blau) -->
    <div class="backdrop" id="cookbookActionSheetBd" style="display:none; background:rgba(0,0,0,0.5);" onclick="closeCookbookActionSheet()"></div>
    <div class="cookbook-action-sheet" id="cookbookActionSheet" style="display:none;">
      <div class="cookbook-action-sheet-handle"></div>
      <div class="cookbook-action-sheet-title" id="cookbookActionSheetTitle">Gericht</div>
      <button type="button" class="cookbook-action-sheet-btn cookbook-action-sheet-btn-yellow" id="cookbookActionEdit"><i data-lucide="edit"></i> Bearbeiten</button>
      <button type="button" class="cookbook-action-sheet-btn" id="cookbookActionWeek"><i data-lucide="calendar"></i> In den Wochenplan</button>
      <button type="button" class="cookbook-action-sheet-btn" id="cookbookActionSave"><i data-lucide="save"></i> Speichern</button>
      <button type="button" class="cookbook-action-sheet-btn" id="cookbookActionShare"><i data-lucide="share-2"></i> Teilen</button>
      <button type="button" class="cookbook-action-sheet-btn" id="cookbookActionPrint"><i data-lucide="printer"></i> Drucken</button>
      <button type="button" class="cookbook-action-sheet-btn cookbook-action-sheet-btn-primary" id="cookbookActionLive"><i data-lucide="zap"></i> Jetzt inserieren</button>
      <button type="button" class="cookbook-action-sheet-btn cookbook-action-sheet-btn-danger" id="cookbookActionDelete"><i data-lucide="trash-2"></i> Löschen</button>
      <button type="button" class="cookbook-action-sheet-btn" onclick="closeCookbookActionSheet()">Abbrechen</button>
    </div>

    <!-- Provider-Profil "Mein Profil" – Ebene 1: Business-Dashboard | Ebene 2: Zahnrad Einstellungen [Master-Prompt] -->
    <section class="view onboarding-view" id="v-provider-profile" style="display:flex; flex-direction:column; min-height:0; background:#F9FAFB;">
      <header id="providerProfileHeader" class="provider-profile-header-rebuild">
        <div id="providerProfileHeaderBrand" class="provider-profile-logo"><span class="logo-mittag">mittag</span><span class="logo-io">io</span></div>
        <button type="button" id="providerProfileGearBtn" class="provider-profile-gear-btn" aria-label="Einstellungen"><i data-lucide="settings" style="width:22px;height:22px;stroke:#6B7280;"></i></button>
      </header>

      <div id="providerProfileContent" class="provider-profile-content-rebuild">
        <!-- Horizontaler Slider: 7 Screens mit Snap-Effekt -->
        <div class="provider-profile-hero" id="providerProfileHero" aria-label="Profil-Slides">
          <div class="provider-profile-hero-slide">
            <div class="provider-profile-hero-icon-wrap">🍴</div>
            <span class="provider-profile-hero-badge">Screen 1</span>
            <h2 class="provider-profile-hero-slide-title">Vor Ort & Mehrweg</h2>
            <p class="provider-profile-hero-slide-sub">Gäste können bei dir essen oder in Mehrweg-Behältern mitnehmen. Einstellungen im Zahnrad.</p>
          </div>
          <div class="provider-profile-hero-slide">
            <div class="provider-profile-hero-icon-wrap">📋</div>
            <span class="provider-profile-hero-badge">Screen 2</span>
            <h2 class="provider-profile-hero-slide-title">Wochenplan</h2>
            <p class="provider-profile-hero-slide-sub">Plan deine Gerichte für die Woche. Einmal einrichten, jede Woche nutzen.</p>
          </div>
          <div class="provider-profile-hero-slide">
            <img src="https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60" alt="" class="provider-profile-hero-slide-img" />
            <div class="provider-profile-hero-slide-body">
              <span class="provider-profile-hero-badge">Inserat</span>
              <h2 class="provider-profile-hero-slide-title">Jetzt für 4,99 € inserieren</h2>
              <p class="provider-profile-hero-slide-sub">Kein Abo. Einmal pro Inserat – sofort sichtbar für Kunden in deiner Nähe.</p>
              <button type="button" id="btnProviderProfileInserierenHero" class="provider-profile-hero-cta provider-profile-hero-cta--yellow">Jetzt inserieren</button>
            </div>
          </div>
          <div class="provider-profile-hero-slide">
            <div class="provider-profile-hero-icon-wrap">🧾</div>
            <span class="provider-profile-hero-badge">Abholnummer</span>
            <h2 class="provider-profile-hero-slide-title">Digitale Abholnummer</h2>
            <p class="provider-profile-hero-slide-sub">Nur 0,89 € pro Vorgang. Schlange überspringen, sauber organisiert.</p>
          </div>
          <div class="provider-profile-hero-slide">
            <div class="provider-profile-hero-icon-wrap">📖</div>
            <span class="provider-profile-hero-badge">Screen 5</span>
            <h2 class="provider-profile-hero-slide-title">Digitales Kochbuch</h2>
            <p class="provider-profile-hero-slide-sub">Alle deine Gerichte an einem Ort. Schnell für den Wochenplan auswählen.</p>
          </div>
          <div class="provider-profile-hero-slide">
            <div class="provider-profile-hero-icon-wrap">📄</div>
            <span class="provider-profile-hero-badge">Screen 6</span>
            <h2 class="provider-profile-hero-slide-title">Abrechnung & Belege</h2>
            <p class="provider-profile-hero-slide-sub">PDF-Download für die Buchhaltung. Transparent und übersichtlich.</p>
          </div>
          <div class="provider-profile-hero-slide">
            <div class="provider-profile-hero-icon-wrap">ⓘ</div>
            <span class="provider-profile-hero-badge">Screen 7</span>
            <h2 class="provider-profile-hero-slide-title">Support & Hilfe</h2>
            <p class="provider-profile-hero-slide-sub">Fragen? Mike meldet sich garantiert innerhalb von 24h persönlich.</p>
          </div>
        </div>
        <!-- Drei Haupt-Kacheln: vertikaler Stack, 24px Abstand -->
        <div id="providerProfileMainWrap" class="provider-profile-tiles-wrap">
          <div id="providerProfileMain" class="provider-profile-main-rebuild">
            <article class="provider-focus-card provider-focus-card-inserat">
              <div class="provider-focus-card-img-wrap"><img src="https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60" alt="Mittagessen" /></div>
              <div class="provider-focus-card-pillars"><span title="Vor Ort">🍴</span><span title="Abholnummer">🧾</span><span title="Mehrweg">🔄</span></div>
              <p class="provider-focus-card-title">Jetzt für 4,99 € inserieren</p>
              <span class="provider-focus-badge provider-focus-badge-green">KEIN ABO. KEIN VERTRAG.</span>
              <button type="button" id="btnProviderProfileInserieren" class="provider-focus-btn provider-focus-btn-green">Jetzt inserieren</button>
            </article>
            <article class="provider-focus-card provider-focus-card-abholnummer">
              <div class="provider-focus-abholnummer-number">#B-42</div>
              <p class="provider-focus-card-title">Digitale Abholnummer</p>
              <p class="provider-focus-card-info">Nur 0,89 € pro Vorgang inkl. aller Gebühren.</p>
            </article>
            <article class="provider-focus-card provider-focus-card-abrechnung" role="button" tabindex="0" id="btnProviderProfileAbrechnung">
              <span class="provider-focus-card-icon">📄</span>
              <p class="provider-focus-card-title">Deine Abrechnungen &amp; PDF-Belege</p>
            </article>
          </div>
        </div>

        <!-- Einstellungsseite (Zahnrad): Identity + Karten + Danger Zone -->
      <div id="providerProfileSubSettings" class="provider-profile-sub" style="display:none; flex-direction:column; min-height:0; background:#F9FAFB;">
        <header class="provider-sub-header" style="background:#fff; padding:10px 20px 12px; padding-top:calc(10px + env(safe-area-inset-top, 0)); border-bottom:1px solid #e5e7eb; position:sticky; top:0; z-index:50; display:flex; align-items:center; gap:14px;">
          <button type="button" id="providerProfileBackSettings" aria-label="Zurück" style="width:44px; height:44px; border-radius:14px; background:transparent; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center;">
            <i data-lucide="chevron-left" style="width:22px; height:22px; color:#1a1a1a;"></i>
          </button>
          <h1 style="margin:0; font-size:18px; font-weight:950; letter-spacing:-0.03em; color:#1a1a1a;">Einstellungen</h1>
        </header>

        <div class="provider-settings-scroll provider-settings-scroll-rebuild" style="flex:1; overflow-y:auto; background:#F9FAFB;">
          <!-- Identity Section (wie Kundenseite: zentrales Logo, Name, Ort, Status) -->
          <div class="provider-settings-identity" style="text-align:center; padding:28px 20px 24px; background:#fff; border-radius:24px; box-shadow:0 2px 12px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04);">
            <div class="plogo" id="providerSettingsLogo" style="margin:0 auto 12px; background-size:cover; background-position:center; background-color:#f1f3f5;"></div>
            <h2 id="providerSettingsName" style="margin:0 0 4px; font-size:20px; font-weight:950; letter-spacing:-0.03em; color:#1a1a1a;">Betriebsname</h2>
            <p id="providerSettingsOrt" style="margin:0 0 12px; font-size:14px; color:#64748b;">Ort</p>
            <span style="display:inline-block; padding:6px 14px; border-radius:999px; font-size:12px; font-weight:800; color:#059669; background:rgba(5,150,105,0.12);">System Online</span>
          </div>

          <!-- Betriebsdaten-Karte (wird aus providerBusinessDataCardSlot hierher verschoben bei Einstellungen) -->
          <div id="providerBusinessDataCardSlotSettings" style="margin-bottom:20px;"></div>

          <!-- Kachel: Zeitfenster – 15-Minuten-Wheel-Picker [cite: 2026-01-29] -->
          <div class="provider-profile-card provider-settings-card" style="background:#fff; border-radius:24px; padding:24px; margin-bottom:20px; border:none; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
            <h3 style="margin:0 0 16px; font-size:17px; font-weight:800; color:#1a1a1a;">⏰ Mittagszeiten</h3>
            <p style="margin:0 0 16px; font-size:14px; color:#64748b; line-height:1.5;">Standard-Zeitfenster für neue Inserate (15-Minuten-Schritte).</p>
            <button type="button" id="providerSettingsTimeTrigger" class="provider-time-trigger time-picker-display" style="display:block; width:100%; border:none; cursor:pointer; font-family:inherit;">
              <span id="providerSettingsTimeDisplay" style="font-size:24px; font-weight:600; color:#22C55E;">11:30 – 14:00</span>
              <span style="display:block; margin-top:4px; font-size:12px; color:#6B7280;">Tippen zum Bearbeiten</span>
            </button>
            <div id="providerSettingsTimeWheelWrap" style="display:none; margin-top:16px; padding:16px; background:#F9FAFB; border-radius:12px;">
              <div style="display:flex; align-items:center; gap:12px;">
                <div style="flex:1;">
                  <label style="display:block; font-size:10px; font-weight:700; color:#6B7280; margin-bottom:6px; text-transform:uppercase;">Start</label>
                  <select id="providerSettingsMealStart" class="provider-time-wheel-select" style="width:100%; height:48px; padding:0 12px; border:none; border-bottom:2px solid #E5E7EB; border-radius:0; font-size:18px; font-weight:600; background:transparent; color:#22C55E; cursor:pointer;"></select>
                </div>
                <span style="color:#6B7280; font-weight:700;">–</span>
                <div style="flex:1;">
                  <label style="display:block; font-size:10px; font-weight:700; color:#6B7280; margin-bottom:6px; text-transform:uppercase;">Ende</label>
                  <select id="providerSettingsMealEnd" class="provider-time-wheel-select" style="width:100%; height:48px; padding:0 12px; border:none; border-bottom:2px solid #E5E7EB; border-radius:0; font-size:18px; font-weight:600; background:transparent; color:#22C55E; cursor:pointer;"></select>
                </div>
              </div>
            </div>
            <label style="display:block; font-size:10px; font-weight:700; color:#6B7280; margin-top:20px; margin-bottom:12px; text-transform:uppercase; letter-spacing:0.05em;">An welchen Tagen?</label>
            <div id="providerSettingsLunchWeekdays" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
          </div>

          <!-- Kachel: Service-Logik (3 Säulen) -->
          <div class="provider-profile-card provider-settings-card" style="background:#fff; border-radius:24px; overflow:hidden; margin-bottom:20px; border:none; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
            <h3 style="margin:0; padding:24px 24px 0; font-size:17px; font-weight:800; color:#1a1a1a;">🏗️ Service-Logik</h3>
            <div style="padding:20px; border-bottom:1px solid #f8f9fa; display:flex; justify-content:space-between; align-items:center;">
              <div style="display:flex; align-items:center; gap:16px;">
                <div style="width:44px; height:44px; border-radius:14px; background:#f1f3f5; display:flex; align-items:center; justify-content:center; font-size:22px;">🍴</div>
                <div>
                  <div style="font-weight:800; color:#1a1a1a; font-size:16px;">Vor Ort essen</div>
                  <div style="font-size:13px; color:#64748b;">Platz im Betrieb anbieten</div>
                </div>
              </div>
              <label class="toggle-switch"><input type="checkbox" id="providerSettingsDineInEnabled"><span class="toggle-slider"></span></label>
            </div>
            <div style="padding:20px; border-bottom:1px solid #f8f9fa; display:flex; justify-content:space-between; align-items:center;">
              <div style="display:flex; align-items:center; gap:16px;">
                <div style="width:44px; height:44px; border-radius:14px; background:#f1f3f5; display:flex; align-items:center; justify-content:center; font-size:22px;">🔄</div>
                <div>
                  <div style="font-weight:800; color:#1a1a1a; font-size:16px;">Mehrweg-System</div>
                  <div style="font-size:13px; color:#64748b;">Vytal, Recup oder eigenes</div>
                </div>
              </div>
              <label class="toggle-switch"><input type="checkbox" id="providerSettingsReuseEnabled"><span class="toggle-slider"></span></label>
            </div>
            <div style="padding:20px; border-bottom:1px solid #f8f9fa; display:flex; justify-content:space-between; align-items:center;">
              <div style="display:flex; align-items:center; gap:16px;">
                <div style="width:44px; height:44px; border-radius:14px; background:rgba(255,215,0,0.15); display:flex; align-items:center; justify-content:center; font-size:22px;">🧾</div>
                <div>
                  <div style="font-weight:800; color:#1a1a1a; font-size:16px;">Abholnummer</div>
                  <div style="font-size:13px; color:#64748b;">Weniger Chaos & mehr Zeit</div>
                </div>
              </div>
              <label class="toggle-switch"><input type="checkbox" id="providerSettingsAbholnummerEnabled"><span class="toggle-slider"></span></label>
            </div>
            <div style="padding:20px; display:flex; justify-content:space-between; align-items:center;">
              <div style="display:flex; align-items:center; gap:16px;">
                <div style="width:44px; height:44px; border-radius:14px; background:#f1f3f5; display:flex; align-items:center; justify-content:center; font-size:22px;">🌾</div>
                <div>
                  <div style="font-weight:800; color:#1a1a1a; font-size:16px;">Allergene angeben?</div>
                  <div style="font-size:13px; color:#64748b;">Standard für neue Inserate</div>
                </div>
              </div>
              <label class="toggle-switch"><input type="checkbox" id="providerSettingsWantsAllergensEnabled"><span class="toggle-slider"></span></label>
            </div>
          </div>

          <!-- Abrechnung & Support -->
          <div class="provider-settings-card provider-settings-card-rebuild" style="background:#fff; border-radius:16px; padding:20px; margin-bottom:20px; box-shadow:0 1px 3px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04);">
            <h3 style="margin:0 0 12px; font-size:15px; font-weight:800; color:#1a1a1a;">Abrechnung &amp; Support</h3>
            <button type="button" id="btnProviderBillingPortal" style="width:100%; min-height:48px; border-radius:16px; font-size:15px; font-weight:800; background:#22C55E; color:#fff; border:none; cursor:pointer; margin-bottom:12px;">Zahlungsmethoden</button>
            <button type="button" id="btnSettingsBillingArchive" class="provider-settings-row-chevron" style="width:100%; display:flex; justify-content:space-between; align-items:center; padding:14px 0; background:transparent; border:none; border-bottom:1px solid #f3f4f6; color:#1a1a1a; font-size:15px; font-weight:700; cursor:pointer; text-align:left;">
              <span>PDF-Archiv &amp; Belege</span><i data-lucide="chevron-right" style="width:20px; height:20px; color:#9ca3af;"></i>
            </button>
            <button type="button" id="btnSettingsSupportFooter" class="provider-settings-row-chevron" style="width:100%; display:flex; justify-content:space-between; align-items:center; padding:14px 0; background:transparent; border:none; color:#1a1a1a; font-size:15px; font-weight:700; cursor:pointer; text-align:left;">
              <span>Support &amp; FAQ</span><i data-lucide="chevron-right" style="width:20px; height:20px; color:#9ca3af;"></i>
            </button>
          </div>
          <!-- Rechtliches & Info (AGB, Datenschutz, Impressum) -->
          <div class="provider-settings-card provider-settings-card-rebuild" style="background:#fff; border-radius:16px; overflow:hidden; margin-bottom:20px; box-shadow:0 1px 3px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04);">
            <h3 style="margin:0; padding:20px 20px 8px; font-size:15px; font-weight:800; color:#1a1a1a;">Rechtliches &amp; Info</h3>
            <a href="#/agb" class="provider-settings-row-chevron" style="display:flex; justify-content:space-between; align-items:center; padding:14px 20px; color:#1a1a1a; font-size:15px; font-weight:700; text-decoration:none; border-bottom:1px solid #f3f4f6;"><span>AGB</span><i data-lucide="chevron-right" style="width:20px; height:20px; color:#9ca3af;"></i></a>
            <a href="#/datenschutz" class="provider-settings-row-chevron" style="display:flex; justify-content:space-between; align-items:center; padding:14px 20px; color:#1a1a1a; font-size:15px; font-weight:700; text-decoration:none; border-bottom:1px solid #f3f4f6;"><span>Datenschutz</span><i data-lucide="chevron-right" style="width:20px; height:20px; color:#9ca3af;"></i></a>
            <div class="provider-settings-row-chevron" style="display:flex; justify-content:space-between; align-items:center; padding:14px 20px; color:#1a1a1a; font-size:15px; font-weight:700; cursor:pointer;" id="btnProviderImpressum"><span>Impressum</span><i data-lucide="chevron-right" style="width:20px; height:20px; color:#9ca3af;"></i></div>
            <div id="providerImpressumContent" style="display:none; padding:16px 20px 20px; font-size:14px; color:#6B7280; line-height:1.6; border-top:1px solid #f3f4f6;">Mike Quach, Langäcker 2, 73635 Rudersberg</div>
          </div>
          <button type="button" id="btnProviderDeleteAccount" class="provider-footer-delete" style="display:block; width:100%; padding:16px; font-size:14px; font-weight:800; color:#dc2626; background:transparent; border:none; cursor:pointer; text-align:center;">
            Profil dauerhaft löschen
          </button>
        </div>
      </div>

        <!-- Sub-Seiten: App-like gleicher Stil wie Hauptansicht -->
      <div id="providerProfileSubBusiness" class="provider-profile-sub" style="display:none; flex-direction:column; min-height:0; background:#f8fafc;">
        <header class="provider-sub-header" style="background:#fff; padding:10px 20px 12px; padding-top:calc(10px + env(safe-area-inset-top, 0)); border-bottom:1px solid #f1f3f5; position:sticky; top:0; z-index:50; display:flex; align-items:center; gap:14px;">
          <button type="button" id="providerProfileBackBusiness" aria-label="Zurück" style="width:44px; height:44px; border-radius:14px; background:#f1f3f5; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center;">
            <i data-lucide="chevron-left" style="width:22px; height:22px; color:#1a1a1a;"></i>
          </button>
          <h1 style="margin:0; font-size:18px; font-weight:950; letter-spacing:-0.03em; color:#1a1a1a;">Meine Daten</h1>
        </header>
        <div style="padding:20px; flex:1; overflow-y:auto; max-width:500px; margin:0 auto; width:100%; box-sizing:border-box;">
          <p style="margin:0; font-size:15px; color:#64748b;">Betriebsdaten findest du in den <strong>Einstellungen</strong> (Zahnrad).</p>
        </div>
      </div>

      <!-- Sub-Seite: Präferenzen & Zeiten (Weiterleitung zu Einstellungen) -->
      <div id="providerProfileSubService" class="provider-profile-sub" style="display:none; flex-direction:column;">
        <header style="background:#fff; padding:24px 20px 20px; border-bottom:1px solid rgba(0,0,0,0.05); position:sticky; top:0; z-index:50; display:flex; align-items:center; gap:16px;">
          <button type="button" id="providerProfileBackService" aria-label="Zurück" style="width:40px; height:40px; border-radius:12px; background:#f8f9fa; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center;">
            <i data-lucide="chevron-left" style="width:24px; height:24px; color:#1a1a1a;"></i>
          </button>
          <h1 style="margin:0; font-size:20px; font-weight:950; letter-spacing:-0.03em; color:#1a1a1a;">Präferenzen & Zeiten</h1>
        </header>
        <div style="padding:24px 20px; flex:1; overflow-y:auto;">
          <p style="margin:0; font-size:15px; color:#64748b;">Zeiten und Service-Optionen findest du in den <strong>Einstellungen</strong> (Zahnrad).</p>
        </div>
      </div>

      <!-- Sub-Seite: Zahlung & Abrechnung -->
      <div id="providerProfileSubPayment" class="provider-profile-sub" style="display:none; flex-direction:column;">
        <header style="background:#fff; padding:24px 20px 20px; border-bottom:1px solid rgba(0,0,0,0.05); position:sticky; top:0; z-index:50; display:flex; align-items:center; gap:16px;">
          <button type="button" id="providerProfileBackPayment" aria-label="Zurück" style="width:40px; height:40px; border-radius:12px; background:#f8f9fa; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center;">
            <i data-lucide="chevron-left" style="width:24px; height:24px; color:#1a1a1a;"></i>
          </button>
          <h1 style="margin:0; font-size:20px; font-weight:950; letter-spacing:-0.03em; color:#1a1a1a;">Abrechnung</h1>
        </header>
        <div style="padding:24px 20px; flex:1;">
          <div style="background:#fff; border-radius:24px; padding:24px; border:1px solid rgba(0,0,0,0.04); box-shadow:0 4px 12px rgba(0,0,0,0.02); margin-bottom:20px;">
            <h3 style="margin:0 0 4px; font-size:17px; font-weight:800; color:#1a1a1a;">Zahlungsmethode</h3>
            <p style="margin:0 0 20px; font-size:14px; color:#64748b;">Für Inseratsgebühren (4,99 € pro Inserat).</p>
            <div id="providerStripeStatus" style="padding:16px; border-radius:16px; background:#f8f9fa; border:2px solid #f1f3f5; margin-bottom:16px; font-size:14px; font-weight:600; color:#64748b; display:flex; align-items:center; gap:10px;">
              <i data-lucide="credit-card" style="width:20px; height:20px;"></i>
              <span>Keine Methode hinterlegt</span>
            </div>
            <button type="button" id="btnProviderBillingPortal" style="width:100%; height:56px; background:var(--brand); color:#fff; border:none; border-radius:18px; font-weight:800; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;">
              <span>Stripe Dashboard öffnen</span>
              <i data-lucide="external-link" style="width:20px; height:20px;"></i>
            </button>
          </div>

          <div style="background:#fff; border-radius:24px; padding:24px; border:1px solid rgba(0,0,0,0.04); box-shadow:0 4px 12px rgba(0,0,0,0.02);">
            <h3 style="margin:0 0 8px; font-size:17px; font-weight:800; color:#1a1a1a;">Rechnungsverlauf</h3>
            <p style="margin:0 0 20px; font-size:14px; color:#64748b; line-height:1.5;">Chronologische Liste mit PDF-Download für die Buchhaltung.</p>
            <button type="button" id="btnBillingArchive" style="width:100%; display:flex; justify-content:space-between; align-items:center; padding:16px 20px; background:#f8f9fa; border:2px solid #f1f3f5; border-radius:16px; color:#1a1a1a; font-size:16px; font-weight:700; cursor:pointer;">
              <span>Rechnungsarchiv</span>
              <i data-lucide="chevron-right" style="width:20px; height:20px; color:#cbd5e1;"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Sub-Seite: Support & Hilfe (Self-Service: Erste Hilfe + Was ist was + Mike kontaktieren) -->
      <div id="providerProfileSubFaq" class="provider-profile-sub provider-support-page" style="display:none; flex-direction:column; min-height:0; background:#F9FAFB;">
        <header style="background:#fff; padding:12px 20px; padding-top:calc(12px + env(safe-area-inset-top, 0)); border-bottom:1px solid #E5E7EB; position:sticky; top:0; z-index:50; display:flex; align-items:center; gap:14px;">
          <button type="button" id="providerProfileBackFaq" aria-label="Zurück" style="width:44px; height:44px; border-radius:14px; background:transparent; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center;">
            <i data-lucide="chevron-left" style="width:22px; height:22px; color:#1a1a1a;"></i>
          </button>
          <h1 style="margin:0; font-size:18px; font-weight:950; letter-spacing:-0.03em; color:#1a1a1a;">Support &amp; Hilfe</h1>
        </header>
        <div class="provider-support-scroll" style="flex:1; overflow-y:auto; padding:20px; padding-bottom:calc(24px + env(safe-area-inset-bottom));">
          <!-- Bereich 1: Erste Hilfe (klickbare Fehlerquellen) -->
          <h2 class="provider-support-section-title">Erste Hilfe</h2>
          <div class="provider-support-error-cards">
            <button type="button" class="provider-support-error-card" data-issue="standort" data-subject="Standort">
              <span class="provider-support-error-icon">📍</span>
              <span class="provider-support-error-label">Fehler: Standort</span>
            </button>
            <button type="button" class="provider-support-error-card" data-issue="zahlung" data-subject="Zahlung">
              <span class="provider-support-error-icon">💳</span>
              <span class="provider-support-error-label">Fehler: Zahlung</span>
            </button>
            <button type="button" class="provider-support-error-card" data-issue="abholnummer" data-subject="Abholnummer">
              <span class="provider-support-error-icon">🧾</span>
              <span class="provider-support-error-label">Fehler: Abholnummer</span>
            </button>
            <button type="button" class="provider-support-error-card" data-issue="sichtbarkeit" data-subject="Sichtbarkeit">
              <span class="provider-support-error-icon">👁️</span>
              <span class="provider-support-error-label">Fehler: Sichtbarkeit</span>
            </button>
          </div>
          <div id="providerSupportSolution" class="provider-support-solution-box" style="display:none;">
            <p id="providerSupportSolutionText" class="provider-support-solution-text"></p>
            <button type="button" id="providerSupportAbholungenBtn" class="provider-support-mail-btn" style="display:none; margin-bottom:8px;">Abholungen anzeigen</button>
            <button type="button" id="providerSupportMailBtn" class="provider-support-mail-btn">Per E-Mail an Mike melden</button>
          </div>

          <!-- Bereich 2: Was ist was (FAQ Accordion) -->
          <h2 class="provider-support-section-title">Was ist was?</h2>
          <div class="provider-support-accordion">
            <div class="provider-support-accordion-item">
              <button type="button" class="provider-support-accordion-trigger" aria-expanded="false"><span>Was sind intelligente Allergene?</span><i data-lucide="chevron-down" class="chevron-icon" style="width:20px;height:20px;"></i></button>
              <div class="accordion-content"><p>Intelligente Allergene: Beim Anlegen eines Gerichts schlägt die App automatisch passende Allergene vor (Autovervollständigung). Du wählst nur aus, was zutrifft – Kunden sehen es sofort in der Gerichtsbeschreibung.</p></div>
            </div>
            <div class="provider-support-accordion-item">
              <button type="button" class="provider-support-accordion-trigger" aria-expanded="false"><span>Was ist die „Live-Vorschau“?</span><i data-lucide="chevron-down" class="chevron-icon" style="width:20px;height:20px;"></i></button>
              <div class="accordion-content"><p>Sobald du ein Inserat veröffentlichst, siehst du in deinem Profil sofort die „Live-Vorschau“. Das ist die exakte Ansicht, die auch deine Kunden auf dem Handy sehen. So kannst du jederzeit prüfen, ob Bild und Preis perfekt sitzen.</p></div>
            </div>
            <div class="provider-support-accordion-item">
              <button type="button" class="provider-support-accordion-trigger" aria-expanded="false"><span>Was ist die „24h-Antwort-Garantie“?</span><i data-lucide="chevron-down" class="chevron-icon" style="width:20px;height:20px;"></i></button>
              <div class="accordion-content"><p>Wenn du über den Hilfe-Button eine Nachricht schickst, landet diese direkt bei Mike. Wir garantieren dir eine persönliche Antwort innerhalb von 24 Stunden – meistens sogar viel schneller, damit dein Mittagsgeschäft reibungslos weiterläuft.</p></div>
            </div>
            <div class="provider-support-accordion-item">
              <button type="button" class="provider-support-accordion-trigger" aria-expanded="false"><span>Was ist die „Favoriten-Statistik“?</span><i data-lucide="chevron-down" class="chevron-icon" style="width:20px;height:20px;"></i></button>
              <div class="accordion-content"><p>Unter deinen „Quick Stats“ siehst du, wie viele Kunden dich als Favoriten markiert haben. Das sind deine Stammkunden von morgen. Je höher diese Zahl, desto mehr Leute werden automatisch benachrichtigt, sobald du ein neues Inserat schaltest.</p></div>
            </div>
            <div class="provider-support-accordion-item">
              <button type="button" class="provider-support-accordion-trigger" aria-expanded="false"><span>Wie funktioniert der Wochenplan?</span><i data-lucide="chevron-down" class="chevron-icon" style="width:20px;height:20px;"></i></button>
              <div class="accordion-content"><p>Im Wochenplan planst du deine Gerichte für Mo–So. Du kannst ein Gericht per „Folgetag“ auf den nächsten Tag kopieren. Einmal einrichten, jede Woche nutzen – ohne Copy-Chaos.</p></div>
            </div>
            <div class="provider-support-accordion-item">
              <button type="button" class="provider-support-accordion-trigger" aria-expanded="false"><span>Kostentransparenz</span><i data-lucide="chevron-down" class="chevron-icon" style="width:20px;height:20px;"></i></button>
              <div class="accordion-content"><p>Kein Abo, kein Vertrag. 4,99 € pro Inserat. Optional 0,89 € pro Abholnummer. Ende.</p></div>
            </div>
            <div class="provider-support-accordion-item">
              <button type="button" class="provider-support-accordion-trigger" aria-expanded="false"><span>Was ist das digitale Kochbuch?</span><i data-lucide="chevron-down" class="chevron-icon" style="width:20px;height:20px;"></i></button>
              <div class="accordion-content"><p>Dein digitales Kochbuch ist die Sammlung aller Gerichte, die du jemals angelegt hast. Von hier aus wählst du schnell aus, was du in den Wochenplan oder als Inserat schalten möchtest – ohne jedes Mal neu einzugeben.</p></div>
            </div>
            <div class="provider-support-accordion-item">
              <button type="button" class="provider-support-accordion-trigger" aria-expanded="false"><span>Was ist die Ein-Session-Regel?</span><i data-lucide="chevron-down" class="chevron-icon" style="width:20px;height:20px;"></i></button>
              <div class="accordion-content"><p>Im Standard-Plan ist immer nur ein Gerät pro Account angemeldet. Meldest du dich woanders an, wird die vorherige Sitzung beendet. So bleibt dein Küchenmodus sicher. Für mehrere Geräte gleichzeitig gibt es ein Team-Upgrade.</p></div>
            </div>
          </div>

          <!-- Rechtliche Links (saubere Liste mit Chevrons) [cite: 2026-01-29] -->
          <h2 class="provider-support-section-title" style="margin-top:24px;">Rechtliches</h2>
          <div class="provider-support-legal-links">
            <a href="#/agb" class="provider-support-legal-row"><span>AGB</span><i data-lucide="chevron-right" style="width:20px;height:20px;color:#9ca3af;"></i></a>
            <a href="#/datenschutz" class="provider-support-legal-row"><span>Datenschutz</span><i data-lucide="chevron-right" style="width:20px;height:20px;color:#9ca3af;"></i></a>
            <a href="#/impressum" class="provider-support-legal-row"><span>Impressum</span><i data-lucide="chevron-right" style="width:20px;height:20px;color:#9ca3af;"></i></a>
          </div>

          <!-- Mike kontaktieren (24h-Garantie) -->
          <div class="provider-support-contact-block">
            <button type="button" id="btnProviderSupportMike" class="provider-support-mike-btn">Mike kontaktieren</button>
            <p class="provider-support-mike-hint">E-Mail an support@mittagio.de – Mike meldet sich garantiert innerhalb von 24h persönlich.</p>
          </div>
        </div>
      </div>
      </div>
    </section>

    <!-- STATISCHE RECHTSTEXTE-SEITEN: KUNDEN -->
    <section class="view" id="v-legal-impressum">
      <div class="panel">
        <h1 style="font-size:24px; font-weight:900; margin-bottom:20px;">Impressum</h1>
        <div style="line-height:1.8; font-size:15px;">
          <p>
            <strong>Betreiber:</strong> Mike Quach<br>
            <strong>Adresse:</strong> Langäcker 2, 73635 Rudersberg<br>
            <strong>Kontakt:</strong> <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a>
          </p>
          <p style="margin-top:20px; padding-top:20px; border-top:1px solid #eee; font-size:13px; color:#666;">
            <strong>Plattformhinweis:</strong><br>
            Mittagio vermittelt Mittagsangebote lokaler Anbieter. Vertragspartner bei Bestellungen ist ausschließlich der jeweilige Anbieter.
          </p>
        </div>
        <div style="margin-top:24px; padding-top:16px; border-top:1px solid #eee; text-align:center; font-size:13px; color:#94a3b8;">
          mittagio • made with ❤️ in Rudersberg
        </div>
        <button class="btn ghost btn-back" type="button" onclick="goBackFromLegalPage()" style="margin-top:20px; width:100%;"><i data-lucide="chevron-left" style="width:18px;height:18px;"></i> Zurück</button>
      </div>
    </section>

    <!-- Impressum für Anbieter: einheitlich helles Layout -->
    <section class="view" id="v-legal-impressum-provider" style="min-height:100vh; padding:20px; padding-bottom:90px;">
      <div class="panel" style="padding:20px; border-radius:16px; box-shadow:0 2px 12px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.06);">
        <h1 style="font-size:24px; font-weight:900; margin-bottom:20px; color:#1a1a1a;">Impressum</h1>
        <div style="line-height:1.8; font-size:15px; color:#334155;">
          <p>
            <strong>Betreiber:</strong> Mike Quach<br>
            <strong>Adresse:</strong> Langäcker 2, 73635 Rudersberg<br>
            <strong>Kontakt:</strong> <a href="mailto:info@mittagio.de" style="color:#0A84FF;">info@mittagio.de</a>
          </p>
          <p style="margin-top:20px; padding-top:20px; border-top:1px solid rgba(0,0,0,0.08); font-size:13px; color:#64748b;">
            <strong>Plattformhinweis:</strong><br>
            Mittagio ist eine Vermittlungsplattform für lokale Gastronomie. Als Anbieter nutzt du unsere digitale Infrastruktur zur Verwaltung deiner Mittagsangebote und zur Abwicklung von Online-Bestellungen.
          </p>
        </div>
        <div style="margin-top:24px; padding-top:16px; border-top:1px solid rgba(0,0,0,0.08); text-align:center; font-size:13px; color:#64748b;">
          made with ❤️ by mittagio.de
        </div>
        <button class="btn ghost btn-back" type="button" onclick="goBackFromLegalPage()" style="margin-top:20px; width:100%;"><i data-lucide="chevron-left" style="width:18px;height:18px;"></i> Zurück</button>
      </div>
    </section>

    <!-- AGB für Kunden -->
    <section class="view" id="v-legal-agb-kurz">
      <div class="panel">
        <h1 style="font-size:24px; font-weight:900; margin-bottom:20px;">AGB (Kunden)</h1>
        <div style="line-height:1.8; font-size:15px;">
          <p><strong>Mittagio ist Plattform, nicht Verkäufer</strong></p>
          <p>Mittagio vermittelt Mittagsangebote lokaler Anbieter. Vertragspartner bei Bestellungen ist ausschließlich der jeweilige Anbieter.</p>
          
          <p style="margin-top:20px;"><strong>Bestellung & Zahlung:</strong></p>
          <p>Du bestellst direkt beim Anbieter über unsere Plattform. Die Zahlung erfolgt sicher online. Nach erfolgreicher Zahlung erhältst du deine Abholnummer.</p>
          
          <p style="margin-top:20px;"><strong>Abholnummer:</strong></p>
          <p>Die Abholnummer dient als Zahlungs- & Abholnachweis. Zeige sie beim Abholen vor, um dein Essen zu erhalten.</p>
          
          <p style="margin-top:20px;"><strong>Stornierung:</strong></p>
          <p>Stornierungen sind bis zu einer bestimmten Frist vor der Abholzeit möglich. Details findest du in der Bestellübersicht.</p>
          
          <p style="margin-top:20px;"><strong>Verantwortung:</strong></p>
          <p>Der Anbieter ist verantwortlich für Speisen, Preise und gesetzliche Vorgaben. Mittagio übernimmt keine Haftung für die Qualität der Speisen.</p>
          
          <p style="margin-top:20px;"><strong>Support:</strong></p>
          <p>Kunden-Hilfe: <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a></p>
        </div>
        <div style="margin-top:24px; padding-top:16px; border-top:1px solid #eee; text-align:center; font-size:13px; color:#94a3b8;">
          mittagio • made with ❤️ in Rudersberg
        </div>
        <button class="btn ghost btn-back" type="button" onclick="goBackFromLegalPage()" style="margin-top:20px; width:100%;"><i data-lucide="chevron-left" style="width:18px;height:18px;"></i> Zurück</button>
      </div>
    </section>

    <!-- AGB für Anbieter: einheitlich helles Layout -->
    <section class="view" id="v-legal-agb-provider" style="min-height:100vh; padding:20px; padding-bottom:90px;">
      <div style="margin-bottom:24px; display:flex; align-items:center; gap:12px;">
        <button type="button" onclick="goBackFromLegalPage()" aria-label="Zurück" style="width:40px; height:40px; border-radius:50%; background:#fff; border:none; box-shadow:0 2px 8px rgba(0,0,0,0.08); cursor:pointer; display:flex; align-items:center; justify-content:center;"><i data-lucide="chevron-left" style="width:22px; height:22px; color:#1a1a1a;"></i></button>
        <h1 style="margin:0; font-size:22px; font-weight:800; color:#1a1a1a; letter-spacing:-0.02em;">AGB (Anbieter)</h1>
      </div>
      <p style="margin:0 0 20px; font-size:14px; color:#8e8e93;">Klick auf eine Zeile öffnet den rechtlichen Text.</p>
      <div id="agbProviderAccordion" style="display:flex; flex-direction:column; gap:12px;">
        <details class="agb-provider-item" style="background:#fff; border-radius:16px; overflow:hidden; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
          <summary style="padding:18px 20px; font-size:16px; font-weight:600; color:#1a1a1a; cursor:pointer; list-style:none; display:flex; align-items:center; gap:10px;"><span style="color:#8e8e93;">§ 1</span> Geltungsbereich &amp; Plattform-Modell</summary>
          <div style="padding:0 20px 20px; font-size:15px; line-height:1.7; color:#3a3a3c;">
            <p style="margin:0 0 12px;">Wir bieten eine Plattform zur Vermittlung von Mahlzeiten für Gastronomie und Handwerk an.</p>
            <p style="margin:0;">Ziel ist die Maximierung deines Umsatzes durch effiziente Inserate. Eine Nutzung als reines Informationstool ohne Verkaufsabsicht ist nicht gestattet.</p>
          </div>
        </details>
        <details class="agb-provider-item" style="background:#fff; border-radius:16px; overflow:hidden; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
          <summary style="padding:18px 20px; font-size:16px; font-weight:600; color:#1a1a1a; cursor:pointer; list-style:none; display:flex; align-items:center; gap:10px;"><span style="color:#8e8e93;">§ 2</span> Inserate &amp; Kosten (Das 4,99 € Modell)</summary>
          <div style="padding:0 20px 20px; font-size:15px; line-height:1.7; color:#3a3a3c;">
            <p style="margin:0 0 12px;"><strong>Fixpreis:</strong> Jedes Inserat wird mit einer Pauschale von 4,99 € berechnet.</p>
            <p style="margin:0 0 12px;"><strong>Zusatzleistung:</strong> Die Abholnummer kann für 0,89 € pro Vorgang optional hinzugebucht werden. Dieser Preis deckt alle Transaktionsgebühren ab.</p>
            <p style="margin:0 0 12px;"><strong>Fälligkeit:</strong> Die Gebühr wird mit Veröffentlichung des Inserats fällig.</p>
            <p style="margin:0 0 12px;"><strong>Kein Abo. Kein Vertrag.</strong> Die Nutzung erfolgt ohne vertragliche Mindestlaufzeit. Jede Inseratsgebühr (4,99 €) ist eine Einzeltransaktion.</p>
            <p style="margin:0;"><strong>Jederzeit flexibel:</strong> Du kannst die App jederzeit deinstallieren oder dein Profil löschen, ohne Kündigungsfristen beachten zu müssen.</p>
          </div>
        </details>
        <details class="agb-provider-item" style="background:#fff; border-radius:16px; overflow:hidden; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
          <summary style="padding:18px 20px; font-size:16px; font-weight:600; color:#1a1a1a; cursor:pointer; list-style:none; display:flex; align-items:center; gap:10px;"><span style="color:#8e8e93;">§ 3</span> Zeitfenster-Logik (Keine Bestandsführung)</summary>
          <div style="padding:0 20px 20px; font-size:15px; line-height:1.7; color:#3a3a3c;">
            <p style="margin:0 0 12px;"><strong>Mittags-Fokus:</strong> Inserate sind streng an das gewählte Mittags-Zeitfenster gebunden.</p>
            <p style="margin:0;"><strong>Automatisierung:</strong> Das Angebot endet automatisch mit Ablauf der Endzeit. Eine manuelle Bestandsführung (Stückzahlen) ist systemseitig nicht vorgesehen.</p>
          </div>
        </details>
        <details class="agb-provider-item" style="background:#fff; border-radius:16px; overflow:hidden; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
          <summary style="padding:18px 20px; font-size:16px; font-weight:600; color:#1a1a1a; cursor:pointer; list-style:none; display:flex; align-items:center; gap:10px;"><span style="color:#8e8e93;">§ 4</span> Die 3 Säulen &amp; Emoji-Regeln</summary>
          <div style="padding:0 20px 20px; font-size:15px; line-height:1.7; color:#3a3a3c;">
            <p style="margin:0 0 12px;">Der Anbieter ist für die korrekte Kennzeichnung verantwortlich:</p>
            <ul style="margin:0 0 12px; padding-left:20px;">
              <li><strong>🍴 Vor Ort essen:</strong> Optionaler Toggle.</li>
              <li><strong>🔄 Mehrweg:</strong> Nachhaltigkeits-Toggle.</li>
              <li><strong>🧾 Abholnummer:</strong> Zusatzservice für 0,89 €.</li>
            </ul>
            <p style="margin:0;"><strong>Wording:</strong> Die Verwendung der Begriffe „Ticket“ oder „Abholcode“ ist untersagt. Es gilt ausschließlich die Abholnummer.</p>
          </div>
        </details>
        <details class="agb-provider-item" style="background:#fff; border-radius:16px; overflow:hidden; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
          <summary style="padding:18px 20px; font-size:16px; font-weight:600; color:#1a1a1a; cursor:pointer; list-style:none; display:flex; align-items:center; gap:10px;"><span style="color:#8e8e93;">§ 5</span> Account-Sicherheit &amp; Session-Limit</summary>
          <div style="padding:0 20px 20px; font-size:15px; line-height:1.7; color:#3a3a3c;">
            <p style="margin:0 0 12px;"><strong>Single-Session:</strong> Um die Integrität des Systems zu wahren, ist nur eine aktive Sitzung pro Account erlaubt. Bei Anmeldung auf einem neuen Gerät wird die bestehende Sitzung nach Bestätigung beendet.</p>
            <p style="margin:0;"><strong>Löschung:</strong> Das Konto kann jederzeit im Profil gelöscht werden. Mit der Löschung enden alle aktiven Inserate sofort.</p>
          </div>
        </details>
        <details class="agb-provider-item" style="background:#fff; border-radius:16px; overflow:hidden; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
          <summary style="padding:18px 20px; font-size:16px; font-weight:600; color:#1a1a1a; cursor:pointer; list-style:none; display:flex; align-items:center; gap:10px;"><span style="color:#8e8e93;">§ 6</span> Datenschutz &amp; Standort (Silicon Valley Standard)</summary>
          <div style="padding:0 20px 20px; font-size:15px; line-height:1.7; color:#3a3a3c;">
            <p style="margin:0 0 12px;"><strong>Geodaten:</strong> Wir nutzen deinen Standort nur, um Kunden im Umkreis dein Angebot anzuzeigen.</p>
            <p style="margin:0;"><strong>Transparenz:</strong> Es erfolgt kein Tracking der Nutzer außerhalb der App-Nutzung. Daten werden nicht an Dritte verkauft.</p>
          </div>
        </details>
      </div>
      <!-- Globaler Footer (Big Tech Design) – Ende jeder rechtlichen Seite -->
      <footer style="margin-top:32px; padding:24px; background:#fff; border-radius:16px; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
        <h2 style="margin:0 0 12px; font-size:14px; font-weight:700; color:#8e8e93; text-transform:uppercase; letter-spacing:0.05em;">Impressum</h2>
        <p style="margin:0; font-size:15px; line-height:1.6; color:#3a3a3c;">
          <strong>Betreiber:</strong> Mike Quach<br>
          <strong>Anschrift:</strong> Langäcker 2, 73635 Rudersberg<br>
          <strong>Kontakt:</strong> <a href="mailto:info@mittagio.de" style="color:#007aff; text-decoration:none;">info@mittagio.de</a>
        </p>
      </footer>
    </section>

    <!-- FAQ mit Reitern (Kunden & Anbieter) -->
    <section class="view" id="v-legal-faq" style="background:#F7F6F0; min-height:100vh; padding:20px; padding-bottom:90px;">
      <div class="panel" style="padding:0; overflow:hidden;">
        <h1 style="font-size:24px; font-weight:900; margin:20px 20px 0; padding-bottom:20px;">FAQ</h1>
        
        <!-- Reiter (Tabs) -->
        <div style="display:flex; border-bottom:2px solid #eee; background:#fff;">
          <button class="faq-tab-btn" id="faqTabCustomer" onclick="switchFaqTab('customer')" style="flex:1; padding:16px; background:#fff; border:none; border-bottom:3px solid #FFD700; font-weight:700; font-size:15px; color:#334155; cursor:pointer;">
            Für Kunden
          </button>
          <button class="faq-tab-btn" id="faqTabProvider" onclick="switchFaqTab('provider')" style="flex:1; padding:16px; background:#f9f9f9; border:none; border-bottom:3px solid transparent; font-weight:600; font-size:15px; color:#666; cursor:pointer;">
            Für Anbieter
          </button>
        </div>
        
        <!-- FAQ-Inhalt: Kunden (Accordion – Tippen = Ausklappen) -->
        <div id="faqContentCustomer" style="display:block; padding:20px; line-height:1.8; font-size:15px;">
          <button type="button" onclick="typeof openAbholnummerExplainSheet==='function'&&openAbholnummerExplainSheet()" style="width:100%; margin-bottom:20px; padding:18px 20px; background:linear-gradient(135deg, rgba(255,215,0,0.15) 0%, rgba(255,215,0,0.08) 100%); border:2px solid rgba(255,215,0,0.4); border-radius:16px; text-align:left; cursor:pointer; display:flex; align-items:center; gap:14px;">
            <span style="font-size:28px;">🧾</span>
            <div>
              <div style="font-size:16px; font-weight:800; color:#1a1a1a;">So funktioniert die Abholnummer</div>
              <div style="font-size:13px; color:#64748b; margin-top:2px;">5 kurze Schritte – mit Bildern</div>
            </div>
            <i data-lucide="chevron-right" style="width:20px;height:20px;color:#94a3b8;margin-left:auto;"></i>
          </button>
          <h2 style="font-size:16px; font-weight:800; margin:0 0 12px; color:#1a1a1a; text-transform:uppercase; letter-spacing:0.5px;">Bestellungen &amp; Bezahlung</h2>
          <details style="background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.06); overflow:hidden; margin-bottom:8px;">
            <summary style="padding:14px 16px; font-size:15px; font-weight:700; color:#2D3436; cursor:pointer; list-style:none;">Muss ich mich registrieren?</summary>
            <p style="margin:0; padding:0 16px 16px; font-size:15px; color:#666;">Ja, damit wir deine Abholnummer sicher zuordnen und dir deine Bestellhistorie anzeigen können.</p>
          </details>
          <details style="background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.06); overflow:hidden; margin-bottom:8px;">
            <summary style="padding:14px 16px; font-size:15px; font-weight:700; color:#2D3436; cursor:pointer; list-style:none;">Wie bezahle ich mein Essen?</summary>
            <p style="margin:0; padding:0 16px 16px; font-size:15px; color:#666;">Die Bezahlung erfolgt digital direkt über die Plattform, damit du vor Ort keine Wartezeit an der Kasse hast.</p>
          </details>
          <details style="background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.06); overflow:hidden; margin-bottom:16px;">
            <summary style="padding:14px 16px; font-size:15px; font-weight:700; color:#2D3436; cursor:pointer; list-style:none;">Kann ich eine Bestellung stornieren?</summary>
            <p style="margin:0; padding:0 16px 16px; font-size:15px; color:#666;">Da die Mahlzeiten frisch für dich vorbereitet werden, ist eine Stornierung nach Ablauf des Zeitfensters leider nicht möglich.</p>
          </details>
          <h2 style="font-size:16px; font-weight:800; margin:0 0 12px; color:#1a1a1a; text-transform:uppercase; letter-spacing:0.5px;">Anbieter &amp; Auswahl</h2>
          <details style="background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.06); overflow:hidden; margin-bottom:8px;">
            <summary style="padding:14px 16px; font-size:15px; font-weight:700; color:#2D3436; cursor:pointer; list-style:none;">Warum sehe ich keine Mehrweg-Option bei meinem Anbieter?</summary>
            <p style="margin:0; padding:0 16px 16px; font-size:15px; color:#666;">Wir arbeiten daran, dass bald alle Partner Mehrweg anbieten. Aktuell liegt die Entscheidung noch beim jeweiligen Anbieter.</p>
          </details>
          <details style="background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.06); overflow:hidden; margin-bottom:16px;">
            <summary style="padding:14px 16px; font-size:15px; font-weight:700; color:#2D3436; cursor:pointer; list-style:none;">Sind die Allergene (Glutenfrei etc.) verlässlich?</summary>
            <p style="margin:0; padding:0 16px 16px; font-size:15px; color:#666;">Ja, die Angaben stammen direkt vom Anbieter. Du kannst diese Filter in deinem Profil unter „Mein Geschmack“ voreinstellen.</p>
          </details>
          <h2 style="font-size:16px; font-weight:800; margin:0 0 12px; color:#1a1a1a; text-transform:uppercase; letter-spacing:0.5px;">Technik &amp; Account</h2>
          <details style="background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.06); overflow:hidden; margin-bottom:8px;">
            <summary style="padding:14px 16px; font-size:15px; font-weight:700; color:#2D3436; cursor:pointer; list-style:none;">Wo finde ich meine alten Bestellungen?</summary>
            <p style="margin:0; padding:0 16px 16px; font-size:15px; color:#666;">Alle vergangenen Mahlzeiten sind in deinem Profil in der „Historie“ chronologisch aufgelistet.</p>
          </details>
          <details style="background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.06); overflow:hidden; margin-bottom:16px;">
            <summary style="padding:14px 16px; font-size:15px; font-weight:700; color:#2D3436; cursor:pointer; list-style:none;">Wie ändere ich meine Mail-Adresse?</summary>
            <p style="margin:0; padding:0 16px 16px; font-size:15px; color:#666;">Gehe in deinem Profil zum Bereich „Profildaten“ – dort kannst du deine E-Mail und deinen Namen jederzeit aktualisieren.</p>
          </details>
        </div>
        
        <!-- FAQ-Inhalt: Anbieter (Accordion – Tippen = Ausklappen) -->
        <div id="faqContentProvider" style="display:none; padding:20px; line-height:1.8; font-size:15px;">
          <h2 style="font-size:16px; font-weight:800; margin:0 0 12px; color:#1a1a1a; text-transform:uppercase; letter-spacing:0.5px;">Kosten &amp; Flexibilität</h2>
          <details style="background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.06); overflow:hidden; margin-bottom:8px;">
            <summary style="padding:14px 16px; font-size:16px; font-weight:700; color:#2D3436; cursor:pointer; list-style:none;">Gibt es eine monatliche Grundgebühr oder ein Abo?</summary>
            <p style="margin:0; padding:0 16px 16px; font-size:15px; color:#666;">Nein. Bei uns gibt es kein Abo, keine Verträge und keine Laufzeiten. Du zahlst nur, wenn du wirklich ein Inserat schaltest. Wenn du nicht inserierst, entstehen dir keinerlei Kosten.</p>
          </details>
          <h2 style="font-size:16px; font-weight:800; margin:0 0 12px; color:#1a1a1a; text-transform:uppercase; letter-spacing:0.5px;">Küche &amp; Ablauf</h2>
          <details style="background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.06); overflow:hidden; margin-bottom:8px;">
            <summary style="padding:14px 16px; font-size:16px; font-weight:700; color:#2D3436; cursor:pointer; list-style:none;">Wie funktioniert der Küchenmodus?</summary>
            <p style="margin:0; padding:0 16px 16px; font-size:15px; color:#666;">Der Küchenmodus ist dein digitales Cockpit. Hier siehst du live eingehende Bestellungen, kannst deine Mittagskarte verwalten und die Abholnummer-Liste für deine Küche ausdrucken oder per E-Mail versenden.</p>
          </details>
          <details style="background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.06); overflow:hidden; margin-bottom:8px;">
            <summary style="padding:14px 16px; font-size:16px; font-weight:700; color:#2D3436; cursor:pointer; list-style:none;">Warum gibt es eine Service-Pauschale von 0,89 €?</summary>
            <p style="margin:0; padding:0 16px 16px; font-size:15px; color:#666;">Diese Pauschale ist dein „Rundum-Sorglos-Paket". Wir übernehmen die komplette Zahlungsabwicklung und die Bankgebühren für dich. Zudem sparst du massiv Personalzeit an der Kasse und hast keinen manuellen Buchungsaufwand mehr.</p>
          </details>
          <details style="background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.06); overflow:hidden; margin-bottom:8px;">
            <summary style="padding:14px 16px; font-size:16px; font-weight:700; color:#2D3436; cursor:pointer; list-style:none;">Muss ich eine Mindestmenge an Essen angeben?</summary>
            <p style="margin:0; padding:0 16px 16px; font-size:15px; color:#666;">Nein. Du entscheidest flexibel, wann ein Gericht „Ausverkauft" ist. Ein Klick im Küchenmodus genügt, um das Angebot für den Tag zu beenden.</p>
          </details>
          <details style="background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.06); overflow:hidden; margin-bottom:16px;">
            <summary style="padding:14px 16px; font-size:16px; font-weight:700; color:#2D3436; cursor:pointer; list-style:none;">Wie sicher ist die Auszahlung?</summary>
            <p style="margin:0; padding:0 16px 16px; font-size:15px; color:#666;">Wir arbeiten mit professionellen Zahlungsdienstleistern zusammen. Dein Umsatz wird gesammelt und regelmäßig direkt auf dein Bankkonto überwiesen – sauber aufgeschlüsselt für deine Buchhaltung.</p>
          </details>
        </div>
        
        <div style="margin-top:32px; padding:20px; border-top:1px solid #eee; text-align:center; font-size:14px; color:#666; background:#f9f9f9;">
          Weitere Fragen? Nutze den Button „Weitere Fragen &amp; Hilfe“ in deinem Profil (Meins).
        </div>
        <button class="btn ghost btn-back" type="button" onclick="goBackFromLegalPage()" style="margin:0 20px 20px; width:calc(100% - 40px);"><i data-lucide="chevron-left" style="width:18px;height:18px;"></i> Zurück</button>
      </div>
    </section>

    <!-- Support-Seite (Kunden): erweiterte FAQs + Kontaktformular, keine E-Mail im UI -->
    <section class="view" id="v-support" style="background:#F7F6F0; min-height:100vh; padding:20px; padding-bottom:90px;">
      <div class="panel" style="padding:0; overflow:hidden;">
        <h1 style="font-size:24px; font-weight:900; margin:20px 20px 0; padding-bottom:20px;">Support &amp; Hilfe</h1>

        <!-- Erweiterte Kunden-FAQs (Zahlung, Stornierung, Account) -->
        <div style="padding:0 20px 20px;">
          <button type="button" onclick="typeof openAbholnummerExplainSheet==='function'&&openAbholnummerExplainSheet()" style="width:100%; margin-bottom:20px; padding:14px 18px; background:rgba(255,215,0,0.12); border:2px solid rgba(255,215,0,0.35); border-radius:14px; text-align:left; cursor:pointer; display:flex; align-items:center; gap:12px;">
            <span style="font-size:24px;">🧾</span>
            <span style="font-size:15px; font-weight:700; color:#1a1a1a;">So funktioniert die Abholnummer (5 Schritte)</span>
            <i data-lucide="chevron-right" style="width:18px;height:18px;color:#94a3b8;margin-left:auto;"></i>
          </button>
          <h2 style="font-size:16px; font-weight:800; margin:0 0 12px; color:#1a1a1a;">Häufige Fragen</h2>
          <details style="background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.06); overflow:hidden; margin-bottom:8px;">
            <summary style="padding:12px 14px; font-size:14px; font-weight:600; color:#1a1a1a; cursor:pointer; list-style:none;">Wie bezahle ich mein Essen?</summary>
            <p style="margin:0; padding:0 14px 14px 14px; font-size:14px; line-height:1.5; color:#555;">Die Bezahlung erfolgt digital direkt über die Plattform. Nach erfolgreicher Zahlung erhältst du deine Abholnummer.</p>
          </details>
          <details style="background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.06); overflow:hidden; margin-bottom:8px;">
            <summary style="padding:12px 14px; font-size:14px; font-weight:600; color:#1a1a1a; cursor:pointer; list-style:none;">Kann ich eine Bestellung stornieren?</summary>
            <p style="margin:0; padding:0 14px 14px 14px; font-size:14px; line-height:1.5; color:#555;">Da die Mahlzeiten frisch für dich vorbereitet werden, ist eine Stornierung nach Ablauf des Zeitfensters leider nicht möglich. Details findest du in der Bestellübersicht.</p>
          </details>
          <details style="background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.06); overflow:hidden; margin-bottom:8px;">
            <summary style="padding:12px 14px; font-size:14px; font-weight:600; color:#1a1a1a; cursor:pointer; list-style:none;">Wo finde ich meine Bestellungen / Account?</summary>
            <p style="margin:0; padding:0 14px 14px 14px; font-size:14px; line-height:1.5; color:#555;">Alle Bestellungen und deine Profildaten findest du unter „Meins“ in der App.</p>
          </details>
        </div>

        <!-- Kontaktformular -->
        <div style="padding:20px; border-top:1px solid #eee;">
          <h2 style="font-size:16px; font-weight:800; margin:0 0 16px; color:#1a1a1a;">Nachricht senden</h2>
          <form id="supportForm" style="display:flex; flex-direction:column; gap:14px;">
            <label style="font-size:14px; font-weight:600; color:#334155;">Betreff</label>
            <select id="supportSubject" required style="width:100%; padding:14px 16px; border-radius:12px; border:2px solid rgba(0,0,0,.1); font-size:15px; background:#fff;">
              <option value="">Bitte wählen</option>
              <option value="bestellung">Frage zu meiner Bestellung</option>
              <option value="abholnummer">Problem mit Abholnummer</option>
              <option value="lob">Lob &amp; Kritik</option>
              <option value="technisch">Technischer Fehler</option>
              <option value="sonstiges">Sonstiges</option>
            </select>
            <label style="font-size:14px; font-weight:600; color:#334155;">Abholnummer (optional)</label>
            <input type="text" id="supportPickupRef" placeholder="z.B. #1A" style="width:100%; padding:14px 16px; border-radius:12px; border:2px solid rgba(0,0,0,.1); font-size:15px; box-sizing:border-box;">
            <label style="font-size:14px; font-weight:600; color:#334155;">Nachricht</label>
            <textarea id="supportMessage" required rows="4" placeholder="Deine Nachricht…" style="width:100%; padding:14px 16px; border-radius:12px; border:2px solid rgba(0,0,0,.1); font-size:15px; resize:vertical; box-sizing:border-box;"></textarea>
            <button type="submit" class="btn" id="btnSupportSubmit" style="width:100%; min-height:52px; font-weight:800; font-size:16px; border-radius:14px; background:var(--brand); color:#1a1a1a; border:none; cursor:pointer;">Nachricht senden</button>
          </form>
        </div>

        <div style="margin-top:24px; padding:20px; text-align:center; font-size:13px; color:#94a3b8;">made with ❤️ by mittagio.de</div>
<button class="btn ghost btn-back" type="button" onclick="goBackFromLegalPage()" style="margin:0 20px 20px; width:calc(100% - 40px);"><i data-lucide="chevron-left" style="width:18px;height:18px;"></i> Zurück</button>
      </div>
    </section>

    <!-- Anbieter-FAQ: einheitlich helles Layout -->
    <section class="view" id="v-legal-faq-provider" style="min-height:100vh; padding:20px; padding-bottom:90px;">
      <div class="panel" style="padding:20px; border-radius:16px; box-shadow:0 2px 12px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.06);">
        <h1 style="font-size:24px; font-weight:900; margin-bottom:20px; color:#1a1a1a;">FAQ für Anbieter</h1>
        <div style="line-height:1.8; font-size:15px; color:#334155;">
          <div style="margin-bottom:24px; padding-bottom:20px; border-bottom:1px solid rgba(0,0,0,0.08);">
            <h3 style="font-size:18px; font-weight:700; margin-bottom:8px; color:#1a1a1a;">Wie funktioniert der Küchenmodus?</h3>
            <p style="margin:0; color:#334155;">Der Küchenmodus ist dein digitales Cockpit. Hier siehst du live eingehende Bestellungen, kannst deine Mittagskarte verwalten und die Abholnummer-Liste für deine Küche ausdrucken oder per E-Mail versenden.</p>
          </div>
          <div style="margin-bottom:24px; padding-bottom:20px; border-bottom:1px solid rgba(0,0,0,0.08);">
            <h3 style="font-size:18px; font-weight:700; margin-bottom:8px; color:#1a1a1a;">Warum gibt es eine Service-Pauschale von 0,89 €?</h3>
            <p style="margin:0; color:#334155;">Diese Pauschale ist dein „Rundum-Sorglos-Paket". Wir übernehmen die komplette Zahlungsabwicklung und die Bankgebühren für dich. Zudem sparst du massiv Personalzeit an der Kasse und hast keinen manuellen Buchungsaufwand mehr.</p>
          </div>
          <div style="margin-bottom:24px; padding-bottom:20px; border-bottom:1px solid rgba(0,0,0,0.08);">
            <h3 style="font-size:18px; font-weight:700; margin-bottom:8px; color:#1a1a1a;">Muss ich eine Mindestmenge an Essen angeben?</h3>
            <p style="margin:0; color:#334155;">Nein. Du entscheidest flexibel, wann ein Gericht „Ausverkauft" ist. Ein Klick im Küchenmodus genügt, um das Angebot für den Tag zu beenden.</p>
          </div>
          <div style="margin-bottom:24px; padding-bottom:20px; border-bottom:1px solid rgba(0,0,0,0.08);">
            <h3 style="font-size:18px; font-weight:700; margin-bottom:8px; color:#1a1a1a;">Wie sicher ist die Auszahlung?</h3>
            <p style="margin:0; color:#334155;">Wir arbeiten mit professionellen Zahlungsdienstleistern zusammen. Dein Umsatz wird gesammelt und regelmäßig direkt auf dein Bankkonto überwiesen – sauber aufgeschlüsselt für deine Buchhaltung.</p>
          </div>
        </div>
        <div style="margin-top:24px; padding:16px; background:#f0fdf4; border-radius:12px; border:1px solid rgba(16,185,129,0.2);">
          <a href="#" id="linkInseratInfo" style="display:flex; align-items:center; gap:8px; font-size:15px; font-weight:700; color:#059669; text-decoration:none;"><span style="font-size:18px;">📋</span> So funktioniert das Inserieren</a>
        </div>
        <div style="margin-top:32px; padding-top:20px; border-top:1px solid rgba(0,0,0,0.08); text-align:center; font-size:14px; color:#64748b;">
          Weitere Fragen? <a href="mailto:support@mittagio.de" style="color:#0A84FF;">support@mittagio.de</a>
        </div>
        <button class="btn ghost btn-back" type="button" onclick="goBackFromLegalPage()" style="margin-top:20px; width:100%;"><i data-lucide="chevron-left" style="width:18px;height:18px;"></i> Zurück</button>
      </div>
    </section>

    <!-- Anbieter Infoseite Inseratsflow: Hero + 5 Kern-Funktionen -->
    <section class="view" id="v-legal-inserat-info-provider" style="min-height:100vh; padding:20px; padding-bottom:90px;">
      <div class="panel inserat-info-panel" style="padding:24px; border-radius:16px; box-shadow:0 2px 12px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.06); background:#fff;">
        <h1 class="inserat-info-hero-title" style="font-size:26px; font-weight:900; margin:0 0 12px; color:#1a1a1a; letter-spacing:-0.03em; line-height:1.2;">Inserieren in unter 30 Sekunden</h1>
        <p class="inserat-info-hero-sub" style="font-size:16px; color:#64748b; margin:0 0 24px; line-height:1.5;">Erreiche hungrige Gäste direkt in deiner Umgebung – ohne Bindung, ohne Risiko.</p>
        <ul class="inserat-info-hero-list" style="margin:0 0 32px; padding-left:20px; font-size:15px; color:#334155; line-height:1.7;">
          <li style="margin-bottom:10px;"><strong>Gerichtsname:</strong> Intelligente Autovervollständigung (Kategorien &amp; Allergene).</li>
          <li style="margin-bottom:10px;"><strong>Bild-Modul:</strong> Kamera, Upload oder 3 Profi-Vorschläge.</li>
          <li style="margin-bottom:0;"><strong>Zeitfenster:</strong> Du bestimmst Start- und Endzeit (keine Bestandsführung).</li>
        </ul>
        <h2 class="inserat-info-section-title" style="font-size:18px; font-weight:800; margin:0 0 20px; color:#1a1a1a;">Die 5 Kern-Funktionen</h2>
        <div class="inserat-info-grid">
          <div class="inserat-info-card" style="padding:16px; border-radius:14px; background:#f8fafc; border:1px solid rgba(0,0,0,0.06);">
            <div class="inserat-info-icon" style="font-size:28px; margin-bottom:10px; line-height:1;">🔄</div>
            <div class="inserat-info-label" style="font-size:12px; font-weight:800; color:#64748b; text-transform:uppercase; letter-spacing:0.04em; margin-bottom:6px;">Mehrweg</div>
            <p class="inserat-info-text" style="margin:0; font-size:14px; color:#334155; line-height:1.5;">Aktiviere den Toggle, wenn du nachhaltige Pfandsysteme unterstützt.</p>
          </div>
          <div class="inserat-info-card" style="padding:16px; border-radius:14px; background:#f8fafc; border:1px solid rgba(0,0,0,0.06);">
            <div class="inserat-info-icon" style="font-size:28px; margin-bottom:10px; line-height:1;">🍴</div>
            <div class="inserat-info-label" style="font-size:12px; font-weight:800; color:#64748b; text-transform:uppercase; letter-spacing:0.04em; margin-bottom:6px;">Vor Ort</div>
            <p class="inserat-info-text" style="margin:0; font-size:14px; color:#334155; line-height:1.5;">Standardmäßig aktiv – zeige Gästen, dass sie bei dir Platz nehmen können.</p>
          </div>
          <div class="inserat-info-card" style="padding:16px; border-radius:14px; background:#f8fafc; border:1px solid rgba(0,0,0,0.06);">
            <div class="inserat-info-icon" style="font-size:28px; margin-bottom:10px; line-height:1;">➕</div>
            <div class="inserat-info-label" style="font-size:12px; font-weight:800; color:#64748b; text-transform:uppercase; letter-spacing:0.04em; margin-bottom:6px;">Extras</div>
            <p class="inserat-info-text" style="margin:0; font-size:14px; color:#334155; line-height:1.5;">Füge Beilagen oder Upgrades mit individuellem Aufpreis hinzu.</p>
          </div>
          <div class="inserat-info-card" style="padding:16px; border-radius:14px; background:#f8fafc; border:1px solid rgba(0,0,0,0.06);">
            <div class="inserat-info-icon" style="font-size:28px; margin-bottom:10px; line-height:1;">⚠️</div>
            <div class="inserat-info-label" style="font-size:12px; font-weight:800; color:#64748b; text-transform:uppercase; letter-spacing:0.04em; margin-bottom:6px;">Allergene</div>
            <p class="inserat-info-text" style="margin:0; font-size:14px; color:#334155; line-height:1.5;">Schnelle Auswahl über Kategorie-Pills und Kürzel für maximale Sicherheit.</p>
          </div>
          <div class="inserat-info-card" style="padding:16px; border-radius:14px; background:#f8fafc; border:1px solid rgba(0,0,0,0.06);">
            <div class="inserat-info-icon" style="font-size:28px; margin-bottom:10px; line-height:1;">🕒</div>
            <div class="inserat-info-label" style="font-size:12px; font-weight:800; color:#64748b; text-transform:uppercase; letter-spacing:0.04em; margin-bottom:6px;">Abholzeit</div>
            <p class="inserat-info-text" style="margin:0; font-size:14px; color:#334155; line-height:1.5;">Definiere klar, wann das Gericht bereitsteht – für stressfreie Abläufe.</p>
          </div>
        </div>
        <button class="btn ghost btn-back" type="button" onclick="goBackFromLegalPage()" style="margin-top:28px; width:100%;"><i data-lucide="chevron-left" style="width:18px;height:18px;"></i> Zurück</button>
      </div>
    </section>

    <section class="view" id="v-legal-datenschutz">
      <div class="panel">
        <h1 style="font-size:24px; font-weight:900; margin-bottom:20px;">Datenschutzerklärung</h1>
        <div style="line-height:1.8; font-size:15px;">
          <p style="font-weight:700; margin-bottom:12px;">Verantwortlicher:</p>
          <p>
            MQ Mittagio UG (haftungsbeschränkt)<br>
            Langäcker 2, 73635 Rudersberg<br>
            Kunden-Hilfe: <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a><br>
            Business-Anfragen: <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a>
          </p>
          
          <p style="margin-top:24px; font-weight:700;">Datenminimierung:</p>
          <p>Wir speichern nur, was für die Zuordnung deiner Abholnummer und deiner Ernährungseinstellungen nötig ist.</p>
          
          <p style="margin-top:24px; font-weight:700;">Sitzungssicherheit:</p>
          <p>Um Missbrauch vorzubeugen, erlauben wir nur eine aktive Session pro Account. Eine Neuanmeldung trennt bestehende Verbindungen.</p>
          
          <p style="margin-top:24px; font-weight:700;">Anbieter-Daten:</p>
          <p>Kommunikation für Business-Partner erfolgt strikt über <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a>.</p>
          
          <p style="margin-top:24px; font-weight:700;">Abholnummer:</p>
          <p>Die Abholnummer dient als Zahlungs-/Abholnachweis, zur Zuordnung und zum Missbrauchsschutz.</p>
          
          <p style="margin-top:24px; font-weight:700;">Online-Zahlung:</p>
          <p>Online-Zahlung erfolgt über externe Zahlungsdienstleister (z.B. Stripe). Wir speichern keine vollständigen Zahlungsdaten (z.B. Kreditkartennummern).</p>
          
          <p style="margin-top:24px; font-weight:700;">Weitergabe:</p>
          <p>Daten werden nur an Zahlungsdienstleister und wenn gesetzlich erforderlich weitergegeben. Keine Werbeweitergabe.</p>
          
          <p style="margin-top:24px; font-weight:700;">Ihre Rechte:</p>
          <p>Sie haben das Recht auf Auskunft, Berichtigung, Löschung, Einschränkung und Widerspruch. Kontakt: <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a></p>
        </div>
        <div style="margin-top:32px; padding-top:20px; border-top:1px solid #eee; text-align:center; font-size:14px; color:#666;">
          Kunden-Hilfe: <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a> | Business: <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a>
        </div>
        <button class="btn ghost btn-back" type="button" onclick="goBackFromLegalPage()" style="margin-top:20px; width:100%;"><i data-lucide="chevron-left" style="width:18px;height:18px;"></i> Zurück</button>
      </div>
    </section>

    <!-- Datenschutz für Anbieter: einheitlich helles Layout -->
    <section class="view" id="v-legal-datenschutz-provider" style="min-height:100vh; padding:20px; padding-bottom:90px;">
      <div class="panel" style="padding:20px; border-radius:16px; box-shadow:0 2px 12px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.06);">
        <h1 style="font-size:24px; font-weight:900; margin-bottom:20px; color:#1a1a1a;">Datenschutzerklärung (Anbieter)</h1>
        <div style="line-height:1.8; font-size:15px; color:#334155;">
          <p style="font-weight:700; margin-bottom:12px;">Verantwortlicher:</p>
          <p>
            MQ Mittagio UG (haftungsbeschränkt)<br>
            Langäcker 2, 73635 Rudersberg<br>
            <strong>Business-Support:</strong> <a href="mailto:support@mittagio.de" style="color:#0A84FF;">support@mittagio.de</a><br>
            Kunden-Hilfe: <a href="mailto:info@mittagio.de" style="color:#0A84FF;">info@mittagio.de</a>
          </p>
          <p style="margin-top:24px; font-weight:700;">Anbieter-Daten & Zugang:</p>
          <p>Für deinen Anbieter-Zugang speichern wir E-Mail, Passwort (verschlüsselt) und alle von dir angelegten Inhalte (Betrieb, Gerichte, Speisekarte). Diese Daten dienen ausschließlich der Bereitstellung der Plattform und der Abwicklung von Bestellungen.</p>
          <p style="margin-top:24px; font-weight:700;">Sitzung & Sicherheit:</p>
          <p>Pro Anbieter-Account ist nur eine aktive Sitzung erlaubt. Eine neue Anmeldung beendet andere Geräte – das schützt dein Konto vor Missbrauch.</p>
          <p style="margin-top:24px; font-weight:700;">Bestell- & Abholdaten:</p>
          <p>Bestellungen und Abholnummern werden zur Abwicklung und zum Nachweis gespeichert. Kundenbezogene Daten (z. B. Abholnummer, Name bei Bestellung) werden nur im erforderlichen Umfang und nicht für Werbezwecke genutzt.</p>
          <p style="margin-top:24px; font-weight:700;">Zahlungsdienstleister:</p>
          <p>Online-Zahlungen laufen über externe Anbieter (z. B. Stripe). Wir speichern keine vollständigen Zahlungsdaten (z. B. Kreditkartennummern).</p>
          <p style="margin-top:24px; font-weight:700;">Weitergabe:</p>
          <p>Daten werden nur an Zahlungsdienstleister und bei gesetzlicher Verpflichtung weitergegeben. Keine Weitergabe zu Werbezwecken.</p>
          <p style="margin-top:24px; font-weight:700;">Deine Rechte:</p>
          <p>Auskunft, Berichtigung, Löschung, Einschränkung und Widerspruch. Anbieter-Anfragen bitte an <a href="mailto:support@mittagio.de" style="color:#0A84FF;">support@mittagio.de</a>.</p>
        </div>
        <div style="margin-top:32px; padding-top:20px; border-top:1px solid rgba(0,0,0,0.08); text-align:center; font-size:14px; color:#64748b;">
          <a href="mailto:support@mittagio.de" style="color:#0A84FF;">support@mittagio.de</a> · Business-Bereich
        </div>
        <button class="btn ghost btn-back" type="button" onclick="goBackFromLegalPage()" style="margin-top:20px; width:100%;"><i data-lucide="chevron-left" style="width:18px;height:18px;"></i> Zurück</button>
      </div>
    </section>

    <!-- Versionsseite (Link im Footer: v1.0.x) -->
    <section class="view" id="v-version" style="background:#F7F6F0; min-height:100vh; padding:20px; padding-bottom:90px;">
      <div class="panel" style="max-width:480px; margin:0 auto;">
        <h1 style="font-size:24px; font-weight:900; margin-bottom:20px;">Version</h1>
        <p style="font-size:16px; color:#555; margin-bottom:16px;">Aktuelle App-Version: <strong>v1.0.0</strong></p>
        <p style="font-size:14px; color:#666; line-height:1.6;">Changelog und technische Details findest du hier. Bei Fragen: <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a></p>
        <button class="btn ghost btn-back" type="button" onclick="history.back();" style="margin-top:24px; width:100%;"><i data-lucide="chevron-left" style="width:18px;height:18px;"></i> Zurück</button>
      </div>
    </section>

    <section class="view" id="v-legal-agb-onboarding">
      <div class="panel">
        <h2 style="font-size:20px; font-weight:900; margin-bottom:16px;">AGB</h2>
        <div style="line-height:1.7; font-size:14px; max-height:60vh; overflow-y:auto;">
          <p><strong>Mittagio ist Plattform, nicht Verkäufer</strong></p>
          <p>Mittagio vermittelt Mittagsangebote lokaler Anbieter. Vertragspartner bei Bestellungen ist ausschließlich der jeweilige Anbieter.</p>
          
          <p style="margin-top:16px;"><strong>Kosten:</strong></p>
          <ul style="padding-left:20px; margin:8px 0;">
            <li>4,99 € zzgl. MwSt. pro Veröffentlichung</li>
            <li>0,89 € zzgl. MwSt. pro Online-Bestellung inkl. aller Bank- & Zahlungsgebühren (pro Bestellung, egal wie viele Gerichte)</li>
          </ul>
          
          <p style="margin-top:16px;"><strong>Abholnummer:</strong></p>
          <p>Abholnummer = Zahlungs- & Abholnachweis. Abwicklungsgebühr fällt auch bei Nicht-Abholung an.</p>
          
          <p style="margin-top:16px;"><strong>Verantwortung:</strong></p>
          <p>Anbieter ist verantwortlich für Inhalte/Speisen/gesetzliche Vorgaben.</p>
          
          <p style="margin-top:16px;"><strong>Support:</strong></p>
          <p>Business-Anfragen: <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a></p>
        </div>
      </div>
    </section>
      
      <div id="provFaqBox" style="display:none;">
        <div class="panel">
          <div class="section-title">FAQ (Anbieter)</div>
          <div class="faq">
            <details>
              <summary>Was ist Mittagio?</summary>
              <p>Mittagio ist eine Online-Plattform, auf der du dein Mittagsangebot sichtbar machst – schnell, einfach und flexibel.</p>
            </details>
            <details>
              <summary>Wie verdiene ich damit Zeit?</summary>
              <p>Du legst Gerichte einmal an (Kochbuch) und veröffentlichst sie mit einem Klick. Weniger Telefonate, weniger Chaos.</p>
            </details>
            <details>
              <summary>Muss Online-Zahlung aktiv sein?</summary>
              <p>Nein. Online-Zahlung ist optional. Abholnummern gibt’s nur bei Online-Zahlung.</p>
            </details>
            <details>
              <summary>Wie kann ich mein Angebot teilen?</summary>
              <p>Mit einem Tap: WhatsApp, Instagram oder Homepage – Text ist automatisch vorbereitet.</p>
            </details>
            <details>
              <summary>Inseratsgebühr / Abholnummer?</summary>
              <p>Inseratsgebühr: 4,99 € einmalig heute pro Gericht. Abholnummer: 0,89 € pro Vorgang (inkl. aller Bankgebühren). Keine Mindestlaufzeit.</p>
            </details>
            <details>
              <summary>Wie funktionieren Abholungen?</summary>
              <p>Wenn Abholnummer aktiv ist, werden die Nummern nach Gericht gruppiert angezeigt. Tippe eine Nummer an, sobald ein Gast abgeholt hat.</p>
            </details>
            <details>
              <summary>Warum Abholnummer?</summary>
              <p>Vorab bezahlt, weniger Chaos an der Ausgabe und ein klarer Ablauf pro Bestellung.</p>
            </details>
            <details>
              <summary>Was kostet die Abholnummer?</summary>
              <p>0,89 € pro Vorgang. Auch mit mehreren Gerichten. Inkl. aller Bank- & Verwaltungsgebühren für Kartenzahlung.</p>
            </details>
            <details>
              <summary>Wie spare ich Zeit?</summary>
              <p>Speichere Gerichte im Kochbuch und veröffentliche sie mit 2-3 Taps erneut.</p>
            </details>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Floating Action Button (FAB) für Modus-Wechsel -->


  <!-- CUSTOMER bottom nav - Mittagio-Bar -->
  <nav class="bottom-nav" id="customerNav" style="position:fixed; bottom:0; left:0; right:0; z-index:999; display:flex; justify-content:space-around; align-items:center; background:rgba(255,255,255,0.85); backdrop-filter:saturate(180%) blur(20px); -webkit-backdrop-filter:saturate(180%) blur(20px); border-top:1px solid rgba(0,0,0,0.05); height:calc(70px + env(safe-area-inset-bottom, 0px)); padding-bottom:env(safe-area-inset-bottom, 0px);">
    <button class="navbtn active" data-go="discover" style="background:none; border:none; padding:8px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px; transition:all 0.2s;">
      <i data-lucide="search" style="width:22px;height:22px;"></i>
      <span style="font-size:11px; font-weight:700;">Entdecken</span>
    </button>
    <button class="navbtn" data-go="fav" style="background:none; border:none; padding:8px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px; transition:all 0.2s;">
      <i data-lucide="heart" style="width:22px;height:22px;"></i>
      <span style="font-size:11px; font-weight:700;">Favoriten</span>
    </button>
    <button class="navbtn" data-go="cart" id="bottomNavBasketBtn" style="background:none; border:none; padding:8px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px; transition:all 0.2s; position:relative;">
      <i data-lucide="shopping-basket" style="width:22px;height:22px;"></i>
      <span style="font-size:11px; font-weight:700;">Mittagsbox</span>
      <span id="bottomNavBasketBadge" style="position:absolute; top:4px; right:4px; background:#FFD700; color:#1a1a1a; font-size:10px; font-weight:900; width:16px; height:16px; border-radius:50%; display:none; align-items:center; justify-content:center; border:2px solid #fff;">0</span>
    </button>
    <button class="navbtn" data-go="profile" style="background:none; border:none; padding:8px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px; transition:all 0.2s;">
      <i data-lucide="user" style="width:22px;height:22px;"></i>
      <span style="font-size:11px; font-weight:700;">Meins</span>
    </button>
  </nav>

    <!-- PROVIDER bottom nav: fixer Zurück-Button darüber, heller Tab-Bar (App-Style) -->
  <div id="providerNavWrap" class="provider-nav-wrap-pill" style="display:none; position:fixed; bottom:24px; left:16px; right:16px; max-width:500px; margin-left:auto; margin-right:auto; z-index:999; padding:0 env(safe-area-inset-right, 0) env(safe-area-inset-bottom, 0) env(safe-area-inset-left, 0);">
    <div id="providerNavBackRow" style="padding:0 20px 16px; display:none;">
      <button type="button" id="btnProviderNavBack" class="btn-back" aria-label="Zurück" style="background:rgba(255,255,255,0.9); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); border:1px solid rgba(0,0,0,0.08); color:#1a1a1a; padding:10px 24px; border-radius:999px; font-size:15px; font-weight:700; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.06);"><i data-lucide="chevron-left" style="width:20px;height:20px;"></i> Zurück</button>
    </div>
    <nav class="bottom provider-nav-light provider-nav-pill" id="providerNav" style="background:#1a1a1a; backdrop-filter:blur(24px); -webkit-backdrop-filter:blur(24px); border:1px solid rgba(255,255,255,0.1); border-radius:2.5rem; padding:16px 32px calc(16px + env(safe-area-inset-bottom, 0)); box-shadow:0 25px 50px rgba(0,0,0,0.25); display:flex; justify-content:space-between; align-items:center;">
      <button class="navbtn active" data-pgo="provider-home" title="Küche"><div class="ico" data-icon="utensils-crossed" data-icon-only="1"></div></button>
      <button class="navbtn" data-pgo="provider-pickups" title="Abholungen"><div class="ico" data-icon="receipt" data-icon-only="1"></div></button>
      <button class="navbtn" data-pgo="provider-week" title="Wochenplan"><div class="ico" data-icon="calendar" data-icon-only="1"></div></button>
      <button class="navbtn" data-pgo="provider-cookbook" title="Kochbuch"><div class="ico" data-icon="bookOpen" data-icon-only="1"></div></button>
      <button class="navbtn" data-pgo="provider-profile" title="Meins"><div class="ico" data-icon="user" data-icon-only="1"></div></button>
    </nav>
  </div>
</div>

    <!-- Quick-Post Modal (direkt aus Kochbuch) -->
    <div class="backdrop" id="quickPostBd" onclick="closeQuickPostSheet()" style="background:rgba(0,0,0,0.5); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); z-index:1100;"></div>
    <div class="sheet" id="quickPostSheet" style="max-width:480px; border-radius:28px; overflow:hidden; z-index:1101;">
      <div class="sheet-body" style="padding:28px;">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
          <div style="width:48px; height:48px; background:rgba(255,222,0,0.2); border-radius:14px; display:flex; align-items:center; justify-content:center;">
            <i data-lucide="rocket" style="width:24px; height:24px; color:#1a1a1a;"></i>
          </div>
          <h3 style="margin:0; font-size:22px; font-weight:900; color:#1a1a1a;">Jetzt live gehen?</h3>
        </div>

        <div id="quickPostSummary" style="background:#f8f7f2; border-radius:20px; padding:20px; margin-bottom:24px; border:1px solid rgba(0,0,0,0.05);">
          <!-- Dynamisch -->
        </div>

        <div style="display:flex; flex-direction:column; gap:12px;">
          <button class="btn-primary" type="button" id="btnQuickPostConfirm" style="width:100%; min-height:60px; font-size:16px; font-weight:800; background:#FFDE00; color:#1a1a1a; border:none; box-shadow:0 4px 16px rgba(255,222,0,0.35);">
            Für 4,99 € inserieren
          </button>
          <button class="btn ghost" type="button" id="btnQuickPostWizard" style="width:100%; min-height:52px; font-weight:700; color:#1a1a1a; border:2px solid #e5e7eb; background:#fff;">
            Angaben ändern
          </button>
          <button class="btn ghost" type="button" onclick="closeQuickPostSheet()" style="width:100%; min-height:44px; color:#64748b; font-weight:600; border:none; background:none;">
            Abbrechen
          </button>
        </div>
      </div>
    </div>

    <!-- Share-Preview-Modal (WhatsApp-Vorschau vor dem Teilen) -->
    <div id="sharePreviewBd" class="share-preview-backdrop" style="display:none; position:fixed; inset:0; z-index:2100; background:rgba(26,26,26,0.8); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); padding:20px; box-sizing:border-box;" onclick="if(event.target===this) closeSharePreviewModal();">
      <div class="share-preview-sheet" style="background:#fff; border-radius:2.5rem; width:100%; max-width:380px; overflow:hidden; box-shadow:0 24px 60px rgba(0,0,0,0.25);">
        <div style="background:#25D366; padding:20px 24px; display:flex; align-items:center; gap:12px;">
          <div style="width:40px; height:40px; background:rgba(255,255,255,0.2); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:20px;">💬</div>
          <div>
            <h3 style="margin:0; font-size:11px; font-weight:900; text-transform:uppercase; letter-spacing:0.15em; color:#fff;">Vorschau</h3>
            <p style="margin:2px 0 0; font-size:10px; opacity:0.9; color:#fff;">So sieht es bei WhatsApp aus</p>
          </div>
        </div>
        <div style="padding:24px;">
          <div id="sharePreviewBubble" style="background:#e7f3ef; padding:16px 18px; border-radius:20px; border-top-left-radius:4px; border:1px solid rgba(0,0,0,0.05); margin-bottom:24px;">
            <p id="sharePreviewText" style="margin:0; font-size:14px; color:#1a1a1a; white-space:pre-line; line-height:1.5; font-weight:500;"></p>
          </div>
          <button type="button" id="btnSharePreviewSend" onclick="sharePreviewSendWhatsApp()" style="width:100%; min-height:56px; border:none; border-radius:1.5rem; background:#25D366; color:#fff; font-size:16px; font-weight:900; box-shadow:0 4px 20px rgba(37,211,102,0.4); cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;">
            <span>JETZT TEILEN</span>
            <span style="font-size:20px;">🚀</span>
          </button>
          <button type="button" id="btnSharePreviewCancel" onclick="closeSharePreviewModal()" style="width:100%; margin-top:16px; padding:12px; border:none; background:none; color:#94a3b8; font-size:11px; font-weight:800; text-transform:uppercase; letter-spacing:0.1em; cursor:pointer;">
            Abbrechen
          </button>
        </div>
      </div>
    </div>

    <!-- Publish Fee Modal (vor Inserats-Veröffentlichung) – Backdrop + Sheet immer gemeinsam anzeigen -->
    <div class="backdrop" id="publishFeeBd" onclick="closePublishFeeModal()" style="background:rgba(0,0,0,0.7); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); z-index:2000;"></div>
    <div class="sheet" id="publishFeeSheet" style="max-width:480px; border-radius:24px; overflow:hidden; z-index:2001;">
  <div class="sheet-body" style="padding:28px;">
    <h3 style="margin:0 0 20px; font-size:22px; font-weight:900; color:#2D3436;">Inserat veröffentlichen</h3>
    <div style="margin-bottom:24px; padding:20px; background:rgba(255,215,0,0.1); border-radius:16px; border:2px solid rgba(255,215,0,0.3);">
      <div style="font-weight:700; font-size:16px; color:#2D3436; margin-bottom:12px; display:flex; align-items:center; gap:8px;">
        <i data-lucide="info" style="width:20px;height:20px; color:#FFD700;"></i>
        <span>Gebühren-Übersicht</span>
      </div>
      <div style="font-size:15px; line-height:1.6; color:#2D3436; margin-bottom:16px;">
        <div style="margin-bottom:12px;">
          <strong>Inseratsgebühr:</strong> <span id="publishFeeAmount" style="color:#FFD700; font-weight:900;">4,99 €</span>
          <div id="publishFeeAmountHint" style="font-size:13px; color:#666; margin-top:4px;">Einmalig heute pro Gericht</div>
        </div>
        <div style="padding-top:12px; border-top:1px solid rgba(0,0,0,0.1);">
          <strong>Abholnummer:</strong> <span style="color:#1f9d55; font-weight:900;">0,89 €</span>
          <div style="font-size:13px; color:#666; margin-top:4px;">Pro Vorgang. Auch mit mehreren Gerichten. inkl. aller Bank- & Verwaltungsgebühren für Kartenzahlung.</div>
        </div>
      </div>
    </div>
    <div style="display:flex; flex-direction:column; gap:12px;">
      <button class="btn-primary" type="button" id="btnPublishConfirm" style="width:100%; min-height:56px; font-size:16px; font-weight:700;">
        Jetzt online stellen
      </button>
      <button class="btn ghost" type="button" onclick="closePublishFeeModal();" style="width:100%; min-height:44px;">
        Abbrechen
      </button>
    </div>
  </div>
</div>

<!-- Hinweis: Adresse in Meine Daten ausfüllen -->
<div class="backdrop" id="addressRequiredBd" onclick="closeAddressRequiredModal()" style="background:rgba(0,0,0,0.5); z-index:1150; display:none;"></div>
<div id="addressRequiredSheet" style="position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:90%; max-width:340px; background:#fff; border-radius:20px; padding:24px; box-shadow:0 20px 40px rgba(0,0,0,0.15); z-index:1151; display:none;">
  <p style="margin:0 0 20px; font-size:16px; font-weight:600; color:#1a1a1a; line-height:1.45;">Bitte zuerst in <strong>Meine Daten</strong> deine Adresse eintragen (Straße, PLZ, Ort).</p>
  <button type="button" onclick="closeAddressRequiredModal(); showProviderProfile(); setTimeout(function(){ if(typeof showProviderProfileSub==='function') showProviderProfileSub('business'); }, 100);" style="width:100%; min-height:48px; border-radius:14px; background:#1a1a1a; color:#fff; font-weight:800; font-size:15px; border:none; cursor:pointer;">Zu Meine Daten</button>
</div>

<!-- Speichern-Erfolg + „Jetzt live?“ (Kochbuch/Wochenplan) – ähnlich Inserat-Erfolg -->
<div class="backdrop" id="saveSuccessSheetBd" onclick="closeSaveSuccessSheet()" style="background:rgba(0,0,0,0.7); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); z-index:1198;"></div>
<div class="sheet" id="saveSuccessSheet" style="max-width:480px; border-radius:32px; background:#f8f7f2; z-index:1199; display:flex; flex-direction:column; max-height:92vh;">
  <div class="sheet-body" style="padding:24px 24px 120px; text-align:center; overflow-y:auto; flex:1; min-height:0;">
    <div style="width:64px; height:64px; background:#dcfce7; color:#16a34a; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:32px; margin:0 auto 16px; box-shadow:0 4px 12px rgba(22,163,74,0.15);">✓</div>
    <h1 id="saveSuccessSheetTitle" style="margin:0 0 8px; font-size:24px; font-weight:950; color:#1a1a1a; letter-spacing:-0.03em;">Gespeichert!</h1>
    <p id="saveSuccessSheetSub" style="margin:0 0 20px; font-size:14px; color:#64748b;">Dein Gericht ist gespeichert.</p>
    <div id="saveSuccessSheetPreview" class="success-card-preview" style="margin-bottom:20px; text-align:left;"></div>
    <div style="background:#fff; border-radius:16px; padding:20px; margin-bottom:24px; border:1px solid rgba(0,0,0,0.06); text-align:left;">
      <p style="margin:0; font-size:15px; font-weight:700; color:#1a1a1a;">Willst du es jetzt live stellen mit Abholnummer?</p>
      <p style="margin:8px 0 0; font-size:13px; color:#64748b; line-height:1.45;">Gäste können dann dein Gericht finden und mit Abholnummer bestellen (0,89 € pro Vorgang).</p>
    </div>
  </div>
  <div style="position:absolute; bottom:0; left:0; right:0; padding:20px 24px calc(20px + env(safe-area-inset-bottom, 0)); background:linear-gradient(to top, #f8f7f2 80%, transparent); display:flex; flex-direction:column; gap:10px;">
    <button type="button" id="saveSuccessSheetBtnLive" style="width:100%; min-height:52px; border-radius:16px; background:#1a1a1a; color:#fff; font-weight:800; font-size:15px; border:none; box-shadow:0 4px 12px rgba(0,0,0,0.1);">Jetzt live stellen</button>
    <button type="button" id="saveSuccessSheetBtnFertig" style="width:100%; min-height:48px; border-radius:16px; background:#fff; color:#1a1a1a; font-weight:700; font-size:15px; border:2px solid rgba(0,0,0,0.1);">Fertig</button>
  </div>
</div>

<!-- 5 Screens: So funktioniert die Abholnummer (Marketing/FAQ) – Platzhalterbilder, ersetzbar -->
<div class="backdrop" id="abholnummerExplainBd" onclick="closeAbholnummerExplainSheet()" style="background:rgba(0,0,0,0.7); backdrop-filter:blur(10px); z-index:1195;"></div>
<div class="sheet" id="abholnummerExplainSheet" style="max-width:480px; border-radius:28px 28px 0 0; background:#f8f7f2; z-index:1196; display:flex; flex-direction:column; max-height:90vh;">
  <div style="padding:16px 0 0; border-bottom:1px solid rgba(0,0,0,0.06); display:flex; align-items:center; justify-content:space-between;">
    <h2 style="margin:0 24px; font-size:18px; font-weight:900; color:#1a1a1a;">So funktioniert die Abholnummer</h2>
    <button type="button" onclick="closeAbholnummerExplainSheet()" aria-label="Schließen" style="width:44px; height:44px; border:none; background:transparent; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; margin-right:8px;"><i data-lucide="x" style="width:22px;height:22px;color:#64748b;"></i></button>
  </div>
  <div class="abholnummer-explain-hero" id="abholnummerExplainCarousel" style="flex:1; min-height:0; padding:20px 0 0;">
    <div class="abholnummer-explain-slide" data-slide="0">
      <img class="abholnummer-explain-slide-img" src="https://images.unsplash.com/photo-1504674900247-0877df9cc84e?auto=format&fit=crop&w=800&q=70" alt="Gerichte entdecken">
      <div class="abholnummer-explain-slide-body">
        <h3 class="abholnummer-explain-slide-title">1. Gericht entdecken</h3>
        <p class="abholnummer-explain-slide-sub">Finde dein Mittagsgericht in der Nähe – frisch, von lokalen Anbietern.</p>
      </div>
    </div>
    <div class="abholnummer-explain-slide" data-slide="1">
      <img class="abholnummer-explain-slide-img" src="https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?auto=format&fit=crop&w=800&q=70" alt="Mittagsbox">
      <div class="abholnummer-explain-slide-body">
        <h3 class="abholnummer-explain-slide-title">2. In die Mittagsbox</h3>
        <p class="abholnummer-explain-slide-sub">Lege Favoriten in deine Mittagsbox – so behältst du den Überblick für heute.</p>
      </div>
    </div>
    <div class="abholnummer-explain-slide" data-slide="2">
      <img class="abholnummer-explain-slide-img" src="https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?auto=format&fit=crop&w=800&q=70" alt="Abholnummer sichern">
      <div class="abholnummer-explain-slide-body">
        <h3 class="abholnummer-explain-slide-title">3. Abholnummer sichern</h3>
        <p class="abholnummer-explain-slide-sub">Sichere dir deine Abholnummer – nur 0,89 €. Zahlung digital, Schlange überspringen.</p>
      </div>
    </div>
    <div class="abholnummer-explain-slide" data-slide="3">
      <img class="abholnummer-explain-slide-img" src="https://images.unsplash.com/photo-1555396273-367ea4eb4db5?auto=format&fit=crop&w=800&q=70" alt="An der Theke">
      <div class="abholnummer-explain-slide-body">
        <h3 class="abholnummer-explain-slide-title">4. An der Theke zeigen</h3>
        <p class="abholnummer-explain-slide-sub">Zeig deine Abholnummer beim Abholen – dein Gericht ist sofort zugeordnet. Fertig.</p>
      </div>
    </div>
    <div class="abholnummer-explain-slide" data-slide="4">
      <img class="abholnummer-explain-slide-img" src="https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=800&q=70" alt="Genießen">
      <div class="abholnummer-explain-slide-body">
        <h3 class="abholnummer-explain-slide-title">5. Genießen</h3>
        <p class="abholnummer-explain-slide-sub">Dein Mittag, ohne Warten – Zeit gespart mit der Abholnummer.</p>
      </div>
    </div>
  </div>
  <div id="abholnummerExplainDots" class="abholnummer-explain-dots"></div>
  <div style="padding:0 24px calc(20px + env(safe-area-inset-bottom, 0)); padding-top:0;">
    <button type="button" id="abholnummerExplainBtnNext" style="width:100%; min-height:52px; border-radius:16px; background:#FFD700; color:#1a1a1a; font-weight:800; font-size:16px; border:none; cursor:pointer; box-shadow:0 4px 12px rgba(255,215,0,0.3);">Weiter</button>
  </div>
</div>

<!-- Inserat Live – Erfolgs-Sheet nach Veröffentlichung -->
<div class="backdrop inserat-success-backdrop" id="inseratSuccessBd" onclick="closeInseratSuccessSheet()" style="background:rgba(0,0,0,0.5); backdrop-filter:blur(30px); -webkit-backdrop-filter:blur(30px); z-index:1200;"></div>
<div class="sheet" id="inseratSuccessSheet" style="max-width:480px; border-radius:32px; background:#f8f7f2; z-index:1201; display:flex; flex-direction:column; max-height:92vh;">
  <div id="confettiContainer" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; overflow:hidden;"></div>
  
  <div class="sheet-body" style="padding:0 24px 100px; text-align:center; overflow-y:auto; flex:1; min-height:0; -webkit-overflow-scrolling:touch;">
    
    <!-- Emotional: Kunde zeigt Abholnummer an der Theke (Fullscreen-Feeling) -->
    <div id="inseratSuccessHero" style="margin:0 -24px 20px; border-radius:0 0 28px 28px; overflow:hidden; background:linear-gradient(180deg, #dcfce7 0%, #f0fdf4 100%); position:relative;">
      <div style="width:100%; aspect-ratio:4/3; max-height:220px; overflow:hidden;">
        <img id="inseratSuccessHeroImg" src="assets/success-hero-abholnummer.png" alt="Kunde zeigt an der Theke die App mit der Abholnummer" style="width:100%; height:100%; object-fit:cover; display:block;">
      </div>
      <div style="position:absolute; bottom:0; left:0; right:0; padding:16px 20px 20px; background:linear-gradient(to top, rgba(0,0,0,0.5) 0%, transparent 100%); color:#fff; text-align:left;">
        <div style="font-size:11px; font-weight:800; text-transform:uppercase; letter-spacing:0.08em; opacity:0.95; margin-bottom:4px;">So sieht’s aus bei dir</div>
        <div style="font-size:15px; font-weight:800;">Dein Gast zeigt die Abholnummer – du übergibst das Gericht. Fertig.</div>
      </div>
    </div>

    <!-- 1. Checkmark + Geschafft (Dopamin-Kick) [cite: 2026-01-26, 2026-01-29, 2026-02-16] -->
    <div id="inseratSuccessCheckmarkBlock" style="margin-bottom:20px;">
      <div class="inserat-success-checkmark" style="width:80px; height:80px; margin:0 auto 16px; background:#dcfce7; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 24px rgba(16,185,129,0.25);">
        <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
      </div>
      <h1 id="inseratSuccessCheckmarkTitle" style="margin:0 0 6px; font-size:22px; font-weight:950; color:#0f172a; letter-spacing:-0.03em;">Geschafft! Deine Abholnummern sind scharfgeschaltet.</h1>
      <p id="inseratSuccessCheckmarkSub" style="margin:0; font-size:14px; color:#64748b; font-weight:500;">Hungrige Gäste können dein Gericht jetzt finden.</p>
    </div>

    <!-- 2. Live Preview (Kompakt-Card mit 3 Säulen) -->
    <div id="inseratSuccessLivePreview" class="success-card-preview" style="margin-bottom:16px;"></div>

    <!-- 2b. Zusammenfassung des Deals -->
    <div id="inseratSuccessDealSummary" style="background:#fff; border-radius:16px; padding:16px 20px; margin-bottom:16px; border:1px solid rgba(0,0,0,0.06); text-align:left;"></div>

    <!-- 2c. Was passiert jetzt? -->
    <p id="inseratSuccessWhatNext" style="margin:0 0 20px; font-size:14px; color:#64748b; line-height:1.5; text-align:left;"></p>

    <!-- 3. Primary Action: WhatsApp Boost (gut sichtbar, direkt unter Vorschau) -->
    <div style="margin-top:16px;">
      <div style="font-size:11px; font-weight:800; color:#9ca3af; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:12px;">Dein Umsatz-Turbo</div>
      <a id="inseratSuccessBtnWhatsApp" href="#" target="_blank" rel="noopener" style="display:flex; align-items:center; justify-content:center; gap:12px; width:100%; min-height:56px; padding:14px 24px; border-radius:20px; background:#25D366; color:#fff; font-weight:900; font-size:17px; text-decoration:none; margin-bottom:12px; box-shadow:0 8px 24px rgba(37,211,102,0.3); cursor:pointer;">
        <i data-lucide="send" style="width:24px; height:24px;"></i>
        <span>Bei WhatsApp teilen</span>
      </a>
      <p style="font-size:13px; color:#64748b; font-weight:500; margin-bottom:24px;">Informiere deine Kunden direkt.</p>
    </div>

    <!-- 4. Secondary Tools Grid -->
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:24px;">
      <button type="button" id="inseratSuccessBtnPrintQR" style="background:#fff; border-radius:20px; padding:16px; border:1px solid rgba(0,0,0,0.06); text-align:center; cursor:pointer;">
        <i data-lucide="qr-code" style="width:24px; height:24px; color:#1a1a1a; margin-bottom:8px;"></i>
        <div style="font-size:13px; font-weight:800; color:#1a1a1a;">Für den Tresen</div>
        <div style="font-size:11px; color:#9ca3af; margin-top:2px;">QR-Code drucken</div>
      </button>
      <button type="button" id="inseratSuccessBtnSocialImage" style="background:#fff; border-radius:20px; padding:16px; border:1px solid rgba(0,0,0,0.06); text-align:center; cursor:pointer;">
        <i data-lucide="instagram" style="width:24px; height:24px; color:#1a1a1a; margin-bottom:8px;"></i>
        <div style="font-size:13px; font-weight:800; color:#1a1a1a;">Für Instagram</div>
        <div style="font-size:11px; color:#9ca3af; margin-top:2px;">Bild generieren</div>
      </button>
    </div>

    <!-- 5. Abholnummer: Finale Bestätigung (emotional, nur bei Abholnummer) -->
    <div id="inseratSuccessAbholnummerSection" style="background:#fff; border-radius:24px; padding:20px; border:1px solid rgba(59,130,246,0.1); display:none; margin-bottom:24px;">
      <div style="font-size:11px; font-weight:800; color:#64748b; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:8px;">Abholnummer für deine Gäste</div>
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px; justify-content:center;">
        <div style="width:8px; height:8px; background:#3b82f6; border-radius:50%; animation: pulse 2s infinite;"></div>
        <span style="font-size:12px; font-weight:800; color:#3b82f6; text-transform:uppercase; letter-spacing:0.05em;">Monitoring Aktiv</span>
      </div>
      <div style="font-size:32px; font-weight:900; color:#1a1a1a; letter-spacing:-0.02em; margin-bottom:4px;">#<span id="inseratSuccessNextCode">1</span></div>
      <div style="font-size:12px; color:#64748b; font-weight:600;">Nächste freie Abholnummer</div>
    </div>

  </div>

  <!-- Bottom: Zum Inserat + Nächstes Gericht [cite: 2026-01-29] -->
  <div style="position:absolute; bottom:0; left:0; right:0; padding:20px 24px calc(20px + env(safe-area-inset-bottom, 0)); background:linear-gradient(to top, #f8f7f2 80%, transparent); text-align:center; display:flex; flex-direction:column; gap:10px;">
    <button type="button" id="inseratSuccessBtnBack" style="width:100%; min-height:52px; border-radius:16px; background:#1a1a1a; color:#fff; font-weight:800; font-size:15px; border:none; box-shadow:0 4px 12px rgba(0,0,0,0.1);">
      Zum Inserat
    </button>
    <button type="button" id="inseratSuccessBtnNewListing" style="width:100%; min-height:48px; border-radius:16px; background:#fff; color:#1a1a1a; font-weight:700; font-size:15px; border:2px solid rgba(0,0,0,0.1);">
      Nächstes Gericht inserieren
    </button>
  </div>
</div>

  <!-- Offer sheet -->
  <div class="backdrop" id="bd" onclick="closeSheet()"></div>
  <div class="sheet" id="sheet">
    <div class="handle"></div>
    
    <div class="sheet-header" style="display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid rgba(0,0,0,0.05); position:sticky; top:0; z-index:100; background:rgba(255,255,255,0.9); backdrop-filter:blur(10px);">
      <button type="button" onclick="closeSheet()" style="width:40px; height:40px; border-radius:12px; background:#f1f3f5; border:none; display:flex; align-items:center; justify-content:center; cursor:pointer;">
        <i data-lucide="chevron-down" style="width:24px;height:24px;color:#1a1a1a;"></i>
      </button>
      <div style="font-weight:850; font-size:16px; color:#1a1a1a; letter-spacing:-0.01em;">Details</div>
      <button type="button" id="btnShareHeader" style="width:40px; height:40px; border-radius:12px; background:#f1f3f5; border:none; display:flex; align-items:center; justify-content:center; cursor:pointer;">
        <i data-lucide="share-2" style="width:20px;height:20px;color:#1a1a1a;"></i>
      </button>
    </div>

    <div class="sheet-body" style="padding:0; overflow-y:auto; flex:1;">
      <!-- Bild Sektion: Preis auf dem Bild wie Dashboard-Kachel -->
      <div style="padding:24px 20px; text-align:center; background:linear-gradient(180deg, #f8f9fa 0%, #fff 100%);">
        <div style="position:relative; width:160px; height:160px; margin:0 auto; border-radius:40px; overflow:hidden; box-shadow:0 12px 32px rgba(0,0,0,0.1); border:4px solid #fff;">
          <img id="sImg" alt="" style="width:100%; height:100%; object-fit:cover;" />
          <div id="sImgPlaceholder" style="position:absolute; inset:0; background:#f1f3f5; display:none; align-items:center; justify-content:center;">
            <i data-lucide="image" style="width:48px;height:48px;color:#cbd5e1;"></i>
          </div>
          <!-- Favorit Button auf dem Bild-Rand -->
          <button id="sFavoriteBtn" style="position:absolute; top:8px; right:8px; width:36px; height:36px; border-radius:10px; background:rgba(255,255,255,0.9); border:none; display:flex; align-items:center; justify-content:center; color:#E34D4D; box-shadow:0 4px 12px rgba(0,0,0,0.1);">
            <i data-lucide="heart" style="width:20px;height:20px;"></i>
          </button>
          <!-- Preis-Sticker auf dem Bild (wie Dashboard-Kachel) -->
          <div id="sPriceSticker" style="position:absolute; bottom:8px; right:8px; padding:6px 12px; border-radius:999px; font-weight:900; font-size:14px; background:rgba(255,215,0,0.95); color:#1a1a1a; box-shadow:0 2px 8px rgba(255,215,0,0.3); z-index:10;"></div>
        </div>
      </div>

      <!-- 5 Icons + ⓘ (wie Inseratsflow): Vor Ort, Mehrweg, Zeit, Allergene, Extras, Legende -->
      <div id="sThreePillars" class="detail-power-bar">
        <!-- Wird dynamisch befüllt -->
      </div>

      <!-- Info Sektion -->
      <div style="padding:24px 20px;">
        <h2 id="sDish" style="margin:0 0 8px; font-size:24px; font-weight:950; color:#1a1a1a; letter-spacing:-0.03em; line-height:1.2;">Gerichtsname</h2>
        
        <button id="sProviderNameBtn" style="display:flex; align-items:center; gap:8px; background:none; border:none; padding:0; cursor:pointer; margin-bottom:24px; text-align:left; width:100%;">
          <div style="width:32px; height:32px; border-radius:8px; background:#f1f3f5; display:flex; align-items:center; justify-content:center; font-size:16px;">🏢</div>
          <span id="sProviderName" style="font-weight:700; font-size:16px; color:#64748b;">Anbieter</span>
          <i data-lucide="chevron-right" style="width:16px;height:16px;color:#cbd5e1; margin-left:auto;"></i>
        </button>

        <div style="display:flex; flex-direction:column; gap:16px; background:#f8f9fa; border-radius:24px; padding:20px; border:1px solid rgba(0,0,0,0.02);">
          <div id="sProviderAddressRow" style="display:flex; align-items:center; gap:12px;">
            <div style="width:36px; height:36px; border-radius:10px; background:#fff; display:flex; align-items:center; justify-content:center;">
              <i data-lucide="map-pin" style="width:18px;height:18px;color:#64748b;"></i>
            </div>
            <span id="sProviderAddress" style="font-size:14px; font-weight:600; color:#1a1a1a;">Adresse</span>
          </div>

          <div id="sDistanceInfo" style="display:none; gap:10px; margin-top:4px;">
            <!-- Wird dynamisch: zwei Kacheln -->
          </div>
        </div>

        <!-- Allergene -->
        <div id="sAllergensWrap" style="margin-top:24px; padding:16px; border-radius:16px; background:rgba(0,0,0,0.03); display:flex; align-items:center; justify-content:space-between; cursor:pointer;" onclick="showAllergensOverlay();">
          <div style="display:flex; align-items:center; gap:8px;">
            <span style="font-size:12px; font-weight:800; color:#64748b; text-transform:uppercase;">Allergene:</span>
            <span id="sAllergensCodes" style="font-size:14px; font-weight:700; color:#1a1a1a;">–</span>
          </div>
          <i data-lucide="info" style="width:18px;height:18px;color:#94a3b8;"></i>
        </div>
      </div>

      <!-- Sticky Bottom CTA (3 Säulen + CTA per GERICHT_DETAILANSICHT_KONZEPT) -->
      <div style="position:sticky; bottom:0; padding:20px; padding-bottom:calc(20px + env(safe-area-inset-bottom, 0px)); background:rgba(255,255,255,0.9); backdrop-filter:blur(10px); border-top:1px solid rgba(0,0,0,0.05); z-index:100;">
        <button class="btn-cust-primary" id="btnPrimaryCTA" style="width:100%;">
          <i data-lucide="shopping-basket"></i>
          <span id="btnPrimaryCTAText">In die Mittagsbox legen</span>
        </button>
        <p id="sInfoHint" style="margin:12px 0 0; text-align:center; font-size:12px; font-weight:600; color:#94a3b8; line-height:1.4; display:none;"></p>
      </div>
    </div>
  </div>

<!-- Provider offer sheet: No-Scroll – Karte ist das Interface, ein Sticky-Button unten -->
<div class="backdrop" id="pbd" onclick="closeProviderSheet()"></div>
<div class="sheet" id="psheet">
  <div class="handle"></div>
  <div class="sheet-body psheet-body">
    <button type="button" class="universal-x" id="psheetCloseX" aria-label="Schließen" title="Schließen">✕</button>
    <div id="pPreview"></div>
    <div class="psheet-footer-sticky psheet-decision-zone" id="psheetDecisionZone">
      <button type="button" id="btnPsheetMitAbholnummer" class="psheet-btn-decision psheet-btn-green" aria-label="Mit Abholnummer inserieren">Mit Abholnummer</button>
      <button type="button" id="btnPsheetNurInserat" class="psheet-btn-decision psheet-btn-yellow" aria-label="Nur Inserat">Nur Inserat</button>
    </div>
  </div>
  <!-- Preis-Overlay: großer Fintech-Zahlenblock (One-Tap Price Edit) -->
  <div id="psheetPriceOverlay" class="psheet-price-overlay" style="display:none;">
    <div class="psheet-price-overlay-backdrop"></div>
    <div class="psheet-price-overlay-inner">
      <label class="psheet-price-overlay-label">Preis (€)</label>
      <input type="text" inputmode="decimal" id="psheetPriceInput" class="psheet-price-input" placeholder="0,00" maxlength="8" />
      <button type="button" id="psheetPriceOverlayClose" class="psheet-price-overlay-close" aria-label="Schließen">Übernehmen</button>
    </div>
  </div>
  <!-- ⓘ-Menü: Legende + Drucken (ausgeblendet, wird bei Klick auf ⓘ geöffnet) -->
  <div id="psheetLegendPopover" class="psheet-legend-popover" style="display:none;">
    <div class="psheet-legend-inner">
      <div style="font-weight:800; margin-bottom:8px; font-size:14px;">Symbole</div>
      <p style="margin:0 0 12px; font-size:13px; color:#475569; line-height:1.5;">🍴 Vor Ort · 🔄 Mehrweg · 🕒 Abholzeit · 🌾 Allergene · ➕ Extras</p>
      <button type="button" id="btnPsheetPrintFromLegend" class="psheet-legend-print">Drucken</button>
      <button type="button" id="btnPsheetLegendClose" class="psheet-legend-close">Schließen</button>
    </div>
  </div>
</div>

<!-- Save-Scope-Dialog: Nur aktuell vs. Im Kochbuch speichern -->
<div class="save-scope-backdrop" id="saveScopeBackdrop" style="display:none;"></div>
<div class="save-scope-sheet" id="saveScopeSheet" style="display:none;">
  <p class="save-scope-title">Wo speichern?</p>
  <button type="button" id="saveScopeOnlyCurrent" class="save-scope-btn save-scope-btn-current">Nur für dieses Inserat / diesen Tag</button>
  <button type="button" id="saveScopeToCookbook" class="save-scope-btn save-scope-btn-cookbook">Als Standard im Kochbuch speichern</button>
  <button type="button" id="saveScopeCancel" class="save-scope-cancel" aria-label="Abbrechen">Abbrechen</button>
</div>

<!-- Abholnummer (bildschirmfüllend) -->
<div class="backdrop" id="codeBd" onclick="closeCodeSheet()"></div>
<div class="quick-ticket" id="codeSheet">
  <button class="quick-ticket-close" onclick="closeCodeSheet()" aria-label="Schließen">
    <i data-lucide="x"></i>
  </button>
  <div class="quick-ticket-content">
    <div class="quick-ticket-header">
      <div class="quick-ticket-logo" id="codeProviderLogo"></div>
      <div class="quick-ticket-provider" id="codeProvider">Anbieter</div>
      <div class="quick-ticket-time" id="codePickupWindow">Essenszeit: –</div>
    </div>
    <div class="quick-ticket-code">
      <div class="quick-ticket-code-label">Abholnummer</div>
      <div class="quick-ticket-code-value" id="codeText">A1</div>
    </div>
    <div class="quick-ticket-details">
      <div class="quick-ticket-detail-item">
        <div class="quick-ticket-detail-label">Gericht</div>
        <div class="quick-ticket-detail-value" id="codeSummary">–</div>
      </div>
      <div class="quick-ticket-detail-item">
        <div class="quick-ticket-detail-label">Abholzeit</div>
        <div class="quick-ticket-detail-value" id="codePickupTime">offen</div>
      </div>
    </div>
    <div class="quick-ticket-status" id="codeStatus">Status: offen</div>
    <div class="quick-ticket-actions">
      <button class="btn" type="button" id="btnToggleOrderStatus">Als abgeholt markieren</button>
    </div>
  </div>
</div>

<!-- Bestelldetail-Sheet (für Bestellungen ohne Abholnummer oder Übersicht) -->
<div class="backdrop" id="orderDetailBd" onclick="closeOrderDetailSheet()"></div>
<div class="sheet" id="orderDetailSheet" style="max-width:420px; border-radius:24px; overflow:hidden;">
  <div class="handle"></div>
  <div class="sheet-body" style="padding:24px;">
    <div style="font-family:'Nunito',sans-serif; font-weight:800; font-size:18px; margin-bottom:20px; color:#1a1a1a;">Bestelldetails</div>
    <div id="orderDetailContent" style="display:flex; flex-direction:column; gap:14px; font-size:15px;">
      <!-- Wird dynamisch befüllt -->
    </div>
    <div id="orderDetailAbholnummerBlock" style="margin-top:20px; padding:16px; background:rgba(255,215,0,0.12); border-radius:16px; border:1px solid rgba(255,215,0,0.3); display:none;">
      <div style="font-weight:800; font-size:14px; margin-bottom:8px; color:#1a1a1a;">🧾 Abholnummer</div>
      <div id="orderDetailCode" style="font-family:monospace; font-size:22px; font-weight:900; letter-spacing:2px; color:#1a1a1a; margin-bottom:12px;">–</div>
      <button type="button" id="btnOrderDetailShowCode" class="btn-primary" style="width:100%; min-height:48px; font-weight:800; border-radius:14px; background:#FFD700; color:#1a1a1a; border:none;">Abholnummer vorzeigen</button>
    </div>
    <button type="button" onclick="closeOrderDetailSheet()" style="margin-top:20px; width:100%; padding:14px; font-size:15px; font-weight:600; color:#64748b; background:transparent; border:1px solid rgba(0,0,0,.1); border-radius:14px; cursor:pointer;">Schließen</button>
  </div>
</div>

<!-- Legal Sheets (Impressum, AGB, Datenschutz) -->
<div class="backdrop" id="legalBd" onclick="closeLegalSheet()"></div>
<!-- AGB Onboarding Modal (1-Screen) -->
<div class="backdrop" id="agbOnboardingBd" onclick="closeAgbOnboardingModal()"></div>
<div class="sheet" id="agbOnboardingSheet">
  <div class="handle"></div>
  <div class="sheet-body" style="padding:24px;">
    <div id="agbOnboardingContent">
      <!-- Wird dynamisch befüllt -->
    </div>
    <div style="display:flex; gap:12px; margin-top:20px;">
      <button class="btn" type="button" id="btnAgbOnboardingAccept" style="flex:1; min-height:56px;">
        Akzeptieren
      </button>
      <button class="btn secondary" type="button" id="btnAgbOnboardingCancel" style="flex:1; min-height:56px;">
        Abbrechen
      </button>
    </div>
  </div>
</div>

<div class="sheet" id="legalSheet">
  <div class="handle"></div>
  <div class="sheet-body" style="max-height:80vh; overflow-y:auto;">
    <div class="panel" id="legalContent">
      <!-- Wird dynamisch befüllt -->
    </div>
  </div>
</div>

<!-- FAQ Sheet (Alle Fragen) -->
<div class="backdrop" id="faqBd" onclick="closeFaqSheet()"></div>
<div class="sheet" id="faqSheet">
  <div class="handle"></div>
  <div class="sheet-body" style="max-height:85vh; overflow-y:auto; padding:16px;">
    <div style="font-weight:600; font-size:18px; margin-bottom:16px; line-height:1.3;">Häufige Fragen</div>
    <div class="faq" id="faqSheetContent">
      <!-- Wird dynamisch befüllt -->
    </div>
  </div>
</div>

<!-- Pickup Detail Sheet (Sammel-Ansicht: Abholnummer + Gerichte + Vor Ort/Mehrweg + Alles übergeben) -->
<div class="backdrop" id="pickupConfirmBd" onclick="closePickupConfirmSheet()"></div>
<div class="sheet" id="pickupConfirmSheet">
  <div class="handle"></div>
  <div class="sheet-body" style="padding:24px;">
    <div style="font-weight:700; font-size:14px; color:var(--muted); margin-bottom:4px;">Abholnummer</div>
    <div style="font-size:40px; font-weight:900; font-family:monospace; color:var(--brand); margin-bottom:8px; line-height:1;" id="pickupConfirmCode">#–</div>
    <div id="pickupConfirmIcons" style="display:flex; align-items:center; gap:10px; margin-bottom:20px; font-size:18px;">
      <span title="Vor Ort möglich">🍴</span><span title="Mehrweg verfügbar">🔄</span><span title="Abholnummer aktiv">🧾</span>
    </div>
    <div style="font-weight:700; font-size:15px; margin-bottom:10px; color:#1a1a1a;">Bestellte Gerichte</div>
    <div id="pickupConfirmDishes" style="display:flex; flex-direction:column; gap:10px; margin-bottom:24px;">
      <!-- Pro Gericht: Name + 🍴 Vor Ort oder 🔄 Mehrweg + Extras -->
    </div>
    <div style="display:flex; flex-direction:column; gap:12px;">
      <button class="btn" type="button" id="btnPickupConfirmYes" style="width:100%; min-height:56px; font-size:16px; font-weight:800; background:#2e7d32; color:#fff; border:none;">
        Alles übergeben &amp; Abgeholt
      </button>
      <button class="btn secondary" type="button" id="btnPickupConfirmNo" style="width:100%; min-height:50px; font-size:16px;">
        Abbrechen
      </button>
    </div>
  </div>
</div>
<!-- Erfolgs-Screen (nach Alles übergeben) -->
<div id="pickupSuccessOverlay" style="display:none; position:fixed; inset:0; background:rgba(34,139,34,0.95); z-index:9999; align-items:center; justify-content:center; flex-direction:column; padding:24px;">
  <div style="font-size:64px; margin-bottom:16px;">✅</div>
  <div style="font-size:28px; font-weight:900; color:#fff; margin-bottom:8px;">Erfolgreich abgeholt!</div>
  <div id="pickupSuccessNetto" style="font-size:20px; font-weight:700; color:rgba(255,255,255,0.95);">Netto-Verdienst: 0,00 €</div>
  <button type="button" id="btnPickupSuccessUndo" style="margin-top:24px; padding:10px 20px; background:rgba(255,255,255,0.2); color:#fff; border:1px solid rgba(255,255,255,0.5); border-radius:12px; font-size:14px; font-weight:600; cursor:pointer;">Versehentlich? Rückgängig</button>
</div>
<!-- Next-Step Popup (nächste Abholnummern) -->
<div id="pickupNextStepOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:10000; align-items:center; justify-content:center; padding:24px;">
  <div style="background:#fff; border-radius:24px; padding:24px; max-width:360px; width:100%; box-shadow:0 8px 32px rgba(0,0,0,0.2);">
    <div id="pickupNextStepTitle" style="font-size:20px; font-weight:800; margin-bottom:16px; color:#1a1a1a;">🎉 Noch 0 Essen offen!</div>
    <div id="pickupNextStepList" style="display:flex; flex-direction:column; gap:10px; margin-bottom:20px;"></div>
    <button type="button" id="btnPickupNextStepUndo" style="width:100%; margin-bottom:10px; padding:12px; border-radius:14px; border:1px solid #e2e8f0; background:#f8fafc; font-size:14px; font-weight:600; color:#64748b; cursor:pointer;">Zuletzt rückgängig (versehentlich abgeholt)</button>
    <button type="button" id="btnPickupNextStepClose" style="width:100%; padding:14px; border-radius:14px; border:2px solid rgba(0,0,0,.1); background:#fff; font-weight:700; font-size:15px; cursor:pointer;">Fertig</button>
  </div>
</div>

<!-- Profil anlegen Sheet (Kunde) -->
<div class="backdrop" id="profileCreateBd" onclick="closeProfileCreateSheet()"></div>
<div class="sheet" id="profileCreateSheet" style="max-width:420px; border-radius:24px; overflow:hidden;">
  <div class="handle"></div>
  <div class="sheet-body" style="padding:24px;">
    <div style="text-align:center; margin-bottom:20px;">
      <div style="width:56px; height:56px; margin:0 auto 12px; background:linear-gradient(135deg, rgba(255,215,0,0.2) 0%, rgba(255,184,0,0.1) 100%); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:28px;">👤</div>
      <h3 style="margin:0 0 6px; font-size:20px; font-weight:900; color:#2D3436;">Hallo! 👋</h3>
      <p class="hint" style="font-size:14px; color:#666; line-height:1.4;">Leg dir ein Profil an, um deine Mittagsbox überall dabei zu haben.</p>
    </div>
    <div style="display:flex; flex-direction:column; gap:14px;">
      <label style="font-size:13px; font-weight:600; color:#64748b;">Name (optional)</label>
      <input class="field" id="profileCreateName" type="text" placeholder="z.B. Max" autocomplete="name" style="width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border); font-size:16px; background:#fbfaf7;" />
      <label style="font-size:13px; font-weight:600; color:#64748b;">E-Mail-Adresse <span style="color:#e74c3c;">*</span></label>
      <input class="field" id="profileCreateEmail" type="email" placeholder="deine@email.de" autocomplete="email" style="width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border); font-size:16px; background:#fbfaf7;" />
      <button class="btn-primary" type="button" id="btnProfileCreateSubmit" style="width:100%; min-height:48px; font-size:16px; font-weight:700; margin-top:8px;">Profil anlegen</button>
      <button class="btn ghost" type="button" id="btnProfileCreateCancel" style="width:100%; min-height:44px;">Abbrechen</button>
    </div>
  </div>
</div>

<!-- Login Modal (Bottom Sheet) -->
<div class="backdrop" id="loginBd" onclick="closeLoginSheet()"></div>
<div class="sheet" id="loginSheet">
  <div class="handle"></div>
  <div class="sheet-body">
    <div class="panel">
      <h3 style="margin:0 0 8px;">Willkommen zurück 👋</h3>
      <div class="hint" style="margin-bottom:20px;">Melde dich an, um auf deine Abholnummern zuzugreifen.</div>
      <input class="field" id="loginModalEmail" type="email" placeholder="E-Mail" autocomplete="email" />
      <div style="height:10px"></div>
      <input class="field" id="loginModalPass" type="password" placeholder="Passwort" autocomplete="current-password" />
      <button class="btn" type="button" id="btnLoginModalLogin" style="margin-top:16px; width:100%;">Anmelden</button>
      <div style="margin-top:12px; text-align:center;">
        <button class="btn ghost" type="button" id="btnLoginModalDemo" style="width:auto; padding:8px 16px;">Demo-Login (ohne Anmeldung)</button>
      </div>
    </div>
  </div>
</div>

<!-- Provider Login Modal (Business-Login) -->
<div class="backdrop" id="providerLoginBd" onclick="closeProviderLoginModal()" style="background:rgba(0,0,0,0.7); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); display:none;"></div>
<div class="sheet" id="providerLoginSheet" style="max-width:420px; border-radius:24px; overflow:hidden; display:none;">
  <div class="sheet-body" style="padding:32px;">
    <div style="text-align:center; margin-bottom:24px;">
      <div style="width:64px; height:64px; margin:0 auto 16px; background:linear-gradient(135deg, rgba(255,204,0,0.2) 0%, rgba(255,184,0,0.1) 100%); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:32px;">
        🏪
      </div>
      <h3 style="margin:0 0 8px; font-size:24px; font-weight:900; color:#2D3436;">Gastgeber-Bereich</h3>
      <p class="hint" style="font-size:14px; color:#666; line-height:1.5;">Verwalte deine Angebote und Abholungen im Handumdrehen.</p>
    </div>
    <div style="display:flex; flex-direction:column; gap:16px;">
      <input class="field" id="providerLoginEmail" type="email" placeholder="E-Mail-Adresse" autocomplete="email" style="width:100%; padding:14px 16px; border-radius:14px; border:1px solid var(--border); font-size:16px; background:#fbfaf7;" />
      <input class="field" id="providerLoginPass" type="password" placeholder="Passwort" autocomplete="current-password" style="width:100%; padding:14px 16px; border-radius:14px; border:1px solid var(--border); font-size:16px; background:#fbfaf7;" />
      <button class="btn-primary" type="button" id="btnProviderLoginModal" style="width:100%; min-height:52px; font-size:16px; font-weight:700; margin-top:8px; background:linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); color:#fff; border:none;">
        <i data-lucide="log-in" style="width:20px;height:20px;"></i>
        <span>Einloggen</span>
      </button>
      <button class="btn ghost" type="button" onclick="closeProviderLoginModal();" style="width:100%; min-height:44px;">
        Abbrechen
      </button>
    </div>
    <details class="hint" style="margin-top:20px; padding:12px; background:rgba(0,0,0,0.04); border-radius:12px; font-size:12px; color:#64748b;">
      <summary style="cursor:pointer; font-weight:600;">Hilfe? Demo-Zugang</summary>
      <p style="margin:8px 0 0; line-height:1.5;">Beliebige E-Mail/Passwort → Einloggen. Thomas-Kurz Live-Check: <strong>thomas@thomas-kurz.de</strong> oder <strong>demo@mittagio.de</strong></p>
    </details>
  </div>
</div>

<!-- Sheet: App herunterladen – Startbildschirm -->
<div class="backdrop" id="pwaStartScreenBd" onclick="closePwaStartScreenSheet()" style="background:rgba(0,0,0,0.5); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); display:none;"></div>
<div class="sheet" id="pwaStartScreenSheet" style="max-width:400px; border-radius:24px; overflow:hidden; display:none;">
  <div class="handle"></div>
  <div class="sheet-body" style="padding:28px 24px;">
    <div style="text-align:center; margin-bottom:20px;">
      <div style="width:56px; height:56px; margin:0 auto 16px; background:rgba(255,215,0,0.25); border-radius:16px; display:flex; align-items:center; justify-content:center; font-size:28px;">📱</div>
      <h3 style="margin:0 0 8px; font-size:20px; font-weight:900; color:#1a1a1a;">App herunterladen</h3>
      <p style="margin:0 0 12px; font-size:15px; color:#64748b; line-height:1.55;">Lade Mittagio als App herunter – dann startest du es wie eine App vom Startbildschirm.</p>
      <p style="margin:0; font-size:14px; color:#64748b; line-height:1.5;"><strong>So geht’s:</strong> Im Browser auf <strong>Teilen</strong> (oder Menü ⋮) tippen → <strong>„Zum Startbildschirm hinzufügen“</strong> wählen. Auf manchen Geräten erscheint der Hinweis auch automatisch.</p>
    </div>
    <button type="button" id="pwaSheetInstallBtn" style="width:100%; min-height:52px; border-radius:14px; font-size:16px; font-weight:800; border:none; background:var(--brand,#FFD700); color:#1a1a1a; cursor:pointer; margin-bottom:10px;">Zum Startbildschirm hinzufügen</button>
    <button type="button" onclick="closePwaStartScreenSheet()" class="btn ghost" style="width:100%; min-height:48px; font-size:15px; font-weight:700; color:#64748b;">Schließen</button>
  </div>
</div>

<!-- Share sheet: Teile es mit deinen Kunden – WhatsApp, Instagram, Link -->
<div class="backdrop" id="shareBd" onclick="closeShareSheet()"></div>
<div class="sheet" id="shareSheet">
  <div class="handle"></div>
  <div class="sheet-body">
    <div class="panel">
      <div style="font-weight:900; font-size:18px;" id="shareSheetTitle">Teile es mit deinen Kunden</div>
      <div class="hint" id="shareSheetSubtitle" style="margin-top:4px;">
        Per WhatsApp, Instagram oder Link – deine Kunden finden das Gericht sofort.
      </div>
    </div>
    <div class="answers" style="margin-top:16px;">
      <button class="ans" type="button" id="btnShareWhatsApp">
        <i data-lucide="message-circle"></i><span>WhatsApp</span>
      </button>
      <button class="ans" type="button" id="btnShareInstagram">
        <i data-lucide="share-2"></i><span>Instagram</span>
      </button>
      <button class="ans" type="button" id="btnShareCopy">
        <i data-lucide="copy"></i><span>Link kopieren</span>
      </button>
    </div>
  </div>
</div>

<!-- Inseratsauswahl (Final): Zwei Buttons + Beliebte Gerichte, keine Preise/Bewertungen -->
<div class="backdrop" id="createFlowBd" onclick="closeCreateFlowSheet()"></div>
<div class="sheet sheet--kitchen" id="createFlowSheet">
  <div class="handle"></div>
  <div class="sheet-body">
    <div class="create-flow-title">Inseratsauswahl</div>

    <div class="create-flow-btns" style="margin-bottom:24px;">
      <button class="btn-create-primary" type="button" id="btnCreateNewDish" style="margin-bottom:12px;">
        <span class="plus-char" style="font-size:22px; line-height:1; color:#fff;">+</span>
        <span>Neues Gericht erstellen</span>
      </button>
      <button class="btn ghost" type="button" id="btnCreateFromCookbook" style="width:100%; min-height:52px; border:2px solid #e5e7eb; background:#fff; border-radius:14px; font-weight:700; color:#1a1a1a;">
        <span>📖 Aus dem Kochbuch hinzufügen</span>
      </button>
    </div>

    <div id="createFlowRennerSection" style="margin-top:8px;">
      <div class="hint" style="margin-bottom:10px; font-weight:800; color:#1a1a1a; font-size:14px;">Beliebte Gerichte</div>
      <div id="createFlowRennerScroll" class="create-flow-renner-scroll" style="display:flex; gap:14px; overflow-x:auto; -webkit-overflow-scrolling:touch; padding:4px 0 16px; scroll-snap-type:x proximity;">
        <!-- Kacheln: Bild, 3 Säulen (🍴🧾🔄), Name, Success-Fact, Heute anbieten -->
      </div>
      <div id="createFlowRennerEmpty" style="display:none; text-align:center; padding:24px 16px; color:#64748b; font-size:14px;">Noch keine beliebten Gerichte – leg Gerichte im Kochbuch an oder biete sie an.</div>
    </div>

    <div class="create-flow-hint hint" id="createFlowDateHint" style="display:none;"></div>
  </div>
</div>

<!-- Snackbar: Undo pickup -->
<div class="snackbar" id="pickupUndo">
  <span id="pickupUndoLabel">Abholung markiert</span>
  <button type="button" id="pickupUndoBtn">Rückgängig</button>
</div>
<!-- Snackbar: Wochenplan Gericht gelöscht – Rückgängig -->
<div class="snackbar" id="weekUndoSnackbar" style="display:none;">
  <span id="weekUndoLabel">Gericht entfernt</span>
  <button type="button" id="weekUndoBtn">Rückgängig</button>
</div>

<!-- Print view -->
<div id="printView" class="print-view"></div>

<!-- Provider Wizard sheet (single reusable) – Küchenmodus -->
<div class="backdrop" id="wbd" onclick="if(event.target===this) closeWizard();"></div>
<div class="sheet sheet--kitchen" id="wizard">
  <div class="handle"></div>
  <div class="sheet-body wizard-sheet-body">
    <div class="wizard" id="wBox">
      <div class="wizard-progress-dots" id="wizardProgressDots" aria-hidden="true"></div>
      <div class="wizard-scroll">
        <div class="w-top">
          <div class="w-title" id="wTitle">Setup</div>
          <div class="w-step" id="wStep">Schritt 1 von 5</div>
        </div>
        <div class="w-q" id="wQ">…</div>
        <p class="w-help" id="wHelp"></p>
        <div id="wContent"></div>
        <div class="wizard-footer" id="wizardFooter" style="display:none;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Fairness-Overlay (Pricing): öffnet bei Klick auf ⓘ neben Umsatzprognose -->
<div class="backdrop" id="pricingFairnessBd" onclick="closePricingFairnessOverlay()" style="z-index:1197;"></div>
<div id="pricingFairnessOverlay" class="pricing-fairness-overlay" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); max-width:min(400px, calc(100vw - 32px)); width:100%; padding:24px; border-radius:20px; background:rgba(255,255,255,0.92); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,0.6); box-shadow:0 20px 50px rgba(0,0,0,0.12); z-index:1198;">
  <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
    <h3 style="margin:0; font-size:18px; font-weight:900; color:#1a1a1a;">Preisübersicht</h3>
    <button type="button" onclick="closePricingFairnessOverlay()" aria-label="Schließen" style="width:40px; height:40px; border:none; background:rgba(0,0,0,0.06); border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:18px; color:#64748b;">×</button>
  </div>
  <div class="pricing-overview-stack" style="display:flex; flex-direction:column; gap:16px;">
    <div class="pricing-block pricing-block--abholnummer" style="padding:16px; background:rgba(16,185,129,0.08); border-radius:14px; border:1px solid rgba(16,185,129,0.25);">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
        <span style="width:12px; height:12px; border-radius:50%; background:#10b981; flex-shrink:0;" aria-hidden="true"></span>
        <span style="font-size:15px; font-weight:800; color:#1a1a1a;">Mit Abholnummer</span>
      </div>
      <p style="margin:0 0 12px; font-size:16px; font-weight:900; color:#059669;">0,89 € pro Vorgang</p>
      <ul style="margin:0; padding-left:20px; font-size:14px; line-height:1.6; color:#475569;">
        <li style="margin-bottom:6px;">Alle Transaktionskosten (EC/Kredit) inklusive</li>
        <li style="margin-bottom:6px;">Gilt auch bei mehreren Bestellungen</li>
        <li style="margin-bottom:0;">Gäste vor Ort: 0,00 €</li>
      </ul>
    </div>
    <div class="pricing-block pricing-block--inserat" style="padding:16px; background:rgba(255,215,0,0.1); border-radius:14px; border:1px solid rgba(250,204,21,0.35);">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
        <span style="width:12px; height:12px; border-radius:50%; background:#FACC15; flex-shrink:0;" aria-hidden="true"></span>
        <span style="font-size:15px; font-weight:800; color:#1a1a1a;">Nur Inserat</span>
      </div>
      <p style="margin:0 0 12px; font-size:16px; font-weight:900; color:#1a1a1a;">Einmalig 4,99 €</p>
      <ul style="margin:0; padding-left:20px; font-size:14px; line-height:1.6; color:#475569;">
        <li style="margin-bottom:6px;">1000 % Sichtbarkeit</li>
        <li style="margin-bottom:6px;">0 % Provision</li>
        <li style="margin-bottom:0;">100 % Umsatz bleibt bei dir</li>
      </ul>
    </div>
  </div>
  <button type="button" onclick="closePricingFairnessOverlay();" style="width:100%; margin-top:24px; padding:16px 24px; background:#10b981; color:#fff; font-size:16px; font-weight:800; border:none; border-radius:14px; cursor:pointer; box-shadow:0 4px 14px rgba(16,185,129,0.35);">Alles klar! Verstanden</button>
</div>

<!-- Login-Konflikt Modal (Ein-Gerät-Schranke) -->
<div class="backdrop" id="loginConflictBd" onclick="closeLoginConflictModal()" style="background:rgba(0,0,0,0.7); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); display:none;"></div>
<div class="sheet" id="loginConflictSheet" style="max-width:420px; border-radius:24px; overflow:hidden; display:none;">
  <div class="handle"></div>
  <div class="sheet-body" style="padding:24px;">
    <div style="text-align:center; margin-bottom:24px;">
      <div style="width:64px; height:64px; margin:0 auto 16px; background:linear-gradient(135deg, rgba(227,77,77,0.1) 0%, rgba(255,215,0,0.08) 100%); border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px solid rgba(227,77,77,0.3);">
        <i data-lucide="smartphone" style="width:32px;height:32px; color:#E34D4D;"></i>
      </div>
      <h2 style="margin:0 0 8px; font-size:24px; font-weight:900; color:#2D3436;">Anderes Gerät aktiv</h2>
      <p style="margin:0; font-size:15px; color:#666; line-height:1.5;">
        Du bist aktuell bereits auf einem anderen Gerät (z.B. Tablet Kasse) angemeldet. Mittagio unterstützt im Standard-Plan eine aktive Sitzung zur Zeit.
      </p>
    </div>
    
    <div style="display:flex; flex-direction:column; gap:12px; margin-bottom:20px;">
      <button class="btn" type="button" id="btnLoginConflictTakeover" style="width:100%; min-height:52px; background:#E34D4D; color:#fff; font-weight:800; border:none; border-radius:12px;">
        <i data-lucide="check-circle" style="width:20px;height:20px; margin-right:8px;"></i>
        Diesen Account hier nutzen
      </button>
      <button class="btn ghost" type="button" onclick="closeLoginConflictModal()" style="width:100%; min-height:44px;">
        Abbrechen
      </button>
    </div>
    
    <div style="padding-top:16px; border-top:1px solid #eee; text-align:center;">
      <p style="margin:0; font-size:12px; color:#666; line-height:1.5;">
        Du möchtest Küche und Kasse gleichzeitig vernetzen?<br>
        <a href="mailto:support@mittagio.de" style="color:#E34D4D; text-decoration:none; font-weight:600;">Melde dich bei Mike für das Team-Upgrade.</a>
      </p>
    </div>
  </div>
</div>

<!-- Support-Kontakt Sheet (Layout = Vorlage für Anbieter + Inseratsflow) -->
<div class="backdrop" id="supportContactBd" onclick="closeSupportContact()" style="background:rgba(0,0,0,0.7); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);"></div>
<div class="sheet" id="supportContactSheet">
  <div class="handle"></div>
  <div class="sheet-body support-layout-body" style="padding:24px;">
    <div style="margin-bottom:24px;">
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
        <i data-lucide="heart" style="width:28px;height:28px; color:#E34D4D;"></i>
        <h2 style="margin:0; font-size:24px; font-weight:900; color:#2D3436;">Support & Hilfe</h2>
      </div>
      <p style="margin:0; font-size:14px; color:#666; line-height:1.5;">
        Egal ob Fragen zur Abholnummer oder Feedback zur App – Mike freut sich auf deine Nachricht.
      </p>
    </div>
    
    <!-- 24h-Antwort-Garantie Badge -->
    <div class="support-style-badge" style="padding:16px; background:linear-gradient(135deg, rgba(46,204,113,0.1) 0%, rgba(39,174,96,0.08) 100%); border:2px solid rgba(46,204,113,0.3); border-radius:12px; margin-bottom:24px; text-align:center;">
      <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:8px;">
        <i data-lucide="clock" style="width:20px;height:20px; color:#2ECC71;"></i>
        <div style="font-weight:900; font-size:16px; color:#2ECC71;">24h-Antwort-Garantie</div>
      </div>
      <div style="font-size:13px; color:#666; line-height:1.5;">
        Wir schauen uns dein Anliegen sofort an und melden uns innerhalb der nächsten 24 Stunden persönlich bei dir.
      </div>
    </div>
    
    <!-- Themen-Auswahl -->
    <div style="margin-bottom:24px;">
      <div style="font-weight:700; font-size:15px; color:#2D3436; margin-bottom:12px;">Worum geht es?</div>
      <div style="display:flex; flex-direction:column; gap:12px;">
        <button class="btn secondary support-style-btn" type="button" onclick="selectSupportTopic('technik')" id="supportTopicTechnik" style="justify-content:flex-start; padding:16px; text-align:left; background:#fff; border:2px solid #e5e7eb; border-radius:12px;">
          <div style="display:flex; align-items:center; gap:12px; width:100%;">
            <i data-lucide="settings" style="width:24px;height:24px; color:#334155; flex-shrink:0;"></i>
            <div style="flex:1;">
              <div style="font-weight:700; font-size:15px; color:#2D3436; margin-bottom:4px;">Technik & App</div>
              <div style="font-size:12px; color:#666;">Probleme mit dem Küchenmodus, Abholnummern oder der App</div>
            </div>
          </div>
        </button>
        
        <button class="btn secondary support-style-btn" type="button" onclick="selectSupportTopic('abrechnung')" id="supportTopicAbrechnung" style="justify-content:flex-start; padding:16px; text-align:left; background:#fff; border:2px solid #e5e7eb; border-radius:12px;">
          <div style="display:flex; align-items:center; gap:12px; width:100%;">
            <i data-lucide="wallet" style="width:24px;height:24px; color:#334155; flex-shrink:0;"></i>
            <div style="flex:1;">
              <div style="font-weight:700; font-size:15px; color:#2D3436; margin-bottom:4px;">Abrechnung & Zahlung</div>
              <div style="font-size:12px; color:#666;">Fragen zu Gebühren, Auszahlungen oder Rechnungen</div>
            </div>
          </div>
        </button>
        
        <button class="btn secondary support-style-btn" type="button" onclick="selectSupportTopic('feedback')" id="supportTopicFeedback" style="justify-content:flex-start; padding:16px; text-align:left; background:#fff; border:2px solid #e5e7eb; border-radius:12px;">
          <div style="display:flex; align-items:center; gap:12px; width:100%;">
            <i data-lucide="message-square" style="width:24px;height:24px; color:#334155; flex-shrink:0;"></i>
            <div style="flex:1;">
              <div style="font-weight:700; font-size:15px; color:#2D3436; margin-bottom:4px;">Feedback & Ideen</div>
              <div style="font-size:12px; color:#666;">Vorschläge zur Verbesserung oder Lob</div>
            </div>
          </div>
        </button>
      </div>
    </div>
    
    <!-- Kontaktformular (wird nach Themen-Auswahl angezeigt) -->
    <div id="supportContactForm" style="display:none;">
      <div style="margin-bottom:16px;">
        <label style="display:block; font-weight:600; font-size:14px; color:#2D3436; margin-bottom:8px;">Deine Nachricht</label>
        <textarea id="supportContactMessage" placeholder="Beschreibe dein Anliegen..." style="width:100%; min-height:120px; padding:12px 16px; border-radius:12px; border:1px solid #ddd; font-size:15px; font-family:inherit; resize:vertical;" rows="5"></textarea>
      </div>
      
      <button class="btn support-style-primary" type="button" onclick="submitSupportContact()" style="width:100%; min-height:52px; background:#E34D4D; color:#fff; font-weight:800; border:none; border-radius:12px;">
        <i data-lucide="send" style="width:20px;height:20px; margin-right:8px;"></i>
        Nachricht senden
      </button>
    </div>
    
    <button class="btn ghost support-style-btn" type="button" onclick="closeSupportContact()" style="width:100%; margin-top:16px; border:2px solid #e5e7eb; border-radius:12px;">Abbrechen</button>
  </div>
</div>

<script>
  // ========== Stripe einrichten (Zahlungen) ==========
  // 1. Publishable Key von https://dashboard.stripe.com/apikeys hier eintragen (pk_test_... oder pk_live_...).
  // 2. Secret Key (sk_...) NUR in Netlify: Site settings → Environment variables → STRIPE_SECRET_KEY.
  const STRIPE_PUBLISHABLE_KEY = 'pk_test_51SyuhZPDULtp9rWO6GTtCQRqfLD7NggIpBa3RaDrBhF68nIwhEoiVkeuebq0llGsONAysRFCb4Hh3ofwcqYGiwri00DLckU2l9';  // Stripe Test – Geheimschlüssel nur in Netlify (STRIPE_SECRET_KEY)
  window.MITTAGIO_STRIPE = window.MITTAGIO_STRIPE || { publishableKey: STRIPE_PUBLISHABLE_KEY, apiBase: '' };

  // --- Storage keys ---
  const LS = {
    offers: 'mittagio_offers_v2',
    favs: 'mittagio_favs_v1',
    providerFavs: 'mittagio_provider_favs_v1',
    dishFavs: 'mittagio_dish_favs_v1',
    cart: 'mittagio_cart_v1',
    orders: 'mittagio_orders_v1',
    customer: 'mittagio_customer_v1',
    provider: 'mittagio_provider_v1',
    cookbook: 'mittagio_cookbook_v1',
    week: 'mittagio_week_v1',
    onboardingDraft: 'mittagio_onboarding_draft_v1',
    pickupDone: 'mittagio_pickup_done_v1',
    mode: 'mittagio_mode_v1',
    discoverView: 'mittagio_discover_view_v1',
    orderHistory: 'mittagio_order_history_v1',
    swipeOnboardingShown: 'mittagio_swipe_onboarding_shown_v1',
    cookbookSwipeHintShown: 'mittagio_cookbook_swipe_hint_v1',
    providerSession: 'mittagio_provider_session_v1',
    favPillars: 'mittagio_fav_pillars_v1', // { [dishId]: { vorOrt, abholnummer, mehrweg } } – 3-Säulen beim Favorisieren einfrieren
    transactions: 'mittagio_transactions_v1' // Transaktionen pro Inserat: id, vendor_id, base_price, addon_pickup, addon_price, total_amount, timestamp
  };
  const load = (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch { return d; } };
  const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

  // Abholzeit-Slots 11:00–14:30 im 15-Minuten-Takt (zentral für Cart + Checkout)
  function getTimeSlots(){
    const slots = [];
    for(let min = 11 * 60; min <= 14 * 60 + 30; min += 15){
      const h = Math.floor(min / 60), m = min % 60;
      slots.push(`${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`);
    }
    return slots;
  }
  window.TIME_SLOTS = window.TIME_SLOTS || getTimeSlots();

  // Cookie-Helfer für Single-Session (Session-ID im Cookie + DB)
  const SESSION_COOKIE_NAME = 'mittagio_session_id';
  const SESSION_COOKIE_DAYS = 30;
  function getCookie(name){
    const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return m ? decodeURIComponent(m[2]) : null;
  }
  function setCookie(name, value, days){
    const maxAge = (days || SESSION_COOKIE_DAYS) * 24 * 60 * 60;
    document.cookie = name + '=' + encodeURIComponent(value) + '; path=/; max-age=' + maxAge + '; SameSite=Lax';
  }
  function deleteCookie(name){
    document.cookie = name + '=; path=/; max-age=0';
  }

  function getFavPillars(dishId){ const m = load(LS.favPillars, {}); return m[dishId] || null; }
  function setFavPillars(dishId, pillars){ const m = load(LS.favPillars, {}); m[dishId] = pillars; save(LS.favPillars, m); }
  function renderPillarBars(vorOrt, abholnummer, mehrweg){
    // Hochwertige, app-like Icons mit Labels (statt Balken)
    // Design: Runde Badges mit Icon + Text darunter, horizontal angeordnet
    
    const styleBadge = (active, color) => `
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
      opacity:${active ? '1' : '0.4'}; filter:${active ? 'none' : 'grayscale(100%)'};
      transition:all 0.2s ease;
    `;
    
    const styleIcon = (color) => `
      width:36px; height:36px; border-radius:50%; background:${color}15; color:${color};
      display:flex; align-items:center; justify-content:center; border:1px solid ${color}30;
    `;
    
    const styleText = `font-size:10px; font-weight:600; color:#333; text-align:center; line-height:1.2; max-width:60px;`;

    return `
      <div style="display:flex; justify-content:center; gap:24px; padding:8px 0;">
        <!-- Vor Ort -->
        <div style="${styleBadge(vorOrt, '#27AE60')}">
          <div style="${styleIcon('#27AE60')}"><i data-lucide="utensils" style="width:18px;height:18px;"></i></div>
          <div style="${styleText}">Vor Ort</div>
        </div>
        
        <!-- Abholnummer: Aktiv = gelb #FFD700, Inaktiv = ausgegraut opacity 0.2 -->
        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; opacity:${abholnummer ? '1' : '0.2'}; filter:${abholnummer ? 'none' : 'grayscale(100%)'}; transition:all 0.2s ease;">
          <div style="width:36px; height:36px; border-radius:50%; background:${abholnummer ? '#FFD700' : 'rgba(0,0,0,0.08)'}; color:${abholnummer ? '#1a1a1a' : '#999'}; display:flex; align-items:center; justify-content:center; border:1px solid ${abholnummer ? 'rgba(255,215,0,0.6)' : 'rgba(0,0,0,0.1)'};">
            <i data-lucide="receipt" style="width:18px;height:18px;"></i>
          </div>
          <div style="${styleText}">Abholnummer</div>
        </div>
        
        <!-- Mehrweg -->
        <div style="${styleBadge(mehrweg, '#2980B9')}">
          <div style="${styleIcon('#2980B9')}"><i data-lucide="leaf" style="width:18px;height:18px;"></i></div>
          <div style="${styleText}">Mehrweg</div>
        </div>
      </div>
    `;
  }
  /** Favoriten-Mini: Nur Emojis (🍴 🧾 🔄), 🧾 mit gelbem Kreis wenn aktiv. */
  function renderPillarBarsFavMini(vorOrt, abholnummer, mehrweg){
    const wrap = (emoji, active, highlight) => highlight
      ? `<span class="abholnummer-highlight">${emoji}</span>`
      : `<span class="emoji-icon ${active ? 'active' : ''}">${emoji}</span>`;
    return `
      <div class="saeulen-mini">
        <span class="emoji-icon ${vorOrt ? 'active' : ''}">🍴</span>
        ${wrap('🧾', abholnummer, abholnummer)}
        <span class="emoji-icon ${mehrweg ? 'active' : ''}">🔄</span>
      </div>
    `;
  }
  /** Silicon-Valley Pills: Drei kompakte Status-Pills nebeneinander (🍴 VOR ORT, 🧾 ABHOLNUMMER, 🔄 MEHRWEG). Inaktiv: #eeeeee + grauer Text. */
  function renderPillarBarsDiscovery(vorOrt, abholnummer, mehrweg){
    const pill = (active, bg, emoji, labelActive, labelInactive) => {
      const bgColor = active ? bg : '#eeeeee';
      const textColor = active ? '#fff' : '#999';
      return `display:inline-flex; align-items:center; justify-content:center; gap:4px; height:24px; max-height:24px; padding:0 10px; border-radius:12px; font-size:11px; font-weight:800; color:${textColor}; letter-spacing:0.02em; white-space:nowrap; background:${bgColor};`;
    };
    return `
      <div class="ocm-pills-row" style="display:flex; flex-wrap:wrap; gap:6px; margin-top:8px;">
        <span style="${pill(vorOrt, '#27AE60', '🍴', 'VOR ORT', 'Kein Vor Ort')}">🍴 ${vorOrt ? 'VOR ORT' : 'Kein Vor Ort'}</span>
        <span style="${pill(abholnummer, '#FFD700', '🧾', 'ABHOLNUMMER', 'Keine Abholnummer')}">🧾 ${abholnummer ? 'ABHOLNUMMER' : 'Keine Abholnummer'}</span>
        <span style="${pill(mehrweg, '#2980B9', '🔄', 'MEHRWEG', 'Kein Mehrweg')}">🔄 ${mehrweg ? 'MEHRWEG' : 'Kein Mehrweg'}</span>
      </div>
    `;
  }
  function clearFavPillars(dishId){ const m = load(LS.favPillars, {}); delete m[dishId]; save(LS.favPillars, m); }

  function renderDiscoverCategories(){
    const bar = document.getElementById('discoverCategoriesBar');
    if(!bar) return;
    // Pills: Eintopf, Vesper, Vegetarisch, Snack (Hellgrau inaktiv, Blau aktiv)
    const cats = [
      {id:'near', label:'Alle', emoji:'✨'},
      {id:'Suppe', label:'Eintopf', emoji:'🍲'},
      {id:'Vesper', label:'Vesper', emoji:'🥩'},
      {id:'Vegetarisch', label:'Vegetarisch', emoji:'🥗'},
      {id:'Salat', label:'Snack', emoji:'🥪'},
    ];
    const active = activeDiscoverFilter === 'near' || !activeDiscoverFilter ? 'near' : activeDiscoverFilter;
    bar.innerHTML = cats.map(c => `
      <button type="button" class="discover-category-chip ${active===c.id ? 'active' : ''}" onclick="selectDiscoverCategory('${c.id}')">
        <span class="discover-pill-emoji">${c.emoji}</span><span>${c.label}</span>
      </button>
    `).join('');
  }

  function getDayName(date){
    const days = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'];
    return days[date.getDay()];
  }

  function renderDiscoverDays(){
    const bar = document.getElementById('discoverDaysBar');
    if(!bar) return;
    
    const days = [];
    const today = new Date();
    for(let i=0; i<7; i++){
      const d = new Date(today);
      d.setDate(today.getDate() + i);
      const iso = d.toISOString().split('T')[0];
      
      let label = i===0 ? 'Heute' : i===1 ? 'Morgen' : i===2 ? 'Übermorgen' : getDayName(d);
      days.push({ id: iso, label: label, date: d });
    }
    
    if(!activeDay) activeDay = days[0].id;
    
    bar.innerHTML = days.map(d => {
      const isActive = activeDay === d.id;
      const dateStr = d.date.getDate() + '.' + (d.date.getMonth() + 1) + '.';
      return `<button class="cust-chip ${isActive ? 'active' : ''}" onclick="selectDiscoverDay('${d.id}')">
        <span style="font-weight:800;">${d.label}</span>
        <span style="font-size:11px; opacity:0.7; margin-left:4px;">${dateStr}</span>
      </button>`;
    }).join('');
  }
  
  window.selectDiscoverDay = function(dayIso){
    activeDay = dayIso;
    renderDiscoverDays();
    renderDiscover();
  };
  
  window.selectDiscoverCategory = function(catId){
    if(catId === 'near' || catId === 'all'){
      activeDiscoverFilter = 'near';
    } else {
      activeDiscoverFilter = catId;
    }
    renderDiscoverCategories(); // Update active state
    renderDiscover();
  };

  function createModernOfferCard(o){
    const data = normalizeOffer(o);
    const card = document.createElement('div');
    card.className = 'cust-card';
    card.onclick = () => openOffer(data.id);
    
    const isFavorited = typeof dishFavs !== 'undefined' && dishFavs.has(String(data.id));
    
    // Image Section (Full-Width der Karte)
    const imgContainer = document.createElement('div');
    imgContainer.style.cssText = 'position:relative; width:100%; overflow:hidden;';
    
    const img = document.createElement('img');
    img.className = 'cust-card-img';
    img.style.display = 'block';
    img.style.width = '100%';
    img.style.objectFit = 'cover';
    img.src = data.imageUrl || 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=800&q=80';
    img.loading = 'lazy';
    imgContainer.appendChild(img);
    // Like Button
    const likeBtn = document.createElement('button');
    likeBtn.style.cssText = 'position:absolute; top:12px; right:12px; width:36px; height:36px; border-radius:10px; background:rgba(255,255,255,0.9); border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; color:#E34D4D; box-shadow:0 4px 12px rgba(0,0,0,0.1);';
    likeBtn.innerHTML = `<i data-lucide="heart" style="width:20px; height:20px; ${isFavorited ? 'fill:#E34D4D;' : ''}"></i>`;
    likeBtn.onclick = (e) => {
      e.stopPropagation();
      toggleFavorite(data.id, likeBtn);
    };
    imgContainer.appendChild(likeBtn);

    // Share Button
    const shareBtn = document.createElement('button');
    shareBtn.style.cssText = 'position:absolute; top:12px; right:56px; width:36px; height:36px; border-radius:10px; background:rgba(255,255,255,0.9); border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; color:#1a1a1a; box-shadow:0 4px 12px rgba(0,0,0,0.1);';
    shareBtn.innerHTML = '<i data-lucide="share-2" style="width:18px;height:18px;"></i>';
    shareBtn.onclick = (e) => {
      e.stopPropagation();
      shareOffer(data);
    };
    imgContainer.appendChild(shareBtn);
    
    card.appendChild(imgContainer);
    
    const p = offers.find(x => x.providerId === data.providerId);
    const vorOrt = !!(p && p.dineInPossible !== false);
    const abholnummer = !!(p && p.orderingEnabled !== false && (data.hasPickupCode || p.hasPickupCode));
    const mehrweg = !!(p && (p.reuse && p.reuse.enabled));
    
    // 3-Säulen-Zeile + Preis direkt unter dem Bild (links Icons, rechts Preis in Fettdruck)
    const pillarsRow = document.createElement('div');
    pillarsRow.style.cssText = 'display:flex; align-items:center; justify-content:space-between; padding:12px 16px;';
    const pillars = document.createElement('div');
    pillars.className = 'card-pillars status-container';
    pillars.innerHTML = `
      <div class="pillar-mini active green" title="Vor Ort essen">🍴</div>
      <div class="pillar-mini ${abholnummer ? 'active yellow' : ''}" title="Abholnummer aktiv">🧾</div>
      <div class="pillar-mini ${mehrweg ? 'active petrol' : ''}" title="Mehrweg verfügbar">🔄</div>
    `;
    const price = document.createElement('div');
    price.className = 'cust-card-price price-pill';
    price.textContent = euro(data.price);
    pillarsRow.appendChild(pillars);
    pillarsRow.appendChild(price);
    
    // Body: Restaurantname direkt über Gerichtname (kompakt in der Karte)
    const body = document.createElement('div');
    body.className = 'cust-card-body';
    body.appendChild(pillarsRow);
    
    const providerLine = document.createElement('div');
    providerLine.className = 'cust-card-meta';
    providerLine.style.marginBottom = '4px';
    providerLine.innerHTML = `<i data-lucide="store" style="width:14px;height:14px;"></i> <span>${(data.providerName || 'Anbieter').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span>`;
    body.appendChild(providerLine);
    
    const title = document.createElement('h3');
    title.className = 'cust-card-title';
    title.textContent = data.dish || 'Gericht';
    body.appendChild(title);

    // Gelber CTA: "In die Mittagsbox" (nur wenn Abholnummer)
    const ctaWrap = document.createElement('div');
    ctaWrap.style.cssText = 'padding:12px 16px 0;';
    const ctaBtn = document.createElement('button');
    ctaBtn.type = 'button';
    ctaBtn.className = 'btn';
    ctaBtn.style.cssText = 'width:100%; min-height:44px; border-radius:12px; background:#FFD700; color:#1a1a1a; font-weight:800; font-size:14px; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; transition:transform 0.2s, box-shadow 0.2s;';
    ctaBtn.innerHTML = (typeof iconMarkup === 'function' ? iconMarkup('shopping-basket') : '') + ' <span>In die Box 🥗</span>';
    ctaBtn.onmouseover = () => { ctaBtn.style.transform = 'scale(1.02)'; ctaBtn.style.boxShadow = '0 4px 12px rgba(255,215,0,0.4)'; };
    ctaBtn.onmouseout = () => { ctaBtn.style.transform = 'scale(1)'; ctaBtn.style.boxShadow = 'none'; };
    ctaBtn.onclick = (e) => {
      e.stopPropagation();
      e.preventDefault();
      if(!abholnummer){ showToast('Keine Abholnummer – nur ansehen.', 2000); return; }
      const thumb = card.querySelector('img');
      flyThumbnailToMittagsbox(thumb, () => {
        if(!addToCart(o)){ showToast('Fehler beim Hinzufügen.', 2000); return; }
        triggerHapticFeedback([20]);
        if(typeof triggerCartIconGlow === 'function') triggerCartIconGlow();
        showToast('In der Box! 🥗', 1500);
        if(typeof updateHeaderBasket === 'function') updateHeaderBasket();
      });
    };
    if(!abholnummer){ ctaBtn.style.background = '#e5e5e5'; ctaBtn.style.color = '#888'; ctaBtn.style.cursor = 'not-allowed'; ctaBtn.disabled = true; }
    ctaWrap.appendChild(ctaBtn);
    body.appendChild(ctaWrap);
    
    // Entfernungsangaben (🚶/🚗) dezent ganz unten
    if(data.distanceKm != null){
      const walkingMinutes = Math.round(Number(data.distanceKm) * 12);
      const carMinutes = Math.round(Number(data.distanceKm) * 1.5);
      const walkingMeters = Math.round(Number(data.distanceKm) * 1000);
      const distanceText = walkingMeters < 1000 ? walkingMeters + 'm' : Number(data.distanceKm).toFixed(1) + 'km';
      const mobilityRow = document.createElement('div');
      mobilityRow.style.cssText = 'margin-top:12px; padding:8px 16px 0; font-size:11px; color:#999; font-weight:500; display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap; border-top:1px solid rgba(0,0,0,0.04);';
      mobilityRow.innerHTML = `<span>🚶 ${walkingMinutes} min</span><span style="color:#ccc;">|</span><span>🚗 ${carMinutes} min</span><span style="color:#ccc;">|</span><span>📍 ${distanceText}</span>`;
      body.appendChild(mobilityRow);
    }
    
    card.appendChild(body);
    
    card.onclick = (e) => {
      if(e.target.closest('button')) return;
      openOffer(data.id);
    };
    
    return card;
  }

  function toggleFavorite(id, btn){
    if(!id) return;
    const sid = String(id);
    const isRemoving = dishFavs.has(sid);
    if(isRemoving){
      dishFavs.delete(sid);
      if(btn && btn.querySelector('i')) btn.querySelector('i').style.fill = 'none';
      showToast('Aus Favoriten entfernt');
    } else {
      dishFavs.add(sid);
      if(btn && btn.querySelector('i')) btn.querySelector('i').style.fill = '#E34D4D';
      showToast('Zu Favoriten hinzugefügt! ❤️');
      if(typeof haptic==='function') haptic(10); else if(navigator.vibrate) navigator.vibrate(10);
    }
    save(LS.dishFavs, Array.from(dishFavs));
    if(typeof renderFavorites === 'function') renderFavorites();
    if(typeof renderDiscover === 'function') renderDiscover();
  }

  function shareOffer(data){
    const shareUrl = location.origin + location.pathname + '#offer/' + data.id;
    const text = `Schau mal, das gibt es heute bei ${data.providerName}: ${data.dish}. Sollen wir hin?`;
    if(navigator.share){
      navigator.share({ title: data.dish, text: text, url: shareUrl });
    } else {
      navigator.clipboard.writeText(text + ' ' + shareUrl);
      showToast('Link kopiert!');
    }
  }

  


  // --- Order Store (localStorage MVP) - MUSS VOR VERWENDUNG DEFINIERT SEIN ---
  /**
   * @typedef {Object} Order
   * @property {string} id
   * @property {number} createdAt
   * @property {number} updatedAt
   * @property {string} dishId
   * @property {string} dishName
   * @property {string} providerId
   * @property {string} providerName
   * @property {string} [providerAddress]
   * @property {number} quantity
   * @property {number} unitPrice - in cents
   * @property {number} total - in cents
   * @property {'PICKUP'} fulfillType - Immer "Zum Mitnehmen" (keine Vor-Ort-Option)
   * @property {string} [etaTime]
   * @property {'CREATED'|'PAYMENT_PENDING'|'PAID'|'CANCELLED'|'COMPLETED'|'PICKED_UP'} status
   * @property {'EUR'} currency
   * @property {string} [stripeCheckoutSessionId]
   * @property {string} [stripePaymentIntentId]
   * @property {string} [receiptEmail]
   * @property {string} [pickupCode] - nur bei PAID (Format: "2B")
   * @property {number} [pickupCodeActivatedAt] - nur bei PAID
   * @property {string} [pickupDate] - ISO date "YYYY-MM-DD"
   * @property {string} [pickupWindow] - e.g. "11:30–14:30"
   * @property {'A'|'B'|'C'|'D'|'E'} [dishLetter] - nur bei PAID
   * @property {number} [runningNumber] - nur bei PAID
   * @property {string} [offerId] - Reference to offer
   * @property {'PAID'|'PICKED_UP'} [status] - Extended status
   * @property {boolean} isGuest
   */
  
  /**
   * Load orders from localStorage
   * @returns {Order[]}
   */
  function loadOrders(){
    try {
      const stored = localStorage.getItem(LS.orders);
      if(!stored) return [];
      const parsed = JSON.parse(stored);
      return Array.isArray(parsed) ? parsed : [];
    } catch(e){
      console.error('Error loading orders:', e);
      return [];
    }
  }
  
  /**
   * Save orders to localStorage
   * @param {Order[]} ordersList
   */
  function saveOrders(ordersList){
    try {
      localStorage.setItem(LS.orders, JSON.stringify(ordersList || []));
    } catch(e){
      if(e.name === 'QuotaExceededError'){
        // Bei Speicherüberlauf: nur letzte 200 Bestellungen behalten
        const trimmed = (ordersList || []).slice(-200);
        try {
          localStorage.setItem(LS.orders, JSON.stringify(trimmed));
          console.warn('Orders trimmed to last 200 due to storage quota.');
        } catch(e2){
          console.error('Error saving orders (trimmed):', e2);
        }
      } else {
        console.error('Error saving orders:', e);
      }
    }
  }
  
  /**
   * Add a new order
   * @param {Order} order
   * @returns {Order}
   */
  function addOrder(order){
    // Guard: pickupCode nur bei PAID
    if(order.pickupCode && order.status !== 'PAID'){
      console.warn('pickupCode should only be set when status is PAID');
      order.pickupCode = undefined;
      order.pickupCodeActivatedAt = undefined;
    }
    
    const ordersList = loadOrders();
    ordersList.push(order);
    saveOrders(ordersList);
    return order;
  }
  
  /**
   * Update an existing order
   * @param {string} orderId
   * @param {Partial<Order>} patch
   * @returns {Order|null}
   */
  function updateOrder(orderId, patch){
    const ordersList = loadOrders();
    const index = ordersList.findIndex(o => o.id === orderId);
    if(index === -1){
      console.error('Order not found:', orderId);
      return null;
    }
    
    const order = ordersList[index];
    
    // Guard: pickupCode nur bei PAID
    if(patch.pickupCode && patch.status !== 'PAID' && order.status !== 'PAID'){
      console.warn('pickupCode should only be set when status is PAID');
      patch.pickupCode = undefined;
      patch.pickupCodeActivatedAt = undefined;
    }
    
    // Merge patch
    const updated = {
      ...order,
      ...patch,
      updatedAt: Date.now()
    };
    
    ordersList[index] = updated;
    saveOrders(ordersList);
    return updated;
  }
  
  /**
   * Get order by ID
   * @param {string} orderId
   * @returns {Order|null}
   */
  function getOrderById(orderId){
    const ordersList = loadOrders();
    return ordersList.find(o => o.id === orderId) || null;
  }
  
  /**
   * List active orders (CREATED, PAYMENT_PENDING, PAID)
   * @returns {Order[]}
   */
  function listActiveOrders(){
    const ordersList = loadOrders();
    return ordersList.filter(o => 
      o.status === 'CREATED' || 
      o.status === 'PAYMENT_PENDING' || 
      o.status === 'PAID'
    );
  }
  
  /**
   * Generate pickup code (legacy: random 5-char code)
   * @param {number} [len=5]
   * @returns {string}
   */
  function generatePickupCode(len = 5){
    const alphabet = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789'; // ohne O/I/0/1
    let code = '';
    for(let i = 0; i < len; i++){
      code += alphabet[Math.floor(Math.random() * alphabet.length)];
    }
    
    // Optional: ensure uniqueness (wenn collision, neu generieren)
    const ordersList = loadOrders();
    const existingCodes = ordersList
      .filter(o => o.pickupCode)
      .map(o => o.pickupCode);
    
    if(existingCodes.includes(code)){
      // Collision: neu generieren (max 10 Versuche)
      for(let attempt = 0; attempt < 10; attempt++){
        code = '';
        for(let i = 0; i < len; i++){
          code += alphabet[Math.floor(Math.random() * alphabet.length)];
        }
        if(!existingCodes.includes(code)) break;
      }
    }
    
    return code;
  }
  
  /**
   * Assign pickup code (deterministic, mock)
   * Single source of truth: Order record
   * @param {Object} params
   * @param {string} params.providerId - Provider ID
   * @param {string} params.pickupDate - ISO date "YYYY-MM-DD"
   * @param {string} params.dishId - Dish/Offer ID
   * @returns {{dishLetter: string, runningNumber: number, pickupCode: string}}
   */
  function assignPickupCode({providerId, pickupDate, dishId}){
    // 1) Get today's active offers for provider (same pickupDate)
    const todayOffers = offers
      .filter(o => o.providerId === providerId && o.day === pickupDate && o.active !== false)
      .sort((a, b) => {
        // 2) Sort deterministically (createdAt or sortIndex)
        const timeA = a.createdAt || 0;
        const timeB = b.createdAt || 0;
        if(timeA !== timeB) return timeA - timeB;
        return (a.id || '').localeCompare(b.id || '');
      });
    
    // 3) Determine dishLetter based on index: 0->A, 1->B, 2->C, 3->D, 4->E
    const dishIndex = todayOffers.findIndex(o => o.id === dishId);
    if(dishIndex === -1){
      // Fallback: use first dish (A)
      const dishLetter = 'A';
      const ordersList = loadOrders();
      // 4) Find existing orders for (providerId + pickupDate + dishLetter)
      const existingOrders = ordersList.filter(o => 
        o.providerId === providerId && 
        o.pickupDate === pickupDate && 
        o.dishLetter === dishLetter &&
        o.status === 'PAID'
      );
      // 5) runningNumber = existingCount + 1
      const runningNumber = existingOrders.length + 1;
      // 6) pickupCode = `${runningNumber}${dishLetter}`
      const pickupCode = `${runningNumber}${dishLetter}`;
      return {dishLetter, runningNumber, pickupCode};
    }
    
    const position = Math.min(dishIndex, 4); // Max 5 dishes (0-4)
    const dishLetter = String.fromCharCode(65 + position); // A=65, B=66, etc. (0→A, 1→B, ...)
    
    // 4) Find existing orders for (providerId + pickupDate + dishLetter)
    const ordersList = loadOrders();
    const existingOrders = ordersList.filter(o => 
      o.providerId === providerId && 
      o.pickupDate === pickupDate && 
      o.dishLetter === dishLetter &&
      o.status === 'PAID'
    );
    
    // 5) runningNumber = existingCount + 1
    const runningNumber = existingOrders.length + 1;
    
    // 6) pickupCode = `${runningNumber}${dishLetter}`
    const pickupCode = `${runningNumber}${dishLetter}`;
    
    return {dishLetter, runningNumber, pickupCode};
  }
  
  /**
   * Generate dish-letter pickup code (legacy wrapper, uses assignPickupCode)
   * @param {string} orderId - Order ID
   * @param {string} dishId - Dish/Offer ID
   * @param {string} providerIdVal - Provider ID (from order)
   * @param {string} day - ISO date string (YYYY-MM-DD)
   * @returns {{code: string, dishLetter: string, runningNumber: number}} - Format: "1A", "2A", "3B", etc.
   */
  function generateDishLetterPickupCode(orderId, dishId, providerIdVal, day){
    const pickupDate = day || isoDate(new Date());
    // Use assignPickupCode (deterministic)
    const result = assignPickupCode({providerId: providerIdVal, pickupDate, dishId});
    return {code: result.pickupCode, dishLetter: result.dishLetter, runningNumber: result.runningNumber};
  }

  // --- State ---
  let mode = load(LS.mode, 'customer'); // 'start' | 'customer' | 'provider' (Standard: 'customer' für Discover-Seite)
  // Angebote werden später durch seedExampleData() oder seed() geladen
  // Zuerst aus localStorage laden, falls vorhanden
  let offers = load(LS.offers, []);
  const legacyFavs = load(LS.favs, []);
  let providerFavs = new Set(load(LS.providerFavs, legacyFavs));
  let dishFavs = new Set(load(LS.dishFavs, []));
  let cart = load(LS.cart, null); // {providerId, items:[{offerId, qty}]} or null
  let orders = loadOrders(); // Load via Order Store
  let customer = load(LS.customer, {
    current_session_id: null, 
    loggedIn:false, 
    name:null,
    email:null,
    dietaryPreferences: {
      vegan: false,
      vegetarian: false,
      glutenFree: false,
      lactoseFree: false
    },
    reuseEnabled: false
  });
  let provider = load(LS.provider, { loggedIn:false, email:null, current_session_id:null, profile:{ name:'', address:'', street:'', zip:'', city:'', mealWindow:'11:30 – 14:00', mealStart:'11:30', mealEnd:'14:00', lunchWeekdays:[1,2,3,4,5], phone:'', email:'', website:'', logoData:'', reuseEnabledByDefault:false, abholnummerEnabledByDefault:false, wantsAllergensByDefault:false } });
  let cookbook = load(LS.cookbook, []); // [{id, dish, category, price, allergens[], extras?, reuse? , photoData?}]
  let week = load(LS.week, {}); // { 'YYYY-MM-DD': [{ providerId, cookbookId, dish, price, timeStart?, timeEnd? }, ...] }

  const CATEGORIES = ['Vegetarisch','Vegan','Fisch','Mit Fleisch'];
  /** Kochbuch MASTER-SPEC (MagazinKochbuch): Pills = Alle, Fleisch, Eintopf, Snack, Vegetarisch */
  const COOKBOOK_CATEGORIES = ['Alle','Fleisch','Eintopf','Snack','Vegetarisch'];
  const CAT_MAP = {
    'Vegan':'Vegan',
    'Vegetarisch':'Vegetarisch',
    'Fisch':'Fisch',
    'Mit Fleisch':'Fleisch',
    'Fleisch':'Fleisch',
    'Geflügel':'Geflügel',
    'Pasta':'Pasta',
    'Suppe':'Suppe',
    'Salat':'Salat',
    'Burger':'Burger',
    'Beilage':'Beilage'
  };
  /** Platzhalter-Bild im Inserat-Wizard (1x1, hellgrau) */
  const WIZARD_PLACEHOLDER_IMAGE = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="1" height="1"%3E%3Crect fill="%23f0f0f0" width="1" height="1"/%3E%3C/svg%3E';
  /** Haptisches Feedback (Vibration) – nur wo erlaubt (z.B. nach Nutzerinteraktion) */
  function haptic(ms){ try { if(navigator.vibrate) navigator.vibrate(ms !== undefined ? ms : 10); } catch(e){} }

  /** Kategorie → Emoji (Bestellhistorie & Pills) */
  const CAT_EMOJI = {
    'Vegan':'🌱',
    'Vegetarisch':'🌿',
    'Fisch':'🐟',
    'Mit Fleisch':'🥩',
    'Fleisch':'🥩',
    'Geflügel':'🍗',
    'Pasta':'🍝',
    'Suppe':'🥣',
    'Salat':'🥗',
    'Burger':'🍔',
    'Beilage':'🍟',
    '🥩':'🥩','🍗':'🍗','🐟':'🐟','🌿':'🌿','🌱':'🌱','🍝':'🍝','🥣':'🥣','🥗':'🥗','🍔':'🍔','🍟':'🍟'
  };
  const DISH_SUGGESTIONS = [
    {name:'Kürbissuppe', category:'Vegan'},
    {name:'Tomatensuppe mit Brot', category:'Vegan'},
    {name:'Pasta mit Gemüse', category:'Vegetarisch'},
    {name:'Käsespätzle', category:'Vegetarisch'},
    {name:'Salat Bowl', category:'Vegetarisch'},
    {name:'Falafel Teller', category:'Vegan'},
    {name:'Veggie Burger', category:'Vegan'},
    {name:'Schnitzel mit Pommes', category:'Fleisch'},
    {name:'Currywurst', category:'Fleisch'},
    {name:'Gulasch mit Spätzle', category:'Fleisch'}
  ];

  // Day slider: today..+6
  // Format: "Montag, 24.01." (immer vollständiger Wochentag + DD.MM.)
  function fmtDay(d, includeToday = false){
    const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
    const wd = weekdays[d.getDay()];
    const day = String(d.getDate()).padStart(2,'0');
    const month = String(d.getMonth()+1).padStart(2,'0');
    
    if(includeToday){
      const today = new Date();
      const isToday = d.toDateString() === today.toDateString();
      if(isToday){
        return `Heute, ${wd} ${day}.${month}.`;
      }
    }
    
    return `${wd}, ${day}.${month}.`;
  }
  
  // Format date with time range: "Montag, 24.01. · 11:30–14:30"
  function fmtDateWithTime(d, timeRange){
    const dateStr = fmtDay(d);
    return timeRange ? `${dateStr} · ${timeRange}` : dateStr;
  }
  
  function isoDate(d){ return d.toISOString().slice(0,10); }

  let activeCat = null;
  let activeDay = isoDate(new Date());
  let providerWeekDay = isoDate(new Date());
  let pickupSort = 'code'; // Default: sort by code (1A, 1B, 1C, 2A, 2B...)
  let pickupFilter = 'offen'; // 'offen' | 'abgeholt'
  let cookbookCategory = 'Alle'; // Konzept: Alle | Fleisch | Eintopf | Snack | Vegetarisch (docs/KOCHBUCH_KONZEPT.md)
  let cookbookMagazineIndex = 0; // aktuell angezeigte Magazin-Karte (filtered[cookbookMagazineIndex])
  let selectedCookbookId = null; // wird auf aktuelle Magazin-Karte gesetzt (für BEARBEITEN/WOCHENPLAN/AUSWÄHLEN)
  let cookbookSortBy = 'date'; // 'date' | 'quantity' | 'price' | 'name'
  let cookbookShowSortMenu = false;
  let cookbookSearchTerm = '';
  let cookbookIsSearching = false;
  let weekPlanDay = isoDate(new Date());
  let weekPlanMode = 'overview'; // 'overview' | 'edit' – Zwei-Phasen: Ansehen vs. Bearbeiten (app-first, Sofa)
  let weekPlanKWIndex = 0; // 0 = aktuelle KW, 1 = nächste, … (KW-Board)
  let weekSortMode = false;
  let weekUndoPending = null;
  let weekUndoTimer = null;
  let weekJustSwiped = false;
  let weekPlanSortMode = false;
  let locationQuery = ''; // Wird durch Auto-GPS oder manuelle Eingabe gesetzt; Fallback: Schorndorf (73614)
  let userLat = null;
  let userLng = null;
  const SCHORNDORF_LAT = 48.8014;
  const SCHORNDORF_LNG = 9.5282;
  const DEFAULT_LOCATION_FALLBACK = 'Schorndorf';
  let pickupDone = new Set(load(LS.pickupDone, []));
  let activeOrderId = null;
  let ordersFilter = 'offen';
  let pickupUndoKey = null;
  let pickupUndoTimer = null;
  let billingFilter = 'month';
  let billingMonth = '2026-01';

  // --- Seed: Keine weiteren Demo-Anbieter (nur Thomas Kurz über seedDemoProvider) ---
  function seed(){
    offers = [];
    save(LS.offers, offers);
  }

  // --- Beispieldaten: Keine weiteren Demo-Anbieter (nur Thomas Kurz über seedDemoProvider). ---
  function seedExampleData(){
    const today = isoDate(new Date());
    const providerNames = []; // Alle Demo-Anbieter außer Thomas Kurz entfernt

    const dishTemplates = [
      // Verschiedene Kategorien
      {dish: 'Kürbissuppe', category: 'Vegan', price: 6.50, img: 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Pasta Carbonara', category: 'Mit Fleisch', price: 8.80, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Salat Bowl', category: 'Vegetarisch', price: 7.90, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Hähnchen Teriyaki', category: 'Mit Fleisch', price: 9.20, img: 'https://images.unsplash.com/photo-1603133872878-684f208fb84b?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Falafel Teller', category: 'Vegan', price: 7.50, img: 'https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Käsespätzle', category: 'Vegetarisch', price: 7.20, img: 'https://images.unsplash.com/photo-1546069901-d5bfd2cbfb1f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Pizza Margherita', category: 'Vegetarisch', price: 8.50, img: 'https://images.unsplash.com/photo-1571997478779-2adcbbe9ab2f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Lachs mit Gemüse', category: 'Fisch', price: 10.50, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Veggie Burger', category: 'Vegan', price: 7.90, img: 'https://images.unsplash.com/photo-1525059696034-4967a7290027?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Schnitzel mit Pommes', category: 'Mit Fleisch', price: 9.80, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Quinoa-Salat', category: 'Vegan', price: 8.20, img: 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Thunfisch-Steak', category: 'Fisch', price: 11.20, img: 'https://images.unsplash.com/photo-1569718212165-3a8278d5f624?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Gulasch mit Spätzle', category: 'Mit Fleisch', price: 9.50, img: 'https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Gemüse-Curry', category: 'Vegan', price: 8.60, img: 'https://images.unsplash.com/photo-1546069901-d5bfd2cbfb1f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Risotto ai Funghi', category: 'Vegetarisch', price: 8.90, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Sushi Platte', category: 'Fisch', price: 12.50, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Steak mit Beilagen', category: 'Mit Fleisch', price: 13.90, img: 'https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Buddha Bowl', category: 'Vegan', price: 8.80, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Caprese Salat', category: 'Vegetarisch', price: 7.40, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Fischfilet mit Kartoffeln', category: 'Fisch', price: 10.80, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Chili con Carne', category: 'Mit Fleisch', price: 8.70, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Avocado-Bowl', category: 'Vegan', price: 9.50, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Mozzarella-Pasta', category: 'Vegetarisch', price: 8.30, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Lachs-Tartar', category: 'Fisch', price: 11.90, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Hamburger Classic', category: 'Mit Fleisch', price: 8.90, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Tofu-Wrap', category: 'Vegan', price: 7.60, img: 'https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Gemüse-Lasagne', category: 'Vegetarisch', price: 9.20, img: 'https://images.unsplash.com/photo-1546069901-d5bfd2cbfb1f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Forelle blau', category: 'Fisch', price: 10.40, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Rinderbraten', category: 'Mit Fleisch', price: 12.50, img: 'https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Power-Smoothie Bowl', category: 'Vegan', price: 6.90, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60'}
    ];

    const newOffers = [];
    const newCookbook = [];
    const newOrders = [];

    providerNames.forEach((provider, pIdx) => {
      // 3 Gerichte pro Provider (verschiedene Kategorien)
      const dishIndices = [
        (pIdx * 3) % dishTemplates.length,
        ((pIdx * 3 + 1) % dishTemplates.length),
        ((pIdx * 3 + 2) % dishTemplates.length)
      ];

      dishIndices.forEach((dishIdx, dIdx) => {
        const template = dishTemplates[dishIdx];
        const cookbookId = cryptoId();
        const offerId = cryptoId();

        // Kochbuch-Eintrag
        newCookbook.push({
          id: cookbookId,
          providerId: provider.id,
          dish: template.dish,
          category: template.category,
          price: template.price,
          allergens: [],
          extras: [],
          reuse: {enabled: false, deposit: 0},
          photoData: template.img,
          hasPickupCode: true,
          dineInPossible: false, // Keine Vor-Ort-Option - nur Abholnummer
          createdAt: Date.now() - (pIdx * 86400000) - (dIdx * 3600000),
          lastUsed: Date.now() - (pIdx * 86400000) - (dIdx * 3600000)
        });

        // Offer (Inserat für heute) – distanceKm für Kundenansicht (Discovery/Swipe, „10 Min“-Filter)
        newOffers.push({
          id: offerId,
          providerId: provider.id,
          providerName: provider.name,
          providerStreet: provider.street,
          providerZip: provider.zip,
          providerCity: provider.city,
          address: provider.address,
          dish: template.dish,
          category: template.category,
          price: template.price,
          pickupWindow: '11:30 – 14:00',
          day: today,
          imageUrl: template.img,
          hasPickupCode: true,
          dineInPossible: true,
          distanceKm: provider.distanceKm != null ? provider.distanceKm : (0.3 + (pIdx * 0.07) + (dIdx * 0.02)),
          allergens: [],
          extras: [],
          reuse: {enabled: (pIdx % 3) === 0, deposit: 0},
          active: true,
          createdAt: Date.now() - (pIdx * 3600000) - (dIdx * 600000)
        });
      });
    });

    // Zuerst Offers speichern, damit assignPickupCode sie verwenden kann
    // WICHTIG: Ersetze alte Offers, damit keine Duplikate entstehen
    offers = [...newOffers];
    save(LS.offers, offers);

    // Jetzt Bestellungen mit Abholnummers erstellen
    providerNames.forEach((provider, pIdx) => {
      const dishIndices = [
        (pIdx * 3) % dishTemplates.length,
        ((pIdx * 3 + 1) % dishTemplates.length),
        ((pIdx * 3 + 2) % dishTemplates.length)
      ];

      dishIndices.forEach((dishIdx, dIdx) => {
        const template = dishTemplates[dishIdx];
        // Finde das entsprechende Offer
        const offer = newOffers.find(o => 
          o.providerId === provider.id && 
          o.dish === template.dish
        );
        if(!offer) return;

        // 10 Bestellungen pro Provider (mit Abholnummers)
        // Verteilung: 3-4 pro Gericht
        const ordersPerDish = dIdx === 0 ? 4 : (dIdx === 1 ? 3 : 3);
        for(let o = 0; o < ordersPerDish; o++){
          const orderId = cryptoId();
          const pickupCode = assignPickupCode({
            providerId: provider.id,
            pickupDate: today,
            dishId: offer.id
          });

          newOrders.push({
            id: orderId,
            createdAt: Date.now() - (pIdx * 3600000) - (dIdx * 600000) - (o * 60000),
            updatedAt: Date.now() - (pIdx * 3600000) - (dIdx * 600000) - (o * 60000),
            dishId: offer.id,
            dishName: template.dish,
            providerId: provider.id,
            providerName: provider.name,
            providerAddress: provider.address,
            quantity: 1,
            unitPrice: Math.round(template.price * 100), // in cents
            total: Math.round(template.price * 100),
            fulfillType: 'PICKUP',
            status: 'PAID',
            currency: 'EUR',
            pickupCode: pickupCode.pickupCode,
            pickupCodeActivatedAt: Date.now() - (pIdx * 3600000) - (dIdx * 600000) - (o * 60000),
            pickupDate: today,
            pickupWindow: '11:30 – 14:00',
            dishLetter: pickupCode.dishLetter,
            runningNumber: pickupCode.runningNumber,
            offerId: offer.id,
            isGuest: false
          });
        }
      });
    });

    // Speichern (Offers bereits oben gespeichert)
    // Ersetze Cookbook komplett für Demo (keine Duplikate)
    const existingCookbook = cookbook.filter(c => !providerNames.some(p => p.id === c.providerId));
    cookbook = [...existingCookbook, ...newCookbook];
    save(LS.cookbook, cookbook);

    // Ersetze Bestellungen für Demo (kein Anhängen – vermeidet QuotaExceededError)
    saveOrders(newOrders);

    return {providers: providerNames.length, cookbook: newCookbook.length, offers: newOffers.length, orders: newOrders.length};
  }

  /** Demo-Anbieter: Metzgerei Thomas Kurz (Live-Check). Echte Adresse, Mittagstisch-Angebote. Login: thomas@thomas-kurz.de oder demo@mittagio.de */
  function seedDemoProvider(){
    const DEMO_EMAIL = 'thomas@thomas-kurz.de';
    const demoProviderId = 'prov_' + btoa(unescape(encodeURIComponent(DEMO_EMAIL))).slice(0, 16);
    const today = isoDate(new Date());
    const profile = {
      name: 'Metzgerei Thomas Kurz',
      address: 'Johann-Philipp-Palm-Straße 27, 73614 Schorndorf',
      street: 'Johann-Philipp-Palm-Straße 27',
      zip: '73614',
      city: 'Schorndorf',
      mealWindow: '11:30 – 14:00',
      mealStart: '11:30',
      mealEnd: '14:00',
      phone: '(07181) 94950',
      email: 'info@thomas-kurz.de',
      website: 'https://thomas-kurz.de',
      distanceKm: 0.2,
      logoData: ''
    };
    /* Metzgerei Thomas Kurz: 40 Gerichte im Kochbuch, 3 Tagesinserate (heute), 1 Woche voll mit je 3 Tagesessen. */
    const demoCookbookTemplates = [
      { dish: 'Steak in Pfifferling-Rahmsoße mit Spirelli und Salat', category: 'Mit Fleisch', price: 9.50, img: 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Kartoffelsuppe mit Würstchen', category: 'Mit Fleisch', price: 8.50, img: 'https://images.unsplash.com/photo-1547592166-23ac45744acd?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Leberkäse mit Kartoffelsalat', category: 'Mit Fleisch', price: 7.90, img: 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Schnitzel mit Pommes', category: 'Mit Fleisch', price: 9.80, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Gulasch mit Spätzle', category: 'Mit Fleisch', price: 9.50, img: 'https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Zwiebelrostbraten mit Bratkartoffeln', category: 'Mit Fleisch', price: 11.90, img: 'https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Käsespätzle', category: 'Vegetarisch', price: 7.20, img: 'https://images.unsplash.com/photo-1546069901-d5bfd2cbfb1f?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Linsen mit Spätzle', category: 'Vegetarisch', price: 6.90, img: 'https://images.unsplash.com/photo-1547592166-23ac45744acd?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Maultaschen mit Salat', category: 'Vegetarisch', price: 8.20, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Gemüse-Lasagne', category: 'Vegetarisch', price: 9.20, img: 'https://images.unsplash.com/photo-1546069901-d5bfd2cbfb1f?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Kürbissuppe', category: 'Vegan', price: 6.50, img: 'https://images.unsplash.com/photo-1547592166-23ac45744acd?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Salat Bowl', category: 'Vegetarisch', price: 7.90, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Rinderbraten mit Rotkohl und Klößen', category: 'Mit Fleisch', price: 12.50, img: 'https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Cordon Bleu mit Pommes', category: 'Mit Fleisch', price: 10.50, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Hackbraten mit Kartoffeln', category: 'Mit Fleisch', price: 9.20, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Schweinebraten mit Knödel', category: 'Mit Fleisch', price: 10.90, img: 'https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Roulade mit Rotkohl und Kartoffeln', category: 'Mit Fleisch', price: 11.20, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Tomatensuppe mit Brot', category: 'Vegetarisch', price: 5.90, img: 'https://images.unsplash.com/photo-1547592166-23ac45744acd?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Spinat mit Spiegelei und Kartoffeln', category: 'Vegetarisch', price: 7.50, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Risotto mit Pilzen', category: 'Vegetarisch', price: 8.90, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Fleischkäse mit Bratkartoffeln', category: 'Mit Fleisch', price: 8.20, img: 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Pasta Carbonara', category: 'Mit Fleisch', price: 8.80, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Hähnchen Teriyaki', category: 'Mit Fleisch', price: 9.20, img: 'https://images.unsplash.com/photo-1603133872878-684f208fb84b?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Falafel Teller', category: 'Vegan', price: 7.50, img: 'https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Pizza Margherita', category: 'Vegetarisch', price: 8.50, img: 'https://images.unsplash.com/photo-1571997478779-2adcbbe9ab2f?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Lachs mit Gemüse', category: 'Fisch', price: 10.50, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Veggie Burger', category: 'Vegan', price: 7.90, img: 'https://images.unsplash.com/photo-1525059696034-4967a7290027?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Quinoa-Salat', category: 'Vegan', price: 8.20, img: 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Thunfisch-Steak', category: 'Fisch', price: 11.20, img: 'https://images.unsplash.com/photo-1569718212165-3a8278d5f624?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Risotto ai Funghi', category: 'Vegetarisch', price: 8.90, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Sushi Platte', category: 'Fisch', price: 12.50, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Steak mit Beilagen', category: 'Mit Fleisch', price: 13.90, img: 'https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Buddha Bowl', category: 'Vegan', price: 8.80, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Caprese Salat', category: 'Vegetarisch', price: 7.40, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Fischfilet mit Kartoffeln', category: 'Fisch', price: 10.80, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Chili con Carne', category: 'Mit Fleisch', price: 8.70, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Avocado-Bowl', category: 'Vegan', price: 9.50, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Mozzarella-Pasta', category: 'Vegetarisch', price: 8.30, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Lachs-Tartar', category: 'Fisch', price: 11.90, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Hamburger Classic', category: 'Mit Fleisch', price: 8.90, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Tofu-Wrap', category: 'Vegan', price: 7.60, img: 'https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Forelle blau', category: 'Fisch', price: 10.40, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60' },
      { dish: 'Power-Smoothie Bowl', category: 'Vegan', price: 6.90, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60' }
    ];
    const demoCookbook = demoCookbookTemplates.map((t, i) => ({
      id: cryptoId(),
      providerId: demoProviderId,
      dish: t.dish,
      category: t.category,
      price: t.price,
      allergens: [],
      extras: [],
      reuse: { enabled: false, deposit: 0 },
      photoData: t.img,
      hasPickupCode: true,
      dineInPossible: true,
      createdAt: Date.now() - (45 - i) * 3600000,
      lastUsed: i < 8 ? Date.now() - (8 - i) * 86400000 : null
    }));
    cookbook = [...demoCookbook];
    save(LS.cookbook, cookbook);

    var demoOffers = [];
    var weekEntries = {};
    for(var dayOffset = 0; dayOffset < 7; dayOffset++){
      const d = new Date(); d.setDate(d.getDate() + dayOffset);
      const dayKey = isoDate(d);
      var dayOffers = [];
      var dayWeekEntries = [];
      for(var mealIdx = 0; mealIdx < 3; mealIdx++){
        const cb = demoCookbook[(dayOffset * 3 + mealIdx) % demoCookbook.length];
        var offerId = cryptoId();
        dayOffers.push({
          id: offerId,
          providerId: demoProviderId,
          providerName: profile.name,
          providerStreet: profile.street,
          providerZip: profile.zip,
          providerCity: profile.city,
          providerLogoData: profile.logoData,
          address: profile.address,
          dish: cb.dish,
          category: cb.category,
          price: cb.price,
          pickupWindow: profile.mealWindow,
          day: dayKey,
          imageUrl: cb.photoData,
          hasPickupCode: true,
          dineInPossible: true,
          distanceKm: profile.distanceKm,
          allergens: [],
          extras: [],
          reuse: { enabled: false, deposit: 0 },
          active: true,
          createdAt: Date.now()
        });
        dayWeekEntries.push({ providerId: demoProviderId, dish: cb.dish, cookbookId: cb.id, price: cb.price, active: true });
      }
      demoOffers = demoOffers.concat(dayOffers);
      weekEntries[dayKey] = dayWeekEntries;
    }
    offers = [...demoOffers];
    save(LS.offers, offers);

    week = { ...weekEntries };
    save(LS.week, week);

    var demoTransactions = [
      { id: cryptoId(), vendor_id: demoProviderId, inserat_id: 'Abrechnung Jan 2026', total_amount: 24.95, timestamp: new Date(Date.now() - 7 * 24 * 3600000).toISOString() },
      { id: cryptoId(), vendor_id: demoProviderId, inserat_id: 'Inseratsgebühr', total_amount: 4.99, timestamp: new Date(Date.now() - 14 * 24 * 3600000).toISOString() },
      { id: cryptoId(), vendor_id: demoProviderId, inserat_id: 'Abholnummer #12', total_amount: 0.89, timestamp: new Date(Date.now() - 21 * 24 * 3600000).toISOString() }
    ];
    var txs = load(LS.transactions, []);
    var txsFiltered = txs.filter(t => t.vendor_id !== demoProviderId);
    save(LS.transactions, [...demoTransactions, ...txsFiltered]);

    save('mittagio_demo_provider_profile', profile);
    var p = load(LS.provider, {});
    var isDemoLogin = p && (p.email === DEMO_EMAIL || p.email === 'demo@mittagio.de');
    if(isDemoLogin){
      p.profile = p.profile || {};
      p.profile.name = profile.name;
      p.profile.address = profile.address;
      p.profile.street = profile.street;
      p.profile.zip = profile.zip;
      p.profile.city = profile.city;
      p.profile.logoData = profile.logoData != null ? profile.logoData : p.profile.logoData;
      p.profile.mealWindow = profile.mealWindow;
      if(profile.phone != null) p.profile.phone = profile.phone;
      if(profile.email != null) p.profile.email = profile.email;
      if(profile.website != null) p.profile.website = profile.website;
      if(profile.mealStart != null) p.profile.mealStart = profile.mealStart;
      if(profile.mealEnd != null) p.profile.mealEnd = profile.mealEnd;
      save(LS.provider, p);
      provider = p;
    }

    return { cookbook: demoCookbook.length, offers: demoOffers.length, week: 7, transactions: demoTransactions.length };
  }

  // --- Test-Funktion für Abholnummer-Logik ---
  function testPickupCodeLogic(){
    const today = isoDate(new Date());
    
    // Test 1: Prüfe ob Beispieldaten vorhanden sind
    const allOrders = loadOrders();
    const allOffers = offers;
    const todayOrders = allOrders.filter(o => o.pickupDate === today && o.status === 'PAID');
    const todayOffers = allOffers.filter(o => o.day === today && o.active !== false);
    
    if(todayOrders.length === 0) return false;
    
    // Test 2: Prüfe Abholnummer-Format
    const codes = todayOrders.map(o => o.pickupCode).filter(Boolean);
    const invalidCodes = codes.filter(c => !/^\d+[A-E]$/.test(c));
    if(invalidCodes.length > 0) return false;
    
    // Test 3: Prüfe Eindeutigkeit pro Provider/Tag
    const providers = [...new Set(todayOrders.map(o => o.providerId))];
    let allUnique = true;
    providers.forEach(pid => {
      const providerOrders = todayOrders.filter(o => o.providerId === pid);
      const providerCodes = providerOrders.map(o => o.pickupCode);
      const uniqueCodes = [...new Set(providerCodes)];
      if(providerCodes.length !== uniqueCodes.length) allUnique = false;
    });
    if(!allUnique) return false;
    
    providers.forEach(pid => {
      const providerOffers = todayOffers.filter(o => o.providerId === pid).sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0));
      const providerOrders = todayOrders.filter(o => o.providerId === pid);
      const expectedLetters = ['A', 'B', 'C'];
      providerOffers.forEach((offer, idx) => {
        const expectedLetter = expectedLetters[idx] || 'A';
        const ordersForOffer = providerOrders.filter(o => o.offerId === offer.id);
        const lettersForOffer = [...new Set(ordersForOffer.map(o => o.dishLetter))];
        if(lettersForOffer.length !== 1 || lettersForOffer[0] !== expectedLetter) allUnique = false;
      });
    });
    
    providers.forEach(pid => {
      const providerOrders = todayOrders.filter(o => o.providerId === pid);
      ['A', 'B', 'C'].forEach(letter => {
        const ordersForLetter = providerOrders.filter(o => o.dishLetter === letter).sort((a,b) => a.runningNumber - b.runningNumber);
        if(ordersForLetter.length > 0){
          const numbers = ordersForLetter.map(o => o.runningNumber);
          const expected = Array.from({length: ordersForLetter.length}, (_, i) => i + 1);
          if(JSON.stringify(numbers) !== JSON.stringify(expected)) allUnique = false;
        }
      });
    });
    
    return allUnique;
  }

  // --- UI helpers ---
  function euro(n){
    const v = Number(n||0);
    return v.toFixed(2).replace('.',',') + ' €';
  }
  function cryptoId(){
    return 'id_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
  }
  function esc(s){
    return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[c]));
  }

  /** Erstes Wort aus Allergen-Label (z. B. "Erdnüsse" statt "Erdnüsse und daraus gewonnene Erzeugnisse"). */
  function allergenFirstWord(label){
    if(!label) return '';
    return String(label).trim().split(/\s+/)[0] || label;
  }

  /** Standardisierte Allergen-Übersetzung (ALLERGENE_OVERLAY_SPEC.md). Anbieter wählt Kürzel; nur zutreffende anzeigen. */
  const ALLERGENE_STANDARD = {
    'A':'Glutenhaltiges Getreide (Weizen, Roggen, Gerste etc.)',
    'B':'Krebstiere und daraus gewonnene Erzeugnisse',
    'C':'Eier und daraus gewonnene Erzeugnisse',
    'D':'Fische und daraus gewonnene Erzeugnisse',
    'E':'Erdnüsse und daraus gewonnene Erzeugnisse',
    'F':'Sojabohnen und daraus gewonnene Erzeugnisse',
    'G':'Milch und Milchprodukte (einschließlich Laktose)',
    'H':'Schalenfrüchte (Mandeln, Haselnüsse, Walnüsse etc.)',
    'L':'Sellerie und daraus gewonnene Erzeugnisse',
    'M':'Senf und daraus gewonnene Erzeugnisse',
    'N':'Sesamsamen und daraus gewonnene Erzeugnisse',
    'O':'Schwefeldioxid und Sulfite',
    'P':'Lupinen und daraus gewonnene Erzeugnisse',
    'R':'Weichtiere und daraus gewonnene Erzeugnisse'
  };
  const ALLERGENE_NAME_TO_CODE = { 'Gluten':'A','Laktose':'G','Sellerie':'L','Milch':'G','Eier':'C','Fisch':'D','Erdnüsse':'E','Soja':'F','Senf':'M','Sesam':'N','Schwefeldioxid':'O','Lupinen':'P','Krebstiere':'B','Schalenfrüchte':'H','Weichtiere':'R' };
  /** Flache Checkliste A–R für Inseratsflow (Spec). */
  const ALLERGENE_CHECKLIST_A_R = Object.entries(ALLERGENE_STANDARD).map(([code,label])=>({code,label})).filter(x=>/[A-R]/.test(x.code));

  const ICONS = {
    plus:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>',
    book:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M4 4.5A2.5 2.5 0 0 1 6.5 2H20v15H6.5A2.5 2.5 0 0 0 4 17.5z"/></svg>',
    share:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="m16 6-4-4-4 4"/><path d="M12 2v14"/></svg>',
    'share-2':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="m8.59 13.51 6.83 3.98"/><path d="m15.41 6.51-6.82 3.98"/></svg>',
    print:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 14h12v8H6z"/></svg>',
    edit:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>',
    action:'<svg viewBox="0 0 24 24" fill="currentColor"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/></svg>',
    heart:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.8 6.6a5 5 0 0 0-7.1 0L12 8.3l-1.7-1.7a5 5 0 1 0-7.1 7.1L12 22l8.8-8.3a5 5 0 0 0 0-7.1Z"/></svg>',
    heartFilled:'<svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><path d="M20.8 6.6a5 5 0 0 0-7.1 0L12 8.3l-1.7-1.7a5 5 0 1 0-7.1 7.1L12 22l8.8-8.3a5 5 0 0 0 0-7.1Z"/></svg>',
    cart:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2h12l2 7H4z"/><path d="M4 9h16v11a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V9Z"/></svg>',
    'shopping-cart':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>',
    'shopping-basket':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 8 3 20h18L19 8"/><path d="M9 8V6a3 3 0 0 1 6 0v2"/></svg>',
    location:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s7-7.2 7-12a7 7 0 1 0-14 0c0 4.8 7 12 7 12z"/><circle cx="12" cy="10" r="2.5"/></svg>',
    star:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 2 3 7 7 .6-5.2 4.5 1.6 7L12 17l-6.4 4.1 1.6-7L2 9.6 9 9z"/></svg>',
    box:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7l9-4 9 4-9 4-9-4Z"/><path d="M3 7v10l9 4 9-4V7"/><path d="M12 11v10"/></svg>',
    leaf:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 14c6-8 14-8 16-6-2 8-10 16-18 14 0-6 2-8 2-8Z"/><path d="M6 14c2 0 6 0 10-4"/></svg>',
    flame:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2s3 4 3 7a3 3 0 1 1-6 0c0-3 3-7 3-7Z"/><path d="M5.5 14.5a6.5 6.5 0 1 0 13 0c0-3.5-2.5-6.5-6.5-9-4 2.5-6.5 5.5-6.5 9Z"/></svg>',
    calendar:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>',
    eye:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6S2 12 2 12Z"/><circle cx="12" cy="12" r="3"/></svg>',
    info:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 10v6"/><path d="M12 7h.01"/></svg>',
    card:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/></svg>',
    home:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 11.5 12 4l9 7.5"/><path d="M5 10.5V20h14v-9.5"/></svg>',
    user:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20a8 8 0 0 1 16 0"/></svg>',
    compass:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M15 9l-2 6-6 2 2-6 6-2Z"/></svg>',
    receipt:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2h12v20l-3-2-3 2-3-2-3 2Z"/><path d="M8 6h8M8 10h8M8 14h6"/></svg>',
    bookOpen:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 5h7a4 4 0 0 1 4 4v12H6a4 4 0 0 0-4 4Z"/><path d="M22 5h-7a4 4 0 0 0-4 4v12h7a4 4 0 0 1 4 4Z"/></svg>',
    clock:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 7v6l4 2"/></svg>',
    globe:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M3 12h18"/><path d="M12 3a12 12 0 0 1 0 18"/><path d="M12 3a12 12 0 0 0 0 18"/></svg>',
    link:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 1 0-7l2-2a5 5 0 0 1 7 7l-2 2"/><path d="M14 11a5 5 0 0 1 0 7l-2 2a5 5 0 0 1-7-7l2-2"/></svg>',
    message:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a4 4 0 0 1-4 4H7l-4 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/></svg>',
    camera:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h4l2-3h4l2 3h4v12H4z"/><circle cx="12" cy="13" r="3"/></svg>',
    mail:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="m3 7 9 6 9-6"/></svg>',
    shield:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2 20 5v6c0 5-3.5 9-8 11-4.5-2-8-6-8-11V5z"/></svg>',
    file:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>',
    wallet:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7h18a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H3z"/><path d="M3 7V5a2 2 0 0 1 2-2h14"/><path d="M17 12h4"/></svg>',
    utensils:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 2v6a4 4 0 0 0 8 0V2"/><path d="M8 2v10"/><path d="M16 2v20"/><path d="M20 2v6a2 2 0 0 1-2 2h-2"/></svg>',
    // Mittagio Icon Set (Lucide Icons - Outline only)
    carrot:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2.5 16.88a1 1 0 0 1-.32-1.43l1.5-2.5a1 1 0 0 1 1.37-.37L8 15l5-5-2-2-5 5-3.13-1.95a1 1 0 0 0-1.37.37l-2.5 1.5a1 1 0 0 0-.5.88Z"/><path d="M16 21h5a1 1 0 0 0 1-1v-5"/><path d="M21 16l-5 5"/><path d="M11 2L9 4l5 5 2-2-5-5Z"/></svg>',
    drumstick:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15.5 9.5 12 13l-1-1-1 1c-1 1-2.5 1.5-4 1l-1 1c-.5.5-1 1.5-1 2.5 0 1 .5 1.5 1 2l2 2c.5.5 1 .5 1.5 0l1-1c-.5-1.5 0-3 1-4l1-1 1 1 3.5-3.5Z"/><path d="M20 2v10"/><path d="M22 4h-4"/></svg>',
    fish:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 10s3-3 8-3 8 3 8 3-3 3-8 3-8-3-8-3Z"/><path d="M4 10v4"/><path d="M8 10v4"/><path d="M12 10v4"/><path d="M16 10v4"/><path d="M2 16s3-3 8-3 8 3 8 3"/><path d="M2 4s3 3 8 3 8-3 8-3"/></svg>',
    'key-round':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="15" r="4"/><path d="m10 15 6-6"/><path d="m18 5 2 2"/><path d="m20 5-2 2"/></svg>',
    'credit-card':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/></svg>',
    'shopping-bag':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>',
    package:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 18v-8Z"/><path d="M3.27 6.96 12 12.01l8.73-5.05"/><path d="M12 22.08V12"/></svg>',
    'utensils-crossed':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15.5-1-.5.5"/><path d="M15 2v5"/><path d="M12 22V8"/><path d="M12 2v3"/><path d="M19 22V11"/><path d="M19 2v4"/><path d="M2 22l20-20"/></svg>',
    store:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7v13h16V7"/><path d="M4 7l2-5h12l2 5"/><path d="M9 12v6"/><path d="M15 12v6"/></svg>',
    'calendar-days':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/><path d="M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01M16 18h.01"/></svg>',
    'map-pin':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>',
    copy:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>',
    check:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6 9 17l-5-5"/></svg>',
    'arrow-left':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>',
    'maximize-2':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6"/><path d="M9 21H3v-6"/><path d="M21 3l-7 7"/><path d="M3 21l7-7"/></svg>',
    x:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg>',
    'alert-circle':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>'
  };
  // MITTAGIO Master-Icons: Spezielle Icons für Abholnummer, Vor Ort, Mehrweg
  function getMittagioMasterIcon(type){
    // type: 'pickup-code' | 'dine-in' | 'reuse'
    if(type === 'pickup-code'){
      // Abholnummer: "A1", Schwarz-Weiß-Kontrast
      return `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="stroke-width:2.5;">
        <rect x="4" y="6" width="16" height="12" rx="2" stroke="currentColor" fill="none"/>
        <path d="M4 10h16" stroke="currentColor" stroke-linecap="round"/>
        <text x="12" y="16" font-family="Arial, sans-serif" font-size="8" font-weight="900" text-anchor="middle" fill="currentColor">A1</text>
        <path d="M18 8l2-2M18 16l2 2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>`;
    } else if(type === 'dine-in'){
      // Vor Ort: Gekreuztes Besteck (Gabel und Messer), schlichte, dicke Linienführung
      return `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="stroke-width:2.5;">
        <path d="M8 3v18M8 3l4 4M8 3L4 7" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M16 3v18M16 3l-4 4M16 3l4 4" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="12" cy="12" r="1.5" fill="currentColor"/>
      </svg>`;
    } else if(type === 'reuse'){
      // Mehrweg: Kreislauf-Symbol (zwei Pfeile im Kreis) mit Blatt in der Mitte, organische Form
      return `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="stroke-width:2;">
        <path d="M12 4c-4.4 0-8 3.6-8 8s3.6 8 8 8" stroke="currentColor" stroke-linecap="round" fill="none"/>
        <path d="M12 4l4 4-4 4" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        <path d="M12 20c4.4 0 8-3.6 8-8s-3.6-8-8-8" stroke="currentColor" stroke-linecap="round" fill="none"/>
        <path d="M12 20L8 16l4-4" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        <path d="M12 9c-1.5 1.5-1.5 3.5 0 5" stroke="currentColor" stroke-linecap="round" fill="none" style="stroke-width:1.5;"/>
        <path d="M12 9l-1 1 1 1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" fill="none" style="stroke-width:1.5;"/>
      </svg>`;
    }
    return '';
  }
  
  const iconMarkup = (name, opts={})=> {
    const iconName = opts.fill && ICONS[name + 'Filled'] ? name + 'Filled' : name;
    return ICONS[iconName] ? `<span class="ico-inline">${ICONS[iconName]}</span>` : '';
  };
  function applyStaticIcons(){
    document.querySelectorAll('[data-icon]').forEach(el=>{
      if(el.dataset.iconApplied) return;
      const iconOnly = el.dataset.iconOnly === '1';
      const label = el.dataset.label || el.textContent.trim();
      el.dataset.label = label;
      if(iconOnly){
        el.innerHTML = iconMarkup(el.dataset.icon);
      } else {
        el.innerHTML = `${iconMarkup(el.dataset.icon)}<span>${esc(label)}</span>`;
      }
      el.dataset.iconApplied = '1';
    });
  }

  function seededInfoKey(str){
    const s = String(str||'');
    let h = 0;
    for(let i=0;i<s.length;i++){ h = (h*31 + s.charCodeAt(i)) % 10000; }
    return h;
  }
  function seededInfo(str){
    const h = seededInfoKey(str);
    const distanceKm = Number((0.5 + (h % 80) / 10).toFixed(1));
    return { distanceKm };
  }

  const DEFAULT_MEAL_WINDOW = '11:30 – 14:00';
  /** Platzhalter-Bild für Inserate ohne Foto (Gastro, unspezifisch) – Overlay „Bild folgt“. */
  const PLACEHOLDER_IMAGE_URL = 'https://images.unsplash.com/photo-1414235077428-338989a2e8c0?auto=format&fit=crop&w=800&q=80';
  const INSERT_FEE = 4.99;       // Inseratsgebühr fix (€)
  const ABHOLNUMMER_FEE = 0.89;  // Abholnummer-Gebühr pro Verkauf (inkl. Stripe/Bank)
  const SUCCESS_FEE = ABHOLNUMMER_FEE; // Alias

  /** Dish-DB für Smart-Input + Bibliothek (name → 3 Bilder). Semantisch sortiert. */
  const DISH_DB = [
    {dish:'Kürbissuppe', category:'Vegan', img:'https://images.unsplash.com/photo-1476718406336-bb5a9690ee2a?auto=format&fit=crop&w=600&q=80'},
    {dish:'Pasta Carbonara', category:'Mit Fleisch', img:'https://images.unsplash.com/photo-1612874742237-6526221588e3?auto=format&fit=crop&w=600&q=80'},
    {dish:'Salat Bowl', category:'Vegetarisch', img:'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=600&q=80'},
    {dish:'Hähnchen Teriyaki', category:'Mit Fleisch', img:'https://images.unsplash.com/photo-1555126634-323283e090fa?auto=format&fit=crop&w=600&q=80'},
    {dish:'Falafel Teller', category:'Vegan', img:'https://images.unsplash.com/photo-1593001874117-c99c800e3eb7?auto=format&fit=crop&w=600&q=80'},
    {dish:'Käsespätzle', category:'Vegetarisch', img:'https://images.unsplash.com/photo-1627856429547-0624d08c8485?auto=format&fit=crop&w=600&q=80'},
    {dish:'Pizza Margherita', category:'Vegetarisch', img:'https://images.unsplash.com/photo-1574071318508-1cdbab80d002?auto=format&fit=crop&w=600&q=80'},
    {dish:'Schnitzel mit Pommes', category:'Mit Fleisch', img:'https://images.unsplash.com/photo-1599921841143-819065d5d431?auto=format&fit=crop&w=600&q=80'},
    {dish:'Veggie Burger', category:'Vegan', img:'https://images.unsplash.com/photo-1550547660-d9450f859349?auto=format&fit=crop&w=600&q=80'},
    {dish:'Gulasch', category:'Mit Fleisch', img:'https://images.unsplash.com/photo-1588509653491-b0db37996c9c?auto=format&fit=crop&w=600&q=80'},
    {dish:'Gemüse-Curry', category:'Vegan', img:'https://images.unsplash.com/photo-1604152135912-04a022e23696?auto=format&fit=crop&w=600&q=80'},
    {dish:'Risotto', category:'Vegetarisch', img:'https://images.unsplash.com/photo-1476124369491-e7addf5db371?auto=format&fit=crop&w=600&q=80'},
    {dish:'Buddha Bowl', category:'Vegan', img:'https://images.unsplash.com/photo-1543339308-43e59d6b73a6?auto=format&fit=crop&w=600&q=80'},
    {dish:'Lachs mit Gemüse', category:'Fisch', img:'https://images.unsplash.com/photo-1519708227418-c8fd9a32b7a2?auto=format&fit=crop&w=600&q=80'},
    {dish:'Sushi Platte', category:'Fisch', img:'https://images.unsplash.com/photo-1553621042-f6e147245754?auto=format&fit=crop&w=600&q=80'},
    {dish:'Caprese Salat', category:'Vegetarisch', img:'https://images.unsplash.com/photo-1529312266912-b33cf6227e2f?auto=format&fit=crop&w=600&q=80'},
    {dish:'Avocado Toast', category:'Vegan', img:'https://images.unsplash.com/photo-1588137372308-15f75323ca8d?auto=format&fit=crop&w=600&q=80'},
    {dish:'Wrap', category:'Vegetarisch', img:'https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=600&q=80'},
    {dish:'Lasagne', category:'Mit Fleisch', img:'https://images.unsplash.com/photo-1574868352503-c8d3014383c8?auto=format&fit=crop&w=600&q=80'},
    {dish:'Chili con Carne', category:'Mit Fleisch', img:'https://images.unsplash.com/photo-1543545811-71a1d43c86dd?auto=format&fit=crop&w=600&q=80'}
  ];

  /** Smart-Input: Eigenhistorie zuerst, dann DISH_DB. Liefert {dish, category, img?}. */
  function getDishSuggestionsSmartInput(q){
    const qn = String(q||'').trim().toLowerCase();
    const out = [];
    const seen = new Set();
    const pid = typeof providerId === 'function' ? providerId() : '';
    ['cookbook','offers'].forEach(src=>{
      const list = src==='cookbook' ? (typeof cookbook!=='undefined'?cookbook:[]) : (typeof offers!=='undefined'?offers:[]);
      (list||[]).forEach(x=>{
        const name = (x.dish||x.title||'').trim();
        if(!name || seen.has(name.toLowerCase())) return;
        if(src==='cookbook' && x.providerId!==pid) return;
        if(src==='offers' && x.providerId!==pid) return;
        if(qn && !name.toLowerCase().includes(qn)) return;
        seen.add(name.toLowerCase());
        const all = (x.allergens && Array.isArray(x.allergens)) ? x.allergens : (typeof getAllergenSuggestionsForDish==='function' ? getAllergenSuggestionsForDish(name) : []);
        out.push({ dish: name, category: x.category||x.diet||'Vegetarisch', img: x.photoData||x.imageUrl||x.img, allergens: all });
      });
    });
    DISH_DB.forEach(x=>{
      const n = (x.dish||'').trim();
      if(!n || seen.has(n.toLowerCase())) return;
      if(qn && !n.toLowerCase().includes(qn)) return;
      seen.add(n.toLowerCase());
      const all = (x.allergens && Array.isArray(x.allergens)) ? x.allergens : (typeof getAllergenSuggestionsForDish==='function' ? getAllergenSuggestionsForDish(n) : []);
      out.push({ dish: n, category: x.category||'Vegetarisch', img: x.img, allergens: all });
    });
    return out.slice(0, 12);
  }

  /** Bis zu 3 Bilder semantisch zum Gerichtsnamen (für Bibliothek). */
  function getDishImagesForName(name){
    const n = String(name||'').trim().toLowerCase();
    if(!n) return DISH_DB.slice(0,3).map(x=>x.img);
    const match = DISH_DB.filter(x=>(x.dish||'').toLowerCase().includes(n) || n.includes((x.dish||'').toLowerCase()));
    const urls = [...match.map(x=>x.img)];
    const rest = DISH_DB.filter(x=>!urls.includes(x.img));
    while(urls.length<3 && rest.length) urls.push(rest.shift().img);
    return urls.slice(0,3);
  }

  function buildAddress(p){
    if(p && p.address && String(p.address).trim()) return String(p.address).trim();
    const rest = [p?.zip, p?.city].filter(Boolean).join(' ').trim();
    return [p?.street, rest].filter(Boolean).join(', ');
  }

  function parseAddress(addr){
    const raw = String(addr||'').trim();
    const out = { address: raw, street:'', zip:'', city:'' };
    if(!raw) return out;
    const parts = raw.split(',').map(s=>s.trim()).filter(Boolean);
    if(parts.length){ out.street = parts[0]; }
    if(parts.length > 1){
      const rest = parts.slice(1).join(', ');
      const m = rest.match(/^(\d{4,6})\s*(.*)$/);
      if(m){ out.zip = m[1]; out.city = m[2] || ''; }
      else { out.city = rest; }
    }
    return out;
  }

  function normalizeProviderProfile(p){
    const base = { name:'', address:'', street:'', zip:'', city:'', mealWindow:DEFAULT_MEAL_WINDOW, mealStart:'11:30', mealEnd:'14:00', lunchWeekdays:[1,2,3,4,5], phone:'', email:'', website:'', logoData:'', kitchenEmail:'', autoSelloutTime:'', reuseEnabledByDefault:false, abholnummerEnabledByDefault:false, wantsAllergensByDefault:false };
    const out = {...base, ...(p||{})};
    if(!out.address){ out.address = buildAddress(out); }
    if(!out.mealWindow){ out.mealWindow = DEFAULT_MEAL_WINDOW; }
    if(!Array.isArray(out.lunchWeekdays)){ out.lunchWeekdays = [1,2,3,4,5]; }
    return out;
  }
  /** Wochentage-Array zu Anzeige-Text (1=Mo … 7=So) */
  function formatLunchWeekdays(arr){
    const labels = ['','Mo','Di','Mi','Do','Fr','Sa','So'];
    if(!arr || arr.length===0) return '–';
    const sorted = [...arr].sort((a,b)=>a-b);
    if(sorted.length===7) return 'Mo–So';
    if(sorted.length===5 && sorted[0]===1 && sorted[4]===5) return 'Mo–Fr';
    return sorted.map(d=>labels[d]).filter(Boolean).join(', ');
  }

  function normalizeOffer(o){
    const out = {...(o||{})};
    if(!out.dish && out.title) out.dish = out.title;
    if(!out.imageUrl && out.img) out.imageUrl = out.img;
    if(!out.pickupWindow && out.time) out.pickupWindow = out.time;
    if(!out.category && out.diet) out.category = out.diet;

    if(out.address && (!out.providerStreet && !out.providerZip && !out.providerCity)){
      const parsed = parseAddress(out.address);
      out.providerStreet = out.providerStreet || parsed.street || '';
      out.providerZip = out.providerZip || parsed.zip || '';
      out.providerCity = out.providerCity || parsed.city || '';
    }
    out.providerStreet = out.providerStreet || '';
    out.providerZip = out.providerZip || '';
    out.providerCity = out.providerCity || '';
    out.hasPickupCode = !!out.hasPickupCode;
    out.dineInPossible = !!out.dineInPossible;
    if(out.active === undefined) out.active = true;
    const info = seededInfo(out.dish || out.providerName || out.providerId);
    if(out.distanceKm == null) out.distanceKm = info.distanceKm;
    // Status wird nur über active gesteuert
    return out;
  }

  // --- Navigation ---
  const views = {
    start:'v-discover',
    discover:'v-discover', fav:'v-fav', orders:'v-orders', cart:'v-cart', profile:'v-profile',
    pickupCode:'v-pickup-code',
    checkout:'v-checkout',
    orderSuccess:'v-order-success', // AbholBestätigung nach Zahlung
    providerLogin:'v-provider-login',
    providerOnboardingEntry:'v-provider-onboarding-entry',
    providerOnboardingFirstDish:'v-provider-onboarding-first-dish',
    providerOnboardingSignup:'v-provider-onboarding-signup',
    providerOnboardingBusiness:'v-provider-onboarding-business',
    providerOnboardingPreview:'v-provider-onboarding-preview',
    providerHome:'v-provider-home', providerPickups:'v-provider-pickups', providerCookbook:'v-provider-cookbook',
    providerProfile:'v-provider-profile', providerBilling:'v-provider-billing', providerWeek:'v-provider-week',
    legalImpressum:'v-legal-impressum', legalImpressumProvider:'v-legal-impressum-provider', legalAgbKurz:'v-legal-agb-kurz', legalAgbProvider:'v-legal-agb-provider', legalDatenschutz:'v-legal-datenschutz', legalAgbOnboarding:'v-legal-agb-onboarding', legalFaq:'v-legal-faq', legalSupport:'v-support', legalFaqProvider:'v-legal-faq-provider', legalInseratInfoProvider:'v-legal-inserat-info-provider', version:'v-version',
    admin:'v-admin'
  };

  function setCustomerNavActive(go){
    document.querySelectorAll('#customerNav .navbtn').forEach(b=>b.classList.toggle('active', b.dataset.go===go));
  }
  function setProviderNavActive(go){
    document.querySelectorAll('#providerNav .navbtn').forEach(b=>b.classList.toggle('active', b.dataset.pgo===go));
  }

  /** FAB nur auf Dashboard: bei true erstellen und an main hängen, bei false aus DOM entfernen (nicht nur ausblenden). */
  function ensureProviderFab(visible){
    var existing = document.getElementById('fabProviderAddOffer');
    if(visible){
      if(existing) return;
      var mainEl = document.querySelector('main');
      if(!mainEl) return;
      var btn = document.createElement('button');
      btn.className = 'fab-provider fab-provider-plus';
      btn.id = 'fabProviderAddOffer';
      btn.type = 'button';
      btn.setAttribute('aria-label', 'Inserat erstellen');
      btn.innerHTML = '<span class="plus-char" style="font-size:28px; line-height:1; color:#1a1a1a;">+</span>';
      btn.onclick = function(){ createFlowPreselectedDate = null; if(typeof openDishFlow === 'function') openDishFlow(null, 'dashboard'); };
      mainEl.appendChild(btn);
    } else {
      if(existing) existing.remove();
    }
  }

  function showView(id){
    const view = document.getElementById(id);
    if(!view){
      console.error('View not found:', id);
      const fallbackView = document.getElementById(views.discover || 'v-discover');
      if(fallbackView) fallbackView.classList.add('active');
      window.scrollTo({top:0,behavior:'smooth'});
      return;
    }
    // Zuerst neue View aktivieren und anzeigen – kein leerer Bildschirm beim Wechsel
    var isProviderView = (id && id.indexOf('v-provider-') === 0);
    var customerViewIds = [views.start, views.discover, views.fav, views.orders, views.cart, views.profile, views.orderSuccess, views.pickupCode, views.checkout].filter(Boolean);
    if(!isProviderView && customerViewIds.indexOf(id) !== -1){
      document.body.classList.remove('provider-mode');
      mode = 'customer';
      try { if(typeof save === 'function' && typeof LS !== 'undefined') save(LS.mode, mode); } catch(e) {}
    }
    if(isProviderView){
      document.body.classList.add('provider-mode');
      if(typeof history !== 'undefined' && history.scrollRestoration !== undefined) history.scrollRestoration = 'manual';
      // Backdrops sofort ausblenden, damit nichts Klicks blockiert (unabhängig von closeQuickPostSheet/closePublishFeeModal)
      try {
        document.getElementById('quickPostBd')?.classList.remove('active');
        document.getElementById('quickPostSheet')?.classList.remove('active');
        document.getElementById('publishFeeBd')?.classList.remove('active');
        document.getElementById('publishFeeSheet')?.classList.remove('active');
      } catch(e) {}
    }
    view.classList.add('active');
    if(id === 'v-pickup-code') view.style.display = 'flex';
    else if(id === 'v-provider-week') view.style.cssText = 'display:flex; flex-direction:column; min-height:100vh; visibility:visible; opacity:1;';
    else if(isProviderView) view.style.cssText = 'display:block !important; min-height:100vh; height:auto; width:100%; visibility:visible; opacity:1; position:relative;';
    else view.style.display = 'block';
    // Danach alle anderen Views ausblenden (explizit display:none – verhindert Aufsummierung mehrerer 100vh)
    document.querySelectorAll('.view').forEach(v => {
      if(v === view) return;
      v.classList.remove('active');
      v.style.setProperty('display', 'none', 'important');
    });
    document.body.classList.toggle('provider-week-active', id === 'v-provider-week');
    /* Bei Anbieter-Views sofort nach oben scrollen, damit kein leerer oberer Bereich sichtbar ist */
    window.scrollTo({ top: 0, behavior: isProviderView ? 'auto' : 'smooth' });
    if (document.documentElement) document.documentElement.scrollTop = 0;
    if (document.body) document.body.scrollTop = 0;
    if (isProviderView) {
      var activeEl = document.getElementById(id);
      if (activeEl && activeEl.scrollIntoView) activeEl.scrollIntoView({ block: 'start', inline: 'nearest', behavior: 'auto' });
      requestAnimationFrame(function(){
        requestAnimationFrame(function(){
          window.scrollTo({ top: 0, behavior: 'auto' });
          if (document.documentElement) document.documentElement.scrollTop = 0;
          if (document.body) document.body.scrollTop = 0;
          var el = document.getElementById(id);
          if (el) { if (el.scrollTop) el.scrollTop = 0; if (el.scrollIntoView) el.scrollIntoView({ block: 'start', behavior: 'auto' }); }
          var mainEl = document.querySelector('main');
          if (mainEl && mainEl.scrollTop) mainEl.scrollTop = 0;
          var appEl = document.getElementById('app');
          if (appEl && appEl.scrollTop) appEl.scrollTop = 0;
        });
      });
    } else if (id === 'v-provider-login') {
      requestAnimationFrame(function(){ requestAnimationFrame(function(){ window.scrollTo({ top: 0, behavior: 'auto' }); }); });
    }
    
    // VIEW PERSISTENCE: Save current view and mode for refresh
    try {
      localStorage.setItem('mittagio_last_view', id);
      localStorage.setItem('mittagio_last_mode', mode);
    } catch(e) { console.error('Failed to save view state', e); }

    if(typeof lucide !== 'undefined') lucide.createIcons();
    
    // Fullscreen-Abholnummer-Modal beim View-Wechsel schließen (verhindert grünes Overlay auf allen Seiten)
    if(typeof closeFullscreenCode === 'function') closeFullscreenCode();
    // Quick-Post- und Publish-Fee-Modals schließen – verhindert leeren Screen oben auf allen Seiten außer Wochenplan
    if(typeof closeQuickPostSheet === 'function') closeQuickPostSheet();
    if(typeof closePublishFeeModal === 'function') closePublishFeeModal();

    // Topbar: Kundefarben (Seite-1-Style) wenn Kundenseite aktiv
    const topbar = document.querySelector('.topbar');
    if(topbar){
      if(customerViewIds.indexOf(id) !== -1) topbar.classList.add('customer-context');
      else topbar.classList.remove('customer-context');
    }
    
    // Topbar-Toggle nur in Discover-View anzeigen
    const toggleTopbar = document.getElementById('toggleDiscoverViewTopbar');
    if(toggleTopbar){
      toggleTopbar.style.display = (id === views.discover) ? 'flex' : 'none';
    }
    
    // FAB (Lust auf Inspiration?) nur auf Discover anzeigen – sonst immer ausblenden
    const fabModeToggle = document.getElementById('fabModeToggle');
    if(fabModeToggle && id !== views.discover){
      fabModeToggle.style.display = 'none';
    }

    // Bottom-Nav jeweils sichtbar halten (Customer vs. Provider)
    const isProv = mode === 'provider';
    const isCustomerOrStart = mode === 'customer' || mode === 'start';
    const customerNavEl = document.getElementById('customerNav');
    const providerNavWrapEl = document.getElementById('providerNavWrap');
    if(customerNavEl) customerNavEl.style.display = isCustomerOrStart ? 'flex' : 'none';
    if(providerNavWrapEl) providerNavWrapEl.style.display = isProv ? 'block' : 'none';

    // Bottom-Nav aktiven Tab immer zur aktuellen View synchronisieren
    if(isCustomerOrStart){
      var go = (id === 'v-discover') ? 'discover' : (id === 'v-profile') ? 'profile' : (id === 'v-cart') ? 'cart' : (id === 'v-fav') ? 'fav' : (id === 'v-orders') ? 'orders' : null;
      if(go) setCustomerNavActive(go);
    }

    // Provider-FAB: nur auf Dashboard im DOM; auf anderen Anbieter-Seiten entfernen
    if(mode === 'provider') ensureProviderFab(id === 'v-provider-home');
    else ensureProviderFab(false);
  }

  function setMode(next, opts){
    if (next == null) return;
    opts = (opts && typeof opts === 'object') ? opts : {};
    mode = next;
    save(LS.mode, mode);

    const isProv = mode==='provider';
    const isStart = mode==='start';
    const isCustomer = mode==='customer';
    const customerNav = document.getElementById('customerNav');
    const providerNavWrap = document.getElementById('providerNavWrap');
    const providerNav = document.getElementById('providerNav');
    const statusIndicator = document.getElementById('providerStatusIndicator');
    
    if(customerNav) customerNav.style.display = (isCustomer || isStart) ? 'flex' : 'none';
    if(providerNavWrap) providerNavWrap.style.display = isProv ? 'block' : 'none';
    if(statusIndicator) statusIndicator.style.display = (isProv && provider.loggedIn) ? 'flex' : 'none';
    

    
    if(isProv && provider.loggedIn){
      document.body.classList.add('provider-mode');
      if(typeof history !== 'undefined' && history.scrollRestoration !== undefined) history.scrollRestoration = 'manual';
      // Modals/Backdrops aus, damit die Oberfläche klickbar bleibt
      try {
        document.getElementById('quickPostBd')?.classList.remove('active');
        document.getElementById('quickPostSheet')?.classList.remove('active');
        document.getElementById('publishFeeBd')?.classList.remove('active');
        document.getElementById('publishFeeSheet')?.classList.remove('active');
      } catch(e) {}
    } else {
      document.body.classList.remove('provider-mode');
    }
    
    updateHeaderBasket();

    if(opts.skipView) return;

    if(isStart){
      if(!customer.loggedIn){
        setMode('customer');
        showDiscover();
        return;
      }
      showStart();
      return;
    }

    if(isProv){
      if(!provider.loggedIn){
        showView(views.providerLogin);
      } else {
        // RESTORE NUR HAUPT-TABS – nie v-provider-detail-public / Login / Onboarding
        const lastView = localStorage.getItem('mittagio_last_view');
        const lastMode = localStorage.getItem('mittagio_last_mode');
        const providerMainViews = ['v-provider-home','v-provider-pickups','v-provider-week','v-provider-cookbook','v-provider-profile','v-provider-billing'];
        const canRestore = lastMode === 'provider' && lastView && providerMainViews.indexOf(lastView) !== -1 && document.getElementById(lastView);
        if(canRestore){
          showView(lastView);
          var navGo = (lastView === 'v-provider-home') ? 'provider-home' : (lastView === 'v-provider-pickups') ? 'provider-pickups' : (lastView === 'v-provider-week') ? 'provider-week' : (lastView === 'v-provider-cookbook') ? 'provider-cookbook' : (lastView === 'v-provider-profile' || lastView === 'v-provider-billing') ? 'provider-profile' : 'provider-home';
          setProviderNavActive(navGo);
          if(lastView === 'v-provider-home'){
            var homeEl = document.getElementById('v-provider-home');
            var wrapEl = homeEl && homeEl.querySelector('.dashboard-floating-wrap');
            if(wrapEl && wrapEl.scrollTop) wrapEl.scrollTop = 0;
          }
          requestAnimationFrame(function(){
            if(lastView === 'v-provider-home') renderProviderHome();
            else if(lastView === 'v-provider-pickups') renderProviderPickups();
            else if(lastView === 'v-provider-week'){ if(typeof renderWeekPlanBoard === 'function') renderWeekPlanBoard(); else renderWeekPlan(); }
            else if(lastView === 'v-provider-cookbook') renderCookbook();
            else if(lastView === 'v-provider-profile') renderProviderProfile();
            else if(lastView === 'v-provider-billing') renderBilling();
            if(lastView === 'v-provider-home'){
              var h = document.getElementById('v-provider-home');
              var w = h && h.querySelector('.dashboard-floating-wrap');
              if(w && w.scrollTop) w.scrollTop = 0;
            }
            if(typeof lucide !== 'undefined') lucide.createIcons();
          });
        } else {
          showProviderHome();
        }
      }
    } else {
      const lastView = localStorage.getItem('mittagio_last_view');
      const lastMode = localStorage.getItem('mittagio_last_mode');
      if((lastMode === 'customer' || lastMode === 'start') && lastView && document.getElementById(lastView)){
        showView(lastView);
        if(lastView === views.discover) { renderChips(); renderDiscover(); }
        else if(lastView === views.fav) renderFavorites();
        else if(lastView === views.orders) renderOrders();
        else if(lastView === views.profile) updateProfileView();
        else if(lastView === 'v-start') renderStart();
      } else {
        showDiscover();
      }
    }
  }

  // Logo-Click Handler (Home-Button)
  function handleLogoClick(){
    // Je nach Mode zur entsprechenden Startseite navigieren
    if(mode === 'provider'){
      showProviderHome();
    } else if(mode === 'start'){
      showStart();
    } else {
      // Customer Mode: Zur Discover-Seite
      showDiscover();
    }
  }
  
  /** Verhindert Browser-Warnung "pushState in trivial session history": bei nur einem Eintrag replaceState nutzen. */
  function pushViewState(state, url){
    url = url || location.pathname;
    if (typeof history.replaceState === 'function' && history.length === 1)
      history.replaceState(state, '', url);
    else if (typeof history.pushState === 'function')
      history.pushState(state, '', url);
  }

  // --- Start ---
  function showStart(){
    // Navigation auf "Entdecken" setzen (auch wenn wir auf Startseite sind)
    const navBtn = document.querySelector('#customerNav button[data-go="discover"]');
    if(navBtn){
      document.querySelectorAll('#customerNav .navbtn').forEach(b=>b.classList.remove('active'));
      navBtn.classList.add('active');
    }
    showView(views.start);
    renderStart();
    pushViewState({view: 'start', mode: mode}, location.pathname);
  }

  // --- Customer views ---
  function showDiscover(){
    setCustomerNavActive('discover');
    showView(views.discover);
    renderChips();
    renderDiscover();
    ensureProviderFab(false);
    // Alle pickupCodeContainer leeren (falls vorhanden)
    document.querySelectorAll('[id="pickupCodeContainer"]').forEach(function(el){ el.innerHTML = ''; });
    // Zusätzlich: dynamische Abholnummer-View (v-pickup-code-dynamic) explizit entfernen, falls sie außerhalb des Containers existiert
    const dynamicView = document.getElementById('v-pickup-code-dynamic');
    if(dynamicView && dynamicView.parentNode) dynamicView.parentNode.removeChild(dynamicView);
    // FAB anzeigen
    const fabModeToggle = document.getElementById('fabModeToggle');
    if(fabModeToggle) fabModeToggle.style.display = 'flex';
    // Topbar-Toggle anzeigen (nur in Discover-View)
    const toggleTopbar = document.getElementById('toggleDiscoverViewTopbar');
    if(toggleTopbar) toggleTopbar.style.display = 'flex';
    pushViewState({view: 'discover', mode: mode}, location.pathname);
  }
  function showFav(){
    setCustomerNavActive('fav');
    showView(views.fav);
    // Toggle im Topbar ausblenden
    const toggleTopbar = document.getElementById('toggleDiscoverViewTopbar');
    if(toggleTopbar) toggleTopbar.style.display = 'none';
    renderFavorites();
    // Vorschau-Sektion initial verstecken
    const upcomingPreview = document.getElementById('favUpcomingPreview');
    if(upcomingPreview){
      upcomingPreview.style.display = 'none';
      upcomingPreview.style.opacity = '0';
    }
    pushViewState({view: 'fav', mode: mode}, location.pathname);
  }
  function showOrders(){
    setCustomerNavActive('orders');
    showView(views.orders);
    renderOrders();
    pushViewState({view: 'orders', mode: mode}, location.pathname);
  }
  function showCart(){
    setCustomerNavActive('cart');
    showView(views.cart);
    renderCart();
    pushViewState({view: 'cart', mode: mode}, location.pathname);
  }
  function showProfile(){
    setCustomerNavActive('profile');
    // Abholnummer-Ansicht explizit verstecken, bevor Profil-Seite angezeigt wird
    const pickupCodeView = document.getElementById('v-pickup-code');
    if(pickupCodeView){
      pickupCodeView.style.display = 'none';
      pickupCodeView.classList.remove('active');
    }
    showView(views.profile);
    updateProfileView();
    lucide.createIcons();
    pushViewState({view: 'profile', mode: mode}, location.pathname);
  }
  
  // --- Abholnummer: kompakte Kachel + codeSheet ---
  let currentPickupOrderId = null;
  
  /** Öffnet das Abholnummer-Sheet mit Order-Daten. */
  function openCodeSheetWithOrder(order){
    if(!order) return;
    const code = order.pickupCode || order.code || '';
    activeOrderId = order.id;
    const codeTextEl = document.getElementById('codeText');
    const codeProviderEl = document.getElementById('codeProvider');
    const codeSummaryEl = document.getElementById('codeSummary');
    const codePickupWindowEl = document.getElementById('codePickupWindow');
    const codePickupTimeEl = document.getElementById('codePickupTime');
    const codeStatusEl = document.getElementById('codeStatus');
    const btnToggle = document.getElementById('btnToggleOrderStatus');
    const isPickedUp = order.status === 'PICKED_UP' || order.status === 'abgeholt';
    if(codeTextEl) codeTextEl.textContent = code || '–';
    if(codeProviderEl) codeProviderEl.textContent = order.providerName || 'Anbieter';
    if(codeSummaryEl) codeSummaryEl.textContent = order.dishName || order.summary || '–';
    if(codePickupWindowEl) codePickupWindowEl.textContent = order.pickupWindow ? 'Essenszeit: ' + order.pickupWindow : 'Essenszeit: –';
    if(codePickupTimeEl) codePickupTimeEl.textContent = order.pickupTime || 'offen';
    if(codeStatusEl) codeStatusEl.textContent = isPickedUp ? 'Status: abgeholt' : 'Status: offen';
    if(btnToggle) btnToggle.textContent = isPickedUp ? 'Als offen markieren' : 'Als abgeholt markieren';
    const logoEl = document.getElementById('codeProviderLogo');
    if(logoEl){
      const offer = (typeof offers !== 'undefined' && offers && offers.length) ? offers.find(o => o.providerName === order.providerName) : null;
      if(offer && offer.providerLogo) logoEl.innerHTML = '<img src="' + (offer.providerLogo || '') + '" alt="Logo" />';
      else logoEl.innerHTML = '';
    }
    document.getElementById('codeBd').classList.add('active');
    document.getElementById('codeSheet').classList.add('active');
    if(typeof lucide !== 'undefined') setTimeout(function(){ lucide.createIcons(); }, 50);
  }
  
  function showPickupCode(orderId){
    const order = getOrderById(orderId);
    if(!order){
      showToast('Bestellung nicht gefunden');
      showDiscover();
      return;
    }
    if(order.status !== 'PAID' && order.status !== 'PICKED_UP'){
      showToast('Zahlung noch nicht bestätigt');
      showOrders();
      return;
    }
    currentPickupOrderId = orderId;
    openCodeSheetWithOrder(order);
  }
  
  function renderPickupCode(order){}

  // --- Provider views ---
  function showProviderHome(){
    // Session-Validität prüfen
    if(!checkSessionValidity()){
      // Session ungültig, wurde bereits ausgeloggt
      return;
    }
    
    setProviderNavActive('provider-home');
    showView(views.providerHome);
    renderProviderHome();
    
    // Dashboard sofort von oben sichtbar (verhindert leerer Screen beim Nach-oben-Scrollen)
    function scrollProviderHomeToTop(){
      window.scrollTo(0, 0);
      if(document.documentElement) document.documentElement.scrollTop = 0;
      if(document.body) document.body.scrollTop = 0;
      var home = document.getElementById('v-provider-home');
      if(home && home.scrollTop) home.scrollTop = 0;
      var wrap = home && home.querySelector('.dashboard-floating-wrap');
      if(wrap && wrap.scrollTop) wrap.scrollTop = 0;
      var mainEl = document.querySelector('main');
      if(mainEl && mainEl.scrollTop) mainEl.scrollTop = 0;
    }
    scrollProviderHomeToTop();
    setTimeout(scrollProviderHomeToTop, 50);
    setTimeout(scrollProviderHomeToTop, 150);
    requestAnimationFrame(function(){ requestAnimationFrame(scrollProviderHomeToTop); });
    
    // Connectivity-Check starten wenn Provider-Modus aktiv
    if(mode === 'provider' && provider.loggedIn){
      startConnectivityCheck();
      // Status-Ampel Icons rendern
      if(typeof lucide !== 'undefined'){
        setTimeout(() => lucide.createIcons(), 50);
      }
    }
    
    // FAB ist von showView/ensureProviderFab bereits ins DOM eingefügt
    // Zurück-Zeile über der Nav ausblenden (nur auf Sub-Views sichtbar)
    const providerNavBackRow = document.getElementById('providerNavBackRow');
    if(providerNavBackRow) providerNavBackRow.style.display = 'none';
    
    pushViewState({view: 'provider-home', mode: mode}, location.pathname);
  }
  function showProviderPickups(){
    if(!checkSessionValidity()) return;
    document.body.classList.remove('provider-week-active');
    if(typeof closeWeekAddSheet === 'function') closeWeekAddSheet();
    if(typeof hideWeekUndoSnackbar === 'function') hideWeekUndoSnackbar();
    document.querySelectorAll('.kw-move-overlay').forEach(function(o){ o.remove(); });
    var wb = document.getElementById('weekAddSheetBd');
    var ws = document.getElementById('weekAddSheet');
    if(wb) wb.style.display = 'none';
    if(ws){ ws.classList.remove('active'); ws.style.display = 'none'; }
    var wu = document.getElementById('weekUndoSnackbar');
    if(wu){ wu.classList.remove('active'); wu.style.display = 'none'; }
    setProviderNavActive('provider-pickups');
    showView(views.providerPickups);
    renderProviderPickups();
    const providerNavBackRow = document.getElementById('providerNavBackRow');
    if(providerNavBackRow) providerNavBackRow.style.display = 'block';
    pushViewState({view: 'provider-pickups', mode: mode}, location.pathname);
  }
  /** Deep-Link: „Zum Wochenplan“ übergibt gewählten Tag → Wochenplan öffnet direkt an der richtigen Stelle (Smart-Jump). */
  function showProviderWeek(preselectDay){
    if(!checkSessionValidity()) return;
    if(preselectDay && typeof preselectDay === 'string') weekPlanDay = preselectDay;
    weekPlanMode = 'overview';
    setProviderNavActive('provider-week');
    showView(views.providerWeek);
    if(typeof renderWeekPlanBoard === 'function') renderWeekPlanBoard(); else renderWeekPlan();
    // Browser-Verlauf aktualisieren
    pushViewState({view: 'provider-week', mode: mode}, location.pathname);
  }
  function showProviderCookbook(){
    if(!checkSessionValidity()) return;
    if(typeof closeSaveSuccessSheet === 'function') closeSaveSuccessSheet();
    if(typeof closeCookbookActionSheet === 'function') closeCookbookActionSheet();
    document.body.classList.remove('provider-week-active');
    setProviderNavActive('provider-cookbook');
    showView(views.providerCookbook);
    renderCookbook();
    const providerNavBackRow = document.getElementById('providerNavBackRow');
    if(providerNavBackRow) providerNavBackRow.style.display = 'none';
    pushViewState({view: 'provider-cookbook', mode: mode}, location.pathname);
  }
  /** Zentrale Formular-Komponente: Felddefinitionen + Rendering, keine Duplikate */
  var MittagioForm = {
    createInputGroup: function(def){
      var wrap = document.createElement('div');
      wrap.className = def.groupClass || 'input-group';
      var input = document.createElement('input');
      input.type = def.type || 'text';
      input.id = def.id;
      input.placeholder = def.placeholder !== undefined ? def.placeholder : ' ';
      input.className = def.inputClass || 'input-field';
      if(def.autocomplete) input.autocomplete = def.autocomplete;
      if(def.maxlength) input.setAttribute('maxlength', def.maxlength);
      var label = document.createElement('label');
      label.setAttribute('for', def.id);
      label.textContent = def.label || '';
      wrap.appendChild(label);
      wrap.appendChild(input);
      return wrap;
    },
    validate: function(value, rules){
      if(rules.required && (!value || !String(value).trim())) return false;
      if(rules.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(value).trim())) return false;
      return true;
    }
  };
  var PROVIDER_BUSINESS_FIELDS = [
    { id: 'providerProfileBusinessName', type: 'text', label: 'Betriebsname', autocomplete: 'organization' },
    { id: 'providerProfileStreet', type: 'text', label: 'Anschrift', autocomplete: 'street-address' },
    { id: 'providerProfileZip', type: 'text', label: 'PLZ', autocomplete: 'postal-code', maxlength: 10 },
    { id: 'providerProfileCity', type: 'text', label: 'Ort', autocomplete: 'address-level2' },
    { id: 'providerProfilePhone', type: 'tel', label: 'Telefon', autocomplete: 'tel' },
    { id: 'providerProfileEmail', type: 'email', label: 'E-Mail', autocomplete: 'email' },
    { id: 'providerProfileWebsite', type: 'url', label: 'Webseite', autocomplete: 'url' }
  ];
  function createProviderBusinessDataCard(){
    var wrap = document.createElement('div');
    wrap.id = 'providerBusinessDataCardWrap';
    wrap.className = 'provider-settings-card';
    wrap.setAttribute('style', 'background:#fff; border-radius:24px; padding:24px; border:1px solid rgba(0,0,0,0.04); box-shadow:0 8px 24px rgba(0,0,0,0.03);');
    var title = document.createElement('h3');
    title.setAttribute('style', 'margin:0 0 20px; font-size:17px; font-weight:800; color:#1a1a1a;');
    title.textContent = 'Betriebsdaten';
    wrap.appendChild(title);
    wrap.appendChild(MittagioForm.createInputGroup(PROVIDER_BUSINESS_FIELDS[0]));
    wrap.appendChild(MittagioForm.createInputGroup(PROVIDER_BUSINESS_FIELDS[1]));
    var row = document.createElement('div');
    row.setAttribute('style', 'display:grid; grid-template-columns:1fr 2fr; gap:12px;');
    row.appendChild(MittagioForm.createInputGroup(PROVIDER_BUSINESS_FIELDS[2]));
    row.appendChild(MittagioForm.createInputGroup(PROVIDER_BUSINESS_FIELDS[3]));
    wrap.appendChild(row);
    wrap.appendChild(MittagioForm.createInputGroup(PROVIDER_BUSINESS_FIELDS[4]));
    wrap.appendChild(MittagioForm.createInputGroup(PROVIDER_BUSINESS_FIELDS[5]));
    var webGroup = MittagioForm.createInputGroup(PROVIDER_BUSINESS_FIELDS[6]);
    webGroup.style.marginBottom = '24px';
    wrap.appendChild(webGroup);
    var btn = document.createElement('button');
    btn.type = 'button';
    btn.id = 'btnProviderSaveBusiness';
    btn.className = 'btn-primary';
    btn.setAttribute('style', 'width:100%; min-height:56px; border-radius:16px; font-size:16px; font-weight:800; background:#FFD700; color:#1a1a1a; border:none; box-shadow:0 4px 12px rgba(255,215,0,0.2); margin-top:20px;');
    btn.textContent = 'Daten speichern';
    wrap.appendChild(btn);
    var securityWrap = document.createElement('div');
    securityWrap.setAttribute('style', 'margin-top:24px; padding-top:20px; border-top:1px solid #f1f3f5;');
    securityWrap.innerHTML = '<h4 style="margin:0 0 12px; font-size:15px; font-weight:800; color:#1a1a1a;">Sicherheit</h4><button type="button" id="btnProviderChangePassword" style="width:100%; display:flex; justify-content:space-between; align-items:center; padding:16px; background:#f8f9fa; border:2px solid #f1f3f5; border-radius:14px; text-decoration:none; color:#1a1a1a; font-size:15px; font-weight:700; cursor:pointer;"><div style="display:flex;align-items:center;gap:12px;"><i data-lucide="lock" style="width:20px;height:20px;color:#64748b;"></i><span>Passwort ändern</span></div><i data-lucide="chevron-right" style="width:20px; height:20px; color:#cbd5e1;"></i></button>';
    wrap.appendChild(securityWrap);
    return wrap;
  }
  function ensureProviderBusinessDataCard(){
    var slot = document.getElementById('providerBusinessDataCardSlot');
    var slotSettings = document.getElementById('providerBusinessDataCardSlotSettings');
    var targetSlot = slot || slotSettings;
    if(!targetSlot) return;
    var card = document.getElementById('providerBusinessDataCardWrap');
    if(!card){ card = createProviderBusinessDataCard(); targetSlot.appendChild(card); }
    else if(card.parentNode !== targetSlot && slotSettings){ slotSettings.appendChild(card); }
  }

  function showProviderProfileSub(subId){
    var mainWrap = document.getElementById('providerProfileMainWrap');
    var header = document.getElementById('providerProfileHeader');
    var contentEl = document.getElementById('providerProfileContent');
    var heroEl = document.getElementById('providerProfileHero');
    var subs = ['providerProfileSubSettings','providerProfileSubBusiness','providerProfileSubService','providerProfileSubPayment','providerProfileSubFaq'];
    if(mainWrap) mainWrap.style.display = subId ? 'none' : 'block';
    if(header) header.style.display = subId ? 'none' : 'block';
    if(heroEl) heroEl.style.display = subId ? 'none' : 'flex';
    var targetId = subId ? 'providerProfileSub' + (subId === 'settings' ? 'Settings' : subId.charAt(0).toUpperCase() + subId.slice(1)) : '';
    subs.forEach(function(id){
      var el = document.getElementById(id);
      if(el) el.style.display = (subId && id === targetId) ? 'flex' : 'none';
    });
    var card = document.getElementById('providerBusinessDataCardWrap');
    var slot = document.getElementById('providerBusinessDataCardSlot');
    var slotSettings = document.getElementById('providerBusinessDataCardSlotSettings');
    if(card && slotSettings){
      if(subId === 'settings'){ slotSettings.appendChild(card); }
      else if(!subId && slot){ slot.insertBefore(card, slot.firstChild); }
    }
    if(subId && contentEl) contentEl.scrollTop = 0;
    if((subId === 'settings' || subId === 'times' || subId === 'service') && typeof renderProviderProfileMealSelects === 'function') renderProviderProfileMealSelects();
    if(subId === 'settings' && typeof updateProviderSettingsTimeDisplay === 'function') updateProviderSettingsTimeDisplay();
    if(typeof lucide !== 'undefined') setTimeout(function(){ lucide.createIcons(); }, 50);
  }
  function updateProviderSettingsTimeDisplay(){
    var startEl = document.getElementById('providerSettingsMealStart');
    var endEl = document.getElementById('providerSettingsMealEnd');
    var displayEl = document.getElementById('providerSettingsTimeDisplay');
    if(displayEl && startEl && endEl) displayEl.textContent = (startEl.value || '11:30') + ' – ' + (endEl.value || '14:00');
  }
  function showProviderProfile(){
    if(!checkSessionValidity()) return;
    setProviderNavActive('provider-profile');
    showView(views.providerProfile);
    showProviderProfileSub(null);
    renderProviderProfile();
    if(typeof lucide !== 'undefined') setTimeout(function(){ lucide.createIcons(); }, 80);
    const providerNavBackRow = document.getElementById('providerNavBackRow');
    if(providerNavBackRow) providerNavBackRow.style.display = 'block';
    pushViewState({view: 'provider-profile', mode: mode}, location.pathname);
  }
  function showProviderBilling(){
    if(!checkSessionValidity()) return;
    setProviderNavActive('provider-profile');
    showView(views.providerBilling);
    renderBilling();
    
    // Browser-Verlauf aktualisieren
    pushViewState({view: 'provider-billing', mode: mode}, location.pathname);
  }

  // --- Chips render ---
  function renderChips(){
    const catEl = document.getElementById('catChips');
    const dayEl = document.getElementById('dayChips');
    if(!catEl || !dayEl){
      return;
    }
    catEl.innerHTML='';
    // Discover Filter Chips: "In der Nähe" (default) + Kategorien
    const discoverCats = [
      {id: 'near', label: 'In der Nähe', icon: null},
      {id: 'Vegan', label: 'Vegan', icon: 'leaf'},
      {id: 'Vegetarisch', label: 'Vegetarisch', icon: 'carrot'},
      {id: 'Fisch', label: 'Fisch', icon: 'fish'},
      {id: 'Mit Fleisch', label: 'Mit Fleisch', icon: 'drumstick'}
    ];
    
    discoverCats.forEach(cat=>{
      const b=document.createElement('button');
      b.className='discover-category-chip' + (activeDiscoverFilter === cat.id ? ' active' : '');
      b.innerHTML = cat.icon ? `${iconMarkup(cat.icon)}<span>${esc(cat.label)}</span>` : `<span>${esc(cat.label)}</span>`;
      b.onclick=()=>{
        activeDiscoverFilter = cat.id;
        renderChips();
        renderDiscover();
      };
      catEl.appendChild(b);
    });

    dayEl.innerHTML='';
    // Date Swipebar: Heute + nächste 6 Tage
    const today = new Date();
    for(let i=0;i<7;i++){
      const d=new Date(today); d.setDate(d.getDate()+i);
      const key=isoDate(d);
      const b=document.createElement('button');
      b.className='discover-calendar-day'+(activeDay===key?' active':'');
      // Format: "Heute" für heute, sonst "Montag, 24.01."
      if(i===0){
        b.textContent = 'Heute';
      } else {
        b.textContent = fmtDay(d);
      }
      b.onclick=()=>{ activeDay=key; renderChips(); renderDiscover(); };
      dayEl.appendChild(b);
    }
  }

  function renderStartChips(){
    const catEl = document.getElementById('startCatChips');
    const dayEl = document.getElementById('startDayChips');
    if(!catEl || !dayEl){
      return;
    }
    catEl.innerHTML='';
    CATEGORIES.forEach(c=>{
      const b=document.createElement('button');
      b.className='chip'+(activeCat===c?' active':'');
      // Icon Mapping: Vegan=leaf, Vegetarisch=carrot, Mit Fleisch=drumstick
      const iconName = c==='Vegan' ? 'leaf' : (c==='Vegetarisch' ? 'carrot' : 'drumstick');
      b.innerHTML = `${iconMarkup(iconName)}<span>${esc(c)}</span>`;
      b.onclick=()=>{
        activeCat = activeCat===c ? null : c;
        renderStart();
        renderDiscover();
      };
      catEl.appendChild(b);
    });

    dayEl.innerHTML='';
    for(let i=0;i<5;i++){
      const d=new Date(); d.setDate(d.getDate()+i);
      const key=isoDate(d);
      const b=document.createElement('button');
      b.className='day'+(activeDay===key?' active':'');
      b.textContent = fmtDay(d);
      b.onclick=()=>{ activeDay=key; renderStart(); renderDiscover(); };
      dayEl.appendChild(b);
    }
  }

  function renderStart(){
    renderStartChips();
    renderStartDiscover();
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }

  function renderStartDiscover(){
    const grid = document.getElementById('startOfferGrid');
    const empty = document.getElementById('startEmptyOffers');
    const loc = document.getElementById('startLocationInput');
    
    if(!grid || !empty) return;

    // Standort-Suche
    if(loc){
      if(loc.value !== locationQuery) loc.value = locationQuery || '';
      loc.oninput=()=>{ locationQuery = loc.value; renderStart(); renderDiscover(); };
    }

    let list = offers.filter(o => o.day === activeDay && o.active !== false);

    if(activeCat){
      const cat = CAT_MAP[activeCat] || activeCat;
      list = list.filter(o => (o.category||'') === cat);
    }

    const q = String(locationQuery||'').trim().toLowerCase();
    if(q){
      list = list.filter(o=>{
        const data = normalizeOffer(o);
        const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity});
        return String(addr||'').toLowerCase().includes(q);
      });
    }

    // Normale Kacheln rendern
    grid.innerHTML='';
    empty.textContent = q ? 'Keine Angebote für diesen Standort.' : 'Noch keine Angebote. Demo: Als Anbieter ein Inserat erstellen.';
    empty.style.display = list.length ? 'none' : 'block';

    list.slice(0,6).forEach(o=> grid.appendChild(offerCard(o, {context:'start'})));
  }

  function createChatBubble(offer){
    const data = normalizeOffer(offer);
    const bubble = document.createElement('div');
    bubble.className='chat-bubble';
    bubble.onclick=()=>openOffer(data.id);
    
    const timeAgo = 'vor 2h'; // Placeholder
    const distance = data.distanceKm ? `${Number(data.distanceKm).toFixed(1)} km` : '';
    // Food type icon (keine Emojis)
    const foodTypeIcon = data.category === 'Vegan' ? 'leaf' : 
                         data.category === 'Vegetarisch' ? 'carrot' : 
                         data.category === 'Mit Fleisch' ? 'drumstick' : 
                         data.category === 'Fisch' ? 'fish' : '';
    
    bubble.innerHTML=`
      <div class="chat-bubble-header">
        <div class="chat-bubble-avatar">
          <img src="${esc(data.imageUrl || 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60')}" alt="${esc(data.providerName || '')}" />
        </div>
        <div class="chat-bubble-meta">
          <div class="chat-bubble-name">${esc(data.providerName || 'Anbieter')}</div>
          <div class="chat-bubble-time">
            ${iconMarkup('clock')}
            <span>${timeAgo}</span>
          </div>
        </div>
        ${distance ? `<div class="chat-bubble-distance">${distance}</div>` : ''}
      </div>
      ${data.imageUrl ? `<img src="${esc(data.imageUrl)}" alt="${esc(data.dish || '')}" class="chat-bubble-image" />` : ''}
      <div class="chat-bubble-message">
        Hey! Heute gibt's ${foodTypeIcon ? iconMarkup(foodTypeIcon) : ''} <strong>${esc(data.dish || 'Gericht')}</strong> für <strong>${euro(data.price || 0)}</strong> – wer ist dabei?
      </div>
      <div class="chat-bubble-actions">
        <button class="chat-bubble-btn chat-bubble-btn-primary" onclick="event.stopPropagation(); const o=offers.find(x=>x.id==='${data.id}'); if(o) openOffer('${data.id}');">Dabei sein</button>
      </div>
    `;
    
    return bubble;
  }

  // --- Discover render (App-like UX, PWA, Light Mode) ---
  let activeDiscoverFilter = 'near'; // 'near', 'Suppe', 'Vesper', 'Vegetarisch', 'Salat', 'provider'
  let currentProviderFilter = null;
  let discoverRadiusM = parseInt(load('mittagio_discover_radius', '1000'), 10) || 1000; // 500, 1000, 3000
  const DISCOVER_CAT_MULTI = { Vesper: ['Mit Fleisch','Fisch'], Vegetarisch: ['Vegetarisch','Vegan'], Suppe: ['Suppe'], Salat: ['Salat'] };
  
  // Location-Autofill: Nur Schorndorf-Umgebung (Demo: Kurz + Fritz)
  const locationSuggestions = [
    'Schorndorf', '73614', '73614 Schorndorf',
    'Schorndorf-Weiler', 'Winterbach', 'Remshalden', 'Urbach', 'Plüderhausen',
    '73614', '73617', '73630', '73634', '73642', '73660'
  ];
  
  function filterLocationSuggestions(query){
    if(!query || query.length < 2) return [];
    const q = query.toLowerCase();
    return locationSuggestions.filter(loc => 
      loc.toLowerCase().includes(q) || 
      (q.length >= 3 && loc.toLowerCase().startsWith(q))
    ).slice(0, 5);
  }
  
  function renderDiscover(){
    // Date Bar rendern (neu)
    renderDiscoverDays();
    
    // Date Bar rendern (neu)
    if(typeof renderDiscoverDays === 'function') renderDiscoverDays();
    
    // Location-Autofill: Toggle & Input-Handler
    const btnDiscoverLocationGPS = document.getElementById('btnDiscoverLocationGPS');
    const btnDiscoverLocationText = document.getElementById('btnDiscoverLocationText');
    const discoverLocationExpanded = document.getElementById('discoverLocationExpanded');
    const discoverLocationInput = document.getElementById('discoverLocationInput');
    const discoverLocationSuggestions = document.getElementById('discoverLocationSuggestions');
    const discoverCurrentLocation = document.getElementById('discoverCurrentLocation');
    
    if(!locationQuery && !userLat){ locationQuery = DEFAULT_LOCATION_FALLBACK; userLat = SCHORNDORF_LAT; userLng = SCHORNDORF_LNG; if(discoverCurrentLocation) discoverCurrentLocation.textContent = DEFAULT_LOCATION_FALLBACK; }
    
    if(btnDiscoverLocationText && discoverLocationExpanded && discoverLocationInput){
      // Klick auf Text = manuelle Eingabe mit Autovervollständigung
      btnDiscoverLocationText.onclick = (e)=>{
        e.preventDefault();
        e.stopPropagation();
        triggerHapticFeedback([10]);
        const isExpanded = discoverLocationExpanded.style.display === 'block';
        if(!isExpanded){
          const rect = btnDiscoverLocationText.getBoundingClientRect();
          discoverLocationExpanded.style.top = (rect.bottom + 6) + 'px';
          discoverLocationExpanded.style.left = Math.max(16, rect.left) + 'px';
          discoverLocationExpanded.style.right = 'auto';
          discoverLocationExpanded.style.display = 'block';
          discoverLocationInput.value = (locationQuery && locationQuery !== 'Aktueller Standort') ? locationQuery : '';
          if(typeof lucide !== 'undefined') lucide.createIcons();
          setTimeout(() => discoverLocationInput.focus(), 100);
        } else {
          discoverLocationExpanded.style.display = 'none';
          discoverLocationInput.value = '';
          if(discoverLocationSuggestions) discoverLocationSuggestions.innerHTML = '';
        }
      };
      
      // Location-Input mit Autofill
      discoverLocationInput.oninput = ()=>{
        const query = discoverLocationInput.value.trim();
        if(query.length >= 2){
          const suggestions = filterLocationSuggestions(query);
          if(suggestions.length > 0){
            discoverLocationSuggestions.innerHTML = suggestions.map(loc => {
              const safe = String(loc).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
              return `<div class="location-suggestion-item" data-loc="${safe}" style="padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(0,0,0,0.05); transition:background 0.2s ease;" onmouseover="this.style.background='rgba(0,0,0,0.05)';" onmouseout="this.style.background='transparent';">
                <div style="display:flex; align-items:center; gap:8px;">
                  <i data-lucide="map-pin" style="width:14px;height:14px; color:#666;"></i>
                  <span style="font-size:14px; font-weight:500; color:#333;">${safe}</span>
                </div>
              </div>`;
            }).join('');
            if(typeof lucide !== 'undefined') lucide.createIcons();
          } else {
            discoverLocationSuggestions.innerHTML = '';
          }
        } else {
          discoverLocationSuggestions.innerHTML = '';
        }
      };
      
      // Delegierter Klick auf Vorschläge (data-loc statt onclick – vermeidet Sonderzeichen-Bugs)
      discoverLocationSuggestions.onclick = (e)=>{
        const item = e.target.closest('.location-suggestion-item');
        if(item){
          const loc = item.getAttribute('data-loc');
          if(loc) selectLocation(loc);
        }
      };
      
      // Enter-Taste: Ersten Vorschlag auswählen oder aktuellen Wert übernehmen
      discoverLocationInput.onkeydown = (e)=>{
        if(e.key === 'Enter'){
          e.preventDefault();
          const query = discoverLocationInput.value.trim();
          if(query){
            selectLocation(query);
          }
        } else if(e.key === 'Escape'){
          discoverLocationExpanded.style.display = 'none';
          discoverLocationInput.value = '';
          discoverLocationSuggestions.innerHTML = '';
        }
      };
      
      // Schließen-Button im Standort-Dropdown
      const discoverLocationClose = document.getElementById('discoverLocationClose');
      if(discoverLocationClose){
        discoverLocationClose.onclick = () => {
          discoverLocationExpanded.style.display = 'none';
          discoverLocationInput.value = '';
          discoverLocationSuggestions.innerHTML = '';
        };
      }
      
      // Standort: Nadel (GPS) nur auf Klick – kein Auto-GPS (vermeidet Flimmern/Fehler auf dem Handy)
      function requestUserLocation(){
        if(!navigator.geolocation){
          if(typeof showToast === 'function') showToast('GPS nicht verfügbar', 2000);
          if(discoverLocationExpanded) discoverLocationExpanded.style.display = 'block';
          if(discoverLocationInput) discoverLocationInput.focus();
          return;
        }
        if(discoverCurrentLocation) discoverCurrentLocation.textContent = 'Ermitteln…';
        if(typeof showToast === 'function') showToast('Standort wird ermittelt…', 1000);
        navigator.geolocation.getCurrentPosition(
          (position)=>{
            userLat = position.coords.latitude;
            userLng = position.coords.longitude;
            locationQuery = 'Aktueller Standort';
            if(discoverCurrentLocation) discoverCurrentLocation.textContent = '📍 Aktueller Standort';
            if(discoverLocationExpanded) discoverLocationExpanded.style.display = 'none';
            if(typeof showToast === 'function') showToast('Standort aktualisiert', 1500);
            renderDiscover();
          },
          (err)=>{
            locationQuery = DEFAULT_LOCATION_FALLBACK;
            userLat = SCHORNDORF_LAT;
            userLng = SCHORNDORF_LNG;
            if(discoverCurrentLocation) discoverCurrentLocation.textContent = DEFAULT_LOCATION_FALLBACK;
            if(discoverLocationExpanded) discoverLocationExpanded.style.display = 'none';
            renderDiscover();
          },
          { enableHighAccuracy: true, timeout: 12000, maximumAge: 300000 }
        );
      }
      if(btnDiscoverLocationGPS){ btnDiscoverLocationGPS.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); triggerHapticFeedback([10]); requestUserLocation(); }; }
      var discoverLocationBtnNadel = document.getElementById('discoverLocationBtnNadel');
      if(discoverLocationBtnNadel){ discoverLocationBtnNadel.onclick = function(){ triggerHapticFeedback([10]); requestUserLocation(); }; }
    }
    
    // Aktuellen Standort anzeigen (Fallback: Demo-Text wenn weder GPS noch Eingabe)
    if(discoverCurrentLocation){
      discoverCurrentLocation.textContent = locationQuery || 'Standort…';
    }
    const swipeLocationCity = document.getElementById('swipeLocationCity');
    if(swipeLocationCity){
      swipeLocationCity.textContent = locationQuery || 'Standort…';
    }
    
    // Globale Funktion für Location-Auswahl (Schorndorf setzt Koordinaten für Filter)
    window.selectLocation = function(loc){
      locationQuery = loc;
      if(/schorndorf|73614/i.test(String(loc))){
        userLat = SCHORNDORF_LAT;
        userLng = SCHORNDORF_LNG;
      }
      if(discoverCurrentLocation) discoverCurrentLocation.textContent = loc;
      // Swipe-Location synchronisieren
      const swipeLocationCity = document.getElementById('swipeLocationCity');
      if(swipeLocationCity) swipeLocationCity.textContent = loc;
      if(discoverLocationInput) discoverLocationInput.value = '';
      if(discoverLocationSuggestions) discoverLocationSuggestions.innerHTML = '';
      if(discoverLocationExpanded) discoverLocationExpanded.style.display = 'none';
      locationExpanded = false;
      triggerHapticFeedback([10]);
      renderDiscover();
    };
    
    // Standort-Suchfeld öffnen (z. B. aus leerem Zustand „Standort ändern“ – ohne prompt)
    window.openDiscoverLocationSearch = function(){
      const exp = document.getElementById('discoverLocationExpanded');
      const inp = document.getElementById('discoverLocationInput');
      if(exp && inp){
        exp.style.display = 'block';
        inp.value = (locationQuery && locationQuery !== DEFAULT_LOCATION_FALLBACK && locationQuery !== 'Aktueller Standort') ? locationQuery : '';
        inp.placeholder = 'PLZ oder Ort eingeben...';
        setTimeout(function(){ inp.focus(); }, 120);
        if(typeof lucide !== 'undefined') lucide.createIcons();
      }
    };
    
    // Search-Button: Expandiert Suchfeld bei Klick
    const btnDiscoverSearch = document.getElementById('btnDiscoverSearch');
    const discoverSearchExpanded = document.getElementById('discoverSearchExpanded');
    const discoverSearchInput = document.getElementById('discoverSearchInput');
    let searchExpanded = false;
    
    if(btnDiscoverSearch && discoverSearchExpanded && discoverSearchInput){
      btnDiscoverSearch.onclick = (e)=>{
        e.preventDefault();
        e.stopPropagation();
        triggerHapticFeedback([10]);
        
        if(!searchExpanded){
          discoverSearchExpanded.style.display = 'block';
          setTimeout(() => {
            discoverSearchInput.focus();
          }, 100);
          searchExpanded = true;
        } else {
          discoverSearchExpanded.style.display = 'none';
          discoverSearchInput.value = '';
          searchExpanded = false;
          renderDiscover();
        }
      };
      
      // Search-Input Handler
      discoverSearchInput.oninput = ()=>{
        const query = discoverSearchInput.value.trim().toLowerCase();
        if(query){
          // Filtere Angebote nach Suchbegriff
          // Wird in renderDiscover() berücksichtigt
          locationQuery = query; // Temporär für Suche nutzen
          renderDiscover();
        } else {
          locationQuery = '';
          renderDiscover();
        }
      };
      
      // ESC zum Schließen
      discoverSearchInput.onkeydown = (e)=>{
        if(e.key === 'Escape'){
          discoverSearchExpanded.style.display = 'none';
          discoverSearchInput.value = '';
          searchExpanded = false;
          locationQuery = '';
          renderDiscover();
        }
      };
    }
    
    // Hunger-Radius: 500m / 1km / 3km
    const radiusLabel = document.getElementById('discoverRadiusLabel');
    const radiusBtn = document.getElementById('discoverRadiusBtn');
    const radiusDropdown = document.getElementById('discoverRadiusDropdown');
    if(radiusLabel) radiusLabel.textContent = discoverRadiusM >= 1000 ? (discoverRadiusM/1000) + ' km' : discoverRadiusM + 'm';
    if(radiusBtn && radiusDropdown){
      radiusBtn.onclick = function(e){ e.stopPropagation(); radiusDropdown.style.display = radiusDropdown.style.display === 'block' ? 'none' : 'block'; };
      radiusDropdown.querySelectorAll('.discover-radius-opt').forEach(function(btn){
        btn.onclick = function(){
          discoverRadiusM = parseInt(btn.getAttribute('data-radius'),10);
          save('mittagio_discover_radius', discoverRadiusM);
          radiusLabel.textContent = discoverRadiusM >= 1000 ? (discoverRadiusM/1000) + ' km' : discoverRadiusM + 'm';
          radiusDropdown.style.display = 'none';
          if(typeof lucide !== 'undefined') lucide.createIcons();
          renderDiscover();
        };
      });
      if(!radiusDropdown._closedBound){
        radiusDropdown._closedBound = true;
        document.addEventListener('click', function(e){
          if(radiusDropdown.style.display === 'block' && !radiusBtn.contains(e.target) && !radiusDropdown.contains(e.target)){
            radiusDropdown.style.display = 'none';
          }
        });
      }
    }
    if(typeof lucide !== 'undefined' && document.getElementById('discoverRadiusChevron')) lucide.createIcons();

    // Nicht switchDiscoverView(discoverViewMode) hier aufrufen – verursacht Rekursion (switchDiscoverView ruft renderDiscover auf).
    // Sichtbarkeit Liste/Karte wird beim Toggle und beim Init gesetzt.
    
    // Angebote filtern: Nur heute + Zeit-Filter (10 Min Gehzeit oder 15 Min Fahrzeit)
    let list = offers.filter(o => o.day === activeDay && o.active !== false);
    
    // Zeit-Filter: Standard 10 Min Gehzeit (5 km/h = 12 Min/km), optional 15 Min Fahrzeit (50 km/h = 1.2 Min/km)
    if(activeTimeFilter === 'walking'){
      // Standard: Gehzeit <= 10 Min
      list = list.filter(o => {
        const data = normalizeOffer(o);
        if(data.distanceKm == null) return false; // Keine Entfernung = ausblenden
        const walkingMinutes = Math.round(Number(data.distanceKm) * 12);
        return walkingMinutes <= 10;
      });
    } else if(activeTimeFilter === 'driving'){
      // Erweitert: Fahrzeit <= 15 Min
      list = list.filter(o => {
        const data = normalizeOffer(o);
        if(data.distanceKm == null) return false; // Keine Entfernung = ausblenden
        const carMinutes = Math.round(Number(data.distanceKm) * 1.2);
        return carMinutes <= 15;
      });
    }
    
    // Ernährungs-Präferenzen Filter (aus Profil)
    if(customer && customer.dietaryPreferences){
      const prefs = customer.dietaryPreferences;
      list = list.filter(o => {
        const normalized = normalizeOffer(o);
        const category = normalized.category || '';
        const allergens = normalized.allergens || [];
        
        // Vegan: Nur "Vegan" Kategorie
        if(prefs.vegan && category !== 'Vegan') return false;
        
        // Vegetarisch: "Vegan" oder "Vegetarisch" (aber nicht "Mit Fleisch" oder "Fisch")
        if(prefs.vegetarian && (category === 'Mit Fleisch' || category === 'Fisch')) return false;
        
        // Glutenfrei: Keine glutenhaltigen Allergene
        if(prefs.glutenFree && allergens.some(a => 
          a.toLowerCase().includes('gluten') || 
          a.toLowerCase().includes('weizen') ||
          a.toLowerCase().includes('dinkel')
        )) return false;
        
        // Laktosefrei: Keine laktosehaltigen Allergene
        if(prefs.lactoseFree && allergens.some(a => 
          a.toLowerCase().includes('laktose') || 
          a.toLowerCase().includes('milch') ||
          a.toLowerCase().includes('käse')
        )) return false;
        
        return true;
      });
    }
    
    // Provider-Filter (wenn aktiv)
    if(activeDiscoverFilter === 'provider' && currentProviderFilter){
      list = list.filter(o => o.providerId === currentProviderFilter);
    }
    
    // Kategorie-Filter: Pills Eintopf/Vesper/Vegetarisch/Snack
    if(activeDiscoverFilter !== 'near' && activeDiscoverFilter !== 'provider'){
      const allowed = DISCOVER_CAT_MULTI[activeDiscoverFilter];
      if(Array.isArray(allowed)){
        list = list.filter(o => allowed.includes(o.category||''));
      } else {
        const cat = CAT_MAP[activeDiscoverFilter] || activeDiscoverFilter;
        list = list.filter(o => (o.category||'') === cat);
      }
    }
    // Hunger-Radius (500m / 1km / 3km)
    const radiusKm = discoverRadiusM / 1000;
    list = list.filter(o => {
      const data = normalizeOffer(o);
      const d = data.distanceKm != null ? Number(data.distanceKm) : 0;
      return d <= radiusKm;
    });
    
    // Standort-Filter
    const q = String(locationQuery||'').trim().toLowerCase();
    if(q){
      list = list.filter(o=>{
        const data = normalizeOffer(o);
        const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity});
        return String(addr||'').toLowerCase().includes(q);
      });
    }
    
    // List Cards rendern (Modern Style)
    const offersEl = document.getElementById('discoverOffers');
    const emptyEl = document.getElementById('discoverEmpty');
    
    // Categories rendern (nur einmal oder bei Änderung)
    renderDiscoverCategories();

    if(offersEl && emptyEl){
      // Skeleton-Loader anzeigen während Daten geladen werden
      offersEl.innerHTML = '';
      for(let i = 0; i < 3; i++){
        offersEl.appendChild(createSlimCardSkeleton());
      }
      
      // Kurze Verzögerung für bessere UX (simuliert Ladezeit)
      setTimeout(() => {
      offersEl.innerHTML = '';
      emptyEl.style.display = list.length ? 'none' : 'block';
      
      // Layout: Pills oben (bereits im Header), darunter gruppiert nach Restaurant + Tiles
      const byProvider = {};
      list.forEach(o => {
        const pid = o.providerId || 'unknown';
        if(!byProvider[pid]) byProvider[pid] = [];
        byProvider[pid].push(o);
      });
      const providerIds = Object.keys(byProvider);
      providerIds.forEach(pid => {
        const group = byProvider[pid];
        const block = document.createElement('div');
        block.className = 'discover-block';
        const grid = document.createElement('div');
        grid.className = 'discover-tiles-grid';
        group.forEach(o => { grid.appendChild(createModernOfferCard(o)); });
        block.appendChild(grid);
        offersEl.appendChild(block);
      });
    
      // Icons aktualisieren nach dem Rendern
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
      }, 300); // 300ms Delay für realistische Ladezeit
    }
    
    // Demo: Match-Screen Test (kann später durch Swipe-System ersetzt werden)
    // Wenn ein Gericht angeklickt wird und es hasPickupCode hat, könnte man showMatchModal aufrufen
  }
  
  // Swipe-View State (mit LocalStorage-Persistenz)
  let discoverViewMode = load(LS.discoverView, 'list'); // 'list' oder 'swipe'
  
  // Zeit-Filter State (Standard: 10 Min Gehzeit)
  let activeTimeFilter = load('mittagio_timeFilter', 'walking'); // 'walking' (10 min) oder 'driving' (15 min)
  
  // Swipe-Location-Info aktualisieren
  function updateSwipeLocationInfo(){
    const swipeLocationCity = document.getElementById('swipeLocationCity');
    const swipeReachabilityText = document.getElementById('swipeReachabilityText');
    const discoverCurrentLocation = document.getElementById('discoverCurrentLocation');
    
    // Standort synchronisieren (nur der Stadtname, nicht das Icon)
    if(swipeLocationCity && discoverCurrentLocation){
      const citySpan = swipeLocationCity.querySelector('.city');
      if(citySpan){
        citySpan.textContent = discoverCurrentLocation.textContent || DEFAULT_LOCATION_FALLBACK;
      } else {
        // Fallback: Falls .city nicht existiert, gesamten Text aktualisieren
        swipeLocationCity.innerHTML = `<span class="icon">📍</span><span class="city">${discoverCurrentLocation.textContent || DEFAULT_LOCATION_FALLBACK}</span>`;
      }
    } else if(swipeLocationCity){
      const citySpan = swipeLocationCity.querySelector('.city');
      if(citySpan){
        citySpan.textContent = locationQuery || DEFAULT_LOCATION_FALLBACK;
      } else {
        swipeLocationCity.innerHTML = `<span class="icon">📍</span><span class="city">${locationQuery || DEFAULT_LOCATION_FALLBACK}</span>`;
      }
    }
    
    // Erreichbarkeits-Info aktualisieren (basierend auf aktivem Zeit-Filter)
    if(swipeReachabilityText){
      if(activeTimeFilter === 'walking'){
        swipeReachabilityText.textContent = 'In deiner Nähe (👣 10 Min. / 🚗 15 Min.)';
      } else {
        swipeReachabilityText.textContent = 'In deiner Nähe (👣 10 Min. / 🚗 15 Min.)';
      }
    }
  }
  
  // Initialisiere FAB State
  setTimeout(() => {
    if(typeof syncToggleState === 'function') syncToggleState();
  }, 100);
  let swipeCards = [];
  let currentSwipeIndex = 0;
  
  function switchDiscoverView(mode){
    discoverViewMode = mode === 'map' || mode === 'list' ? mode : 'list';
    save(LS.discoverView, discoverViewMode);
    
    const listEl = document.getElementById('discoverOffers');
    const mapWrap = document.getElementById('discoverMap');
    const swipeEl = document.getElementById('discoverSwipe');
    const emptyEl = document.getElementById('discoverEmpty');
    const switchBtn = document.getElementById('discoverViewSwitchBtn');
    const switchIcon = document.getElementById('discoverViewSwitchIcon');
    const switchLabel = document.getElementById('discoverViewSwitchLabel');
    
    if(discoverViewMode === 'map'){
      if(listEl) listEl.style.display = 'none';
      if(emptyEl) emptyEl.style.display = 'none';
      if(mapWrap) { mapWrap.style.display = 'block'; renderDiscoverMap(); }
      if(swipeEl) swipeEl.style.display = 'none';
      if(switchIcon) switchIcon.textContent = '☰';
      if(switchLabel) switchLabel.textContent = 'Liste';
    } else {
      if(listEl) listEl.style.display = 'flex';
      if(mapWrap) mapWrap.style.display = 'none';
      if(swipeEl) swipeEl.style.display = 'none';
      if(emptyEl) emptyEl.style.display = 'none';
      if(switchIcon) switchIcon.textContent = '🗺️';
      if(switchLabel) switchLabel.textContent = 'Karte';
      if(typeof renderDiscover === 'function') renderDiscover();
    }
    
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }
  
  function renderDiscoverMap(){
    const canvas = document.getElementById('discoverMapCanvas');
    if(!canvas) return;
    canvas.innerHTML = '';
    var list = offers.filter(function(o){ return o.day === activeDay && o.active !== false; });
    if(activeDiscoverFilter !== 'near' && activeDiscoverFilter !== 'provider'){
      var allowed = DISCOVER_CAT_MULTI[activeDiscoverFilter];
      if(Array.isArray(allowed)) list = list.filter(function(o){ return allowed.includes(o.category||''); });
      else list = list.filter(function(o){ return (o.category||'') === (CAT_MAP[activeDiscoverFilter] || activeDiscoverFilter); });
    }
    var radiusKm = discoverRadiusM / 1000;
    list = list.filter(function(o){
      var data = normalizeOffer(o);
      var d = data.distanceKm != null ? Number(data.distanceKm) : 0;
      return d <= radiusKm;
    });
    var q = String(locationQuery||'').trim().toLowerCase();
    if(q){
      list = list.filter(function(o){
        var data = normalizeOffer(o);
        var addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity});
        return String(addr||'').toLowerCase().includes(q);
      });
    }
    if(list.length === 0){
      canvas.innerHTML = '<div class="discover-map-empty" style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:24px; text-align:center;"><div style="font-size:48px; margin-bottom:16px;">🗺️</div><div style="font-size:18px; font-weight:800; color:#1a1a1a; margin-bottom:8px;">Keine Angebote im Radius</div><div style="font-size:14px; color:#64748b;">Erweitere den Hunger-Radius oder wechsle die Kategorie.</div></div>';
      return;
    }
    var cols = 4;
    list.forEach(function(o, i){
      var data = normalizeOffer(o);
      var pin = document.createElement('div');
      pin.className = 'discover-pin';
      var row = Math.floor(i / cols);
      var col = i % cols;
      var x = (col + 0.5) * (100 / cols);
      var y = 20 + (row + 0.5) * (70 / Math.max(1, Math.ceil(list.length / cols)));
      pin.style.left = x + '%';
      pin.style.top = y + '%';
      var emoji = (data.category === 'Suppe') ? '🍲' : (data.category === 'Mit Fleisch' || data.category === 'Fisch') ? '🥩' : (data.category === 'Vegetarisch' || data.category === 'Vegan') ? '🥗' : '🥪';
      pin.innerHTML = '<div class="discover-pin-emoji">' + emoji + '</div><div class="discover-pin-price">' + euro(data.price) + '</div>';
      pin.onclick = function(e){ e.stopPropagation(); openDiscoverPinDrawer(o); };
      canvas.appendChild(pin);
    });
  }
  
  window.openDiscoverPinDrawer = function(offer){
    var data = normalizeOffer(offer);
    var drawer = document.getElementById('discoverPinDrawer');
    var imgEl = document.getElementById('discoverPinDrawerImage');
    var titleEl = document.getElementById('discoverPinDrawerTitle');
    var pillarsEl = document.getElementById('discoverPinDrawerPillars');
    var btnEl = document.getElementById('discoverPinDrawerBtn');
    var backdrop = document.getElementById('discoverPinDrawerBackdrop');
    if(!drawer || !titleEl || !pillarsEl || !btnEl) return;
    if(imgEl) imgEl.src = data.imageUrl || 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=800&q=80';
    titleEl.textContent = data.dish || 'Gericht';
    var p = offers.find(function(x){ return x.providerId === data.providerId; });
    var abholnummer = !!(p && p.orderingEnabled !== false && (data.hasPickupCode || p.hasPickupCode));
    var mehrweg = !!(p && (p.reuse && p.reuse.enabled));
    pillarsEl.innerHTML = '<div class="pillar-mini active green" title="Vor Ort möglich">🍴</div><div class="pillar-mini ' + (abholnummer ? 'active yellow' : '') + '" title="Abholnummer aktiv">🧾</div><div class="pillar-mini ' + (mehrweg ? 'active petrol' : '') + '" title="Mehrweg verfügbar">🔄</div>';
    btnEl.onclick = function(){ closeDiscoverPinDrawer(); openOffer(data.id); };
    if(backdrop) backdrop.classList.add('open');
    drawer.classList.add('open');
  };
  
  window.closeDiscoverPinDrawer = function(){
    var drawer = document.getElementById('discoverPinDrawer');
    var b = document.getElementById('discoverPinDrawerBackdrop');
    if(drawer) drawer.classList.remove('open');
    if(b) b.classList.remove('open');
  };
  
  var discoverViewSwitchBtn = document.getElementById('discoverViewSwitchBtn');
  if(discoverViewSwitchBtn){
    discoverViewSwitchBtn.onclick = function(){
      var newMode = discoverViewMode === 'list' ? 'map' : 'list';
      switchDiscoverView(newMode);
      save(LS.discoverView, newMode);
    };
  }
  
  // SwipeCards rendern - ENTFERNT
  function renderSwipeCards(){ return;
    // Standort und Erreichbarkeits-Info aktualisieren
    updateSwipeLocationInfo();
    const swipeStack = document.getElementById('swipeStack');
    const swipeEmpty = document.getElementById('swipeEmpty');
    if(!swipeStack) return;
    
    // Filtere Angebote: Nur heute + Zeit-Filter (10 Min Gehzeit oder 15 Min Fahrzeit)
    // KEINE Kategorie-Filter, KEINE Ernährungs-Präferenzen - reiner Überraschungs-Modus
    let list = offers.filter(o => o.day === activeDay && o.active !== false);
    
    // Zeit-Filter: Standard 10 Min Gehzeit (5 km/h = 12 Min/km), optional 15 Min Fahrzeit (50 km/h = 1.2 Min/km)
    if(activeTimeFilter === 'walking'){
      // Standard: Gehzeit <= 10 Min
      list = list.filter(o => {
        const data = normalizeOffer(o);
        if(data.distanceKm == null) return false; // Keine Entfernung = ausblenden
        const walkingMinutes = Math.round(Number(data.distanceKm) * 12);
        return walkingMinutes <= 10;
      });
    } else if(activeTimeFilter === 'driving'){
      // Erweitert: Fahrzeit <= 15 Min
      list = list.filter(o => {
        const data = normalizeOffer(o);
        if(data.distanceKm == null) return false; // Keine Entfernung = ausblenden
        const carMinutes = Math.round(Number(data.distanceKm) * 1.2);
        return carMinutes <= 15;
      });
    }
    
    const q = String(locationQuery||'').trim().toLowerCase();
    if(q){
      list = list.filter(o=>{
        const data = normalizeOffer(o);
        const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity});
        return String(addr||'').toLowerCase().includes(q);
      });
    }
    
    // Kategorie-Filter (Fleisch / Vegetarisch / Salat)
    if(activeSwipePreference){
      list = list.filter(o => {
        const data = normalizeOffer(o);
        const cat = (data.category || data.diet || '').toLowerCase();
        if(activeSwipePreference === 'fleisch') return cat.includes('fleisch') || cat.includes('meat');
        if(activeSwipePreference === 'vegetarisch') return cat.includes('vegetarisch') || cat.includes('vegan') || cat.includes('veggie');
        if(activeSwipePreference === 'salat') return cat.includes('salat') || cat.includes('bowl') || cat.includes('salad');
        return false;
      });
    }
    
    // Filter: Entferne bereits gelikte oder abgelehnte Gerichte
    const favorites = JSON.parse(localStorage.getItem('mittagio_favorites') || '[]');
    const disliked = JSON.parse(sessionStorage.getItem('mittagio_disliked') || '[]');
    
    list = list.filter(o => {
      const data = normalizeOffer(o);
      const dishKey = data.id;
      // Zeige nur Gerichte, die weder geliked noch abgelehnt wurden
      return !favorites.includes(dishKey) && !disliked.includes(dishKey);
    });
    
    swipeCards = list;
    currentSwipeIndex = 0;
    
    swipeStack.innerHTML = '';
    
    // Debug-Overlay aktualisieren
    const debugOverlay = document.getElementById('swipeCurrentIndex');
    if(debugOverlay){
      debugOverlay.textContent = '0';
    }
    
    if(swipeCards.length === 0){
      if(swipeEmpty) swipeEmpty.style.display = 'block';
      const swipeEndOfStack = document.getElementById('swipeEndOfStack');
      if(swipeEndOfStack) swipeEndOfStack.style.display = 'none';
      return;
    }
    
    if(swipeEmpty) swipeEmpty.style.display = 'none';
    const swipeEndOfStack = document.getElementById('swipeEndOfStack');
    if(swipeEndOfStack) swipeEndOfStack.style.display = 'none';
    
    // Erstelle nur die ersten 3 Karten (Performance)
    const cardsToShow = Math.min(3, swipeCards.length);
    for(let i = 0; i < cardsToShow; i++){
      const card = createSwipeCard(swipeCards[i], i);
      swipeStack.appendChild(card);
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }
  
  // SwipeCard erstellen - ENTFERNT
  function createSwipeCard(offer, index){ return null;
    const data = normalizeOffer(offer);
    const card = document.createElement('div');
    card.className = 'swipe-card';
    card.dataset.offerId = data.id;
    card.dataset.swipeIndex = index;
    card.dataset.category = (data.category || data.diet || '').toLowerCase(); // Für Filter-Logik
    card.style.zIndex = 100 - index;
    
    // Tinder-Stack: Random Rotation (-2° bis +2°) für Stapel-Effekt
    const randomRotation = (Math.random() * 4 - 2); // -2 bis +2 Grad
    const scale = 1 - index * 0.04;
    const translateY = index * 12;
    card.style.transform = `translate(-50%, calc(-50% + ${translateY}px)) scale(${scale}) rotate(${index > 0 ? randomRotation : 0}deg)`;
    card.style.opacity = index === 0 ? 1 : 0.92;
    
    // Float/Waber-Animation nur für die aktive (oberste) Karte
    if(index === 0){
      card.classList.add('active-float');
    }
    
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    
    // Prüfe Provider-Daten für Badges
    const offerProvider = offers.find(p => p.providerId === data.providerId);
    const orderingEnabled = offerProvider && (offerProvider.orderingEnabled !== false && (data.hasPickupCode || offerProvider.hasPickupCode));
    const hasReuseSupport = offerProvider && (offerProvider.reuseEnabled || offerProvider.reuse || (offerProvider.providerProfile && offerProvider.providerProfile.reuseEnabled));
    const hasDineIn = offerProvider && (offerProvider.dineInPossible !== false || data.dineInPossible);
    
    // Prüfe ob Gericht bereits favorisiert ist (dishFavs = Quelle für Favoriten-Seite)
    const dishKey = data.id;
    const isFavorited = typeof dishFavs !== 'undefined' && dishFavs.has(String(dishKey));
    
    // Mittagessen-Tinder: 3 Säulen als Balken unter dem Anbieter (keine Icons auf dem Bild)
    card.innerHTML = `
      <div class="swipe-card-content">
        <!-- Bild mit Herz-Icon und Preis-Sticker (ohne Säulen-Overlay) -->
        <div class="swipe-card-image-wrapper">
          <div class="swipe-card-image">
            <img src="${esc(imgSrc)}" alt="${esc(data.dish||'')}" />
            <div class="swipe-card-heart-icon" style="position:absolute; top:12px; right:12px; width:44px; height:44px; background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 8px rgba(0,0,0,0.15); z-index:15; cursor:pointer; transition:all 0.2s ease;" title="${isFavorited ? 'Aus Favoriten entfernen' : 'Zu Favoriten hinzufügen'}">
              <span style="font-size:20px; ${isFavorited ? 'color:#E34D4D;' : 'color:#999;'}">${isFavorited ? '❤️' : '🤍'}</span>
            </div>
            <div class="swipe-card-price-sticker">${euro(data.price)}</div>
          </div>
        </div>
        
        <!-- Titel-Sektion: Direkt unter dem Bild -->
        <div class="swipe-card-title-section" style="width:100%; padding:16px 12px 0; text-align:center;">
          <h2 class="swipe-card-title">${esc(data.dish||'Gericht')}</h2>
          <p class="swipe-card-provider">${esc(data.providerName||'Anbieter')}</p>
          <div style="margin-top:12px; padding:0 8px;">${renderPillarBars(hasDineIn, orderingEnabled, hasReuseSupport)}</div>
        </div>
        
        <!-- Logistik-Sektion: Distanzen, Essenszeit & Allergene -->
        <div class="swipe-card-logistics-section" style="width:100%; padding:12px 16px 0; margin-top:8px;">
          ${(() => {
            // Distanzberechnung
            const distanceKm = data.distanceKm || 0;
            const walkingMeters = Math.round(distanceKm * 1000);
            const walkingMinutes = Math.round(distanceKm * 12); // 5 km/h = 12 Min/km
            const carMinutes = Math.round(distanceKm * 1.2); // 50 km/h = 1.2 Min/km
            
            // Essenszeit formatieren
            let timeWindowHtml = '';
            if(data.pickupWindow){
              const timeMatch = data.pickupWindow.match(/(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/);
              if(timeMatch){
                const fromTime = timeMatch[1] + ':' + timeMatch[2];
                const toTime = timeMatch[3] + ':' + timeMatch[4];
                timeWindowHtml = `<div style="display:flex; align-items:center; gap:6px; font-size:13px; color:#666; margin-bottom:8px;">
                  <span>🕒</span>
                  <span>von ${fromTime} bis ${toTime} Uhr</span>
                </div>`;
              }
            }
            
            // Allergene-Link (nur wenn vorhanden)
            let allergensHtml = '';
            if(data.allergens && Array.isArray(data.allergens) && data.allergens.length > 0){
              const allergenCount = data.allergens.length;
              allergensHtml = `<div style="display:flex; align-items:center; gap:6px; font-size:13px; color:#666; cursor:pointer; text-decoration:underline; margin-top:8px;" onclick="showSwipeAllergensOverlay('${esc(data.id)}'); event.stopPropagation();" title="Allergene anzeigen">
                <span>Allergene anzeigen</span>
                <span style="font-size:12px;">ⓘ</span>
              </div>`;
            }
            
            return `
              <!-- Doppelte Distanzanzeige: Parallel -->
              <div style="display:flex; justify-content:center; align-items:center; gap:20px; margin-bottom:8px; flex-wrap:wrap;">
                <div style="display:flex; align-items:center; gap:6px; font-size:13px; color:#666;">
                  <span>🚶</span>
                  <span>${walkingMeters < 1000 ? walkingMeters + 'm' : (walkingMeters / 1000).toFixed(1) + 'km'} • ${walkingMinutes} Min</span>
                </div>
                <div style="display:flex; align-items:center; gap:6px; font-size:13px; color:#666;">
                  <span>🚗</span>
                  <span>${distanceKm.toFixed(1)}km • ${carMinutes} Min</span>
                </div>
              </div>
              
              ${timeWindowHtml}
              
              ${allergensHtml}
            `;
          })()}
        </div>
      </div>
    `;
    
    // Herz-Icon Click-Handler: toggleFavorite nutzt dishFavs → Gericht erscheint in Favoriten-Seite
    const heartIcon = card.querySelector('.swipe-card-heart-icon');
    if(heartIcon){
      heartIcon.onclick = (e) => {
        e.stopPropagation();
        e.preventDefault();
        triggerHapticFeedback([10]);
        toggleFavorite(data.id, heartIcon);
        // Swipe-Karte nutzt span mit Emoji, kein Lucide-i – manuell aktualisieren
        const span = heartIcon.querySelector('span');
        if(span){
          const nowFav = dishFavs.has(String(data.id));
          span.innerHTML = nowFav ? '❤️' : '🤍';
          span.style.color = nowFav ? '#E34D4D' : '#999';
        }
      };
    }
    
    return card;
  }
  
  // Allergene-Overlay für Swipe-Karten
  window.showSwipeAllergensOverlay = function(offerId){
    const offer = offers.find(x => x.id === offerId);
    if(!offer) return;
    
    const o = normalizeOffer(offer);
    if(!o || !o.allergens || o.allergens.length === 0) return;
    
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; display:flex; align-items:center; justify-content:center; padding:20px;';
    overlay.onclick = (e) => {
      if(e.target === overlay) {
        document.body.removeChild(overlay);
      }
    };
    
    const content = document.createElement('div');
    content.style.cssText = 'background:linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); border-radius:24px; padding:24px; max-width:420px; width:100%; border:2px solid rgba(255,255,255,0.1); box-shadow:0 8px 32px rgba(0,0,0,0.5); max-height:90vh; overflow:hidden; display:flex; flex-direction:column;';
    content.onclick = (e) => e.stopPropagation();
    
    // Allergene-Mapping (vereinfacht - sollte mit ALLERGENE_STANDARD arbeiten)
    const raw = o.allergens.map(a => String(a||'').trim());
    const codes = [];
    raw.forEach(v => {
      const u = v.toUpperCase();
      if(typeof ALLERGENE_STANDARD !== 'undefined' && ALLERGENE_STANDARD[u]){ 
        codes.push(u); 
        return; 
      }
      // Fallback: Direkt verwenden wenn kein Mapping vorhanden
      if(u.length === 1 && u >= 'A' && u <= 'R'){
        codes.push(u);
      }
    });
    const seen = {};
    const unique = codes.filter(c => { if(seen[c]) return false; seen[c]=1; return true; });
    
    const allergenList = unique.map(code => {
      const fullLabel = (typeof ALLERGENE_STANDARD !== 'undefined' && ALLERGENE_STANDARD[code]) 
        ? ALLERGENE_STANDARD[code] 
        : `Allergen ${code}`;
      const firstWord = typeof allergenFirstWord === 'function' ? allergenFirstWord(fullLabel) : String(fullLabel).trim().split(/\s+/)[0] || fullLabel;
      return `<div style="display:flex; align-items:center; gap:10px; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.1);">
        <i data-lucide="shield-alert" style="width:20px;height:20px;color:rgba(255,255,255,0.8);flex-shrink:0;"></i>
        <span style="color:rgba(255,255,255,0.9); font-weight:700; font-size:14px; flex-shrink:0;">${esc(code)}</span>
        <span style="color:rgba(255,255,255,0.85); font-size:14px;">${esc(firstWord)}</span>
      </div>`;
    }).join('');
    
    const disclaimer = 'Für die Richtigkeit und Aktualität der Angaben ist ausschließlich der Anbieter verantwortlich. Bei schweren Allergien halten Sie bitte Rücksprache mit dem Personal vor Ort.';
    
    content.innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; flex-shrink:0;">
        <h3 style="color:#fff; font-size:20px; font-weight:900; margin:0;">Allergene & Informationen</h3>
        <button type="button" onclick="this.closest('[style*=\\'position:fixed\\']').remove();" style="background:none; border:none; color:#fff; cursor:pointer; padding:4px; display:flex; align-items:center; justify-content:center;">
          <i data-lucide="x" style="width:20px;height:20px;"></i>
        </button>
      </div>
      <div style="padding:12px 14px; background:rgba(255,255,255,0.06); border-radius:12px; border:1px solid rgba(255,255,255,0.1); margin-bottom:16px; flex-shrink:0; font-size:12px; color:rgba(255,255,255,0.85); line-height:1.5;">
        ${esc(disclaimer)}
      </div>
      <div style="max-height:280px; overflow-y:auto; flex:1; min-height:0;">
        ${allergenList || '<p style="color:rgba(255,255,255,0.5); font-size:14px;">Keine passenden Allergene in der Standard-Liste.</p>'}
      </div>
    `;
    
    overlay.appendChild(content);
    document.body.appendChild(overlay);
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  };
  
  // Button-Handler für Polaroid-Modus: Rot (Nein), Grau (Weiter), Grün (Ja)
  function setupSwipeButtons(){
    // Exit-Button (X oben rechts) - bereits im neuen Header vorhanden
    const btnExit = document.getElementById('btnSwipeExit');
    if(btnExit){
      btnExit.onclick = () => {
        switchDiscoverView('list');
        showToast('Zur Listenansicht gewechselt');
      };
    }
    
    // Share-Button (oben rechts im Header)
    const btnShare = document.getElementById('btnSwipeShare');
    if(btnShare){
      btnShare.onclick = () => {
        triggerHapticFeedback([10]);
        const swipeStack = document.getElementById('swipeStack');
        if(!swipeStack) return;
        const allCards = Array.from(swipeStack.querySelectorAll('.swipe-card')).filter(c => {
          if(!c || !c.style) return false;
          const opacity = c.style.opacity;
          return opacity !== '0' && opacity !== '0px' && opacity !== 0 && c.style.display !== 'none';
        });
        const currentCard = allCards.length > 0 ? allCards[0] : null;
        if(currentCard && currentCard.dataset){
          const offerId = currentCard.dataset.offerId;
          const offer = offers.find(o => o.id === offerId);
          if(offer){
            const data = normalizeOffer(offer);
            const shareText = `Schau dir "${data.dish}" von ${data.providerName} auf MITTAGIO an! 🍽️`;
            const shareUrl = window.location.href.split('#')[0] + '#offer=' + offerId;
            
            if(navigator.share){
              navigator.share({
                title: data.dish,
                text: shareText,
                url: shareUrl
              }).catch(() => {
                // Fallback: Kopiere URL in Zwischenablage
                navigator.clipboard.writeText(shareUrl);
                showToast('Link kopiert!', 2000);
              });
            } else {
              // Fallback: Kopiere URL in Zwischenablage
              navigator.clipboard.writeText(shareUrl);
              showToast('Link kopiert!', 2000);
            }
          }
        }
      };
    }
    
    // Standort-Info beim Swipe-Modus aktualisieren
    updateSwipeLocationInfo();
    
    // Rot-Button: Nein (Ablehnen)
    const btnReject = document.getElementById('btnSwipeReject');
    // X-Button: Ablehnen (Fly-Out Links)
    if(btnReject){
      btnReject.onclick = () => {
        const swipeStack = document.getElementById('swipeStack');
        if(!swipeStack) return;
        const allCards = Array.from(swipeStack.querySelectorAll('.swipe-card:not(.fly-out-left):not(.fly-out-right)')).filter(c => c.style.opacity !== '0');
        const currentCard = allCards.length > 0 ? allCards[0] : null;
        if(!currentCard || !currentCard.dataset) return;
        const offerId = currentCard.dataset.offerId;
        const offer = offers.find(o => o.id === offerId);
        if(offer){
          triggerHapticFeedback([20]);
          rejectOffer(offer);
          currentCard.classList.remove('active-float');
          currentCard.classList.add('fly-out-left');
          setTimeout(() => {
            if(currentCard.parentNode) currentCard.remove();
            currentSwipeIndex++;
            setTimeout(() => showNextSwipeCard(), 50);
          }, 450);
        }
      };
    }
    
    // Herz-Button: Zustimmen / Match (Fly-Out Rechts)
    const btnLike = document.getElementById('btnSwipeLike');
    if(btnLike){
      btnLike.onclick = () => {
        const swipeStack = document.getElementById('swipeStack');
        if(!swipeStack) return;
        const allCards = Array.from(swipeStack.querySelectorAll('.swipe-card:not(.fly-out-left):not(.fly-out-right)')).filter(c => c.style.opacity !== '0');
        const currentCard = allCards.length > 0 ? allCards[0] : null;
        if(!currentCard || !currentCard.dataset) return;
        const offerId = currentCard.dataset.offerId;
        const offer = offers.find(o => o.id === offerId);
        if(offer){
          triggerHapticFeedback([20, 10, 30]);
          acceptOffer(offer);
          currentCard.classList.remove('active-float');
          currentCard.classList.add('fly-out-right');
          setTimeout(() => {
            if(currentCard.parentNode) currentCard.remove();
            currentSwipeIndex++;
            setTimeout(() => showNextSwipeCard(), 50);
          }, 450);
        }
      };
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(() => lucide.createIcons(), 50);
    }
  }
  
  // Button-basierte Interaktion
  
  // Haptic Feedback (verbessert: kurze, dezent Vibration)
  function triggerHapticFeedback(pattern = [15]){
    if('vibrate' in navigator){
      navigator.vibrate(pattern); // Standard: 15ms, oder Pattern wie [10, 5, 10]
    }
  }
  
  function rejectOffer(offer){
    // Nein = Ablehnen - In SessionStorage speichern
    if(!offer || !offer.id){
      console.error('Invalid offer in rejectOffer:', offer);
      return;
    }
    
    const data = normalizeOffer(offer);
    const dishKey = data.id;
    
    // Zu Ablehnungs-Liste hinzufügen (SessionStorage - nur für diese Session)
    const disliked = JSON.parse(sessionStorage.getItem('mittagio_disliked') || '[]');
    if(!disliked.includes(dishKey)){
      disliked.push(dishKey);
      sessionStorage.setItem('mittagio_disliked', JSON.stringify(disliked));
    }
    
    showToast('Gericht abgelehnt', 1000);
  }
  
  function acceptOffer(offer){
    if(!offer || !offer.id){
      console.error('Invalid offer in acceptOffer:', offer);
      return;
    }
    
    const data = normalizeOffer(offer);
    const dishKey = data.id;
    const offerProvider = offers.find(p => p.providerId === data.providerId);
    const vorOrt = !!(offerProvider && (offerProvider.dineInPossible !== false || data.dineInPossible));
    const abholnummer = !!(offerProvider && (offerProvider.orderingEnabled !== false && (data.hasPickupCode || offerProvider.hasPickupCode)));
    const mehrweg = !!(offerProvider && (offerProvider.reuseEnabled || offerProvider.reuse || (offerProvider.providerProfile && offerProvider.providerProfile.reuseEnabled)));
    
    // 3-Säulen einfrieren: Status beim Favorisieren speichern
    setFavPillars(dishKey, { vorOrt, abholnummer, mehrweg });
    
    const favorites = JSON.parse(localStorage.getItem('mittagio_favorites') || '[]');
    if(!favorites.includes(dishKey)){
      favorites.push(dishKey);
      localStorage.setItem('mittagio_favorites', JSON.stringify(favorites));
    }
    if(!dishFavs.has(dishKey)){
      dishFavs.add(dishKey);
      save(LS.dishFavs, Array.from(dishFavs));
    }
    
    triggerHapticFeedback([20, 10, 30]);
    
    // "Lecker!" Match-Overlay anzeigen
    showMatchOverlay(data);
    
    // Favoriten-Icon in Nav bouncen lassen
    triggerFavoritesIconBounce();
    
    // Favoriten-Seite aktualisieren
    if(typeof renderFavorites === 'function') renderFavorites();
  }
  
  // "Lecker!" Match-Overlay anzeigen
  function showMatchOverlay(data){
    // Entferne eventuell vorhandenes Overlay
    const existingOverlay = document.getElementById('matchOverlayTinder');
    if(existingOverlay) existingOverlay.remove();
    
    const overlay = document.createElement('div');
    overlay.id = 'matchOverlayTinder';
    overlay.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:2000; display:flex; align-items:center; justify-content:center;';
    overlay.innerHTML = `
      <div class="match-overlay" style="text-align:center; padding:40px; max-width:320px;">
        <div style="font-size:80px; margin-bottom:16px;">😋</div>
        <h2 style="color:#fff; font-size:36px; font-weight:900; margin:0 0 12px; letter-spacing:2px;">Lecker!</h2>
        <p style="color:rgba(255,255,255,0.8); font-size:16px; margin:0 0 24px; line-height:1.5;">${esc(data.dish || 'Gericht')} wurde zu deiner Mittagsbox hinzugefügt.</p>
        <div style="display:flex; gap:12px; justify-content:center;">
          <button type="button" onclick="document.getElementById('matchOverlayTinder').remove(); showFav();" style="padding:14px 28px; background:#FFD700; color:#1a1a1a; font-weight:800; font-size:15px; border:none; border-radius:12px; cursor:pointer;">In die Mittagsbox</button>
          <button type="button" onclick="document.getElementById('matchOverlayTinder').remove();" style="padding:14px 28px; background:rgba(255,255,255,0.15); color:#fff; font-weight:700; font-size:15px; border:none; border-radius:12px; cursor:pointer;">Weiter</button>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
    
    // Auto-close nach 3s
    setTimeout(() => {
      if(overlay.parentNode) overlay.remove();
    }, 3000);
  }
  
  // Favoriten-Icon in Bottom-Nav bouncen
  function triggerFavoritesIconBounce(){
    const favNavBtn = document.querySelector('#customerNav button[data-go="fav"]');
    if(!favNavBtn) return;
    const icon = favNavBtn.querySelector('.ico');
    if(icon){
      icon.classList.add('fav-icon-bounce');
      setTimeout(() => icon.classList.remove('fav-icon-bounce'), 600);
    }
  }
  
  // === MITTAGESSEN-TINDER: Erst Filtern, dann Swipen ===
  let activeSwipePreference = null;
  let swipeFiltersSelected = false;
  
  function setupSwipeFilterHandlers(){
    document.querySelectorAll('.swipe-pref-btn').forEach(btn => {
      btn.onclick = () => onSwipeFilterSelect('pref', btn.dataset.pref);
    });
    document.querySelectorAll('.swipe-dist-btn').forEach(btn => {
      btn.onclick = () => onSwipeFilterSelect('dist', btn.dataset.dist);
    });
  }
  
  function onSwipeFilterSelect(type, value){
    triggerHapticFeedback([10]);
    if(type === 'pref'){
      if(activeSwipePreference === value){ activeSwipePreference = null; updatePrefButtonState(null); }
      else { activeSwipePreference = value; updatePrefButtonState(value); }
      if(!swipeFiltersSelected) activeTimeFilter = activeTimeFilter || 'walking';
    } else {
      activeTimeFilter = value;
      updateDistanceButtonState(value);
      if(!swipeFiltersSelected) activeSwipePreference = activeSwipePreference || null;
    }
    save('mittagio_timeFilter', activeTimeFilter);
    
    if(!swipeFiltersSelected){
      swipeFiltersSelected = true;
      const intro = document.getElementById('swipeFilterIntro');
      const area = document.getElementById('swipeStackArea');
      if(intro) intro.style.display = 'none';
      if(area) area.style.display = 'flex';
      renderSwipeCards();
      showToast('Karten geladen – viel Spaß beim Swipen!', 1500);
    } else {
      renderSwipeCards();
      const label = type === 'pref' ? (value === 'fleisch' ? 'Fleisch' : value === 'vegetarisch' ? 'Vegetarisch' : 'Salat') : (value === 'walking' ? 'Zu Fuss' : 'Auto');
      showToast('Filter: ' + label, 1000);
    }
  }
  
  function updatePrefButtonState(activePref){
    document.querySelectorAll('.swipe-pref-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.pref === activePref);
    });
  }
  
  function updateDistanceButtonState(activeDist){
    document.querySelectorAll('.swipe-dist-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.dist === activeDist);
    });
  }
  
  window.toggleSwipeMenu = function(){
    showToast('Menü: In Entwicklung', 1500);
  };
  
  // Fly-to-Favorites Animation: Gericht fliegt zum Herz-Icon
  function triggerFlyToFavoritesAnimation(offer){
    const data = normalizeOffer(offer);
    const card = document.querySelector('.swipe-card[data-offer-id="' + data.id + '"]');
    if(!card) return;
    
    const img = card.querySelector('.swipe-card-image img');
    if(!img) return;
    
    // Finde das Favoriten-Icon in der Bottom Nav
    const favNavBtn = document.querySelector('#customerNav button[data-go="fav"]');
    if(!favNavBtn) return;
    
    // Temporäre Kopie des Bildes erstellen
    const flyImg = img.cloneNode(true);
    flyImg.style.cssText = `
      position:fixed;
      width:100px;
      height:100px;
      object-fit:cover;
      border-radius:16px;
      z-index:9999;
      pointer-events:none;
      box-shadow:0 8px 24px rgba(0,0,0,0.3);
      transition:all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    `;
    
    const cardRect = card.getBoundingClientRect();
    const favRect = favNavBtn.getBoundingClientRect();
    
    flyImg.style.left = cardRect.left + (cardRect.width / 2) - 50 + 'px';
    flyImg.style.top = cardRect.top + (cardRect.height * 0.3) + 'px';
    
    document.body.appendChild(flyImg);
    
    // Animation zum Herz-Icon
    setTimeout(() => {
      flyImg.style.left = favRect.left + (favRect.width / 2) - 50 + 'px';
      flyImg.style.top = favRect.top + (favRect.height / 2) - 50 + 'px';
      flyImg.style.transform = 'scale(0.2) rotate(360deg)';
      flyImg.style.opacity = '0';
    }, 50);
    
    // Heart-Reaction: Bounce + Glow
    setTimeout(() => {
      favNavBtn.classList.add('bounce', 'glow');
      
      // Cleanup
      setTimeout(() => {
        favNavBtn.classList.remove('bounce', 'glow');
      }, 500);
    }, 300);
    
    // Cleanup
    setTimeout(() => {
      if(flyImg.parentNode) flyImg.parentNode.removeChild(flyImg);
    }, 700);
  }
  
  // Anbieter-Quick-View (Modal mit Adresse & Maps-Link)
  function openProviderQuickView(providerId){
    const providerOffers = offers.filter(o => o.providerId === providerId && o.active !== false);
    if(providerOffers.length === 0) return;
    
    const provider = normalizeOffer(providerOffers[0]);
    const address = buildAddress({
      street: provider.providerStreet,
      zip: provider.providerZip,
      city: provider.providerCity,
      address: provider.address
    });
    
    // Modal erstellen
    const modal = document.createElement('div');
    modal.className = 'backdrop active';
    modal.style.zIndex = '100';
    modal.onclick = () => {
      modal.remove();
    };
    
    const content = document.createElement('div');
    content.style.cssText = `
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      background:#fff;
      border-radius:24px;
      padding:24px;
      max-width:90vw;
      width:400px;
      box-shadow:0 8px 32px rgba(0,0,0,0.2);
      z-index:101;
    `;
    content.onclick = (e) => e.stopPropagation();
    
    content.innerHTML = `
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
        <div style="width:48px; height:48px; border-radius:12px; background:rgba(255,215,0,0.15); display:flex; align-items:center; justify-content:center;">
          <i data-lucide="store" style="width:24px;height:24px; color:#FFD700;"></i>
        </div>
        <div style="flex:1;">
          <div style="font-weight:900; font-size:18px; color:#2D3436; margin-bottom:4px;">${esc(provider.providerName || 'Anbieter')}</div>
          <div style="font-size:14px; color:#666; display:flex; align-items:center; gap:6px;">
            <i data-lucide="map-pin" style="width:14px;height:14px;"></i>
            <span>${esc(address)}</span>
          </div>
        </div>
        <button onclick="this.closest('.backdrop').remove();" style="background:none; border:none; padding:8px; cursor:pointer; border-radius:8px; transition:background 0.2s;" onmouseover="this.style.background='#f5f5f5';" onmouseout="this.style.background='none';">
          <i data-lucide="x" style="width:20px;height:20px; color:#666;"></i>
        </button>
      </div>
      <div style="display:flex; flex-direction:column; gap:12px;">
        <button class="btn-primary" type="button" onclick="openGoogleMapsRoute('${esc(providerId)}'); this.closest('.backdrop').remove();" style="width:100%; min-height:48px; font-weight:700;">
          <i data-lucide="navigation" style="width:20px;height:20px;"></i> <span>Anfahrt</span>
        </button>
        ${provider.distanceKm != null ? (() => {
          const walkingMinutes = Math.round(Number(provider.distanceKm) * 12);
          const walkingTimeText = walkingMinutes < 1 ? '< 1 Min.' : `${walkingMinutes} Min.`;
          return `<div style="text-align:center; font-size:13px; color:#666; padding:8px; display:flex; align-items:center; justify-content:center; gap:4px;"><i data-lucide="navigation" style="width:14px;height:14px;"></i> <span>${walkingTimeText} zu Fuß</span></div>`;
        })() : ''}
      </div>
    `;
    
    modal.appendChild(content);
    document.body.appendChild(modal);
    
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }
  
  // Google Maps Route öffnen (für einen oder mehrere Anbieter)
  function openGoogleMapsRoute(providerId){
    // Wenn kein providerId, dann Multi-Vendor aus Korb
    if(!providerId){
      if(!cart || !cart.items.length) return;
      const providerIds = new Set();
      cart.items.forEach(it => {
        const o = offers.find(x => x.id === it.offerId);
        if(o) providerIds.add(o.providerId);
      });
      
      if(providerIds.size === 0) return;
      if(providerIds.size === 1){
        openGoogleMapsRoute(Array.from(providerIds)[0]);
        return;
      }
      
      // Mehrere Anbieter: Optimale Route mit Waypoints
      const addresses = [];
      Array.from(providerIds).forEach(id => {
        const o = offers.find(x => x.providerId === id && x.active !== false);
        if(o){
          const p = normalizeOffer(o);
          const addr = buildAddress({
            street: p.providerStreet,
            zip: p.providerZip,
            city: p.providerCity
          });
          if(addr) addresses.push(encodeURIComponent(addr));
        }
      });
      
      if(addresses.length === 0) return;
      
      // Google Maps mit Waypoints (optimale Route)
      if(addresses.length > 1){
        const waypoints = addresses.slice(0, -1).join('|');
        const destination = addresses[addresses.length - 1];
        const url = `https://www.google.com/maps/dir/?api=1&origin=My+Location&waypoints=${waypoints}&destination=${destination}`;
        window.open(url, '_blank');
      } else {
        const url = `https://www.google.com/maps/search/?api=1&query=${addresses[0]}`;
        window.open(url, '_blank');
      }
      return;
    }
    
    // Einzelner Anbieter
    const o = offers.find(x => x.providerId === providerId && x.active !== false);
    if(!o) return;
    
    const p = normalizeOffer(o);
    const address = buildAddress({
      street: p.providerStreet,
      zip: p.providerZip,
      city: p.providerCity
    });
    
    if(!address) return;
    
    const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
    window.open(url, '_blank');
  }
  
  // Nächste Karte anzeigen
  function showNextSwipeCard(){
    const swipeStack = document.getElementById('swipeStack');
    if(!swipeStack) return;
    
    // CRITICAL FIX: Reset alle State-Variablen vor dem Update
    // Stelle sicher, dass keine Swipe-Gesten mehr aktiv sind
    // WICHTIG: Dies verhindert, dass alte State-Variablen aus Closure die neue Karte blockieren
    const allCards = swipeStack.querySelectorAll('.swipe-card');
    allCards.forEach(card => {
      if(card && card.style){
        // Entferne alle Swipe-Klassen und setze State zurück
        card.classList.remove('swiping');
        card.style.transition = '';
        // Entferne haptisches Feedback Flag
        if(card.dataset) card.dataset.hapticTriggered = '';
      }
    });
    
    // Speicher-Bereinigung: Entferne alle entfernten Karten aus dem DOM
    allCards.forEach(card => {
      if(!card || !card.parentNode || !card.style || card.style.opacity === '0'){
        // Karte wurde bereits entfernt oder ist unsichtbar - entferne sie komplett
        if(card && card.parentNode && card.style){
          // CRITICAL FIX: Setze display:none BEVOR entfernt wird, um Events zu blockieren
          card.style.display = 'none';
          // Cleanup: Entferne alle Event-Listener durch Klonen und Ersetzen
          const newCard = card.cloneNode(true);
          card.parentNode.replaceChild(newCard, card);
          card.remove();
        }
      }
    });
    
    // Verschiebe alle verbleibenden Karten nach oben (zentriert)
    // Performance-Fix: Prüfe ob Elemente noch existieren
    let cards = Array.from(swipeStack.querySelectorAll('.swipe-card')).filter(c => {
      if(!c || !c.parentNode || !c.style) return false; // Element existiert nicht mehr
      // CRITICAL FIX: Filtere auch display:none Karten aus
      if(c.style.display === 'none') return false;
      // Filtere Karten mit opacity 0 oder swipe-Klassen
      const opacity = c.style.opacity;
      if(opacity === '0' || opacity === '0px') return false;
      if(c.classList.contains('swipe-left') || c.classList.contains('swipe-right')) return false;
      return true;
    });
    
    // CRITICAL FIX: Stelle sicher, dass die oberste Karte (index 0) korrekt konfiguriert ist
    // BUGFIX: Index-Problem beheben - stelle sicher, dass currentSwipeIndex korrekt ist
    // Wenn keine Karten mehr sichtbar sind, aber noch Karten im Array sind, lade die nächste
    if(cards.length === 0 && currentSwipeIndex < swipeCards.length){
      const nextCard = createSwipeCard(swipeCards[currentSwipeIndex], 0);
      if(nextCard && swipeStack) {
        swipeStack.appendChild(nextCard);
        cards = [nextCard];
      }
    }
    
    // CRITICAL FIX: Wenn weniger als 3 Karten vorhanden sind UND noch weitere Karten verfügbar sind, lade sie VORHER
    // Dies verhindert, dass der Stack leer wird
    while(cards.length < 3 && currentSwipeIndex + cards.length < swipeCards.length){
      const nextIndex = currentSwipeIndex + cards.length;
      if(nextIndex < swipeCards.length){
        const nextCard = createSwipeCard(swipeCards[nextIndex], cards.length);
        if(nextCard && swipeStack) {
          swipeStack.appendChild(nextCard);
          cards.push(nextCard);
        } else {
          break; // Verhindere Endlosschleife
        }
      } else {
        break;
      }
    }
    
    // CRITICAL FIX: Aktualisiere cards-Array nach dem Laden neuer Karten
    cards = Array.from(swipeStack.querySelectorAll('.swipe-card')).filter(c => {
      if(!c || !c.parentNode || !c.style) return false;
      if(c.style.display === 'none') return false;
      const opacity = c.style.opacity;
      if(opacity === '0' || opacity === '0px') return false;
      if(c.classList.contains('swipe-left') || c.classList.contains('swipe-right')) return false;
      return true;
    });
    
    cards.forEach((card, i) => {
      if(!card || !card.parentNode || !card.style) return; // Sicherheitscheck
      
      // CRITICAL FIX: Aktualisiere den Index als data-Attribut für dynamische Prüfung
      if(card.dataset) card.dataset.swipeIndex = String(currentSwipeIndex + i);
      
      // Reset Transform und Transition für sauberen Neustart
      card.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
      card.style.zIndex = String(100 - i);
      const scale = 1 - i * 0.05;
      const translateY = i * 10;
      card.style.transform = `translate(-50%, calc(-50% + ${translateY}px)) scale(${scale})`;
      card.style.opacity = i === 0 ? '1' : '0.95';
      
      // CRITICAL: Die oberste Karte (i === 0) muss interaktiv sein und Event-Listener erhalten
      if(i === 0){
        card.style.pointerEvents = 'auto';
        card.style.cursor = 'grab';
        card.style.display = 'block';
        card.style.willChange = 'transform';
        card.classList.remove('swipe-left', 'swipe-right', 'swiping', 'fly-out-left', 'fly-out-right');
        card.classList.add('active-float'); // Tinder Float/Waber Animation
        card.style.opacity = '1';
        card.style.visibility = 'visible';
        // Tinder: Random Rotation für Stack-Effekt entfernen bei aktiver Karte
        card.style.transform = `translate(-50%, -50%) scale(1)`;
      } else {
        card.style.pointerEvents = 'none';
        card.classList.remove('active-float');
        // Tinder: Random Rotation beibehalten für Stack-Effekt
        const randomRotation = (Math.random() * 4 - 2);
        card.style.transform = `translate(-50%, calc(-50% + ${translateY}px)) scale(${scale}) rotate(${randomRotation}deg)`;
      }
    });
    
    // Diese Logik wurde nach oben verschoben, um sicherzustellen, dass Karten VORHER geladen werden
    
    // End-of-Stack: Wenn keine Karten mehr, zeige Abschlusskarte
    const swipeEndOfStack = document.getElementById('swipeEndOfStack');
    const swipeEmpty = document.getElementById('swipeEmpty');
    
    // CRITICAL FIX: Prüfe sowohl ob keine Karten mehr sichtbar sind UND ob alle Karten durchgesehen wurden
    const allCardsVisible = Array.from(swipeStack.querySelectorAll('.swipe-card')).filter(c => {
      if(!c || !c.style) return false;
      const opacity = c.style.opacity;
      return opacity !== '0' && opacity !== '0px' && opacity !== 0 && c.style.display !== 'none';
    }).length;
    
    if(allCardsVisible === 0 && currentSwipeIndex >= swipeCards.length){
      if(swipeEndOfStack) swipeEndOfStack.style.display = 'block';
      if(swipeEmpty) swipeEmpty.style.display = 'none';
    } else {
      if(swipeEndOfStack) swipeEndOfStack.style.display = 'none';
      if(swipeEmpty) swipeEmpty.style.display = 'none';
    }
    
    // Debug-Overlay aktualisieren
    const debugOverlay = document.getElementById('swipeCurrentIndex');
    if(debugOverlay){
      debugOverlay.textContent = currentSwipeIndex;
    }
    
    // Cleanup: Entferne Event-Listener von entfernten Karten (verhindert Memory Leaks)
    // Performance-Fix: Aggressiveres Cleanup nach jedem Swipe
    setTimeout(() => {
      if(!swipeStack) return;
      const removedCards = swipeStack.querySelectorAll('.swipe-card[style*="opacity: 0"]');
      removedCards.forEach(card => {
        if(card && card.parentNode){
          // Entferne alle Event-Listener durch Klonen
          const newCard = card.cloneNode(true);
          card.parentNode.replaceChild(newCard, card);
          card.remove();
        }
      });
      
      // Zusätzlicher Cleanup: Entferne Karten die nicht mehr sichtbar sind
      const allCards = swipeStack.querySelectorAll('.swipe-card');
      allCards.forEach(card => {
        if(card && (card.style.opacity === '0' || !card.parentNode || card.offsetParent === null)){
          if(card.parentNode) card.remove();
        }
      });
    }, 300);
  }
  
  // FAB (Floating Action Button) für Modus-Wechsel
  const fabModeToggle = document.getElementById('fabModeToggle');
  const fabModeIcon = document.getElementById('fabModeIcon');
  const fabHint = document.getElementById('fabHint');
  
  // Toggle-Switch Handler im Header
  const toggleDiscoverViewTopbar = document.getElementById('toggleDiscoverViewTopbar');
  
  function syncToggleState(){
    const isSwipe = discoverViewMode === 'swipe';
    
    // Topbar-Toggle
    // Moderner Toggle: Aktiven Zustand setzen und Icon wechseln
    if(toggleDiscoverViewTopbar){
      const iconEl = toggleDiscoverViewTopbar.querySelector('#toggleDiscoverViewIcon');
      if(isSwipe){
        toggleDiscoverViewTopbar.classList.add('active');
        if(iconEl) iconEl.setAttribute('data-lucide', 'list');
      } else {
        toggleDiscoverViewTopbar.classList.remove('active');
        if(iconEl) iconEl.setAttribute('data-lucide', 'grid-3x3');
      }
      if(typeof lucide !== 'undefined' && iconEl) lucide.createIcons();
    }
    
    // FAB aktualisieren
    if(fabModeToggle){
      if(isSwipe){
        fabModeToggle.classList.add('active');
        // Icon wechseln: Sparkles (Inspiration) → Liste
        if(fabModeIcon){
          fabModeIcon.setAttribute('data-lucide', 'list');
          if(typeof lucide !== 'undefined') lucide.createIcons();
        }
      } else {
        fabModeToggle.classList.remove('active');
        // Icon wechseln: Liste → Sparkles (Inspiration)
        if(fabModeIcon){
          fabModeIcon.setAttribute('data-lucide', 'sparkles');
          if(typeof lucide !== 'undefined') lucide.createIcons();
        }
      }
    }
  }
  
  // FAB Click-Handler mit Puls-Animation
  if(fabModeToggle){
    fabModeToggle.onclick = () => {
      // Puls-Animation
      fabModeToggle.classList.add('pulsing');
      setTimeout(() => fabModeToggle.classList.remove('pulsing'), 400);
      
      // Modus wechseln
      const newMode = discoverViewMode === 'list' ? 'swipe' : 'list';
      switchDiscoverView(newMode);
      save(LS.discoverView, newMode);
      syncToggleState();
      
      // Haptic Feedback (falls unterstützt)
      if(typeof haptic==='function') haptic(10); else if(navigator.vibrate) navigator.vibrate(10);
    };
  }
  

  
  // Micro-Hint beim ersten Start (nur einmal anzeigen)
  const fabHintShown = load('fabHintShown', false);
  if(fabModeToggle && fabHint && !fabHintShown){
    // Zeige FAB nur in Discover-View
    function showFabInDiscover(){
      const currentView = document.querySelector('.view.active');
      if(currentView && currentView.id === 'v-discover'){
        fabModeToggle.style.display = 'flex';
        // Zeige Hint nach kurzer Verzögerung
        setTimeout(() => {
          if(fabHint) fabHint.classList.add('show');
        }, 500);
        // Verstecke Hint nach 2 Sekunden
        setTimeout(() => {
          if(fabHint) fabHint.classList.remove('show');
          save('fabHintShown', true);
        }, 2500);
      } else {
        fabModeToggle.style.display = 'none';
      }
    }
    
    // Beim ersten Laden
    showFabInDiscover();
    
    // Beim View-Wechsel
    const originalShowView = window.showView;
    if(originalShowView){
      window.showView = function(viewId){
        originalShowView(viewId);
        setTimeout(showFabInDiscover, 100);
      };
    }
  } else if(fabModeToggle){
    // Hint bereits gezeigt - zeige FAB nur in Discover
    function showFabInDiscover(){
      const currentView = document.querySelector('.view.active');
      if(currentView && currentView.id === 'v-discover'){
        fabModeToggle.style.display = 'flex';
      } else {
        fabModeToggle.style.display = 'none';
      }
    }
    showFabInDiscover();
    
    // Beim View-Wechsel
    const originalShowView = window.showView;
    if(originalShowView){
      window.showView = function(viewId){
        originalShowView(viewId);
        setTimeout(showFabInDiscover, 100);
      };
    }
  }
  
  // Initialer Zustand setzen
  setTimeout(() => {
    syncToggleState();
    if(fabModeToggle){
      const currentView = document.querySelector('.view.active');
      if(currentView && currentView.id === 'v-discover'){
        fabModeToggle.style.display = 'flex';
      }
    }
  }, 200);
  
  // Initiale Ansicht beim ersten Laden setzen
  if(discoverViewMode === 'map'){
    switchDiscoverView('map');
  } else if(discoverViewMode === 'swipe'){
    switchDiscoverView('list');
  } else {
    switchDiscoverView('list');
  }
  
  // Skeleton-Loader für Slim-Cards (Loading-State)
  function createSlimCardSkeleton(){
    const skeleton = document.createElement('div');
    skeleton.className = 'dish-card skeleton-pulse';
    skeleton.innerHTML = `
      <div style="display:flex; gap:12px; align-items:flex-start;">
        <!-- Bild-Platzhalter -->
        <div class="skeleton-bg" style="width:100px; height:100px; max-width:100px; max-height:100px; flex-shrink:0; border-radius:12px;"></div>
        
        <!-- Text-Platzhalter -->
        <div style="flex:1; display:flex; flex-direction:column; justify-content:space-between; min-width:0; padding:2px 0;">
          <div>
            <!-- Name & Preis Zeile -->
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px; margin-bottom:4px;">
              <div class="skeleton-bg" style="height:16px; border-radius:4px; flex:1; max-width:66%;"></div>
              <div class="skeleton-bg" style="height:16px; border-radius:4px; width:25%;"></div>
            </div>
            <!-- Anbieter-Platzhalter -->
            <div class="skeleton-bg-light" style="height:10px; border-radius:4px; width:50%; margin-bottom:6px;"></div>
          </div>
          
          <!-- Info-Zeile Platzhalter -->
          <div style="display:flex; gap:12px; margin-top:auto;">
            <div class="skeleton-bg-light" style="height:10px; border-radius:4px; width:48px;"></div>
            <div class="skeleton-bg-light" style="height:10px; border-radius:4px; width:48px;"></div>
          </div>
        </div>
      </div>
    `;
    return skeleton;
  }
  
  // Entscheidungs-Kachel (Heute-Fokus): 2x2 Grid mit 3 Säulen in unterer Leiste
  function createDecisionTile(o, opts={}){
    const data = normalizeOffer(o);
    const interactive = opts.interactive !== false;
    const card = document.createElement('div');
    card.className = 'decision-tile';
    card.style.cssText = `
      position: relative;
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      flex-direction: column;
      aspect-ratio: 1;
    `;
    
    if(interactive){
      card.onclick = () => openOffer(data.id);
      card.onmouseover = () => {
        card.style.transform = 'scale(1.02)';
        card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
      };
      card.onmouseout = () => {
        card.style.transform = 'scale(1)';
        card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
      };
    }
    
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    
    // Bild-Container (mit Overlay für 3 Säulen)
    const imgContainer = document.createElement('div');
    imgContainer.style.cssText = `
      position: relative;
      width: 100%;
      flex: 1;
      overflow: hidden;
      background: #f0f0f0;
    `;
    
    const img = document.createElement('img');
    img.src = imgSrc;
    img.alt = data.dish || '';
    img.style.cssText = `
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    `;
    imgContainer.appendChild(img);
    
    // Rotes X oben rechts (Ausschlussverfahren)
    const dismissBtn = document.createElement('button');
    dismissBtn.type = 'button';
    dismissBtn.style.cssText = `
      position: absolute;
      top: 8px;
      right: 8px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(231, 76, 60, 0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 2px solid #fff;
      color: #fff;
      font-size: 18px;
      font-weight: 900;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 20;
      box-shadow: 0 2px 8px rgba(231, 76, 60, 0.4);
      transition: transform 0.2s ease;
    `;
    dismissBtn.textContent = '×';
    dismissBtn.onclick = (e) => {
      e.stopPropagation();
      triggerHapticFeedback([10]);
      // Kachel ausblenden (Ausschlussverfahren)
      card.style.opacity = '0';
      card.style.transform = 'scale(0.9)';
      setTimeout(() => {
        if(card.parentNode) card.parentNode.removeChild(card);
      }, 200);
      showToast('Gericht ausgeschlossen');
    };
    dismissBtn.onmouseover = () => {
      dismissBtn.style.transform = 'scale(1.1)';
    };
    dismissBtn.onmouseout = () => {
      dismissBtn.style.transform = 'scale(1)';
    };
    imgContainer.appendChild(dismissBtn);
    
    // 3 Säulen in unterer Leiste (im Bild-Overlay)
    const pillarsRow = document.createElement('div');
    pillarsRow.style.cssText = `
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0.3) 50%, transparent 100%);
      padding: 12px 8px 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      z-index: 10;
    `;
    
    const offerProvider = offers.find(p => p.providerId === data.providerId);
    const orderingEnabled = offerProvider && (offerProvider.orderingEnabled !== false && (data.hasPickupCode || offerProvider.hasPickupCode));
    const hasDineIn = offerProvider && (offerProvider.dineInPossible !== false || data.dineInPossible);
    const hasReuse = offerProvider && (offerProvider.reuse && offerProvider.reuse.enabled);
    
    // Säule 1: Vor Ort 🍴
    const pillar1 = document.createElement('div');
    pillar1.style.cssText = `
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: ${hasDineIn ? 'rgba(255,255,255,0.95)' : 'rgba(255,255,255,0.4)'};
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      opacity: ${hasDineIn ? '1' : '0.4'};
      filter: ${hasDineIn ? 'none' : 'grayscale(100%)'};
    `;
    pillar1.textContent = '🍴';
    pillarsRow.appendChild(pillar1);
    
    // Säule 2: Abholnummer 🧾
    const pillar2 = document.createElement('div');
    pillar2.style.cssText = `
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: ${orderingEnabled ? 'rgba(255,255,255,0.95)' : 'rgba(255,255,255,0.4)'};
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      opacity: ${orderingEnabled ? '1' : '0.4'};
      filter: ${orderingEnabled ? 'none' : 'grayscale(100%)'};
    `;
    pillar2.textContent = '🧾';
    pillarsRow.appendChild(pillar2);
    
    // Säule 3: Mehrweg 🔄 - ENTFERNT (nur noch im Profil)
    
    imgContainer.appendChild(pillarsRow);
    card.appendChild(imgContainer);
    
    // Footer: Name & Preis in Gelb
    const footer = document.createElement('div');
    footer.style.cssText = `
      background: var(--brand);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 60px;
    `;
    
    const dishName = document.createElement('div');
    dishName.style.cssText = `
      font-weight: 900;
      font-size: 14px;
      color: #1a1a1a;
      line-height: 1.3;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    `;
    dishName.textContent = data.dish || 'Gericht';
    footer.appendChild(dishName);
    
    const price = document.createElement('div');
    price.style.cssText = `
      font-weight: 900;
      font-size: 18px;
      color: #1a1a1a;
    `;
    price.textContent = euro(data.price);
    footer.appendChild(price);
    
    card.appendChild(footer);
    
    return card;
  }
  
  // List Card für Discover-Seite (Kompaktes horizontales Design - Slim-Card)
  function createDiscoverListCard(o){
    const data = normalizeOffer(o);
    const card = document.createElement('div');
    card.className = 'dish-card';
    
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    
    // Favorit-Status prüfen (dishFavs speichert Strings)
    const dishKey = String(data.id || '');
    const isFav = typeof dishFavs !== 'undefined' && dishFavs.has(dishKey);
    
    // Gehzeit berechnen
    let walkingTimeText = '';
    if(data.walkingTimeText){
      walkingTimeText = data.walkingTimeText;
    } else if(data.distanceKm != null){
      const walkingMinutes = Math.round(Number(data.distanceKm) * 12);
      walkingTimeText = walkingMinutes < 1 ? '< 1 Min.' : `${walkingMinutes} Min.`;
    }
    
    // Eco-Badge: Mehrweg-Option (wenn Anbieter es unterstützt)
    const offerProvider = offers.find(p => p.providerId === data.providerId);
    const hasReuseSupport = offerProvider && (offerProvider.reuseEnabled || offerProvider.reuse || (offerProvider.providerProfile && offerProvider.providerProfile.reuseEnabled));
    
    // Service-Label prüfen (Abholnummer vs. Nur Info)
    const hasAbholnummer = data.hasPickupCode || false;
    const serviceLabel = hasAbholnummer 
      ? {text: 'Abholnummer', icon: '🧾', color: '#27AE60', bg: 'rgba(39,174,96,0.15)', border: 'rgba(39,174,96,0.3)'}
      : {text: 'Nur Info', icon: '👁️', color: '#64748b', bg: 'rgba(100,116,139,0.1)', border: 'rgba(100,116,139,0.2)'};
    
    // Kompaktes horizontales Layout: Bild links (quadratisch), Text rechts
    card.innerHTML = `
      <div style="display:flex; gap:12px; align-items:flex-start;">
        <!-- Kompaktes Bild links (quadratisch, max. 100px) -->
        <div style="position:relative; width:100px; height:100px; max-width:100px; max-height:100px; flex-shrink:0; border-radius:12px; overflow:hidden; background:#f0f0f0;">
        <img src="${esc(imgSrc)}" alt="${esc(data.dish||'')}" style="width:100%; height:100%; object-fit:cover;" />
          <!-- Service-Label (oben links) -->
          <div style="position:absolute; top:4px; left:4px; background:${serviceLabel.bg}; border:1px solid ${serviceLabel.border}; color:${serviceLabel.color}; padding:3px 6px; border-radius:6px; font-size:9px; font-weight:700; display:flex; align-items:center; gap:3px; box-shadow:0 2px 4px rgba(0,0,0,0.2); backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px); z-index:6; white-space:nowrap;">
            <span style="font-size:10px;">${serviceLabel.icon}</span>
            <span>${serviceLabel.text}</span>
          </div>
          <!-- Eco-Badge: Mehrweg-Konzept-Icon - ENTFERNT (nur noch im Profil) -->
          <!-- Favorit-Button (oben rechts) -->
          <button class="btn-icon-overlay" onclick="event.stopPropagation(); event.preventDefault(); toggleDishFav(${JSON.stringify(dishKey)}); const btn=this.querySelector('i'); if(btn){ const nowFav=typeof dishFavs!=='undefined'&&dishFavs.has(${JSON.stringify(dishKey)}); btn.style.fill=nowFav?'currentColor':''; btn.style.color=nowFav?'#e74c3c':'#666'; if(typeof lucide!=='undefined')lucide.createIcons(); }" title="Favorit" style="position:absolute; top:4px; right:4px; width:28px; height:28px; border-radius:50%; background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.15); transition:transform 0.2s ease; z-index:5;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
            <i data-lucide="heart" style="width:14px;height:14px;${isFav ? 'fill:currentColor; color:#e74c3c;' : 'color:#666;'}"></i>
          </button>
        </div>
        
        <!-- Info-Bereich rechts (flex:1 für volle Breite) -->
        <div style="flex:1; display:flex; flex-direction:column; justify-content:space-between; min-width:0; padding:2px 0;">
          <!-- Name & Preis in einer Zeile -->
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px; margin-bottom:4px;">
            <h3 class="dish-name" style="font-weight:900; font-size:15px; line-height:1.3; margin:0; color:#111; letter-spacing:-0.2px; flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">${esc(data.dish||'Gericht')}</h3>
            <div class="dish-price" style="font-size:16px; color:var(--brand); font-weight:900; flex-shrink:0; white-space:nowrap;">${euro(data.price)}</div>
      </div>
          
          <!-- Anbieter-Name (klein, uppercase) -->
          <p style="font-size:10px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin:0 0 6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
            ${esc(data.providerName||'Anbieter')}
          </p>
          
          <!-- Info-Zeile: Gehzeit & Zeit-Slot (kompakt) -->
          <div style="display:flex; align-items:center; gap:12px; font-size:10px; font-weight:700; color:#64748b; margin-top:auto;">
            ${walkingTimeText ? `<span style="display:flex; align-items:center; gap:3px;">
              <i data-lucide="navigation" style="width:11px;height:11px; color:var(--brand);"></i>
              <span>${walkingTimeText}</span>
            </span>` : ''}
            ${data.pickupWindow ? `<span style="display:flex; align-items:center; gap:3px;">
              <i data-lucide="clock" style="width:11px;height:11px; color:#94a3b8;"></i>
              <span>${esc(data.pickupWindow)}</span>
            </span>` : ''}
          </div>
        </div>
      </div>
    `;
    
    // Klick auf Karte öffnet immer Detailansicht (nicht direkt Bestellung)
    card.onclick = (e)=>{
      if(e.target.closest('.btn-icon-overlay')) return; // Button-Handler übernimmt
      openOffer(data.id); // Immer Detailansicht öffnen
    };
    
    return card;
  }

  function offerCard(o, opts={}){
    const data = normalizeOffer(o);
    const interactive = opts.interactive !== false;
    const isPolaroid = opts.context === 'customer' || opts.context === 'discover';
    const offerProvider = offers.find(p => p.providerId === data.providerId);
    const usePreviewData = opts.previewFromWizard || opts.interactive === false && data.id === 'preview';
    const orderingEnabled = usePreviewData ? !!data.hasPickupCode : (offerProvider && (offerProvider.orderingEnabled !== false && (data.hasPickupCode || offerProvider.hasPickupCode)));
    const hasDineIn = usePreviewData ? !!data.dineInPossible : (offerProvider && (offerProvider.dineInPossible !== false || data.dineInPossible));
    const hasReuse = usePreviewData ? !!(data.reuse && data.reuse.enabled) : (offerProvider && (offerProvider.reuse && offerProvider.reuse.enabled));
    const card=document.createElement('div');
    card.className='card';
    if(isPolaroid){
      card.classList.add('polaroid');
    } else if(opts.context === 'start' || opts.context === 'customer'){
      card.classList.add('playful');
    }
    if(interactive){
      card.onclick=()=>openOffer(data.id);
    } else {
      card.style.cursor='default';
    }

    // Image (Polaroid: 50% Höhe für kompakte Sammelkarte)
    const img=document.createElement('div');
    img.className='img';
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    
    if(isPolaroid){
      // Kompakte Polaroid-Karte: Foto nimmt exakt 50% Höhe ein
      img.style.cssText = 'position:relative; width:100%; height:50%; min-height:140px; max-height:140px; overflow:hidden; background:#f0f0f0;';
      img.innerHTML = `<img alt="${esc(data.dish||'')}" src="${esc(imgSrc)}" style="width:100%; height:100%; object-fit:cover;" />`;
      
      // Keine Icons mehr auf dem Bild – 3 Säulen als Balken unter dem Anbieter
      
      // Preis-Sticker: Rechts unten auf Foto (gelbe Pill systemweit)
      const priceSticker = document.createElement('div');
      priceSticker.className = 'price-pill';
      priceSticker.style.cssText = 'position:absolute; bottom:8px; right:8px; padding:6px 12px; border-radius:999px; font-weight:900; font-size:14px; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 8px rgba(255,215,0,0.3); z-index:10;';
      priceSticker.textContent = euro(data.price);
      img.appendChild(priceSticker);
      if(data.photoDataIsStandard){
        const symbolHint = document.createElement('div');
        symbolHint.style.cssText = 'position:absolute; bottom:8px; left:8px; right:56px; background:rgba(255,255,255,0.85); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); padding:6px 10px; border-radius:12px; border:1px solid rgba(255,255,255,0.4); z-index:10;';
        symbolHint.innerHTML = '<p style="margin:0; font-size:10px; font-weight:800; color:#1a1a1a; text-transform:uppercase; display:flex; align-items:center; gap:6px;"><span>ℹ️</span> Symbolbild: Abweichungen zum Original möglich</p>';
        img.appendChild(symbolHint);
      }
    } else {
      img.style.position = 'relative';
      img.style.overflow = 'hidden';
      img.innerHTML = `<img alt="${esc(data.dish||'')}" src="${esc(imgSrc)}" style="width:100%; height:100%; object-fit:cover;" />`;
      if(data.photoDataIsStandard){
        const symbolHint = document.createElement('div');
        symbolHint.style.cssText = 'position:absolute; bottom:8px; left:8px; right:8px; background:rgba(255,255,255,0.85); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); padding:6px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.4);';
        symbolHint.innerHTML = '<p style="margin:0; font-size:10px; font-weight:800; color:#1a1a1a; text-transform:uppercase; display:flex; align-items:center; gap:6px;"><span>ℹ️</span> Symbolbild: Abweichungen zum Original möglich</p>';
        img.appendChild(symbolHint);
      }
    }

    // Polaroid: 3 Säulen (🍴 🔄 🧾) direkt unter dem Bild – Konzept: Icons unter Bild, dann Name/Preis/Zeit
    if(isPolaroid){
      const barsWrap = document.createElement('div');
      barsWrap.style.cssText = 'padding:10px 16px; background:#fff; border-top:1px solid rgba(0,0,0,0.04);';
      barsWrap.innerHTML = renderPillarBars(hasDineIn, orderingEnabled, hasReuse);
      card.appendChild(img);
      card.appendChild(barsWrap);
    }

    // Heart Icon (Favorit) - rechts oben (kein Text, nur Icon)
    const dishKey = data.id;
    const heart=document.createElement('button');
    heart.className='card-heart'+(dishFavs.has(dishKey)?' on':'');
    heart.type='button';
    heart.innerHTML = dishFavs.has(dishKey) ? iconMarkup('heart', {fill:true}) : iconMarkup('heart');
    heart.onclick=(e)=>{ e.stopPropagation(); toggleDishFav(dishKey); };
    if(interactive){ card.appendChild(heart); }
    if(!isPolaroid){ card.appendChild(img); }

    // Body
    const body=document.createElement('div');
    body.className='body';
    if(isPolaroid){
      // Polaroid: Weißer Hintergrund für Body (Holz nur im View-Hintergrund) - Clean-up: Keine grauen Linien/Schattenboxen
      body.style.cssText = 'background:#fff; padding:0; flex:1; display:flex; flex-direction:column; border:none; box-shadow:none;';
    }
    
    // Polaroid: Gerichtname in Marker-Schrift mit Teilen-Icon
    if(isPolaroid){
      const titleRow = document.createElement('div');
      titleRow.style.cssText = 'margin-top:12px; padding:0 16px; display:flex; align-items:center; justify-content:space-between; gap:8px;';
      
      const title = document.createElement('h3');
      title.style.cssText = "font-family:'Kalam', 'Comic Sans MS', 'Marker Felt', cursive; font-weight:700; font-size:18px; color:#000; text-transform:none; letter-spacing:0.5px; line-height:1.3; margin:0; flex:1; text-align:center;";
      title.textContent = data.dish || 'Gericht';
      titleRow.appendChild(title);
      
      // Teilen-Icon rechts neben dem Namen
      const shareBtn = document.createElement('button');
      shareBtn.type = 'button';
      shareBtn.style.cssText = 'width:32px; height:32px; border-radius:50%; background:rgba(0,0,0,0.05); border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; flex-shrink:0; transition:background 0.2s ease;';
      shareBtn.onmouseover = () => { shareBtn.style.background = 'rgba(0,0,0,0.1)'; };
      shareBtn.onmouseout = () => { shareBtn.style.background = 'rgba(0,0,0,0.05)'; };
      shareBtn.onclick = (e) => {
        e.stopPropagation();
        shareOffer(data);
      };
      shareBtn.innerHTML = iconMarkup('share-2', {size: 16});
      titleRow.appendChild(shareBtn);
      
      body.appendChild(titleRow);
    } else {
      // Standard-Titelzeile: Dish name (max 2 Zeilen)
    const titleRow = document.createElement('div');
    titleRow.className='card-title-row';
    const title = document.createElement('h3');
    title.className='card-title';
    title.textContent = data.dish || 'Gericht';
    titleRow.appendChild(title);
    body.appendChild(titleRow);
    }
    
    // Anbieter: Restaurant-Name (nur bei Polaroid) – Säulen bereits unter Bild
    if(isPolaroid){
      const providerEl = document.createElement('p');
      providerEl.style.cssText = 'margin:8px 0 0; padding:0 16px; text-align:center; font-size:13px; font-weight:600; color:#666; cursor:pointer; transition:opacity 0.2s ease;';
      providerEl.onmouseover = () => { providerEl.style.opacity = '0.7'; };
      providerEl.onmouseout = () => { providerEl.style.opacity = '1'; };
      providerEl.innerHTML = `<i data-lucide="store" style="width:14px;height:14px; margin-right:4px;"></i> <span>${esc(data.providerName || 'Anbieter')}</span>`;
      providerEl.onclick = (e) => {
        e.stopPropagation();
        if(data.providerId) showProviderProfilePublic(data.providerId);
      };
      body.appendChild(providerEl);
      
      // Icons initialisieren (für die neuen Badges)
      if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
      
      // Mobilitäts-Zeile: Minimalistisch, einzeilig, kleine Schrift (10-12px)
      if(data.distanceKm != null && !usePreviewData){
        const mobilityRow = document.createElement('div');
        mobilityRow.style.cssText = 'margin-top:6px; padding:0 16px; display:flex; align-items:center; justify-content:center; gap:10px; font-size:11px; color:#666; font-weight:500; line-height:1.4;';
        
        // Gehzeit: 5 km/h = 12 Minuten pro km
        const walkingMinutes = Math.round(Number(data.distanceKm) * 12);
        const walkingMeters = Math.round(Number(data.distanceKm) * 1000);
        const walkingTimeText = walkingMinutes < 1 ? '< 1' : walkingMinutes;
        
        // Autofahrt: 50 km/h = 1.2 Minuten pro km
        const carMinutes = Math.round(Number(data.distanceKm) * 1.2);
        const carTimeText = carMinutes < 1 ? '< 1' : carMinutes;
        
        // Entfernung: Meter oder Kilometer formatieren
        const distanceText = walkingMeters < 1000 ? `${walkingMeters}m` : `${Number(data.distanceKm).toFixed(1)}km`;
        
        // Minimalistisches Design: Icons + Zeiten/Entfernung, einzeilig
        mobilityRow.innerHTML = `
          <span style="display:inline-flex; align-items:center; gap:3px; white-space:nowrap;">
            <span style="font-size:14px; line-height:1;">🚶</span>
            <span>${walkingTimeText} min</span>
          </span>
          <span style="color:#999; font-size:10px;">|</span>
          <span style="display:inline-flex; align-items:center; gap:3px; white-space:nowrap;">
            <span style="font-size:14px; line-height:1;">🚗</span>
            <span>${carTimeText} min</span>
          </span>
          <span style="color:#999; font-size:10px;">|</span>
          <span style="display:inline-flex; align-items:center; gap:3px; white-space:nowrap;">
            <span style="font-size:14px; line-height:1;">📍</span>
            <span>${distanceText}</span>
          </span>
        `;
        body.appendChild(mobilityRow);
      }
    } else {
      // Standard: Anbieter mit Store-Icon
      const providerEl = document.createElement('p');
      providerEl.className='card-provider';
      providerEl.style.cursor = 'pointer';
      providerEl.style.textDecoration = 'underline';
      providerEl.style.textDecorationColor = 'rgba(0,0,0,0.2)';
      providerEl.style.transition = 'opacity 0.2s ease';
      providerEl.onmouseover = () => { providerEl.style.opacity = '0.7'; };
      providerEl.onmouseout = () => { providerEl.style.opacity = '1'; };
      providerEl.innerHTML = `<i data-lucide="store" style="width:16px;height:16px;"></i> <span>${esc(data.providerName || 'Anbieter')}</span>`;
      providerEl.onclick = (e) => {
        e.stopPropagation();
        if(data.providerId) showProviderProfilePublic(data.providerId);
      };
      body.appendChild(providerEl);
    }
    
    // Preis: Nur bei Nicht-Polaroid (bei Polaroid ist Preis auf dem Bild)
    if(!isPolaroid){
    const price = document.createElement('div');
    price.className='card-price';
    price.textContent = euro(data.price);
    body.appendChild(price);
    }
    
    // Info-Zeile: Nur bei Nicht-Polaroid (bei Polaroid wird Mobilitäts-Zeile verwendet)
    if(!isPolaroid){
      const infoRow = document.createElement('div');
      infoRow.className='card-info-badges';
      
      // clock: timeRange
      if(data.pickupWindow){
        const timeBadge = document.createElement('span');
        timeBadge.className='card-info-badge';
        timeBadge.innerHTML = `${iconMarkup('clock')} <span>${esc(data.pickupWindow)}</span>`;
        infoRow.appendChild(timeBadge);
      }
      
      // map-pin: distance
      if(data.distanceKm != null && !usePreviewData){
        const distBadge = document.createElement('span');
        distBadge.className='card-info-badge';
        distBadge.innerHTML = `${iconMarkup('map-pin')} <span>${Number(data.distanceKm).toFixed(1)}</span>`;
        infoRow.appendChild(distBadge);
      }
      
      // food type: leaf (Vegan), carrot (Vegetarian), drumstick (Meat), fish (Fish)
      const foodTypeIcon = data.category === 'Vegan' ? 'leaf' : 
                           data.category === 'Vegetarisch' ? 'carrot' : 
                           data.category === 'Mit Fleisch' ? 'drumstick' : 
                           data.category === 'Fisch' ? 'fish' : '';
      if(foodTypeIcon && !usePreviewData){
        const typeBadge = document.createElement('span');
        typeBadge.className='card-info-badge';
        typeBadge.innerHTML = iconMarkup(foodTypeIcon);
        infoRow.appendChild(typeBadge);
      }
      
      // Max 4 Icons pro Info-Zeile
      if(infoRow.children.length > 4){
        while(infoRow.children.length > 4){
          infoRow.removeChild(infoRow.lastChild);
        }
      }
      
      if(infoRow.children.length > 0){
        body.appendChild(infoRow);
      }
    }
    
    // Actions: Primary CTA "In die Mittagsbox" (gelber Button ohne graue Box)
    if(interactive){
      if(isPolaroid){
        // Polaroid: Gelber Button direkt auf weißem Rand (ohne graue Box)
        const orderBtn = document.createElement('button');
        orderBtn.type = 'button';
        orderBtn.style.cssText = 'width:calc(100% - 32px); margin:12px 16px; min-height:48px; background:#FFCC00; color:#1a1a1a; font-weight:900; font-size:16px; border:none; border-radius:12px; box-shadow:0 4px 12px rgba(255,204,0,0.3); display:flex; align-items:center; justify-content:center; gap:8px; cursor:pointer; transition:transform 0.2s ease, box-shadow 0.2s ease;';
        orderBtn.onmouseover = () => {
          orderBtn.style.transform = 'translateY(-2px)';
          orderBtn.style.boxShadow = '0 6px 16px rgba(255,204,0,0.4)';
        };
        orderBtn.onmouseout = () => {
          orderBtn.style.transform = 'translateY(0)';
          orderBtn.style.boxShadow = '0 4px 12px rgba(255,204,0,0.3)';
        };
        orderBtn.innerHTML = `${iconMarkup('shopping-basket')} <span>In die Box 🥗</span>`;
        orderBtn.disabled = !data.hasPickupCode;
        if(orderBtn.disabled){
          orderBtn.style.opacity = '0.5';
          orderBtn.style.cursor = 'not-allowed';
        }
        orderBtn.onclick = (e) => {
          e.stopPropagation();
          if(orderBtn.disabled) return;
          const thumb = card.querySelector('img');
          flyThumbnailToMittagsbox(thumb, () => handleOrderClick(data));
        };
        body.appendChild(orderBtn);
      } else {
        // Standard: Mit grauer Box
        const actions=document.createElement('div');
        actions.className='card-actions';
        
        const orderBtn=document.createElement('button');
        orderBtn.type='button';
        orderBtn.className='card-action primary';
        orderBtn.innerHTML = `${iconMarkup('shopping-basket')} <span>In die Mittagsbox</span>`;
        orderBtn.disabled = !data.hasPickupCode;
        orderBtn.onclick=(e)=>{ e.stopPropagation(); const thumb = card.querySelector('img'); flyThumbnailToMittagsbox(thumb, () => handleOrderClick(data)); };
        
        actions.appendChild(orderBtn);
        body.appendChild(actions);
      }
    }

    if(!isPolaroid) card.appendChild(img);
    card.appendChild(body);
    
    // Icons aktualisieren (für Heart Icon)
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
    
    return card;
  }

  function providerCard(o, opts={}){
    const data = normalizeOffer(o);
    const interactive = opts.interactive !== false;
    const showActions = opts.showActions === true;
    const isToday = data.day === (opts.todayKey || isoDate(new Date()));
    const statusLine = data.hasPickupCode ? (isToday ? 'Abholnummer · Heute' : 'Abholnummer') : '';
    const card=document.createElement('div');
    card.className='card';
    card.style.cursor = interactive ? 'pointer' : 'default';
    if(interactive){
      card.onclick=()=>openProviderOffer(data.id);
    }

    const profile = normalizeProviderProfile(provider.profile || {});
    const imgSrc = data.imageUrl || data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    const windowText = data.pickupWindow || profile.mealWindow || '';

    const img=document.createElement('div');
    img.className='img';
    img.innerHTML = `
      <img alt="${esc(data.dish||'Gericht')}" src="${esc(imgSrc)}" />
      ${data.active===false?'<div class="badge inactive">Inaktiv</div>':''}
      ${data.hasPickupCode?'<div class="badge code">Abholnummer</div>':''}
      ${data.dineInPossible?'<div class="badge dine">Vor Ort</div>':''}
    `;

    const body=document.createElement('div');
    body.className='body';
    body.innerHTML = `
      <p class="title">${esc(data.dish||'Gericht')}</p>
      <p class="sub">Essenszeit: ${esc(windowText || '—')}</p>
      ${statusLine ? `<div class="tag">${esc(statusLine)}</div>` : ''}
      <div class="meta">
        <div class="price">${euro(data.price)}</div>
        <div class="right">
          <div>${esc(data.category||'')}</div>
        </div>
      </div>
    `;

    const info=document.createElement('div');
    info.className='info-row';
    const addInfo = (icon, text)=>{
      const item=document.createElement('div');
      item.className='info-item';
      item.innerHTML = `${iconMarkup(icon)}<span>${esc(text)}</span>`;
      info.appendChild(item);
    };
    if(data.hasPickupCode) addInfo('hash', 'Abholnummer');
    if(data.dineInPossible) addInfo('utensils', 'Vor Ort');
    if(info.childElementCount){ body.appendChild(info); }

    if(showActions){
      const actions=document.createElement('div');
      actions.className='card-actions';

      const actBtn=document.createElement('button');
      actBtn.type='button';
      actBtn.className='card-action';
      actBtn.innerHTML = `${iconMarkup('action')}<span>Aktionen</span>`;
      actBtn.onclick=(e)=>{ e.stopPropagation(); openProviderOffer(data.id); };

      const shareBtn=document.createElement('button');
      shareBtn.type='button';
      shareBtn.className='card-action';
      shareBtn.innerHTML = `${iconMarkup('share')}<span>Teilen</span>`;
      shareBtn.onclick=(e)=>{ e.stopPropagation(); shareOffer(data); };

      const printBtn=document.createElement('button');
      printBtn.type='button';
      printBtn.className='card-action';
      printBtn.innerHTML = `${iconMarkup('print')}<span>Drucken</span>`;
      printBtn.onclick=(e)=>{ e.stopPropagation(); printOffer(data); };

      actions.appendChild(actBtn);
      actions.appendChild(shareBtn);
      actions.appendChild(printBtn);
      body.appendChild(actions);
    }

    card.appendChild(img);
    card.appendChild(body);
    return card;
  }

  function toggleProviderFav(providerId){
    if(!providerId) return;
    if(providerFavs.has(providerId)) providerFavs.delete(providerId); else providerFavs.add(providerId);
    const arr = Array.from(providerFavs);
    save(LS.providerFavs, arr);
    // keep legacy key for compatibility
    save(LS.favs, arr);
    renderDiscover();
    renderStart();
    renderFavorites();
    updateSheetFavs();
  }

  // Haptics-Funktion für Vibrations-Feedback
  function triggerHapticFeedback(pattern = [15]){
    if(navigator.vibrate){
      try {
        navigator.vibrate(pattern);
      } catch(e){
        // Fallback: Ignoriere Fehler
      }
    }
  }

  function toggleDishFav(offerId){
    if(!offerId) return;
    const sid = String(offerId);
    triggerHapticFeedback([15]);
    if(dishFavs.has(sid)){
      dishFavs.delete(sid);
      clearFavPillars(sid);
    } else {
      dishFavs.add(sid);
      const offer = offers.find(o => String(o.id) === sid);
      if(offer){
        const data = normalizeOffer(offer);
        const prov = offers.find(p => p.providerId === data.providerId);
        const vorOrt = !!(prov && (prov.dineInPossible !== false || data.dineInPossible));
        const abholnummer = !!(prov && (prov.orderingEnabled !== false && (data.hasPickupCode || prov.hasPickupCode)));
        const mehrweg = !!(prov && (prov.reuseEnabled || prov.reuse || (prov.providerProfile && prov.providerProfile.reuseEnabled)));
        setFavPillars(sid, { vorOrt, abholnummer, mehrweg });
      }
    }
    save(LS.dishFavs, Array.from(dishFavs));
    renderDiscover();
    renderStart();
    renderFavorites();
    updateSheetFavs();
  }
  
  // Favoriten-Kachel: Kompaktes Grid-Layout (Dashboard-Style)
  function createFavoriteCard(o){
    const data = normalizeOffer(o);
    const card = document.createElement('div');
    card.className = 'fav-grid-card';
    card.setAttribute('data-fav-id', data.id);
    card.style.position = 'relative';
    card.style.background = '#FFFFFF';
    card.style.borderRadius = '16px';
    card.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.08)';
    card.style.border = '1px solid rgba(0,0,0,0.06)';
    card.style.overflow = 'hidden';
    card.style.transition = 'transform 0.2s ease, opacity 0.3s ease, box-shadow 0.2s ease';
    card.style.cursor = 'pointer';
    card.style.display = 'flex';
    card.style.flexDirection = 'column';
    
    // Hover-Effekt
    card.onmouseenter = () => {
      card.style.transform = 'translateY(-2px)';
      card.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.12)';
    };
    card.onmouseleave = () => {
      card.style.transform = 'translateY(0)';
      card.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.08)';
    };
    
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    
    // Kompaktes Bild (reduzierte Höhe für Grid)
    const img = document.createElement('div');
    img.style.position = 'relative';
    img.style.height = '96px'; // Kompakt: 96px statt 256px
    img.style.overflow = 'hidden';
    img.style.background = '#f0f0f0';
    const imgEl = document.createElement('img');
    imgEl.src = imgSrc;
    imgEl.alt = esc(data.dish||'Gericht');
    imgEl.style.width = '100%';
    imgEl.style.height = '100%';
    imgEl.style.objectFit = 'cover';
    img.appendChild(imgEl);
    
    // X-Icon oben rechts zum Entfernen (Schnell-Streichen)
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.style.position = 'absolute';
    removeBtn.style.top = '6px';
    removeBtn.style.right = '6px';
    removeBtn.style.zIndex = '10';
    removeBtn.style.background = 'rgba(255,255,255,0.95)';
    removeBtn.style.backdropFilter = 'blur(8px)';
    removeBtn.style.webkitBackdropFilter = 'blur(8px)';
    removeBtn.style.border = 'none';
    removeBtn.style.borderRadius = '50%';
    removeBtn.style.width = '28px';
    removeBtn.style.height = '28px';
    removeBtn.style.display = 'flex';
    removeBtn.style.alignItems = 'center';
    removeBtn.style.justifyContent = 'center';
    removeBtn.style.cursor = 'pointer';
    removeBtn.style.padding = '0';
    removeBtn.style.boxShadow = '0 2px 6px rgba(0,0,0,0.15)';
    removeBtn.style.transition = 'transform 0.2s ease, background 0.2s ease';
    removeBtn.innerHTML = '<i data-lucide="x" style="width:16px;height:16px;color:#E34D4D;stroke-width:3;"></i>';
    removeBtn.onmouseenter = () => {
      removeBtn.style.transform = 'scale(1.1)';
      removeBtn.style.background = '#fff';
    };
    removeBtn.onmouseleave = () => {
      removeBtn.style.transform = 'scale(1)';
      removeBtn.style.background = 'rgba(255,255,255,0.95)';
    };
    removeBtn.onclick = (e) => {
      e.stopPropagation();
      e.preventDefault();
      // Haptics beim Entfernen
      triggerHapticFeedback([15]);
      // Animation: Ausblenden
      card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      card.style.opacity = '0';
      card.style.transform = 'scale(0.9)';
      // Nach Animation entfernen
      setTimeout(() => {
      toggleDishFav(data.id);
        // Grid automatisch neu anordnen durch Re-Render
        renderFavorites();
      }, 300);
    };
    img.appendChild(removeBtn);
    
    // Kompakter Content-Bereich
    const body = document.createElement('div');
    body.style.padding = '8px';
    body.style.flex = '1';
    body.style.display = 'flex';
    body.style.flexDirection = 'column';
    body.style.gap = '4px';
    body.innerHTML = `
      <p style="font-size:10px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin:0; line-height:1.2; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${esc(data.providerName||'Anbieter')}</p>
      <p style="font-size:13px; font-weight:900; color:#1a1a1a; margin:0; line-height:1.3; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">${esc(data.dish||'Gericht')}</p>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:auto; padding-top:4px;">
        <span style="font-size:14px; font-weight:900; color:var(--brand);">${euro(data.price)}</span>
            </div>
    `;
    
    card.appendChild(img);
    card.appendChild(body);
    
    // Klick auf Karte öffnet Details (nicht auf Remove-Button)
    card.onclick = (e) => {
      // Ignoriere Klicks auf Remove-Button
      if(e.target.closest('button[type="button"]')) return;
      openOffer(data.id);
    };
    
    return card;
  }
  
  // Favorit zur Mittagsbox hinzufügen
  function addFavoriteToCart(o){
    const data = normalizeOffer(o);
    
    // Prüfe ob Gericht Abholnummer hat
    if(!data.hasPickupCode){
      showToast('Dieses Gericht hat keine Abholnummer. Bitte wähle ein anderes Gericht.', 3000);
      return;
    }
    
    // Bestätigung
    const confirmed = confirm(`Dieses Gericht für heute wählen?\n\n${esc(data.dish||'Gericht')}\n${euro(data.price)}\n\nNach der Zahlung erhältst du deine Abholnummer.`);
    if(!confirmed) return;
    
    // Gericht hinzufügen (statt "Zur Mittagsbox" - verboten für Endkunden)
    if(addToCart(o)){
      showToast('Gericht hinzugefügt!', 2000);
      updateHeaderBasket();
      
      // Zur Mittagsbox navigieren (dort kann der Nutzer dann zur Kasse gehen)
      setTimeout(() => {
        showCart();
      }, 500);
    } else {
      showToast('Fehler beim Hinzufügen. Bitte erneut versuchen.', 3000);
    }
  }

  // Heute-Fokus: Immer nur heute anzeigen (kein Day-Switcher mehr)
  let activeFavDay = isoDate(new Date()); // Immer heute
  
  function renderFavorites(){
    const provGrid=document.getElementById('favProviders');
    const provEmpty=document.getElementById('emptyFavProviders');
    const dishGrid=document.getElementById('favDishes');
    const dishEmpty=document.getElementById('emptyFavDishes');
    const favEmptyState = document.getElementById('favEmptyState');
    const favContent = document.getElementById('favContent');
    if(!provGrid || !dishGrid || !provEmpty || !dishEmpty) return;
    
    // Day-Switcher ENTFERNT: Fokus zu 100% auf dem aktuellen Tag
    // activeFavDay wird immer auf heute gesetzt
    activeFavDay = isoDate(new Date());
    
    // Verstecke Day-Switcher falls noch vorhanden
    const daySwitcher = document.getElementById('favDaySwitcher');
    if(daySwitcher) daySwitcher.style.display = 'none';

    const candidates = offers
      .filter(o => o.active !== false && providerFavs.has(o.providerId) && o.day === activeFavDay)
      .sort((a,b)=>String(b.day||'').localeCompare(String(a.day||'')));
    const bestByProvider = new Map();
    candidates.forEach(o=>{
      if(!bestByProvider.has(o.providerId)) bestByProvider.set(o.providerId, o);
    });
    const providerList = Array.from(bestByProvider.values());

    // Alle favorisierten Gerichte anzeigen (nicht nur heute) – heute zuerst sortiert
    const dishList = offers
      .filter(o => o.active !== false && dishFavs.has(String(o.id)))
      .sort((a,b)=>{
        const aDay = a.day || '';
        const bDay = b.day || '';
        if(aDay === activeFavDay && bDay !== activeFavDay) return -1;
        if(aDay !== activeFavDay && bDay === activeFavDay) return 1;
        return String(bDay).localeCompare(String(aDay));
      });

    // Empty State: Wenn beide Listen leer sind, zeige zentrierten Empty State
    const hasAnyFavorites = providerList.length > 0 || dishList.length > 0;
    
    if(favEmptyState){
      favEmptyState.style.display = hasAnyFavorites ? 'none' : 'flex';
      // Stelle sicher, dass Flex-Layout aktiv ist
      if(!hasAnyFavorites){
        favEmptyState.style.flexDirection = 'column';
        favEmptyState.style.alignItems = 'center';
        favEmptyState.style.textAlign = 'center';
      }
    }
    if(favContent){
      favContent.style.display = hasAnyFavorites ? 'block' : 'none';
    }
    
    // Provider Section - "Deine Lieblings-Anbieter heute"
    const sectionProvidersWrapper = document.getElementById('sectionProvidersWrapper');
    const favProviderSeparator = document.getElementById('favProviderSeparator');
    provGrid.innerHTML='';
    
    // Zeige Sektion nur wenn es Anbieter-Favoriten gibt
    if(sectionProvidersWrapper){
      sectionProvidersWrapper.style.display = providerFavs.size > 0 ? 'block' : 'none';
    }
    if(favProviderSeparator){
      favProviderSeparator.style.display = (providerFavs.size > 0 && dishList.length > 0) ? 'block' : 'none';
    }
    
    const sectionProviders = document.getElementById('sectionProviders');
    if(sectionProviders) sectionProviders.style.display = providerList.length > 0 ? 'block' : 'none';
    provEmpty.style.display = providerList.length ? 'none' : 'block';
    
    // Alle favorisierten Anbieter durchgehen (nicht nur die mit Angeboten für heute)
    const allFavoritedProviders = Array.from(providerFavs);
    const providerMap = new Map();
    
    // Erstelle Map aller Anbieter mit ihren Angeboten für heute
    allFavoritedProviders.forEach(providerId => {
      const providerOffers = offers.filter(o => 
        o.providerId === providerId && 
        o.active !== false && 
        o.day === activeFavDay
      );
      // Finde erstes Angebot des Providers für Provider-Daten (Name, etc.)
      const firstOffer = offers.find(p => p.providerId === providerId);
      if(firstOffer){
        // Erstelle Provider-Objekt aus Angebot-Daten
        const providerData = {
          providerId: providerId,
          providerName: normalizeOffer(firstOffer).providerName || 'Anbieter',
          orderingEnabled: firstOffer.hasPickupCode !== false,
          dineInPossible: firstOffer.dineInPossible !== false,
          reuse: firstOffer.reuse || {enabled: false}
        };
        providerMap.set(providerId, {
          provider: providerData,
          offers: providerOffers,
          hasOfferToday: providerOffers.length > 0
        });
      }
    });
    
    // Rendere alle favorisierten Anbieter
    Array.from(providerMap.values()).forEach(({provider, offers: providerOffers, hasOfferToday}) => {
      if(provider){
        try {
          const providerCard = createFavoriteProviderCard(provider, providerOffers, hasOfferToday);
          provGrid.appendChild(providerCard);
        } catch(err){
          console.error('Error rendering provider favorite:', err, provider);
        }
      }
    });

    // Dish Section: Oberste 4 Gericht-Favoriten im 2x2 Grid (Jiggle + X)
    dishGrid.innerHTML='';
    const sectionDishesWrapper = document.getElementById('sectionDishesWrapper');
    if(sectionDishesWrapper) sectionDishesWrapper.style.display = dishList.length > 0 ? 'block' : 'none';
    dishEmpty.style.display = dishList.length ? 'none' : 'block';
    const topFour = dishList.slice(0, 4);
    topFour.forEach(o=>{
      if(o?.id){
        try {
          const favCard = createFavoriteGridCard(o);
          dishGrid.appendChild(favCard);
        } catch(err){
          console.error('Error rendering dish favorite:', err, o);
        }
      }
    });
    
    // Share (Web Share API) – Logik-Weiche:
    // IF User wählt 'Team-Bestellung': Variante 2 (Direkt-Warenkorb-Link) – zukünftig
    // ELSE IF Abholnummer 🧾 vorhanden: Variante 1 (Fokus Zeitersparnis / Skip-the-line)
    // ELSE (Keine Abholnummer): Variante 3 (Fokus Gericht & Treffen – „Lockerer Lunch“)
    const favShareWrap = document.getElementById('favShareWrap');
    if(favShareWrap) favShareWrap.style.display = 'none';
    const baseUrl = window.location.href.split('#')[0] || window.location.origin || '';
    const firstDish = topFour.length > 0 ? normalizeOffer(topFour[0]) : null;
    const firstProviderName = (providerList.length > 0 && !firstDish) ? (normalizeOffer(providerList[0]).providerName || 'Mittagio') : null;
    const firstHasAbholnummer = firstDish && (() => {
      const o = topFour[0];
      const p = offers.find(x => x.providerId === (o && o.providerId));
      return !!(p && (p.orderingEnabled !== false && ((o && (o.hasPickupCode || o.orderingEnabled)) || (p.hasPickupCode))));
    })();
    // Smart-Share: Anbietername aus Favoriten-Kachel; abholnummer → „skippen“ vs. „Mittag machen“
    const shareFavAction = () => {
      try {
        const providerName = (firstDish && firstDish.providerName) ? firstDish.providerName : (firstProviderName || 'Mittagio');
        const dishName = (firstDish && (firstDish.dish || firstDish.title)) ? (firstDish.dish || firstDish.title) : '';
        const linkToDish = (firstDish && firstDish.id) ? (baseUrl + '#offer=' + firstDish.id) : baseUrl;
        let shareText;
        if(firstHasAbholnummer){
          shareText = `🚀 Schau mal! Meine Mittagsbox heute bei ${providerName}! 🍴 Ich hab mir schon die Abholnummer 🧾 gesichert, dann können wir die Schlange einfach skippen. Kommst du mit? ${linkToDish}`;
        } else {
          shareText = `😋 Schau mal! Meine Mittagsbox heute bei ${providerName}! 🍴 Sieht richtig gut aus, oder? Sollen wir uns dort heute treffen & Mittag machen? ${linkToDish}`;
        }
        const shareTitle = dishName ? `${dishName} – ${providerName} | Mittagio` : 'Mein Mittag – Mittagio';
        const doFallback = () => {
          try {
            if(navigator.clipboard && navigator.clipboard.writeText){
              navigator.clipboard.writeText(shareText).then(() => {
                if(typeof showToast === 'function') showToast('Link kopiert – zum Teilen einfügen');
              }).catch(() => {
                if(typeof showToast === 'function') showToast('Teilen: Link zum Einfügen bereit');
              });
            } else {
              if(typeof showToast === 'function') showToast('Teilen: ' + shareTitle);
            }
          } catch(e2){
            if(typeof showToast === 'function') showToast('Teilen vorbereitet');
          }
        };
        if(navigator.share && typeof navigator.share === 'function'){
          navigator.share({ title: shareTitle, text: shareText, url: linkToDish })
            .then(() => { if(typeof showToast === 'function') showToast('Geteilt'); })
            .catch((err) => { if(err && err.name === 'AbortError') return; doFallback(); });
        } else {
          doFallback();
        }
      } catch(e){
        if(typeof showToast === 'function') showToast('Teilen nicht möglich – bitte Link manuell kopieren');
      }
    };
    const btnFavShareHeader = document.getElementById('btnFavShareHeader');
    if(btnFavShareHeader){
      btnFavShareHeader.style.display = (topFour.length > 0 || providerList.length > 0) ? 'flex' : 'none';
      btnFavShareHeader.onclick = function(e){ e.preventDefault(); e.stopPropagation(); shareFavAction(); };
    }
    const btnShareMyLunch = document.getElementById('btnShareMyLunch');
    if(btnShareMyLunch) btnShareMyLunch.onclick = shareFavAction;
    
    // Pull-Hinweis: anzeigen wenn es Favoriten für Morgen/Übermorgen gibt
    const favPullHint = document.getElementById('favPullHint');
    const hasUpcoming = offers.some(o => o.active !== false && (dishFavs.has(o.id) || providerFavs.has(o.providerId)) && o.day !== activeFavDay);
    if(favPullHint) favPullHint.style.display = hasUpcoming ? 'block' : 'none';
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
    
    // Vorschau auf kommende Tage rendern
    renderFavoritesUpcomingPreview();
    
    // Scroll-Listener für Vorschau-Sektion einrichten
    setupFavoritesScrollListener();
  }
  
  // Vorschau auf kommende Tage (Morgen, Übermorgen)
  function renderFavoritesUpcomingPreview(){
    const upcomingPreview = document.getElementById('favUpcomingPreview');
    const upcomingDays = document.getElementById('favUpcomingDays');
    if(!upcomingPreview || !upcomingDays) return;
    
    upcomingDays.innerHTML = '';
    
    const today = new Date();
    const upcomingDaysList = [];
    
    // Morgen und Übermorgen
    for(let i = 1; i <= 2; i++){
      const d = new Date(today);
      d.setDate(d.getDate() + i);
      const dayKey = isoDate(d);
      const dayLabel = i === 1 ? 'Morgen' : fmtDay(d).split(',')[0];
      
      // Favoriten für diesen Tag finden
      const dayDishes = offers.filter(o => 
        o.active !== false && 
        dishFavs.has(o.id) && 
        o.day === dayKey
      );
      
      if(dayDishes.length > 0){
        upcomingDaysList.push({
          dayKey: dayKey,
          dayLabel: dayLabel,
          dishes: dayDishes
        });
      }
    }
    
    // Zeige Vorschau nur wenn es Gerichte gibt
    if(upcomingDaysList.length > 0){
      upcomingDaysList.forEach(({dayKey, dayLabel, dishes}) => {
        const daySection = document.createElement('div');
        daySection.style.cssText = 'margin-bottom:20px;';
        
        const dayTitle = document.createElement('div');
        dayTitle.style.cssText = 'font-size:14px; font-weight:700; color:#666; margin-bottom:10px; text-transform:uppercase; letter-spacing:0.5px;';
        dayTitle.textContent = dayLabel;
        daySection.appendChild(dayTitle);
        
        // Horizontale Scroll-Liste für kompakte Darstellung
        const scrollContainer = document.createElement('div');
        scrollContainer.style.cssText = 'display:flex; gap:10px; overflow-x:auto; padding-bottom:8px; scrollbar-width:thin; -webkit-overflow-scrolling:touch;';
        scrollContainer.style.scrollbarWidth = 'thin';
        
        dishes.forEach(o => {
          const data = normalizeOffer(o);
          const miniCard = createUpcomingDayCard(data, dayKey);
          scrollContainer.appendChild(miniCard);
        });
        
        daySection.appendChild(scrollContainer);
        upcomingDays.appendChild(daySection);
      });
    }
  }
  
  // Kompakte Karte für kommende Tage
  function createUpcomingDayCard(data, dayKey){
    const card = document.createElement('div');
    card.style.cssText = 'flex:0 0 auto; width:140px; background:#fff; border-radius:10px; border:1px solid rgba(0,0,0,0.08); box-shadow:0 1px 3px rgba(0,0,0,0.06); overflow:hidden; cursor:pointer; transition:transform 0.2s ease, box-shadow 0.2s ease;';
    
    card.onmouseover = () => {
      card.style.transform = 'translateY(-2px)';
      card.style.boxShadow = '0 2px 6px rgba(0,0,0,0.1)';
    };
    card.onmouseout = () => {
      card.style.transform = 'translateY(0)';
      card.style.boxShadow = '0 1px 3px rgba(0,0,0,0.06)';
    };
    
    card.onclick = () => {
      openOffer(data.id);
    };
    
    // Mini-Bild (kompakt)
    const img = document.createElement('div');
    img.style.cssText = 'width:100%; height:80px; background:#f0f0f0; overflow:hidden; position:relative;';
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    img.innerHTML = `<img src="${esc(imgSrc)}" alt="${esc(data.dish||'')}" style="width:100%; height:100%; object-fit:cover;" />`;
    card.appendChild(img);
    
    // Body
    const body = document.createElement('div');
    body.style.cssText = 'padding:8px;';
    
    // Gerichtname (kompakt)
    const title = document.createElement('div');
    title.style.cssText = "font-family:'Kalam', 'Comic Sans MS', 'Marker Felt', cursive; font-weight:700; font-size:12px; color:#000; margin-bottom:4px; line-height:1.2; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;";
    title.textContent = data.dish || 'Gericht';
    body.appendChild(title);
    
    // Restaurant-Name (sehr kompakt)
    const provider = document.createElement('div');
    provider.style.cssText = 'font-size:10px; color:#999; margin-bottom:6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;';
    provider.textContent = data.providerName || 'Anbieter';
    body.appendChild(provider);
    
    // 3 Säulen-Icons (dezent, klein)
    const offerProvider = offers.find(p => p.providerId === data.providerId);
    const orderingEnabled = offerProvider && (offerProvider.orderingEnabled !== false && (data.hasPickupCode || offerProvider.hasPickupCode));
    const hasDineIn = offerProvider && (offerProvider.dineInPossible !== false || data.dineInPossible);
    const hasReuse = offerProvider && (offerProvider.reuse && offerProvider.reuse.enabled);
    
    const iconsRow = document.createElement('div');
    iconsRow.style.cssText = 'display:flex; align-items:center; justify-content:center; gap:6px;';
    iconsRow.innerHTML = `
      <span style="font-size:14px; opacity:${hasDineIn ? '1' : '0.3'};" title="Vor Ort">🍴</span>
      <span style="font-size:14px; opacity:${orderingEnabled ? '1' : '0.3'};" title="Abholnummer">🧾</span>
      <span style="font-size:14px; opacity:${hasReuse ? '1' : '0.3'};" title="Mehrweg">🔄</span>
    `;
    body.appendChild(iconsRow);
    
    card.appendChild(body);
    return card;
  }
  
  // Scroll-Listener für Vorschau-Sektion
  function setupFavoritesScrollListener(){
    const favContent = document.getElementById('favContent');
    const upcomingPreview = document.getElementById('favUpcomingPreview');
    if(!favContent || !upcomingPreview) return;
    
    let lastScrollTop = 0;
    let previewShown = false;
    
    const checkScroll = () => {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const favContentBottom = favContent.offsetTop + favContent.offsetHeight;
      const viewportBottom = scrollTop + window.innerHeight;
      
      // Zeige Vorschau wenn Nutzer unter Anbieter-Favoriten scrollt oder hochzieht
      if(!previewShown && (scrollTop > favContentBottom - window.innerHeight * 0.8 || scrollTop < lastScrollTop)){
        previewShown = true;
        upcomingPreview.style.display = 'block';
        // Fade-in Animation
        setTimeout(() => {
          upcomingPreview.style.opacity = '1';
        }, 50);
      }
      
      lastScrollTop = scrollTop;
    };
    
    // Initial check
    checkScroll();
    
    // Scroll-Listener
    window.addEventListener('scroll', checkScroll, {passive: true});
    
    // Touch-Listener für "hochziehen"
    let touchStartY = 0;
    favContent.addEventListener('touchstart', (e) => {
      touchStartY = e.touches[0].clientY;
    }, {passive: true});
    
    favContent.addEventListener('touchmove', (e) => {
      const touchY = e.touches[0].clientY;
      // Wenn Nutzer nach oben zieht (pull up)
      if(touchY > touchStartY + 50 && !previewShown){
        previewShown = true;
        upcomingPreview.style.display = 'block';
        setTimeout(() => {
          upcomingPreview.style.opacity = '1';
        }, 50);
      }
    }, {passive: true});
  }
  
  // Favoriten-Grid-Karte: homogenes Layout (fixe Höhe, 1:1 Bild, 3 Säulen unter Bild, Abholnummer #FFD700, CTA unten)
  function createFavoriteGridCard(o){
    const data = normalizeOffer(o);
    const card = document.createElement('div');
    card.className = 'fav-card';
    card.onclick = () => openOffer(data.id);
    
    // Remove Button
    const removeBtn = document.createElement('button');
    removeBtn.style.cssText = 'position:absolute; top:8px; right:8px; z-index:20; width:28px; height:28px; border-radius:10px; background:rgba(255,255,255,0.9); border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.1);';
    removeBtn.innerHTML = '<i data-lucide="x" style="width:16px; height:16px; color:#E34D4D;"></i>';
    removeBtn.onclick = (e) => {
      e.stopPropagation();
      toggleDishFav(data.id);
      renderFavorites();
    };
    card.appendChild(removeBtn);

    const img = document.createElement('img');
    img.className = 'fav-card-img';
    img.src = data.imageUrl || 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=800&q=80';
    img.loading = 'lazy';
    card.appendChild(img);
    
    const body = document.createElement('div');
    body.style.padding = '12px';
    body.style.flex = '1';
    body.style.display = 'flex';
    body.style.flexDirection = 'column';
    
    const title = document.createElement('div');
    title.style.cssText = 'font-size:14px; font-weight:850; color:#1a1a1a; margin-bottom:4px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; line-height:1.3; letter-spacing:-0.01em;';
    title.textContent = data.dish || 'Gericht';
    body.appendChild(title);
    
    const meta = document.createElement('div');
    meta.style.cssText = 'font-size:11px; font-weight:700; color:#64748b; margin-bottom:8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;';
    meta.textContent = data.providerName || 'Anbieter';
    body.appendChild(meta);
    
    // 3 Pillars Mini
    const pillars = document.createElement('div');
    pillars.className = 'card-pillars';
    pillars.style.marginTop = 'auto';
    
    const p = offers.find(x => x.providerId === data.providerId);
    const abholnummer = !!(p && p.orderingEnabled !== false && (data.hasPickupCode || p.hasPickupCode));
    const mehrweg = !!(p && (p.reuse && p.reuse.enabled));
    
    pillars.innerHTML = `
      <div class="pillar-mini active" style="width:20px; height:20px; font-size:12px;">🍴</div>
      <div class="pillar-mini ${abholnummer ? 'active yellow' : ''}" style="width:20px; height:20px; font-size:12px;">🧾</div>
      <div class="pillar-mini ${mehrweg ? 'active green' : ''}" style="width:20px; height:20px; font-size:12px;">🔄</div>
    `;
    body.appendChild(pillars);
    
    const btn = document.createElement('button');
    btn.className = 'btn-cust-primary';
    btn.style.cssText = 'width:100%; margin-top:12px; height:40px; border-radius:12px; font-size:13px; box-shadow:none;';
    btn.textContent = 'In die Box';
    btn.onclick = (e) => {
      e.stopPropagation();
      if(!abholnummer){ showToast('Keine Abholnummer verfügbar'); return; }
      flyThumbnailToMittagsbox(img, () => {
        if(addToCart(o)){
          showToast('In der Box! 🥗');
          updateHeaderBasket();
        }
      });
    };
    body.appendChild(btn);
    
    card.appendChild(body);
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons({props: { 'stroke-width': 3 }, elements: [removeBtn]}), 10);
    return card;
  }
  
  function triggerCartIconGlow(){
    const btn = document.getElementById('bottomNavBasketBtn');
    if(!btn) return;
    const ico = btn.querySelector('.ico');
    if(ico){ ico.classList.add('cart-icon-glow'); setTimeout(() => ico.classList.remove('cart-icon-glow'), 600); }
  }

  /**
   * Animation: Thumbnail verkleinert sich und fliegt in das Mittagsbox-Icon.
   * sourceEl = Bild-Element (img oder Container mit img); onComplete = Callback nach Ende.
   */
  function flyThumbnailToMittagsbox(sourceEl, onComplete){
    if(typeof onComplete !== 'function') onComplete = function(){};
    const targetBtn = document.getElementById('bottomNavBasketBtn');
    if(!targetBtn){ onComplete(); return; }
    const targetEl = targetBtn.querySelector('.ico') || targetBtn;
    const imgEl = sourceEl && (sourceEl.tagName === 'IMG' ? sourceEl : sourceEl.querySelector('img'));
    const src = imgEl && (imgEl.src || imgEl.getAttribute('src'));
    if(!src || !imgEl){ onComplete(); return; }
    const srcRect = imgEl.getBoundingClientRect();
    const targetRect = targetEl.getBoundingClientRect();
    const fly = document.createElement('div');
    fly.className = 'fly-thumbnail';
    const img = document.createElement('img');
    img.src = src;
    img.alt = '';
    fly.appendChild(img);
    fly.style.left = srcRect.left + 'px';
    fly.style.top = srcRect.top + 'px';
    fly.style.width = srcRect.width + 'px';
    fly.style.height = srcRect.height + 'px';
    fly.style.transition = 'none';
    document.body.appendChild(fly);
    const startCenterX = srcRect.left + srcRect.width / 2;
    const startCenterY = srcRect.top + srcRect.height / 2;
    const targetCenterX = targetRect.left + targetRect.width / 2;
    const targetCenterY = targetRect.top + targetRect.height / 2;
    const tx = targetCenterX - startCenterX;
    const ty = targetCenterY - startCenterY;
    requestAnimationFrame(function(){
      requestAnimationFrame(function(){
        fly.style.transition = 'transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.5s ease';
        fly.style.transform = 'translate(' + tx + 'px, ' + ty + 'px) scale(0.12)';
        fly.style.opacity = '0.85';
        setTimeout(function(){
          fly.remove();
          onComplete();
        }, 520);
      });
    });
  }

  // Anbieter-Favoriten-Karte: Kompakte Zeile mit Name, Text und 3 Icons
  function createFavoriteProviderCard(providerData, offersToday, hasOfferToday){
    const card = document.createElement('div');
    card.className = 'cust-card';
    card.style.cssText = 'flex-direction:row; padding:12px; align-items:center; gap:16px; margin-bottom:12px;';
    if(!hasOfferToday) card.style.opacity = '0.6';
    
    const logo = document.createElement('div');
    logo.style.cssText = 'width:56px; height:56px; border-radius:16px; background:#f1f3f5; display:flex; align-items:center; justify-content:center; font-size:28px; flex-shrink:0;';
    logo.textContent = '🍽️';
    card.appendChild(logo);
    
    const body = document.createElement('div');
    body.style.flex = '1';
    body.style.minWidth = '0';
    
    const name = document.createElement('h4');
    name.style.cssText = 'margin:0 0 2px; font-size:16px; font-weight:850; color:#1a1a1a; letter-spacing:-0.01em;';
    name.textContent = providerData.providerName || 'Anbieter';
    body.appendChild(name);
    
    const status = document.createElement('div');
    status.style.cssText = 'font-size:13px; font-weight:600; color:#64748b;';
    if(hasOfferToday){
      const offer = offersToday[0];
      status.textContent = offer.dish || 'Heute im Angebot';
      status.style.color = 'var(--brand2)';
    } else {
      status.textContent = 'Heute kein Angebot';
    }
    body.appendChild(status);
    card.appendChild(body);
    
    const pillars = document.createElement('div');
    pillars.className = 'card-pillars';
    pillars.style.marginTop = '0';
    
    const orderingEnabled = providerData.orderingEnabled !== false && (offersToday.length > 0 && offersToday.some(o => normalizeOffer(o).hasPickupCode));
    const hasDineIn = providerData.dineInPossible !== false || (offersToday.length > 0 && offersToday.some(o => normalizeOffer(o).dineInPossible));
    const hasReuse = providerData.reuse && providerData.reuse.enabled;
    
    pillars.innerHTML = `
      <div class="pillar-mini ${hasDineIn ? 'active' : ''}" style="width:24px; height:24px;">🍴</div>
      <div class="pillar-mini ${orderingEnabled ? 'active yellow' : ''}" style="width:24px; height:24px;">🧾</div>
      <div class="pillar-mini ${hasReuse ? 'active green' : ''}" style="width:24px; height:24px;">🔄</div>
    `;
    card.appendChild(pillars);
    
    card.onclick = () => {
      showProviderProfilePublic(providerData.providerId);
    };
    
    return card;
  }

  function genPickupCode(){
    return generatePickupCode();
  }

  function renderOrders(){
    // Orders aus localStorage laden
    orders = loadOrders();
    
    const box = document.getElementById('ordersList');
    const emptyEl = document.getElementById('ordersEmptyState');
    const filters = document.getElementById('ordersFilters');
    if(!box) return;
    if(filters){
      filters.innerHTML='';
      [
        {id:'offen', label:'Offen'},
        {id:'abgeholt', label:'Abgeholt'},
        {id:'alle', label:'Alle'}
      ].forEach(f=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='cust-chip'+(ordersFilter===f.id?' active':'');
        b.textContent=f.label;
        b.onclick=()=>{ ordersFilter=f.id; renderOrders(); };
        filters.appendChild(b);
      });
    }
    if(!orders.length){
      if(emptyEl) emptyEl.style.display='flex';
      box.style.display='none';
      box.innerHTML='';
      return;
    }
    const fmt = (ts)=>{
      const d = new Date(ts);
      if(Number.isNaN(d.getTime())) return '';
      return fmtDay(d);
    };
    const list = orders.filter(o=>{
      if(ordersFilter==='alle') return true;
      // Map status for filter matching
      const status = o.status || 'offen';
      if(ordersFilter === 'offen'){
        // Show PAID orders (not picked up)
        return status === 'PAID';
      }
      if(ordersFilter === 'abgeholt'){
        // Show PICKED_UP or COMPLETED orders
        return status === 'PICKED_UP' || status === 'COMPLETED' || o.pickupStatus === 'PICKED_UP';
      }
      return status === ordersFilter;
    });
    list.sort((a,b)=>{
      if(ordersFilter === 'alle'){
        const sa = a.status || 'offen';
        const sb = b.status || 'offen';
        // Sortierung: PAID > PAYMENT_PENDING > CREATED > andere
        const priority = { 'PAID': 1, 'PAYMENT_PENDING': 2, 'CREATED': 3, 'offen': 4 };
        const pa = priority[sa] || 5;
        const pb = priority[sb] || 5;
        if(pa !== pb) return pa - pb;
      }
      return (b.createdAt||0) - (a.createdAt||0);
    });
    if(!list.length){
      if(emptyEl) emptyEl.style.display='none';
      box.style.display='block';
      box.innerHTML='';
      box.textContent = 'Keine passenden Bestellungen.';
      box.className = 'hint';
      box.style.padding = '24px';
      box.style.textAlign = 'center';
      return;
    }
    if(emptyEl) emptyEl.style.display='none';
    box.style.display='block';
    box.className = '';
    box.style.padding = '';
    box.style.textAlign = '';
    box.innerHTML = list.map(o=>{
      // Status-Anzeige
      const status = o.status || 'offen';
      // Check for PICKED_UP status (from pickupStatus field or status)
      // Single source of truth: Order record
      const isPickedUp = status === 'PICKED_UP' || status === 'COMPLETED' || o.pickupStatus === 'PICKED_UP' || status === 'abgeholt';
      const statusLabel = isPickedUp ? 'Abgeholt ✅' :
                         status === 'CREATED' ? 'Erstellt' :
                         status === 'PAYMENT_PENDING' ? 'Zahlung ausstehend' :
                         status === 'PAID' ? 'Bezahlt' :
                         status === 'CANCELLED' ? 'Abgebrochen' :
                         status;
      const isDone = isPickedUp;
      const code = o.pickupCode || o.code || '';
      // Code nur anzeigen wenn PAID (Guard)
      const showCode = status === 'PAID' && code;
      
      return `
      <div class="order-item ${isDone ? 'done' : ''}">
        <div class="order-top">
          <div>
            <div style="font-weight:900">${esc(o.providerName || 'Anbieter')}</div>
            <div class="hint">${esc(o.dishName || o.summary || '')}</div>
          </div>
          <div class="order-right">
            ${showCode ? `<button class="order-code" type="button" data-id="${esc(o.id||'')}" data-code="${esc(code)}">${esc(code)}</button>` : ''}
            <div class="status-pill ${isDone ? 'done' : 'open'}">${esc(statusLabel)}</div>
          </div>
        </div>
        <div class="hint" style="margin-top:6px;">
          ${o.total ? `Gesamt: ${euro(o.totalCents ? (o.totalCents / 100) : (o.total || 0))} · ` : ''}${o.etaTime ? `Abholzeit: ${esc(o.etaTime)} · ` : ''}${fmt(o.createdAt)}
        </div>
      </div>
    `;
    }).join('');

    box.querySelectorAll('.order-code').forEach(btn=>{
      btn.onclick=()=> {
        const orderId = btn.getAttribute('data-id') || '';
        showPickupCode(orderId); // Öffnet Abholnummer-Sheet (quick-ticket)
      };
    });
  }

  function openCodeSheet(orderId){
    const order = getOrderById(orderId) || (typeof orders !== 'undefined' && orders ? orders.find(o=>o.id===orderId) : null);
    if(!order) return;
    openCodeSheetWithOrder(order);
  }
  function closeCodeSheet(){
    document.getElementById('codeBd').classList.remove('active');
    document.getElementById('codeSheet').classList.remove('active');
    activeOrderId = null;
  }

  /** Bestelldetail-Sheet: Zeigt Gericht, Anbieter, Datum, Status; bei PAID/PICKED_UP zusätzlich Abholnummer. */
  function showOrderDetail(orderId){
    const order = getOrderById(orderId);
    if(!order){
      showToast('Bestellung nicht gefunden');
      return;
    }
    const dateStr = order.pickupDate || (order.createdAt ? new Date(order.createdAt).toLocaleDateString('de-DE') : '–');
    const statusText = order.status === 'PICKED_UP' || order.status === 'abgeholt' ? 'Abgeholt' : (order.status === 'PAID' ? 'Bezahlt' : order.status || '–');
    const content = document.getElementById('orderDetailContent');
    if(content){
      content.innerHTML = `
        <div><span style="color:#64748b;">Gericht</span><br><strong>${esc(order.dishName || order.summary || 'Bestellung')}</strong></div>
        <div><span style="color:#64748b;">Anbieter</span><br><strong>${esc(order.providerName || 'Anbieter')}</strong></div>
        <div><span style="color:#64748b;">Datum</span><br><strong>${esc(dateStr)}</strong></div>
        <div><span style="color:#64748b;">Status</span><br><strong>${esc(statusText)}</strong></div>
      `;
    }
    const block = document.getElementById('orderDetailAbholnummerBlock');
    const codeEl = document.getElementById('orderDetailCode');
    const btnShowCode = document.getElementById('btnOrderDetailShowCode');
    const isPaidOrPickedUp = order.status === 'PAID' || order.status === 'PICKED_UP' || order.status === 'abgeholt';
    if(block){
      if(isPaidOrPickedUp && (order.pickupCode || order.code)){
        block.style.display = 'block';
        if(codeEl) codeEl.textContent = order.pickupCode || order.code || '–';
        if(btnShowCode){
          btnShowCode.onclick = function(){ closeOrderDetailSheet(); openCodeSheetWithOrder(order); };
        }
      } else {
        block.style.display = 'none';
      }
    }
    document.getElementById('orderDetailBd').classList.add('active');
    document.getElementById('orderDetailSheet').classList.add('active');
  }

  function closeOrderDetailSheet(){
    document.getElementById('orderDetailBd').classList.remove('active');
    document.getElementById('orderDetailSheet').classList.remove('active');
  }

  // --- Offer sheet ---
  let activeOfferId=null;
  let activeProviderOfferId=null;
  // Navigation History für Back-Button
  let navigationHistory = [];
  
  function openOffer(id){
    const raw = offers.find(x=>x.id===id);
    if(!raw) return;
    const o = normalizeOffer(raw);
    const offerProvider = offers.find(p => p.providerId === o.providerId);
    const orderingEnabled = !!(offerProvider && (offerProvider.orderingEnabled !== false && (o.hasPickupCode || offerProvider.hasPickupCode)));
    activeOfferId = id;
    
    // UI Elements
    const sImg = document.getElementById('sImg');
    const sDish = document.getElementById('sDish');
    const sImgPlaceholder = document.getElementById('sImgPlaceholder');
    const sFavoriteBtn = document.getElementById('sFavoriteBtn');
    const sThreePillars = document.getElementById('sThreePillars');
    const sProviderAddress = document.getElementById('sProviderAddress');
    const sDistanceInfo = document.getElementById('sDistanceInfo');
    const sAllergensCodes = document.getElementById('sAllergensCodes');
    const btnCTA = document.getElementById('btnPrimaryCTA');
    const primaryCTAText = document.getElementById('btnPrimaryCTAText');
    const sInfoHint = document.getElementById('sInfoHint');
    const statusBadgeEl = document.getElementById('sStatusBadge');
    const badgesEl = document.getElementById('sBadges');
    const infoRowEl = document.getElementById('sInfoRow');
    const addressFullEl = document.getElementById('sAddressFull');
    const aw = document.getElementById('sAllergensWrap');
    const sAllergens = document.getElementById('sAllergens');
    const ew = document.getElementById('sExtrasWrap');
    const rw = document.getElementById('sReuseWrap');
    const ecoBadgeEl = document.getElementById('sEcoBadge');
    const btnOpenRoute = document.getElementById('btnOpenRoute');
    
    // Foto-Handling
    if(sImg){
      sImg.src = o.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
      sImg.style.display = 'block';
      sImg.onerror = () => { if(sImgPlaceholder) sImgPlaceholder.style.display = 'flex'; sImg.style.display = 'none'; };
      sImg.onload = () => { if(sImgPlaceholder) sImgPlaceholder.style.display = 'none'; };
    }
    
    if(sDish) sDish.textContent = o.dish || '';
    const sPriceSticker = document.getElementById('sPriceSticker');
    if(sPriceSticker) sPriceSticker.textContent = euro(o.price);

    // Klick auf Anbieter-Name -> Öffnet öffentliches Profil
    const sProviderNameBtn = document.getElementById('sProviderNameBtn');
    if(sProviderNameBtn){
      sProviderNameBtn.onclick = () => {
        closeSheet();
        showProviderProfilePublic(o.providerId);
      };
    }
    
    // Favorite State
    const favorites = JSON.parse(localStorage.getItem('mittagio_favorites') || '[]');
    const isFav = favorites.includes(id);
    const heartIcon = sFavoriteBtn ? sFavoriteBtn.querySelector('i[data-lucide="heart"]') : null;
    if(heartIcon){
      heartIcon.style.fill = isFav ? '#e74c3c' : 'none';
      heartIcon.style.color = '#e74c3c';
    }
    if(sFavoriteBtn){
      sFavoriteBtn.onclick = (e) => {
        e.stopPropagation();
        toggleFavorite(id, sFavoriteBtn);
      };
    }

    // 5 Icons + ⓘ (wie Inseratsflow): Vor Ort, Mehrweg, Zeit, Allergene, Extras, Legende [cite: 2026-02-16]
    if(sThreePillars){
      const hasReuse = !!(offerProvider && (offerProvider.reuseEnabled || offerProvider.reuse || (offerProvider.providerProfile && offerProvider.providerProfile.reuseEnabled)));
      const hasDineIn = !!(offerProvider && (offerProvider.dineInPossible !== false));
      const hasTime = !!(o.pickupWindow && String(o.pickupWindow).trim());
      const hasAllergens = !!(o.allergens && o.allergens.length);
      const hasExtras = !!(o.extras && o.extras.length);
      function addDetailPillar(emo, title, active, onClick){
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'detail-pillar-btn' + (active ? ' active' : '');
        btn.setAttribute('aria-label', title);
        btn.title = title;
        btn.textContent = emo;
        if(onClick) btn.onclick = function(e){ e.stopPropagation(); if(typeof hapticLight === 'function') hapticLight(); else if(navigator.vibrate) navigator.vibrate(10); onClick(); };
        sThreePillars.appendChild(btn);
      }
      addDetailPillar('🍴', 'Vor Ort', hasDineIn, null);
      addDetailPillar('🔄', 'Mehrweg', hasReuse, null);
      addDetailPillar('🕒', 'Zeitfenster', hasTime, null);
      addDetailPillar('🌾', 'Allergene', hasAllergens, function(){ if(typeof showAllergensOverlay === 'function') showAllergensOverlay(); });
      addDetailPillar('➕', 'Extras', hasExtras, function(){
        if(!(o.extras && o.extras.length)){ if(typeof showToast === 'function') showToast('Keine Extras'); return; }
        if(typeof showExtrasDetailOverlay === 'function') showExtrasDetailOverlay();
      });
      const legendBtn = document.createElement('button');
      legendBtn.type = 'button';
      legendBtn.className = 'detail-legend-btn';
      legendBtn.setAttribute('aria-label', 'Infos zu den Symbolen');
      legendBtn.title = '🍴 Vor Ort · 🔄 Mehrweg · 🕒 Zeit · 🌾 Allergene · ➕ Extras';
      legendBtn.textContent = 'ⓘ';
      legendBtn.onclick = function(e){ e.stopPropagation(); if(typeof hapticLight === 'function') hapticLight(); if(typeof showToast === 'function') showToast('🍴 Vor Ort · 🔄 Mehrweg · 🕒 Zeit · 🌾 Allergene · ➕ Extras'); };
      sThreePillars.appendChild(legendBtn);
    }

    // Sticky Bottom CTA: Mittagio-Gelb und Text "Mittagsbox"
    if(btnCTA){
      btnCTA.style.background = '#FFD700';
      btnCTA.style.color = '#1a1a1a';
      btnCTA.style.border = 'none';
      btnCTA.style.fontWeight = '900';
      btnCTA.style.boxShadow = '0 8px 24px rgba(255,215,0,0.25)';
      if(primaryCTAText) primaryCTAText.textContent = 'In die Mittagsbox legen';
    }

    const addr = buildAddress({address:o.address, street:o.providerStreet, zip:o.providerZip, city:o.providerCity});
    if(sProviderAddress) sProviderAddress.textContent = addr || 'Adresse nicht verfügbar';

    // Google Maps Buttons
    if(sDistanceInfo && o.distanceKm != null){
      sDistanceInfo.style.display = 'flex';
      const walk = Math.round(o.distanceKm * 12);
      const car = Math.round(o.distanceKm * 1.5);
      sDistanceInfo.innerHTML = `
        <button onclick="openGoogleMapsRoute('${o.providerId}')" style="flex:1; height:44px; border-radius:12px; border:none; background:#fff; font-size:13px; font-weight:700; color:#1a1a1a; display:flex; align-items:center; justify-content:center; gap:6px; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
          🚶 ${walk} Min.
        </button>
        <button onclick="openGoogleMapsRoute('${o.providerId}')" style="flex:1; height:44px; border-radius:12px; border:none; background:#fff; font-size:13px; font-weight:700; color:#1a1a1a; display:flex; align-items:center; justify-content:center; gap:6px; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
          🚗 ${car} Min.
        </button>
      `;
    }

    // Status Badge
    if(statusBadgeEl){
      if(orderingEnabled){
        statusBadgeEl.innerHTML = '<span style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px; background:rgba(39,174,96,0.12); border-radius:8px; color:#27AE60; font-size:13px; font-weight:700; border:1px solid rgba(39,174,96,0.2);">⚡ Nur mit Abholnummer</span>';
      } else {
        statusBadgeEl.innerHTML = '<span style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px; background:rgba(100,116,139,0.1); border-radius:8px; color:#64748b; font-size:13px; font-weight:600; border:1px solid rgba(100,116,139,0.2);">👁️ Nur Info</span>';
      }
    }

    // Badges Row
    if(badgesEl){
      badgesEl.innerHTML = '';
      const badges = [];
      const hasReuseSupport = !!(offerProvider && (offerProvider.reuseEnabled || offerProvider.reuse || (offerProvider.providerProfile && offerProvider.providerProfile.reuseEnabled)));
      if(hasReuseSupport) badges.push({class:'eco', text:'Mehrweg möglich', icon:'leaf'});
      if(orderingEnabled) badges.push({class:'code', text:'Abholnummer', icon:'hash'});
      if(!orderingEnabled) badges.push({class:'pickup', text:'Zum Mitnehmen', icon:'shopping-bag'});
      
      badges.slice(0, 3).forEach(badge => {
        const badgeEl = document.createElement('span');
        badgeEl.className = `card-status-badge ${badge.class}`;
        if(badge.class === 'eco'){
          badgeEl.style.background = 'rgba(39,174,96,0.1)';
          badgeEl.style.color = '#27AE60';
          badgeEl.style.border = '1px solid rgba(39,174,96,0.2)';
          badgeEl.innerHTML = `<img src="assets/icon-mehrweg.png" alt="Mehrweg" class="concept-icon" style="width:16px;height:16px; margin-right:4px;"><span>${esc(badge.text)}</span>`;
        } else if(badge.class === 'code'){
          badgeEl.innerHTML = `<img src="assets/icon-abholnummer.png" alt="Abholnummer" class="concept-icon" style="width:16px;height:16px; margin-right:4px;"> <span>${esc(badge.text)}</span>`;
        } else {
          badgeEl.innerHTML = `<i data-lucide="${badge.icon}" style="width:14px;height:14px;"></i> <span>${esc(badge.text)}</span>`;
        }
        badgesEl.appendChild(badgeEl);
      });
    }
    
    // Info Row
    if(infoRowEl){
      infoRowEl.innerHTML = '';
      if(o.pickupWindow){
        const day = o.day ? new Date(o.day) : new Date();
        const dateStr = fmtDateWithTime(day, o.pickupWindow);
        const timeEl = document.createElement('div');
        timeEl.style.display = 'flex';
        timeEl.style.alignItems = 'center';
        timeEl.style.gap = '6px';
        timeEl.innerHTML = `${iconMarkup('clock')} <span>${esc(dateStr)}</span>`;
        infoRowEl.appendChild(timeEl);
      }
      const foodTypeIcon = o.category === 'Vegan' ? 'leaf' : 
                           o.category === 'Vegetarisch' ? 'carrot' : 
                           o.category === 'Fisch' ? 'fish' :
                           o.category === 'Mit Fleisch' ? 'drumstick' : '';
      if(foodTypeIcon){
        const foodEl = document.createElement('div');
        foodEl.innerHTML = iconMarkup(foodTypeIcon);
        infoRowEl.appendChild(foodEl);
      }
    }
    
    // Address Full
    if(addressFullEl){
      const fullAddr = [o.providerName, o.providerStreet, o.providerZip, o.providerCity].filter(Boolean).join(', ');
      addressFullEl.textContent = fullAddr || addr || '-';
    }
    
    // Allergene
    if(aw){
      if(o.allergens && o.allergens.length){
        aw.style.display = 'flex';
        const r = o.allergens.map(a => String(a||'').trim());
        const codes = [];
        r.forEach(v => {
          const u = v.toUpperCase();
          if(ALLERGENE_STANDARD[u]){ codes.push(u); return; }
          const nk = Object.keys(ALLERGENE_NAME_TO_CODE).find(k => k.toLowerCase() === v.toLowerCase());
          const c = nk ? ALLERGENE_NAME_TO_CODE[nk] : null;
          if(c && ALLERGENE_STANDARD[c]) codes.push(c);
        });
        const seen = {};
        const uniq = codes.filter(c => { if(seen[c]) return false; seen[c]=1; return true; });
        if(sAllergensCodes) sAllergensCodes.textContent = uniq.length ? uniq.join(', ') : '–';
        if(sAllergens){
          const list = uniq.map(c => {
            const label = ALLERGENE_STANDARD[c];
            const word = typeof allergenFirstWord === 'function' ? allergenFirstWord(label) : String(label||'').trim().split(/\s+/)[0];
            return `<div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
              <i data-lucide="shield-alert" style="width:16px;height:16px;color:rgba(255,255,255,0.7);flex-shrink:0;"></i>
              <span style="font-weight:700; color:rgba(255,255,255,0.9);">${esc(c)}</span>
              <span style="color:rgba(255,255,255,0.75); font-size:12px;">${esc(word)}</span>
            </div>`;
          }).join('');
          sAllergens.innerHTML = list || '';
        }
      } else {
        aw.style.display = 'flex';
        if(sAllergensCodes) sAllergensCodes.textContent = '–';
      }
    }

    // Extras
    if(ew){
      if(o.extras && o.extras.length){
        ew.style.display='block';
        const sx = document.getElementById('sExtras');
        if(sx) sx.textContent = o.extras.map(e=>`${e.name} (+${euro(e.price)})`).join(' · ');
      } else ew.style.display='none';
    }

    // Reuse
    if(rw){
      if(o.reuse && o.reuse.enabled){
        rw.style.display='block';
        const sr = document.getElementById('sReuse');
        if(sr) sr.textContent = `Pfand ${euro(o.reuse.deposit)}`;
      } else rw.style.display='none';
    }

    // Eco-Badge
    if(ecoBadgeEl){
      const hasReuseSupport = !!(offerProvider && (offerProvider.reuseEnabled || offerProvider.reuse || (offerProvider.providerProfile && offerProvider.providerProfile.reuseEnabled)));
      ecoBadgeEl.style.display = hasReuseSupport ? 'block' : 'none';
      if(hasReuseSupport){
        ecoBadgeEl.innerHTML = `<div style="padding:8px 12px; background:rgba(39,174,96,0.1); border-radius:8px; font-size:13px; font-weight:700; color:#27AE60; display:inline-flex; align-items:center; gap:6px; border:1px solid rgba(39,174,96,0.2);"><img src="assets/icon-mehrweg.png" alt="Mehrweg" class="concept-icon"> <span>Mehrweg möglich</span></div>`;
      }
    }

    // CTA Button Logic
    if(btnCTA && primaryCTAText){
      btnCTA.disabled = false;
      btnCTA.className = 'btn-primary';
      btnCTA.classList.remove('loading', 'success');
      
      const isActive = o.active !== false;
      const isToday = o.day === isoDate(new Date());
      const isAvailable = isActive && isToday;
      
      if(!isAvailable){
        btnCTA.disabled = true;
        primaryCTAText.textContent = !isActive ? 'Angebot nicht verfügbar' : 'Angebot nicht mehr verfügbar';
        btnCTA.onclick = null;
      } else if(orderingEnabled){
        primaryCTAText.textContent = 'In die Mittagsbox legen';
        if(sInfoHint) sInfoHint.style.display = 'none';
        btnCTA.onclick = () => {
          btnCTA.disabled = true;
          btnCTA.classList.add('loading');
          primaryCTAText.textContent = 'Wird hinzugefügt...';
          
          // Auto-Favorite
          const favs = JSON.parse(localStorage.getItem('mittagio_favorites') || '[]');
          if(!favs.includes(o.id)){
            favs.push(o.id);
            localStorage.setItem('mittagio_favorites', JSON.stringify(favs));
            dishFavs.add(o.id);
            save(LS.dishFavs, Array.from(dishFavs));
            if(heartIcon) heartIcon.style.fill = '#e74c3c';
          }
          
          flyThumbnailToMittagsbox(sImg, () => {
            if(addToCart(o)){
              triggerCartIconGlow();
              btnCTA.classList.remove('loading');
              btnCTA.classList.add('success');
              primaryCTAText.textContent = 'Erfolgreich!';
              showToast('Gericht hinzugefügt!');
              updateHeaderBasket();
              setTimeout(() => {
                showCart();
                setTimeout(() => {
                  btnCTA.disabled = false;
                  btnCTA.classList.remove('success');
                  primaryCTAText.textContent = 'In die Mittagsbox legen';
                }, 500);
              }, 300);
            } else {
              btnCTA.disabled = false;
              btnCTA.classList.remove('loading');
              primaryCTAText.textContent = 'In die Mittagsbox legen';
              showToast('Fehler beim Hinzufügen.');
            }
          });
        };
      } else {
        primaryCTAText.textContent = 'In die Mittagsbox legen';
        if(sInfoHint){
          sInfoHint.textContent = 'Anbieter nimmt nicht an Abholnummer teil';
          sInfoHint.style.display = 'block';
        }
        btnCTA.onclick = () => {
          const favs = JSON.parse(localStorage.getItem('mittagio_favorites') || '[]');
          if(!favs.includes(o.id)){
            favs.push(o.id);
            localStorage.setItem('mittagio_favorites', JSON.stringify(favs));
            dishFavs.add(o.id);
            save(LS.dishFavs, Array.from(dishFavs));
            if(heartIcon) heartIcon.style.fill = '#e74c3c';
          }
          const currentCount = parseInt(localStorage.getItem(`provider_${o.providerId}_requests`) || '0', 10);
          localStorage.setItem(`provider_${o.providerId}_requests`, String(currentCount + 1));
          triggerHapticFeedback([10, 20]);
          btnCTA.disabled = true;
          btnCTA.classList.add('success');
          primaryCTAText.textContent = 'Vielen Dank! ✓';
          showToast('Anfrage übermittelt.');
          setTimeout(() => {
            btnCTA.disabled = false;
            btnCTA.classList.remove('success');
            primaryCTAText.textContent = 'In die Mittagsbox legen';
          }, 2000);
        };
      }
    }

    // Allergene Overlay
    window.showAllergensOverlay = function(){
      const ov = document.createElement('div');
      ov.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; display:flex; align-items:center; justify-content:center; padding:20px;';
      ov.onclick = (e) => { if(e.target === ov) ov.remove(); };
      
      const content = document.createElement('div');
      content.style.cssText = 'background:linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); border-radius:24px; padding:24px; max-width:420px; width:100%; border:2px solid rgba(255,255,255,0.1); box-shadow:0 8px 32px rgba(0,0,0,0.5); max-height:90vh; overflow:hidden; display:flex; flex-direction:column;';
      content.onclick = (e) => e.stopPropagation();
      
      const codes = (o.allergens || []).map(a => {
        const u = String(a).toUpperCase();
        if(ALLERGENE_STANDARD[u]) return u;
        const nk = Object.keys(ALLERGENE_NAME_TO_CODE).find(k => k.toLowerCase() === String(a).toLowerCase());
        return nk ? ALLERGENE_NAME_TO_CODE[nk] : null;
      }).filter(Boolean);
      const uniq = [...new Set(codes)];
      
      const listHtml = uniq.map(c => {
        const label = ALLERGENE_STANDARD[c];
        const word = typeof allergenFirstWord === 'function' ? allergenFirstWord(label) : String(label||'').trim().split(/\s+/)[0];
        return `<div style="display:flex; align-items:center; gap:10px; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.1);">
          <i data-lucide="shield-alert" style="width:20px;height:20px;color:rgba(255,255,255,0.8);flex-shrink:0;"></i>
          <span style="color:rgba(255,255,255,0.9); font-weight:700; font-size:14px; flex-shrink:0;">${esc(c)}</span>
          <span style="color:rgba(255,255,255,0.85); font-size:14px;">${esc(word)}</span>
        </div>`;
      }).join('');
      
      content.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; flex-shrink:0;">
          <h3 style="color:#fff; font-size:20px; font-weight:900; margin:0;">Allergene</h3>
          <button type="button" onclick="this.closest('[style*=\\'position:fixed\\']').remove();" style="background:none; border:none; color:#fff; cursor:pointer;"><i data-lucide="x"></i></button>
        </div>
        <div style="max-height:280px; overflow-y:auto; flex:1;">
          ${listHtml || '<p style="color:rgba(255,255,255,0.5);">Keine Allergene hinterlegt.</p>'}
        </div>
      `;
      ov.appendChild(content);
      document.body.appendChild(ov);
      if(typeof lucide !== 'undefined') lucide.createIcons();
    };
    window.showExtrasDetailOverlay = function(){
      const ov = document.createElement('div');
      ov.className = 'extras-detail-overlay';
      ov.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; display:flex; align-items:center; justify-content:center; padding:20px;';
      ov.onclick = function(e){ if(e.target === ov) ov.remove(); };
      const list = (o.extras || []).map(function(e){ return (e.name || '') + (e.price ? ' (+' + (typeof euro === 'function' ? euro(e.price) : e.price + ' €') + ')' : ''); }).filter(Boolean);
      const content = document.createElement('div');
      content.style.cssText = 'background:linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); border-radius:24px; padding:24px; max-width:420px; width:100%; border:2px solid rgba(255,255,255,0.1); box-shadow:0 8px 32px rgba(0,0,0,0.5);';
      content.onclick = function(e){ e.stopPropagation(); };
      content.innerHTML = '<div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;"><h3 style="color:#fff; font-size:20px; font-weight:900; margin:0;">Extras</h3><button type="button" class="extras-overlay-close" style="background:none; border:none; color:#fff; cursor:pointer;"><i data-lucide="x"></i></button></div><div style="color:rgba(255,255,255,0.9); font-size:14px;">' + (list.length ? list.map(function(t){ return '<div style="padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.1);">' + (typeof esc === 'function' ? esc(t) : t) + '</div>'; }).join('') : '<p style="color:rgba(255,255,255,0.5);">Keine Extras.</p>') + '</div>';
      var closeBtn = content.querySelector('.extras-overlay-close');
      if(closeBtn) closeBtn.onclick = function(){ ov.remove(); };
      ov.appendChild(content);
      document.body.appendChild(ov);
      if(typeof lucide !== 'undefined') lucide.createIcons();
    };

    // Route Button
    if(btnOpenRoute){
      if(!o.hasPickupCode){
        btnOpenRoute.style.display = 'block';
        btnOpenRoute.onclick = () => {
          const routeMaps = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
          window.open(routeMaps, '_blank');
        };
      } else {
        btnOpenRoute.style.display = 'none';
      }
    }

    updateSheetFavs();
    document.getElementById('bd').classList.add('active');
    document.getElementById('sheet').classList.add('active');
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }

  function updateSheetFavs(){
    const providerBtn = document.getElementById('btnFav');
    const dishBtn = document.getElementById('btnDishFav');
    if(!activeOfferId){
      if(providerBtn) providerBtn.textContent='Anbieter speichern';
      if(dishBtn) dishBtn.textContent='Gericht speichern';
      return;
    }
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    const providerKey = o.providerId;
    const dishKey = o.id;
    if(providerBtn){
      const label = providerKey && providerFavs.has(providerKey) ? 'Anbieter entfernen' : 'Anbieter speichern';
      providerBtn.innerHTML = `${iconMarkup('heart')}<span>${esc(label)}</span>`;
    }
    if(dishBtn){
      const label = dishKey && dishFavs.has(dishKey) ? 'Von Speiseplan entfernen' : 'Auf meinen Speiseplan';
      dishBtn.innerHTML = `${iconMarkup('utensils')}<span>${esc(label)}</span>`;
    }
  }

  function closeSheet(){
    document.getElementById('bd').classList.remove('active');
    document.getElementById('sheet').classList.remove('active');
    
    // Zurück zur vorherigen Ansicht (inkl. Scroll-Position)
    if(navigationHistory.length > 0){
      const prev = navigationHistory.pop();
      locationQuery = prev.locationQuery || '';
      activeCat = prev.activeCat || null;
      activeDay = prev.activeDay || isoDate(new Date());
      activeDiscoverFilter = prev.activeFilter || 'near';
      
      if(prev.view === 'start'){
        showStart();
      } else {
        showDiscover();
      }
      
      // Scroll-Position wiederherstellen
      if(prev.scrollY !== undefined){
        setTimeout(()=>{
          window.scrollTo({top: prev.scrollY, behavior: 'auto'});
        }, 100);
      }
    }
  }
  
  // --- Match-Screen (nach Rechts-Swipe) ---
  let currentMatchOffer = null;
  
  function showMatchModal(offer){
    if(!offer) return;
    const matchBd = document.getElementById('matchBd');
    const matchSheet = document.getElementById('matchSheet');
    if(!matchBd || !matchSheet) return; // Match-Modal (Swipe) entfernt
    currentMatchOffer = offer;
    const data = normalizeOffer(offer);
    
    matchBd.classList.add('active');
    matchSheet.classList.add('active');
    
    // Daten füllen
    const dishImageEl = document.getElementById('matchDishImage');
    const dishNameEl = document.getElementById('matchDishName');
    const providerNameEl = document.getElementById('matchProviderName');
    const distanceEl = document.getElementById('matchDistance');
    const fastWegEl = document.getElementById('matchFastWeg');
    
    if(dishImageEl){
      const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
      dishImageEl.innerHTML = `<img src="${esc(imgSrc)}" alt="${esc(data.dish||'')}" style="width:100%; height:100%; object-fit:cover;" />`;
    }
    if(dishNameEl) dishNameEl.textContent = data.dish || 'Gericht';
    if(providerNameEl) providerNameEl.textContent = data.providerName || 'Anbieter';
    if(distanceEl){
      const distance = data.distanceKm != null ? `${Math.round(data.distanceKm * 1000)}m` : '';
      distanceEl.textContent = distance ? `Nur ${distance} von dir entfernt` : 'In deiner Nähe';
    }
    
    // Fast weg Badge (wenn ausverkauft oder fast ausverkauft)
    if(fastWegEl){
      // No-Limits: Keine "Fast weg" Logik mehr - Status wird über active gesteuert
      fastWegEl.style.display = 'none';
    }
    
    // Konfetti-Animation
    triggerMatchConfetti();
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(() => lucide.createIcons(), 50);
    }
  }
  
  function closeMatchModal(){
    const matchBd = document.getElementById('matchBd');
    const matchSheet = document.getElementById('matchSheet');
    if(matchBd) matchBd.classList.remove('active');
    if(matchSheet) matchSheet.classList.remove('active');
    currentMatchOffer = null;
  }
  
  function triggerMatchConfetti(){
    const canvas = document.getElementById('matchConfetti');
    if(!canvas) return;
    
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    
    const particles = [];
    const colors = ['#FFD700', '#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1'];
    
    for(let i = 0; i < 50; i++){
      particles.push({
        x: canvas.width / 2,
        y: canvas.height / 2,
        vx: (Math.random() - 0.5) * 10,
        vy: (Math.random() - 0.5) * 10 - 5,
        color: colors[Math.floor(Math.random() * colors.length)],
        size: Math.random() * 6 + 4,
        life: 1
      });
    }
    
    function animate(){
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      particles.forEach((p, i) => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.2; // Gravity
        p.life -= 0.02;
        
        if(p.life > 0){
          ctx.globalAlpha = p.life;
          ctx.fillStyle = p.color;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
          ctx.fill();
        } else {
          particles.splice(i, 1);
        }
      });
      
      if(particles.length > 0){
        requestAnimationFrame(animate);
      }
    }
    animate();
  }
  
  // Match Modal Handlers
  const btnMatchReserve = document.getElementById('btnMatchReserve');
  if(btnMatchReserve){
    btnMatchReserve.onclick = () => {
      if(currentMatchOffer){
        closeMatchModal();
        // Direkt zum Checkout
        const data = normalizeOffer(currentMatchOffer);
        if(data.hasPickupCode){
          handleOrderClick(currentMatchOffer);
        } else {
          openOffer(currentMatchOffer.id);
        }
      }
    };
  }
  
  const btnMatchLater = document.getElementById('btnMatchLater');
  if(btnMatchLater){
    btnMatchLater.onclick = () => {
      if(currentMatchOffer){
        // Zu Favoriten hinzufügen
        toggleDishFav(currentMatchOffer.id);
        closeMatchModal();
        showToast('Gericht zur Mittagsbox hinzugefügt');
      }
    };
  }
  
  // Backdrop Handler
  const matchBd = document.getElementById('matchBd');
  if(matchBd){
    matchBd.onclick = () => {
      closeMatchModal();
    };
  }

  // Android Hardware-Back unterstützen
  window.addEventListener('popstate', function(e){
    // AGB Onboarding Modal schließen
    if(document.getElementById('agbOnboardingSheet') && document.getElementById('agbOnboardingSheet').classList.contains('active')){
      closeAgbOnboardingModal();
      e.preventDefault();
      return;
    }
    // Pickup Confirmation Sheet schließen
    if(document.getElementById('pickupConfirmSheet') && document.getElementById('pickupConfirmSheet').classList.contains('active')){
      closePickupConfirmSheet();
      e.preventDefault();
      pushViewState(null, location.pathname);
      return;
    }
    // Create Flow Sheet schließen
    if(document.getElementById('createFlowSheet') && document.getElementById('createFlowSheet').classList.contains('active')){
      closeCreateFlowSheet();
      e.preventDefault();
      pushViewState(null, location.pathname);
      return;
    }
    // FAQ Sheet schließen
    if(document.getElementById('faqSheet') && document.getElementById('faqSheet').classList.contains('active')){
      closeFaqSheet();
      e.preventDefault();
      pushViewState(null, location.pathname);
      return;
    }
    // Login Modal schließen
    if(document.getElementById('loginSheet') && document.getElementById('loginSheet').classList.contains('active')){
      closeLoginSheet();
      e.preventDefault();
      pushViewState(null, location.pathname);
      return;
    }
    // Provider Login Modal schließen
    if(document.getElementById('providerLoginSheet') && document.getElementById('providerLoginSheet').style.display !== 'none'){
      closeProviderLoginModal();
      e.preventDefault();
      pushViewState(null, location.pathname);
      return;
    }
    // Wizard schließen
    if(document.getElementById('wizard') && document.getElementById('wizard').classList.contains('active')){
      closeWizard();
      e.preventDefault();
      pushViewState(null, location.pathname);
      return;
    }
    // Sheet schließen
    if(document.getElementById('sheet') && document.getElementById('sheet').classList.contains('active')){
      closeSheet();
      e.preventDefault();
      pushViewState(null, location.pathname);
      return;
    }
    // Onboarding back navigation
    const currentView = document.querySelector('.view.active');
    if(currentView && currentView.id.startsWith('v-provider-onboarding')){
      if(currentView.id === 'v-provider-onboarding-preview'){
        showOnboardingBusiness();
        e.preventDefault();
        pushViewState(null, location.pathname);
        return;
      } else if(currentView.id === 'v-provider-onboarding-business'){
        showOnboardingSignup();
        e.preventDefault();
        pushViewState(null, location.pathname);
        return;
      } else if(currentView.id === 'v-provider-onboarding-signup'){
        showOnboardingFirstDish(!!onboardingDraftDish);
        e.preventDefault();
        pushViewState(null, location.pathname);
        return;
      } else if(currentView.id === 'v-provider-onboarding-first-dish'){
        showOnboardingEntry(!!onboardingDraftDish);
        e.preventDefault();
        pushViewState(null, location.pathname);
        return;
      } else if(currentView.id === 'v-provider-onboarding-entry'){
        // Animation für 3-Punkt-Erklärung
        setTimeout(() => {
          const points = document.querySelectorAll('#onboardingExplanationPoints .onboarding-point');
          points.forEach((point, index) => {
            setTimeout(() => {
              point.style.opacity = '1';
              point.style.transform = 'translateY(0)';
            }, index * 200);
          });
          // Icons aktualisieren
          if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 100);
        }, 100);
        // Exit onboarding, go to login or customer mode
        if(provider.loggedIn){
          showProviderHome();
        } else {
          setMode('customer');
          showProfile();
        }
        e.preventDefault();
        pushViewState(null, location.pathname);
        return;
      }
    }
    
    // In-App Navigation: Zurück zu vorheriger View innerhalb der App
    // Prüfe ob wir in einer Customer-View sind
    if(currentView){
      const viewId = currentView.id;
      if(viewId === 'v-fav'){
        showDiscover();
        e.preventDefault();
        return;
      } else if(viewId === 'v-cart'){
        showDiscover();
        e.preventDefault();
        return;
      } else if(viewId === 'v-orders'){
        showProfile();
        e.preventDefault();
        return;
      } else if(viewId === 'v-profile'){
        showDiscover();
        e.preventDefault();
        return;
      } else if(viewId === 'v-discover'){
        showStart();
        e.preventDefault();
        return;
      } else if(viewId === 'v-start'){
        // Bleib auf Start oder gehe zu Discover
        showStart();
        e.preventDefault();
        return;
      }
    }
    
    // Provider Views
    if(mode === 'provider'){
      const providerView = currentView ? currentView.id : '';
      if(providerView === 'v-provider-profile'){
        showProviderHome();
        e.preventDefault();
        return;
      } else if(providerView === 'v-provider-pickups'){
        showProviderHome();
        e.preventDefault();
        return;
      } else if(providerView === 'v-provider-cookbook'){
        showProviderHome();
        e.preventDefault();
        return;
      } else if(providerView === 'v-provider-billing'){
        showProviderProfile();
        e.preventDefault();
        return;
      }
    }
  });

  function openProviderOffer(id){
    var idStr = String(id);
    var raw = offers.find(x=>String(x.id)===idStr);
    if(!raw){
      var fresh = load(LS.offers, []);
      raw = fresh.find(x=>String(x.id)===idStr);
      if(!raw){
        if(typeof showToast === 'function') showToast('Gericht konnte nicht geladen werden.');
        return;
      }
    }
    const o = normalizeOffer(raw);
    activeProviderOfferId = raw.id;
    const profile = normalizeProviderProfile(provider.profile || {});
    const offerProvider = offers.find(p => p.providerId === o.providerId);
    const hasReuse = offerProvider && (offerProvider.reuseEnabled || offerProvider.reuse || (offerProvider.providerProfile && offerProvider.providerProfile.reuseEnabled));
    const imgSrc = o.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    const hasDineIn = o.dineInPossible !== false;
    const hasTimeValue = !!(o.pickupWindow && String(o.pickupWindow).trim());
    const hasAllergens = !!(o.allergens && o.allergens.length);
    const hasExtras = !!(o.extras && o.extras.length);
    const priceStr = (Number(o.price)||0).toFixed(2).replace('.',',');
    const catLabel = (o.category && CAT_EMOJI[o.category]) ? (CAT_EMOJI[o.category] + ' ' + (o.category || '')) : (o.category || '');
    const pill = (active, label, emo, dataIcon) => '<button type="button" class="status-pill ' + (active ? 'active' : 'inactive') + '" title="' + esc(label) + '" aria-label="' + esc(label) + '" data-psheet-icon="' + esc(dataIcon) + '"><span style="font-size:18px;">' + emo + '</span></button>';
    const funcBtn = (active, title, emo, dataIcon) => '<button type="button" class="func-icon-btn ' + (active ? 'active' : '') + '" title="' + esc(title) + '" aria-label="' + esc(title) + '" data-psheet-icon="' + esc(dataIcon) + '">' + emo + '</button>';
    const cardState = typeof getCardState === 'function' ? getCardState(o) : (o.active !== false && o.day === (typeof isoDate === 'function' ? isoDate(new Date()) : '') ? 'LIVE' : 'PLANNED');
    const stateLabel = typeof getCardStateLabel === 'function' ? getCardStateLabel(cardState) : (cardState === 'LIVE' ? 'Live' : 'Geplant');
    const powerBarHtml = '<div class="inserat-power-bar inserat-unified-pills psheet-power-bar">' +
      pill(hasDineIn, 'Vor Ort', '🍴', 'dinein') +
      pill(hasReuse, 'Mehrweg', '🔄', 'reuse') +
      pill(hasTimeValue, 'Zeit', '🕒', 'time') +
      funcBtn(hasAllergens, 'Allergene', '🌾', 'allergens') +
      funcBtn(hasExtras, 'Extras', '➕', 'extras') +
      '<button type="button" class="power-bar-legend-trigger" id="psheetInfoTrigger" title="Symbole &amp; Drucken" aria-label="Legende" data-psheet-icon="legend">ⓘ</button>' +
      '</div>';
    const preview = document.getElementById('pPreview');
    preview.innerHTML = '<div class="universal-dish-card psheet-card" data-card-state="' + esc(cardState) + '" data-offer-id="' + esc(String(raw.id)) + '" role="button" tabindex="0" aria-label="Karte bearbeiten oder long-press für Ausverkauft">' +
      '<div class="inserat-photo-tile photo-header psheet-photo-header psheet-card-click-area" style="position:relative;overflow:hidden;flex-shrink:0;width:100%;background:#f0f0f0;">' +
      (cardState === 'LIVE' ? '<div class="psheet-state-badge card-state-badge card-state-live">' + esc(stateLabel) + '</div>' : (cardState === 'PLANNED' ? '<div class="psheet-state-badge card-state-badge card-state-planned">' + esc(stateLabel) + '</div>' : '')) +
      '<button type="button" class="psheet-share-on-image" id="psheetShareOnImage" aria-label="Teilen" title="Teilen">📤</button>' +
      '<img src="' + esc(imgSrc) + '" alt="' + esc(o.dish||'') + '" style="width:100%;height:100%;object-fit:cover;display:block;" />' +
      '</div>' +
      powerBarHtml +
      '<div class="psheet-card-body">' +
      '<div class="psheet-card-title-row">' +
      '<div class="psheet-card-title-wrap">' +
      '<input type="text" class="psheet-card-title dish-title-input" id="psheetTitleInput" value="' + esc(o.dish || '') + '" placeholder="Gerichtname" maxlength="80" />' +
      (catLabel ? '<span class="psheet-category-pill category-pill">' + esc(catLabel) + '</span>' : '') +
      '</div>' +
      '<button type="button" class="psheet-price-btn price-button-yellow" id="psheetPriceBtn" aria-label="Preis">' + priceStr + ' €</button>' +
      '</div>' +
      '</div>' +
      '</div>';
    var cardEl = preview.querySelector('.universal-dish-card.psheet-card');
    var psheetLongPressFired = false;
    preview.querySelectorAll('.psheet-card-click-area').forEach(function(el){
      el.style.cursor = 'pointer';
      el.addEventListener('click', function(ev){
        if(ev.target.closest('.psheet-share-on-image')) return;
        if(psheetLongPressFired){ ev.preventDefault(); ev.stopPropagation(); return; }
        ev.preventDefault();
        ev.stopPropagation();
        if(typeof hapticLight === 'function') hapticLight(); else if(navigator.vibrate) navigator.vibrate(10);
        closeProviderSheet();
        startListingFlow({ editOfferId: raw.id });
      });
    });
    var shareOnImage = document.getElementById('psheetShareOnImage');
    if(shareOnImage){
      shareOnImage.addEventListener('click', function(ev){
        ev.preventDefault();
        ev.stopPropagation();
        if(typeof hapticLight === 'function') hapticLight();
        var offer = offers.find(x=>x.id===raw.id);
        if(offer){
          if(cardEl && typeof shareCardAsImage === 'function') shareCardAsImage(cardEl, offer);
          else if(typeof shareOffer === 'function') shareOffer(offer);
        }
      });
    }
    var infoTrigger = document.getElementById('psheetInfoTrigger');
    if(infoTrigger){
      infoTrigger.addEventListener('click', function(ev){
        ev.preventDefault();
        ev.stopPropagation();
        try { if(typeof hapticLight === 'function') hapticLight(); else if(navigator.vibrate) navigator.vibrate(10); } catch(e){}
        var pop = document.getElementById('psheetLegendPopover');
        if(pop) pop.style.display = 'block';
      });
    }
    function enterPsheetEditMode(){
      if(!cardEl) return;
      cardEl.classList.add('psheet-edit-mode');
      try { if(navigator.vibrate) navigator.vibrate(10); if(typeof hapticLight === 'function') hapticLight(); } catch(e){}
    }
    function updatePsheetDecisionZone(){
      var zone = document.getElementById('psheetDecisionZone');
      var btnGreen = document.getElementById('btnPsheetMitAbholnummer');
      var btnYellow = document.getElementById('btnPsheetNurInserat');
      if(!zone || !btnGreen || !btnYellow) return;
      var dish = (raw.dish || raw.title || '').trim();
      var priceOk = (Number(raw.price) || 0) > 0;
      var isComplete = dish.length > 0 && priceOk;
      btnGreen.classList.toggle('psheet-incomplete', !isComplete);
      btnYellow.classList.toggle('psheet-incomplete', !isComplete);
      btnGreen.classList.toggle('psheet-ready', isComplete);
    }
    var titleInput = document.getElementById('psheetTitleInput');
    var categoryPill = preview.querySelector('.category-pill');
    if(titleInput){
      titleInput.addEventListener('focus', function(){ enterPsheetEditMode(); try { if(navigator.vibrate) navigator.vibrate(10); } catch(e){} });
      titleInput.addEventListener('input', function(){
        raw.dish = titleInput.value.trim(); raw.title = raw.dish;
        if(typeof save === 'function' && typeof LS !== 'undefined') save(LS.offers, offers);
        if(categoryPill){ categoryPill.classList.remove('jiggle'); void categoryPill.offsetWidth; categoryPill.classList.add('jiggle'); setTimeout(function(){ categoryPill.classList.remove('jiggle'); }, 150); }
        if(priceBtn){ priceBtn.classList.remove('jiggle'); void priceBtn.offsetWidth; priceBtn.classList.add('jiggle'); setTimeout(function(){ priceBtn.classList.remove('jiggle'); }, 150); }
        updatePsheetDecisionZone();
      });
      titleInput.addEventListener('blur', function(){ raw.dish = titleInput.value.trim(); raw.title = raw.dish; if(typeof save === 'function' && typeof LS !== 'undefined') save(LS.offers, offers); updatePsheetDecisionZone(); });
      titleInput.addEventListener('keydown', function(ev){ if(ev.key === 'Enter'){ ev.preventDefault(); titleInput.blur(); } });
    }
    /* Icon-Leiste: Bounce + Edit-Modus + Event für Header-Morphing */
    preview.querySelectorAll('.psheet-power-bar [data-psheet-icon]').forEach(function(btn){
      btn.addEventListener('click', function(ev){
        ev.preventDefault();
        ev.stopPropagation();
        var icon = btn.getAttribute('data-psheet-icon');
        if(icon && icon !== 'legend'){
          btn.classList.add('psheet-pill-bounce');
          setTimeout(function(){ btn.classList.remove('psheet-pill-bounce'); }, 500);
          enterPsheetEditMode();
          try { window.dispatchEvent(new CustomEvent('psheet-icon-tap', { detail: { icon: icon, offerId: raw.id } })); } catch(e){}
        }
      });
    });
    var priceBtn = document.getElementById('psheetPriceBtn');
    if(priceBtn){
      priceBtn.addEventListener('click', function(ev){
        ev.preventDefault();
        ev.stopPropagation();
        enterPsheetEditMode();
        var overlay = document.getElementById('psheetPriceOverlay');
        var input = document.getElementById('psheetPriceInput');
        if(overlay && input){
          input.value = (Number(raw.price)||0).toFixed(2).replace('.',',');
          overlay.style.display = 'flex';
          setTimeout(function(){ input.focus(); }, 100);
        }
      });
    }
    var priceOverlay = document.getElementById('psheetPriceOverlay');
    var priceInput = document.getElementById('psheetPriceInput');
    var priceOverlayClose = document.getElementById('psheetPriceOverlayClose');
    if(priceOverlay && priceInput && priceOverlayClose){
      priceOverlay.querySelector('.psheet-price-overlay-backdrop').addEventListener('click', function(){ priceOverlay.style.display = 'none'; });
      priceOverlayClose.addEventListener('click', function(){
        var val = priceInput.value.replace(',','.').replace(/[^\d.-]/g,'');
        var num = parseFloat(val) || 0;
        raw.price = Math.max(0, num);
        if(typeof save === 'function' && typeof LS !== 'undefined') save(LS.offers, offers);
        if(priceBtn) priceBtn.textContent = (raw.price).toFixed(2).replace('.',',') + ' €';
        priceOverlay.style.display = 'none';
        updatePsheetDecisionZone();
      });
    }
    updatePsheetDecisionZone();
    var btnGreen = document.getElementById('btnPsheetMitAbholnummer');
    var btnYellow = document.getElementById('btnPsheetNurInserat');
    function doPsheetSave(withPickup){
      raw.hasPickupCode = !!withPickup;
      if(typeof save === 'function' && typeof LS !== 'undefined') save(LS.offers, offers);
      if(typeof showToast === 'function') showToast(withPickup ? 'Mit Abholnummer gespeichert' : 'Inserat gespeichert');
      closeProviderSheet();
      if(typeof renderProviderHome === 'function') renderProviderHome();
    }
    function doPsheetSaveAndCookbook(withPickup){
      var cbId = raw.cookbookId;
      if(cbId && Array.isArray(cookbook)){
        var ent = cookbook.find(function(c){ return String(c.id) === String(cbId); });
        if(ent){ ent.dish = (raw.dish || raw.title || ent.dish || '').trim(); ent.title = ent.dish; if(raw.price != null) ent.price = raw.price; if(typeof save === 'function' && typeof LS !== 'undefined') save(LS.cookbook, cookbook); }
      }
      doPsheetSave(withPickup);
    }
    function maybeShowSaveScope(withPickup){
      if(raw.cookbookId && typeof showSaveScopeDialog === 'function'){
        showSaveScopeDialog({ onlyCurrent: function(){ doPsheetSave(withPickup); }, saveToCookbook: function(){ doPsheetSaveAndCookbook(withPickup); } });
      } else {
        doPsheetSave(withPickup);
      }
    }
    if(btnGreen){
      btnGreen.addEventListener('click', function(ev){
        ev.preventDefault();
        if(btnGreen.classList.contains('psheet-incomplete')) return;
        try { if(navigator.vibrate) navigator.vibrate(20); if(typeof hapticLight === 'function') hapticLight(); } catch(e){}
        maybeShowSaveScope(true);
      });
    }
    if(btnYellow){
      btnYellow.addEventListener('click', function(ev){
        ev.preventDefault();
        if(btnYellow.classList.contains('psheet-incomplete')) return;
        try { if(navigator.vibrate) navigator.vibrate(20); if(typeof hapticLight === 'function') hapticLight(); } catch(e){}
        maybeShowSaveScope(false);
      });
    }
    var closeX = document.getElementById('psheetCloseX');
    if(closeX){
      closeX.addEventListener('click', function(ev){
        ev.preventDefault();
        ev.stopPropagation();
        if(closeX.classList.contains('exit-active')) return;
        try { if(navigator.vibrate) navigator.vibrate(20); } catch(e){}
        if(titleInput) titleInput.blur();
        closeX.classList.add('exit-active');
        setTimeout(function(){ closeProviderSheet(); }, 300);
      });
    }
    var longPressTimer;
    function startLongPress(){ longPressTimer = setTimeout(function(){ psheetLongPressFired = true; if(typeof hapticLight === 'function') hapticLight(); toggleOfferSoldOut(raw.id); closeProviderSheet(); }, 500); }
    function cancelLongPress(){ if(longPressTimer){ clearTimeout(longPressTimer); longPressTimer = null; } }
    if(cardEl){
      cardEl.addEventListener('touchstart', function(ev){ if(ev.touches.length===1) startLongPress(); }, { passive: true });
      cardEl.addEventListener('touchend', cancelLongPress, { passive: true });
      cardEl.addEventListener('touchcancel', cancelLongPress, { passive: true });
      cardEl.addEventListener('mousedown', function(ev){ if(ev.button===0) startLongPress(); });
      cardEl.addEventListener('mouseup', cancelLongPress);
      cardEl.addEventListener('mouseleave', cancelLongPress);
    }

    var pbd = document.getElementById('pbd');
    var psheetEl = document.getElementById('psheet');
    if(pbd) pbd.classList.add('active');
    if(psheetEl) psheetEl.classList.add('active');
  }
  if(typeof window !== 'undefined') window.openProviderOffer = openProviderOffer;

  /* Dashboard-Karten: Klick in Capture-Phase abfangen, damit die Detailseite zuverlässig öffnet (auch bei Touch/Overlay) */
  (function(){
    if(document._providerCardCapture) return;
    document._providerCardCapture = true;
    document.addEventListener('click', function(ev){
      if(!document.body.classList.contains('provider-mode')) return;
      var list = document.getElementById('providerActiveListings');
      if(!list || !list.contains(ev.target)) return;
      var card = ev.target.closest && ev.target.closest('.prov-card[data-offer-id]');
      if(!card) return;
      var id = card.getAttribute('data-offer-id');
      if(!id) return;
      ev.preventDefault();
      ev.stopPropagation();
      try { if(typeof hapticLight === 'function') hapticLight(); else if(navigator.vibrate) navigator.vibrate(10); } catch(e){}
      if(typeof window.openProviderOffer === 'function') window.openProviderOffer(id);
    }, true);
  })();

  function closeProviderSheet(){
    var pop = document.getElementById('psheetLegendPopover');
    if(pop) pop.style.display = 'none';
    document.getElementById('pbd').classList.remove('active');
    document.getElementById('psheet').classList.remove('active');
  }

  var _saveScopeCallbacks = null;
  function showSaveScopeDialog(opts){
    if(!opts || (typeof opts.onlyCurrent !== 'function' && typeof opts.saveToCookbook !== 'function')) return;
    _saveScopeCallbacks = opts;
    var bd = document.getElementById('saveScopeBackdrop');
    var sheet = document.getElementById('saveScopeSheet');
    if(bd) bd.style.display = 'block';
    if(sheet) sheet.style.display = 'block';
    try { if(navigator.vibrate) navigator.vibrate(10); if(typeof hapticLight === 'function') hapticLight(); } catch(e){}
  }
  function closeSaveScopeDialog(){
    _saveScopeCallbacks = null;
    var bd = document.getElementById('saveScopeBackdrop');
    var sheet = document.getElementById('saveScopeSheet');
    if(bd) bd.style.display = 'none';
    if(sheet) sheet.style.display = 'none';
  }
  (function(){
    var bd = document.getElementById('saveScopeBackdrop');
    var sheet = document.getElementById('saveScopeSheet');
    var btnOnly = document.getElementById('saveScopeOnlyCurrent');
    var btnCookbook = document.getElementById('saveScopeToCookbook');
    var btnCancel = document.getElementById('saveScopeCancel');
    if(bd) bd.addEventListener('click', closeSaveScopeDialog);
    if(btnOnly) btnOnly.addEventListener('click', function(){ if(_saveScopeCallbacks && typeof _saveScopeCallbacks.onlyCurrent === 'function'){ _saveScopeCallbacks.onlyCurrent(); } closeSaveScopeDialog(); try { if(navigator.vibrate) navigator.vibrate(20); } catch(e){} });
    if(btnCookbook) btnCookbook.addEventListener('click', function(){ if(_saveScopeCallbacks && typeof _saveScopeCallbacks.saveToCookbook === 'function'){ _saveScopeCallbacks.saveToCookbook(); } closeSaveScopeDialog(); try { if(navigator.vibrate) navigator.vibrate(20); } catch(e){} });
    if(btnCancel) btnCancel.addEventListener('click', closeSaveScopeDialog);
  })();
  if(typeof window !== 'undefined'){ window.showSaveScopeDialog = showSaveScopeDialog; window.closeSaveScopeDialog = closeSaveScopeDialog; }

  function buildShareText(o){
    const dish = o.dish || o.title || 'Gericht';
    const profile = normalizeProviderProfile(provider.profile || {});
    const providerName = o.providerName || profile.name || 'Anbieter';
    const pickup = o.pickupWindow || profile.mealWindow || '—';
    return `${providerName}\nHeute zu Mittag: ${dish}\n${euro(o.price)}\n${pickup}\nPowered by Mittagio`;
  }

  function setPrintView(html){
    const pv = document.getElementById('printView');
    if(!pv) return;
    pv.innerHTML = html;
  }
  function clearPrintView(){
    const pv = document.getElementById('printView');
    if(!pv) return;
    pv.innerHTML = '';
  }
  window.addEventListener('afterprint', clearPrintView);

  function printHtml(html){
    setPrintView(html);
    window.print();
    setTimeout(clearPrintView, 300);
  }

  function buildOfferPrintHtml(o){
    const data = normalizeOffer(o);
    const profile = normalizeProviderProfile(provider.profile || {});
    const name = data.providerName || profile.name || 'Anbieter';
    const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity}) || buildAddress(profile);
    const badges = [];
    const offerProvider = offers.find(p => p.providerId === data.providerId);
    const orderingEnabled = offerProvider && (offerProvider.orderingEnabled !== false && (data.hasPickupCode || offerProvider.hasPickupCode));
    if(orderingEnabled) badges.push('Abholnummer');
    return `
      <div class="print-card">
        <div style="display:flex;align-items:center;gap:12px;">
          ${profile.logoData ? `<img src="${profile.logoData}" alt="Logo" style="width:56px;height:56px;border-radius:12px;object-fit:cover" />` : ''}
          <div>
            <h1>${esc(name)}</h1>
            <div class="print-muted">${esc(addr || '')}</div>
          </div>
        </div>
        <h2>${esc(data.dish || 'Gericht')}</h2>
        <div class="print-row">
          <div><b>Preis:</b> ${euro(data.price || 0)}</div>
          <div><b>Essenszeit:</b> ${esc(data.pickupWindow || profile.mealWindow || '')}</div>
        </div>
        <div style="margin-top:8px;">
          ${badges.map(b=>`<span class="print-badge">${esc(b)}</span>`).join(' ')}
        </div>
      </div>
    `;
  }

  function buildWeekCardHtml(){
    const profile = normalizeProviderProfile(provider.profile || {});
    const days = [];
    for(let i=0;i<5;i++){
      const d = new Date(); d.setDate(d.getDate()+i);
      days.push(isoDate(d));
    }
    const dayBlocks = days.map(key=>{
      const items = (week[key]||[])
        .filter(x=>x.providerId===providerId() && x.active !== false)
        .map(entry=>{
          const cb = cookbook.find(c => String(c.id) === String(entry.cookbookId));
          const name = cb?.dish || entry.dish || 'Gericht';
          const price = cb?.price || 0;
          const windowText = cb?.pickupWindow || profile.mealWindow || '';
          return `
            <div class="print-row">
              <div>
                <div>${esc(name)}</div>
                <div class="print-muted">${esc(windowText)}</div>
              </div>
              <div>${euro(price)}</div>
            </div>
          `;
        });
      const label = key ? fmtDay(new Date(key)) : key;
      return `
        <div class="print-card">
          <h2>${esc(label)}</h2>
          ${items.length ? items.join('') : '<div class="print-muted">Keine Gerichte geplant.</div>'}
        </div>
      `;
    }).join('');

    return `
      <div class="print-card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <div>
            <h1>${esc(profile.name || 'Anbieter')}</h1>
            <div class="print-muted">${esc(buildAddress(profile) || '')}</div>
            <div class="print-muted">Essenszeit: ${esc(profile.mealWindow || '')}</div>
            <div class="print-muted" style="margin-top:6px;"><b>Unsere Gerichte – nächste Tage</b></div>
          </div>
          ${profile.logoData ? `<img src="${profile.logoData}" alt="Logo" style="width:72px;height:72px;border-radius:14px;object-fit:cover" />` : ''}
        </div>
      </div>
      <div class="print-grid">
        ${dayBlocks}
      </div>
      <div class="print-card" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div>
          <div style="font-weight:900">Mittagio</div>
          <div class="print-muted">Dein Mittag. Lokal. Frisch. Digital.</div>
        </div>
        <div style="text-align:center;">
          <div class="pickup-code-display">Abholnummer</div>
          <div class="print-muted">Ein Tap genügt</div>
        </div>
      </div>
    `;
  }

  function printOffer(o){
    if(!o) return;
    printHtml(buildOfferPrintHtml(o));
  }

  function printCookbookEntry(entry){
    if(!entry) return;
    const profile = normalizeProviderProfile(provider.profile || {});
    const offer = normalizeOffer({
      dish: entry.dish,
      category: entry.category,
      price: entry.price,
      pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
      providerName: profile.name || provider.email || 'Anbieter',
      providerStreet: profile.street||'',
      providerZip: profile.zip||'',
      providerCity: profile.city||'',
      providerLogoData: profile.logoData||'',
      hasPickupCode: !!entry.hasPickupCode,
      dineInPossible: !!entry.dineInPossible,
      allergens: entry.allergens||[],
      extras: entry.extras||[],
      reuse: entry.reuse||{enabled:false,deposit:0}
    });
    printHtml(buildOfferPrintHtml(offer));
  }

  function printWeekCard(){
    printHtml(buildWeekCardHtml());
  }

  // Share Payload für Offer Details
  let sharePayload = { subject: '', body: '', url: '' };
  
  function openShareSheet(subject, body, url=location.href, subtitle=''){
    sharePayload = { subject, body, url };
    
    // Dynamischen Untertitel setzen
    const subtitleEl = document.getElementById('shareSheetSubtitle');
    if(subtitleEl){
      subtitleEl.textContent = subtitle || 'Empfiehl dieses Mittagsangebot weiter';
    }
    
    document.getElementById('shareBd').classList.add('active');
    document.getElementById('shareSheet').classList.add('active');
  }

  function closeShareSheet(){
    document.getElementById('shareBd').classList.remove('active');
    document.getElementById('shareSheet').classList.remove('active');
  }
  
  function getSuccessFactForRenner(c, allOrders){
    var wd = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'];
    if(c.lastUsed && !Number.isNaN(new Date(c.lastUsed).getTime())){
      var d = new Date(c.lastUsed);
      return 'Zuletzt am ' + d.getDate() + '.' + String(d.getMonth()+1).padStart(2,'0') + ' erfolgreich angeboten';
    }
    if(allOrders && allOrders.length){
      var byDay = {};
      allOrders.forEach(function(o){
        var day = o.day || (o.createdAt ? (typeof isoDate === 'function' ? isoDate(new Date(o.createdAt)) : '') : '');
        if(!day) return;
        var match = (o.dishId && String(o.dishId)===String(c.id)) || (o.dish && String((o.dish||'').trim())===String((c.dish||'').trim()));
        if(match) byDay[day] = (byDay[day]||0) + 1;
      });
      var bestDay = '';
      var best = 0;
      for(var k in byDay){ if(byDay[k]>best){ best=byDay[k]; bestDay=k; } }
      if(bestDay){
        var d = new Date(bestDay+'T12:00:00');
        if(!Number.isNaN(d.getTime())) return 'Top-Seller am ' + wd[d.getDay()];
      }
    }
    return 'Im Kochbuch';
  }

  function populateCreateFlowRenner(){
    var scroll = document.getElementById('createFlowRennerScroll');
    var emptyEl = document.getElementById('createFlowRennerEmpty');
    if(!scroll) return;
    var pid = typeof providerId === 'function' ? providerId() : '';
    var mine = (cookbook||[]).filter(function(c){ return String(c.providerId)===String(pid); });
    var allOrders = typeof loadOrders === 'function' ? loadOrders() : [];
    mine.sort(function(a,b){
      var au = a.lastUsed || 0, bu = b.lastUsed || 0;
      if(bu!==au) return bu-au;
      return (b.dish||'').localeCompare(a.dish||'');
    });
    var topGerichte = mine.slice(0, 10);
    scroll.innerHTML = '';
    if(emptyEl) emptyEl.style.display = topGerichte.length ? 'none' : 'block';
    topGerichte.forEach(function(c){
      var card = document.createElement('div');
      card.className = 'renner-card';
      var imgUrl = c.photoData || 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=200&q=60';
      var hasAbhol = !!(c.hasPickupCode !== undefined ? c.hasPickupCode : true);
      var hasMehrweg = !!(c.reuse && c.reuse.enabled);
      var icons = '<span title="Vor Ort">🍴</span>';
      if(hasAbhol) icons += '<span title="Abholnummer">🧾</span>';
      if(hasMehrweg) icons += '<span title="Mehrweg">🔄</span>';
      var fact = getSuccessFactForRenner(c, allOrders);
      card.innerHTML = '<img class="renner-card-img" src="'+(typeof esc==='function'?esc(imgUrl):String(imgUrl).replace(/"/g,'&quot;'))+'" alt=""><div class="renner-card-icons">'+icons+'</div><div class="renner-card-body"><div class="renner-card-name">'+(typeof esc==='function'?esc(c.dish||'Gericht'):String(c.dish||'Gericht').replace(/</g,'&lt;'))+'</div><div class="renner-card-fact">'+fact+'</div><button type="button" class="renner-card-btn">Heute anbieten</button></div>';
      var btn = card.querySelector('.renner-card-btn');
      if(btn) btn.onclick = function(e){ e.stopPropagation(); if(typeof haptic==='function') haptic(8); closeCreateFlowSheet(); startListingFlow({ dishId: c.id, date: createFlowPreselectedDate || (typeof isoDate==='function'?isoDate(new Date()):''), entryPoint: 'dashboard' }); };
      card.onclick = function(e){ if(e.target===btn || btn.contains(e.target)) return; if(typeof haptic==='function') haptic(8); closeCreateFlowSheet(); startListingFlow({ dishId: c.id, date: createFlowPreselectedDate || (typeof isoDate==='function'?isoDate(new Date()):''), entryPoint: 'dashboard' }); };
      scroll.appendChild(card);
    });
  }

  function openCreateFlowSheet(){
    if(typeof haptic === 'function') haptic(10);
    const sheet = document.getElementById('createFlowSheet');
    const hint = document.getElementById('createFlowDateHint');

    if(sheet && hint){
      if(createFlowPreselectedDate){
        const d = new Date(createFlowPreselectedDate);
        const weekday = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'][d.getDay()];
        const dateStr = d.getDate() + '.' + String(d.getMonth()+1).padStart(2,'0') + '.';
        hint.innerHTML = '<i data-lucide="calendar" style="width:16px;height:16px;color:#64748b;flex-shrink:0;"></i><span>Für ' + weekday + ', ' + dateStr + '</span>';
        hint.style.display = 'inline-flex';
        if(typeof lucide !== 'undefined') setTimeout(function(){ lucide.createIcons(); }, 50);
      } else {
        hint.style.display = 'none';
      }

      populateCreateFlowRenner();

      document.getElementById('createFlowBd').classList.add('active');
      sheet.classList.add('active');
      if(typeof lucide !== 'undefined') setTimeout(function(){ lucide.createIcons(); }, 50);
    }
  }
  
  function closeCreateFlowSheet(){
    document.getElementById('createFlowBd').classList.remove('active');
    document.getElementById('createFlowSheet').classList.remove('active');
    createFlowPreselectedDate = null;
    createFlowOriginView = 'dashboard';
  }
  
  // Create Flow Handlers - Beide öffnen Master-Flow
  const btnCreateFromCookbook = document.getElementById('btnCreateFromCookbook');
  if(btnCreateFromCookbook){
    btnCreateFromCookbook.onclick = () => {
      closeCreateFlowSheet();
      // Navigate to cookbook - user selects entry there, then "Inserieren" opens Master-Flow
      showProviderCookbook();
    };
  }
  
  const btnCreateNewDish = document.getElementById('btnCreateNewDish');
  if(btnCreateNewDish){
    btnCreateNewDish.onclick = () => {
      const date = createFlowPreselectedDate;
      const ep = createFlowOriginView || 'dashboard';
      closeCreateFlowSheet();
      openDishFlow(date, ep);
    };
  }
  
  // Offer More Menu
  function openOfferMoreMenu(offerId){
    const offer = offers.find(o => o.id === offerId);
    if(!offer) return;
    
    const actions = [
      {label: 'Bearbeiten', action: () => {
        closeCreateFlowSheet(); // Falls offen
        startListingFlow({editOfferId: offerId});
      }},
      {label: 'Duplizieren', action: () => {
        const newOffer = {...offer, id: cryptoId(), createdAt: Date.now()};
        offers.unshift(newOffer);
        save(LS.offers, offers);
        renderProviderHome();
        renderDiscover();
        showToast('Inserat dupliziert');
      }},
      {label: 'Pausieren', action: () => {
        offer.active = false;
        save(LS.offers, offers);
        renderProviderHome();
        renderDiscover();
        showToast('Inserat pausiert');
      }},
      {label: 'Löschen', action: () => {
        if(confirm('Inserat wirklich löschen?')){
          const idx = offers.findIndex(o => o.id === offerId);
          if(idx >= 0){
            offers.splice(idx, 1);
            save(LS.offers, offers);
            renderProviderHome();
            renderDiscover();
            showToast('Inserat gelöscht');
          }
        }
      }}
    ];
    
    // Simple prompt-based menu (später kann ein Sheet verwendet werden)
    const choice = prompt(`Aktion für "${offer.dish || offer.title}":\n1. Bearbeiten\n2. Duplizieren\n3. Pausieren\n4. Löschen\n\nNummer eingeben:`);
    const idx = parseInt(choice) - 1;
    if(idx >= 0 && idx < actions.length){
      actions[idx].action();
    }
  }
  
  // Toast helper
  function showToast(message){
    // Simple snackbar-style toast
    let toast = document.getElementById('toast');
    if(!toast){
      toast = document.createElement('div');
      toast.id = 'toast';
      toast.style.cssText = 'position:fixed; bottom:90px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.85); color:#fff; padding:12px 20px; border-radius:12px; font-size:14px; z-index:100; opacity:0; transition:opacity .3s; pointer-events:none;';
      document.body.appendChild(toast);
    }
    toast.textContent = message;
    toast.style.opacity = '1';
    setTimeout(() => {
      toast.style.opacity = '0';
    }, 3000);
  }
  /** High-End Error: Haptik 100ms, optional Shake am Element, Toast am oberen Rand (mattes Orange). */
  function showSoftError(message, element){
    try { if(navigator.vibrate) navigator.vibrate(100); else if(typeof haptic === 'function') haptic(100); } catch(e){}
    if(element && element.classList){ element.classList.add('shake-horizontal'); setTimeout(function(){ element.classList.remove('shake-horizontal'); }, 300); }
    var el = document.getElementById('toastSoftError');
    if(!el){
      el = document.createElement('div');
      el.id = 'toastSoftError';
      el.className = 'toast-soft-error';
      el.style.cssText = 'position:fixed; top:calc(60px + env(safe-area-inset-top)); left:16px; right:16px; background:#FF9500; color:#fff; padding:14px 18px; border-radius:14px; font-size:14px; font-weight:600; z-index:1100; opacity:0; transition:opacity .25s; pointer-events:none; text-align:center; box-shadow:0 4px 20px rgba(255,149,0,0.35);';
      document.body.appendChild(el);
    }
    el.textContent = message || 'Etwas ist schiefgelaufen.';
    el.style.opacity = '1';
    setTimeout(function(){ el.style.opacity = '0'; }, 3500);
  }

  async function copyShareLink(){
    const url = sharePayload.url || location.href;
    if(navigator.clipboard && navigator.clipboard.writeText){
      try{ 
        await navigator.clipboard.writeText(url);
        if(typeof showToast === 'function') showToast('Link kopiert!');
        else alert('Link kopiert!');
        return true;
      }catch{}
    }
    prompt('Link kopieren:', url);
    return false;
  }
  
  function shareViaWhatsApp(subject, body, url){
    const text = `${subject}\n\n${body}\n\n👉 Jetzt anschauen:\n${url}`;
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
    window.open(whatsappUrl, '_blank');
  }
  
  function shareViaInstagram(subject, body, url){
    // Instagram unterstützt keine direkten Share-Links, daher Link kopieren + Hinweis
    const text = `${subject}\n\n${body}\n\n👉 Jetzt anschauen:\n${url}`;
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).then(() => {
        showToast('Text kopiert! Füge ihn in deinen Instagram-Post ein.');
      }).catch(() => {
        prompt('Text für Instagram kopieren:', text);
      });
    } else {
      prompt('Text für Instagram kopieren:', text);
    }
  }

  /** Karten-Layout als Bild für Social Media (Instagram/WhatsApp) teilen. Fallback: shareOffer. */
  function shareCardAsImage(cardEl, fallbackOffer){
    if(!cardEl || typeof html2canvas !== 'function'){
      if(fallbackOffer && typeof shareOffer === 'function') shareOffer(fallbackOffer);
      return;
    }
    html2canvas(cardEl, { scale: 2, useCORS: true, allowTaint: true, backgroundColor: '#ffffff', logging: false })
      .then(function(canvas){
        canvas.toBlob(function(blob){
          if(!blob){ if(fallbackOffer) shareOffer(fallbackOffer); return; }
          var file = new File([blob], 'mittagio-karte.png', { type: 'image/png' });
          if(navigator.share && navigator.canShare && navigator.canShare({ files: [file] })){
            navigator.share({ title: 'Mittagio', text: '', files: [file] })
              .then(function(){ if(typeof showToast === 'function') showToast('Bild geteilt!'); })
              .catch(function(err){ if(err.name !== 'AbortError' && fallbackOffer) shareOffer(fallbackOffer); });
          } else {
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'mittagio-karte.png';
            a.click();
            URL.revokeObjectURL(a.href);
            if(typeof showToast === 'function') showToast('Bild gespeichert – zum Teilen in Galerie öffnen');
          }
        }, 'image/png', 0.95);
      })
      .catch(function(){
        if(fallbackOffer && typeof shareOffer === 'function') shareOffer(fallbackOffer);
      });
  }

  function shareOffer(o, useWebShare = true){
    if(!o) return;
    const data = normalizeOffer(o);
    const providerName = data.providerName || 'Anbieter';
    const dishName = data.dish || 'Gericht';
    const price = euro(data.price);
    const hasAbholnummer = !!data.hasPickupCode;
    const shareUrl = typeof buildOfferShareUrl === 'function' ? buildOfferShareUrl(o) : (location.origin + (location.pathname || '') + '#offer/' + (o.id || ''));
    
    let shareText;
    if(hasAbholnummer){
      shareText = `🚀 Lust auf was Richtiges? Schau mal, was wir heute Leckeres für dich haben!\n\n📍 ${providerName}\n🍴 ${dishName} - ${price}\n\nJetzt Schlange überspringen & Abholnummer sichern:\n👉 ${shareUrl}\n\n#mittagio #lunch #heutebeius`;
    } else {
      shareText = `😋 Lust auf was Richtiges? Schau mal, was wir heute Leckeres für dich haben!\n\n📍 ${providerName}\n🍴 ${dishName} - ${price}\n\nJetzt online entdecken & vorbeikommen:\n👉 ${shareUrl}\n\n#mittagio #lunch #heutebeius`;
    }

    // Anbieter: Share-Sheet mit WhatsApp, Instagram, Link öffnen
    if(typeof getMode === 'function' && getMode() === 'provider'){
      const titleEl = document.getElementById('shareSheetTitle');
      if(titleEl) titleEl.textContent = 'Teile es mit deinen Kunden';
      const subtitleEl = document.getElementById('shareSheetSubtitle');
      if(subtitleEl) subtitleEl.textContent = 'Per WhatsApp, Instagram oder Link – deine Kunden finden das Gericht sofort.';
      openShareSheet(dishName, shareText, shareUrl, 'Per WhatsApp, Instagram oder Link – deine Kunden finden das Gericht sofort.');
      if(typeof lucide !== 'undefined') setTimeout(function(){ lucide.createIcons(); }, 50);
      return;
    }

    // Kunde: Web Share API (wenn verfügbar) oder Link kopieren
    if(navigator.share && useWebShare){
      navigator.share({
        title: dishName,
        text: shareText,
        url: shareUrl
      }).then(() => {
        showToast('Geteilt!');
      }).catch((err) => {
        if(err.name !== 'AbortError'){
          copyToClipboard(shareText);
          showToast('Link kopiert!');
        }
      });
      return;
    }
    copyToClipboard(shareText);
    showToast('Link kopiert!');
  }
  
  // Helper: Link in Zwischenablage kopieren
  function copyToClipboard(text){
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).catch(() => {
        // Fallback für ältere Browser
        fallbackCopyToClipboard(text);
      });
    } else {
      fallbackCopyToClipboard(text);
    }
  }
  
  function fallbackCopyToClipboard(text){
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
      document.execCommand('copy');
    } catch(err) {
      console.error('Fallback copy failed:', err);
    }
    document.body.removeChild(textArea);
  }
  
  // Web Share API für Kunden (Bestätigungsseite)
  function shareOrderConfirmation(order){
    if(!order) return;
    const dishName = order.dishName || 'Gericht';
    const providerName = order.providerName || 'Anbieter';
    
    if(navigator.share){
      navigator.share({
        title: 'Mein Mittagessen heute!',
        text: `Schlange stehen gespart! Hab mir gerade ${dishName} bei ${providerName} gesichert. 🍖📱 #mittagio`,
        url: location.href
      }).then(() => {
        showToast('Geteilt!');
      }).catch((err) => {
      });
    } else {
      // Fallback: Link kopieren
      const text = `Schlange stehen gespart! Hab mir gerade ${dishName} bei ${providerName} gesichert. 🍖📱 #mittagio ${location.href}`;
      navigator.clipboard.writeText(text).then(() => {
        showToast('Link kopiert!');
      });
    }
  }
  
  // Web Share API für Anbieter (Heute teilen)
  function shareProviderOffer(offer){
    if(!offer) return;
    const data = normalizeOffer(offer);
    const dishName = data.dish || 'Gericht';
    const price = euro(data.price || 0);
    const profile = normalizeProviderProfile(provider.profile || {});
    const providerName = profile.name || provider.email || 'Anbieter';
    const shareUrl = `${location.origin}${location.pathname}#offer/${offer.id}`;
    const hasAbholnummer = !!data.hasPickupCode;
    
    let shareText;
    if(hasAbholnummer){
      shareText = `🔥 Heißer Tipp für heute: ${dishName}!\n\n📍 ${providerName}\n💰 Nur ${price}\n\nSchnell sein lohnt sich – jetzt Abholnummer sichern & Warteschlange überspringen:\n👉 ${shareUrl}\n\n#mittagio #foodtip #leckeressen #heute`;
    } else {
      shareText = `🔥 Heißer Tipp für heute: ${dishName}!\n\n📍 ${providerName}\n💰 Nur ${price}\n\nJetzt online entdecken & vorbeikommen:\n👉 ${shareUrl}\n\n#mittagio #foodtip #leckeressen #heute`;
    }
    
    if(navigator.share){
      navigator.share({
        title: dishName,
        text: shareText,
        url: shareUrl
      }).then(() => {
        showToast('Geteilt!');
      }).catch((err) => {
        if(err.name !== 'AbortError'){
          copyToClipboard(shareText);
          showToast('Link kopiert!');
        }
      });
    } else {
      // Fallback: Link kopieren
      copyToClipboard(shareText);
      showToast('Link kopiert!');
    }
  }

  function addToCart(o){
    if(!o || !o.hasPickupCode){
      alert('Ohne Abholnummer nur ansehen.');
      return false;
    }
    // Multi-Vendor erlaubt (keine Warnung mehr, nur Info im Korb)
    if(!cart){ cart = { providerId:o.providerId, providerName:o.providerName, items:[], pickupTime:'' }; }
    const idx = cart.items.findIndex(i=>i.offerId===o.id);
    if(idx>=0) cart.items[idx].qty += 1; else cart.items.push({offerId:o.id, qty:1});
    save(LS.cart, cart);
    updateHeaderBasket();
    return true;
  }

  function handleOrderClick(o){
    // KEIN Login-Zwang: Gast kann direkt bestellen
    if(addToCart(o)){
      showCart();
    } else {
      openOffer(o.id);
    }
  }

  const btnFav = document.getElementById('btnFav');
  if(btnFav) btnFav.onclick=()=>{
    if(!activeOfferId) return;
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    toggleProviderFav(o.providerId);
  };
  const btnDishFav = document.getElementById('btnDishFav');
  if(btnDishFav) btnDishFav.onclick=()=>{
    if(!activeOfferId) return;
    toggleDishFav(activeOfferId);
  };
  // Share Button im Header (Offer Detail Page)
  const btnShareHeader = document.getElementById('btnShareHeader');
  if(btnShareHeader) btnShareHeader.onclick=()=>{
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    shareOffer(o);
  };
  
  const btnShare = document.getElementById('btnShare');
  if(btnShare) btnShare.onclick=()=>{
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    shareOffer(o);
  };
  
  // Share Sheet Actions
  const btnShareWhatsApp = document.getElementById('btnShareWhatsApp');
  if(btnShareWhatsApp) btnShareWhatsApp.onclick=()=>{
    shareViaWhatsApp(sharePayload.subject, sharePayload.body, sharePayload.url);
    closeShareSheet();
  };
  
  const btnShareInstagram = document.getElementById('btnShareInstagram');
  if(btnShareInstagram) btnShareInstagram.onclick=()=>{
    shareViaInstagram(sharePayload.subject, sharePayload.body, sharePayload.url);
    closeShareSheet();
  };
  
  const btnShareCopy = document.getElementById('btnShareCopy');
  if(btnShareCopy) btnShareCopy.onclick=()=>{
    copyShareLink();
    closeShareSheet();
  };
  
  const btnCodeClose = document.getElementById('btnCodeClose');
  if(btnCodeClose) btnCodeClose.onclick=()=> closeCodeSheet();
  const btnToggleOrderStatus = document.getElementById('btnToggleOrderStatus');
  if(btnToggleOrderStatus) btnToggleOrderStatus.onclick=()=>{
    if(!activeOrderId) return;
    const order = getOrderById(activeOrderId);
    if(order){
      const newStatus = order.status === 'PICKED_UP' || order.status === 'abgeholt' ? 'PAID' : 'PICKED_UP';
      updateOrder(activeOrderId, { status: newStatus, pickupCodeActivatedAt: newStatus === 'PICKED_UP' ? Date.now() : null });
      openCodeSheetWithOrder(getOrderById(activeOrderId));
      if(typeof updateProfileView === 'function') updateProfileView();
    } else if(typeof orders !== 'undefined' && orders){
      const idx = orders.findIndex(o=>o.id===activeOrderId);
      if(idx>=0){
        orders[idx].status = orders[idx].status === 'abgeholt' ? 'offen' : 'abgeholt';
        if(typeof save === 'function') save(LS.orders, orders);
        if(typeof renderOrders === 'function') renderOrders();
        openCodeSheet(activeOrderId);
      }
    }
  };
  
  // --- Login Modal ---
  function openLoginSheet(){
    document.getElementById('loginBd').classList.add('active');
    document.getElementById('loginSheet').classList.add('active');
    // Focus auf E-Mail-Input
    setTimeout(()=>{
      const emailInput = document.getElementById('loginModalEmail');
      if(emailInput) emailInput.focus();
    }, 300);
  }
  
  function closeLoginSheet(){
    document.getElementById('loginBd').classList.remove('active');
    document.getElementById('loginSheet').classList.remove('active');
  }
  
  // Login Modal Backdrop Handler
  const loginBd = document.getElementById('loginBd');
  if(loginBd){
    loginBd.onclick = () => {
      closeLoginSheet();
    };
  }
  
  // Login Modal Handler
  const btnLoginModalLogin = document.getElementById('btnLoginModalLogin');
  if(btnLoginModalLogin){
    btnLoginModalLogin.onclick=()=>{
      const email = document.getElementById('loginModalEmail').value.trim();
      const pass = document.getElementById('loginModalPass').value.trim();
      if(!email || !pass){
        alert('Bitte E-Mail und Passwort eingeben.');
        return;
      }
      customer.loggedIn = true;
      customer.name = customer.name || email.split('@')[0];
      customer.email = email;
      save(LS.customer, customer);
      updateProfileView();
      closeLoginSheet();
      // Nach Login zur Discover-Seite
      setMode('customer');
      showDiscover();
    };
  }
  
  const btnLoginModalDemo = document.getElementById('btnLoginModalDemo');
  if(btnLoginModalDemo){
    btnLoginModalDemo.onclick=()=>{
      customer.loggedIn = true;
      customer.name = customer.name || 'Mike';
      save(LS.customer, customer);
      updateProfileView();
      closeLoginSheet();
      // Nach Demo-Login zur Discover-Seite
      setMode('customer');
      showDiscover();
    };
  }

  applyStaticIcons();
  const locBtn = document.getElementById('btnLocationPin');
  if(locBtn){
    locBtn.innerHTML = iconMarkup('location');
    locBtn.onclick=()=>{
      alert('Standort gesetzt. Du kannst jederzeit wechseln.');
    };
  }
  const startLocBtn = document.getElementById('btnStartLocationPin');
  if(startLocBtn){
    startLocBtn.innerHTML = iconMarkup('location');
    startLocBtn.onclick=()=>{
      alert('Standort gesetzt. Du kannst jederzeit wechseln.');
    };
  }
  const startNearBtn = document.getElementById('btnStartNear');
  if(startNearBtn){
    startNearBtn.onclick=()=>{
      alert('Zeige Angebote in deiner Nähe.');
      renderStart();
    };
  }

  const btnAddCart = document.getElementById('btnAddCart');
  if(btnAddCart){
    btnAddCart.onclick=()=>{
      const o = offers.find(x=>x.id===activeOfferId);
      if(!o) return;
      if(!addToCart(o)) return;
      closeSheet();
      showCart();
    };
  }

  // Header-Basket aktualisieren (Badge mit Anzahl)
  function updateHeaderBasket(){
    const bottomNavBasketBadge = document.getElementById('bottomNavBasketBadge');
    if(!bottomNavBasketBadge) return;
    
    const raw = load(LS.cart, []);
    const cart = (raw != null && raw !== undefined) ? raw : [];
    const itemCount = (cart && cart.items && Array.isArray(cart.items))
      ? cart.items.reduce((sum, it) => sum + (it && it.qty != null ? it.qty : 0), 0)
      : (Array.isArray(cart) ? cart.length : 0);
    
    if(itemCount > 0){
      bottomNavBasketBadge.textContent = itemCount > 99 ? '99+' : itemCount;
      bottomNavBasketBadge.style.display = 'flex';
    } else {
      bottomNavBasketBadge.style.display = 'none';
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }
  
  // --- Cart ---
  function renderCart(){
    const box=document.getElementById('cartBox');
    const btn=document.getElementById('btnCheckout');
    
    if(!cart || !cart.items.length){
      box.innerHTML = `
        <div style="text-align:center; padding:60px 20px;">
          <div style="width:120px; height:120px; margin:0 auto 24px; background:linear-gradient(135deg, #f8f9fa 0%, #f1f3f5 100%); border-radius:40px; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 24px rgba(0,0,0,0.04);">
            <i data-lucide="shopping-basket" style="width:48px;height:48px;color:#cbd5e1;"></i>
          </div>
          <h3 style="font-size:22px; font-weight:850; margin-bottom:12px; color:#1a1a1a; letter-spacing:-0.02em;">Deine Mittagsbox hat Hunger.</h3>
          <p style="font-size:15px; color:#64748b; margin-bottom:32px; line-height:1.6; max-width:280px; margin-left:auto; margin-right:auto;">Such dir was Leckeres aus – in wenigen Klicks ist die Abholnummer sicher.</p>
          <button class="btn-cust-primary" type="button" onclick="showDiscover();" style="width:100%; max-width:260px; margin:0 auto;">
            <i data-lucide="compass" style="width:20px;height:20px;"></i> <span>Entdecken</span>
          </button>
        </div>
      `;
      if(btn) btn.style.display='none';
      const cartVerzehrart = document.getElementById('cartVerzehrart');
      if(cartVerzehrart) cartVerzehrart.style.display = 'none';
      updateHeaderBasket();
      if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
      return;
    }

    if(btn){
      btn.style.display = 'flex';
      btn.onclick = () => {
        if(!cart.pickupTime){ showToast('Bitte wähle eine Abholzeit'); return; }
        showCheckout();
      };
    }
    const cartVerzehrart = document.getElementById('cartVerzehrart');
    if(cartVerzehrart) cartVerzehrart.style.display = 'block';

    let total=0;
    const TIME_SLOTS = getTimeSlots();
    const now = new Date();
    const currentMinutes = now.getHours() * 60 + now.getMinutes();
    const availableSlots = TIME_SLOTS.filter(slot => {
      const [h, m] = slot.split(':').map(Number);
      return (h * 60 + m) >= currentMinutes + 10;
    });
    const slotsToShow = availableSlots.length > 0 ? availableSlots : TIME_SLOTS.slice(0, 6);
    
    const itemsByProvider = new Map();
    cart.items.forEach(it => {
      const o = offers.find(x => x.id === it.offerId);
      if(!o) return;
      if(!itemsByProvider.has(o.providerId)) itemsByProvider.set(o.providerId, { provider: normalizeOffer(o), items: [] });
      itemsByProvider.get(o.providerId).items.push({offer: o, qty: it.qty});
    });
    
    let groupedHtml = '';
    itemsByProvider.forEach((group, pid) => {
      groupedHtml += `
        <div style="margin-bottom:20px;">
          <div style="font-size:12px; font-weight:800; color:#94a3b8; text-transform:uppercase; margin-bottom:8px; display:flex; align-items:center; gap:6px;">
            <i data-lucide="store" style="width:14px;height:14px;"></i> ${esc(group.provider.providerName)}
          </div>
          ${group.items.map(({offer, qty}) => {
            const norm = normalizeOffer(offer);
            const lineTotal = Number(norm.price||0) * qty;
            total += lineTotal;
            return `
              <div style="display:flex; align-items:center; gap:12px; padding:12px 0; border-bottom:1px solid #f1f3f5;">
                <div style="flex:1; min-width:0;">
                  <div style="font-weight:700; font-size:14px; color:#1a1a1a;">${esc(norm.dish)}</div>
                  <div style="font-weight:800; color:var(--brand); font-size:13px; margin-top:2px;">${euro(lineTotal)}</div>
                </div>
                <div style="display:flex; align-items:center; gap:10px; background:#f8f9fa; border-radius:10px; padding:4px;">
                  <button onclick="changeQty('${offer.id}', -1)" style="width:28px; height:28px; border-radius:8px; border:none; background:#fff; font-weight:900; cursor:pointer;">-</button>
                  <span style="font-weight:800; min-width:16px; text-align:center;">${qty}</span>
                  <button onclick="changeQty('${offer.id}', 1)" style="width:28px; height:28px; border-radius:8px; border:none; background:#fff; font-weight:900; cursor:pointer;">+</button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    });

    box.innerHTML = groupedHtml + `
      <div style="margin-top:20px;">
        <label style="display:block; font-weight:800; font-size:14px; margin-bottom:12px; color:#64748b; text-transform:uppercase;">Abholzeit</label>
        <div style="display:flex; gap:8px; overflow-x:auto; padding-bottom:8px; scrollbar-width:none;">
          ${slotsToShow.map(t => `
            <button class="cust-chip ${cart.pickupTime === t ? 'active' : ''}" onclick="selectCartTime('${t}')">${t}</button>
          `).join('')}
        </div>
      </div>
      <div style="margin-top:24px; padding-top:20px; border-top:2px solid #1a1a1a; display:flex; align-items:center; justify-content:space-between;">
        <span style="font-weight:850; font-size:18px;">Gesamt</span>
        <span style="font-weight:950; font-size:22px; color:#1a1a1a;">${euro(total)}</span>
      </div>
    `;
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
    updateHeaderBasket();
  }

  window.changeQty = (id, delta) => {
    const it = cart.items.find(x => x.offerId === id);
    if(it){
      it.qty += delta;
      if(it.qty <= 0) cart.items = cart.items.filter(x => x.offerId !== id);
      save(LS.cart, cart);
      renderCart();
      updateHeaderBasket();
    }
  };

  window.selectCartTime = (t) => {
    cart.pickupTime = t;
    save(LS.cart, cart);
    renderCart();
  };

  const btnCheckout = document.getElementById('btnCheckout');
  // --- Checkout Navigation ---
  function showCheckout(){
    if(!cart || !cart.items || !cart.items.length){
      showCart();
      return;
    }
    
    // Prüfe ob Payment möglich ist
    const hasPayment = cart.items.every(it=>{
      const o = offers.find(x=>x.id===it.offerId);
      return o && normalizeOffer(o).hasPickupCode;
    });
    
    if(!hasPayment){
      alert('Diese Bestellung enthält Gerichte ohne Abholnummer. Bitte wähle Angebote mit Abholnummer aus.');
      return;
    }
    
    // Gesamtpreis berechnen
    let total = 0;
    cart.items.forEach(it=>{
      const o = offers.find(x=>x.id===it.offerId);
      if(o){
        const normalized = normalizeOffer(o);
        total += Number(normalized.price||0) * it.qty;
      }
    });
    
    if(total <= 0){
      alert('Bitte wähle mindestens ein Gericht aus.');
      return;
    }
    
    // Checkout-View rendern
    renderCheckout(total);
    
    // View anzeigen
    showView(views.checkout);
    setCustomerNavActive('cart'); // Cart bleibt aktiv
    
    // History für Back-Button
    if(!isNavigatingBack){
      navigationHistory.push({
        view: 'cart',
        locationQuery: locationQuery || '',
        activeCat: activeCat || null,
        activeDay: activeDay || isoDate(new Date()),
        activeFilter: activeDiscoverFilter || 'near',
        scrollY: window.scrollY
      });
      pushViewState({view: 'checkout'}, '#checkout');
    }
  }
  
  function renderCheckout(total){
    if(!cart) cart = { items: [] };
    if(!cart.verzehrmodus) cart.verzehrmodus = 'mitnehmen';
    save(LS.cart, cart);
    
    // Zeitauswahl im 15-Minuten-Takt rendern (11:00–14:30)
    const TIME_SLOTS = getTimeSlots();
    const currentMinutes = window.currentMinutes || (new Date().getHours() * 60 + new Date().getMinutes());
    let selectedTime = cart && cart.pickupTime ? cart.pickupTime : '';
    
    // Auto-Auswahl: Nächster verfügbarer Slot (wenn noch keine Zeit gewählt)
    if(!selectedTime){
      const availableSlots = TIME_SLOTS.filter(t => {
        const [h, m] = t.split(':').map(Number);
        return (h * 60 + m) >= currentMinutes + 15;
      });
      if(availableSlots.length > 0){
        selectedTime = availableSlots[0];
        if(!cart) cart = {items: []};
        cart.pickupTime = selectedTime;
        save(LS.cart, cart);
      }
    }
    
    const checkoutTimeSlots = document.getElementById('checkoutTimeSlots');
    if(checkoutTimeSlots){
      checkoutTimeSlots.innerHTML = TIME_SLOTS.map(t => {
        const [h, m] = t.split(':').map(Number);
        const slotMinutes = h * 60 + m;
        const isAvailable = slotMinutes >= currentMinutes + 15;
        const isSelected = selectedTime === t;
        return `<button type="button" class="time-slot-btn ${isSelected ? 'selected' : ''} ${!isAvailable ? 'disabled' : ''}" data-time="${t}" style="flex:0 0 auto; min-width:72px; padding:12px; border-radius:12px; border:2px solid ${isSelected ? '#FFD700' : '#e7e1d5'}; background:${isSelected ? '#FFD700' : '#fff'}; color:${isSelected ? '#2D3436' : isAvailable ? '#666' : '#ccc'}; font-weight:${isSelected ? '900' : '600'}; font-size:14px; cursor:${isAvailable ? 'pointer' : 'not-allowed'}; transition:all 0.2s ease; opacity:${isAvailable ? '1' : '0.5'};">
          ${t}
        </button>`;
      }).join('');
      
      // Handler für Time-Slots
      checkoutTimeSlots.querySelectorAll('.time-slot-btn:not(.disabled)').forEach(btn => {
        btn.onclick = () => {
          const time = btn.getAttribute('data-time');
          if(!cart) cart = {items: []};
          cart.pickupTime = time;
          save(LS.cart, cart);
          
          // Custom Input ausblenden
          const customInputWrapper = document.getElementById('customTimeInputWrapper');
          if(customInputWrapper) customInputWrapper.style.display = 'none';
          const customInput = document.getElementById('checkoutPickupTimeCustom');
          if(customInput) customInput.value = '';
          
          // UI aktualisieren
          checkoutTimeSlots.querySelectorAll('.time-slot-btn').forEach(b => {
            const isSelected = b.getAttribute('data-time') === time;
            b.classList.toggle('selected', isSelected);
            b.style.borderColor = isSelected ? '#FFD700' : '#e7e1d5';
            b.style.background = isSelected ? '#FFD700' : '#fff';
            b.style.color = isSelected ? '#2D3436' : '#666';
            b.style.fontWeight = isSelected ? '900' : '600';
          });
          
          const hiddenInput = document.getElementById('checkoutPickupTime');
          if(hiddenInput) hiddenInput.value = time;
        };
      });
    }
    
    // "Andere Uhrzeit wählen" Button Handler
    const btnOtherTime = document.getElementById('btnOtherTime');
    const customTimeInputWrapper = document.getElementById('customTimeInputWrapper');
    const customTimeInput = document.getElementById('checkoutPickupTimeCustom');
    if(btnOtherTime && customTimeInputWrapper && customTimeInput){
      btnOtherTime.onclick = () => {
        const isVisible = customTimeInputWrapper.style.display !== 'none';
        customTimeInputWrapper.style.display = isVisible ? 'none' : 'block';
        if(!isVisible){
          customTimeInput.focus();
          // Alle Slots deselektieren
          if(checkoutTimeSlots){
            checkoutTimeSlots.querySelectorAll('.time-slot-btn').forEach(b => {
              b.classList.remove('selected');
              b.style.borderColor = '#e7e1d5';
              b.style.background = '#fff';
              b.style.color = '#666';
              b.style.fontWeight = '600';
            });
          }
          // Wenn bereits eine Custom-Zeit gesetzt ist, diese anzeigen
          if(cart && cart.pickupTime && !TIME_SLOTS.includes(cart.pickupTime)){
            // Format für time-Input: HH:MM
            const timeParts = cart.pickupTime.replace(' Uhr', '').split(':');
            if(timeParts.length === 2){
              customTimeInput.value = `${timeParts[0].padStart(2, '0')}:${timeParts[1].padStart(2, '0')}`;
            }
          }
        }
      };
      
      customTimeInput.onchange = () => {
        const customTime = customTimeInput.value;
        if(customTime){
          const [h, m] = customTime.split(':').map(Number);
          const timeMinutes = h * 60 + m;
          const minMinutes = 11 * 60; // 11:00
          const maxMinutes = 14 * 60 + 30; // 14:30
          if(timeMinutes >= minMinutes && timeMinutes <= maxMinutes){
            const formattedTime = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')} Uhr`;
            if(!cart) cart = {items: []};
            cart.pickupTime = formattedTime;
            save(LS.cart, cart);
            const hiddenInput = document.getElementById('checkoutPickupTime');
            if(hiddenInput) hiddenInput.value = formattedTime;
            showToast('Zeit gespeichert ✓', 1500);
          } else {
            showToast('Bitte wähle eine Zeit zwischen 11:00 und 14:30 Uhr', 3000);
            customTimeInput.value = '';
          }
        }
      };
    }
    
    // Hidden Input setzen
    const hiddenInput = document.getElementById('checkoutPickupTime');
    if(hiddenInput && selectedTime) hiddenInput.value = selectedTime;
    
    // Vor Ort nur anzeigen, wenn mindestens ein Anbieter im Cart dineInPossible hat
    let anyDineIn = false;
    cart.items.forEach(it => {
      const o = offers.find(x => x.id === it.offerId);
      if(o && normalizeOffer(o).dineInPossible) anyDineIn = true;
    });
    const btnVorOrt = document.getElementById('checkoutBtnVorOrt');
    const btnMitnehmen = document.getElementById('checkoutBtnMitnehmen');
    if(btnVorOrt) btnVorOrt.style.display = anyDineIn ? '' : 'none';
    if(!anyDineIn && (cart.verzehrmodus || '') === 'vor_ort'){
      cart.verzehrmodus = 'mitnehmen';
      save(LS.cart, cart);
    }
    const vm = cart.verzehrmodus || 'mitnehmen';
    
    // Active-State: Gelbe Hintergrundfarbe für ausgewählten Button
    const updateVerzehrartButtons = () => {
      const isVorOrt = vm === 'vor_ort';
      const isMitnehmen = vm === 'mitnehmen';
      
      if(btnVorOrt){
        btnVorOrt.classList.toggle('active', isVorOrt);
        btnVorOrt.style.borderColor = isVorOrt ? '#FFD700' : '#e7e1d5';
        btnVorOrt.style.background = isVorOrt ? '#FFD700' : '#fff';
        btnVorOrt.style.color = isVorOrt ? '#2D3436' : '#666';
        btnVorOrt.style.fontWeight = isVorOrt ? '900' : '600';
      }
      
      if(btnMitnehmen){
        btnMitnehmen.classList.toggle('active', isMitnehmen);
        btnMitnehmen.style.borderColor = isMitnehmen ? '#FFD700' : '#e7e1d5';
        btnMitnehmen.style.background = isMitnehmen ? '#FFD700' : '#fff';
        btnMitnehmen.style.color = isMitnehmen ? '#2D3436' : '#666';
        btnMitnehmen.style.fontWeight = isMitnehmen ? '900' : '600';
      }
    };
    
    updateVerzehrartButtons();
    
    // Interaktions-Logik: Status an Anbieter-Datensatz senden
    if(btnVorOrt){
      btnVorOrt.onclick = () => {
        cart.verzehrmodus = 'vor_ort';
        save(LS.cart, cart);
        
        // Signal an Anbieter: Porzellan/Besteck vorbereiten
        cart.items.forEach(item => {
          const offer = offers.find(o => o.id === item.offerId);
          if(offer && offer.providerId){
            // Verzehrart wird beim Erstellen der Bestellung an den Anbieter übermittelt
            // Der Anbieter sieht in seinem Dashboard: "Vor Ort essen" für diese Bestellung
          }
        });
        
        renderCheckout(total);
      };
    }
    
    if(btnMitnehmen){
      btnMitnehmen.onclick = () => {
        cart.verzehrmodus = 'mitnehmen';
        if(!cart.verpackung) cart.verpackung = 'mehrweg';
        save(LS.cart, cart);
        
        // Signal an Anbieter: Einpacken in Box/Mehrweg
        cart.items.forEach(item => {
          const offer = offers.find(o => o.id === item.offerId);
          if(offer && offer.providerId){
          }
        });
        
        renderCheckout(total);
      };
    }
    
    // Verpackung (nur bei Mitnehmen) – Anzeige + Buttons im Time-Slot-Stil
    const verpackungWrap = document.getElementById('checkoutVerpackung');
    const btnEigenerBehaeltner = document.getElementById('checkoutBtnEigenerBehaeltner');
    const btnMehrweg = document.getElementById('checkoutBtnMehrweg');
    const isMitnehmen = (cart.verzehrmodus || 'mitnehmen') === 'mitnehmen';
    if(verpackungWrap) verpackungWrap.style.display = isMitnehmen ? 'block' : 'none';
    
    const verpackung = cart.verpackung || 'mehrweg';
    const setVerpackungActive = (btn, active) => {
      if(!btn) return;
      btn.style.borderColor = active ? '#FFD700' : '#e7e1d5';
      btn.style.background = active ? '#FFD700' : '#fff';
      btn.style.color = active ? '#2D3436' : '#666';
      btn.style.fontWeight = active ? '900' : '600';
    };
    if(btnEigenerBehaeltner){
      setVerpackungActive(btnEigenerBehaeltner, verpackung === 'eigener_behaeltner');
      btnEigenerBehaeltner.onclick = () => {
        cart.verpackung = 'eigener_behaeltner';
        save(LS.cart, cart);
        setVerpackungActive(btnEigenerBehaeltner, true);
        setVerpackungActive(btnMehrweg, false);
      };
    }
    if(btnMehrweg){
      setVerpackungActive(btnMehrweg, verpackung === 'mehrweg');
      btnMehrweg.onclick = () => {
        cart.verpackung = 'mehrweg';
        save(LS.cart, cart);
        setVerpackungActive(btnMehrweg, true);
        setVerpackungActive(btnEigenerBehaeltner, false);
      };
    }
    
    const summaryEl = document.getElementById('checkoutSummary');
    if(!summaryEl) return;
    
    // Anbieter klickbar: Bei [Name1], [Name2] → Profil
    const providerMap = new Map();
    cart.items.forEach(it => {
      const o = offers.find(x => x.id === it.offerId);
      if(o && o.providerId) providerMap.set(o.providerId, normalizeOffer(o).providerName || 'Anbieter');
    });
    let providerLineHtml = '<div style="margin-bottom:12px; font-size:14px; color:#64748b;">Bei: ';
    const providerEntries = [];
    providerMap.forEach((name, pid) => providerEntries.push({ pid, name }));
    providerLineHtml += providerEntries.map(({ pid, name }) => `<button type="button" class="checkout-provider-link" data-provider-id="${esc(pid)}" style="background:none;border:none;padding:0;font-weight:700;color:#1a1a1a;text-decoration:underline;cursor:pointer;font-size:14px;">${esc(name)}</button>`).join(', ');
    providerLineHtml += '</div>';
    
    // Bestellübersicht rendern
    let summaryHTML = providerLineHtml + '<div style="font-weight:700; font-size:16px; margin-bottom:16px; color:#2D3436;">Bestellübersicht</div>';
    cart.items.forEach(it=>{
      const o = offers.find(x=>x.id===it.offerId);
      if(o){
        const normalized = normalizeOffer(o);
        const lineTotal = Number(normalized.price||0) * it.qty;
        summaryHTML += `
          <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid rgba(0,0,0,.08);">
            <div>
              <div style="font-weight:600; font-size:15px; color:#2D3436;">${esc(normalized.dish||'Gericht')} × ${it.qty}</div>
              <div style="font-size:13px; color:#666; margin-top:4px;">${esc(normalized.providerName||'Anbieter')}</div>
            </div>
            <div style="font-weight:700; font-size:16px; color:#2D3436;">${euro(lineTotal)}</div>
          </div>
        `;
      }
    });
    summaryHTML += `
      <div style="display:flex; justify-content:space-between; align-items:center; padding-top:16px; margin-top:16px; border-top:2px solid #2D3436;">
        <div style="font-weight:900; font-size:18px; color:#2D3436;">Gesamt</div>
        <div style="font-weight:900; font-size:24px; color:#FFB800;">${euro(total)}</div>
      </div>
    `;
    summaryEl.innerHTML = summaryHTML;
    summaryEl.querySelectorAll('.checkout-provider-link').forEach(btn => {
      const pid = btn.getAttribute('data-provider-id');
      if(pid) btn.onclick = () => showProviderProfilePublic(pid);
    });
    
    // Apple Pay / Google Pay Buttons prüfen (wenn verfügbar)
    const btnApplePay = document.getElementById('btnApplePay');
    const btnGooglePay = document.getElementById('btnGooglePay');
    if(btnApplePay){
      // Prüfe ob Apple Pay verfügbar ist (in Production: window.ApplePaySession?.canMakePayments())
      btnApplePay.style.display = 'none'; // MVP: Ausgeblendet, in Production aktivieren
    }
    if(btnGooglePay){
      // Prüfe ob Google Pay verfügbar ist
      btnGooglePay.style.display = 'none'; // MVP: Ausgeblendet, in Production aktivieren
    }
    
    // Standard Payment Button Handler
    const btnStandardPayment = document.getElementById('btnStandardPayment');
    if(btnStandardPayment){
      btnStandardPayment.onclick = () => {
        processCheckoutPayment(total);
      };
    }
    
    // Back Button
    const btnCheckoutBack = document.getElementById('btnCheckoutBack');
    if(btnCheckoutBack){
      btnCheckoutBack.onclick = () => {
        showCart();
      };
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(() => lucide.createIcons(), 50);
    }
  }
  
  function processCheckoutPayment(total){
    // Name validieren
    const nameInput = document.getElementById('checkoutName');
    const name = nameInput ? nameInput.value.trim() : '';
    if(!name){
      alert('Bitte gib deinen Namen für die Abholung ein.');
      if(nameInput) nameInput.focus();
      return;
    }
    
    // Abholzeit auslesen
    const pickupTimeSelect = document.getElementById('checkoutPickupTime');
    const pickupTime = pickupTimeSelect ? pickupTimeSelect.value : 'asap';
    const pickupTimeText = pickupTime === 'asap' ? 'So schnell wie möglich' : `${pickupTime} Uhr`;
    
    // E-Mail (optional)
    const emailInput = document.getElementById('checkoutEmail');
    const email = emailInput ? emailInput.value.trim() : '';
    
    // Cart mit neuen Daten aktualisieren
    cart.pickupTime = pickupTimeText;
    cart.customerName = name;
    cart.customerEmail = email;
    save(LS.cart, cart);
    
    // Pro Anbieter eine Order erstellen (eine Zahlung, mehrere Abholnummern)
    const ordersCreated = createOrdersFromCartByProvider(cart, 'CREATED');
    if(!ordersCreated || ordersCreated.length === 0){
      alert('Fehler beim Erstellen der Bestellung.');
      return;
    }
    ordersCreated.forEach(o => updateOrder(o.id, { status: 'PAYMENT_PENDING' }));
    startStripeCheckout(total, cart, ordersCreated);
  }
  
  if(btnCheckout){
    btnCheckout.onclick=()=>{
      showCheckout();
    };
  }
  
  /**
   * Create order from cart
   * @param {Object} cartData
   * @param {'CREATED'|'PAYMENT_PENDING'} initialStatus
   * @returns {Order|null}
   */
  function createOrderFromCart(cartData, initialStatus){
    if(!cartData || !cartData.items || !cartData.items.length) return null;
    
    const firstOffer = cartData.items.length ? offers.find(x=>x.id===cartData.items[0].offerId) : null;
    const firstOfferNormalized = firstOffer ? normalizeOffer(firstOffer) : null;
    
    // Gesamtpreis berechnen (in Cents)
    let totalCents = 0;
    const items = cartData.items.map(it=>{
      const o = offers.find(x=>x.id===it.offerId);
      if(!o) return null;
      const normalized = normalizeOffer(o);
      const unitPriceCents = Math.round(Number(normalized.price||0) * 100);
      const lineTotalCents = unitPriceCents * it.qty;
      totalCents += lineTotalCents;
      return {
        dishId: o.id,
        dishName: normalized.dish || normalized.title || 'Gericht',
        quantity: it.qty,
        unitPriceCents: unitPriceCents
      };
    }).filter(Boolean);
    
    const now = Date.now();
    /** @type {Order} */
    const order = {
      id: cryptoId(),
      createdAt: now,
      updatedAt: now,
      dishId: items[0]?.dishId || '',
      verzehrmodus: cartData.verzehrmodus || 'mitnehmen', // Verzehrart an Anbieter übermitteln: 'vor_ort' = Porzellan/Besteck vorbereiten, 'mitnehmen' = Einpacken in Box/Mehrweg
      offerId: items[0]?.dishId || '', // Same as dishId for MVP
      dishName: items.map(i => `${i.dishName} x ${i.quantity}`).join(', '),
      providerId: cartData.providerId || '',
      providerName: cartData.providerName || 'Anbieter',
      providerAddress: firstOfferNormalized ? buildAddress({
        address: firstOfferNormalized.address,
        street: firstOfferNormalized.providerStreet,
        zip: firstOfferNormalized.providerZip,
        city: firstOfferNormalized.providerCity
      }) : '',
      quantity: cartData.items.reduce((sum, it) => sum + it.qty, 0),
      unitPrice: items[0]?.unitPriceCents || 0,
      total: totalCents,
      fulfillType: cartData.verzehrmodus === 'vor_ort' ? 'DINE_IN' : 'PICKUP', // Für Kompatibilität
      etaTime: cartData.pickupTime || '',
      abholzeit: cartData.pickupTime || '',
      status: initialStatus,
      currency: 'EUR',
      stripeCheckoutSessionId: undefined,
      stripePaymentIntentId: undefined,
      receiptEmail: undefined,
      pickupCode: undefined, // Abholnummer; wird bei PAID gesetzt
      abholnummer: undefined, // Alias für Anbieter-Output; bei PAID = pickupCode
      pickupCodeActivatedAt: undefined, // Nur bei PAID
      pickupDate: undefined, // Wird bei PAID gesetzt
      pickupWindow: firstOfferNormalized && firstOfferNormalized.pickupWindow ? firstOfferNormalized.pickupWindow : '',
      dishLetter: undefined, // Wird bei PAID gesetzt
      runningNumber: undefined, // Wird bei PAID gesetzt
      isGuest: true,
      // Kompatibilität
      summary: items.map(i => `${i.dishName} x ${i.quantity}`).join(', '),
      code: null,
      pickupTime: cartData.pickupTime || '',
      pickupWindow: firstOfferNormalized && firstOfferNormalized.pickupWindow ? firstOfferNormalized.pickupWindow : '',
      unitPriceCents: items[0]?.unitPriceCents || 0,
      totalCents: totalCents,
      paymentIntentId: null,
      verpackung: cartData.verpackung || null // Säule 3: eigener_behaeltner | mehrweg (nur bei Mitnehmen)
    };
    
    return addOrder(order);
  }
  
  /**
   * Erstellt pro Anbieter eine Order (eine Zahlung, mehrere Abholnummern).
   * @param {Object} cartData
   * @param {'CREATED'|'PAYMENT_PENDING'} initialStatus
   * @returns {Order[]}
   */
  function createOrdersFromCartByProvider(cartData, initialStatus){
    if(!cartData || !cartData.items || !cartData.items.length) return [];
    const byProvider = new Map();
    cartData.items.forEach(it => {
      const o = offers.find(x => x.id === it.offerId);
      if(!o || !o.providerId) return;
      if(!byProvider.has(o.providerId)) byProvider.set(o.providerId, []);
      byProvider.get(o.providerId).push({ offer: o, qty: it.qty });
    });
    const result = [];
    byProvider.forEach((providerItems, providerId) => {
      const first = providerItems[0].offer;
      const firstNorm = normalizeOffer(first);
      let totalCents = 0;
      const items = providerItems.map(({ offer, qty }) => {
        const normalized = normalizeOffer(offer);
        const unitPriceCents = Math.round(Number(normalized.price || 0) * 100);
        const lineTotalCents = unitPriceCents * qty;
        totalCents += lineTotalCents;
        return { dishId: offer.id, dishName: normalized.dish || normalized.title || 'Gericht', quantity: qty, unitPriceCents };
      });
      const now = Date.now();
      const order = {
        id: cryptoId(),
        createdAt: now,
        updatedAt: now,
        dishId: items[0]?.dishId || '',
        verzehrmodus: cartData.verzehrmodus || 'mitnehmen',
        offerId: items[0]?.dishId || '',
        dishName: items.map(i => `${i.dishName} x ${i.quantity}`).join(', '),
        providerId: providerId,
        providerName: firstNorm.providerName || 'Anbieter',
        providerAddress: firstNorm ? [firstNorm.providerStreet, firstNorm.providerZip, firstNorm.providerCity].filter(Boolean).join(', ') : '',
        quantity: providerItems.reduce((s, i) => s + i.qty, 0),
        unitPrice: items[0]?.unitPriceCents || 0,
        total: totalCents,
        fulfillType: cartData.verzehrmodus === 'vor_ort' ? 'DINE_IN' : 'PICKUP',
        etaTime: cartData.pickupTime || '',
        abholzeit: cartData.pickupTime || '',
        status: initialStatus,
        currency: 'EUR',
        stripeCheckoutSessionId: undefined,
        stripePaymentIntentId: undefined,
        receiptEmail: undefined,
        pickupCode: undefined,
        abholnummer: undefined,
        pickupCodeActivatedAt: undefined,
        pickupDate: undefined,
        pickupWindow: firstNorm?.pickupWindow || '',
        dishLetter: undefined,
        runningNumber: undefined,
        isGuest: true,
        summary: items.map(i => `${i.dishName} x ${i.quantity}`).join(', '),
        code: null,
        pickupTime: cartData.pickupTime || '',
        unitPriceCents: items[0]?.unitPriceCents || 0,
        totalCents: totalCents,
        paymentIntentId: null,
        verpackung: cartData.verpackung || null
      };
      const added = addOrder(order);
      if(added) result.push(added);
    });
    return result;
  }
  
  // --- Stripe Checkout (Gastzahlung, Zahlung Pflicht) ---
  /**
   * Start Stripe Checkout flow
   * @param {number} total - Total amount in EUR (not cents)
   * @param {Object} cartData - Cart data
   * @param {string|Object[]} orderIdOrOrders - Order ID (single) or array of orders (multi-provider)
   */
  function startStripeCheckout(total, cartData, orderIdOrOrders){
    const orderIds = Array.isArray(orderIdOrOrders) ? orderIdOrOrders.map(o => o.id) : [orderIdOrOrders];
    const mainOrderId = orderIds[0];
    var stripeConfig = window.MITTAGIO_STRIPE || {};
    var publishableKey = stripeConfig.publishableKey;
    var apiBase = stripeConfig.apiBase || '';

    if (publishableKey && apiBase !== false) {
      var endpoint = (apiBase || window.location.origin) + '/.netlify/functions/create-checkout-session';
      var basePath = (window.location.pathname || '/').replace(/\/?$/, '') || '';
      var successUrl = window.location.origin + basePath + '/';
      var cancelUrl = window.location.origin + basePath + '/';
      var lineItems = (cartData && cartData.items && cartData.items.length) ? cartData.items.map(function(item){
        var offer = typeof offers !== 'undefined' && offers.find ? offers.find(function(o){ return o.id === item.offerId; }) : null;
        var name = (offer && offer.dish) ? offer.dish : (item.dish || 'Gericht');
        var price = (item.total != null) ? item.total : (item.price != null ? item.price * (item.quantity || 1) : total);
        return { name: name, amount: price, quantity: 1 };
      }) : null;
      var payload = {
        orderId: mainOrderId,
        total: total,
        currency: 'eur',
        successUrl: successUrl,
        cancelUrl: cancelUrl,
        lineItems: lineItems && lineItems.length ? lineItems : null
      };

      fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
        .then(function(r){ return r.json(); })
        .then(function(data){
          if (data.error) throw new Error(data.error);
          if (data.url) {
            var sessionId = data.sessionId || data.url;
            orderIds.forEach(function(id){ updateOrder(id, { stripeCheckoutSessionId: sessionId }); });
            window.location.href = data.url;
          } else {
            throw new Error('Keine Checkout-URL erhalten');
          }
        })
        .catch(function(err){
          console.error('Stripe Checkout:', err);
          if (typeof showToast === 'function') showToast('Zahlung konnte nicht gestartet werden. ' + (err.message || ''));
          else alert('Zahlung konnte nicht gestartet werden. ' + (err.message || ''));
        });
      return;
    }

    // Demo: Kein Stripe konfiguriert – Simuliere Checkout
    var sessionId = 'demo_session_' + cryptoId();
    orderIds.forEach(function(id){ updateOrder(id, { stripeCheckoutSessionId: sessionId }); });
    if (confirm('Stripe Checkout würde jetzt geöffnet.\n\nGesamtbetrag: ' + euro(total) + '\n\nGastzahlung möglich (E-Mail nur für Zahlungsbeleg).\n\nDemo: Zahlung erfolgreich simulieren?')) {
      handleCheckoutSuccess(sessionId, mainOrderId);
    } else {
      handleCheckoutCancel(mainOrderId);
    }
  }
  
  /**
   * Handle Stripe Checkout Success Return
   * Route: /checkout/success?session_id=xxx OR ?orderId=xxx
   * @param {string} [sessionId] - Stripe session ID (optional)
   * @param {string} [orderId] - Order ID (optional, if sessionId not available)
   */
  function handleCheckoutSuccess(sessionId, orderId){
    // TODO: In Production, verify payment via Webhook
    const ordersList = loadOrders();
    let orders = [];
    if(sessionId) orders = ordersList.filter(o => o.stripeCheckoutSessionId === sessionId);
    if(orders.length === 0 && orderId) orders = [getOrderById(orderId)].filter(Boolean);
    
    if(orders.length === 0){
      console.error('Order not found for checkout success', { sessionId, orderId });
      // Zeige Fehler-UI
      const errorView = document.createElement('div');
      errorView.className = 'panel';
      errorView.style.padding = '40px 20px';
      errorView.style.textAlign = 'center';
      errorView.innerHTML = `
        <div style="font-size:48px; margin-bottom:20px;">⚠️</div>
        <h3 style="margin-bottom:12px;">Bestellung nicht gefunden</h3>
        <p class="hint" style="margin-bottom:24px;">Die Bestellung konnte nicht gefunden werden.</p>
        <button class="btn" type="button" onclick="showDiscover()" style="width:100%; min-height:44px;">
          <i data-lucide="compass"></i> Zur Entdecken-Seite
        </button>
      `;
      document.body.appendChild(errorView);
      showView(null); // Hide all views
      if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
      return;
    }
    
    const paymentData = {
      stripeCheckoutSessionId: sessionId || orders[0].stripeCheckoutSessionId,
      paymentIntentId: 'pi_' + cryptoId(),
      receiptEmail: 'customer@example.com'
    };
    const notPaid = orders.filter(o => o.status !== 'PAID');
    notPaid.forEach(o => {
      if(o.status !== 'PAYMENT_PENDING') console.warn('Order status is not PAYMENT_PENDING:', o.id);
      completePayment(o.id, paymentData, { skipCartClear: true, skipShowSuccess: true });
    });
    cart = null;
    save(LS.cart, cart);
    if(typeof renderCart === 'function') renderCart();
    const paidOrders = loadOrders().filter(o => o.stripeCheckoutSessionId === sessionId);
    if(paidOrders.length === 1 && paidOrders[0].status === 'PAID') showOrderSuccess(paidOrders[0]);
    else if(paidOrders.length > 1) showOrderSuccess(paidOrders);
    else if(paidOrders.length === 1) showPickupCode(paidOrders[0].id);
  }
  
  /**
   * Handle Stripe Checkout Cancel
   * Route: /checkout/cancel?orderId=xxx OR ?session_id=xxx
   * @param {string} [orderId] - Order ID (optional)
   * @param {string} [sessionId] - Stripe session ID (optional)
   */
  function handleCheckoutCancel(orderId, sessionId){
    let order = null;
    
    // Find order: priority: orderId > sessionId
    if(orderId){
      order = getOrderById(orderId);
    } else if(sessionId){
      const ordersList = loadOrders();
      order = ordersList.find(o => o.stripeCheckoutSessionId === sessionId);
    }
    
    if(!order){
      // Fallback: direkt zum Warenkorb
      showCart();
      return;
    }
    
    // Set status to CANCELLED
    updateOrder(order.id, {
      status: 'CANCELLED'
    });
    
    // UI: "Zahlung abgebrochen" + Button "Zurück zum Warenkorb"
    // Navigate back to cart
    showCart();
    
    // Zeige Info (optional, kann auch weggelassen werden)
    setTimeout(() => {
      const cartBox = document.getElementById('cartBox');
      if(cartBox){
        const infoDiv = document.createElement('div');
        infoDiv.className = 'hint';
        infoDiv.style.cssText = 'background:#fff3cd; border:1px solid #ffc107; border-radius:12px; padding:12px; margin-bottom:16px; text-align:center;';
        infoDiv.innerHTML = 'ℹ️ Zahlung abgebrochen';
        cartBox.insertBefore(infoDiv, cartBox.firstChild);
      }
    }, 100);
  }
  
  /**
   * Complete payment (set status to PAID and generate pickup code)
   * @param {string} orderId
   * @param {Object} paymentData
   * @param {{ skipCartClear?: boolean, skipShowSuccess?: boolean }} [opts] - Bei Mehrfach-Bestellung: Cart/Success vom Aufrufer gesteuert
   */
  function completePayment(orderId, paymentData, opts){
    const skipCartClear = opts && opts.skipCartClear;
    const skipShowSuccess = opts && opts.skipShowSuccess;
    const order = getOrderById(orderId);
    if(!order){
      console.error('Order not found:', orderId);
      return;
    }
    
    const offer = offers.find(o => o.id === order.dishId || o.id === order.offerId);
    const pickupDate = offer ? offer.day : isoDate(new Date());
    const pickupWindow = offer ? (offer.pickupWindow || '') : (order.pickupWindow || '');
    
    const {dishLetter, runningNumber, pickupCode} = assignPickupCode({
      providerId: order.providerId,
      pickupDate: pickupDate,
      dishId: order.dishId || order.offerId
    });
    const now = Date.now();
    
    const updatedOrder = updateOrder(orderId, {
      status: 'PAID',
      stripeCheckoutSessionId: paymentData.stripeCheckoutSessionId,
      stripePaymentIntentId: paymentData.paymentIntentId,
      receiptEmail: paymentData.receiptEmail,
      pickupCode: pickupCode,
      abholnummer: pickupCode,
      pickupCodeActivatedAt: now,
      pickupDate: pickupDate,
      pickupWindow: pickupWindow,
      dishLetter: dishLetter,
      runningNumber: runningNumber,
      code: pickupCode,
      paymentStatus: 'PAID',
      paymentIntentId: paymentData.paymentIntentId
    });
    
    if(!updatedOrder) return;
    
    if(!skipCartClear){
      cart = null;
      save(LS.cart, cart);
      renderCart();
    }
    orders = loadOrders();
    renderOrders();
    
    if(mode === 'provider' && order.providerId === providerId()){
      sendBackupEmailToProvider(updatedOrder);
      playSaleSound();
      renderProviderHome();
      renderProviderPickups();
    }
    sendOrderToProviderDashboard(updatedOrder);
    
    if(!skipShowSuccess) showOrderSuccess(updatedOrder);
  }
  
  /**
   * AbholBestätigung: Success-View nach Zahlung (Abholnummer, Zeit, Modus, Verpackung).
   * @param {Order|Order[]} orderOrOrders - eine Bestellung oder Array (mehrere Anbieter)
   */
  function showOrderSuccess(orderOrOrders){
    const orders = Array.isArray(orderOrOrders) ? orderOrOrders : [orderOrOrders];
    if(orders.length === 0){ showDiscover(); return; }
    const order = orders[0];
    const code = order.pickupCode || order.abholnummer || order.code || '–';
    const zeit = order.pickupTime || order.abholzeit || order.etaTime || '–';
    const modus = order.verzehrmodus || 'mitnehmen';
    const verpackung = order.verpackung || null;
    const isMitnehmen = modus === 'mitnehmen';
    
    const singleBlock = document.getElementById('orderSuccessSingleBlock');
    const multiBlock = document.getElementById('orderSuccessMultiBlock');
    const abholnummerEl = document.getElementById('orderSuccessAbholnummer');
    const zeitEl = document.getElementById('orderSuccessZeit');
    const modusEl = document.getElementById('orderSuccessModus');
    const verpackungWrap = document.getElementById('orderSuccessVerpackung');
    const btnDone = document.getElementById('btnOrderSuccessDone');
    
    if(orders.length > 1){
      if(singleBlock) singleBlock.style.display = 'none';
      if(multiBlock){
        multiBlock.style.display = 'block';
        multiBlock.innerHTML = orders.map(o => {
          const c = o.pickupCode || o.abholnummer || o.code || '–';
          const name = (o.providerName || 'Anbieter').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          return '<div style="text-align:center; padding:16px; background:rgba(255,215,0,0.12); border-radius:16px; border:2px solid rgba(255,215,0,0.3); margin-bottom:12px;"><div style="font-size:12px; font-weight:700; color:#64748b; margin-bottom:4px;">Bei ' + name + '</div><div style="font-family:monospace; font-size:28px; font-weight:900; letter-spacing:4px; color:#1a1a1a;">#' + (c + '').replace(/</g, '&lt;') + '</div></div>';
        }).join('');
      }
    } else {
      if(singleBlock) singleBlock.style.display = 'block';
      if(multiBlock) multiBlock.style.display = 'none';
      if(abholnummerEl) abholnummerEl.textContent = '#' + code;
    }
    if(zeitEl) zeitEl.innerHTML = '<span style="font-size:20px;">🕒</span> Abholung um ' + (zeit.indexOf('Uhr') >= 0 ? zeit : zeit + ' Uhr');
    if(modusEl){
      if(modus === 'vor_ort') modusEl.innerHTML = '<span style="font-size:20px;">🍴</span> Vor Ort';
      else modusEl.innerHTML = '<span style="font-size:20px;">🔄</span> Mitnehmen';
    }
    if(verpackungWrap){
      if(isMitnehmen && verpackung){
        verpackungWrap.style.display = 'flex';
        verpackungWrap.innerHTML = verpackung === 'eigener_behaeltner' ? '<span style="font-size:20px;">🔄</span> Eigener Behälter' : '<span style="font-size:20px;">🔄</span> Mehrweg-System';
      } else verpackungWrap.style.display = 'none';
    }
    if(btnDone) btnDone.onclick = () => showDiscover();
    var orderSuccessCurrentOrder = order;
    var btnKollegen = document.getElementById('btnOrderSuccessKollegen');
    if(btnKollegen){
      btnKollegen.onclick = function(){
        var o = orderSuccessCurrentOrder;
        if(!o) return;
        var dishId = o.dishId || o.offerId || '';
        var shareUrl = (location.origin || '') + (location.pathname || '/').replace(/\/$/, '') + '#offer/' + dishId;
        var text = 'Schau mal, das gibt es heute bei ' + (o.providerName || 'Metzger') + ': ' + (o.dishName || 'Gericht') + '. Sollen wir hin? Ich sicher uns die Abholnummer! ' + shareUrl;
        if(navigator.share){
          navigator.share({ title: o.dishName || 'Gericht', text: text, url: shareUrl }).then(function(){ if(typeof showToast === 'function') showToast('Geteilt!'); }).catch(function(){});
        } else {
          navigator.clipboard.writeText(text).then(function(){ if(typeof showToast === 'function') showToast('Link kopiert!'); });
        }
      };
    }
    if(typeof lucide !== 'undefined') lucide.createIcons();
    showView(views.orderSuccess);
    setCustomerNavActive('cart');
  }
  
  /**
   * Simuliert Übermittlung an Anbieter-Dashboard (abholnummer, zeit, modus, verpackung).
   * In Production: POST an Backend → Anbieter-Dashboard aktualisiert sich.
   */
  function sendOrderToProviderDashboard(order){
    const payload = {
      abholnummer: order.pickupCode || order.abholnummer || order.code,
      zeit: order.pickupTime || order.abholzeit || order.etaTime,
      modus: order.verzehrmodus === 'vor_ort' ? 'vor_ort' : 'mitnehmen',
      verpackung: order.verpackung || (order.verzehrmodus === 'mitnehmen' ? 'mehrweg' : null),
      providerId: order.providerId,
      dishName: order.dishName,
      quantity: order.quantity
    };
    // Optional: In Production hier z.B. EventBus oder API-Call
    // window.dispatchEvent(new CustomEvent('order-paid', { detail: payload }));
  }

  // --- Start actions ---
  const startCustomerBtn = document.getElementById('btnStartCustomer');
  if(startCustomerBtn){
    startCustomerBtn.onclick=()=>{
      setMode('customer');
    };
  }
  const startProviderBtn = document.getElementById('btnStartProvider');
  if(startProviderBtn){
    startProviderBtn.onclick=()=>{
      setMode('provider');
    };
  }

  // --- Profile View ("Mein Mittagio") - Zalando-Prinzip ---
  let currentPublicProviderId = null;

  function showProviderProfilePublic(providerId){
    currentPublicProviderId = providerId;
    showView('v-provider-detail-public');
    renderPublicProviderProfile();
  }

  function renderPublicProviderProfile(){
    const pid = currentPublicProviderId;
    if(!pid) return;

    // Finde Anbieter-Daten (aus erstem verfügbarem Angebot)
    const allOffers = load(LS.offers, []);
    const provOffers = allOffers.filter(o => o.providerId === pid);
    const first = provOffers[0] || {};
    const norm = normalizeOffer(first);

    const pubProvName = document.getElementById('pubProvName');
    const pubProvTitle = document.getElementById('pubProvTitle');
    const pubProvAddress = document.getElementById('pubProvAddress');
    
    if(pubProvName) pubProvName.textContent = norm.providerName || 'Anbieter';
    if(pubProvTitle) pubProvTitle.textContent = norm.providerName || 'Anbieter';
    if(pubProvAddress) pubProvAddress.textContent = [norm.providerStreet, norm.providerZip, norm.providerCity].filter(Boolean).join(', ') || 'Adresse nicht verfügbar';
    var logoWrap = document.getElementById('pubProvLogoWrap');
    var logoEmoji = document.getElementById('pubProvLogoEmoji');
    if(logoWrap){
      if(norm.providerLogoData || first.providerLogoData){
        var src = norm.providerLogoData || first.providerLogoData;
        logoWrap.innerHTML = '<img src="' + esc(src) + '" alt="" style="width:100%; height:100%; object-fit:cover;" />';
      } else if(logoEmoji) {
        logoWrap.innerHTML = '<span id="pubProvLogoEmoji">🏢</span>';
      }
    }

    // Favorite Status
    const favBtn = document.getElementById('btnToggleFavProvider');
    if(favBtn){
      const isFav = providerFavs.has(pid);
      favBtn.innerHTML = `<i data-lucide="heart" style="width:22px;height:22px;color:#E34D4D;${isFav ? 'fill:#E34D4D;' : ''}"></i>`;
      favBtn.onclick = () => {
        toggleProviderFavorite(pid);
        renderPublicProviderProfile();
      };
    }

    // Teilen
    const shareBtn = document.getElementById('pubProvShare');
    if(shareBtn){
      shareBtn.onclick = () => {
        shareProviderMenu(pid);
      };
    }

    // Heute Angebote
    const today = isoDate(new Date());
    const todayOffers = provOffers.filter(o => o.day === today && o.active !== false);
    const todayList = document.getElementById('pubProvTodayOffers');
    if(todayList){
      if(todayOffers.length === 0){
        todayList.innerHTML = '<div class="pub-prov-empty">Heute keine Angebote verfügbar.</div>';
      } else {
        todayList.innerHTML = todayOffers.map(o => createPublicOfferRow(o)).join('');
      }
    }

    // Wochenplan
    const weekList = document.getElementById('pubProvWeekPlan');
    if(weekList){
      const futureOffers = provOffers.filter(o => o.day > today && o.active !== false).sort((a,b) => a.day.localeCompare(b.day));
      if(futureOffers.length === 0){
        weekList.innerHTML = '<div class="pub-prov-empty">Keine weiteren Angebote geplant.</div>';
      } else {
        weekList.innerHTML = futureOffers.map(o => createPublicOfferRow(o, true)).join('');
      }
    }

    if(typeof lucide !== 'undefined') lucide.createIcons();
  }

  function createPublicOfferRow(o, showDate = false){
    const norm = normalizeOffer(o);
    const dateLabel = showDate ? `<div style="font-size:11px; font-weight:800; color:var(--brand); text-transform:uppercase; margin-bottom:4px;">${fmtDay(o.day)}</div>` : '';
    return `
      <div class="cust-card pub-prov-offer-card" onclick="showDishDetail('${o.id}')" style="padding:16px; display:flex; gap:16px; align-items:center; cursor:pointer; background:#fff; border:1px solid rgba(0,0,0,0.04); border-radius:18px;">
        <div style="width:64px; height:64px; border-radius:14px; overflow:hidden; flex-shrink:0; background:#f1f3f5;">
          <img src="${o.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=200&q=80'}" alt="" style="width:100%; height:100%; object-fit:cover;">
        </div>
        <div style="flex:1; min-width:0;">
          ${dateLabel}
          <div style="font-weight:800; font-size:15px; color:#1a1a1a; margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${esc(o.dish)}</div>
          <div style="font-size:13px; color:#64748b; font-weight:600;">${o.pickupWindow || 'Mittags'} • ${euro(o.price)}</div>
        </div>
        <i data-lucide="chevron-right" style="width:20px;height:20px;color:#cbd5e1;flex-shrink:0;"></i>
      </div>
    `;
  }

  function toggleProviderFavorite(pid){
    if(providerFavs.has(pid)){
      providerFavs.delete(pid);
      showToast('Von Lieblingen entfernt');
    } else {
      providerFavs.add(pid);
      showToast('Zu Lieblingen hinzugefügt');
    }
    save(LS.providerFavs, Array.from(providerFavs));
    updateProfileView(); // Profil aktualisieren
  }

  function fmtDay(dateStr){
    const d = new Date(dateStr);
    const days = ['SO', 'MO', 'DI', 'MI', 'DO', 'FR', 'SA'];
    return days[d.getDay()] + ' ' + d.getDate() + '.' + (d.getMonth()+1) + '.';
  }

  function updateProfileView(){
    var pwaTipEl = document.getElementById('profilePwaTip');
    if(pwaTipEl) pwaTipEl.style.display = (localStorage.getItem('mittagio_pwa_tip_dismissed') === 'true') ? 'none' : 'block';
    var btnDismissPwa = document.getElementById('btnDismissPwaTip');
    if(btnDismissPwa && !btnDismissPwa._pwaBound){ btnDismissPwa._pwaBound = true; btnDismissPwa.onclick = function(){ try { localStorage.setItem('mittagio_pwa_tip_dismissed', 'true'); } catch(e) {} var el = document.getElementById('profilePwaTip'); if(el) el.style.display = 'none'; }; }
    const isLoggedIn = customer.loggedIn;
    const firstName = customer.name ? customer.name.split(' ')[0] : '';
    const fullName = customer.name || 'Gast';
    
    const initials = fullName.split(' ').map(n => n[0]?.toUpperCase() || '').join('').slice(0, 2) || '?';
    
    // Header-Card (Identität)
    const headerCard = document.getElementById('profileHeaderCard');
    if(headerCard){
      if(isLoggedIn){
        headerCard.innerHTML = `
          <div style="width:64px; height:64px; border-radius:24px; background:var(--brand); display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:900; color:#1a1a1a; box-shadow:0 8px 24px rgba(255,215,0,0.3); flex-shrink:0;">
            ${initials}
          </div>
          <div style="flex:1; min-width:0;">
            <div style="font-weight:950; font-size:22px; color:#1a1a1a; letter-spacing:-0.02em; line-height:1.2;">Hallo ${esc(firstName || 'Kunde')} 👋</div>
            <div style="font-size:14px; font-weight:600; color:#64748b; margin-top:2px;">Persönlicher Bereich</div>
          </div>
        `;
        // E-Mail in "Meine Daten" und im Zahnrad-Sheet anzeigen
        const emailDisp = document.getElementById('profileDisplayEmail');
        if(emailDisp) emailDisp.textContent = customer.email || '-';
        const emailSheet = document.getElementById('profileDisplayEmailSheet');
        if(emailSheet) emailSheet.textContent = customer.email || '-';
      } else {
        headerCard.innerHTML = `
          <div style="flex:1;">
            <div style="font-weight:950; font-size:22px; color:#1a1a1a; letter-spacing:-0.02em; line-height:1.2; margin-bottom:8px;">Willkommen 👋</div>
            <p style="font-size:14px; color:#64748b; line-height:1.5; margin:0 0 20px;">Melde dich an, um deine Bestellungen und die Mittagsbox zu speichern.</p>
            <button class="btn-cust-primary" type="button" id="btnProfileCreateAccount" style="height:48px; font-size:15px;">
              Profil anlegen
            </button>
          </div>
        `;
        const btn = document.getElementById('btnProfileCreateAccount');
        if(btn) btn.onclick = () => { openProfileCreateSheet(); };
      }
    }
    
    // Aktive Abholnummern
    const abholnummerSection = document.getElementById('profileAbholnummerSection');
    const abholnummerList = document.getElementById('profileActiveAbholnummernList');
    const today = isoDate(new Date());
    const allOrders = loadOrders();
    const activeAbholnummern = allOrders.filter(o => o.status === 'PAID' && o.pickupDate === today && !o.pickupCodeActivatedAt);

    const noAbholnummerHint = document.getElementById('profileNoAbholnummerHint');
    if(abholnummerSection && abholnummerList){
      if(activeAbholnummern.length > 0){
        abholnummerSection.style.display = 'block';
        if(noAbholnummerHint) noAbholnummerHint.style.display = 'none';
        abholnummerList.innerHTML = activeAbholnummern.map(order => {
          const code = order.pickupCode || '–';
          return `
            <div class="cust-card" style="flex-direction:row; padding:24px; align-items:center; gap:20px; margin-bottom:0; border:2px solid rgba(255,215,0,0.35); background:rgba(255,215,0,0.08); border-radius:20px; cursor:pointer;" onclick="showPickupCode('${esc(order.id)}');">
              <div style="width:56px; height:56px; border-radius:16px; background:var(--brand); display:flex; align-items:center; justify-content:center; font-size:28px;">🧾</div>
              <div style="flex:1; min-width:0;">
                <div style="font-weight:950; font-size:28px; color:#1a1a1a; letter-spacing:3px; font-family:monospace; line-height:1.2;">${esc(code)}</div>
                <div style="font-size:14px; font-weight:600; color:#64748b; margin-top:6px;">${esc(order.providerName || 'Anbieter')}</div>
              </div>
              <i data-lucide="chevron-right" style="width:24px;height:24px; color:var(--brand);"></i>
            </div>
          `;
        }).join('');
      } else {
        abholnummerSection.style.display = 'none';
        if(noAbholnummerHint) noAbholnummerHint.style.display = 'block';
      }
    } else if(noAbholnummerHint) noAbholnummerHint.style.display = 'block';

    // Historie (letzte 2)
    const orderHistoryEl = document.getElementById('profileOrderHistoryList');
    if(orderHistoryEl){
      const sorted = (allOrders || []).slice().sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      if(sorted.length === 0){
        orderHistoryEl.innerHTML = '<p style="margin:0; color:#64748b; font-size:14px; text-align:center; padding:10px 0;">Noch keine Bestellungen.</p>';
      } else {
        const firstTwo = sorted.slice(0, 2);
        orderHistoryEl.innerHTML = firstTwo.map(o => `
          <div class="profile-order-item" onclick="showOrderDetail('${o.id}')" style="padding:12px 0; border-bottom:1px solid #f1f3f5; display:flex; align-items:center; gap:12px; cursor:pointer;">
            <div style="width:40px; height:40px; border-radius:10px; background:#f8f9fa; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:18px;">🍽️</div>
            <div style="flex:1; min-width:0;">
              <div style="font-weight:700; font-size:14px; color:#1a1a1a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${esc(o.dishName || 'Gericht')}</div>
              <div style="font-size:12px; color:#64748b;">${esc(o.providerName || 'Anbieter')} • ${o.pickupDate || ''}</div>
            </div>
            <div style="font-weight:800; font-size:14px; color:var(--brand);">${euro(Number(o.total||0)/100)}</div>
          </div>
        `).join('');
      }
    }

    // Deine Lieblinge (Anbieter) – Hauptseite + Sheet
    const favListEl = document.getElementById('profileFavProvidersList');
    const favListSheet = document.getElementById('profileFavProvidersListSheet');
    const favHtml = (() => {
      const allOffers = load(LS.offers, []);
      const myFavProviders = Array.from(providerFavs || []).map(pid => {
        const o = allOffers.find(x => x.providerId === pid);
        return { id: pid, name: o ? o.providerName : 'Anbieter' };
      });
      if(myFavProviders.length === 0) return '<p style="margin:0; color:#64748b; font-size:13px; text-align:center;">Noch keine Lieblinge gespeichert.</p>';
      return myFavProviders.map(p => `
        <div onclick="closeProfileSettingsSheet(); showProviderProfilePublic('${p.id}')" style="display:flex; align-items:center; justify-content:space-between; padding:10px 14px; background:#fff; border-radius:12px; border:1px solid #f1f3f5; cursor:pointer;">
          <div style="display:flex; align-items:center; gap:10px;">
            <div style="width:32px; height:32px; border-radius:8px; background:#f8f9fa; display:flex; align-items:center; justify-content:center; font-size:14px;">🏢</div>
            <span style="font-weight:700; font-size:14px; color:#1a1a1a;">${esc(p.name)}</span>
          </div>
          <i data-lucide="chevron-right" style="width:16px;height:16px;color:#cbd5e1;"></i>
        </div>
      `).join('');
    })();
    if(favListEl) favListEl.innerHTML = favHtml;
    if(favListSheet) favListSheet.innerHTML = favHtml;

    // Ernährungs-Profil (Checkboxes) – Hauptseite + Sheet
    const dietSection = document.getElementById('profileDietCheckboxes');
    const dietSheet = document.getElementById('profileDietCheckboxesSheet');
    const prefs = customer.dietaryPreferences || {};
    const isReuseEnabled = customer.reuseEnabled || false;
    const dietSwitches = [
      { key: 'vegan', label: 'Vegan', icon: 'leaf' },
      { key: 'vegetarian', label: 'Vegetarisch', icon: 'sprout' },
      { key: 'reuse', label: 'Mehrweg', icon: 'refresh-cw' }
    ];
    const dietHtml = dietSwitches.map(s => {
      const checked = s.key === 'reuse' ? isReuseEnabled : prefs[s.key];
      const changeHandler = s.key === 'reuse' ? `toggleReuseOption(this.checked)` : `toggleDietaryPreference('${s.key}', this.checked)`;
      return `
        <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background:#f8f9fa; border-radius:14px;">
          <div style="display:flex; align-items:center; gap:10px;">
            <i data-lucide="${s.icon}" style="width:18px;height:18px;color:#64748b;"></i>
            <span style="font-weight:700; font-size:14px; color:#1a1a1a;">${s.label}</span>
          </div>
          <label class="switch-mini">
            <input type="checkbox" ${checked ? 'checked' : ''} onchange="${changeHandler}">
            <span class="slider-mini"></span>
          </label>
        </div>
      `;
    }).join('');
    if(dietSection) dietSection.innerHTML = dietHtml;
    if(dietSheet) dietSheet.innerHTML = dietHtml;

    // FAQ Accordion (Die 3 wichtigsten) – Hauptseite + Sheet
    const faqEl = document.getElementById('profileTopFaq');
    const faqSheet = document.getElementById('profileTopFaqSheet');
    const faqs = [
      { q: 'Wie funktioniert die Abholnummer?', a: 'Deine Abholnummer ist dein digitaler Bon. Zeige sie einfach beim Anbieter vor Ort auf deinem Smartphone vor.', icon: 'receipt' },
      { q: 'Was mache ich bei Problemen?', a: 'Wende dich bitte direkt an das Personal vor Ort. Deine Abholnummer ist dein Zahlungsbeleg.', icon: 'help-circle' },
      { q: 'Wo finde ich Mehrweg-Optionen?', a: 'Achte auf das 🔄-Icon beim Gericht. Wir bauen unser Mehrweg-Netzwerk stetig aus.', icon: 'refresh-cw' }
    ];
    const faqHtml = faqs.map(f => `
      <div style="border-radius:14px; border:1px solid #f1f3f5; overflow:hidden;">
        <button onclick="const a = this.nextElementSibling; a.style.display = a.style.display === 'none' ? 'block' : 'none';" style="width:100%; padding:14px; background:#f8f9fa; border:none; display:flex; align-items:center; gap:12px; cursor:pointer; text-align:left;">
          <i data-lucide="${f.icon}" style="width:18px;height:18px;color:#64748b;"></i>
          <span style="flex:1; font-size:14px; font-weight:700; color:#1a1a1a;">${f.q}</span>
          <i data-lucide="chevron-down" style="width:16px;height:16px;color:#cbd5e1;"></i>
        </button>
        <div style="display:none; padding:14px; font-size:14px; line-height:1.5; color:#64748b; background:#fff;">
          ${f.a}
        </div>
      </div>
    `).join('');
    if(faqEl) faqEl.innerHTML = faqHtml;
    if(faqSheet) faqSheet.innerHTML = faqHtml;

    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }

  // Toggle Profile Section
  function toggleProfileSection(id, btn){
    const el = document.getElementById(id);
    if(!el) return;
    const isHidden = el.style.display === 'none';
    el.style.display = isHidden ? 'block' : 'none';
    
    // Chevron drehen
    if(btn){
      const chevron = btn.querySelector('.chevron');
      if(chevron) chevron.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
    }
  }

  // Zahnrad-Menü (Einstellungen-Sheet) öffnen/schließen
  function openProfileSettingsSheet(){
    const bd = document.getElementById('profileSettingsSheetBd');
    const sheet = document.getElementById('profileSettingsSheet');
    const scrollEl = document.getElementById('profileSettingsSheetScroll');
    if(bd){ bd.style.display = 'block'; bd.style.opacity = '1'; }
    if(sheet) sheet.style.display = 'block';
    if(scrollEl) scrollEl.scrollTop = 0;
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }
  function closeProfileSettingsSheet(){
    const bd = document.getElementById('profileSettingsSheetBd');
    const sheet = document.getElementById('profileSettingsSheet');
    if(bd){ bd.style.display = 'none'; bd.style.opacity = '0'; }
    if(sheet){ sheet.style.display = 'none'; }
  }
  function toggleProfileSettingsSection(sectionId){
    const el = document.getElementById(sectionId);
    if(!el) return;
    const isHidden = el.style.display === 'none';
    el.style.display = isHidden ? 'block' : 'none';
    const chevrons = document.querySelectorAll('.profile-sheet-chevron[data-section="' + sectionId + '"]');
    chevrons.forEach(c => { c.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)'; });
    var scrollEl = document.getElementById('profileSettingsSheetScroll');
    if(scrollEl) scrollEl.scrollTop = 0;
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }
  function openProfilePwaTipSheet(){
    var bd = document.getElementById('pwaStartScreenBd');
    var sheet = document.getElementById('pwaStartScreenSheet');
    if(bd){ bd.style.display = 'block'; bd.classList.add('active'); }
    if(sheet){ sheet.style.display = 'block'; sheet.classList.add('active'); }
    if(typeof lucide !== 'undefined') setTimeout(function(){ lucide.createIcons(); }, 50);
  }
  function closePwaStartScreenSheet(){
    var bd = document.getElementById('pwaStartScreenBd');
    var sheet = document.getElementById('pwaStartScreenSheet');
    if(bd){ bd.style.display = 'none'; bd.classList.remove('active'); }
    if(sheet){ sheet.style.display = 'none'; sheet.classList.remove('active'); }
  }
  if(typeof window !== 'undefined'){ window.openProfilePwaTipSheet = openProfilePwaTipSheet; window.closePwaStartScreenSheet = closePwaStartScreenSheet; }
  var pwaDeferredPrompt = null;
  var pwaBannerShownThisSession = false;
  window.addEventListener('beforeinstallprompt', function(e){
    e.preventDefault();
    pwaDeferredPrompt = e;
    // Einmal pro Session unser Sheet zeigen, damit Nutzer „Zum Startbildschirm hinzufügen“ tippen kann (dann wird prompt() aufgerufen).
    if(!pwaBannerShownThisSession && typeof openProfilePwaTipSheet === 'function'){
      pwaBannerShownThisSession = true;
      setTimeout(function(){ openProfilePwaTipSheet(); }, 1500);
    }
  });
  var pwaSheetInstallBtn = document.getElementById('pwaSheetInstallBtn');
  if(pwaSheetInstallBtn){
    pwaSheetInstallBtn.onclick = function(){
      if(pwaDeferredPrompt){
        pwaDeferredPrompt.prompt();
        pwaDeferredPrompt.userChoice.then(function(choice){ if(choice.outcome === 'accepted') closePwaStartScreenSheet(); });
      } else {
        if(typeof showToast === 'function') showToast('Im Browser: Menü ⋮ → „Zum Startbildschirm hinzufügen“', 3500);
        closePwaStartScreenSheet();
      }
    };
  }
  
  // Ernährungs-Präferenz Toggle
  function toggleDietaryPreference(key, value){
    if(!customer.dietaryPreferences) customer.dietaryPreferences = { vegan: false, vegetarian: false, glutenFree: false, lactoseFree: false };
    if(customer.reuseEnabled === undefined) customer.reuseEnabled = false;
    customer.dietaryPreferences[key] = value;
    save(LS.customer, customer);
    updateProfileView();
    
    // Feed sofort neu rendern mit Filter
    if(typeof renderDiscover === 'function'){
      renderDiscover();
    }
  }
  
  // Mehrweg-Option Toggle
  function toggleReuseOption(enabled){
    customer.reuseEnabled = enabled;
    save(LS.customer, customer);
    updateProfileView();
    
    if(enabled){
      showToast('Mehrweg-Option aktiviert 🌱', 2000);
    } else {
      showToast('Mehrweg-Option deaktiviert', 1500);
    }
  }
  
  // Support-Actions Handler
  function handleSupportAction(action){
    if(action === 'openHelp'){
      // Kunden-Hilfe: info@mittagio.de (Mike Quach, Rudersberg)
      showToast('Kunden-Hilfe: info@mittagio.de', 2000);
      // E-Mail-Client öffnen
      window.location.href = 'mailto:info@mittagio.de?subject=Hilfe%20bei%20Mittagio';
    } else if(action === 'showDatenschutz'){
      showView(views.legalDatenschutz);
    } else if(action === 'showImpressum'){
      showView(views.legalImpressum);
    } else if(action === 'logout'){
      if(confirm('Möchtest du dich wirklich abmelden?')){
        customer.loggedIn = false;
        customer.name = null;
        customer.email = null;
        save(LS.customer, customer);
        updateProfileView();
      }
    }
  }
  
  // Provider Login Modal (Backdrop + Sheet brauchen Klasse "active" für Sichtbarkeit)
  function showProviderLoginModal(){
    const providerLoginBd = document.getElementById('providerLoginBd');
    const providerLoginSheet = document.getElementById('providerLoginSheet');
    if(providerLoginBd){ providerLoginBd.style.display = 'block'; providerLoginBd.classList.add('active'); }
    if(providerLoginSheet){ providerLoginSheet.style.display = 'block'; providerLoginSheet.classList.add('active'); }
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }
  
  function closeProviderLoginModal(){
    const providerLoginBd = document.getElementById('providerLoginBd');
    const providerLoginSheet = document.getElementById('providerLoginSheet');
    if(providerLoginBd){ providerLoginBd.style.display = 'none'; providerLoginBd.classList.remove('active'); }
    if(providerLoginSheet){ providerLoginSheet.style.display = 'none'; providerLoginSheet.classList.remove('active'); }
    // Felder leeren
    const emailField = document.getElementById('providerLoginEmail');
    const passField = document.getElementById('providerLoginPass');
    if(emailField) emailField.value = '';
    if(passField) passField.value = '';
  }
  if(typeof window !== 'undefined'){
    window.showProviderLoginModal = showProviderLoginModal;
    window.closeProviderLoginModal = closeProviderLoginModal;
  }
  var btnProfileProviderPortalEl = document.getElementById('btnProfileProviderPortal');
  if(btnProfileProviderPortalEl){
    btnProfileProviderPortalEl.addEventListener('click', function(e){
      e.preventDefault();
      e.stopPropagation();
      showProviderLoginModal();
    });
  }
  
  // Provider Login Handler
  const btnProviderLoginModal = document.getElementById('btnProviderLoginModal');
  if(btnProviderLoginModal){
    btnProviderLoginModal.onclick = () => {
      const email = document.getElementById('providerLoginEmail').value.trim();
      const pass = document.getElementById('providerLoginPass').value.trim();
      if(!email || !pass){
        showToast('Bitte E-Mail und Passwort eingeben.', 2000);
        return;
      }
      
      // Session-Check: Prüfe ob bereits eine aktive Session existiert
      const existingSession = load(LS.providerSession, null);
      const currentSessionId = load('mittagio_current_session_id', null);
      
      // Wenn bereits eine Session existiert und es ist nicht die aktuelle Session
      if(existingSession && existingSession.email === email && existingSession.sessionId !== currentSessionId){
        // Login-Konflikt: Zeige Modal
        openLoginConflictModal(email, () => {
          // Übernahme bestätigt: Neue Session erstellen
          performProviderLogin(email);
        });
        return;
      }
      
      // Normale Login-Durchführung
      performProviderLogin(email);
    };
  }
  
  // Provider-Login durchführen (mit Single-Session: Session-ID in DB + Cookie)
  function performProviderLogin(email){
    const newSessionId = cryptoId();
    const sessionData = {
      email: email,
      sessionId: newSessionId,
      createdAt: Date.now(),
      lastActivity: Date.now()
    };
    save(LS.providerSession, sessionData);
    save('mittagio_current_session_id', newSessionId);
    setCookie(SESSION_COOKIE_NAME, newSessionId, SESSION_COOKIE_DAYS);
    provider.loggedIn = true;
    provider.email = email;
    provider.current_session_id = newSessionId;
    if(email === 'demo@mittagio.de' || email === 'thomas@thomas-kurz.de'){
      var demoProfile = load('mittagio_demo_provider_profile', null);
      if(demoProfile){
        provider.profile = provider.profile || {};
        provider.profile.name = demoProfile.name || provider.profile.name;
        provider.profile.address = demoProfile.address || provider.profile.address;
        provider.profile.street = demoProfile.street || provider.profile.street;
        provider.profile.zip = demoProfile.zip || provider.profile.zip;
        provider.profile.city = demoProfile.city || provider.profile.city;
        provider.profile.logoData = demoProfile.logoData != null ? demoProfile.logoData : provider.profile.logoData;
        provider.profile.mealWindow = demoProfile.mealWindow || provider.profile.mealWindow;
        if(demoProfile.phone != null) provider.profile.phone = demoProfile.phone;
        if(demoProfile.email != null) provider.profile.email = demoProfile.email;
        if(demoProfile.website != null) provider.profile.website = demoProfile.website;
        if(demoProfile.mealStart != null) provider.profile.mealStart = demoProfile.mealStart;
        if(demoProfile.mealEnd != null) provider.profile.mealEnd = demoProfile.mealEnd;
      }
    }
    save(LS.provider, provider);
    closeProviderLoginModal();
    showToast('Erfolgreich eingeloggt! 🎉', 2000);
    if(typeof updateProfileView === 'function') updateProfileView();
    setMode('provider', { skipView: true });
    if(provider.onboardingCompleted){
      showProviderHome();
    } else {
      showOnboardingEntry(!!load(LS.onboardingDraft, null));
    }
  }
  
  // Login-Konflikt Modal öffnen
  function openLoginConflictModal(email, onConfirm){
    const bd = document.getElementById('loginConflictBd');
    const sheet = document.getElementById('loginConflictSheet');
    if(bd) bd.classList.add('active');
    if(sheet) sheet.classList.add('active');
    
    // Übernahme-Button Handler
    const btnTakeover = document.getElementById('btnLoginConflictTakeover');
    if(btnTakeover){
      btnTakeover.onclick = () => {
        closeLoginConflictModal();
        if(onConfirm) onConfirm();
      };
    }
    
    // Icons rendern
    if(typeof lucide !== 'undefined'){
      setTimeout(() => lucide.createIcons(), 50);
    }
  }
  
  // Login-Konflikt Modal schließen
  function closeLoginConflictModal(){
    const bd = document.getElementById('loginConflictBd');
    const sheet = document.getElementById('loginConflictSheet');
    if(bd) bd.classList.remove('active');
    if(sheet) sheet.classList.remove('active');
  }
  
  // Single-Session-Middleware: Cookie mit current_session_id in DB vergleichen
  function checkSingleSession(){
    if(mode !== 'provider' || !provider.loggedIn) return true;
    const cookieSessionId = getCookie(SESSION_COOKIE_NAME);
    const dbSessionId = provider.current_session_id || load('mittagio_current_session_id', null);
    if(cookieSessionId && dbSessionId && cookieSessionId === dbSessionId){
      return true;
    }
    deleteCookie(SESSION_COOKIE_NAME);
    localStorage.removeItem(LS.providerSession);
    localStorage.removeItem('mittagio_current_session_id');
    provider.loggedIn = false;
    provider.current_session_id = null;
    save(LS.provider, provider);
    showToast('Du wurdest auf einem anderen Gerät angemeldet.', 4000);
    setMode('provider');
    showView(views.providerLogin);
    return false;
  }

  // Session-Validität prüfen (bei App-Start und regelmäßig) – nutzt checkSingleSession
  function checkSessionValidity(){
    if(mode !== 'provider' || !provider.loggedIn) return true;
    if(!checkSingleSession()) return false;
    const currentSessionId = getCookie(SESSION_COOKIE_NAME) || load('mittagio_current_session_id', null);
    const storedSession = load(LS.providerSession, null);
    if(!currentSessionId || !storedSession || storedSession.sessionId !== currentSessionId){
      provider.loggedIn = false;
      provider.current_session_id = null;
      save(LS.provider, provider);
      deleteCookie(SESSION_COOKIE_NAME);
      localStorage.removeItem('mittagio_current_session_id');
      showToast('Du wurdest auf einem anderen Gerät angemeldet.', 4000);
      setMode('provider');
      showView(views.providerLogin);
      return false;
    }
    if(storedSession.email === provider.email){
      storedSession.lastActivity = Date.now();
      save(LS.providerSession, storedSession);
    }
    return true;
  }
  
  // Session-Aktivität aktualisieren (bei User-Interaktionen)
  function updateSessionActivity(){
    if(mode === 'provider' && provider.loggedIn){
      const storedSession = load(LS.providerSession, null);
      const currentSessionId = load('mittagio_current_session_id', null);
      if(storedSession && storedSession.sessionId === currentSessionId){
        storedSession.lastActivity = Date.now();
        save(LS.providerSession, storedSession);
      }
    }
  }
  
  // Session-Aktivität bei wichtigen Aktionen aktualisieren
  // (wird bei renderProviderHome, renderProviderPickups, etc. aufgerufen)
  
  // Session-Check regelmäßig durchführen (alle 30 Sekunden)
  setInterval(() => {
    if(mode === 'provider' && provider.loggedIn){
      checkSessionValidity();
    }
  }, 30000);
  
  // Enter-Taste im Login-Modal
  const providerLoginEmail = document.getElementById('providerLoginEmail');
  const providerLoginPass = document.getElementById('providerLoginPass');
  if(providerLoginEmail && providerLoginPass){
    [providerLoginEmail, providerLoginPass].forEach(field => {
      field.onkeydown = (e) => {
        if(e.key === 'Enter'){
          e.preventDefault();
          if(btnProviderLoginModal) btnProviderLoginModal.click();
        }
      };
    });
  }

  // Logout-Handler (wenn vorhanden)
  const btnUnifiedLogout = document.getElementById('btnUnifiedLogout');
  if(btnUnifiedLogout){
    btnUnifiedLogout.onclick=()=>{
      customer.loggedIn = false;
      customer.name = null;
      customer.email = null;
      save(LS.customer, customer);
      updateProfileView();
      showProfile();
    };
  }

  // Provider Switch (wenn vorhanden)
  const btnSwitchToProvider = document.getElementById('btnSwitchToProvider');
  if(btnSwitchToProvider){
    btnSwitchToProvider.onclick=()=>{
      if(!provider.loggedIn){
        setMode('provider');
      } else {
        showProviderHome();
      }
    };
  }

  // --- Hybrid Onboarding System ---
  let onboardingDraftDish = load(LS.onboardingDraft, null);
  
  function showOnboardingEntry(hasDraft = false){
    showView(views.providerOnboardingEntry);
    
    // Show returning banner if draft exists
    const entryPanel = document.getElementById('onboardingEntryPanel') || document.querySelector('#v-provider-onboarding-entry .panel');
    if(hasDraft && onboardingDraftDish && entryPanel){
      const banner = document.createElement('div');
      banner.style.cssText = 'margin-bottom:24px; padding:16px; background:#f0f7f0; border-radius:12px; border:1px solid #4caf50;';
      banner.innerHTML = `
        <div style="font-weight:600; font-size:16px; margin-bottom:8px; color:#2e7d32;">Du hast ein Gericht vorbereitet</div>
        <div style="font-size:14px; line-height:1.4; margin-bottom:12px; color:#666;">Möchtest du weitermachen?</div>
        <div style="display:flex; gap:8px;">
          <button class="btn secondary" type="button" id="btnOnboardingResume" style="flex:1; min-height:44px;">Weiter bearbeiten</button>
          <button class="btn ghost" type="button" id="btnOnboardingDiscard" style="flex:1; min-height:44px;">Verwerfen</button>
        </div>
      `;
      entryPanel.insertBefore(banner, entryPanel.firstChild);
      
      const btnResume = document.getElementById('btnOnboardingResume');
      const btnDiscard = document.getElementById('btnOnboardingDiscard');
      if(btnResume) btnResume.onclick = () => showOnboardingFirstDish(true);
      if(btnDiscard) btnDiscard.onclick = () => {
        onboardingDraftDish = null;
        save(LS.onboardingDraft, null);
        showOnboardingEntry(false);
      };
    }
  }
  
  function showOnboardingFirstDish(prefill = false){
    showView(views.providerOnboardingFirstDish);
    
    // Push state for browser back button
    pushViewState({onboarding: 'first-dish'}, location.pathname);
    
    if(prefill && onboardingDraftDish){
      const dishName = document.getElementById('onboardingDishName');
      const timeStart = document.getElementById('onboardingPickupTimeStart');
      const timeEnd = document.getElementById('onboardingPickupTimeEnd');
      const photoPreview = document.getElementById('onboardingPhotoPreview');
      const photoPreviewImg = document.getElementById('onboardingPhotoPreviewImg');
      
      if(dishName) dishName.value = onboardingDraftDish.dishName || '';
      if(timeStart) timeStart.value = onboardingDraftDish.pickupTimeStart || '';
      if(timeEnd) timeEnd.value = onboardingDraftDish.pickupTimeEnd || '';
      if(onboardingDraftDish.photoData && photoPreview && photoPreviewImg){
        photoPreview.style.display = 'block';
        photoPreviewImg.src = onboardingDraftDish.photoData;
      }
    }
    
    // Photo upload handler (recreate each time to avoid duplicates)
    const existingInput = document.getElementById('onboardingPhotoInput');
    if(existingInput) existingInput.remove();
    
    const photoInput = document.createElement('input');
    photoInput.id = 'onboardingPhotoInput';
    photoInput.type = 'file';
    photoInput.accept = 'image/*';
    photoInput.style.display = 'none';
    document.body.appendChild(photoInput);
    
    // Profi-Galerie System
    const foodLibrary = {
      klassiker: [
        {id: 'schnitzel', name: 'Schnitzel', url: 'https://images.unsplash.com/photo-1562967914-608f82629710?auto=format&fit=crop&w=800&q=80', allergens: ['Gluten', 'Ei']},
        {id: 'bratwurst', name: 'Bratwurst', url: 'https://images.unsplash.com/photo-1528607929212-2636ec44253e?auto=format&fit=crop&w=800&q=80', allergens: ['Gluten']},
        {id: 'roulade', name: 'Roulade', url: 'https://images.unsplash.com/photo-1546833999-b9f581a1996d?auto=format&fit=crop&w=800&q=80', allergens: ['Gluten']}
      ],
      deftig: [
        {id: 'gulasch', name: 'Gulasch', url: 'https://images.unsplash.com/photo-1563379091339-03246963d19c?auto=format&fit=crop&w=800&q=80', allergens: []},
        {id: 'braten', name: 'Braten', url: 'https://images.unsplash.com/photo-1544025162-d76694265947?auto=format&fit=crop&w=800&q=80', allergens: []},
        {id: 'kassler', name: 'Kassler', url: 'https://images.unsplash.com/photo-1544025162-d76694265947?auto=format&fit=crop&w=800&q=80', allergens: []}
      ],
      eintoepfe: [
        {id: 'linsensuppe', name: 'Linsensuppe', url: 'https://images.unsplash.com/photo-1547592166-23ac45744acd?auto=format&fit=crop&w=800&q=80', allergens: []},
        {id: 'erbsensuppe', name: 'Erbsensuppe', url: 'https://images.unsplash.com/photo-1547592166-23ac45744acd?auto=format&fit=crop&w=800&q=80', allergens: []},
        {id: 'kartoffelsuppe', name: 'Kartoffelsuppe', url: 'https://images.unsplash.com/photo-1547592166-23ac45744acd?auto=format&fit=crop&w=800&q=80', allergens: []}
      ],
      modern: [
        {id: 'bowl', name: 'Bowl', url: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=800&q=80', allergens: []},
        {id: 'wrap', name: 'Wrap', url: 'https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=800&q=80', allergens: ['Gluten']},
        {id: 'salat', name: 'Salat', url: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=800&q=80', allergens: []}
      ]
    };
    
    let selectedProPhoto = null;
    let recentProPhotos = JSON.parse(localStorage.getItem('mittagio_recent_pro_photos') || '[]');
    
    // Profi-Galerie Funktionen (global, damit onclick funktioniert)
    window.openProPhotoGallery = function(){
      const proPhotoBd = document.getElementById('proPhotoBd');
      const proPhotoSheet = document.getElementById('proPhotoSheet');
      if(proPhotoBd) proPhotoBd.style.display = 'block';
      if(proPhotoSheet) proPhotoSheet.style.display = 'flex';
      window.renderProPhotoGallery('all');
    };
    
    window.closeProPhotoGallery = function(){
      const proPhotoBd = document.getElementById('proPhotoBd');
      const proPhotoSheet = document.getElementById('proPhotoSheet');
      if(proPhotoBd) proPhotoBd.style.display = 'none';
      if(proPhotoSheet) proPhotoSheet.style.display = 'none';
    };
    
    window.renderProPhotoGallery = function(category){
      const gridEl = document.getElementById('proPhotoGrid');
      if(!gridEl) return;
      
      // Kategorien-Tabs aktualisieren
      document.querySelectorAll('.pro-photo-category-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.category === category);
        tab.style.background = tab.dataset.category === category ? '#FFD700' : '#f5f5f5';
        tab.style.color = tab.dataset.category === category ? '#2D3436' : '#666';
      });
      
      // Zuletzt genutzt anzeigen (wenn vorhanden)
      const recentEl = document.getElementById('proPhotoRecent');
      const recentGridEl = document.getElementById('proPhotoRecentGrid');
      if(recentEl && recentGridEl){
        if(recentProPhotos.length > 0 && category === 'all'){
          recentEl.style.display = 'block';
          recentGridEl.innerHTML = recentProPhotos.slice(0, 4).map(photo => {
            return `
              <div onclick="selectProPhoto('${photo.id}', '${esc(photo.url)}', '${esc(photo.category)}');" style="aspect-ratio:1; border-radius:12px; overflow:hidden; cursor:pointer; border:2px solid #FFD700;">
                <img src="${esc(photo.url)}" alt="${esc(photo.name)}" style="width:100%; height:100%; object-fit:cover;" />
              </div>
            `;
          }).join('');
        } else {
          recentEl.style.display = 'none';
        }
      }
      
      // Galerie rendern
      let photos = [];
      if(category === 'all'){
        Object.values(foodLibrary).flat().forEach(p => photos.push({...p, category: Object.keys(foodLibrary).find(k => foodLibrary[k].includes(p))}));
      } else {
        photos = foodLibrary[category] || [];
      }
      
      gridEl.innerHTML = photos.map(photo => {
        const cat = (photo.category || category);
        return `
          <div onclick="selectProPhoto('${photo.id}', '${esc(photo.url)}', '${cat}');" style="aspect-ratio:1; border-radius:12px; overflow:hidden; cursor:pointer; border:2px solid #e7e1d5; transition:all 0.2s;" onmouseover="this.style.borderColor='#FFD700'; this.style.transform='scale(1.05)';" onmouseout="this.style.borderColor='#e7e1d5'; this.style.transform='scale(1)';">
            <img src="${esc(photo.url)}" alt="${esc(photo.name)}" style="width:100%; height:100%; object-fit:cover;" />
          </div>
        `;
      }).join('');
    };
    
    window.selectProPhoto = function(photoId, photoUrl, category){
      selectedProPhoto = {id: photoId, url: photoUrl, category: category, isStockPhoto: true};
      
      const catKey = (typeof category === 'string' && category !== 'all') ? category : Object.keys(foodLibrary).find(k => (foodLibrary[k] || []).some(p => p.id === photoId)) || 'all';
      const photoName = (foodLibrary[catKey] || []).find(p => p.id === photoId)?.name || 'Gericht';
      recentProPhotos = recentProPhotos.filter(p => p.id !== photoId);
      recentProPhotos.unshift({id: photoId, url: photoUrl, category: catKey, name: photoName});
      recentProPhotos = recentProPhotos.slice(0, 10);
      localStorage.setItem('mittagio_recent_pro_photos', JSON.stringify(recentProPhotos));
      
      window.closeProPhotoGallery();
      
      // Immer durch Foto-Editor: Filter + Zuschnitt. Listing vs Onboarding unterscheiden.
      (async ()=>{
        let dataUrl = photoUrl;
        if(/^https?:\/\//i.test(photoUrl)){
          try { dataUrl = await urlToDataUrl(photoUrl); } catch(e){
            if(typeof showToast === 'function') showToast('Foto konnte nicht geladen werden.');
            return;
          }
        }
        if(window.proPhotoContext === 'listing'){
          window.proPhotoContext = null;
          await openPhotoEditor(dataUrl);
          if(typeof showToast === 'function') showToast('Profi-Foto übernommen.');
          return;
        }
        await openPhotoEditor(dataUrl, {
          onAccept: (url)=>{
            if(typeof onboardingDraftDish === 'undefined') return;
            onboardingDraftDish = onboardingDraftDish || {};
            onboardingDraftDish.photoData = url;
            if(typeof save === 'function' && typeof LS !== 'undefined') save(LS.onboardingDraft, onboardingDraftDish);
            const previewEl = document.getElementById('onboardingPhotoPreview');
            const previewImgEl = document.getElementById('onboardingPhotoPreviewImg');
            const watermarkEl = document.getElementById('onboardingPhotoWatermark');
            if(previewEl && previewImgEl){
              previewEl.style.display = 'block';
              previewImgEl.src = url;
              previewImgEl.style.filter = '';
              if(watermarkEl) watermarkEl.style.display = 'block';
            }
            if(typeof showToast === 'function') showToast('Profi-Foto übernommen.');
          }
        });
      })();
    };
    
    // Kategorien-Tab Handler
    document.querySelectorAll('.pro-photo-category-tab').forEach(tab => {
      tab.onclick = () => {
        window.renderProPhotoGallery(tab.dataset.category);
      };
    });
    
    // Profi-Galerie Button Handler
    const btnOnboardingChooseProPhoto = document.getElementById('btnOnboardingChooseProPhoto');
    if(btnOnboardingChooseProPhoto){
      btnOnboardingChooseProPhoto.onclick = () => {
        window.openProPhotoGallery();
      };
    }
    
    const btnAddPhoto = document.getElementById('btnOnboardingAddPhoto');
    if(btnAddPhoto){
      btnAddPhoto.onclick = () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.capture = 'environment';
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if(!file) return;
          const dataUrl = await toDataUrl(file);
          await openPhotoEditor(dataUrl, {
            onAccept: (url) => {
              if(typeof onboardingDraftDish === 'undefined') return;
              onboardingDraftDish = onboardingDraftDish || {};
              onboardingDraftDish.photoData = url;
              if(typeof save === 'function' && typeof LS !== 'undefined') save(LS.onboardingDraft, onboardingDraftDish);
              const previewEl = document.getElementById('onboardingPhotoPreview');
              const previewImgEl = document.getElementById('onboardingPhotoPreviewImg');
              const watermarkEl = document.getElementById('onboardingPhotoWatermark');
              if(previewEl && previewImgEl){
                previewEl.style.display = 'block';
                previewImgEl.src = url;
                previewImgEl.style.filter = '';
                if(watermarkEl) watermarkEl.style.display = 'none';
              }
              selectedProPhoto = null;
              if(typeof showToast === 'function') showToast('Foto übernommen.');
            }
          });
        };
        input.click();
      };
    }
    
    // photoInput.onchange
    const existingPhotoInput = document.getElementById('photoInput');
    if(existingPhotoInput){
      existingPhotoInput.onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const dataUrl = await toDataUrl(file);
        await openPhotoEditor(dataUrl, {
          onAccept: (url) => {
            if(!onboardingDraftDish) onboardingDraftDish = {};
            onboardingDraftDish.photoData = url;
            if(typeof save === 'function' && typeof LS !== 'undefined') save(LS.onboardingDraft, onboardingDraftDish);
            const photoPreview = document.getElementById('onboardingPhotoPreview');
            const photoPreviewImg = document.getElementById('onboardingPhotoPreviewImg');
            if(photoPreview && photoPreviewImg){
              photoPreview.style.display = 'block';
              photoPreviewImg.src = url;
            }
            if(typeof showToast === 'function') showToast('Foto übernommen.');
          }
        });
      };
    }
    
    // Warn before leaving if changes exist
    let hasChanges = false;
    const inputs = ['onboardingDishName', 'onboardingPickupTimeStart', 'onboardingPickupTimeEnd'];
    inputs.forEach(id => {
      const el = document.getElementById(id);
      if(el){
        el.oninput = () => { hasChanges = true; };
      }
    });
    
    window.onbeforeunload = (e) => {
      if(hasChanges && onboardingDraftDish){
        e.preventDefault();
        e.returnValue = '';
      }
    };
  }
  
  function showOnboardingSignup(){
    showView(views.providerOnboardingSignup);
    pushViewState({onboarding: 'signup'}, location.pathname);
  }
  
  function showOnboardingBusiness(){
    showView(views.providerOnboardingBusiness);
    pushViewState({onboarding: 'business'}, location.pathname);
  }
  
  function showOnboardingPreview(dishId){
    showView(views.providerOnboardingPreview);
    pushViewState({onboarding: 'preview'}, location.pathname);
    
    // Load saved dish and show preview
    const savedDish = dishId ? cookbook.find(c => c.id === dishId) : cookbook.find(c => c.providerId === providerId());
    const previewCard = document.getElementById('onboardingPreviewCard');
    if(previewCard && (savedDish || onboardingDraftDish)){
      const dish = savedDish || {
        dish: onboardingDraftDish.dishName,
        category: 'Vegetarisch',
        photoData: onboardingDraftDish.photoData || null
      };
      
      const preview = offerCard({
        id: dish.id || 'preview',
        dish: dish.dish,
        category: dish.category || 'Vegetarisch',
        price: 0, // No price in preview
        pickupWindow: savedDish?.pickupWindow || `${onboardingDraftDish?.pickupTimeStart || '11:30'} – ${onboardingDraftDish?.pickupTimeEnd || '14:30'}`,
        imageUrl: dish.photoData || dish.imageUrl || '',
        providerName: provider.profile?.name || 'Dein Betrieb',
        hasPickupCode: false, // No abholcode in preview
        dineInPossible: false
      }, {interactive: false});
      
      previewCard.innerHTML = '';
      previewCard.appendChild(preview);
      
      // Disable all interactive elements in preview
      preview.querySelectorAll('button, a').forEach(el => {
        el.style.pointerEvents = 'none';
        el.style.opacity = '0.5';
      });
      
      // Update icons
      if(typeof lucide !== 'undefined'){
        setTimeout(() => lucide.createIcons(), 50);
      }
    }
  }
  
  // Onboarding Event Handlers – Einstieg "Was bieten Sie heute an?"
  function startOnboardingFromEntry(){
    const input = document.getElementById('onboardingEntryDishInput');
    const value = input ? input.value.trim() : '';
    if(value){
      onboardingDraftDish = onboardingDraftDish || {};
      onboardingDraftDish.dishName = value;
      save(LS.onboardingDraft, onboardingDraftDish);
      showOnboardingFirstDish(true);
    } else {
      showOnboardingFirstDish(false);
    }
  }
  const onboardingEntryDishInput = document.getElementById('onboardingEntryDishInput');
  if(onboardingEntryDishInput) onboardingEntryDishInput.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); startOnboardingFromEntry(); } });
  const btnOnboardingEntryGo = document.getElementById('btnOnboardingEntryGo');
  if(btnOnboardingEntryGo) btnOnboardingEntryGo.onclick = startOnboardingFromEntry;
  const btnOnboardingEntryStart = document.getElementById('btnOnboardingEntryStart');
  if(btnOnboardingEntryStart) btnOnboardingEntryStart.onclick = startOnboardingFromEntry;
  const btnOnboardingEntryLater = document.getElementById('btnOnboardingEntryLater');
  if(btnOnboardingEntryLater) btnOnboardingEntryLater.onclick = () => {
    if(provider.loggedIn){
      showProviderHome();
    } else {
      showView(views.providerLogin);
    }
  };
  
  const btnOnboardingFirstDishBack = document.getElementById('btnOnboardingFirstDishBack');
  if(btnOnboardingFirstDishBack) btnOnboardingFirstDishBack.onclick = () => {
    const dishName = document.getElementById('onboardingDishName')?.value.trim();
    const timeStart = document.getElementById('onboardingPickupTimeStart')?.value;
    const timeEnd = document.getElementById('onboardingPickupTimeEnd')?.value;
    
    // Check if user has made changes
    if(dishName || timeStart || timeEnd || onboardingDraftDish?.photoData){
      if(confirm('Später weitermachen?\n\nDein Gericht ist noch nicht gespeichert.')){
        showOnboardingEntry(!!onboardingDraftDish);
      }
    } else {
      showOnboardingEntry(!!onboardingDraftDish);
    }
  };
  
  const btnOnboardingFirstDishNext = document.getElementById('btnOnboardingFirstDishNext');
  if(btnOnboardingFirstDishNext) btnOnboardingFirstDishNext.onclick = () => {
    const dishName = document.getElementById('onboardingDishName')?.value.trim();
    const dishPrice = document.getElementById('onboardingDishPrice')?.value.trim();
    const dishDiet = document.querySelector('input[name="dishDiet"]:checked')?.value;
    const dishDesc = document.getElementById('onboardingDishDesc')?.value.trim();
    const timeStart = document.getElementById('onboardingPickupTimeStart')?.value;
    const timeEnd = document.getElementById('onboardingPickupTimeEnd')?.value;
    
    if(!dishName || !dishPrice || !timeStart || !timeEnd || !dishDiet){
      alert('Bitte fülle alle Pflichtfelder aus (Name, Preis, Kategorie, Zeit).');
      return;
    }
    
    // Save draft
    onboardingDraftDish = {
      dishName,
      dishPrice,
      dishDiet,
      dishDesc,
      pickupTimeStart: timeStart,
      pickupTimeEnd: timeEnd,
      photoData: onboardingDraftDish?.photoData || null
    };
    save(LS.onboardingDraft, onboardingDraftDish);
    
    // Check where to go
    if(provider.loggedIn){
      // Wenn eingeloggt: Abkürzung zur Vorschau (überspringe Account & Business)
      showOnboardingPreview(null);
    } else {
      // Wenn neu: Konto erstellen
      showOnboardingSignup();
    }
  };

  // --- AUTO-SAVE / CACHE FOR ONBOARDING STEP 1 ---
  const obCacheIds = ['onboardingDishName', 'onboardingDishPrice', 'onboardingDishDesc', 'onboardingPickupTimeStart', 'onboardingPickupTimeEnd'];
  obCacheIds.forEach(id => {
    const el = document.getElementById(id);
    if(el){
      const cached = localStorage.getItem('cache_' + id);
      if(cached) el.value = cached;
      if(id !== 'onboardingDishPrice') el.addEventListener('input', () => localStorage.setItem('cache_' + id, el.value));
    }
  });
  // Onboarding Preis: +/- Buttons, Komma immer gesetzt, 1-Daumen
  (function(){
    const inp = document.getElementById('onboardingDishPrice');
    const disp = document.getElementById('onboardingDishPriceDisplay');
    const btnMinus = document.getElementById('btnOnboardingPriceMinus');
    const btnPlus = document.getElementById('btnOnboardingPricePlus');
    if(!inp || !disp || !btnMinus || !btnPlus) return;
    function updatePrice(val){
      val = Math.round(val*100)/100;
      inp.value = String(val);
      inp.setAttribute('value', val);
      disp.textContent = val.toFixed(2).replace('.',',')+' €';
      localStorage.setItem('cache_onboardingDishPrice', String(val));
    }
    const cached = localStorage.getItem('cache_onboardingDishPrice');
    if(cached){ const v = parseFloat(cached.replace(',','.'))||8.5; updatePrice(v); }
    btnMinus.onclick = () => { let v = parseFloat((inp.value||'8.5').replace(',','.'))||0; if(v>=0.5) updatePrice(v-0.5); };
    btnPlus.onclick = () => { let v = parseFloat((inp.value||'8.5').replace(',','.'))||0; updatePrice(v+0.5); };
  })();
  // Radio Buttons Cache (Kategorie)
  const dietRadios = document.querySelectorAll('input[name="dishDiet"]');
  const cachedDiet = localStorage.getItem('cache_dishDiet');
  if(cachedDiet) {
    dietRadios.forEach(r => { if(r.value === cachedDiet) r.checked = true; });
  }
  dietRadios.forEach(r => {
    r.addEventListener('change', () => localStorage.setItem('cache_dishDiet', r.value));
  });
  // ------------------------------------------------
  
  const btnOnboardingSignupCreate = document.getElementById('btnOnboardingSignupCreate');
  if(btnOnboardingSignupCreate) btnOnboardingSignupCreate.onclick = () => {
    const email = document.getElementById('onboardingEmail')?.value.trim();
    const password = document.getElementById('onboardingPassword')?.value.trim();
    
    if(!email || !password || password.length < 8){
      alert('Bitte gib eine gültige E-Mail und ein Passwort (mind. 8 Zeichen) ein.');
      return;
    }
    
    // Create account
    provider.loggedIn = true;
    provider.email = email;
    provider.onboardingCompleted = false; // Will be set to true after preview
    save(LS.provider, provider);
    
    // Save dish to cookbook
    if(onboardingDraftDish){
      const newDish = {
        id: cryptoId(),
        providerId: providerId(),
        dish: onboardingDraftDish.dishName,
        category: onboardingDraftDish.dishDiet || 'Vegetarisch',
        description: onboardingDraftDish.dishDesc || '',
        price: parseFloat(onboardingDraftDish.dishPrice.replace(',', '.')) || 0,
        pickupWindow: `${onboardingDraftDish.pickupTimeStart} – ${onboardingDraftDish.pickupTimeEnd}`,
        photoData: onboardingDraftDish.photoData || '',
        hasPickupCode: false, // No abholcode in onboarding
        dineInPossible: false,
        allergens: [],
        extras: [],
        reuse: {enabled: false, deposit: 0},
        createdAt: Date.now(),
        lastUsed: null
      };
      cookbook.push(newDish);
      save(LS.cookbook, cookbook);
      
      // Clear draft after successful save
      onboardingDraftDish = null;
      save(LS.onboardingDraft, null);
      
      // Clear Input Cache
      ['onboardingDishName', 'onboardingDishPrice', 'onboardingPickupTimeStart', 'onboardingPickupTimeEnd'].forEach(id => localStorage.removeItem('cache_' + id));

      // Proceed to business screen
      showOnboardingBusiness();
    }
  };
  
  const btnOnboardingSignupLater = document.getElementById('btnOnboardingSignupLater');
  if(btnOnboardingSignupLater) btnOnboardingSignupLater.onclick = () => {
    // Keep draft, go to login
    showView(views.providerLogin);
  };

  // --- AUTO-SAVE STEP 2 ---
  const elEmail = document.getElementById('onboardingEmail');
  if(elEmail){
    const cachedEmail = localStorage.getItem('cache_onboardingEmail');
    if(cachedEmail) elEmail.value = cachedEmail;
    elEmail.addEventListener('input', () => localStorage.setItem('cache_onboardingEmail', elEmail.value));
  }
  // -----------------------
  
  const btnOnboardingBusinessBack = document.getElementById('btnOnboardingBusinessBack');
  if(btnOnboardingBusinessBack) btnOnboardingBusinessBack.onclick = () => showOnboardingSignup();
  
  const btnOnboardingBusinessNext = document.getElementById('btnOnboardingBusinessNext');
  if(btnOnboardingBusinessNext) btnOnboardingBusinessNext.onclick = () => {
    const businessName = document.getElementById('onboardingBusinessName')?.value.trim();
    const cityOrAddress = document.getElementById('onboardingCityOrAddress')?.value.trim();
    
    if(!businessName || !cityOrAddress){
      alert('Bitte fülle alle Felder aus.');
      return;
    }
    
    // Save provider profile basics
    if(!provider.profile) provider.profile = {};
    provider.profile.name = businessName;
    const parsed = parseAddress(cityOrAddress);
    provider.profile.street = parsed.street || cityOrAddress;
    provider.profile.zip = parsed.zip || '';
    provider.profile.city = parsed.city || cityOrAddress;
    save(LS.provider, provider);
    
    // Get the saved dish ID
    const savedDish = cookbook.find(c => c.providerId === providerId() && c.dish === onboardingDraftDish?.dishName);
    if(savedDish){
      showOnboardingPreview(savedDish.id);
    } else {
      // Fallback: show preview with draft data
      showOnboardingPreview(null);
    }
  };
  
  // Tap-Demo Funktion (interaktiver Moment im Onboarding)
  function triggerTapDemo(){
    const demoCode = document.getElementById('demoPickupCode');
    const message = document.getElementById('tapDemoMessage');
    if(!demoCode || !message) return;
    
    // Grüner Flash-Effekt
    demoCode.style.background = '#4caf50';
    demoCode.style.color = '#fff';
    demoCode.style.transform = 'scale(0.95)';
    demoCode.style.borderColor = '#4caf50';
    
    // Nach 200ms zurück
    setTimeout(() => {
      demoCode.style.background = '#fff';
      demoCode.style.color = '#2D3436';
      demoCode.style.transform = 'scale(1)';
      demoCode.style.borderColor = '#FFD700';
    }, 200);
    
    // Nachricht anzeigen
    message.style.display = 'block';
    
    // Haptic Feedback
    if('vibrate' in navigator){
      navigator.vibrate([50, 30, 50]);
    }
  }
  
  const btnOnboardingPreviewDashboard = document.getElementById('btnOnboardingPreviewDashboard');
  if(btnOnboardingPreviewDashboard) btnOnboardingPreviewDashboard.onclick = () => {
    // Falls noch ein Entwurf da ist (z.B. weil wir eingeloggt waren und Account-Erstellung übersprungen haben), jetzt speichern!
    if(onboardingDraftDish){
      const newDish = {
        id: cryptoId(),
        providerId: providerId(),
        dish: onboardingDraftDish.dishName,
        category: onboardingDraftDish.dishDiet || 'Vegetarisch',
        description: onboardingDraftDish.dishDesc || '',
        price: parseFloat(onboardingDraftDish.dishPrice.replace(',', '.')) || 0,
        pickupWindow: `${onboardingDraftDish.pickupTimeStart} – ${onboardingDraftDish.pickupTimeEnd}`,
        photoData: onboardingDraftDish.photoData || '',
        hasPickupCode: false,
        dineInPossible: false,
        allergens: [],
        extras: [],
        reuse: {enabled: false, deposit: 0},
        createdAt: Date.now(),
        lastUsed: null
      };
      cookbook.push(newDish);
      save(LS.cookbook, cookbook);
      
      // Clear draft
      onboardingDraftDish = null;
      save(LS.onboardingDraft, null);
      ['onboardingDishName', 'onboardingDishPrice', 'onboardingDishDesc', 'onboardingPickupTimeStart', 'onboardingPickupTimeEnd'].forEach(id => localStorage.removeItem('cache_' + id));
    }

    provider.onboardingCompleted = true;
    save(LS.provider, provider);
    // Zurück zum Dashboard
    showProviderHome();
  };
  
  const btnOnboardingPreviewEdit = document.getElementById('btnOnboardingPreviewEdit');
  if(btnOnboardingPreviewEdit) btnOnboardingPreviewEdit.onclick = () => {
    // Restore draft from saved dish
    const savedDish = cookbook.find(c => c.providerId === providerId());
    if(savedDish){
      onboardingDraftDish = {
        dishName: savedDish.dish,
        pickupTimeStart: savedDish.pickupWindow?.split(' – ')[0] || '11:30',
        pickupTimeEnd: savedDish.pickupWindow?.split(' – ')[1] || '14:30',
        photoData: savedDish.photoData || null
      };
      save(LS.onboardingDraft, onboardingDraftDish);
    }
    showOnboardingFirstDish(true);
  };
  
  // Browser back button handling for onboarding (integrated in existing popstate handler)
  // The existing popstate handler already handles wizard and sheets
  // We add onboarding handling there

  // --- Provider entry ---
  const btnProvBack = document.getElementById('btnProvBack');
  if(btnProvBack){
    btnProvBack.onclick=()=>{ setMode('customer'); showProfile(); };
  }

  const btnProvLogin = document.getElementById('btnProvLogin');
  if(btnProvLogin){
    btnProvLogin.onclick=()=>{
      const email = document.getElementById('provEmail').value.trim();
      const pass = document.getElementById('provPass').value.trim();
      if(!email || !pass){ showToast('Bitte E-Mail-Adresse und Passwort eingeben.', 2000); return; }
      
      const existingSession = load(LS.providerSession, null);
      const currentSessionId = load('mittagio_current_session_id', null);
      if(existingSession && existingSession.email === email && existingSession.sessionId !== currentSessionId){
        openLoginConflictModal(email, () => { performProviderLogin(email); });
        return;
      }
      performProviderLogin(email);
    };
  }

  const btnProvLogout = document.getElementById('btnProvLogout');
  if(btnProvLogout){
    btnProvLogout.onclick=()=>{
      deleteCookie(SESSION_COOKIE_NAME);
      localStorage.removeItem(LS.providerSession);
      localStorage.removeItem('mittagio_current_session_id');
      provider.loggedIn = false;
      provider.current_session_id = null;
      save(LS.provider, provider);
      setMode('customer');
      showProfile();
    };
  }

  const btnProviderLogout = document.getElementById('btnProviderLogout');
  if(btnProviderLogout){
    btnProviderLogout.onclick=()=>{
      deleteCookie(SESSION_COOKIE_NAME);
      localStorage.removeItem(LS.providerSession);
      localStorage.removeItem('mittagio_current_session_id');
      provider.loggedIn = false;
      provider.current_session_id = null;
      save(LS.provider, provider);
      setMode('customer');
      showProfile();
      showToast('Du wurdest abgemeldet.');
    };
  }

  // Rechtliches
  // --- AGB Onboarding Modal (1-Screen) ---
  function openAgbOnboardingModal(callback){
    const content = document.getElementById('agbOnboardingContent');
    if(!content) return;
    
    content.innerHTML = `
      <h2 style="font-size:20px; font-weight:900; margin-bottom:16px;">AGB</h2>
      <div style="line-height:1.7; font-size:14px; max-height:60vh; overflow-y:auto; padding-right:8px;">
        <p><strong>Mittagio ist Plattform, nicht Verkäufer</strong></p>
        <p>Mittagio vermittelt Mittagsangebote lokaler Anbieter. Vertragspartner bei Bestellungen ist ausschließlich der jeweilige Anbieter.</p>
        
        <p style="margin-top:16px;"><strong>Kosten:</strong></p>
        <ul style="padding-left:20px; margin:8px 0;">
          <li>4,99 € zzgl. MwSt. pro Veröffentlichung</li>
          <li>0,89 € zzgl. MwSt. pro Online-Bestellung inkl. aller Bank- & Zahlungsgebühren (pro Bestellung, egal wie viele Gerichte)</li>
        </ul>
        
        <p style="margin-top:16px;"><strong>Abholnummer:</strong></p>
        <p>Abholnummer = Zahlungs- & Abholnachweis. Abwicklungsgebühr fällt auch bei Nicht-Abholung an.</p>
        
        <p style="margin-top:16px;"><strong>Verantwortung:</strong></p>
        <p>Anbieter ist verantwortlich für Inhalte/Speisen/gesetzliche Vorgaben.</p>
        
        <p style="margin-top:16px;"><strong>Support:</strong></p>
        <p><a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a></p>
      </div>
    `;
    
    document.getElementById('agbOnboardingBd').classList.add('active');
    document.getElementById('agbOnboardingSheet').classList.add('active');
    
    const acceptBtn = document.getElementById('btnAgbOnboardingAccept');
    const cancelBtn = document.getElementById('btnAgbOnboardingCancel');
    if(acceptBtn) acceptBtn.onclick = () => {
      closeAgbOnboardingModal();
      if(callback) callback(true);
    };
    if(cancelBtn) cancelBtn.onclick = () => {
      closeAgbOnboardingModal();
      if(callback) callback(false);
    };
  }
  
  function closeAgbOnboardingModal(){
    document.getElementById('agbOnboardingBd').classList.remove('active');
    document.getElementById('agbOnboardingSheet').classList.remove('active');
  }
  
  // --- Legal Sheets (Impressum, AGB, Datenschutz) ---
  function openLegalSheet(type){
    const content = document.getElementById('legalContent');
    if(!content) return;
    
    let html = '';
    let title = '';
    
    if(type === 'impressum'){
      title = 'Impressum';
      html = `
        <h3 style="margin:0 0 20px;">Impressum</h3>
        <div style="line-height:1.8;">
          <p style="font-weight:700; margin-bottom:12px;">Verantwortlich für den Inhalt:</p>
          <p>
            <strong>Mike Quach</strong><br>
            Langäcker 2<br>
            73635 Rudersberg<br>
            Deutschland
          </p>
          <p style="margin-top:16px;">
            <strong>Kunden-Hilfe:</strong> <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a><br>
            <strong>Business:</strong> <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a>
          </p>
          <p style="margin-top:20px; padding-top:20px; border-top:1px solid #eee; font-size:13px; color:#666;">
            <strong>Plattformhinweis:</strong><br>
            Mittagio vermittelt Mittagsangebote lokaler Anbieter. Vertragspartner bei Bestellungen ist ausschließlich der jeweilige Anbieter.
          </p>
          <p style="margin-top:20px; padding-top:16px; border-top:1px solid #eee; font-size:13px; color:#94a3b8; text-align:center;">
            made with ❤️ by mittagio.de
          </p>
        </div>
      `;
    } else if(type === 'agb'){
      title = 'Allgemeine Geschäftsbedingungen (Kunden)';
      html = `
        <h3 style="margin:0 0 20px;">Allgemeine Geschäftsbedingungen (Kunden)</h3>
        <div style="line-height:1.8; font-size:14px;">
          <p style="margin-bottom:16px;"><strong>1. Geltungsbereich</strong></p>
          <p style="margin-bottom:20px;">Diese Allgemeinen Geschäftsbedingungen (AGB) gelten für die Nutzung der Plattform Mittagio durch Kunden. Mittagio betreibt eine Plattform zur Vermittlung von Mittagsangeboten lokaler Anbieter.</p>
          
          <p style="margin-bottom:16px;"><strong>2. Rolle von Mittagio</strong></p>
          <p style="margin-bottom:20px;">Mittagio ist kein Restaurant und kein Lieferdienst. Mittagio vermittelt ausschließlich zwischen Kunden und Anbietern. Der Kaufvertrag kommt direkt zwischen dem Kunden und dem jeweiligen Anbieter zustande.</p>
          
          <p style="margin-bottom:16px;"><strong>3. Nutzung der Plattform</strong></p>
          <p style="margin-bottom:20px;">Die Nutzung ist grundsätzlich ohne Registrierung möglich. Kunden können Mittagsangebote auswählen und entdecken. Ein Anspruch auf Verfügbarkeit bestimmter Angebote besteht nicht.</p>
          
          <p style="margin-bottom:16px;"><strong>4. Bestellung & Abholung</strong></p>
          <p style="margin-bottom:20px;">Mit Abschluss der Bestellung erhält der Kunde eine Abholnummer. Die Abholnummer ist beim Anbieter vorzuzeigen. Die Abholung erfolgt innerhalb der vom Anbieter angegebenen Essenszeit.</p>
          
          <p style="margin-bottom:16px;"><strong>5. Preise & Bezahlung</strong></p>
          <p style="margin-bottom:20px;">Alle Preise werden vom Anbieter festgelegt. Die Bezahlung erfolgt direkt beim Anbieter vor Ort, sofern nicht anders angegeben. Mittagio erhebt aktuell keine Gebühren vom Kunden.</p>
          
          <p style="margin-bottom:16px;"><strong>6. Stornierung</strong></p>
          <p style="margin-bottom:20px;">Stornierungen sind abhängig von den Regelungen des jeweiligen Anbieters. Ein Anspruch auf Stornierung oder Rückerstattung über Mittagio besteht nicht.</p>
          
          <p style="margin-bottom:16px;"><strong>7. Haftung</strong></p>
          <p style="margin-bottom:20px;">Mittagio haftet nicht für Qualität, Menge oder Beschaffenheit der Speisen, Ausfälle, Verspätungen oder Änderungen durch den Anbieter, sowie Allergene oder Unverträglichkeiten. Für diese Punkte ist ausschließlich der jeweilige Anbieter verantwortlich.</p>
          
          <p style="margin-bottom:16px;"><strong>8. Verfügbarkeit</strong></p>
          <p style="margin-bottom:20px;">Mittagio bemüht sich um eine hohe Verfügbarkeit der Plattform, übernimmt jedoch keine Garantie für eine jederzeit unterbrechungsfreie Nutzung.</p>
          
          <p style="margin-bottom:16px;"><strong>9. Änderungen der AGB</strong></p>
          <p style="margin-bottom:20px;">Mittagio behält sich vor, diese AGB anzupassen, wenn sich Funktionen oder rechtliche Rahmenbedingungen ändern.</p>
          
          <p style="margin-bottom:16px;"><strong>10. Kontakt</strong></p>
          <p style="margin-bottom:20px;">Bei Fragen zur Nutzung der Plattform: <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a></p>
          
          <p style="margin-top:24px; padding-top:20px; border-top:1px solid #eee; font-size:12px; color:#666;">
            <strong>Stand:</strong> Januar 2026
          </p>
        </div>
      `;
    } else if(type === 'datenschutz'){
      title = 'Datenschutzerklärung';
      html = `
        <h3 style="margin:0 0 20px;">Datenschutzerklärung</h3>
        <div style="line-height:1.8; font-size:14px;">
          <p style="margin-bottom:16px;"><strong>1. Verantwortlicher</strong></p>
          <p style="margin-bottom:20px;">
            Verantwortlich für die Datenverarbeitung ist:<br><br>
            <strong>MQ Mittagio UG (haftungsbeschränkt)</strong><br>
            Vertreten durch: Mike Quach<br>
            Langäcker 2<br>
            73635 Rudersberg<br>
            Deutschland<br><br>
            <strong>Kunden-Hilfe:</strong> <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a><br>
            <strong>Business-Anfragen:</strong> <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a>
          </p>
          
          <p style="margin-bottom:16px;"><strong>2. Allgemeines</strong></p>
          <p style="margin-bottom:20px;">Der Schutz deiner persönlichen Daten ist uns wichtig. Wir verarbeiten personenbezogene Daten nur im notwendigen Umfang und gemäß den geltenden Datenschutzgesetzen (DSGVO).</p>
          
          <p style="margin-bottom:16px;"><strong>3. Welche Daten wir verarbeiten</strong></p>
          <p style="margin-bottom:12px;"><strong>a) Bei der Nutzung der Plattform</strong></p>
          <p style="margin-bottom:20px;">Beim Besuch von Mittagio werden technisch notwendige Daten verarbeitet, z. B.:</p>
          <ul style="margin:0 0 20px 20px; padding-left:0;">
            <li style="margin-bottom:8px;">IP-Adresse (gekürzt/anonymisiert, sofern möglich)</li>
            <li style="margin-bottom:8px;">Datum und Uhrzeit des Zugriffs</li>
            <li style="margin-bottom:8px;">Browsertyp / Betriebssystem</li>
            <li style="margin-bottom:8px;">aufgerufene Seiten</li>
          </ul>
          <p style="margin-bottom:20px;">Diese Daten sind technisch erforderlich, um die Plattform bereitzustellen.</p>
          
          <p style="margin-bottom:12px;"><strong>b) Bei einer Bestellung</strong></p>
          <p style="margin-bottom:12px;">Wenn du ein Mittagsangebot bestellst, verarbeiten wir:</p>
          <ul style="margin:0 0 12px 20px; padding-left:0;">
            <li style="margin-bottom:8px;">ausgewähltes Gericht</li>
            <li style="margin-bottom:8px;">Anbieter</li>
            <li style="margin-bottom:8px;">Abholzeit (ungefähr)</li>
            <li style="margin-bottom:8px;">generierte Abholnummer</li>
          </ul>
          <p style="margin-bottom:20px;">
            👉 Keine Pflicht zur Registrierung<br>
            👉 Keine Zahlungsdaten (Bezahlung erfolgt ggf. vor Ort beim Anbieter)
          </p>
          
          <p style="margin-bottom:12px;"><strong>c) Lokale Speicherung (PWA)</strong></p>
          <p style="margin-bottom:20px;">Bestellungen und Abholnummern werden lokal auf deinem Gerät gespeichert (z. B. im LocalStorage), damit du sie auch offline wieder anzeigen kannst. Diese Daten werden nicht automatisch an uns übertragen.</p>
          
          <p style="margin-bottom:16px;"><strong>4. Weitergabe von Daten</strong></p>
          <p style="margin-bottom:20px;">Deine Daten werden nur an den jeweiligen Anbieter weitergegeben, soweit dies zur Abwicklung deiner Bestellung erforderlich ist.</p>
          <p style="margin-bottom:20px;">Eine Weitergabe an Dritte erfolgt nicht, außer:</p>
          <ul style="margin:0 0 20px 20px; padding-left:0;">
            <li style="margin-bottom:8px;">es besteht eine gesetzliche Verpflichtung</li>
            <li style="margin-bottom:8px;">oder du hast ausdrücklich eingewilligt</li>
          </ul>
          
          <p style="margin-bottom:16px;"><strong>5. Cookies & Tracking</strong></p>
          <p style="margin-bottom:20px;">Mittagio verwendet keine Tracking-Cookies und kein Nutzer-Tracking zu Werbezwecken.</p>
          <p style="margin-bottom:20px;">Es werden ausschließlich technisch notwendige Speichermechanismen verwendet (z. B. für App-Funktionen).</p>
          
          <p style="margin-bottom:16px;"><strong>6. Hosting</strong></p>
          <p style="margin-bottom:20px;">Die Plattform wird über externe Hosting-Anbieter betrieben. Dabei können technisch notwendige Zugriffsdaten (z. B. IP-Adresse) verarbeitet werden, um den sicheren Betrieb zu gewährleisten.</p>
          
          <p style="margin-bottom:16px;"><strong>7. Deine Rechte</strong></p>
          <p style="margin-bottom:12px;">Du hast jederzeit das Recht auf:</p>
          <ul style="margin:0 0 12px 20px; padding-left:0;">
            <li style="margin-bottom:8px;">Auskunft über deine gespeicherten Daten</li>
            <li style="margin-bottom:8px;">Berichtigung unrichtiger Daten</li>
            <li style="margin-bottom:8px;">Löschung deiner Daten</li>
            <li style="margin-bottom:8px;">Einschränkung der Verarbeitung</li>
            <li style="margin-bottom:8px;">Widerspruch gegen die Verarbeitung</li>
          </ul>
          <p style="margin-bottom:20px;">Anfragen bitte per E-Mail an: <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a></p>
          
          <p style="margin-bottom:16px;"><strong>8. Änderungen dieser Datenschutzerklärung</strong></p>
          <p style="margin-bottom:20px;">Diese Datenschutzerklärung kann angepasst werden, wenn sich Funktionen oder gesetzliche Vorgaben ändern.</p>
          <p style="margin-bottom:20px;">Es gilt jeweils die auf dieser Seite veröffentlichte Version.</p>
          
          <p style="margin-top:24px; padding-top:20px; border-top:1px solid #eee; font-size:12px; color:#666;">
            <strong>9. Stand</strong><br>
            Stand: Januar 2026
          </p>
        </div>
      `;
    }
    
    content.innerHTML = html;
    document.getElementById('legalBd').classList.add('active');
    document.getElementById('legalSheet').classList.add('active');
  }
  
  function closeLegalSheet(){
    document.getElementById('legalBd').classList.remove('active');
    document.getElementById('legalSheet').classList.remove('active');
  }
  
  // Profil anlegen Sheet (Kunde)
  function openProfileCreateSheet(){
    const bd = document.getElementById('profileCreateBd');
    const sheet = document.getElementById('profileCreateSheet');
    const nameEl = document.getElementById('profileCreateName');
    const emailEl = document.getElementById('profileCreateEmail');
    if(!bd || !sheet || !emailEl) return;
    if(nameEl) nameEl.value = '';
    emailEl.value = '';
    bd.classList.add('active');
    sheet.classList.add('active');
    setTimeout(function(){ emailEl.focus(); }, 120);
    if(typeof lucide !== 'undefined') setTimeout(function(){ lucide.createIcons(); }, 50);
  }
  function closeProfileCreateSheet(){
    const bd = document.getElementById('profileCreateBd');
    const sheet = document.getElementById('profileCreateSheet');
    if(bd) bd.classList.remove('active');
    if(sheet) sheet.classList.remove('active');
  }
  
  // FAQ Sheet
  function openFaqSheet(){
    const content = document.getElementById('faqSheetContent');
    if(!content) return;
    
    const allFaq = `
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Wie funktioniert Mittagio?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Du findest Mittagsangebote in deiner Stadt, optional bezahlst du online und holst zur gewählten Zeit ab.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Was ist die Abholnummer?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Deine Abholnummer für die Mittagspause. Du erhältst sie nach erfolgreicher Online-Zahlung.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Muss ich online bezahlen?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Nein. Online-Zahlung ist optional. Eine Abholnummer gibt's nur bei Online-Zahlung.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Kann ich ohne Abholnummer Gerichte hinzufügen?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Nein. Angebote ohne Abholnummer kannst du nur ansehen.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Wann kann ich abholen?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Innerhalb der Essenszeit. Wähle eine ungefähre Abholzeit in deiner Mittagsbox.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Kann ich mehrere Gerichte in einem Vorgang buchen?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Ja. Du kannst mehrere Gerichte in einem Vorgang buchen (eine Abholnummer).</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Vor Ort essen möglich?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Wenn das Badge „Vor Ort" angezeigt wird, kannst du vor Ort essen.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Teilen</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Teile Angebote per WhatsApp, Instagram oder Website.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Kontakt</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Bei Fragen schreib uns an <a href="mailto:info@mittagio.de" style="color:var(--muted);">info@mittagio.de</a></p>
      </details>
    `;
    
    content.innerHTML = allFaq;
    document.getElementById('faqBd').classList.add('active');
    document.getElementById('faqSheet').classList.add('active');
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined') setTimeout(()=> lucide.createIcons(), 50);
  }
  
  // Kachel-Popup Funktionen (Neugier-Popup)
  function showTilePopup(element, text){
    const popup = element.querySelector('.tile-popup');
    if(popup){
      if(text){
        const textNode = popup.childNodes[0];
        if(textNode && textNode.nodeType === 3) textNode.textContent = text;
        else {
          const arrow = popup.querySelector('div[style*="border-left"]') || '';
          popup.innerHTML = text + (arrow.outerHTML || '<div style="position:absolute; top:100%; left:50%; transform:translateX(-50%); width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; border-top:6px solid #1e1e1e;"></div>');
        }
      }
      popup.style.opacity = '1';
    }
  }
  function hideTilePopup(element){
    const popup = element.querySelector('.tile-popup');
    if(popup){
      popup.style.opacity = '0';
    }
  }
  
  // PDF-Küchenliste generieren & Download
  function generateKitchenListPDF(dayKey = null){
    const todayKey = dayKey || isoDate(new Date());
    const profile = normalizeProviderProfile(provider.profile || {});
    const providerName = profile.name || provider.email || 'Anbieter';
    const providerAddr = buildAddress(profile) || '';
    
    // Bestellungen für den Tag filtern
    const orders = loadOrders().filter(o => {
      const offer = offers.find(off => off.id === o.dishId || off.providerId === o.providerId);
      return offer && offer.providerId === providerId() && offer.day === todayKey && o.status === 'PAID';
    });
    
    // Gruppieren nach Gericht
    const grouped = {};
    orders.forEach(o => {
      const offer = offers.find(off => off.id === o.dishId);
      const dishName = offer?.dish || o.dishName || 'Gericht';
      if(!grouped[dishName]){
        grouped[dishName] = {count: 0, orders: [], price: offer?.price || 0};
      }
      grouped[dishName].count += 1;
      grouped[dishName].orders.push(o);
    });
    
    // HTML für Print generieren
    const dateStr = dayKey ? fmtDay(new Date(dayKey)) : 'Heute';
    const html = `
      <div class="print-card">
        <h1>Küchenliste - ${esc(providerName)}</h1>
        <div class="print-muted">${esc(providerAddr)}</div>
        <div class="print-muted" style="margin-top:8px;">${esc(dateStr)} · ${orders.length} Bestellung${orders.length !== 1 ? 'en' : ''}</div>
      </div>
      ${Object.entries(grouped).map(([dish, data]) => `
        <div class="print-card">
          <h2>${esc(dish)} × ${data.count}</h2>
          <div class="print-muted" style="margin-top:4px;">Abholnummern: ${data.orders.map(o => o.pickupCode || o.code || '–').join(', ')}</div>
        </div>
      `).join('')}
      <div class="print-card" style="margin-top:20px; padding-top:20px; border-top:2px solid #ddd;">
        <div class="print-muted">Erstellt am ${new Date().toLocaleString('de-DE')}</div>
        <div class="print-muted">Mittagio - Dein Mittag. Lokal. Frisch. Digital.</div>
      </div>
    `;
    
    printHtml(html);
  }
  
  // PDF-Küchenliste per E-Mail versenden (Fallback: Download)
  function emailKitchenList(dayKey = null){
    const todayKey = dayKey || isoDate(new Date());
    const dateStr = dayKey ? fmtDay(new Date(dayKey)) : 'Heute';
    
    // Generiere HTML
    generateKitchenListPDF(todayKey);
    
    // Fallback: Download-Link anbieten
    showToast('Küchenliste wird vorbereitet...');
    setTimeout(() => {
      if(confirm('Küchenliste drucken oder als PDF speichern?')){
        window.print();
      }
    }, 500);
  }
  
  function closeFaqSheet(){
    document.getElementById('faqBd').classList.remove('active');
    document.getElementById('faqSheet').classList.remove('active');
  }
  
  // Legal Links
  const btnImpressum = document.getElementById('btnImpressum');
  if(btnImpressum) btnImpressum.onclick=()=>{ openLegalSheet('impressum'); };
  const btnAGB = document.getElementById('btnAGB');
  if(btnAGB) btnAGB.onclick=()=>{ openLegalSheet('agb'); };
  const btnDatenschutz = document.getElementById('btnDatenschutz');
  if(btnDatenschutz) btnDatenschutz.onclick=()=>{ openLegalSheet('datenschutz'); };
  
  // Profile Legal Links - öffnen statische Seiten
  const btnProfileImpressum = document.getElementById('btnProfileImpressum');
  if(btnProfileImpressum) btnProfileImpressum.onclick=(e)=>{ e.preventDefault(); showLegalPage('impressum'); };
  const btnProfileAGB = document.getElementById('btnProfileAGB');
  if(btnProfileAGB) btnProfileAGB.onclick=(e)=>{ e.preventDefault(); showLegalPage('agb-kurz'); };
  const btnProfileDatenschutz = document.getElementById('btnProfileDatenschutz');
  if(btnProfileDatenschutz) btnProfileDatenschutz.onclick=(e)=>{ e.preventDefault(); showLegalPage('datenschutz'); };

  // Support-Formular (Kunden): Nachricht senden – Bestätigung ohne E-Mail im UI
  const supportForm = document.getElementById('supportForm');
  if(supportForm){
    supportForm.addEventListener('submit', function(e){
      e.preventDefault();
      const subjectEl = document.getElementById('supportSubject');
      const messageEl = document.getElementById('supportMessage');
      const pickupRefEl = document.getElementById('supportPickupRef');
      if(!messageEl || !messageEl.value.trim()){ showToast('Bitte Nachricht eingeben.', 2000); return; }
      showToast('Vielen Dank. Deine Nachricht wurde übermittelt. Wir melden uns in Kürze.', 4000);
      if(subjectEl) subjectEl.value = '';
      if(messageEl) messageEl.value = '';
      if(pickupRefEl) pickupRefEl.value = '';
    });
  }
  
  // Profil anlegen Sheet: Submit & Abbrechen
  const btnProfileCreateSubmit = document.getElementById('btnProfileCreateSubmit');
  const btnProfileCreateCancel = document.getElementById('btnProfileCreateCancel');
  if(btnProfileCreateSubmit){
    btnProfileCreateSubmit.onclick = function(){
      const nameEl = document.getElementById('profileCreateName');
      const emailEl = document.getElementById('profileCreateEmail');
      const name = (nameEl && nameEl.value) ? nameEl.value.trim() : '';
      const email = (emailEl && emailEl.value) ? emailEl.value.trim() : '';
      if(!email){
        showToast('Bitte E-Mail-Adresse eingeben.', 2000);
        if(emailEl) emailEl.focus();
        return;
      }
      var re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if(!re.test(email)){
        showToast('Bitte gültige E-Mail-Adresse eingeben.', 2000);
        if(emailEl) emailEl.focus();
        return;
      }
      customer.loggedIn = true;
      customer.email = email;
      customer.name = name || email.split('@')[0];
      if(!customer.dietaryPreferences) customer.dietaryPreferences = { vegan: false, vegetarian: false, glutenFree: false, lactoseFree: false };
      if(customer.reuseEnabled === undefined) customer.reuseEnabled = false;
      save(LS.customer, customer);
      closeProfileCreateSheet();
      updateProfileView();
      showToast('Profil angelegt! 👋', 2000);
      if(typeof triggerHapticFeedback === 'function') triggerHapticFeedback([10]);
    };
  }
  if(btnProfileCreateCancel) btnProfileCreateCancel.onclick = closeProfileCreateSheet;
  
  // Provider nav handlers
  document.getElementById('providerNav').addEventListener('click',(e)=>{
    const b = e.target.closest('button');
    if(!b) return;
    const go = b.dataset.pgo;
    if(go==='provider-home') showProviderHome();
    if(go==='provider-pickups') showProviderPickups();
    if(go==='provider-week') showProviderWeek();
    if(go==='provider-cookbook') showProviderCookbook();
    if(go==='provider-support') openSupportContact();
    if(go==='provider-profile') showProviderProfile();
  });
  // Kochbuch: Plus / „Neues Gericht“ – Delegation damit Tap immer den Gericht-anlegen-Flow öffnet
  document.addEventListener('click', function(e){
    var btn = e.target.closest('[data-action="cookbook-add-dish"]');
    if(!btn || !document.getElementById('v-provider-cookbook') || !document.getElementById('v-provider-cookbook').classList.contains('active')) return;
    e.preventDefault();
    e.stopPropagation();
    if(typeof haptic === 'function') haptic(6);
    if(selectedCookbookId){ if(typeof openCookbookLiveSheet === 'function') openCookbookLiveSheet(); }
    else { if(typeof openDishFlow === 'function') openDishFlow(); }
  }, true);
  const btnProviderNavBack = document.getElementById('btnProviderNavBack');
  if(btnProviderNavBack) btnProviderNavBack.onclick = function(){ showProviderHome(); };

  // Dashboard: „Wochenplan öffnen“-Button und Klick auf Wochenplan-Karte → volle Wochenplan-Ansicht
  document.addEventListener('click', function(e){
    var openBtn = e.target.closest('#btnDashboardOpenWeekPlan');
    if(openBtn){ e.preventDefault(); if(typeof showProviderWeek === 'function') showProviderWeek(); return; }
    var card = e.target.closest('#providerWeekCard');
    if(card && !e.target.closest('button') && !e.target.closest('.week-preview-link')){ e.preventDefault(); if(typeof showProviderWeek === 'function') showProviderWeek(); }
  }, true);

  // Customer nav handlers - Robuster Event-Delegation-Ansatz
  document.addEventListener('click', function(e){
    // Prüfe ob Klick innerhalb von customerNav (closest funktioniert auch bei pointer-events:none auf Kindern)
    const btn = e.target.closest('#customerNav button.navbtn');
    if(!btn || !btn.dataset.go) return;
    
    const go = btn.dataset.go;
    e.preventDefault();
    e.stopPropagation();
    
    
    try {
      if(go==='discover'){
        if(mode === 'start'){
          showStart();
        } else {
          showDiscover();
        }
      } else if(go==='fav'){
        showFav();
      } else if(go==='cart'){
        showCart();
      } else if(go==='orders'){
        showOrders();
      } else if(go==='profile'){
        showProfile();
      }
    } catch(err){
      console.error('Navigation error:', err, go);
      alert('Navigation-Fehler: ' + err.message);
    }
  }, true); // useCapture für frühere Event-Erfassung

  // --- Provider Dashboard (Home) - FINAL MVP ---
  let createFlowPreselectedDate = null; // Für Date-Preselect aus Today/Week
  let createFlowOriginView = 'dashboard'; // 'dashboard' = Pricing-Weiche (4,99/Gratis) | 'week' = nur Emerald Speichern
  
  // Zeit-Tracker Animation
  function animateTimeTracker(element, startHours, startMinutes, endHours, endMinutes){
    const duration = 1500; // 1.5 Sekunden
    const startTime = Date.now();
    const totalStartMinutes = startHours * 60 + startMinutes;
    const totalEndMinutes = endHours * 60 + endMinutes;
    const diff = totalEndMinutes - totalStartMinutes;
    
    function update(){
      const elapsed = Date.now() - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const easeOut = 1 - Math.pow(1 - progress, 3); // Ease-out cubic
      const currentMinutes = Math.round(totalStartMinutes + diff * easeOut);
      const currentHours = Math.floor(currentMinutes / 60);
      const currentMinutesRemainder = currentMinutes % 60;
      
      element.textContent = `${currentHours}h ${currentMinutesRemainder}min`;
      
      if(progress < 1){
        requestAnimationFrame(update);
      } else {
        element.textContent = `${endHours}h ${endMinutes}min`;
      }
    }
    
    update();
  }
  
  function renderProviderHome(){
    closeQuickPostSheet();
    updateSessionActivity();

    // Oben kein leerer Screen: Scroll sofort auf 0
    var homeEl = document.getElementById('v-provider-home');
    var wrapEl = homeEl && homeEl.querySelector('.dashboard-floating-wrap');
    if(wrapEl) wrapEl.scrollTop = 0;
    var mainEl = document.querySelector('main');
    if(mainEl) mainEl.scrollTop = 0;
    if(document.documentElement) document.documentElement.scrollTop = 0;
    if(document.body) document.body.scrollTop = 0;
    
    const profile = normalizeProviderProfile(provider.profile || {});
    const todayKey = isoDate(new Date());
    const mineAll = offers.filter(o => o.providerId === providerId());
    const mineActive = mineAll.filter(o => o.active !== false);
    const mineToday = mineActive.filter(o => o.day === todayKey);
    
    // Header: Begrüßung & Datum
    const firstName = (profile.name || '').trim().split(/\s+/)[0] || 'Chef';
    const greetingEl = document.getElementById('providerHomeGreeting');
    if(greetingEl) greetingEl.textContent = 'Hallo, ' + firstName;
    const dateEl = document.getElementById('providerHomeDate');
    if(dateEl){
      const d = new Date();
      const wd = ['So','Mo','Di','Mi','Do','Fr','Sa'][d.getDay()];
      dateEl.textContent = wd + ', ' + d.getDate() + '.' + String(d.getMonth() + 1).padStart(2, '0') + '.';
    }
    
    // Kunden-Nachfrage: Request-Count aus LocalStorage
    const requestCountEl = document.getElementById('providerRequestCount');
    if(requestCountEl){
      const requestCount = parseInt(localStorage.getItem(`provider_${providerId()}_requests`) || '0', 10);
      requestCountEl.textContent = requestCount;
      
      // Sektion nur anzeigen wenn Requests vorhanden
      const demandSection = document.getElementById('providerCustomerDemand');
      if(demandSection){
        if(requestCount > 0){
          demandSection.style.display = 'block';
        } else {
          demandSection.style.display = 'none';
        }
      }
    }
    
      // ---------------------------------------------------------
      // NEUE DASHBOARD LOGIK (Hero, Umsatz, Push)
      // ---------------------------------------------------------
      
      // 1. Daten berechnen
      const todayOrders = loadOrders().filter(o => {
        const offer = offers.find(off => off.id === o.dishId || off.providerId === o.providerId);
        return offer && offer.providerId === providerId() && offer.day === todayKey && o.status === 'PAID';
      });
      const tagesumsatzCents = todayOrders.reduce((sum, o) => sum + (o.totalCents || 0), 0);
      const tagesumsatzEuro = (tagesumsatzCents / 100).toFixed(2);
      
      const hasRevenue = tagesumsatzCents > 0;
      const hasOffers = mineToday.length > 0;
      const isHeroActive = hasRevenue || hasOffers;

      // 2. Hero Card Update
      const heroStateStart = document.getElementById('heroStateStart');
      const heroStateActive = document.getElementById('heroStateActive');
      const heroRevenue = document.getElementById('heroRevenueDisplay');
      const heroOrders = document.getElementById('heroOrdersCount');
      const heroPickups = document.getElementById('heroPickupCount');
      const btnHeroShare = document.getElementById('btnHeroShare');

      if(heroStateStart && heroStateActive){
        if(isHeroActive){
          heroStateStart.style.display = 'none';
          heroStateActive.style.display = 'block';
          
          if(heroRevenue) heroRevenue.textContent = tagesumsatzEuro.replace('.', ',') + ' €';
          if(heroOrders) heroOrders.textContent = todayOrders.length;
          if(heroPickups) heroPickups.textContent = todayOrders.filter(o => o.status === 'PAID').length;
          
          // Farbe bei Umsatz grün
          if(heroRevenue && hasRevenue) heroRevenue.style.color = '#2e7d32';
          else if(heroRevenue) heroRevenue.style.color = '#1a1a1a';
          
        } else {
          heroStateStart.style.display = 'block';
          heroStateActive.style.display = 'none';
        }
      }
      
      if(btnHeroShare){
        btnHeroShare.onclick = () => shareTodayOffers();
      }

      // 3. Push Pickup (Anzeigen wenn Inserat da, aber kein Abholnummer)
      const providerPushPickup = document.getElementById('providerPushPickup');
      if(providerPushPickup){
        // Wir zeigen die Push-Karte NICHT mehr an, da der User meinte "Bottom ist immer noch nicht immer da"
        // und das Layout "heller" und "appliker" sein soll.
        // Die Abholnummer-Logik ist jetzt im Inserats-Flow integriert.
        providerPushPickup.style.display = 'none';
      }

      // Alte Elemente ausblenden/aufräumen (falls noch Refs im Code)
      const providerTimeSaved = document.getElementById('providerTimeSaved');
      if(providerTimeSaved) providerTimeSaved.textContent = tagesumsatzEuro.replace('.', ',') + ' €';
      
      const todayPickups = todayOrders.length;
      const cookbookCount = cookbook.length;
      const kpiAbholungenCount = document.getElementById('kpiAbholungenCount');
      if(kpiAbholungenCount) kpiAbholungenCount.textContent = todayPickups;
      const kpiKochbuchCount = document.getElementById('kpiKochbuchCount');
      if(kpiKochbuchCount) kpiKochbuchCount.textContent = cookbookCount;
      const providerCookbookTiles = document.getElementById('providerCookbookTiles');
      if(providerCookbookTiles){
        const pid = providerId();
        const todayKey = isoDate(new Date());
        const mine = (cookbook||[]).filter(c=>c.providerId===pid);
        const topN = mine.slice().sort((a,b)=>(b.lastUsed||0)-(a.lastUsed||0) || (b.createdAt||0)-(a.createdAt||0)).slice(0,6);
        providerCookbookTiles.innerHTML = '';
        for(let i=0;i<6;i++){
          const c = topN[i];
          const tile = document.createElement('div');
          tile.className = 'cookbook-tile';
          tile.style.cssText = 'border-radius:14px; background:#fff; border:1px solid rgba(0,0,0,0.06); overflow:hidden; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.04); transition:transform 0.15s, box-shadow 0.15s; display:flex; flex-direction:column; min-height:0; min-width:0;';
          tile.setAttribute('role','button');
          tile.setAttribute('tabindex','0');
          tile.onmouseover = function(){ this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 14px rgba(0,0,0,0.08)'; };
          tile.onmouseout = function(){ this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.04)'; };
          if(c){
            const imgUrl = (c.photoData || c.imageUrl || 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=400&q=60').replace(/"/g,'&quot;').replace(/'/g,'%27');
            const name = (c.dish||'Gericht').length > 14 ? (c.dish||'').substring(0,12)+'…' : (c.dish||'Gericht');
            tile.innerHTML = '<div style="height:56px; flex-shrink:0; overflow:hidden; background:#f1f3f5;"><img src="'+imgUrl+'" alt="" style="width:100%; height:100%; object-fit:cover; display:block;" onerror="this.style.display=\'none\'"></div><div style="padding:8px 10px; flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;"><div style="font-size:11px; font-weight:800; color:#1a1a1a; text-align:center; line-height:1.2;">'+esc(name)+'</div><div style="font-size:10px; font-weight:700; color:#1a1a1a; margin-top:2px;">'+euro(c.price||0)+'</div><div style="margin-top:6px; font-size:10px; font-weight:800; color:#FFDE00; text-transform:uppercase; letter-spacing:0.03em;">Heute anbieten</div></div>';
            tile.onclick = function(ev){ if(!ev.target.closest('a')) { if(typeof startListingFlow==='function') startListingFlow({ dishId: c.id, date: todayKey }); } };
            tile.onkeydown = function(ev){ if(ev.key==='Enter'||ev.key===' '){ ev.preventDefault(); if(typeof startListingFlow==='function') startListingFlow({ dishId: c.id, date: todayKey }); } };
          } else {
            tile.innerHTML = '<div style="height:56px; background:#f1f3f5; display:flex; align-items:center; justify-content:center;"><i data-lucide="book-open" style="width:22px; height:22px; color:#cbd5e1;"></i></div><div style="padding:10px; text-align:center;"><div style="font-size:11px; color:#94a3b8;">–</div><div style="font-size:10px; color:#94a3b8; margin-top:4px;">Leer</div></div>';
            tile.onclick = function(){ if(typeof showProviderCookbook==='function') showProviderCookbook(); };
            tile.onkeydown = function(ev){ if(ev.key==='Enter'||ev.key===' '){ ev.preventDefault(); if(typeof showProviderCookbook==='function') showProviderCookbook(); } };
          }
          providerCookbookTiles.appendChild(tile);
        }
        if(typeof lucide!=='undefined') setTimeout(function(){ lucide.createIcons(); }, 50);
      }
      const kpiTagesessenDish = document.getElementById('kpiTagesessenDish');
      if(kpiTagesessenDish){
        if(mineToday.length > 0){
          const firstDish = mineToday[0];
          const dishName = firstDish.dish || firstDish.title || 'Gericht';
          kpiTagesessenDish.textContent = dishName.length > 18 ? dishName.substring(0, 18) + '…' : dishName;
        } else {
          kpiTagesessenDish.textContent = '–';
        }
      }

      // Dashboard 2.1: Header-Kennzahlen (Tagesessen, Abholungen, Umsatz)
      const dashTagesessen = document.getElementById('dashboardTagesessenCount');
      const dashAbholungen = document.getElementById('dashboardAbholungenCount');
      const dashKochbuch = document.getElementById('dashboardKochbuchCount');
      const dashUmsatz = document.getElementById('dashboardUmsatzToday');
      const dashAbholungenHint = document.getElementById('dashboardAbholungenHint');
      const dashUmsatzHint = document.getElementById('dashboardUmsatzHint');
      if(dashTagesessen) dashTagesessen.textContent = mineToday.length;
      if(dashAbholungen) dashAbholungen.textContent = todayPickups;
      if(dashAbholungenHint){ dashAbholungenHint.style.display = todayPickups === 0 ? 'block' : 'none'; }
      if(dashKochbuch) dashKochbuch.textContent = cookbookCount;
      const nettoEuro = (tagesumsatzCents / 100 - todayOrders.length * 0.89).toFixed(2);
      if(dashUmsatz){ dashUmsatz.textContent = nettoEuro.replace('.', ',') + ' €'; dashUmsatz.style.color = hasRevenue ? '#16a34a' : '#1a1a1a'; }
      if(dashUmsatzHint){ dashUmsatzHint.style.display = !hasRevenue ? 'block' : 'none'; }

      // KPI: Tagesessen-Label immer anzeigen; Abholungen/Umsatz-Labels ausblenden bei Aktivität
      const kpiLabelTagesessen = document.getElementById('kpiLabelTagesessen');
      const kpiLabelAbholungen = document.getElementById('kpiLabelAbholungen');
      const kpiLabelUmsatz = document.getElementById('kpiLabelUmsatz');
      if(kpiLabelTagesessen) kpiLabelTagesessen.style.display = '';
      if(kpiLabelAbholungen) kpiLabelAbholungen.style.display = todayPickups > 0 ? 'none' : '';
      if(kpiLabelUmsatz) kpiLabelUmsatz.style.display = hasRevenue ? 'none' : '';

      // KPI Click-Handler
      const kpiTagesessen = document.getElementById('kpiTagesessen');
      if(kpiTagesessen) kpiTagesessen.onclick = () => {
        const target = document.getElementById('providerActiveListingsSection');
        if(target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      };
      const kpiBestellungen = document.getElementById('kpiBestellungen');
      if(kpiBestellungen) kpiBestellungen.onclick = () => {
        if(typeof showProviderPickups === 'function') showProviderPickups();
      };
      const kpiUmsatz = document.getElementById('kpiUmsatz');
      if(kpiUmsatz){
        kpiUmsatz.onclick = () => { if(typeof showProviderBilling === 'function') showProviderBilling(); };
        kpiUmsatz.onkeydown = function(e){ if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); kpiUmsatz.click(); } };
      }

      // Aktive Inserate: Sektion immer sichtbar; bei 0 Tagesessen leere Karte mit CTA
      const providerActiveListings = document.getElementById('providerActiveListings');
      const providerActiveListingsSection = document.getElementById('providerActiveListingsSection');
      const providerActiveListingsEmptyCard = document.getElementById('providerActiveListingsEmptyCard');
      if(providerActiveListingsSection) providerActiveListingsSection.style.display = 'block';
      if(providerActiveListingsEmptyCard) providerActiveListingsEmptyCard.style.display = mineToday.length === 0 ? 'block' : 'none';
      var btnShareToday = document.getElementById('btnProviderShareToday');
      if(btnShareToday) btnShareToday.onclick = function(){ if(typeof shareTodayOffers === 'function') shareTodayOffers(); };
      if(providerActiveListings){
        providerActiveListings.innerHTML = '';
        providerActiveListings.style.display = mineToday.length > 0 ? 'flex' : 'none';
        var p = (provider && provider.profile) ? provider.profile : {};
        var defaultDineIn = p.dineInPossibleDefault !== false;
        var defaultPickup = !!p.abholnummerEnabledByDefault;
        var defaultReuse = !!p.reuseEnabledByDefault;
        mineToday.forEach(function(o){
          const d = normalizeOffer(o);
          const imgUrl = d.imageUrl || 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=800&q=70';
          const hasReusable = !!(o.reuse && o.reuse.enabled);
          const hasPickupNumber = !!o.hasPickupCode;
          const hasDineIn = o.dineInPossible !== false;
          const dishName = d.dish || d.title || 'Gericht';
          const isLive = o.active !== false;
          const viewsCount = parseInt(localStorage.getItem('mittagio_views_' + o.id) || '0', 10);
          const favCount = (JSON.parse(localStorage.getItem('mittagio_favorites') || '[]')).filter(function(id){ return id === o.id; }).length;
          const pickupsForOffer = todayOrders.filter(function(ord){ return ord.dishId === o.id; });
          const orderCount = pickupsForOffer.length;
          const paidWithCode = pickupsForOffer.filter(function(ord){ return ord.status === 'PAID' && ord.pickupCode; });
          const firstPickupCode = paidWithCode.length ? ('#' + (paidWithCode[0].pickupCode || String(paidWithCode[0].id || '').slice(-2))) : null;
          const abholnummerLabel = hasPickupNumber ? (firstPickupCode || '–') : '–';
          const abholnummerGray = !hasPickupNumber;
          // 3 Säulen: runde PillarIcons (green = Vor Ort, yellow = Abholnummer, petrol = Mehrweg) direkt unter dem Bild
          const pillarDineIn = hasDineIn ? 'active green' : '';
          const pillarPickup = hasPickupNumber ? 'active yellow' : '';
          const pillarReuse = hasReusable ? 'active petrol' : '';
          const pillarsRow = '<div class="card-pillars" style="display:flex; gap:12px; margin-bottom:12px;"><div class="pillar-mini ' + pillarDineIn + '" title="Vor Ort">🍴</div><div class="pillar-mini ' + pillarPickup + '" title="Abholnummer">🧾</div><div class="pillar-mini ' + pillarReuse + '" title="Mehrweg">🔄</div></div>';

          const card = document.createElement('div');
          card.className = 'prov-card';
          card.setAttribute('data-offer-id', String(o.id));
          card.setAttribute('role', 'button');
          card.setAttribute('tabindex', '0');
          card.style.padding = '0';
          card.style.overflow = 'hidden';
          card.style.cursor = 'pointer';
          card.innerHTML = `
            <div style="position:relative; height:180px; width:100%;">
              <img src="${esc(imgUrl)}" alt="" style="width:100%; height:100%; object-fit:cover;" />
              <div class="price-pill" style="position:absolute; bottom:12px; right:12px; padding:6px 14px; border-radius:999px; font-size:16px; font-weight:900;">${euro(d.price)}</div>
              ${isLive ? '<div style="position:absolute; top:12px; left:12px; background:rgba(255,255,255,0.9); backdrop-filter:blur(4px); padding:4px 10px; border-radius:8px; display:flex; align-items:center; gap:6px;"><span style="width:8px; height:8px; background:#22c55e; border-radius:50%;"></span><span style="font-size:10px; font-weight:800; text-transform:uppercase; color:#1a1a1a;">Live</span></div>' : ''}
            </div>
            <div style="padding:var(--card-padding, 20px);">
              ${pillarsRow}
              <h2 style="margin:0 0 16px; font-size:18px; font-weight:900; color:#1a1a1a;">${esc(dishName)}</h2>
              <div style="display:flex; gap:16px; margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid #f1f1f1;">
                <div style="display:flex; align-items:center; gap:6px;"><span style="font-size:16px;">👁️</span><span style="font-size:13px; font-weight:800;">${viewsCount}</span></div>
                <div style="display:flex; align-items:center; gap:6px;"><span style="font-size:16px;">❤️</span><span style="font-size:13px; font-weight:800;">${favCount}</span></div>
                <div style="display:flex; align-items:center; gap:6px;"><span style="font-size:16px;">🧾</span><span style="font-size:13px; font-weight:800;">${orderCount}</span></div>
              </div>
              <div style="margin-bottom:0; padding:8px 12px; border-radius:10px; background:${abholnummerGray ? '#f1f5f9' : 'rgba(255,215,0,0.15)'}; color:${abholnummerGray ? '#94a3b8' : '#1a1a1a'}; font-size:12px; font-weight:800; display:flex; align-items:center; gap:8px;">
                <span style="font-size:14px;">🧾</span>
                <span>Abholnummer</span>
                <span style="margin-left:auto; font-family:monospace; letter-spacing:0.05em;">${abholnummerLabel}</span>
              </div>
            </div>
          `;
          (function(offerId){
            card.onclick = function(ev){
              ev.preventDefault();
              ev.stopPropagation();
              try { if(typeof hapticLight === 'function') hapticLight(); else if(navigator.vibrate) navigator.vibrate(10); } catch(e){}
              var fn = typeof window !== 'undefined' && window.openProviderOffer;
              if(offerId && fn) fn(offerId);
            };
          })(String(o.id));
          providerActiveListings.appendChild(card);
        });
        if(!providerActiveListings._offerClickDelegation){
          providerActiveListings._offerClickDelegation = true;
          providerActiveListings.addEventListener('click', function(ev){
            var card = ev.target.closest('.prov-card[data-offer-id]');
            if(!card) return;
            var id = card.getAttribute('data-offer-id');
            var fn = typeof window !== 'undefined' && window.openProviderOffer;
            if(id && fn){
              ev.preventDefault();
              ev.stopPropagation();
              try { if(typeof hapticLight === 'function') hapticLight(); else if(navigator.vibrate) navigator.vibrate(10); } catch(e){}
              fn(id);
            }
          });
          providerActiveListings.addEventListener('keydown', function(ev){
            if(ev.key !== 'Enter' && ev.key !== ' ') return;
            var card = ev.target.closest('.prov-card[data-offer-id]');
            if(!card) return;
            ev.preventDefault();
            var id = card.getAttribute('data-offer-id');
            var fn = typeof window !== 'undefined' && window.openProviderOffer;
            if(id && fn) fn(id);
          });
        }
        if(typeof lucide !== 'undefined') setTimeout(function(){ lucide.createIcons(); }, 50);
      }

      // CTA-Button: Neues Gericht inserieren (wie FAB → openDishFlow)
      const btnProviderDashboardCTA = document.getElementById('btnProviderDashboardCTA');
      if(btnProviderDashboardCTA) btnProviderDashboardCTA.onclick = function(){ openDishFlow(); };

      // Live Abholnummern: Pills (Referenz 97525 – erste gelb #ffde00, rest grau)
      const providerNextPickupPills = document.getElementById('providerNextPickupPills');
      if(providerNextPickupPills){
        providerNextPickupPills.innerHTML = '';
        const paidOrders = todayOrders.filter(function(o){ return o.status === 'PAID' && o.pickupCode; });
        paidOrders.slice(0, 10).forEach(function(ord, i){
          const pill = document.createElement('div');
          const isFirst = i === 0;
          pill.style.cssText = 'flex-shrink:0; width:40px; height:40px; border-radius:50%; font-size:12px; font-weight:700; display:flex; align-items:center; justify-content:center; background:' + (isFirst ? '#ffde00' : '#f1f1f1') + '; color:' + (isFirst ? '#1a1a1a' : 'rgba(0,0,0,0.4)') + '; box-shadow:' + (isFirst ? 'inset 0 1px 2px rgba(0,0,0,0.08)' : 'none') + ';';
          pill.textContent = '#' + (ord.pickupCode || ord.id.slice(-3));
          providerNextPickupPills.appendChild(pill);
        });
        if(paidOrders.length === 0){
          const empty = document.createElement('div');
          empty.style.cssText = 'font-size:13px; color:rgba(0,0,0,0.4);';
          empty.textContent = 'Heute noch keine';
          providerNextPickupPills.appendChild(empty);
        }
      }
    
    // TODAY Card
    const providerTodayCard = document.getElementById('providerTodayCard');
    const providerTodayTitle = document.getElementById('providerTodayTitle');
    const providerTodayContent = document.getElementById('providerTodayContent');
    if(providerTodayCard && providerTodayTitle && providerTodayContent){
      const today = new Date();
      const weekday = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'][today.getDay()];
      const dateStr = `${today.getDate()}.${String(today.getMonth()+1).padStart(2,'0')}.`;
      providerTodayTitle.textContent = `Heute · ${weekday}, ${dateStr}`;
      
      if(mineToday.length > 0){
        const withCodeToday = mineToday.filter(o => o.hasPickupCode).length;
        const nextPickup = loadOrders().filter(o => {
          const offer = offers.find(off => off.id === o.dishId || off.providerId === o.providerId);
          return offer && offer.providerId === providerId() && offer.day === todayKey && o.status === 'PAID';
        }).sort((a,b) => (a.etaTime || '').localeCompare(b.etaTime || ''))[0];
        
        let html = `
          <div style="margin-bottom:12px;">
            <a href="#" id="providerTodayInserateLink" style="display:block; padding:10px; background:#f8f7f3; border-radius:12px; text-decoration:none; color:inherit; margin-bottom:8px;">
              <div style="font-weight:600; font-size:14px;">Inserate heute: ${mineToday.length}</div>
            </a>
            <a href="#" id="providerTodayPickupsLink" style="display:block; padding:10px; background:#f8f7f3; border-radius:12px; text-decoration:none; color:inherit;">
              <div style="font-weight:600; font-size:14px;">Abholungen heute: ${todayPickups}</div>
            </a>
        `;
        if(nextPickup && nextPickup.etaTime){
          const pickupCount = loadOrders().filter(o => {
            const offer = offers.find(off => off.id === o.dishId || off.providerId === o.providerId);
            return offer && offer.providerId === providerId() && offer.day === todayKey && o.status === 'PAID' && o.etaTime === nextPickup.etaTime;
          }).length;
          html += `
            <div style="margin-top:8px; padding:10px; background:#f8f7f3; border-radius:12px;">
              <div style="font-weight:600; font-size:14px;">Nächste Abholung: ${esc(nextPickup.etaTime)} (${pickupCount} ${pickupCount === 1 ? 'Abholnummer' : 'Abholnummern'})</div>
            </div>
          `;
        }
        html += `</div>`;
        providerTodayContent.innerHTML = html;
        
        const providerTodayInserateLink = document.getElementById('providerTodayInserateLink');
        if(providerTodayInserateLink) providerTodayInserateLink.onclick = (e) => {
          e.preventDefault();
          // Scroll to Active Offers section (falls vorhanden)
          const activeOffers = document.getElementById('providerActiveOffers');
          if(activeOffers){
            activeOffers.scrollIntoView({behavior: 'smooth', block: 'start'});
          }
        };
        const providerTodayPickupsLink = document.getElementById('providerTodayPickupsLink');
        if(providerTodayPickupsLink) providerTodayPickupsLink.onclick = (e) => {
          e.preventDefault();
          showProviderPickups();
        };
      } else {
        providerTodayContent.innerHTML = `
          <div style="font-weight:600; font-size:16px; margin-bottom:8px; text-align:center;">Keine Inserate heute</div>
          <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:var(--muted); text-align:center;">
            Erstelle dein erstes Inserat für heute.
          </div>
          <button class="btn secondary" type="button" id="btnProviderTodayAddDish" style="width:100%; min-height:44px;">
            Inserat für heute erstellen
          </button>
        `;
        const btnProviderTodayAddDish = document.getElementById('btnProviderTodayAddDish');
        if(btnProviderTodayAddDish) btnProviderTodayAddDish.onclick = () => {
          // Unified Flow: Direkt mit Heute-Datum
          openDishFlow(todayKey);
        };
      }
    }
    
    // Active Offers Mini List (max 3, expandable)
    const providerActiveOffers = document.getElementById('providerActiveOffers');
    const providerActiveOffersList = document.getElementById('providerActiveOffersList');
    if(providerActiveOffers && providerActiveOffersList){
      const showAll = providerActiveOffers.dataset.showAll === 'true';
      const activeList = showAll ? mineActive : mineActive.slice(0, 3);
      if(activeList.length > 0){
        providerActiveOffers.style.display = 'block';
        providerActiveOffersList.innerHTML = activeList.map(o => {
          // Status-Badge: "LIVE · Online bezahlt" oder "LIVE · Vor Ort"
          let statusBadge = '';
          if(o.active !== false){
            if(o.hasPickupCode){
              statusBadge = '<span style="font-size:11px; padding:2px 8px; background:rgba(46,125,50,.12); border-radius:6px; color:#2e7d32; font-weight:600;">🟢 LIVE · Online bezahlt</span>';
            } else {
              statusBadge = '<span style="font-size:11px; padding:2px 8px; background:rgba(0,0,0,.06); border-radius:6px; color:#666; font-weight:600;">⚪ LIVE · Vor Ort</span>';
            }
          }
          
          // Verzehrart-Badges
          const badges = [];
          const offerProvider = offers.find(p => p.providerId === o.providerId);
          const orderingEnabled = offerProvider && (offerProvider.orderingEnabled !== false && (o.hasPickupCode || offerProvider.hasPickupCode));
          if(orderingEnabled) badges.push('<span style="font-size:11px; padding:2px 6px; background:rgba(255,204,0,.15); border-radius:6px; color:var(--brand);">Abholnummer</span>');
          if(!orderingEnabled) badges.push('<span style="font-size:11px; padding:2px 6px; background:rgba(0,0,0,.06); border-radius:6px;">To Go</span>');
          
          // No-Limits: Prominenter "Ausverkauft" / "Noch da" Toggle direkt in der Liste
          const isActive = o.active !== false;
          const toggleBtn = isActive 
            ? `<button class="btn" type="button" data-offer-id="${esc(o.id)}" onclick="event.stopPropagation(); toggleOfferSoldOut('${esc(o.id)}');" style="background:#E34D4D; color:#fff; font-weight:700; padding:6px 12px; font-size:12px; min-height:32px; border-radius:8px; border:none; flex-shrink:0;">Ausverkauft</button>`
            : `<button class="btn" type="button" data-offer-id="${esc(o.id)}" onclick="event.stopPropagation(); toggleOfferSoldOut('${esc(o.id)}');" style="background:#4caf50; color:#fff; font-weight:700; padding:6px 12px; font-size:12px; min-height:32px; border-radius:8px; border:none; flex-shrink:0;">Wieder verfügbar</button>`;
          
          return `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 0; border-bottom:1px solid var(--border);">
              <div style="flex:1; min-width:0;" data-offer-id="${esc(o.id)}" style="cursor:pointer;">
                <div style="font-weight:600; font-size:14px; line-height:1.3; margin-bottom:4px;">${esc(o.dish || o.title || 'Gericht')}</div>
                <div style="font-size:12px; color:var(--muted); margin-bottom:6px;">${esc(o.pickupWindow || o.time || '')}</div>
                <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
                  ${statusBadge}
                  ${badges.join('')}
                </div>
              </div>
              <div style="display:flex; gap:8px; align-items:center; flex-shrink:0;">
                ${toggleBtn}
                <button class="btn ghost" type="button" data-offer-id="${esc(o.id)}" style="padding:8px; min-width:36px;" onclick="event.stopPropagation(); openOfferMoreMenu('${esc(o.id)}');">
                  ⋯
                </button>
              </div>
            </div>
          `;
        }).join('');
        
        // Tap on offer item
        providerActiveOffersList.querySelectorAll('[data-offer-id]').forEach(el => {
          if(el.tagName !== 'BUTTON'){
            el.onclick = () => {
              const offerId = el.dataset.offerId;
              startListingFlow({editOfferId: offerId});
            };
          }
        });
        
        const btnProviderShowAllOffers = document.getElementById('btnProviderShowAllOffers');
        if(btnProviderShowAllOffers){
          if(mineActive.length > 3){
            btnProviderShowAllOffers.style.display = 'inline-block';
            btnProviderShowAllOffers.onclick = (e) => {
              e.preventDefault();
              providerActiveOffers.dataset.showAll = 'true';
              renderProviderHome();
            };
          } else {
            btnProviderShowAllOffers.style.display = 'none';
          }
        }
      } else {
        providerActiveOffers.style.display = 'none';
      }
    }
    
    // Quick-Kill-Widget Handler (Not-Aus)
    const btnQuickKill = document.getElementById('btnQuickKill');
    if(btnQuickKill){
      btnQuickKill.onclick = () => {
        if(confirm('⚠️ NOT-AUS: Möchtest du wirklich ALLE aktiven Gerichte für heute schließen?\n\nDies kann nicht rückgängig gemacht werden.')){
          const todayKey = isoDate(new Date());
          let closedCount = 0;
          mineToday.forEach(o => {
            const offer = offers.find(off => off.id === o.id);
            if(offer && offer.active !== false){
              offer.active = false;
              closedCount++;
            }
          });
          save(LS.offers, offers);
          showToast(`✅ ${closedCount} Gericht${closedCount !== 1 ? 'e' : ''} geschlossen`);
          renderProviderHome();
          renderDiscover();
        }
      };
    }
    
    // Storno-Funktion für Bestellungen (0,89 € Servicegebühr bleibt)
    window.cancelOrder = function(orderId){
      const order = getOrderById(orderId);
      if(!order) return;
      
      if(order.status === 'PICKED_UP' || order.status === 'COMPLETED'){
        alert('Diese Bestellung wurde bereits abgeholt und kann nicht storniert werden.');
        return;
      }
      
      const serviceFee = 0.89; // Servicegebühr bleibt
      const refundAmount = (order.total || 0) / 100 - serviceFee;
      
      if(confirm(`Bestellung stornieren?\n\nErstattung: ${euro(refundAmount)}\nServicegebühr (0,89 €) wird einbehalten.\n\nFortfahren?`)){
        updateOrder(orderId, {
          status: 'CANCELLED',
          cancelledAt: Date.now(),
          refundAmount: Math.round(refundAmount * 100), // in cents
          serviceFeeRetained: Math.round(serviceFee * 100) // in cents
        });
        
        showToast(`Bestellung storniert. ${euro(refundAmount)} werden erstattet.`);
        
        // Historie speichern
        const history = load(LS.orderHistory, []);
        history.push({
          orderId: order.id,
          action: 'CANCELLED',
          timestamp: Date.now(),
          refundAmount: refundAmount,
          serviceFeeRetained: serviceFee
        });
        save(LS.orderHistory, history);
        
        // UI aktualisieren
        if(mode === 'provider'){
          renderProviderPickups();
          renderProviderHome();
        }
      }
    };
    
    // Week Preview
    renderProviderWeekPreviewNew();
    
    // Wochenplan-Karte: Tastatur (Enter/Space) öffnet volle Ansicht
    const providerWeekCardEl = document.getElementById('providerWeekCard');
    if(providerWeekCardEl && !providerWeekCardEl._weekCardKeyBound){
      providerWeekCardEl._weekCardKeyBound = true;
      providerWeekCardEl.onkeydown = function(ev){ if(ev.key==='Enter'||ev.key===' '){ ev.preventDefault(); if(!ev.target.closest('button') && typeof showProviderWeek==='function') showProviderWeek(); } };
    }
    
    // Footer-Button „Zum Wochenplan“ (app-like) → volle Wochenplan-Ansicht
    const btnProviderWeekFooter = document.getElementById('btnProviderWeekFooter');
    if(btnProviderWeekFooter){
      btnProviderWeekFooter.onclick = function(){ if(typeof haptic === 'function') haptic(6); if(typeof showProviderWeek === 'function') showProviderWeek(); };
      btnProviderWeekFooter.onkeydown = function(e){ if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); btnProviderWeekFooter.click(); } };
    }
    const btnProviderShareWeekPlan = document.getElementById('btnProviderShareWeekPlan');
    if(btnProviderShareWeekPlan) btnProviderShareWeekPlan.onclick = function(){ if(typeof haptic === 'function') haptic(6); if(typeof shareWeekPlan === 'function') shareWeekPlan(); };
    const btnProviderShareWeekPlanTitle = document.getElementById('btnProviderShareWeekPlanTitle');
    if(btnProviderShareWeekPlanTitle) btnProviderShareWeekPlanTitle.onclick = function(){ if(typeof haptic === 'function') haptic(6); if(typeof shareWeekPlan === 'function') shareWeekPlan(); };

    // Wochenplan-Button: Text mit Anzahl geplanter Gerichte (nächste 7 Tage)
    const btnWeekPlanText = document.getElementById('btnDashboardOpenWeekPlanText');
    if(btnWeekPlanText){
      const pid = providerId();
      let weekPlannedCount = 0;
      for(let i = 0; i < 7; i++){
        const d = new Date();
        d.setDate(d.getDate() + i);
        const key = isoDate(d);
        weekPlannedCount += (offers || []).filter(o => o.providerId === pid && o.active !== false && o.day === key).length;
        weekPlannedCount += ((week || {})[key] || []).filter(x => x.providerId === pid && x.active !== false).length;
      }
      btnWeekPlanText.textContent = weekPlannedCount > 0 ? 'Wochenplan · ' + weekPlannedCount + ' Gerichte geplant' : 'Wochenplan öffnen';
    }
    
    // Leere-Karte CTA: Erstes Gericht für heute
    const btnFirstDishToday = document.getElementById('btnProviderFirstDishToday');
    if(btnFirstDishToday) btnFirstDishToday.onclick = function(){ createFlowPreselectedDate = typeof isoDate === 'function' ? isoDate(new Date()) : null; createFlowOriginView = 'dashboard'; if(typeof openCreateFlowSheet === 'function') openCreateFlowSheet(); };
    
    // Post-Onboarding Dashboard State (if just completed onboarding)
    const providerEmptyDashboard = document.getElementById('providerEmptyDashboard');
    if(providerEmptyDashboard){
      const hasAnyData = mineActive.length > 0 || cookbook.length > 0;
      const justCompletedOnboarding = provider.onboardingCompleted && !provider.onboardingShown && cookbook.length > 0;
      
      if(justCompletedOnboarding){
        // Show post-onboarding state
        providerEmptyDashboard.style.display = 'block';
        providerEmptyDashboard.innerHTML = `
          <div style="font-weight:600; font-size:18px; margin-bottom:8px; line-height:1.3;">Gericht erstellt</div>
          <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:var(--muted);">
            Dein Gericht ist gespeichert. Veröffentliche es, um sichtbar zu werden.
          </div>
          <button class="btn-primary" type="button" id="btnPostOnboardingPublish" style="width:100%; min-height:56px; margin-bottom:12px;">
            Gericht veröffentlichen
          </button>
          <button class="btn secondary" type="button" id="btnPostOnboardingPlan" style="width:100%; min-height:44px;">
            Weiter planen
          </button>
        `;
        
        const btnPublish = document.getElementById('btnPostOnboardingPublish');
        const btnPlan = document.getElementById('btnPostOnboardingPlan');
        if(btnPublish){
          const savedDish = cookbook.find(c => c.providerId === providerId());
          if(savedDish){
            btnPublish.onclick = () => {
              openDishFlow(); // Unified Flow: Heute
            };
          }
        }
        if(btnPlan) btnPlan.onclick = () => showProviderCookbook();
        
        // Mark onboarding as shown
        provider.onboardingShown = true;
        save(LS.provider, provider);
      } else {
        // Normal empty state
        providerEmptyDashboard.style.display = hasAnyData ? 'none' : 'block';
        if(!hasAnyData){
          providerEmptyDashboard.innerHTML = `
            <div style="font-weight:600; font-size:18px; margin-bottom:8px; line-height:1.3;">Noch keine aktiven Inserate</div>
            <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:var(--muted);">
              Erstelle dein erstes Inserat, um für Kunden sichtbar zu werden.
            </div>
            <button class="btn secondary" type="button" id="btnProviderEmptyAddDish" style="width:100%; min-height:44px;">
              Gericht erstellen
            </button>
          `;
        }
        
        const btnProviderEmptyAddDish = document.getElementById('btnProviderEmptyAddDish');
        if(btnProviderEmptyAddDish) btnProviderEmptyAddDish.onclick = () => {
          openDishFlow();
        };
        // „Gericht erstellen“-Button entfernt (Dashboard: nur Kasten mit Aktive Angebote heute + Wochenplan)
      }
    }
    
    // FAB wird von ensureProviderFab() erstellt und dort verknüpft

    // Refresh Button Handler: Tooltip bereits im HTML; Loading-Feedback (disabled + Spinner)
    const btnRefresh = document.getElementById('btnProviderHomeRefresh');
    if(btnRefresh){
      btnRefresh.onclick = () => {
        if(btnRefresh.getAttribute('aria-busy') === 'true') return;
        btnRefresh.setAttribute('aria-busy', 'true');
        btnRefresh.disabled = true;
        const icon = btnRefresh.querySelector('i');
        if(icon) {
          icon.style.transition = 'transform 0.5s ease-in-out';
          icon.style.transform = 'rotate(360deg)';
        }
        renderProviderHome();
        setTimeout(() => {
          btnRefresh.removeAttribute('aria-busy');
          btnRefresh.disabled = false;
          if(icon) { icon.style.transform = 'rotate(0deg)'; icon.style.transition = 'none'; }
          if(typeof showToast === 'function') showToast('Daten aktualisiert');
        }, 400);
      };
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined') setTimeout(()=> lucide.createIcons(), 50);
  }

  // Week Preview (7 Tage) – Applike: neutrale Pills, gelb aktiv; Gerichteliste + Link zum Wochenplan
  function renderProviderWeekPreviewNew(){
    const dayWrap = document.getElementById('providerWeekDays');
    const dayContent = document.getElementById('providerWeekDayContent');
    if(!dayWrap || !dayContent) return;
    var draftCount = typeof getWeekDraftDays === 'function' ? getWeekDraftDays().length : 0;
    var draftEl = document.getElementById('providerWeekDraftCount');
    if(draftCount > 0){
      if(!draftEl){
        draftEl = document.createElement('p');
        draftEl.id = 'providerWeekDraftCount';
        draftEl.style.cssText = 'font-size:13px; font-weight:700; color:#64748b; margin:0 0 12px;';
        dayWrap.parentNode.insertBefore(draftEl, dayWrap);
      }
      draftEl.textContent = draftCount + ' Entwurf' + (draftCount !== 1 ? 'e' : '') + ' in den nächsten 4 Wochen';
      draftEl.style.display = '';
    } else if(draftEl){ draftEl.style.display = 'none'; }
    const today = new Date();
    let selectedDay = providerWeekDay || isoDate(today);
    
    const pid = typeof providerId === 'function' ? providerId() : '';
    dayWrap.innerHTML = '';
    for(let i = 0; i < 7; i++){
      const d = new Date(today);
      d.setDate(d.getDate() + i);
      const key = isoDate(d);
      const offersForThisDay = (offers || []).filter(function(o){ return o.providerId === pid && o.active !== false && o.day === key; });
      const weekEntriesForDay = (week[key] || []).filter(function(x){ return x.providerId === pid && x.active !== false; });
      const hasListings = offersForThisDay.length + weekEntriesForDay.length > 0;
      const hasOnline = offersForThisDay.length > 0;
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'week-preview-pill' + (selectedDay === key ? ' active' : '') + (hasListings ? ' has-listings' : '') + (hasOnline ? ' has-online' : '');
      const weekday = ['So','Mo','Di','Mi','Do','Fr','Sa'][d.getDay()];
      const dateStr = d.getDate() + '.' + String(d.getMonth()+1).padStart(2,'0') + '.';
      b.textContent = i === 0 ? 'Heute' : (weekday + '\n' + dateStr);
      b.title = hasOnline ? 'Online' : (hasListings ? 'Geplant' : 'Kein Gericht');
      b.onclick = function(){ if(typeof haptic === 'function') haptic(6); providerWeekDay = key; renderProviderWeekPreviewNew(); };
      dayWrap.appendChild(b);
    }
    
    const offersForDay = offers.filter(function(o){ return o.providerId === providerId() && o.active !== false && o.day === selectedDay; });
    const weekEntries = (week[selectedDay] || []).filter(function(x){ return x.providerId === providerId() && x.active !== false; });
    const totalPlanned = offersForDay.length + weekEntries.length;
    
    function euro(n){ return (Number(n)||0).toFixed(2).replace('.',',') + ' €'; }
    
    var allOrdersForSold = (typeof loadOrders === 'function' ? loadOrders() : []) || [];
    if(totalPlanned > 0){
      var mealWindow = (provider && provider.profile && provider.profile.mealWindow) ? provider.profile.mealWindow : '11:30 – 14:00';
      var dishRows = [];
      var hasOnline = offersForDay.length > 0;
      if(hasOnline) dishRows.push('<p class="week-preview-section-label">Aktiv &amp; Online</p>');
      offersForDay.forEach(function(o){
        var dishName = (typeof esc === 'function' ? esc(o.dish || 'Gericht') : (o.dish || 'Gericht').replace(/</g,'&lt;'));
        var soldCount = allOrdersForSold.filter(function(ord){ var o2 = (offers || []).find(function(x){ return x.id === ord.dishId || x.id === ord.offerId; }); return o2 && String(o2.providerId) === String(providerId()) && String((o2.dish || '').trim()) === String((o.dish || '').trim()); }).length;
        var soldBox = soldCount > 0 ? '<div class="week-preview-dish-sold"><span>Verkauft</span><span class="week-preview-dish-sold-num">' + soldCount + '</span></div>' : '';
        var imgSrc = (o.imageUrl || o.img || '').toString().trim();
        var thumbHtml = '<div class="week-preview-dish-thumb">' + (imgSrc ? '<img src="' + (typeof esc === 'function' ? esc(imgSrc) : String(imgSrc).replace(/"/g,'&quot;')) + '" alt="" loading="lazy"/>' : '') + '</div>';
        dishRows.push('<div class="week-preview-dish week-preview-dish-online" data-offer-id="' + (o.id || '') + '">' + thumbHtml + '<div class="week-preview-dish-inner"><div class="week-preview-dish-name">' + dishName + '</div></div>' + soldBox + '</div>');
      });
      weekEntries.forEach(function(e, slotIndex){
        var cb = cookbook.find(function(c){ return String(c.id) === String(e.cookbookId); });
        var name = (typeof esc === 'function' ? esc((cb && cb.dish) || e.dish || 'Gericht') : ((cb && cb.dish) || e.dish || 'Gericht').replace(/</g,'&lt;'));
        dishRows.push('<div class="week-preview-dish week-preview-dish-geplant" data-day="' + (typeof esc === 'function' ? esc(selectedDay) : selectedDay) + '" data-slot="' + slotIndex + '"><div class="week-preview-dish-name">' + name + '</div><div class="week-preview-dish-meta"><span class="week-preview-dish-status geplant">Geplant</span></div></div>');
      });
      dayContent.innerHTML = '<div class="week-preview-dishes">' + dishRows.join('') + '</div>';
      /* Direkt-Edit: Klick auf Gerichtskarte */
      var dishes = dayContent.querySelectorAll('.week-preview-dish');
      dishes.forEach(function(el){
        el.onclick = function(){
          if(typeof haptic === 'function') haptic(6);
          if(el.classList.contains('week-preview-dish-online')){
            var offerId = el.getAttribute('data-offer-id');
            if(offerId && typeof startListingFlow === 'function') startListingFlow({ editOfferId: offerId });
          } else if(el.classList.contains('week-preview-dish-geplant')){
            var day = el.getAttribute('data-day');
            var slot = parseInt(el.getAttribute('data-slot'), 10);
            if(typeof openWeekAddSheet === 'function') openWeekAddSheet(day, isNaN(slot) ? undefined : slot);
          }
        };
      });
    } else {
      var wdNames = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'];
      var gapDayName = wdNames[new Date(selectedDay + 'T12:00:00').getDay()];
      /* Stolz-Archiv: Vorschlag aus Kochbuch (Erfolgsgericht mit Verkäufen oder zuletzt genutzt) */
      var suggested = null;
      var allOrders = (typeof loadOrders === 'function' ? loadOrders() : []) || [];
      var mine = (cookbook || []).filter(function(c){ return String(c.providerId) === String(pid); });
      for(var si = 0; si < mine.length; si++){
        var e = mine[si];
        if(!e.lastUsed) continue;
        var sold = (offers || []).length ? allOrders.filter(function(ord){
          var o = offers.find(function(x){ return x.id === ord.dishId || x.id === ord.offerId; });
          if(!o || String(o.providerId) !== String(pid)) return false;
          return String(o.dish || '').trim() === String(e.dish || '').trim();
        }).length : 0;
        if(!suggested || sold > (suggested.soldCount || 0) || (sold === (suggested.soldCount || 0) && (e.lastUsed || 0) > (suggested.lastUsed || 0))) suggested = { dish: e.dish || 'Gericht', id: e.id, lastUsed: e.lastUsed, soldCount: sold };
      }
      if(!suggested && mine.length) suggested = { dish: mine[0].dish || 'Gericht', id: mine[0].id, lastUsed: mine[0].lastUsed, soldCount: 0 };
      var emptyLabel = (typeof esc === 'function' ? esc(gapDayName) : gapDayName.replace(/</g,'&lt;')) + ' ist noch leer';
      dayContent.innerHTML =
        '<div class="week-preview-dishes">' +
        '<div class="week-preview-empty-trigger" id="btnProviderWeekEmptyTrigger" role="button" tabindex="0">' +
        '<div class="week-preview-empty-plus prov-add-plus-icon" aria-hidden="true">＋</div>' +
        '<div><div class="week-preview-empty-label">' + emptyLabel + '</div><div class="week-preview-empty-cta">JETZT NEUES GERICHT</div></div>' +
        '</div></div>';
      var btnEmpty = document.getElementById('btnProviderWeekEmptyTrigger');
      if(btnEmpty) btnEmpty.onclick = function(){ if(typeof haptic === 'function') haptic(6); createFlowPreselectedDate = selectedDay; createFlowOriginView = 'week'; if(typeof openCreateFlowSheet === 'function') openCreateFlowSheet(); };
      if(btnEmpty) btnEmpty.onkeydown = function(e){ if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); btnEmpty.click(); } };
    }
    /* Haptik beim Einrasten (Snap-Carousel) – Dashboard-Wochenvorschau */
    if(dayWrap && !dayWrap._hapticSnapAttached){
      dayWrap._hapticSnapAttached = true;
      var snapT;
      dayWrap.addEventListener('scroll', function(){ clearTimeout(snapT); snapT = setTimeout(function(){ if(typeof haptic === 'function') haptic(6); }, 120); }, { passive: true });
      try { dayWrap.addEventListener('scrollend', function(){ if(typeof haptic === 'function') haptic(6); }, { passive: true }); } catch(e){}
    }
    if(typeof lucide !== 'undefined') lucide.createIcons();
  }
  
  // Kompatibilität
  function renderProviderWeekPreview(){
    const dayWrap = document.getElementById('provWeekDays');
    const list = document.getElementById('provWeekPreview');
    if(!dayWrap || !list) return;

    dayWrap.innerHTML = '';
    for(let i=0;i<5;i++){
      const d = new Date(); d.setDate(d.getDate()+i);
      const key = isoDate(d);
      const b = document.createElement('button');
      b.className = 'day' + (providerWeekDay===key ? ' active' : '');
      b.textContent = fmtDay(d);
      b.onclick=()=>{ providerWeekDay = key; renderProviderWeekPreview(); };
      dayWrap.appendChild(b);
    }

    const items = (week[providerWeekDay]||[]).filter(x=>x.providerId===providerId() && x.active !== false);
    if(!items.length){
      list.innerHTML = `
        <div>Keine Inserate geplant.</div>
        <div style="height:8px"></div>
        <button class="btn secondary" type="button" id="btnWeekAdd">Inserat hinzufügen</button>
      `;
      const addBtn = document.getElementById('btnWeekAdd');
      if(addBtn) addBtn.onclick=()=> startListingFlow({});
      return;
    }
    list.innerHTML = items.map(i=>`• ${esc(i.dish)}`).join('<br>');
  }

  function weekDayShortLabel(d, i){
    if(i === 0) return 'Heute';
    const days = ['So','Mo','Di','Mi','Do','Fr','Sa'];
    return days[d.getDay()] + ' ' + d.getDate() + '.' + (d.getMonth()+1) + '.';
  }

  /** Bundesland aus Anbieter-Adresse (PLZ). PLZ-Bereiche DE (vereinfacht). */
  function plzToBundesland(plz){
    var z = parseInt(String(plz || '').replace(/\D/g, '').slice(0, 2), 10);
    if(isNaN(z)) return null;
    if(z >= 1 && z <= 9) return 'BE';
    if(z >= 10 && z <= 11) return 'BE';
    if(z >= 12 && z <= 19) return 'BB';
    if(z === 20) return 'HH';
    if(z >= 21 && z <= 29) return 'SH';
    if(z >= 30 && z <= 36) return 'NI';
    if(z >= 37 && z <= 39) return 'ST';
    if(z >= 40 && z <= 48) return 'NW';
    if(z >= 49 && z <= 49) return 'NW';
    if(z >= 50 && z <= 53) return 'RP';
    if(z >= 54 && z <= 59) return 'RP';
    if(z >= 60 && z <= 67) return 'HE';
    if(z >= 68 && z <= 69) return 'BW';
    if(z >= 70 && z <= 79) return 'BW';
    if(z >= 80 && z <= 89) return 'BY';
    if(z >= 90 && z <= 92) return 'TH';
    if(z >= 93 && z <= 94) return 'SN';
    if(z >= 95 && z <= 96) return 'BY';
    if(z >= 97 && z <= 99) return 'TH';
    if(z === 0) return 'BE';
    return null;
  }
  function getBundeslandFromProvider(){
    var p = (typeof provider !== 'undefined' && provider && provider.profile) ? provider.profile : {};
    return plzToBundesland(p.zip) || plzToBundesland(p.address) || null;
  }

  /** Feiertage DE nach Bundesland (Adresse). Rückgabe: { 'YYYY-MM-DD': 'Feiertagsname' }. */
  function getGermanHolidaysForRange(startDate, endDate, bundesland){
    var out = {};
    var y1 = startDate.getFullYear(), y2 = endDate.getFullYear();
    var bl = bundesland || getBundeslandFromProvider();
    var has0106 = bl === 'BW' || bl === 'BY' || bl === 'ST';
    var has0815 = bl === 'BY' || bl === 'SL';
    var has1031 = bl === 'BB' || bl === 'MV' || bl === 'SN' || bl === 'ST' || bl === 'TH' || bl === 'HB' || bl === 'NI' || bl === 'SH' || bl === 'HH';
    var has1101 = bl === 'BW' || bl === 'BY' || bl === 'NW' || bl === 'RP' || bl === 'SL';
    var hasBuss = bl === 'SN';
    for(var y = y1; y <= y2; y++){
      out[y + '-01-01'] = 'Neujahr';
      if(has0106) out[y + '-01-06'] = 'Heilige Drei Könige';
      var oster = getEasterSunday(y);
      var kf = new Date(oster.getTime()); kf.setDate(kf.getDate() - 2);
      var om = new Date(oster.getTime()); om.setDate(om.getDate() + 1);
      var hi = new Date(oster.getTime()); hi.setDate(hi.getDate() + 39);
      var pf = new Date(oster.getTime()); pf.setDate(pf.getDate() + 50);
      out[isoDate(kf)] = 'Karfreitag';
      out[isoDate(oster)] = 'Ostersonntag';
      out[isoDate(om)] = 'Ostermontag';
      out[y + '-05-01'] = 'Tag der Arbeit';
      out[isoDate(hi)] = 'Christi Himmelfahrt';
      out[isoDate(pf)] = 'Pfingstmontag';
      if(has0815) out[y + '-08-15'] = 'Mariä Himmelfahrt';
      out[y + '-10-03'] = 'Tag der Deutschen Einheit';
      if(has1031) out[y + '-10-31'] = 'Reformationstag';
      if(has1101) out[y + '-11-01'] = 'Allerheiligen';
      if(hasBuss){
        var firstAdvent = getFirstAdvent(y);
        var buss = new Date(firstAdvent.getTime()); buss.setDate(buss.getDate() - 11);
        out[isoDate(buss)] = 'Buß- und Bettag';
      }
      out[y + '-12-25'] = '1. Weihnachtsfeiertag';
      out[y + '-12-26'] = '2. Weihnachtsfeiertag';
    }
    return out;
  }
  function getFirstAdvent(year){
    var dec24 = new Date(year, 11, 24);
    var dow = dec24.getDay();
    var daysBack = (dow === 0 ? 0 : dow) + 21;
    var d = new Date(year, 11, 24);
    d.setDate(d.getDate() - daysBack);
    return d;
  }
  function getEasterSunday(year){
    var a = year % 19, b = Math.floor(year/100), c = year % 100;
    var d = Math.floor(b/4), e = b % 4, f = Math.floor((b+8)/25);
    var g = Math.floor((b-f+1)/3), h = (19*a+b-d-g+15) % 30;
    var i = Math.floor(c/4), k = c % 4, l = (32+2*e+2*i-h-k) % 7;
    var m = Math.floor((a+11*h+22*l)/451), month = Math.floor((h+l-7*m+114)/31)-1;
    var day = ((h+l-7*m+114) % 31) + 1;
    return new Date(year, month, day);
  }

  function getWeekMonday(weekIndex){
    var today = new Date();
    var day = today.getDay();
    var diff = today.getDate() - day + (day === 0 ? -6 : 1);
    var monday = new Date(today.getFullYear(), today.getMonth(), diff + (weekIndex * 7));
    return monday;
  }
  function getISOWeek(d){
    d = new Date(d);
    d.setHours(0, 0, 0, 0);
    var thursday = new Date(d);
    thursday.setDate(d.getDate() + 4 - (d.getDay() || 7));
    var jan1 = new Date(thursday.getFullYear(), 0, 1);
    return Math.ceil((((thursday - jan1) / 86400000) + 1) / 7);
  }
  function getWeekDayKeys(weekIndex){
    var monday = getWeekMonday(weekIndex);
    var keys = [];
    for (var i = 0; i < 7; i++) {
      var d = new Date(monday.getFullYear(), monday.getMonth(), monday.getDate() + i);
      keys.push(isoDate(d));
    }
    return keys;
  }
  function getKWLabel(weekIndex){
    return 'KW ' + getISOWeek(getWeekMonday(weekIndex));
  }
  function getKWProgress(weekIndex){
    var keys = getWeekDayKeys(weekIndex);
    var filled = 0;
    keys.forEach(function(key){
      var provEntries = (week[key] || []).filter(function(x){ return x.providerId === providerId(); });
      var liveOffers = offers.filter(function(o){ return o.providerId === providerId() && o.day === key; });
      if (liveOffers.length > 0 || provEntries.length > 0) filled++;
    });
    return Math.min(1, filled / 7);
  }
  function moveWeekEntryToDay(dayFrom, slotFrom, dayTo){
    var arr = week[dayFrom];
    if (!arr || !arr[slotFrom]) return;
    var entry = arr[slotFrom];
    if (entry.providerId !== providerId()) return;
    arr.splice(slotFrom, 1);
    if (arr.length === 0) delete week[dayFrom];
    if (!week[dayTo]) week[dayTo] = [];
    week[dayTo].push(entry);
    save(LS.week, week);
    var boardWrap = document.getElementById('kwBoardWrap');
    if (boardWrap && boardWrap.style.display !== 'none' && typeof renderWeekPlanBoard === 'function') renderWeekPlanBoard();
    renderWeekPlan();
    renderProviderWeekPreview();
    if (typeof toast === 'function') toast('Gericht verschoben');
  }
  function attachKWBoardSlotGestures(grid){
    if (!grid) return;
    var SWIPE_THRESHOLD = 56;
    var LONG_PRESS_MS = 500;
    var slots = grid.querySelectorAll('.kw-slot[data-draft="1"]');
    slots.forEach(function(slotEl){
      var dayKey = slotEl.getAttribute('data-day');
      var slotIdx = parseInt(slotEl.getAttribute('data-slot'), 10) || 0;
      var startX = 0, currentX = 0, longPressTimer = null;
      function clearLongPress(){ if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; } }
      function handleSwipeEnd(){
        if (currentX < -SWIPE_THRESHOLD && typeof haptic === 'function') haptic(6);
        if (currentX < -SWIPE_THRESHOLD && typeof deletePlannedEntryWithUndo === 'function') deletePlannedEntryWithUndo(dayKey, slotIdx);
        slotEl.style.transform = '';
        slotEl.classList.remove('kw-slot-swipe-delete');
      }
      slotEl.addEventListener('touchstart', function(e){
        startX = e.touches[0].clientX;
        currentX = 0;
        clearLongPress();
        longPressTimer = setTimeout(function(){ longPressTimer = null; if (typeof haptic === 'function') haptic(6); openKWBoardMoveSheet(dayKey, slotIdx); }, LONG_PRESS_MS);
      }, { passive: true });
      slotEl.addEventListener('touchmove', function(e){
        currentX = e.touches[0].clientX - startX;
        if (currentX < -20) clearLongPress();
        if (currentX < 0) { slotEl.style.transform = 'translateX(' + currentX + 'px)'; if (Math.abs(currentX) >= SWIPE_THRESHOLD) slotEl.classList.add('kw-slot-swipe-delete'); }
      }, { passive: true });
      slotEl.addEventListener('touchend', function(){
        clearLongPress();
        handleSwipeEnd();
      }, { passive: true });
      slotEl.addEventListener('mousedown', function(e){
        if (e.button !== 0) return;
        startX = e.clientX;
        currentX = 0;
        clearLongPress();
        longPressTimer = setTimeout(function(){ longPressTimer = null; if (typeof haptic === 'function') haptic(6); openKWBoardMoveSheet(dayKey, slotIdx); }, LONG_PRESS_MS);
      });
      slotEl.addEventListener('mousemove', function(e){
        if (e.buttons !== 1) return;
        currentX = e.clientX - startX;
        if (currentX < -20) clearLongPress();
        if (currentX < 0) { slotEl.style.transform = 'translateX(' + currentX + 'px)'; if (Math.abs(currentX) >= SWIPE_THRESHOLD) slotEl.classList.add('kw-slot-swipe-delete'); }
      });
      slotEl.addEventListener('mouseup', function(){ clearLongPress(); handleSwipeEnd(); });
      slotEl.addEventListener('mouseleave', function(){ clearLongPress(); slotEl.style.transform = ''; slotEl.classList.remove('kw-slot-swipe-delete'); });
    });
  }
  function openKWBoardMoveSheet(fromDay, fromSlot){
    var arr = week[fromDay];
    if (!arr || !arr[fromSlot]) return;
    var entry = arr[fromSlot];
    if (entry.providerId !== providerId()) return;
    var keys = getWeekDayKeys(weekPlanKWIndex);
    var dayNames = ['Mo','Di','Mi','Do','Fr','Sa','So'];
    var overlay = document.createElement('div');
    overlay.className = 'kw-move-overlay';
    overlay.innerHTML = '<div class="kw-move-sheet"><div class="kw-move-title">Gericht verschieben nach</div><div class="kw-move-days"></div><button type="button" class="kw-move-cancel">Abbrechen</button></div>';
    var sheet = overlay.querySelector('.kw-move-sheet');
    var daysWrap = overlay.querySelector('.kw-move-days');
    keys.forEach(function(key, i){
      if (key === fromDay) return;
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'kw-move-day-btn';
      var d = new Date(key + 'T12:00:00');
      btn.textContent = dayNames[i] + ', ' + d.getDate() + '.';
      btn.onclick = function(){ if (typeof haptic === 'function') haptic(6); moveWeekEntryToDay(fromDay, fromSlot, key); overlay.remove(); };
      daysWrap.appendChild(btn);
    });
    overlay.querySelector('.kw-move-cancel').onclick = function(){ if (typeof haptic === 'function') haptic(6); overlay.remove(); };
    overlay.onclick = function(e){ if (e.target === overlay) overlay.remove(); };
    document.body.appendChild(overlay);
  }
  function renderWeekPlanBoard(){
    updateSessionActivity();
    week = load(LS.week, {});
    offers = load(LS.offers, []);
    provider = load(LS.provider, provider);
    var wrap = document.getElementById('kwBoardWrap');
    if (wrap) wrap.style.display = 'flex';
    var carousel = document.getElementById('kwCarousel');
    var progressFill = document.getElementById('kwProgressFill');
    var grid = document.getElementById('kwGrid');
    if (!carousel || !grid) return;
    carousel.innerHTML = '';
    for (var w = 0; w < 4; w++) {
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'kw-pill' + (w === weekPlanKWIndex ? ' active' : '');
      btn.textContent = getKWLabel(w);
      btn.setAttribute('data-kw', String(w));
      btn.onclick = (function(k){ return function(){ if(typeof haptic === 'function') haptic(6); weekPlanKWIndex = k; renderWeekPlanBoard(); }; })(w);
      carousel.appendChild(btn);
    }
    var progress = getKWProgress(weekPlanKWIndex);
    if (progressFill) progressFill.style.width = (progress * 100) + '%';
    var keys = getWeekDayKeys(weekPlanKWIndex);
    var dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
    var p = (provider && provider.profile) ? provider.profile : {};
    var defaultDineIn = p.dineInPossibleDefault !== false;
    var defaultPickup = !!p.abholnummerEnabledByDefault;
    var defaultReuse = !!p.reuseEnabledByDefault;
    var scrollEl = document.getElementById('kwBoardScroll');
    var strip = document.getElementById('kwCookbookStrip');
    if (scrollEl && !strip) {
      strip = document.createElement('div');
      strip.id = 'kwCookbookStrip';
      strip.className = 'kw-cookbook-drag-strip';
      strip.setAttribute('role', 'list');
      scrollEl.insertBefore(strip, grid);
    }
    if (strip) {
      var mine = (cookbook || []).filter(function(c){ return c.providerId === providerId(); });
      strip.innerHTML = '<span class="kw-cookbook-drag-label">Aus Kochbuch ziehen:</span>' + (mine.slice(0, 8).map(function(c){
        return '<div class="kw-cookbook-drag-pill" draggable="true" data-cookbook-id="' + esc(String(c.id)) + '" role="button">' + esc((c.dish || 'Gericht').substring(0, 12)) + (c.dish && c.dish.length > 12 ? '…' : '') + '</div>';
      }).join(''));
      strip.querySelectorAll('.kw-cookbook-drag-pill').forEach(function(pill){
        pill.ondragstart = function(e){
          e.dataTransfer.setData('text/plain', pill.getAttribute('data-cookbook-id'));
          e.dataTransfer.effectAllowed = 'copy';
          if(typeof haptic === 'function') haptic(6);
        };
      });
    }
    grid.innerHTML = '';
    keys.forEach(function(key, dayIdx){
      var d = new Date(key + 'T12:00:00');
      var dayLabel = dayNames[dayIdx];
      var dateLabel = d.getDate() + '.' + (d.getMonth() + 1) + '.';
      var provEntries = (week[key] || []).filter(function(x){ return x.providerId === providerId(); });
      var liveOffers = offers.filter(function(o){ return o.providerId === providerId() && o.day === key; });
      var items = liveOffers.length > 0 ? liveOffers : provEntries;
      var isLive = liveOffers.length > 0;
      var card = document.createElement('div');
      card.className = 'kw-day-card' + (isLive ? ' kw-day-has-live' : '');
      card.setAttribute('data-date', key);
      card.innerHTML = '<div class="kw-day-label">' + dayLabel + '</div><div class="kw-day-date">' + dateLabel + '</div><div class="kw-slots"></div>';
      var slotsWrap = card.querySelector('.kw-slots');
      var numSlots = items.length >= 3 ? 4 : 3;
      for (var slot = 0; slot < numSlots; slot++) {
        var entry = items[slot];
        if (entry) {
          var cb = cookbook.find(function(c){ return String(c.id) === String(entry.cookbookId); });
          var name = (cb && cb.dish) || entry.dish || 'Gericht';
          var price = (cb && cb.price) || entry.price || 0;
          var img = (cb && cb.photoData) || entry.photoData || entry.imageUrl || '';
          var entryDineIn = entry.dineInPossible !== false;
          var entryPickup = !!(entry.hasPickupCode !== undefined ? entry.hasPickupCode : defaultPickup);
          var entryReuse = !!(entry.reuse && entry.reuse.enabled);
          var hasTime = isLive || !!(entry.timeStart && entry.timeEnd);
          var showVorOrt = (entry.dineInPossible !== undefined) && (entryDineIn !== defaultDineIn);
          var showMehrweg = (entry.reuse !== undefined) && (entryReuse !== defaultReuse);
          var overrideBadges = [];
          if (showVorOrt) overrideBadges.push('<span title="Vor Ort (Abweichung)">🍴</span>');
          if (showMehrweg) overrideBadges.push('<span title="Mehrweg (Abweichung)">🔄</span>');
          var badgeHtml = overrideBadges.length ? '<div class="kw-slot-override-badges">' + overrideBadges.join('') + '</div>' : '';
          function kwPowerIcon(emoji, ok, timeMissing){ var c = 'week-power-icon'; if(timeMissing) c += ' week-power-time-missing'; else if(ok) c += (emoji === '🕒' ? ' week-power-time-ok' : ' week-power-icon-ok'); else c += ' week-power-icon-muted'; return '<span class="' + c + '">' + emoji + '</span>'; }
          var kwPowerBar = '<div class="week-power-bar kw-slot-power">' + kwPowerIcon('🍴', entryDineIn, false) + kwPowerIcon('🕒', hasTime, !hasTime) + kwPowerIcon('🧾', entryPickup, false) + kwPowerIcon('🔄', entryReuse, false) + '</div>';
          if (slot === 0) {
            var slotEl = document.createElement('div');
            slotEl.className = 'kw-slot kw-slot-main' + (isLive ? ' kw-slot-live' : '');
            slotEl.setAttribute('data-day', key);
            slotEl.setAttribute('data-slot', String(slot));
            if (!isLive) slotEl.setAttribute('data-draft', '1');
            slotEl.innerHTML = '<div class="kw-slot-thumb" style="' + (img ? 'background-image:url(\'' + esc(img) + '\')' : '') + '">' + badgeHtml + '</div><div class="kw-slot-body"><div class="kw-slot-name">' + esc(name) + '</div><div class="kw-slot-price"><span class="price-pill">' + euro(price) + '</span></div>' + kwPowerBar + '</div>';
            slotEl.onclick = (function(k, idx){ return function(e){ e.stopPropagation(); if(slotEl.classList.contains('kw-slot-swipe-delete')) return; if(typeof haptic === 'function') haptic(6); weekPlanDay = k; if(isLive && items[idx] && items[idx].id){ if(typeof startListingFlow === 'function') startListingFlow({ editOfferId: items[idx].id }); } else { if(typeof openWeekAddSheet === 'function') openWeekAddSheet(k, idx); } }; })(key, slot);
            slotsWrap.appendChild(slotEl);
          } else {
            var slotSmall = document.createElement('div');
            slotSmall.className = 'kw-slot kw-slot-small' + (isLive ? ' kw-slot-live' : '');
            slotSmall.setAttribute('data-day', key);
            slotSmall.setAttribute('data-slot', String(slot));
            if (!isLive) slotSmall.setAttribute('data-draft', '1');
            slotSmall.innerHTML = '<div class="kw-slot-thumb" style="' + (img ? 'background-image:url(\'' + esc(img) + '\')' : '') + '">' + badgeHtml + '</div><div class="kw-slot-name">' + esc(name) + '</div><div class="kw-slot-price"><span class="price-pill">' + euro(price) + '</span></div>' + kwPowerBar + '';
            slotSmall.onclick = (function(k, idx){ return function(e){ e.stopPropagation(); if(slotSmall.classList.contains('kw-slot-swipe-delete')) return; if(typeof haptic === 'function') haptic(6); weekPlanDay = k; if(isLive && items[idx] && items[idx].id){ if(typeof startListingFlow === 'function') startListingFlow({ editOfferId: items[idx].id }); } else { if(typeof openWeekAddSheet === 'function') openWeekAddSheet(k, idx); } }; })(key, slot);
            slotsWrap.appendChild(slotSmall);
          }
        } else {
          var empty = document.createElement('button');
          empty.type = 'button';
          empty.className = 'kw-slot kw-slot-empty';
          empty.setAttribute('data-day', key);
          empty.setAttribute('aria-label', 'Gericht hinzufügen für ' + dayLabel + ', ' + dateLabel);
          empty.textContent = '+';
          empty.onclick = (function(k){ return function(e){ e.preventDefault(); e.stopPropagation(); if(typeof haptic === 'function') haptic(6); weekPlanDay = k; createFlowPreselectedDate = k; createFlowOriginView = 'week'; if(typeof openCreateFlowSheet === 'function') openCreateFlowSheet(); }; })(key);
          slotsWrap.appendChild(empty);
        }
      }
      grid.appendChild(card);
    });
    attachKWBoardSlotGestures(grid);
    grid.querySelectorAll('.kw-slot, .kw-slot-empty').forEach(function(slotEl){
      var dayKey = slotEl.getAttribute('data-day');
      if(!dayKey) return;
      slotEl.ondragover = function(e){ e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; slotEl.classList.add('kw-slot-drop-over'); };
      slotEl.ondragleave = function(){ slotEl.classList.remove('kw-slot-drop-over'); };
      slotEl.ondrop = function(e){
        e.preventDefault();
        slotEl.classList.remove('kw-slot-drop-over');
        var cookbookId = e.dataTransfer.getData('text/plain');
        if(!cookbookId || typeof addCookbookEntryToWeek !== 'function') return;
        addCookbookEntryToWeek(dayKey, cookbookId);
        if(typeof haptic === 'function') haptic(6);
        renderWeekPlanBoard();
        if(typeof showToast === 'function') showToast('Gericht eingetragen');
      };
    });
    var btnKwPdf = document.getElementById('btnKwPdf');
    var btnKwShare = document.getElementById('btnKwShare');
    if (btnKwPdf) btnKwPdf.onclick = function(){ if(typeof haptic === 'function') haptic(6); if(typeof printWeekCard === 'function') printWeekCard(); };
    if (btnKwShare) btnKwShare.onclick = function(){ if(typeof haptic === 'function') haptic(6); if(typeof shareWeekPlan === 'function') shareWeekPlan(); };
    var monday = getWeekMonday(weekPlanKWIndex);
    var sunday = new Date(monday.getFullYear(), monday.getMonth(), monday.getDate() + 6);
    var sub = document.getElementById('weekHeaderSubtitle');
    if (sub) sub.textContent = getKWLabel(weekPlanKWIndex) + ' · ' + monday.getDate() + '. – ' + sunday.getDate() + '.' + (sunday.getMonth() !== monday.getMonth() ? ' ' + ['Jan','Feb','Mär','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'][sunday.getMonth()] : '');
    if (typeof lucide !== 'undefined') lucide.createIcons();
  }
  function renderWeekPlan(){
    updateSessionActivity();
    var boardWrap = document.getElementById('kwBoardWrap');
    const dayWrap = document.getElementById('weekDays');
    const list = document.getElementById('weekList');
    /* Nur KW-Board. Ohne weekDays/weekList → Board anzeigen. */
    if(!dayWrap || !list){
      if (boardWrap) boardWrap.style.display = 'flex';
      if (boardWrap && typeof renderWeekPlanBoard === 'function') renderWeekPlanBoard();
      if (typeof renderProviderWeekPreview === 'function') renderProviderWeekPreview();
      return;
    }
    if (boardWrap) boardWrap.style.display = 'none';
    let actionsBar = document.getElementById('weekActionsBar');
    let activateBlock = document.getElementById('weekActivateBlock');
    const thumbZone = document.getElementById('weekThumbZone');
    const headerTitle = document.getElementById('weekHeaderTitle');
    const headerSubtitle = document.getElementById('weekHeaderSubtitle');
    const headerDoneBtn = document.getElementById('weekHeaderDoneBtn');

    if(weekPlanMode === 'overview'){
      if(headerTitle) headerTitle.textContent = 'Wochenplan';
      if(headerSubtitle) headerSubtitle.textContent = 'Deine Woche im Überblick';
      if(headerDoneBtn) headerDoneBtn.style.display = 'none';
      dayWrap.style.display = 'none';
      dayWrap.innerHTML = '';
      var ir = document.getElementById('weekIndicatorRow');
      if(ir) ir.style.display = 'none';
      var todayKey = isoDate(new Date());
      var hasDraftToday = false;
      var draftCount4Weeks = typeof getWeekDraftDays === 'function' ? getWeekDraftDays().length : 0;
      var dayCardsHtml = '';
      for(var w = 0; w < 4; w++){
        var weekStart = w * 7;
        var weekLabel = 'KW ' + (w + 1);
        var rowHtml = '<div class="week-overview-week-row" style="margin-bottom:16px;"><div class="week-overview-day-label" style="margin-bottom:8px;">' + weekLabel + '</div>';
        for(var i = 0; i < 7; i++){
          var idx = weekStart + i;
          var d = new Date(); d.setDate(d.getDate() + idx);
          var key = isoDate(d);
          var entriesForDay = week[key] || [];
          var provEntries = entriesForDay.filter(function(x){ return x.providerId === providerId(); });
          var liveOffers = offers.filter(function(o){ return o.providerId === providerId() && o.day === key; });
          var isLive = liveOffers.length > 0;
          if(key === todayKey && !isLive && provEntries.length > 0) hasDraftToday = true;
          var label = weekDayShortLabel(d, idx);
          var badge = isLive ? '<span class="week-overview-badge online">ONLINE</span>' : (provEntries.length ? '<span class="week-overview-badge draft">ENTWURF</span>' : '');
          var names = [];
          if(isLive){ liveOffers.forEach(function(o){ var cb = cookbook.find(function(c){ return String(c.id) === String(o.cookbookId); }); names.push(cb && cb.dish ? esc(cb.dish) : (o.dish || 'Gericht')); }); }
          else { provEntries.forEach(function(e){ var cb = cookbook.find(function(c){ return String(c.id) === String(e.cookbookId); }); names.push(cb && cb.dish ? esc(cb.dish) : (e.dish || 'Gericht')); }); }
          var dishesHtml = names.length ? names.join(' · ') : '<span class="empty">—</span>';
          rowHtml += '<div class="week-overview-day' + (isLive ? ' week-day-online' : '') + '" style="margin-bottom:8px;"><div class="week-overview-day-label">' + label + ' ' + badge + '</div><div class="week-overview-dishes' + (names.length ? '' : ' empty') + '">' + dishesHtml + '</div></div>';
        }
        rowHtml += '</div>';
        dayCardsHtml += rowHtml;
      }
      list.innerHTML = '<div class="week-overview-scroll">' + (draftCount4Weeks > 0 ? '<p class="week-overview-draft-count" style="font-size:13px; font-weight:700; color:#64748b; margin-bottom:12px;">' + draftCount4Weeks + ' Entwurf' + (draftCount4Weeks !== 1 ? 'e' : '') + ' in den nächsten 4 Wochen</p>' : '') + dayCardsHtml + '</div>';
      list.classList.add('week-overview-list');
      if(thumbZone){
        thumbZone.innerHTML = '<div class="week-overview-cta-wrap"><button type="button" class="week-edit-primary" id="weekOverviewEditBtn"><i data-lucide="pencil" style="width:22px;height:22px;"></i> Plan bearbeiten</button></div><div class="week-actions-bar" id="weekOverviewActions" style="display:flex; align-items:center; gap:10px; margin-top:12px; flex-wrap:nowrap;"><button class="btn secondary" type="button" id="weekOverviewActivate" style="' + (hasDraftToday ? '' : 'display:none;') + ' flex:0 0 auto; min-height:48px; padding:0 16px; border-radius:14px; font-size:14px; font-weight:700;" onclick="activateWeekDay(isoDate(new Date())); renderWeekPlan();">Live</button><button class="btn secondary" type="button" id="weekOverviewPdf" style="flex:1; min-height:48px; border-radius:14px; font-size:14px; font-weight:700;"><i data-lucide="printer" style="width:18px;height:18px;margin-right:6px;"></i>Drucken</button><button class="btn secondary" type="button" id="weekOverviewShare" style="flex:1; min-height:48px; border-radius:14px; font-size:14px; font-weight:700;"><i data-lucide="share-2" style="width:18px;height:18px;margin-right:6px;"></i>Teilen</button></div>';
        var editBtn = document.getElementById('weekOverviewEditBtn');
        if(editBtn) editBtn.onclick = function(){ weekPlanMode = 'edit'; renderWeekPlan(); };
        var pdfBtn = document.getElementById('weekOverviewPdf');
        if(pdfBtn) pdfBtn.onclick = function(){ if(typeof printWeekCard === 'function') printWeekCard(); };
        var shareBtn = document.getElementById('weekOverviewShare');
        if(shareBtn) shareBtn.onclick = function(){ if(typeof shareWeekPlan === 'function') shareWeekPlan(); };
      }
      if(typeof lucide !== 'undefined') lucide.createIcons();
      return;
    }

    weekPlanMode = weekPlanMode || 'edit';
    if(headerTitle) headerTitle.textContent = 'Wochenplan';
    if(headerSubtitle) headerSubtitle.textContent = 'Deine Woche · Gerichte planen';
    if(headerDoneBtn){ headerDoneBtn.style.display = 'block'; headerDoneBtn.onclick = function(){ weekPlanMode = 'overview'; renderWeekPlan(); }; }
    dayWrap.style.display = '';
    list.classList.remove('week-overview-list');
    if(thumbZone) thumbZone.innerHTML = '<div id="weekMasterActivateBar" class="week-master-activate-bar" style="display:none;"><button type="button" class="week-master-btn" id="btnWeekMasterActivate"></button></div><div class="week-activate-block" id="weekActivateBlock" style="display:none;"><button type="button" class="week-activate-btn" id="btnWeekActivateThumb"><span class="week-activate-btn-text">Jetzt für 4,99 € aktivieren</span></button></div><div class="week-actions-bar" id="weekActionsBar" style="display:none; margin-top:12px;"><button class="btn secondary" type="button" id="btnWeekRefreshZone" style="flex:0 0 auto; min-height:52px; min-width:52px; padding:0; border-radius:14px;" aria-label="Aktualisieren"><i data-lucide="refresh-cw" style="width:22px;height:22px;"></i></button><button class="btn secondary" type="button" id="btnWeekPdf" style="flex:1; min-height:52px; border-radius:14px; font-size:15px; font-weight:700;"><i data-lucide="printer" style="width:20px;height:20px;margin-right:8px;"></i>Drucken</button><button class="btn secondary" type="button" id="btnWeekShare" style="flex:1; min-height:52px; border-radius:14px; font-size:15px; font-weight:700;"><i data-lucide="share-2" style="width:20px;height:20px;margin-right:8px;"></i>Teilen</button></div>';
    actionsBar = document.getElementById('weekActionsBar');
    activateBlock = document.getElementById('weekActivateBlock');
    var btnRefresh = document.getElementById('btnWeekRefreshZone');
    if(btnRefresh) btnRefresh.onclick = function(){ renderWeekPlan(); if(typeof showToast === 'function') showToast('Aktualisiert'); };
    var btnPdf = document.getElementById('btnWeekPdf');
    if(btnPdf) btnPdf.onclick = function(){ if(typeof printWeekCard === 'function') printWeekCard(); };
    var btnShare = document.getElementById('btnWeekShare');
    if(btnShare) btnShare.onclick = function(){ if(typeof shareWeekPlan === 'function') shareWeekPlan(); };

    var rangeStart = new Date();
    var rangeEnd = new Date(); rangeEnd.setDate(rangeEnd.getDate() + 27);
    var holidays = getGermanHolidaysForRange(rangeStart, rangeEnd, getBundeslandFromProvider());
    dayWrap.innerHTML = '';
    var weekIndicatorRow = document.getElementById('weekIndicatorRow');
    if(!weekIndicatorRow){
      weekIndicatorRow = document.createElement('div');
      weekIndicatorRow.id = 'weekIndicatorRow';
      weekIndicatorRow.className = 'week-indicator-row';
      dayWrap.parentNode && dayWrap.parentNode.insertBefore(weekIndicatorRow, dayWrap.nextSibling);
    }
    var weekStatuses = [];
    for(var w = 0; w < 4; w++){
      var hasLive = false, hasDraft = false;
      for(var di = 0; di < 7; di++){
        var wd = new Date(); wd.setDate(wd.getDate() + w * 7 + di);
        var k = isoDate(wd);
        var provEntries = (week[k] || []).filter(function(x){ return x.providerId === providerId(); });
        var liveOffers = offers.filter(function(o){ return o.providerId === providerId() && o.day === k; });
        if(liveOffers.length > 0) hasLive = true;
        else if(provEntries.length > 0) hasDraft = true;
      }
      weekStatuses.push(hasLive ? 'active' : (hasDraft ? 'draft' : 'empty'));
    }
    weekIndicatorRow.style.display = 'flex';
    weekIndicatorRow.innerHTML = weekStatuses.map(function(s, w){
      return '<button type="button" class="week-indicator-dot week-dot-' + s + '" data-week="' + w + '" aria-label="Woche ' + (w + 1) + '" aria-hidden="false"></button>';
    }).join('');
    for(var i = 0; i < 28; i++){
      var d = new Date(); d.setDate(d.getDate() + i);
      var key = isoDate(d);
      var b = document.createElement('button');
      b.type = 'button';
      b.className = 'week-day-pill' + (weekPlanDay === key ? ' active' : '') + (i === 0 ? ' week-day-pill-today' : '') + (holidays[key] ? ' week-day-pill-holiday' : '');
      b.setAttribute('data-date', key);
      if(holidays[key]) b.setAttribute('title', 'Feiertag: ' + holidays[key]);
      b.textContent = weekDayShortLabel(d, i);
      b.onclick = function(k){ return function(){ if(typeof haptic === 'function') haptic(6); weekPlanDay = k; renderWeekPlan(); }; }(key);
      dayWrap.appendChild(b);
    }
    weekIndicatorRow.querySelectorAll('.week-indicator-dot').forEach(function(btn){
      var w = parseInt(btn.getAttribute('data-week'), 10);
      btn.onclick = function(){
        if(typeof haptic === 'function') haptic(6);
        var idx = w * 7;
        if(dayWrap.children[idx]) dayWrap.children[idx].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      };
    });
    /* Haptic beim Einrasten im Snap-Carousel (Magic Slider) */
    if(!dayWrap._hapticSnapAttached){
      dayWrap._hapticSnapAttached = true;
      var snapTimeout;
      dayWrap.addEventListener('scroll', function(){
        clearTimeout(snapTimeout);
        snapTimeout = setTimeout(function(){ if(typeof haptic === 'function') haptic(6); }, 120);
      }, { passive: true });
      try { dayWrap.addEventListener('scrollend', function(){ if(typeof haptic === 'function') haptic(6); }, { passive: true }); } catch(e){}
    }
    requestAnimationFrame(function(){
      requestAnimationFrame(function(){
        dayWrap.scrollLeft = 0;
      });
    });

    const dayEntries = week[weekPlanDay] || [];
    const providerEntries = dayEntries.map((entry, idx)=>({entry, idx})).filter(x => x.entry.providerId === providerId());
    const dayLiveOffers = offers.filter(o => o.providerId === providerId() && o.day === weekPlanDay);
    const dayIsLive = dayLiveOffers.length > 0;

    if(!providerEntries.length && !dayIsLive){
      list.innerHTML = `
        <div class="week-empty-state">
          <div style="width:72px; height:72px; background:rgba(255,215,0,0.12); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px;">
            <i data-lucide="calendar-plus" style="width:36px; height:36px; color:var(--brand,#FFD700);"></i>
          </div>
          <div class="week-empty-title">Noch kein Plan für diesen Tag</div>
          <div class="week-empty-hint">Wähle ein Gericht aus dem Kochbuch oder lege ein neues an.</div>
          <button class="btn-primary provider-add-plus-btn" type="button" id="btnWeekEmptyAdd" style="width:100%; max-width:280px; min-height:56px; border-radius:14px; margin-bottom:10px;">
            <span class="plus-char" style="font-size:20px; line-height:1; color:#fff;">+</span>
            <span>Gericht hinzufügen</span>
          </button>
          <button class="btn secondary" type="button" id="btnWeekEmptyNew" style="width:100%; max-width:280px; min-height:56px; border-radius:14px;">
            Neues Gericht anlegen
          </button>
        </div>
      `;
      const btnWeekEmptyAdd = document.getElementById('btnWeekEmptyAdd');
      if(btnWeekEmptyAdd) btnWeekEmptyAdd.onclick = () => { if(typeof openWeekAddSheet === 'function') openWeekAddSheet(); };
      const btnWeekEmptyNew = document.getElementById('btnWeekEmptyNew');
      if(btnWeekEmptyNew) btnWeekEmptyNew.onclick = () => { createFlowPreselectedDate = weekPlanDay; createFlowOriginView = 'week'; openCreateFlowSheet(); };
      if(actionsBar) actionsBar.style.display = 'none';
      if(activateBlock) activateBlock.style.display = 'none';
      if(typeof lucide !== 'undefined') lucide.createIcons();
      return;
    }

    if(actionsBar) actionsBar.style.display = 'flex';
    if(activateBlock) activateBlock.style.display = 'none';
    list.innerHTML = '';

    var statusBlock = document.createElement('div');
    statusBlock.className = 'week-status-block';
    var p = (provider && provider.profile) ? provider.profile : {};
    var stdAbhol = !!p.abholnummerEnabledByDefault;
    var stdMehrweg = !!p.reuseEnabledByDefault;
    var stdVorOrt = p.dineInPossibleDefault !== false;
    var profileStdHtml = '<div class="week-profile-std" style="font-size:11px; color:#94a3b8; margin-top:6px;">Standard: Abholnummer ' + (stdAbhol ? '✓' : '–') + ', Mehrweg ' + (stdMehrweg ? '✓' : '–') + ', Vor Ort ' + (stdVorOrt ? '✓' : '–') + '</div>';
    if(dayIsLive){
      statusBlock.innerHTML = '<div><div class="week-status-online"><span class="week-status-dot" style="background:#FFDE00;"></span><span>ONLINE</span></div>' + profileStdHtml + '</div><button type="button" class="btn secondary" style="min-height:40px; padding:0 14px; font-size:14px; font-weight:700; border-radius:12px;" onclick="shareWeekPlan()">Teilen</button>';
    } else {
      statusBlock.innerHTML = '<div><div class="week-status-draft"><span class="week-status-dot" style="background:#94a3b8;"></span><span>ENTWURF</span></div>' + profileStdHtml + '</div><div style="text-align:right;"><button type="button" class="week-activate-inline" onclick="activateWeekDay(\'' + weekPlanDay + '\')">Plan aktivieren</button><div class="week-status-activate-hint">Speichert alle Änderungen. Einmal 4,99 € pro Tag – alle Gerichte gehen online.</div></div>';
    }
    list.appendChild(statusBlock);

    if(!dayIsLive && weekSortMode){
      var sortBar = document.createElement('div');
      sortBar.className = 'week-sort-bar';
      sortBar.innerHTML = '<div><span style="font-size:14px; font-weight:800; color:#1a1a1a;">Reihenfolge per Drag & Drop ändern</span><div class="week-status-activate-hint" style="margin-top:4px;">Zum Beenden auf „Fertig“ tippen.</div></div><button type="button" class="week-sort-done" id="weekSortDoneBtn">Fertig</button>';
      list.appendChild(sortBar);
      var weekSortDoneBtn = document.getElementById('weekSortDoneBtn');
      if(weekSortDoneBtn) weekSortDoneBtn.onclick = function(){ weekSortMode = false; renderWeekPlan(); };
      list.classList.add('week-sort-mode');
    } else {
      list.classList.remove('week-sort-mode');
    }

    var itemsToShow = dayIsLive ? dayLiveOffers : providerEntries.map(function(x){ return x.entry; });
    var entryIndices = dayIsLive ? [] : providerEntries.map(function(x){ return x.idx; });

    itemsToShow.forEach(function(entry, idx){
      var cb = cookbook.find(function(c){ return String(c.id) === String(entry.cookbookId); });
      var name = (cb && cb.dish) || entry.dish || 'Gericht';
      var price = (cb && cb.price) || entry.price || 0;
      var img = (cb && cb.photoData) || entry.photoData || entry.imageUrl || '';
      var weekIndex = entryIndices[idx];
      var wrap = document.createElement('div');
      wrap.className = 'week-meal-card-wrap' + (dayIsLive ? ' week-card-live' : '');
      if(!dayIsLive && weekSortMode){
        wrap.draggable = true;
        wrap.dataset.index = String(weekIndex);
        var imgSort = (cb && cb.photoData) || entry.photoData || entry.imageUrl || '';
        var thumbSort = '<div class="week-meal-thumb" style="width:56px;min-width:56px;height:56px;border-radius:12px;overflow:hidden;background:#e5e7eb;flex-shrink:0;background-size:cover;background-position:center' + (imgSort ? ';background-image:url(\'' + esc(imgSort) + '\')' : '') + '"></div>';
        wrap.innerHTML = '<div class="week-meal-card" style="display:flex; align-items:center;"><div class="week-meal-card-drag-handle"><i data-lucide="grip-vertical" style="width:24px;height:24px;"></i></div>' + thumbSort + '<div><div class="week-meal-name">' + esc(name) + '</div><div class="week-meal-meta"><span class="price-pill">' + euro(price) + '</span></div></div></div>';
        wrap.ondragstart = function(e){ e.dataTransfer.setData('text/plain', weekIndex); e.dataTransfer.effectAllowed = 'move'; };
        wrap.ondragover = function(e){ e.preventDefault(); e.dataTransfer.dropEffect = 'move'; var from = parseInt(e.dataTransfer.getData('text/plain'), 10); var to = parseInt(this.dataset.index, 10); if(from !== to){ this.classList.add('week-drag-over'); } };
        wrap.ondragleave = function(){ this.classList.remove('week-drag-over'); };
        wrap.ondrop = function(e){
          e.preventDefault();
          this.classList.remove('week-drag-over');
          var fromIndex = parseInt(e.dataTransfer.getData('text/plain'), 10);
          var toIndex = parseInt(this.dataset.index, 10);
          if(fromIndex !== toIndex && !isNaN(fromIndex) && !isNaN(toIndex)) reorderWeekDay(weekPlanDay, fromIndex, toIndex);
        };
        list.appendChild(wrap);
        return;
      }
      var swipeInner = document.createElement('div');
      swipeInner.className = 'week-meal-card-swipe';
      var card = document.createElement('div');
      card.className = 'week-meal-card';
      var onlineHtml = dayIsLive
        ? '<span class="week-meal-online"><i data-lucide="check-circle" style="width:14px;height:14px;"></i> Online</span>'
        : '<span style="font-size:12px; font-weight:700; color:#94a3b8;">Geplant</span>';
      var p = (provider && provider.profile) ? provider.profile : {};
      var defaultDineIn = p.dineInPossibleDefault !== false;
      var defaultPickup = !!p.abholnummerEnabledByDefault;
      var defaultReuse = !!p.reuseEnabledByDefault;
      var entryDineIn = entry.dineInPossible !== false;
      var entryPickup = !!(entry.hasPickupCode !== undefined ? entry.hasPickupCode : defaultPickup);
      var entryReuse = !!(entry.reuse && entry.reuse.enabled);
      var hasTime = !!(entry.timeStart && entry.timeEnd);
      function powerIcon(emoji, ok, timeMissing){ var c = 'week-power-icon'; if(timeMissing) c += ' week-power-time-missing'; else if(ok) c += (emoji === '🕒' ? ' week-power-time-ok' : ' week-power-icon-ok'); else c += ' week-power-icon-muted'; return '<span class="' + c + '" title="' + (emoji === '🍴' ? 'Vor Ort' : emoji === '🕒' ? (hasTime ? 'Zeit gesetzt' : 'Zeit fehlt') : emoji === '🧾' ? 'Abholnummer' : 'Mehrweg') + '">' + emoji + '</span>'; }
      var powerBarHtml = '<div class="week-power-bar">' + powerIcon('🍴', entryDineIn, false) + powerIcon('🕒', hasTime, !hasTime) + powerIcon('🧾', entryPickup, false) + powerIcon('🔄', entryReuse, false) + '</div>';
      var showVorOrt = (entry.dineInPossible !== undefined) && (entryDineIn !== defaultDineIn);
      var showMehrweg = (entry.reuse !== undefined) && (entryReuse !== defaultReuse);
      var badgeParts = [];
      if(showVorOrt) badgeParts.push('<span title="Vor Ort (Abweichung)">🍴</span>');
      if(showMehrweg) badgeParts.push('<span title="Mehrweg (Abweichung)">🔄</span>');
      var badgesHtml = badgeParts.length ? '<div class="week-meal-badges" style="display:flex; gap:8px; margin-top:6px; font-size:14px;">' + badgeParts.join('') + '</div>' : '';
      var verdienstHtml = !dayIsLive ? '<div class="week-meal-verdienst" style="font-size:12px; color:#1a1a1a; margin-top:4px;">Verdienst ca. ' + euro(Math.max(0, (Number(price)||0) - 4.99)) + '</div>' : '';
      var moveBtnHtml = !dayIsLive ? '<div style="margin-top:8px; display:flex; align-items:center; gap:12px; flex-wrap:wrap;"><button type="button" class="week-meal-move-btn" data-day="' + esc(weekPlanDay) + '" data-index="' + weekIndex + '" style="padding:0; background:none; border:none; font-size:12px; font-weight:700; color:#64748b; cursor:pointer; text-decoration:underline;">Verschieben</button><button type="button" class="week-meal-direct-btn" data-day="' + esc(weekPlanDay) + '" data-index="' + weekIndex + '" style="padding:6px 12px; border-radius:10px; font-size:12px; font-weight:800; background:#22C55E; color:#fff; border:none; cursor:pointer;">Direkt Inserieren</button></div>' : '';
      var thumbHtml = '<div class="week-meal-thumb" style="width:56px;min-width:56px;height:56px;border-radius:12px;overflow:hidden;background:#e5e7eb;flex-shrink:0;background-size:cover;background-position:center' + (img ? ';background-image:url(\'' + esc(img) + '\')' : '') + '"></div>';
      card.innerHTML = thumbHtml + '<div style="flex:1;min-width:0;"><div class="week-meal-name">' + esc(name) + '</div><div class="week-meal-meta"><span class="price-pill">' + euro(price) + '</span> ' + onlineHtml + '</div>' + powerBarHtml + badgesHtml + verdienstHtml + moveBtnHtml + '</div>';
      card.style.cursor = 'pointer';
      if(!dayIsLive){
        card.onclick = function(e){ e.preventDefault(); e.stopPropagation(); if(weekJustSwiped) return; if(e.target.closest && (e.target.closest('.week-meal-move-btn') || e.target.closest('.week-meal-direct-btn'))) return; if(hasTime){ if(typeof openWeekAddSheet === 'function') openWeekAddSheet(weekPlanDay, weekIndex); } else { if(typeof openWeekTimeOverlay === 'function') openWeekTimeOverlay(weekPlanDay, weekIndex); } };
        var swipeDel = document.createElement('div');
        swipeDel.className = 'week-swipe-actions right';
        swipeDel.innerHTML = '<i data-lucide="trash-2" style="width:22px;height:22px;"></i><span>Löschen</span>';
        swipeDel.onclick = function(){ deletePlannedEntryWithUndo(weekPlanDay, weekIndex); };
        var swipeCopy = document.createElement('div');
        swipeCopy.className = 'week-swipe-actions left';
        swipeCopy.innerHTML = '<i data-lucide="copy" style="width:22px;height:22px;"></i><span>Folgetag</span>';
        swipeCopy.onclick = function(){ copyWeekEntryToNextDay(weekPlanDay, weekIndex); };
        swipeInner.appendChild(swipeCopy);
        swipeInner.appendChild(swipeDel);
        swipeInner.appendChild(card);
        card.querySelectorAll('.week-meal-move-btn').forEach(function(btn){
          btn.onclick = function(ev){ ev.preventDefault(); ev.stopPropagation(); if(typeof haptic === 'function') haptic(6); var d = btn.getAttribute('data-day'); var i = parseInt(btn.getAttribute('data-index'), 10); if(typeof openMoveWeekEntrySheet === 'function') openMoveWeekEntrySheet(d, i); };
        });
        card.querySelectorAll('.week-meal-direct-btn').forEach(function(btn){
          btn.onclick = function(ev){ ev.preventDefault(); ev.stopPropagation(); if(typeof haptic === 'function') haptic(6); var d = btn.getAttribute('data-day'); var i = parseInt(btn.getAttribute('data-index'), 10); if(typeof publishSingleWeekEntry === 'function') publishSingleWeekEntry(d, i); };
        });
        attachSwipeToWeekCard(swipeInner, weekPlanDay, weekIndex);
        attachLongPressToWeekCard(wrap);
      } else {
        card.onclick = function(e){ e.preventDefault(); e.stopPropagation(); if(weekJustSwiped) return; if(typeof startListingFlow === 'function') startListingFlow({ editOfferId: entry.id || '' }); };
        swipeInner.appendChild(card);
      }
      wrap.appendChild(swipeInner);
      list.appendChild(wrap);
    });

    /* "Weiteres Gericht planen" entfernt – Nutzer nutzt gelbes Plus oder Wochenplan-Karte */

    var draftDays = getWeekDraftDays();
    var masterBar = document.getElementById('weekMasterActivateBar');
    var btnMaster = document.getElementById('btnWeekMasterActivate');
    if(masterBar && btnMaster){
      if(draftDays.length > 0){
        masterBar.style.display = 'block';
        var total = (draftDays.length * 4.99).toFixed(2).replace('.', ',');
        btnMaster.textContent = 'Gesamte Auswahl aktivieren (' + draftDays.length + ' × 4,99 €)';
        btnMaster.onclick = function(){ if(typeof haptic === 'function') haptic(10); bulkActivateWeekDrafts(); };
      } else {
        masterBar.style.display = 'none';
      }
    }

    if(typeof lucide !== 'undefined') lucide.createIcons();
  }

  function getWeekDraftDays(){
    var out = [];
    for(var i = 0; i < 28; i++){
      var d = new Date(); d.setDate(d.getDate() + i);
      var key = isoDate(d);
      var provEntries = (week[key] || []).filter(function(x){ return x.providerId === providerId(); });
      var liveOffers = offers.filter(function(o){ return o.providerId === providerId() && o.day === key; });
      if(provEntries.length > 0 && liveOffers.length === 0) out.push(key);
    }
    return out;
  }

  function bulkActivateWeekDrafts(){
    var draftDays = getWeekDraftDays();
    if(!draftDays.length) return;
    var profile = normalizeProviderProfile(provider.profile || {});
    if(profile.abholnummerEnabledByDefault === undefined || profile.abholnummerEnabledByDefault === null){
      if(typeof showToast === 'function') showToast('Bitte zuerst Abholnummer-Standard im Profil festlegen.');
      return;
    }
    var total = (draftDays.length * 4.99).toFixed(2).replace('.', ',');
    var msg = draftDays.length + ' Tag(e) mit Entwürfen werden aktiviert. Gesamtbetrag: ' + draftDays.length + ' × 4,99 € = ' + total + ' €. Fortfahren?';
    if(!confirm(msg)) return;
    var totalNum = draftDays.length * 4.99;
    var fakeOffer = { id: 'bulk', dish: 'Gesamte Auswahl (' + draftDays.length + ' Tage)', price: totalNum, providerId: providerId() };
    showPublishFeeModal(fakeOffer, function(){
      draftDays.forEach(function(date){
        var entries = (week[date] || []).filter(function(e){ return e.providerId === providerId(); });
        entries.forEach(function(e){
          var c = cookbook.find(function(x){ return String(x.id) === String(e.cookbookId); }) || {};
          var base = normalizeOffer(e);
          var newOffer = Object.assign({}, base, {
            id: cryptoId(),
            dish: c.dish || e.dish,
            price: c.price || e.price,
            hasPickupCode: !!profile.abholnummerEnabledByDefault,
            active: true,
            day: date
          });
          offers.push(newOffer);
        });
      });
      save(LS.offers, offers);
      renderWeekPlan();
      if(typeof renderProviderHome === 'function') renderProviderHome();
      if(typeof showToast === 'function') showToast('Alle ' + draftDays.length + ' Tage aktiviert. Zum Wochenplan.');
    });
  }

  function attachSwipeToWeekCard(swipeEl, date, index){
    var cardEl = swipeEl.querySelector && swipeEl.querySelector('.week-meal-card') || swipeEl.children[2];
    if(!cardEl) return;
    var startX = 0, currentX = 0, SWIPE_THRESHOLD = 60, mouseActive = false;
    function onStart(e){
      startX = (e.touches && e.touches[0] ? e.touches[0].clientX : e.clientX) || 0;
      currentX = 0;
      cardEl.style.transition = 'none';
    }
    function onMove(e){
      var x = (e.touches && e.touches[0] ? e.touches[0].clientX : e.clientX) || 0;
      currentX = x - startX;
      currentX = Math.max(-100, Math.min(100, currentX));
      cardEl.style.transform = 'translateX(' + currentX + 'px)';
    }
    function onEnd(e){
      if(currentX < -SWIPE_THRESHOLD){
        if(e && e.cancelable) e.preventDefault();
        weekJustSwiped = true; setTimeout(function(){ weekJustSwiped = false; }, 500);
        swipeEl.classList.add('week-meal-card-exit', 'week-meal-card-exit-left');
        cardEl.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
        cardEl.style.transform = 'translateX(-120%)';
        swipeEl.style.transition = 'opacity 0.25s ease';
        swipeEl.style.opacity = '0';
        setTimeout(function(){ deletePlannedEntryWithUndo(date, index); }, 320);
      } else if(currentX > SWIPE_THRESHOLD){
        if(e && e.cancelable) e.preventDefault();
        weekJustSwiped = true; setTimeout(function(){ weekJustSwiped = false; }, 500);
        swipeEl.classList.add('week-meal-card-exit', 'week-meal-card-exit-right');
        cardEl.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
        cardEl.style.transform = 'translateX(120%)';
        swipeEl.style.transition = 'opacity 0.25s ease';
        swipeEl.style.opacity = '0';
        setTimeout(function(){ copyWeekEntryToNextDay(date, index); }, 320);
      } else {
        cardEl.style.transition = 'transform 0.2s ease-out';
        cardEl.style.transform = 'translateX(0)';
      }
    }
    function onMouseMove(e){
      if(!mouseActive) return;
      currentX = e.clientX - startX;
      currentX = Math.max(-100, Math.min(100, currentX));
      cardEl.style.transform = 'translateX(' + currentX + 'px)';
    }
    function onMouseUp(){
      if(!mouseActive) return;
      mouseActive = false;
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
      onEnd();
    }
    swipeEl.addEventListener('touchstart', onStart, { passive: true });
    swipeEl.addEventListener('touchmove', onMove, { passive: true });
    swipeEl.addEventListener('touchend', onEnd, { passive: false });
    swipeEl.addEventListener('mousedown', function(e){
      e.preventDefault();
      startX = e.clientX;
      currentX = 0;
      cardEl.style.transition = 'none';
      mouseActive = true;
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    });
  }
  function attachLongPressToWeekCard(wrap){
    var timer = null;
    var LONG_PRESS_MS = 500;
    function clearTimer(){ if(timer){ clearTimeout(timer); timer = null; } }
    function startLongPress(e){
      clearTimer();
      timer = setTimeout(function(){
        timer = null;
        weekSortMode = true;
        renderWeekPlan();
      }, LONG_PRESS_MS);
    }
    wrap.addEventListener('touchstart', function(e){ startLongPress(e); }, { passive: true });
    wrap.addEventListener('touchend', clearTimer, { passive: true });
    wrap.addEventListener('touchmove', clearTimer, { passive: true });
    wrap.addEventListener('mousedown', function(e){ startLongPress(e); });
    wrap.addEventListener('mouseup', clearTimer);
    wrap.addEventListener('mouseleave', clearTimer);
  }
  function reorderWeekDay(date, fromIndex, toIndex){
    var arr = week[date];
    if(!arr || fromIndex === toIndex || fromIndex < 0 || toIndex < 0 || fromIndex >= arr.length || toIndex >= arr.length) return;
    var e = arr.splice(fromIndex, 1)[0];
    arr.splice(toIndex, 0, e);
    save(LS.week, week);
    renderWeekPlan();
    renderProviderWeekPreview();
    if(typeof toast === 'function') toast('Reihenfolge geändert');
  }
  function addCookbookEntryToWeek(dayKey, cookbookId, opts){
    var c = (cookbook||[]).find(function(x){ return String(x.id) === String(cookbookId); });
    if(!c || c.providerId !== providerId()) return;
    if(!week[dayKey]) week[dayKey] = [];
    var entry = { providerId: c.providerId, cookbookId: c.id, dish: c.dish, price: c.price };
    if(opts && (opts.timeStart != null || opts.timeEnd != null)){ entry.timeStart = opts.timeStart; entry.timeEnd = opts.timeEnd; }
    week[dayKey].push(entry);
    save(LS.week, week);
    var boardWrap = document.getElementById('kwBoardWrap');
    if(boardWrap && boardWrap.style.display !== 'none'){ if(typeof renderWeekPlanBoard === 'function') renderWeekPlanBoard(); } else { renderWeekPlan(); }
    renderProviderWeekPreview();
    toast((c.dish || 'Gericht') + ' hinzugefügt');
  }
  function replaceWeekEntry(dayKey, index, cookbookId){
    var c = (cookbook||[]).find(function(x){ return String(x.id) === String(cookbookId); });
    if(!c || c.providerId !== providerId()) return;
    var arr = week[dayKey];
    if(!arr || index < 0 || index >= arr.length) return;
    var prev = arr[index];
    var entry = { providerId: c.providerId, cookbookId: c.id, dish: c.dish, price: c.price };
    if(prev && (prev.timeStart != null || prev.timeEnd != null)){ entry.timeStart = prev.timeStart; entry.timeEnd = prev.timeEnd; }
    arr[index] = entry;
    save(LS.week, week);
    var boardWrap = document.getElementById('kwBoardWrap');
    if(boardWrap && boardWrap.style.display !== 'none'){ if(typeof renderWeekPlanBoard === 'function') renderWeekPlanBoard(); } else { renderWeekPlan(); }
    renderProviderWeekPreview();
    toast((c.dish || 'Gericht') + ' ersetzt');
  }

  /** Origin-View für Quick-Action: Nach Speichern im Sheet zurück zur Ursprungsansicht (Dashboard oder Wochenplan). */
  var weekAddSheetOriginView = '';
  var weekMultiSelectCookbookId = null;
  var weekMultiSelectDays = {};

  function openWeekMultiSelectSheet(){
    var list = document.getElementById('weekAddSheetList');
    var titleEl = document.getElementById('weekAddSheetTitle');
    var hintEl = document.getElementById('weekAddSheetHint');
    var searchWrap = document.getElementById('weekAddSheetSearch') ? document.getElementById('weekAddSheetSearch').parentElement : null;
    if(!list || !titleEl) return;
    weekMultiSelectCookbookId = null;
    weekMultiSelectDays = {};
    if(document.getElementById('weekAddSheetSearch')) document.getElementById('weekAddSheetSearch').style.display = 'block';
    titleEl.textContent = 'Gericht auf mehrere Tage setzen';
    hintEl.textContent = '1. Gericht wählen';
    var pid = providerId();
    var mine = (cookbook||[]).filter(function(c){ return c.providerId === pid; });
    list.innerHTML = '';
    list.style.display = 'grid';
    list.style.gridTemplateColumns = 'repeat(2, 1fr)';
    mine.forEach(function(c){
      var card = document.createElement('div');
      card.style.cssText = 'background:#fff; border-radius:16px; border:1px solid #f1f3f5; overflow:hidden; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.04); display:flex; flex-direction:column;';
      var imgUrl = c.photoData || 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=200&q=60';
      card.innerHTML = '<div style="height:80px; width:100%; background:#f1f3f5;"><img src="' + imgUrl + '" style="width:100%; height:100%; object-fit:cover;"></div><div style="padding:10px;"><div style="font-size:13px; font-weight:800; color:#1a1a1a;">' + esc(c.dish) + '</div><div style="font-size:11px; font-weight:700; color:#1a1a1a;">' + euro(c.price||0) + '</div></div>';
      card.onclick = function(){
        if(typeof haptic === 'function') haptic(6);
        weekMultiSelectCookbookId = c.id;
        hintEl.textContent = '2. Tage antippen (mehrfach auswählbar)';
        list.style.gridTemplateColumns = 'repeat(4, 1fr)';
        list.style.gap = '8px';
        list.innerHTML = '';
        for(var i = 0; i < 28; i++){
          var d = new Date(); d.setDate(d.getDate() + i);
          var key = isoDate(d);
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'week-day-pill';
          btn.setAttribute('data-date', key);
          btn.textContent = (i === 0 ? 'Heute' : (d.getDate() + '.' + (d.getMonth()+1) + '.'));
          btn.style.cssText = 'min-height:48px; border-radius:12px; border:2px solid #e2e8f0; background:#f8f9fa; font-size:12px; font-weight:800; color:#64748b;';
          (function(k){
            btn.onclick = function(){
              if(typeof haptic === 'function') haptic(6);
              weekMultiSelectDays[k] = !weekMultiSelectDays[k];
              this.style.background = weekMultiSelectDays[k] ? '#FFDE00' : '#f8f9fa';
              this.style.color = weekMultiSelectDays[k] ? '#fff' : '#64748b';
              this.style.borderColor = weekMultiSelectDays[k] ? '#FFDE00' : '#e2e8f0';
              var n = Object.keys(weekMultiSelectDays).filter(function(x){ return weekMultiSelectDays[x]; }).length;
              var doneBtn = document.getElementById('btnWeekMultiDone');
              if(doneBtn) doneBtn.textContent = n ? 'Fertig – auf ' + n + ' Tage setzen' : 'Fertig';
            };
          })(key);
          list.appendChild(btn);
        }
        var doneBtn = document.createElement('button');
        doneBtn.type = 'button';
        doneBtn.id = 'btnWeekMultiDone';
        doneBtn.className = 'week-add-more';
        doneBtn.style.cssText = 'grid-column:1/-1; margin-top:12px; min-height:56px; border-radius:16px; font-size:16px; font-weight:800; border:none; background:#FFDE00; color:#1a1a1a; cursor:pointer;';
        doneBtn.textContent = 'Fertig';
        doneBtn.onclick = function(){
          var keys = Object.keys(weekMultiSelectDays).filter(function(k){ return weekMultiSelectDays[k]; });
          if(!keys.length){ if(typeof showToast === 'function') showToast('Bitte mindestens einen Tag wählen'); return; }
          if(typeof haptic === 'function') haptic(10);
          keys.forEach(function(k){ addCookbookEntryToWeek(k, weekMultiSelectCookbookId); });
          closeWeekAddSheet();
          var boardWrap = document.getElementById('kwBoardWrap');
          if(boardWrap && boardWrap.style.display !== 'none' && typeof renderWeekPlanBoard === 'function') renderWeekPlanBoard(); else if(typeof renderWeekPlan === 'function') renderWeekPlan();
          if(typeof renderProviderWeekPreview === 'function') renderProviderWeekPreview();
          if(typeof showToast === 'function') showToast('Gericht auf ' + keys.length + ' Tage gesetzt');
        };
        list.appendChild(doneBtn);
      };
      list.appendChild(card);
    });
    if(mine.length === 0) list.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:24px; color:#64748b;">Kein Gericht im Kochbuch</div>';
  }

  function openWeekAddSheet(dayKeyOrReplaceIndex, replaceIndexParam){
    var bd = document.getElementById('weekAddSheetBd');
    var sheet = document.getElementById('weekAddSheet');
    var list = document.getElementById('weekAddSheetList');
    var searchInput = document.getElementById('weekAddSheetSearch');
    var hint = document.getElementById('weekAddSheetHint');
    var chooserEl = document.getElementById('weekAddSheetChooser');
    var listWrapEl = document.getElementById('weekAddSheetListWrap');
    if(!bd || !sheet || !list) return;
    var dayKey;
    var isReplace;
    var replaceIndex = -1;
    if(typeof dayKeyOrReplaceIndex === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dayKeyOrReplaceIndex)){
      dayKey = dayKeyOrReplaceIndex;
      isReplace = typeof replaceIndexParam === 'number' && replaceIndexParam >= 0;
      if(isReplace) replaceIndex = replaceIndexParam;
    } else if(typeof dayKeyOrReplaceIndex === 'number' && dayKeyOrReplaceIndex >= 0){
      dayKey = typeof weekPlanDay !== 'undefined' ? weekPlanDay : isoDate(new Date());
      isReplace = true;
      replaceIndex = dayKeyOrReplaceIndex;
    } else {
      dayKey = typeof weekPlanDay !== 'undefined' ? weekPlanDay : isoDate(new Date());
      isReplace = false;
    }
    weekAddSheetOriginView = (document.querySelector('.view.active') && document.querySelector('.view.active').id) || 'v-provider-week';
    var titleEl = document.getElementById('weekAddSheetTitle');
    if(titleEl) titleEl.textContent = isReplace ? 'Gericht ersetzen' : 'Gericht zum Plan hinzufügen';
    var d = new Date(dayKey + 'T12:00:00');
    var dayLabel = weekDayShortLabel(d, 0);
    if(hint) hint.textContent = isReplace ? 'Wähle ein anderes Gericht für diese Position.' : 'Tap = sofort in den Plan für ' + dayLabel;
    var pid = providerId();
    var mine = (cookbook||[]).filter(function(c){ return c.providerId === pid; });
    function fillList(filter){
      var q = (filter||'').toLowerCase();
      var items = q ? mine.filter(function(c){ return (c.dish||'').toLowerCase().indexOf(q) >= 0; }) : mine;
      var top5 = items.slice(0, 5);
      var show = q ? items : (top5.length ? top5 : items);
      list.innerHTML = '';
      if(show.length === 0){
        list.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:24px; color:#64748b; font-size:14px;">Kein Gericht gefunden</div>';
        return;
      }
      show.forEach(function(c){
        var card = document.createElement('div');
        card.style.cssText = 'background:#fff; border-radius:16px; border:1px solid #f1f3f5; overflow:hidden; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.04); display:flex; flex-direction:column;';
        var imgUrl = c.photoData || 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=200&q=60';
        card.innerHTML = '<div style="height:80px; width:100%; background:#f1f3f5;"><img src="' + imgUrl + '" style="width:100%; height:100%; object-fit:cover;"></div><div style="padding:10px;"><div style="font-size:13px; font-weight:800; color:#1a1a1a; line-height:1.2; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; height:32px;">' + esc(c.dish) + '</div><div style="font-size:11px; font-weight:700; color:#1a1a1a; margin-top:4px;">' + euro(c.price||0) + '</div></div>';
        card.onclick = function(){
          if(isReplace) replaceWeekEntry(dayKey, replaceIndex, c.id); else addCookbookEntryToWeek(dayKey, c.id);
          closeWeekAddSheet();
          if(weekAddSheetOriginView === 'v-provider-home' && typeof renderProviderWeekPreviewNew === 'function') renderProviderWeekPreviewNew();
        };
        list.appendChild(card);
      });
    }
    if(searchInput){
      searchInput.value = '';
      searchInput.oninput = function(){ fillList(searchInput.value.trim()); };
    }
    if(chooserEl && listWrapEl){
      if(isReplace){
        chooserEl.style.display = 'none';
        listWrapEl.style.display = '';
        fillList('');
      } else {
        chooserEl.style.display = '';
        listWrapEl.style.display = 'none';
        var btnFromCookbook = document.getElementById('btnWeekAddFromCookbook');
        var btnNewDish = document.getElementById('btnWeekAddNewDish');
        if(btnFromCookbook){
          btnFromCookbook.onclick = function(){
            if(typeof haptic === 'function') haptic(6);
            chooserEl.style.display = 'none';
            listWrapEl.style.display = '';
            fillList('');
          };
        }
        if(btnNewDish){
          btnNewDish.onclick = function(){
            if(typeof haptic === 'function') haptic(6);
            closeWeekAddSheet();
            if(typeof openDishFlow === 'function') openDishFlow(dayKey, 'week');
          };
        }
      }
    } else {
      fillList('');
    }
    var btnMulti = document.getElementById('btnWeekAddMulti');
    if(btnMulti) btnMulti.onclick = function(){ openWeekMultiSelectSheet(); };
    var btnClose = document.querySelector('#weekAddSheet .btn.secondary[onclick="closeWeekAddSheet()"]');
    if(btnClose) btnClose.style.display = '';
    bd.style.display = 'block';
    sheet.style.display = '';
    sheet.classList.add('active');
  }
  function closeWeekAddSheet(){
    var bd = document.getElementById('weekAddSheetBd');
    var sheet = document.getElementById('weekAddSheet');
    if(bd) bd.style.display = 'none';
    if(sheet) sheet.classList.remove('active');
  }

  var weekTimeOverlayDay = null;
  var weekTimeOverlayIndex = null;
  function openWeekTimeOverlay(dayKey, entryIndex){
    var bd = document.getElementById('weekTimeOverlayBd');
    var sheet = document.getElementById('weekTimeOverlay');
    var startEl = document.getElementById('weekTimeOverlayStart');
    var endEl = document.getElementById('weekTimeOverlayEnd');
    if(!bd || !sheet || !startEl || !endEl) return;
    weekTimeOverlayDay = dayKey;
    weekTimeOverlayIndex = entryIndex;
    var arr = week[dayKey] || [];
    var entry = arr[entryIndex];
    var p = (provider && provider.profile) ? provider.profile : {};
    var defStart = (entry && entry.timeStart) || p.mealStart || '11:30';
    var defEnd = (entry && entry.timeEnd) || p.mealEnd || '14:00';
    if(startEl.options.length === 0){
      var opts = '';
      for(var h = 8; h <= 20; h++){ for(var m = 0; m < 60; m += 15){ var t = (h < 10 ? '0' + h : h) + ':' + (m === 0 ? '00' : m); opts += '<option value="' + t + '">' + t + ' Uhr</option>'; } }
      startEl.innerHTML = opts;
      endEl.innerHTML = opts;
    }
    startEl.value = defStart;
    endEl.value = defEnd;
    if(typeof haptic === 'function') haptic(6);
    bd.style.display = 'block';
    sheet.style.display = '';
    sheet.classList.add('active');
  }
  function closeWeekTimeOverlay(){
    var bd = document.getElementById('weekTimeOverlayBd');
    var sheet = document.getElementById('weekTimeOverlay');
    if(bd) bd.style.display = 'none';
    if(sheet) sheet.classList.remove('active');
    weekTimeOverlayDay = null;
    weekTimeOverlayIndex = null;
  }
  (function(){
    var saveBtn = document.getElementById('weekTimeOverlaySave');
    var bd = document.getElementById('weekTimeOverlayBd');
    if(!saveBtn) return;
    saveBtn.onclick = function(){
      if(weekTimeOverlayDay == null || weekTimeOverlayIndex == null) return;
      var startEl = document.getElementById('weekTimeOverlayStart');
      var endEl = document.getElementById('weekTimeOverlayEnd');
      var start = (startEl && startEl.value) ? startEl.value : '11:30';
      var end = (endEl && endEl.value) ? endEl.value : '14:00';
      var arr = week[weekTimeOverlayDay];
      if(arr && arr[weekTimeOverlayIndex]){ arr[weekTimeOverlayIndex].timeStart = start; arr[weekTimeOverlayIndex].timeEnd = end; save(LS.week, week); }
      if(typeof haptic === 'function') haptic(6);
      if(typeof showToast === 'function') showToast('Zeitfenster gespeichert');
      closeWeekTimeOverlay();
      if(typeof renderWeekPlan === 'function') renderWeekPlan();
    };
    if(bd) bd.onclick = closeWeekTimeOverlay;
  })();

  function copyWeekEntryToNextDay(fromDate, entryIndex){
    var dayArr = week[fromDate] || [];
    var entry = dayArr[entryIndex];
    if(!entry || entry.providerId !== providerId()) return;
    var d = new Date(fromDate + 'T12:00:00');
    d.setDate(d.getDate() + 1);
    var nextKey = isoDate(d);
    if(!week[nextKey]) week[nextKey] = [];
    var newEntry = { providerId: entry.providerId, cookbookId: entry.cookbookId, dish: entry.dish, price: entry.price };
    if(entry.timeStart != null || entry.timeEnd != null){ newEntry.timeStart = entry.timeStart; newEntry.timeEnd = entry.timeEnd; }
    week[nextKey].push(newEntry);
    save(LS.week, week);
    renderWeekPlan();
    if(typeof renderProviderWeekPreview === 'function') renderProviderWeekPreview();
    var nextLabel = weekDayShortLabel(d, 1);
    if(typeof showToast === 'function') showToast('Auf ' + nextLabel + ' kopiert'); else if(typeof toast === 'function') toast('Auf ' + nextLabel + ' kopiert');
  }
  function copyWeekEntryToOtherDay(fromDate, entryIndex){
    var dayArr = week[fromDate] || [];
    var entry = dayArr[entryIndex];
    if(!entry || entry.providerId !== providerId()) return;
    var keys = [];
    for(var i = 0; i < 7; i++){ var d = new Date(); d.setDate(d.getDate() + i); keys.push(isoDate(d)); }
    var otherDays = keys.filter(function(k){ return k !== fromDate; });
    var sheet = document.getElementById('copyDaySheet');
    if(!sheet){
      sheet = document.createElement('div');
      sheet.id = 'copyDaySheet';
      sheet.className = 'bottom-sheet';
      sheet.style.cssText = 'position:fixed; left:0; right:0; bottom:0; background:#fff; border-radius:20px 20px 0 0; box-shadow:0 -4px 20px rgba(0,0,0,0.15); z-index:9999; padding:20px 20px calc(20px + env(safe-area-inset-bottom)); display:none;';
      sheet.innerHTML = '<div style="font-weight:800; font-size:16px; margin-bottom:16px;">An welchen Tag kopieren?</div><div id="copyDayList"></div><button type="button" class="btn secondary" style="margin-top:16px; width:100%; min-height:48px;" id="copyDayCancel">Abbrechen</button>';
      document.body.appendChild(sheet);
      document.getElementById('copyDayCancel').onclick = function(){ sheet.style.display = 'none'; };
    }
    var list = document.getElementById('copyDayList');
    list.innerHTML = '';
    otherDays.forEach(function(key){
      var d = new Date(key + 'T12:00:00');
      var label = weekDayShortLabel(d, keys.indexOf(key));
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn secondary';
      btn.style.cssText = 'width:100%; min-height:48px; margin-bottom:8px; border-radius:12px; font-size:15px; font-weight:700;';
      btn.textContent = label;
      btn.onclick = function(){
        if(!week[key]) week[key] = [];
        var newEntry = { providerId: entry.providerId, cookbookId: entry.cookbookId, dish: entry.dish, price: entry.price };
        if(entry.timeStart != null || entry.timeEnd != null){ newEntry.timeStart = entry.timeStart; newEntry.timeEnd = entry.timeEnd; }
        week[key].push(newEntry);
        save(LS.week, week);
        sheet.style.display = 'none';
        renderWeekPlan();
        if(typeof renderProviderWeekPreview === 'function') renderProviderWeekPreview();
        if(typeof showToast === 'function') showToast('Gericht für ' + label + ' übernommen'); else if(typeof toast === 'function') toast('Gericht für ' + label + ' übernommen');
      };
      list.appendChild(btn);
    });
    sheet.style.display = 'block';
  }

  function openMoveWeekEntrySheet(dayKey, entryIndex){
    if(!week[dayKey] || !week[dayKey][entryIndex]) return;
    var entry = week[dayKey][entryIndex];
    if(!entry || entry.providerId !== providerId()) return;
    var keys = [];
    for(var i = 0; i < 28; i++){ var d = new Date(); d.setDate(d.getDate() + i); keys.push(isoDate(d)); }
    var otherDays = keys.filter(function(k){ return k !== dayKey; });
    var overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9998; display:flex; flex-direction:column; justify-content:flex-end; padding:20px; box-sizing:border-box;';
    overlay.innerHTML = '<div style="background:#fff; border-radius:20px 20px 0 0; padding:20px; max-height:70vh; overflow-y:auto;"><div style="font-weight:800; font-size:16px; margin-bottom:16px;">Auf welchen Tag verschieben?</div><div id="moveDayList"></div><button type="button" class="kw-move-cancel" style="width:100%; min-height:48px; margin-top:16px; border-radius:14px; font-weight:700; background:#f1f3f5; border:none; cursor:pointer;">Abbrechen</button></div>';
    var list = overlay.querySelector('#moveDayList');
    otherDays.slice(0, 14).forEach(function(key){
      var d = new Date(key + 'T12:00:00');
      var label = ['So','Mo','Di','Mi','Do','Fr','Sa'][d.getDay()] + ', ' + d.getDate() + '.';
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn secondary';
      btn.style.cssText = 'width:100%; min-height:48px; margin-bottom:8px; border-radius:12px; font-size:15px; font-weight:700;';
      btn.textContent = label;
      btn.onclick = function(){
        if(typeof haptic === 'function') haptic(6);
        moveWeekEntryToDay(dayKey, entryIndex, key);
        overlay.remove();
        if(typeof showToast === 'function') showToast('Verschoben'); else if(typeof toast === 'function') toast('Verschoben');
      };
      list.appendChild(btn);
    });
    overlay.onclick = function(e){ if(e.target === overlay) overlay.remove(); };
    overlay.querySelector('.kw-move-cancel').onclick = function(){ if(typeof haptic === 'function') haptic(6); overlay.remove(); };
    document.body.appendChild(overlay);
  }

  function deletePlannedEntry(date, index){
    if(week[date]){
      week[date].splice(index, 1);
      if(week[date].length === 0) delete week[date];
      save(LS.week, week);
      renderWeekPlan();
      renderProviderWeekPreview();
    }
  }
  function deletePlannedEntryWithUndo(date, index){
    var arr = week[date];
    if(!arr || !arr[index]) return;
    var entry = arr[index];
    if(entry.providerId !== providerId()) return;
    arr.splice(index, 1);
    if(arr.length === 0) delete week[date];
    save(LS.week, week);
    renderWeekPlan();
    var boardWrap = document.getElementById('kwBoardWrap');
    if(boardWrap && boardWrap.style.display !== 'none' && typeof renderWeekPlanBoard === 'function') renderWeekPlanBoard();
    renderProviderWeekPreview();
    if(weekUndoTimer) clearTimeout(weekUndoTimer);
    weekUndoPending = { date: date, index: index, entry: entry };
    var snack = document.getElementById('weekUndoSnackbar');
    if(snack){ snack.style.display = 'flex'; snack.classList.add('active'); }
    var lbl = document.getElementById('weekUndoLabel');
    if(lbl) lbl.textContent = 'Gericht entfernt';
    var undoBtn = document.getElementById('weekUndoBtn');
    if(undoBtn){
      undoBtn.onclick = function(){
        if(weekUndoPending){
          var d = weekUndoPending.date, i = weekUndoPending.index, e = weekUndoPending.entry;
          if(!week[d]) week[d] = [];
          week[d].splice(i, 0, e);
          save(LS.week, week);
          renderWeekPlan();
          renderProviderWeekPreview();
          if(typeof toast === 'function') toast('Rückgängig gemacht');
        }
        hideWeekUndoSnackbar();
      };
    }
    weekUndoTimer = setTimeout(hideWeekUndoSnackbar, 4000);
  }
  function hideWeekUndoSnackbar(){
    weekUndoPending = null;
    if(weekUndoTimer){ clearTimeout(weekUndoTimer); weekUndoTimer = null; }
    var snack = document.getElementById('weekUndoSnackbar');
    if(snack){ snack.classList.remove('active'); snack.style.display = 'none'; }
  }

  function moveWeekEntry(dayKey, fromIndex, toIndex){
    var arr = week[dayKey];
    if(!arr || fromIndex === toIndex || fromIndex < 0 || toIndex < 0 || fromIndex >= arr.length || toIndex >= arr.length) return;
    var entry = arr.splice(fromIndex, 1)[0];
    arr.splice(toIndex, 0, entry);
    save(LS.week, week);
    renderWeekPlan();
    renderProviderWeekPreview();
  }

  function publishSingleWeekEntry(dayKey, entryIndex){
    var arr = week[dayKey] || [];
    var entry = arr[entryIndex];
    if(!entry || entry.providerId !== providerId()) return;
    var profile = normalizeProviderProfile(provider.profile || {});
    var hasDefault = profile.abholnummerEnabledByDefault !== undefined && profile.abholnummerEnabledByDefault !== null;
    if(!hasDefault){
      if(typeof startWizard === 'function') startWizard('listing', { fromCookbookId: entry.cookbookId, date: dayKey, skipToAbholnummer: true });
      return;
    }
    var cb = cookbook.find(function(c){ return String(c.id) === String(entry.cookbookId); }) || {};
    var o = normalizeOffer({
      id: cryptoId(),
      providerId: providerId(),
      providerName: profile.name || provider.email || 'Anbieter',
      providerStreet: profile.street || '',
      providerZip: profile.zip || '',
      providerCity: profile.city || '',
      providerLogoData: profile.logoData || '',
      dish: cb.dish || entry.dish || '',
      category: cb.category || 'Vegetarisch',
      price: Number(cb.price != null ? cb.price : entry.price || 0),
      pickupWindow: profile.mealWindow || (profile.mealStart && profile.mealEnd ? profile.mealStart + ' – ' + profile.mealEnd : '11:30 – 14:00'),
      hasPickupCode: !!profile.abholnummerEnabledByDefault,
      dineInPossible: cb.dineInPossible !== false,
      allergens: cb.allergens || [],
      extras: cb.extras || [],
      reuse: cb.reuse || { enabled: !!profile.reuseEnabledByDefault, deposit: profile.reuseEnabledByDefault ? 2 : 0 },
      imageUrl: cb.photoData || '',
      day: dayKey,
      active: true
    });
    if(typeof showPublishFeeModal === 'function'){
      showPublishFeeModal(o, function(){
        if(typeof publishWeekEntry === 'function') publishWeekEntry(dayKey, entry);
        if(typeof renderWeekPlan === 'function') renderWeekPlan();
        if(typeof renderProviderHome === 'function') renderProviderHome();
        if(typeof showToast === 'function') showToast('Direkt live geschaltet');
      });
    } else {
      if(typeof publishWeekEntry === 'function') publishWeekEntry(dayKey, entry);
      if(typeof renderWeekPlan === 'function') renderWeekPlan();
      if(typeof showToast === 'function') showToast('Direkt live geschaltet');
    }
  }

  function activateWeekDay(date){
    const entries = (week[date] || []).filter(e => e.providerId === providerId());
    if(!entries.length) return;
    
    const profile = normalizeProviderProfile(provider.profile || {});
    const hasDefault = profile.abholnummerEnabledByDefault !== undefined && profile.abholnummerEnabledByDefault !== null;
    
    if(!hasDefault){
      const entry = entries[0];
      startWizard('listing', { fromCookbookId: entry.cookbookId, date: date, skipToAbholnummer: true });
      return;
    }

    // Vollständiges Offer (wie publishCookbookEntry) für Modal + Erfolgs-Sheet
    const firstEntry = entries[0];
    const cb = cookbook.find(c => String(c.id) === String(firstEntry.cookbookId)) || {};
    const o = normalizeOffer({
      id: cryptoId(),
      providerId: providerId(),
      providerName: profile.name || provider.email || 'Anbieter',
      providerStreet: profile.street||'',
      providerZip: profile.zip||'',
      providerCity: profile.city||'',
      providerLogoData: profile.logoData||'',
      dish: cb.dish || firstEntry.dish || '',
      category: cb.category || 'Vegetarisch',
      price: Number(cb.price != null ? cb.price : firstEntry.price || 0),
      pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
      hasPickupCode: !!profile.abholnummerEnabledByDefault,
      dineInPossible: cb.dineInPossible !== false,
      allergens: cb.allergens || [],
      extras: cb.extras || [],
      reuse: cb.reuse || { enabled: !!profile.reuseEnabledByDefault, deposit: profile.reuseEnabledByDefault ? 2 : 0 },
      imageUrl: cb.photoData || '',
      day: date,
      active: true
    });
    if(!o.providerStreet && (profile.street || profile.zip || profile.city)){
      o.providerStreet = profile.street || buildAddress(profile);
      o.providerZip = profile.zip; o.providerCity = profile.city;
    }
    
    showPublishFeeModal(o, () => {
      // Erster Eintrag wurde bereits von publishOffer() ins offers-Array geschrieben; nur die übrigen hinzufügen
      entries.slice(1).forEach(e => {
        const c = cookbook.find(x => String(x.id) === String(e.cookbookId)) || {};
        offers.push({
          id: cryptoId(),
          providerId: providerId(),
          providerName: profile.name || provider.email || 'Anbieter',
          providerStreet: o.providerStreet || '',
          providerZip: o.providerZip || '',
          providerCity: o.providerCity || '',
          dish: c.dish || e.dish,
          price: Number(c.price != null ? c.price : e.price || 0),
          category: c.category || 'Vegetarisch',
          pickupWindow: o.pickupWindow,
          hasPickupCode: !!profile.abholnummerEnabledByDefault,
          dineInPossible: c.dineInPossible !== false,
          allergens: c.allergens || [],
          extras: c.extras || [],
          reuse: c.reuse || { enabled: false, deposit: 0 },
          imageUrl: c.photoData || '',
          day: date,
          active: true
        });
      });
      save(LS.offers, offers);
      renderWeekPlan();
      if(typeof renderProviderHome === 'function') renderProviderHome();
    });
  }

  function pickupCodeCount(dish){
    const base = String(dish||'').split('').reduce((sum, ch)=>sum + ch.charCodeAt(0), 0);
    return 2 + (base % 4); // 2..5
  }

  // Build pickup list (single list, no grouping)
  // Single source of truth: Order record (ordersStore)
  function buildPickupList(){
    const todayKey = isoDate(new Date());
    const providerIdVal = providerId();
    
    // Load from shared ordersStore (localStorage)
    const ordersList = loadOrders();
    
    // Filter: providerId + pickupDate + status=PAID (default "Offen")
    const todayOrders = ordersList.filter(o => {
      // Must be for this provider
      if(o.providerId !== providerIdVal) return false;
      
      // Must be PAID with pickupCode
      if(o.status !== 'PAID' || !o.pickupCode) return false;
      
      // Check pickupDate (from order - single source of truth)
      const orderPickupDate = o.pickupDate;
      if(orderPickupDate){
        return orderPickupDate === todayKey;
      }
      
      // Fallback: check offer.day (for legacy orders)
      const offer = offers.find(off => off.id === o.dishId || off.id === o.offerId);
      return offer && offer.day === todayKey;
    });
    
    if(!todayOrders.length) return [];
    
    // Map orders to pickup items (one Abholnummer = one order; Icons aus Verzehr/Verpackung)
    return todayOrders.map(order => {
      const isPickedUp = order.status === 'PICKED_UP' || order.status === 'COMPLETED' || order.pickupStatus === 'PICKED_UP';
      const hasEatIn = order.verzehrmodus === 'vor_ort';
      const hasReuse = order.verpackung === 'mehrweg' || (order.verpackung && String(order.verpackung).toLowerCase().includes('mehrweg'));
      return {
        orderId: order.id,
        code: order.pickupCode || order.code || '',
        dishName: order.dishName || order.summary || 'Gericht',
        pickupTime: order.pickupWindow || order.etaTime || order.abholzeit || '',
        status: isPickedUp ? 'PICKED_UP' : 'OPEN',
        hasEatIn: !!hasEatIn,
        hasReuse: !!hasReuse,
        order: order
      };
    });
  }

  function renderProviderPickups(){
    // Session-Aktivität aktualisieren
    updateSessionActivity();
    // Wochenplan-UI auf Abholungen-Seite ausblenden (keine Sheet/Snackbar/Overlay-Reste)
    if(typeof closeWeekAddSheet === 'function') closeWeekAddSheet();
    if(typeof hideWeekUndoSnackbar === 'function') hideWeekUndoSnackbar();
    document.querySelectorAll('.kw-move-overlay').forEach(function(o){ o.remove(); });
    var wu = document.getElementById('weekUndoSnackbar');
    if(wu){ wu.classList.remove('active'); wu.style.display = 'none'; }
    const subheader = document.getElementById('provPickupsSubheader');
    const filterEl = document.getElementById('provPickupFilter');
    const empty = document.getElementById('provPickupsEmpty');
    const listEl = document.getElementById('provPickupsList');
    if(!subheader || !filterEl || !empty || !listEl) return;

    // Subheader: "Heute · {weekday, date}"
    const today = new Date();
    const weekday = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'][today.getDay()];
    const dateStr = `${today.getDate()}.${String(today.getMonth()+1).padStart(2,'0')}.`;
    subheader.textContent = `Heute · ${weekday}, ${dateStr}`;

    // Get all pickups
    const allPickups = buildPickupList();
    
    // Filter pickups
    const filteredPickups = allPickups.filter(p => {
      if(pickupFilter === 'offen') return p.status === 'OPEN';
      if(pickupFilter === 'abgeholt') return p.status === 'PICKED_UP';
      return true;
    });

    // Filter Toggle
    filterEl.innerHTML='';
    [
      {id:'offen', label:'Offen'},
      {id:'abgeholt', label:'Abgeholt'}
    ].forEach(f=>{
      const b=document.createElement('button');
      b.type='button';
      b.className='ans'+(pickupFilter===f.id?' on':'');
      b.textContent=f.label;
      b.onclick=()=>{ pickupFilter=f.id; renderProviderPickups(); };
      filterEl.appendChild(b);
    });

    // Empty States
    if(!allPickups.length){
      empty.style.display='block';
      empty.innerHTML = `
        <div style="font-weight:600; font-size:16px; margin-bottom:8px;">Keine Abholungen</div>
        <div style="font-size:14px; line-height:1.4; color:var(--muted);">Heute gibt es noch keine Abholungen.</div>
      `;
      listEl.style.display='none';
      return;
    }
    
    if(!filteredPickups.length){
      empty.style.display='block';
      if(pickupFilter === 'offen'){
        empty.innerHTML = `
          <div style="font-weight:600; font-size:16px; margin-bottom:8px;">Alles erledigt</div>
          <div style="font-size:14px; line-height:1.4; color:var(--muted);">Alle Abholungen sind abgeschlossen.</div>
        `;
      } else {
        empty.innerHTML = `
          <div style="font-weight:600; font-size:16px; margin-bottom:8px;">Keine abgeholten Bestellungen</div>
          <div style="font-size:14px; line-height:1.4; color:var(--muted);">Noch keine Bestellungen als abgeholt markiert.</div>
        `;
      }
      listEl.style.display='none';
      return;
    }
    
    empty.style.display='none';
    listEl.style.display='none'; // Grid hat Priorität

    // Sort pickups: Zuerst nach Abholzeit (früheste zuerst), dann nach Code-Reihenfolge
    const list = [...filteredPickups];
    list.sort((a, b) => {
      // Priorität 1: Abholzeit (früheste zuerst)
      const aTime = a.pickupTime || a.etaTime || '';
      const bTime = b.pickupTime || b.etaTime || '';
      if(aTime && bTime){
        // Parse time (z.B. "11:30" -> 1130)
        const parseTime = (timeStr) => {
          const match = String(timeStr).match(/(\d{1,2}):(\d{2})/);
          if(!match) return 9999; // Späteste Zeit
          return parseInt(match[1], 10) * 100 + parseInt(match[2], 10);
        };
        const aTimeNum = parseTime(aTime);
        const bTimeNum = parseTime(bTime);
        if(aTimeNum !== bTimeNum) return aTimeNum - bTimeNum;
      }
      
      // Priorität 2: Code-Reihenfolge (1A, 1B, 1C, 2A, 2B, 2C, 10A, 10B...)
      const parseCode = (code) => {
        const match = String(code || '').match(/^(\d+)([A-Z])$/);
        if(!match) return {num: 9999, letter: 'Z'};
        return {num: parseInt(match[1], 10), letter: match[2]};
      };
      const aCode = parseCode(a.code);
      const bCode = parseCode(b.code);
      
      if(aCode.num !== bCode.num) return aCode.num - bCode.num;
      return aCode.letter.localeCompare(bCode.letter);
    });

    // Render Grid (Theken-Grid) - Große Kacheln
    const gridEl = document.getElementById('provPickupsGrid');
    if(gridEl){
      gridEl.style.display = filteredPickups.length > 0 ? 'grid' : 'none';
      gridEl.innerHTML = '';
      
      list.forEach(p=>{
        const isDone = p.status === 'PICKED_UP';
        const isPaid = !isDone;
        const codeDisplay = (p.code ? '#' + String(p.code).replace(/\s/g,'') : '#–');
        const icons = [];
        if(p.hasEatIn) icons.push('<span style="font-size:18px;" title="Vor Ort">🍴</span>');
        if(p.hasReuse) icons.push('<span style="font-size:18px;" title="Mehrweg">🔄</span>');
        icons.push('<span style="font-size:18px;" title="Abholnummer">🧾</span>');
        const iconsHtml = icons.join(' ');
        
        const card = document.createElement('div');
        card.className = `pickup-card ${isDone ? 'status-done' : 'status-paid'}`;
        card.innerHTML = `
          <div class="pickup-card-header">
            <div class="pickup-card-code">${esc(codeDisplay)}</div>
            <div class="pickup-card-time">${esc(p.pickupTime || 'Sofort')}</div>
          </div>
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px; font-size:16px;">${iconsHtml}</div>
          <div class="pickup-card-body">
            <div class="pickup-card-dish">${esc((p.dishName || 'Gericht').split(',')[0])}</div>
            <div class="pickup-card-customer">${p.order && p.order.customerName ? esc(p.order.customerName) : 'Gast'}</div>
          </div>
          ${!isDone ? '<div class="pickup-card-badge">Bezahlt</div>' : ''}
          <div class="check-overlay"><i data-lucide="check" class="check-icon" style="width:48px;height:48px;color:#fff;stroke-width:4;"></i></div>
        `;
        card.onclick = () => {
          if(isDone){
            if(confirm('Abholnummer wieder als „Offen“ markieren?')){
              updateOrder(p.orderId, { status: 'PAID', pickupStatus: undefined, completedAt: undefined });
              renderProviderPickups();
            }
          } else {
            openPickupDetailSheet(p.orderId);
          }
        };
        gridEl.appendChild(card);
      });
        
    }
    
    // Render list (falls Grid nicht verfügbar)
    listEl.innerHTML='';
    listEl.style.display = gridEl ? 'none' : (filteredPickups.length > 0 ? 'block' : 'none');
    list.forEach(p=>{
      const isPickedUp = p.status === 'PICKED_UP';
      const codeDisplay = p.code ? '#' + String(p.code).replace(/\s/g,'') : '#–';
      const icons = (p.hasEatIn ? '🍴 ' : '') + (p.hasReuse ? '🔄 ' : '') + '🧾';
      const row = document.createElement('div');
      row.className = 'pickup-row' + (isPickedUp ? ' picked-up' : '');
      row.style.cssText = 'display:flex; align-items:center; gap:16px; padding:16px; border-bottom:1px solid var(--border); ' + (isPickedUp ? 'opacity:0.5; background:#f8f8f8;' : 'cursor:pointer;');
      row.innerHTML = `
        <div style="font-size:32px; font-weight:900; font-family:monospace; color:var(--brand); min-width:70px; text-align:center; line-height:1;">${esc(codeDisplay)}</div>
        <div style="font-size:16px; margin-right:8px;">${icons}</div>
        <div style="flex:1; min-width:0;">
          <div style="font-weight:600; font-size:16px; line-height:1.3; margin-bottom:4px;">${esc((p.dishName||'').split(',')[0])}</div>
          <div style="font-size:14px; color:var(--muted); margin-bottom:4px;">${esc(p.pickupTime || '')}</div>
          <div style="font-size:13px; color:${isPickedUp ? 'var(--muted)' : '#2e7d32'}; font-weight:500;">${isPickedUp ? '✅ Abgeholt' : '🟢 Bezahlt'}</div>
        </div>
      `;
      if(!isPickedUp){
        row.onclick = () => openPickupDetailSheet(p.orderId);
      }
      listEl.appendChild(row);
    });
    
    // PDF-Küchenliste Buttons
    const btnKitchenListPDF = document.getElementById('btnKitchenListPDF');
    const btnKitchenListEmail = document.getElementById('btnKitchenListEmail');
    if(btnKitchenListPDF){
      btnKitchenListPDF.onclick = () => {
        generateKitchenListPDF();
      };
    }
    if(btnKitchenListEmail){
      btnKitchenListEmail.onclick = () => {
        emailKitchenList();
      };
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }
  
  // Pickup Detail Sheet (Sammel-Ansicht: Abholnummer, Gerichte, Vor Ort/Mehrweg, Alles übergeben)
  let currentPickupConfirmOrderId = null;
  
  function openPickupConfirmSheet(orderId, code, dishName){
    openPickupDetailSheet(orderId);
  }
  
  function openPickupDetailSheet(orderId){
    const order = getOrderById(orderId);
    if(!order) return;
    currentPickupConfirmOrderId = orderId;
    const code = order.pickupCode || order.code || '–';
    const codeDisplay = code ? '#' + String(code).replace(/\s/g,'') : '#–';
    const codeEl = document.getElementById('pickupConfirmCode');
    if(codeEl) codeEl.textContent = codeDisplay;
    const hasEatIn = order.verzehrmodus === 'vor_ort';
    const hasReuse = order.verpackung === 'mehrweg' || (order.verpackung && String(order.verpackung).toLowerCase().includes('mehrweg'));
    const iconsRow = document.getElementById('pickupConfirmIcons');
    if(iconsRow) iconsRow.innerHTML = (hasEatIn ? '<span title="Vor Ort">🍴</span>' : '') + (hasReuse ? '<span title="Mehrweg">🔄</span>' : '') + '<span title="Abholnummer">🧾</span>';
    const dishesEl = document.getElementById('pickupConfirmDishes');
    if(dishesEl){
      const dishLines = (order.dishName || order.summary || 'Gericht').split(',').map(s => s.trim()).filter(Boolean);
      if(!dishLines.length) dishLines.push('Gericht');
      dishesEl.innerHTML = dishLines.map(line => {
        const icon = hasEatIn ? '🍴 Vor Ort' : (hasReuse ? '🔄 Mehrweg' : '🧾');
        return `<div style="display:flex; align-items:center; justify-content:space-between; padding:12px 14px; background:#f8f9fa; border-radius:12px; font-size:15px;"><span>${esc(line)}</span><span style="font-size:14px; color:#64748b;">${esc(icon)}</span></div>`;
      }).join('');
    }
    document.getElementById('pickupConfirmBd').classList.add('active');
    document.getElementById('pickupConfirmSheet').classList.add('active');
  }
  
  function closePickupConfirmSheet(){
    document.getElementById('pickupConfirmBd').classList.remove('active');
    document.getElementById('pickupConfirmSheet').classList.remove('active');
    currentPickupConfirmOrderId = null;
  }
  
  function showPickupSuccessThenNextStep(orderId){
    const order = getOrderById(orderId);
    if(!order) return;
    const totalEur = (order.total || 0) / 100;
    const netto = Math.max(0, totalEur - ABHOLNUMMER_FEE);
    const nettoStr = netto.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';
    const overlay = document.getElementById('pickupSuccessOverlay');
    const nettoEl = document.getElementById('pickupSuccessNetto');
    if(overlay){ overlay.style.display = 'flex'; }
    if(nettoEl){ nettoEl.textContent = 'Netto-Verdienst: ' + nettoStr; }
    setTimeout(() => {
      if(overlay) overlay.style.display = 'none';
      const allPickups = buildPickupList();
      const openPickups = allPickups.filter(p => p.status === 'OPEN');
      const nextEl = document.getElementById('pickupNextStepOverlay');
      const titleEl = document.getElementById('pickupNextStepTitle');
      const listEl = document.getElementById('pickupNextStepList');
      if(nextEl) nextEl.style.display = 'flex';
      if(titleEl) titleEl.textContent = openPickups.length ? '🎉 Noch ' + openPickups.length + ' Essen offen!' : '🎉 Alles erledigt!';
      if(listEl){
        const next3 = openPickups.slice(0, 3);
        listEl.innerHTML = next3.length ? next3.map(p => {
          const codeDisplay = p.code ? '#' + String(p.code).replace(/\s/g,'') : '#–';
          return '<button type="button" data-order-id="' + esc(p.orderId) + '" style="display:flex; align-items:center; justify-content:space-between; padding:14px 16px; background:#f1f5f9; border:none; border-radius:14px; font-size:16px; font-weight:700; cursor:pointer; text-align:left;">' + esc(codeDisplay) + ' <span style="color:#64748b; font-weight:500;">→</span></button>';
        }).join('') : '<p style="margin:0; color:#64748b; font-size:15px;">Keine weiteren Abholnummern.</p>';
        listEl.querySelectorAll('button[data-order-id]').forEach(btn => {
          btn.onclick = () => {
            const id = btn.getAttribute('data-order-id');
            document.getElementById('pickupNextStepOverlay').style.display = 'none';
            if(id) openPickupDetailSheet(id);
          };
        });
      }
      const btnClose = document.getElementById('btnPickupNextStepClose');
      if(btnClose) btnClose.onclick = () => { document.getElementById('pickupNextStepOverlay').style.display = 'none'; renderProviderPickups(); };
    }, 2200);
  }
  
  const btnPickupConfirmYes = document.getElementById('btnPickupConfirmYes');
  if(btnPickupConfirmYes){
    btnPickupConfirmYes.onclick = () => {
      if(!currentPickupConfirmOrderId) return;
      const order = getOrderById(currentPickupConfirmOrderId);
      if(!order) return;
      updateOrder(currentPickupConfirmOrderId, { status: 'PICKED_UP', pickupStatus: 'PICKED_UP', completedAt: Date.now() });
      closePickupConfirmSheet();
      renderProviderPickups();
      showPickupSuccessThenNextStep(currentPickupConfirmOrderId);
    };
  }
  
  const btnPickupConfirmNo = document.getElementById('btnPickupConfirmNo');
  if(btnPickupConfirmNo){
    btnPickupConfirmNo.onclick = () => { closePickupConfirmSheet(); };
  }

  function showPickupUndo(key){
    pickupUndoKey = key;
    const snack = document.getElementById('pickupUndo');
    if(!snack) return;
    const label = document.getElementById('pickupUndoLabel');
    if(label) label.textContent = 'Abholung markiert';
    const btn = document.getElementById('pickupUndoBtn');
    if(btn){
      btn.onclick=()=>{
        if(pickupUndoKey && pickupDone.has(pickupUndoKey)){
          pickupDone.delete(pickupUndoKey);
          save(LS.pickupDone, Array.from(pickupDone));
          renderProviderPickups();
        }
        hidePickupUndo();
      };
    }
    snack.classList.add('active');
    if(pickupUndoTimer) clearTimeout(pickupUndoTimer);
    pickupUndoTimer = setTimeout(hidePickupUndo, 5000);
  }

  function hidePickupUndo(){
    const snack = document.getElementById('pickupUndo');
    if(!snack) return;
    snack.classList.remove('active');
    pickupUndoKey = null;
  }

  function renderProviderProfile(){
    updateSessionActivity();
    ensureProviderBusinessDataCard();
    const p = normalizeProviderProfile(provider.profile || {});
    const addr = buildAddress(p);
    const name = p.name || 'Betriebsname';
    
    function goProfileBack(){ showProviderProfileSub(null); }
    var backSettings = document.getElementById('providerProfileBackSettings');
    if(backSettings) backSettings.onclick = goProfileBack;
    var backFaq = document.getElementById('providerProfileBackFaq');
    if(backFaq) backFaq.onclick = function(){ if(typeof haptic === 'function') haptic(6); if(typeof showProviderProfileSub === 'function') showProviderProfileSub('settings'); };
    var btnImpressum = document.getElementById('btnProviderImpressum');
    var impressumContent = document.getElementById('providerImpressumContent');
    if(btnImpressum && impressumContent) btnImpressum.onclick = function(){ if(typeof haptic === 'function') haptic(6); impressumContent.style.display = impressumContent.style.display === 'none' ? 'block' : 'none'; };
    var btnBillingArchive = document.getElementById('btnBillingArchive');
    if(btnBillingArchive) btnBillingArchive.onclick = function(){ if(!checkSessionValidity()) return; showView(views.providerBilling); renderBilling(); };
    var btnSettingsBillingArchive = document.getElementById('btnSettingsBillingArchive');
    if(btnSettingsBillingArchive) btnSettingsBillingArchive.onclick = function(){ if(!checkSessionValidity()) return; showView(views.providerBilling); renderBilling(); };
    var btnSettingsSupport = document.getElementById('btnSettingsSupport');
    var btnSettingsSupportFooter = document.getElementById('btnSettingsSupportFooter');
    function openSupportPage(){ if(typeof haptic === 'function') haptic(6); if(typeof showProviderProfileSub === 'function') showProviderProfileSub('faq'); }
    if(btnSettingsSupport) btnSettingsSupport.onclick = openSupportPage;
    if(btnSettingsSupportFooter) btnSettingsSupportFooter.onclick = openSupportPage;
    // Support & Hilfe: Erste-Hilfe-Karten → Sofort-Lösung → Mail an Mike
    var supportSolutions = {
      standort: 'Standort kalibrieren: Öffne Einstellungen (Zahnrad) → Betriebsdaten. Prüfe Anschrift, PLZ und Ort. Dein Standort wird für die Kunden-Suche verwendet.',
      zahlung: 'Zahlung prüfen: In den Einstellungen unter „Abrechnung & Support“ → Zahlungsmethoden. Stelle sicher, dass eine gültige Karte hinterlegt ist.',
      abholnummer: 'Abholnummer: Sie wird bei jeder Bestellung automatisch generiert. Prüfe unter „Abholnummer“ (Tab in der App) deine heutigen Abholungen. Die Einstellung „Abholnummer“ findest du in den Einstellungen unter den 3 Säulen.',
      sichtbarkeit: 'Sichtbarkeit: Dein Inserat ist nur während des von dir gesetzten Zeitfensters (Mittagszeiten) für Kunden sichtbar. Außerhalb dieser Zeit erscheint es nicht im Feed – so ist es gewollt.'
    };
    var abholungenBtn = document.getElementById('providerSupportAbholungenBtn');
    document.querySelectorAll('.provider-support-error-card').forEach(function(btn){
      btn.onclick = function(){
        if(typeof haptic === 'function') haptic(6);
        var issue = btn.getAttribute('data-issue');
        var subject = (btn.getAttribute('data-subject') || '').trim();
        var textEl = document.getElementById('providerSupportSolutionText');
        var solutionWrap = document.getElementById('providerSupportSolution');
        if(textEl) textEl.textContent = supportSolutions[issue] || '';
        if(solutionWrap){ solutionWrap.style.display = 'block'; solutionWrap.setAttribute('data-subject', subject); }
        if(abholungenBtn) abholungenBtn.style.display = issue === 'abholnummer' ? 'block' : 'none';
      };
    });
    if(abholungenBtn) abholungenBtn.onclick = function(){
      if(typeof haptic === 'function') haptic(6);
      if(typeof setProviderNavActive === 'function') setProviderNavActive('provider-pickups');
      if(typeof showView === 'function' && typeof views !== 'undefined' && views.providerPickups) showView(views.providerPickups);
    };
    var supportMailBtn = document.getElementById('providerSupportMailBtn');
    if(supportMailBtn) supportMailBtn.onclick = function(){
      if(typeof haptic === 'function') haptic(6);
      var solutionWrap = document.getElementById('providerSupportSolution');
      var subj = (solutionWrap && solutionWrap.getAttribute('data-subject')) ? solutionWrap.getAttribute('data-subject') : 'Anfrage';
      openSupportMail(subj);
    };
    function openSupportMail(thema){
      var p = (provider && provider.profile) ? provider.profile : {};
      var betrieb = (p.name || p.businessName || 'Betrieb').trim();
      var subject = '[SUPPORT] - ' + betrieb + ' - ' + (thema || 'Anfrage');
      var mailto = 'mailto:support@mittagio.de?subject=' + encodeURIComponent(subject);
      window.location.href = mailto;
      if(typeof showToast === 'function') showToast('Nachricht gesendet! Mike meldet sich garantiert innerhalb von 24h persönlich.');
    }
    document.querySelectorAll('.provider-support-accordion-trigger').forEach(function(trigger){
      trigger.onclick = function(){
        if(typeof haptic === 'function') haptic(6);
        var item = trigger.closest('.provider-support-accordion-item');
        var content = item ? item.querySelector('.accordion-content') : null;
        var chevron = trigger.querySelector('.chevron-icon');
        var isOpen = content && content.classList.contains('open');
        document.querySelectorAll('.provider-support-accordion .accordion-content').forEach(function(c){ c.classList.remove('open'); });
        document.querySelectorAll('.provider-support-accordion .chevron-icon').forEach(function(ch){ ch.classList.remove('rotated'); });
        document.querySelectorAll('.provider-support-accordion-trigger').forEach(function(t){ t.setAttribute('aria-expanded', 'false'); });
        if(!isOpen && content){ content.classList.add('open'); if(chevron) chevron.classList.add('rotated'); if(trigger) trigger.setAttribute('aria-expanded', 'true'); }
      };
    });
    var btnProviderSupportMike = document.getElementById('btnProviderSupportMike');
    if(btnProviderSupportMike) btnProviderSupportMike.onclick = function(){
      if(typeof haptic === 'function') haptic(8);
      openSupportMail('Anfrage');
    };
    var btnProviderDeleteAccount = document.getElementById('btnProviderDeleteAccount');
    if(btnProviderDeleteAccount){ btnProviderDeleteAccount.onclick = function(){ if(confirm('Account wirklich dauerhaft löschen? Diese Aktion kann nicht rückgängig gemacht werden.')) { showToast('Account-Löschung angefragt.'); } }; }

    // Identity-Bereich auf der Einstellungsseite (Sub Settings)
    var settingsLogo = document.getElementById('providerSettingsLogo');
    var settingsName = document.getElementById('providerSettingsName');
    var settingsOrt = document.getElementById('providerSettingsOrt');
    if(settingsLogo){
      if(p.logoData){ settingsLogo.style.backgroundImage = `url('${esc(p.logoData)}')`; settingsLogo.innerHTML = ''; }
      else { settingsLogo.style.backgroundImage = 'none'; settingsLogo.innerHTML = '<span style="font-size:22px; font-weight:900; color:#64748b;">' + esc((name || 'B').charAt(0).toUpperCase()) + '</span>'; }
    }
    if(settingsName) settingsName.textContent = name || 'Betriebsname';
    if(settingsOrt) settingsOrt.textContent = (p.city || (p.zip && p.city ? p.zip + ' ' + p.city : '') || addr || 'Ort').trim() || '—';
    var gearBtn = document.getElementById('providerProfileGearBtn');
    if(gearBtn) gearBtn.onclick = function(){
      if(typeof haptic === 'function') haptic(6);
      if(typeof showProviderProfileSub === 'function') showProviderProfileSub('settings');
    };
    var headerBrand = document.getElementById('providerProfileHeaderBrand');
    if(headerBrand){ headerBrand.onclick = function(){ if(typeof showProviderHome === 'function') showProviderHome(); }; headerBrand.style.cursor = 'pointer'; }
    var btnProfileInserieren = document.getElementById('btnProviderProfileInserieren');
    if(btnProfileInserieren) btnProfileInserieren.onclick = function(){ if(typeof haptic === 'function') haptic(8); if(typeof openDishFlow === 'function') openDishFlow(); };
    var btnProfileInserierenHero = document.getElementById('btnProviderProfileInserierenHero');
    if(btnProfileInserierenHero) btnProfileInserierenHero.onclick = function(){ if(typeof haptic === 'function') haptic(8); if(typeof openDishFlow === 'function') openDishFlow(); };
    var btnProfileAbrechnung = document.getElementById('btnProviderProfileAbrechnung');
    if(btnProfileAbrechnung) btnProfileAbrechnung.onclick = function(){ if(typeof haptic === 'function') haptic(6); if(typeof showProviderBilling === 'function') showProviderBilling(); };
    if(btnProfileAbrechnung) btnProfileAbrechnung.onkeydown = function(e){ if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); btnProfileAbrechnung.click(); } };
    
    // Kontaktdaten (Adresse, Telefon, E-Mail, Internetseite)
    const profileBusinessName = document.getElementById('providerProfileBusinessName');
    const profileStreet = document.getElementById('providerProfileStreet');
    const profileZip = document.getElementById('providerProfileZip');
    const profileCity = document.getElementById('providerProfileCity');
    const profilePhone = document.getElementById('providerProfilePhone');
    const profileEmail = document.getElementById('providerProfileEmail');
    const profileWebsite = document.getElementById('providerProfileWebsite');
    const btnSaveBusiness = document.getElementById('btnProviderSaveBusiness');

    const saveAllBusinessData = () => {
      if(!provider.profile) provider.profile = {};
      provider.profile.name = profileBusinessName ? profileBusinessName.value.trim() : (p.name || '');
      provider.profile.street = profileStreet ? profileStreet.value.trim() : (p.street || '');
      provider.profile.zip = profileZip ? profileZip.value.trim() : (p.zip || '');
      provider.profile.city = profileCity ? profileCity.value.trim() : (p.city || '');
      provider.profile.phone = profilePhone ? profilePhone.value.trim() : (p.phone || '');
      provider.profile.email = profileEmail ? profileEmail.value.trim() : (p.email || '');
      provider.profile.website = profileWebsite ? profileWebsite.value.trim() : (p.website || '');
      provider.profile.address = buildAddress(provider.profile);
      save(LS.provider, provider);
      showToast('Daten gespeichert');
      renderProviderProfile(); // UI updaten
    };

    if(profileBusinessName) profileBusinessName.value = p.name || '';
    if(profileStreet) profileStreet.value = p.street || '';
    if(profileZip) profileZip.value = p.zip || '';
    if(profileCity) profileCity.value = p.city || '';
    if(profilePhone) profilePhone.value = p.phone || '';
    if(profileEmail) profileEmail.value = p.email || '';
    if(profileWebsite) profileWebsite.value = p.website || '';
    [profileBusinessName, profileStreet, profileZip, profileCity, profilePhone, profileEmail, profileWebsite].forEach(function(el){
      if(!el) return;
      if(el.value && el.value.trim()) el.classList.add('floating-filled'); else el.classList.remove('floating-filled');
      el.addEventListener('input', function(){ if(this.value && this.value.trim()) this.classList.add('floating-filled'); else this.classList.remove('floating-filled'); });
    });
    if(btnSaveBusiness) btnSaveBusiness.onclick = saveAllBusinessData;
    
    // Meine Mittagszeiten: Start/Ende (Profil + Einstellungen mit eigenen IDs)
    const mealStartEl = document.getElementById('providerMealStart');
    const mealEndEl = document.getElementById('providerMealEnd');
    const settingsMealStartEl = document.getElementById('providerSettingsMealStart');
    const settingsMealEndEl = document.getElementById('providerSettingsMealEnd');
    let timeOptions = '';
    for(let h=8; h<=20; h++){
      for(let m=0; m<60; m+=15){
        let t = (h<10?'0'+h:h)+':'+(m===0?'00':m);
        timeOptions += `<option value="${t}">${t} Uhr</option>`;
      }
    }
    if(mealStartEl && mealStartEl.options.length === 0){ mealStartEl.innerHTML = timeOptions; if(mealEndEl) mealEndEl.innerHTML = timeOptions; }
    if(settingsMealStartEl && settingsMealStartEl.options.length === 0){ settingsMealStartEl.innerHTML = timeOptions; if(settingsMealEndEl) settingsMealEndEl.innerHTML = timeOptions; }
    const saveMealWindow = (fromStart, fromEnd) => {
      if(!provider.profile) provider.profile = {};
      const start = (fromStart && fromStart.value) ? fromStart.value : (p.mealStart || '11:30');
      const end = (fromEnd && fromEnd.value) ? fromEnd.value : (p.mealEnd || '14:00');
      provider.profile.mealStart = start;
      provider.profile.mealEnd = end;
      provider.profile.mealWindow = `${start} – ${end}`;
      save(LS.provider, provider);
      showToast('Mittagszeiten gespeichert');
      if(mealStartEl) mealStartEl.value = start;
      if(mealEndEl) mealEndEl.value = end;
      if(settingsMealStartEl) settingsMealStartEl.value = start;
      if(settingsMealEndEl) settingsMealEndEl.value = end;
      if(typeof updateProviderSettingsTimeDisplay === 'function') updateProviderSettingsTimeDisplay();
    };
    const startVal = p.mealStart || '11:30';
    const endVal = p.mealEnd || '14:00';
    if(mealStartEl){ mealStartEl.value = startVal; mealStartEl.onchange = function(){ if(typeof haptic === 'function') haptic(6); saveMealWindow(mealStartEl, mealEndEl); }; }
    if(mealEndEl){ mealEndEl.value = endVal; mealEndEl.onchange = function(){ if(typeof haptic === 'function') haptic(6); saveMealWindow(mealStartEl, mealEndEl); }; }
    if(settingsMealStartEl){ settingsMealStartEl.value = startVal; settingsMealStartEl.onchange = function(){ if(typeof haptic === 'function') haptic(6); saveMealWindow(settingsMealStartEl, settingsMealEndEl); }; }
    if(settingsMealEndEl){ settingsMealEndEl.value = endVal; settingsMealEndEl.onchange = function(){ if(typeof haptic === 'function') haptic(6); saveMealWindow(settingsMealStartEl, settingsMealEndEl); }; }
    if(typeof updateProviderSettingsTimeDisplay === 'function') updateProviderSettingsTimeDisplay();
    var timeTrigger = document.getElementById('providerSettingsTimeTrigger');
    var timeWheelWrap = document.getElementById('providerSettingsTimeWheelWrap');
    if(timeTrigger && timeWheelWrap) timeTrigger.onclick = function(){
      if(typeof haptic === 'function') haptic(6);
      var isHidden = timeWheelWrap.style.display === 'none' || !timeWheelWrap.style.display;
      timeWheelWrap.style.display = isHidden ? 'block' : 'none';
      if(isHidden){ var first = document.getElementById('providerSettingsMealStart'); if(first) first.focus(); }
    };
    
    // Wochentage (Mo=1 … So=7) – Profil + Einstellungen mit eigenen IDs, Sync bei Änderung
    const labelsWd = [{d:1,l:'Mo'},{d:2,l:'Di'},{d:3,l:'Mi'},{d:4,l:'Do'},{d:5,l:'Fr'},{d:6,l:'Sa'},{d:7,l:'So'}];
    const fillWeekdaysWrap = (wrap) => {
      if(!wrap) return;
      const arr = Array.isArray(provider.profile && provider.profile.lunchWeekdays) ? provider.profile.lunchWeekdays : [1,2,3,4,5];
      wrap.innerHTML = labelsWd.map(({d,l}) => `<label style="display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border-radius:10px; border:2px solid ${arr.includes(d)?'#FFDE00':'#e7e1d5'}; background:${arr.includes(d)?'rgba(255,222,0,0.15)':'#fff'}; cursor:pointer; font-size:14px; font-weight:600;"><input type="checkbox" data-wd="${d}" ${arr.includes(d)?'checked':''} style="width:18px; height:18px;">${l}</label>`).join('');
    };
    const bindWeekdaysWrap = (wrap, otherWrap) => {
      if(!wrap) return;
      wrap.querySelectorAll('input[type=checkbox]').forEach(cb => {
        cb.onchange = () => {
          const wd = parseInt(cb.dataset.wd, 10);
          if(!provider.profile) provider.profile = {};
          if(!Array.isArray(provider.profile.lunchWeekdays)) provider.profile.lunchWeekdays = [1,2,3,4,5];
          if(cb.checked) { if(!provider.profile.lunchWeekdays.includes(wd)) provider.profile.lunchWeekdays.push(wd); }
          else provider.profile.lunchWeekdays = provider.profile.lunchWeekdays.filter(x => x !== wd);
          provider.profile.lunchWeekdays.sort((a,b)=>a-b);
          save(LS.provider, provider);
          showToast('Wochentage gespeichert');
          fillWeekdaysWrap(otherWrap);
          bindWeekdaysWrap(otherWrap, wrap);
        };
      });
    };
    const weekdaysWrap = document.getElementById('providerLunchWeekdays');
    const weekdaysWrapSettings = document.getElementById('providerSettingsLunchWeekdays');
    fillWeekdaysWrap(weekdaysWrap);
    fillWeekdaysWrap(weekdaysWrapSettings);
    bindWeekdaysWrap(weekdaysWrap, weekdaysWrapSettings);
    bindWeekdaysWrap(weekdaysWrapSettings, weekdaysWrap);
    
    // Abholnummer-Standard-Toggle
    const abholnummerEnabled = document.getElementById('providerAbholnummerEnabled');
    const abholnummerSwitch = abholnummerEnabled ? abholnummerEnabled.closest('.toggle-switch') : null;
    if(abholnummerEnabled){
      abholnummerEnabled.checked = p.abholnummerEnabledByDefault || false;
      if(abholnummerSwitch){ abholnummerEnabled.checked ? abholnummerSwitch.classList.add('active') : abholnummerSwitch.classList.remove('active'); }
      abholnummerEnabled.onchange = () => {
        if(!provider.profile) provider.profile = {};
        provider.profile.abholnummerEnabledByDefault = abholnummerEnabled.checked;
        save(LS.provider, provider);
        if(abholnummerSwitch){ abholnummerEnabled.checked ? abholnummerSwitch.classList.add('active') : abholnummerSwitch.classList.remove('active'); }
        showToast(abholnummerEnabled.checked ? 'Abholnummer standardmäßig an' : 'Abholnummer standardmäßig aus');
      };
      if(abholnummerSwitch){ abholnummerSwitch.onclick = () => { abholnummerEnabled.checked = !abholnummerEnabled.checked; abholnummerEnabled.onchange(); }; }
    }

    // Vor-Ort-Standard-Toggle (🍴)
    const dineInEnabled = document.getElementById('providerDineInEnabled');
    const dineInSwitch = dineInEnabled ? dineInEnabled.closest('.toggle-switch') : null;
    if(dineInEnabled){
      dineInEnabled.checked = p.dineInPossibleDefault !== false;
      if(dineInSwitch){ dineInEnabled.checked ? dineInSwitch.classList.add('active') : dineInSwitch.classList.remove('active'); }
      dineInEnabled.onchange = () => {
        if(!provider.profile) provider.profile = {};
        provider.profile.dineInPossibleDefault = dineInEnabled.checked;
        save(LS.provider, provider);
        if(dineInSwitch){ dineInEnabled.checked ? dineInSwitch.classList.add('active') : dineInSwitch.classList.remove('active'); }
        showToast(dineInEnabled.checked ? 'Vor Ort standardmäßig an' : 'Vor Ort standardmäßig aus');
      };
      if(dineInSwitch){ dineInSwitch.onclick = () => { dineInEnabled.checked = !dineInEnabled.checked; dineInEnabled.onchange(); }; }
    }

    // Allergene-Standard-Toggle (Präferenzen)
    const wantsAllergensEnabled = document.getElementById('providerWantsAllergensEnabled');
    const wantsAllergensSwitch = wantsAllergensEnabled ? wantsAllergensEnabled.closest('.toggle-switch') : null;
    if(wantsAllergensEnabled){
      wantsAllergensEnabled.checked = p.wantsAllergensByDefault || false;
      if(wantsAllergensSwitch){ wantsAllergensEnabled.checked ? wantsAllergensSwitch.classList.add('active') : wantsAllergensSwitch.classList.remove('active'); }
      wantsAllergensEnabled.onchange = () => {
        if(!provider.profile) provider.profile = {};
        provider.profile.wantsAllergensByDefault = wantsAllergensEnabled.checked;
        save(LS.provider, provider);
        if(wantsAllergensSwitch){ wantsAllergensEnabled.checked ? wantsAllergensSwitch.classList.add('active') : wantsAllergensSwitch.classList.remove('active'); }
        showToast(wantsAllergensEnabled.checked ? 'Allergene standardmäßig angeben' : 'Allergene standardmäßig aus');
      };
      if(wantsAllergensSwitch){ wantsAllergensSwitch.onclick = () => { wantsAllergensEnabled.checked = !wantsAllergensEnabled.checked; wantsAllergensEnabled.onchange(); }; }
    }

    // Einstellungs-Seite: gleiche Toggles mit eigenen IDs (keine Duplicate-ID), Sync mit Profil + Haupt-Checkbox
    function bindSettingsToggle(settingsId, mainId, profileKey, getVal, toastOn, toastOff) {
      const el = document.getElementById(settingsId);
      if(!el) return;
      const sw = el.closest('.toggle-switch');
      el.checked = getVal(p);
      if(sw){ el.checked ? sw.classList.add('active') : sw.classList.remove('active'); }
      el.onchange = () => {
        if(!provider.profile) provider.profile = {};
        provider.profile[profileKey] = el.checked;
        save(LS.provider, provider);
        if(sw){ el.checked ? sw.classList.add('active') : sw.classList.remove('active'); }
        showToast(el.checked ? toastOn : toastOff);
        var main = document.getElementById(mainId);
        if(main){ main.checked = el.checked; var msw = main.closest('.toggle-switch'); if(msw){ main.checked ? msw.classList.add('active') : msw.classList.remove('active'); } }
      };
      if(sw){ sw.onclick = () => { el.checked = !el.checked; el.onchange(); }; }
    }
    bindSettingsToggle('providerSettingsDineInEnabled', 'providerDineInEnabled', 'dineInPossibleDefault', function(p){ return p.dineInPossibleDefault !== false; }, 'Vor Ort standardmäßig an', 'Vor Ort standardmäßig aus');
    bindSettingsToggle('providerSettingsReuseEnabled', 'providerReuseEnabled', 'reuseEnabledByDefault', function(p){ return p.reuseEnabledByDefault || false; }, 'Mehrweg-Pfandsystem aktiviert', 'Mehrweg-Pfandsystem deaktiviert');
    bindSettingsToggle('providerSettingsAbholnummerEnabled', 'providerAbholnummerEnabled', 'abholnummerEnabledByDefault', function(p){ return p.abholnummerEnabledByDefault || false; }, 'Abholnummer standardmäßig an', 'Abholnummer standardmäßig aus');
    bindSettingsToggle('providerSettingsWantsAllergensEnabled', 'providerWantsAllergensEnabled', 'wantsAllergensByDefault', function(p){ return p.wantsAllergensByDefault || false; }, 'Allergene standardmäßig angeben', 'Allergene standardmäßig aus');
    
    // Account: Status 1 aktive Sitzung
    const sessionStatusEl = document.getElementById('providerSessionStatus');
    if(sessionStatusEl) sessionStatusEl.textContent = '1 aktive Sitzung';
    const btnChangePassword = document.getElementById('btnProviderChangePassword');
    if(btnChangePassword){ btnChangePassword.onclick = (e) => { e.preventDefault(); showToast('Passwort ändern: In der App unter Account verfügbar.'); }; }
    
    // Küchen-Zeiten: Automatischer Ausverkauf
    const autoSelloutTime = document.getElementById('providerAutoSelloutTime');
    if(autoSelloutTime){
      autoSelloutTime.value = p.autoSelloutTime || '14:00';
      autoSelloutTime.onchange = () => {
        if(!provider.profile) provider.profile = {};
        provider.profile.autoSelloutTime = autoSelloutTime.value;
        save(LS.provider, provider);
        showToast('Küchen-Zeiten gespeichert');
        
        // Automatischen Ausverkauf aktivieren (wenn Zeit erreicht)
        checkAutoSellout();
      };
    }
    
    // Küchen-E-Mail
    const kitchenEmail = document.getElementById('providerKitchenEmail');
    if(kitchenEmail){
      kitchenEmail.value = p.kitchenEmail || '';
      kitchenEmail.onchange = () => {
        if(!provider.profile) provider.profile = {};
        provider.profile.kitchenEmail = kitchenEmail.value;
        save(LS.provider, provider);
        showToast('Küchen-E-Mail gespeichert');
      };
    }
    
    // Mehrweg-Pfandsystem Switch
    const reuseEnabled = document.getElementById('providerReuseEnabled');
    const reuseSwitch = reuseEnabled ? reuseEnabled.closest('.toggle-switch') : null;
    if(reuseEnabled){
      reuseEnabled.checked = p.reuseEnabledByDefault || false;
      if(reuseSwitch){
        if(reuseEnabled.checked) reuseSwitch.classList.add('active');
        else reuseSwitch.classList.remove('active');
      }
      reuseEnabled.onchange = () => {
        if(!provider.profile) provider.profile = {};
        provider.profile.reuseEnabledByDefault = reuseEnabled.checked;
        save(LS.provider, provider);
        if(reuseSwitch){
          if(reuseEnabled.checked) reuseSwitch.classList.add('active');
          else reuseSwitch.classList.remove('active');
        }
        showToast(reuseEnabled.checked ? 'Mehrweg-Pfandsystem aktiviert' : 'Mehrweg-Pfandsystem deaktiviert');
      };
      // Toggle-Switch Klick-Handler
      if(reuseSwitch){
        reuseSwitch.onclick = () => {
          reuseEnabled.checked = !reuseEnabled.checked;
          reuseEnabled.onchange();
        };
      }
    }
    
    // Speisekarte teilen Button
    const btnShareMenu = document.getElementById('btnProviderShareMenu');
    if(btnShareMenu){
      btnShareMenu.onclick = () => {
        shareProviderMenu();
      };
    }
    
    // Finanz-Dashboard: Zeit-Ersparnis
    const timeSavedEl = document.getElementById('providerProfileTimeSaved');
    if(timeSavedEl){
      const todayAbholnummern = loadOrders().filter(o => {
        const offer = offers.find(off => off.id === o.dishId || off.providerId === o.providerId);
        return offer && offer.providerId === providerId() && offer.day === isoDate(new Date()) && o.status === 'PAID';
      }).length;
      const timeSavedMinutes = Math.round(todayAbholnummern * 1.5);
      timeSavedEl.textContent = `${timeSavedMinutes} Minuten`;
    }
    
    // Netto-Auszahlung pro Abholnummer (Beispiel: Durchschnittspreis - 0,89 €)
    const netPayoutEl = document.getElementById('providerProfileNetPayout');
    if(netPayoutEl){
      const todayOffers = offers.filter(o => o.providerId === providerId() && o.day === isoDate(new Date()) && o.active !== false);
      if(todayOffers.length > 0){
        const avgPrice = todayOffers.reduce((sum, o) => sum + (o.price || 0), 0) / todayOffers.length;
        const netPayout = Math.max(0, avgPrice - 0.89);
        netPayoutEl.textContent = euro(netPayout);
      } else {
        netPayoutEl.textContent = '–';
      }
    }
    
    // Icons aktualisieren (inkl. Support-Segment mit Herz-Icon)
    if(typeof lucide !== 'undefined'){
      setTimeout(() => lucide.createIcons(), 50);
    }
  }
  
  // Speisekarte teilen (Provider-Menü)
  function shareProviderMenu(){
    const profile = normalizeProviderProfile(provider.profile || {});
    const providerName = profile.name || provider.email || 'Anbieter';
    const providerIdVal = providerId();
    
    // Alle aktiven Gerichte des Providers sammeln
    const providerOffers = offers.filter(o => o.providerId === providerIdVal && o.active !== false);
    
    if(providerOffers.length === 0){
      showToast('Keine Gerichte zum Teilen');
      return;
    }
    
    const shareUrl = `${location.origin}${location.pathname}#provider/${providerIdVal}`;
    const shareText = `😋 Lust auf was Richtiges? Entdecke unsere aktuelle Speisekarte!\n\n📍 ${providerName}\n\n${providerOffers.slice(0, 5).map(o => `🍴 ${o.dish || o.title || 'Gericht'} - ${euro(o.price || 0)}`).join('\n')}${providerOffers.length > 5 ? `\n... und viele weitere Highlights!` : ''}\n\nDirekt online bestellen & Zeit sparen:\n👉 ${shareUrl}\n\n#mittagio #speisekarte #foodie #lunchtime`;
    
    if(navigator.share){
      navigator.share({
        title: `Speisekarte ${providerName}`,
        text: shareText,
        url: shareUrl
      }).then(() => {
        showToast('Speisekarte geteilt!');
      }).catch((err) => {
        if(err.name !== 'AbortError'){
          copyToClipboard(shareText);
          showToast('Link kopiert!');
        }
      });
    } else {
      copyToClipboard(shareText);
      showToast('Link kopiert!');
    }
  }
  
  // Automatischer Ausverkauf prüfen (wird regelmäßig aufgerufen)
  function checkAutoSellout(){
    const profile = normalizeProviderProfile(provider.profile || {});
    const autoSelloutTime = profile.autoSelloutTime;
    if(!autoSelloutTime) return;
    
    const now = new Date();
    const [hours, minutes] = autoSelloutTime.split(':').map(Number);
    const selloutTime = new Date();
    selloutTime.setHours(hours, minutes, 0, 0);
    
    // Prüfe ob aktuelle Zeit >= Ausverkauf-Zeit
    if(now >= selloutTime){
      const todayKey = isoDate(now);
      const mineToday = offers.filter(o => o.providerId === providerId() && o.day === todayKey && o.active !== false);
      
      if(mineToday.length > 0){
        let changed = false;
        mineToday.forEach(o => {
          if(o.active !== false){
            o.active = false;
            changed = true;
          }
        });
        
        if(changed){
          save(LS.offers, offers);
          renderProviderHome();
          renderDiscover();
          showToast('Automatischer Ausverkauf: Alle Gerichte deaktiviert');
        }
      }
    }
  }
  
  // Automatischen Ausverkauf regelmäßig prüfen (alle 5 Minuten)
  setInterval(checkAutoSellout, 5 * 60 * 1000);

  function renderBilling(){
    const listEl = document.getElementById('billingList');
    const emptyEl = document.getElementById('billingListEmpty');
    const todayListEl = document.getElementById('billingTodayList');
    const todayEmptyEl = document.getElementById('billingTodayEmpty');
    const todayRevenueEl = document.getElementById('billingTodayRevenue');
    const btnZahlungsmittel = document.getElementById('btnBillingZahlungsmittel');
    const btnBillingPortal = document.getElementById('btnProviderBillingPortal');
    if(btnZahlungsmittel) btnZahlungsmittel.onclick = function(){ showToast('Zahlungsmittel ändern (Demo – später Stripe/Backend).'); };
    if(btnBillingPortal) btnBillingPortal.onclick = function(){ if(typeof showToast === 'function') showToast('Stripe Dashboard (Demo – später Link zum Backend).'); };
    if(!listEl) return;

    const pid = typeof providerId === 'function' ? providerId() : '';
    const todayKey = typeof isoDate === 'function' ? isoDate(new Date()) : new Date().toISOString().slice(0,10);
    
    // 1. Tagesabrechnungen befüllen
    const ordersAll = typeof loadOrders === 'function' ? loadOrders() : [];
    const myTodayOrders = ordersAll.filter(o => o.providerId === pid && o.orderDate === todayKey && (o.status === 'PAID' || o.status === 'PICKED_UP'));
    const totalToday = myTodayOrders.reduce((sum, o) => sum + (o.totalPrice || 0), 0);
    
    if(todayRevenueEl) todayRevenueEl.textContent = totalToday.toFixed(2).replace('.', ',') + ' €';
    
    if(todayListEl){
      if(myTodayOrders.length === 0){
        todayListEl.style.display = 'none';
        if(todayEmptyEl) todayEmptyEl.style.display = 'block';
      } else {
        todayListEl.style.display = 'flex';
        if(todayEmptyEl) todayEmptyEl.style.display = 'none';
        todayListEl.innerHTML = myTodayOrders.map(o => `
          <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(0,0,0,0.04);">
            <div>
              <div style="font-weight:700; color:#1a1a1a;">${esc(o.dishName || 'Gericht')}</div>
              <div style="font-size:12px; color:#64748b;">${esc(o.pickupTime || 'Heute')} · #${esc(o.id.slice(-4))}</div>
            </div>
            <div style="font-weight:800; color:#16a34a;">+${(o.totalPrice || 0).toFixed(2).replace('.', ',')} €</div>
          </div>
        `).join('');
      }
    }

    // 2. Historische Abrechnungen befüllen
    var txs = typeof loadTransactions === 'function' ? loadTransactions() : [];
    var myTxs = txs.filter(function(t){ return t.vendor_id === pid; });
    myTxs.sort(function(a,b){ return (new Date(b.timestamp)) - (new Date(a.timestamp)); });

    if(emptyEl){ emptyEl.style.display = myTxs.length ? 'none' : 'block'; }
    listEl.style.display = myTxs.length ? 'flex' : 'none';

    listEl.innerHTML = myTxs.map(function(t){
      var datum = t.timestamp ? new Date(t.timestamp).toLocaleDateString('de-DE', { day:'2-digit', month:'2-digit', year:'numeric' }) : '–';
      var posten = t.inserat_id ? ('Inserat ' + t.inserat_id) : (t.id || '–');
      var betrag = (t.total_amount != null) ? Number(t.total_amount).toFixed(2).replace('.', ',') + ' €' : '–';
      var txJson = esc(JSON.stringify({ id: t.id, timestamp: t.timestamp, total_amount: t.total_amount, inserat_id: t.inserat_id }));
      return '<div style="display:flex; align-items:center; justify-content:space-between; padding:14px 0; border-bottom:1px solid rgba(0,0,0,0.06);">' +
        '<div><div style="font-weight:700; color:#1a1a1a;">' + esc(datum) + '</div><div style="font-size:13px; color:#64748b;">' + esc(posten) + '</div></div>' +
        '<div style="display:flex; align-items:center; gap:12px;"><span style="font-weight:800; color:#16a34a;">' + betrag + '</span>' +
        '<button type="button" aria-label="Rechnung als PDF" style="width:36px; height:36px; border-radius:50%; border:none; background:rgba(0,0,0,0.06); color:#1a1a1a; cursor:pointer; display:flex; align-items:center; justify-content:center;" data-tx="' + txJson + '"><i data-lucide="file-down" style="width:18px;height:18px;"></i></button></div></div>';
    }).join('');

    listEl.querySelectorAll('button[data-tx]').forEach(function(btn){
      btn.onclick = function(){
        try {
          var t = JSON.parse(btn.getAttribute('data-tx') || '{}');
          if(typeof openReceiptPrint === 'function') openReceiptPrint(t); else showToast('Rechnung wird geöffnet – Speichern als PDF über Drucken.');
        } catch(e){ showToast('Rechnung konnte nicht geladen werden.'); }
      };
    });
    if(typeof applyStaticIcons === 'function') applyStaticIcons();
    if(typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
  }

  // --- Admin: Guard + View + Render + CSV ---
  const ADMIN_FLAG_KEY = 'mittagio_admin';
  function isAdmin(){
    const urlParams = new URLSearchParams(window.location.search);
    if(urlParams.get('admin') === '1') return true;
    try { return localStorage.getItem(ADMIN_FLAG_KEY) === '1'; } catch(e){ return false; }
  }
  function showAdminView(){
    if(!isAdmin()){
      if(typeof showToast === 'function') showToast('Zugriff nur für Admins.');
      if(typeof showDiscover === 'function') showDiscover();
      else if(typeof showView === 'function') showView(views.discover || 'v-discover');
      return;
    }
    showView(views.admin || 'v-admin');
    renderAdmin();
    if(typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
  }
  function renderAdmin(){
    const kpiUmsatz = document.getElementById('adminKpiUmsatz');
    const kpiInserate = document.getElementById('adminKpiInserate');
    const kpiAbholnummern = document.getElementById('adminKpiAbholnummern');
    const feedList = document.getElementById('adminFeedList');
    const tableBody = document.getElementById('adminTableBody');
    const tableSum = document.getElementById('adminTableSum');
    const btnCsv = document.getElementById('adminBtnCsvExport');

    var txs = typeof loadTransactions === 'function' ? loadTransactions() : [];
    var allOffers = typeof load === 'function' ? load(LS.offers, []) : [];
    var activeOffers = allOffers.filter(function(o){ return o && o.active !== false; });
    var todayStr = typeof isoDate === 'function' ? isoDate(new Date()) : new Date().toISOString().slice(0,10);
    var todayTxs = txs.filter(function(t){ return t.timestamp && t.timestamp.slice(0,10) === todayStr; });
    var tagesumsatz = todayTxs.reduce(function(s, t){ return s + (Number(t.total_amount) || 0); }, 0);
    var ordersAll = typeof loadOrders === 'function' ? loadOrders() : [];
    var abholnummernCount = ordersAll.filter(function(o){ return o.status === 'PAID' || o.status === 'PICKED_UP'; }).length;

    if(kpiUmsatz) kpiUmsatz.textContent = (tagesumsatz.toFixed(2)).replace('.', ',') + ' €';
    if(kpiInserate) kpiInserate.textContent = String(activeOffers.length);
    if(kpiAbholnummern) kpiAbholnummern.textContent = String(abholnummernCount);

    if(feedList){
      feedList.innerHTML = activeOffers.slice(0, 20).map(function(o){
        var name = (o.dishName || o.dish || o.name || 'Inserat').substring(0, 40);
        var day = o.day || '–';
        var id = o.id || '–';
        return '<div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background:#f8f7f2; border-radius:12px;">' +
          '<div><div style="font-weight:700; color:#1a1a1a;">' + esc(name) + '</div><div style="font-size:12px; color:#64748b;">' + esc(day) + ' · ID ' + esc(id) + '</div></div>' +
          '<span style="font-size:12px; font-weight:700; color:#16a34a;">Live</span></div>';
      }).join('');
      if(activeOffers.length === 0) feedList.innerHTML = '<div class="hint" style="color:#64748b; padding:16px;">Keine aktiven Inserate.</div>';
    }

    txs = txs.slice().sort(function(a,b){ return (new Date(b.timestamp)) - (new Date(a.timestamp)); });
    var sumTotal = txs.reduce(function(s, t){ return s + (Number(t.total_amount) || 0); }, 0);
    if(tableBody){
      tableBody.innerHTML = txs.map(function(t){
        var datum = t.timestamp ? new Date(t.timestamp).toLocaleDateString('de-DE', { day:'2-digit', month:'2-digit', year:'numeric' }) : '–';
        var basis = (t.base_price != null) ? Number(t.base_price).toFixed(2).replace('.', ',') + ' €' : '–';
        var addon = (t.addon_price != null && Number(t.addon_price) > 0) ? Number(t.addon_price).toFixed(2).replace('.', ',') + ' €' : '–';
        var gesamt = (t.total_amount != null) ? Number(t.total_amount).toFixed(2).replace('.', ',') + ' €' : '–';
        return '<tr style="border-bottom:1px solid #e5e7eb;">' +
          '<td style="padding:12px 8px;">' + esc(datum) + '</td>' +
          '<td style="padding:12px 8px;">' + esc(t.vendor_id || '–') + '</td>' +
          '<td style="padding:12px 8px;">' + esc(t.inserat_id || '–') + '</td>' +
          '<td style="text-align:right; padding:12px 8px;">' + basis + '</td>' +
          '<td style="text-align:right; padding:12px 8px;">' + addon + '</td>' +
          '<td style="text-align:right; padding:12px 8px; font-weight:700;">' + gesamt + '</td></tr>';
      }).join('');
      if(txs.length === 0) tableBody.innerHTML = '<tr><td colspan="6" style="padding:24px; color:#64748b; text-align:center;">Keine Transaktionen.</td></tr>';
    }
    if(tableSum){
      tableSum.innerHTML = '<td style="padding:12px 8px;" colspan="3">Gesamt</td><td colspan="2"></td><td style="text-align:right; padding:12px 8px;">' + (sumTotal.toFixed(2)).replace('.', ',') + ' €</td>';
    }

    if(btnCsv){
      btnCsv.onclick = function(){
        var csvRows = ['Datum;Anbieter;Inserat-ID;Basis (€);Abholnummer (€);Gesamtbetrag (€)'];
        txs.forEach(function(t){
          var datum = t.timestamp ? new Date(t.timestamp).toLocaleDateString('de-DE') : '';
          var basis = (t.base_price != null) ? String(Number(t.base_price).toFixed(2).replace('.', ',')) : '';
          var addon = (t.addon_price != null) ? String(Number(t.addon_price).toFixed(2).replace('.', ',')) : '';
          var gesamt = (t.total_amount != null) ? String(Number(t.total_amount).toFixed(2).replace('.', ',')) : '';
          csvRows.push([datum, (t.vendor_id || ''), (t.inserat_id || ''), basis, addon, gesamt].join(';'));
        });
        var csv = '\uFEFF' + csvRows.join('\r\n');
        var blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'Umsaetze_Export_' + todayStr + '.csv';
        a.click();
        URL.revokeObjectURL(a.href);
        if(typeof showToast === 'function') showToast('CSV exportiert.');
      };
    }
  }

  const btnProvFaq = document.getElementById('btnProvFaq');
  if(btnProvFaq){
    btnProvFaq.onclick=()=>{
      showLegalPage('faq-provider');
      if(mode === 'provider'){
        pushViewState({view: 'provider-faq', mode: mode}, '/anbieter/hilfe/faq');
      }
    };
  }
  const linkInseratInfo = document.getElementById('linkInseratInfo');
  if(linkInseratInfo){
    linkInseratInfo.onclick=function(e){ e.preventDefault(); if(typeof hapticLight === 'function') hapticLight(); showLegalPage('inserat-info-provider'); };
  }

  const btnBilling = document.getElementById('btnBilling');
  if(btnBilling){
    btnBilling.onclick=()=>{
      if(!checkSessionValidity()) return;
      showView(views.providerBilling);
      renderBilling();
      // Browser-Verlauf aktualisieren
      pushViewState({view: 'provider-billing', mode: mode}, location.pathname);
    };
  }
  const btnBillingBack = document.getElementById('btnBillingBack');
  if(btnBillingBack){
    btnBillingBack.onclick=()=> showProviderProfile();
  }

  const rowProfileOverview = document.getElementById('rowProfileOverview');
  if(rowProfileOverview){
    rowProfileOverview.onclick=()=>{
      // Profilübersicht: Navigiere zu Profil-Seite
      showProviderProfile();
      window.scrollTo({top: 0, behavior: 'smooth'});
    };
  }
  
  // Profil bearbeiten Button (neu im "Mein Profil" Abschnitt)
  const btnProfileEdit = document.getElementById('btnProfileEdit');
  if(btnProfileEdit){
    btnProfileEdit.onclick=()=>{
      startWizard('provider');
    };
  }

  const btnProvShareOffer = document.getElementById('btnProvShareOffer');
  if(btnProvShareOffer){
    btnProvShareOffer.onclick=()=>{
      const first = offers.find(o=>o.providerId===providerId());
      if(first) {
        try {
          shareOffer(first);
        } catch(err) {
          console.error('Share error:', err);
          showToast('Teilen kommt als nächstes.');
        }
      } else {
        showToast('Noch keine Inserate zum Teilen.');
      }
    };
  }
  const btnProvWeekPdf = document.getElementById('btnProvWeekPdf');
  if(btnProvWeekPdf){
    btnProvWeekPdf.onclick=()=> printWeekCard();
  }
  // Provider Support (nur im Anbieter-Dashboard, support@mittagio.de)
  const btnProvSupport = document.getElementById('btnProvSupport');
  if(btnProvSupport){
    btnProvSupport.onclick=()=>{
      window.location.href = 'mailto:support@mittagio.de';
    };
  }

  // Legal Pages Navigation (statische Seiten)
  function showLegalPage(page){
    // Separate Impressen und AGBs für Kunden und Anbieter
    const isProvider = mode === 'provider';
    const pageMap = {
      'impressum': isProvider ? 'v-legal-impressum-provider' : 'v-legal-impressum',
      'agb-kurz': isProvider ? 'v-legal-agb-provider' : 'v-legal-agb-kurz',
      'agb-provider': 'v-legal-agb-provider',
      'impressum-provider': 'v-legal-impressum-provider',
      'datenschutz': isProvider ? 'v-legal-datenschutz-provider' : 'v-legal-datenschutz',
      'datenschutz-provider': 'v-legal-datenschutz-provider',
      'faq': 'v-legal-faq',
      'support': 'v-support',
      'faq-provider': 'v-legal-faq-provider',
      'inserat-info-provider': 'v-legal-inserat-info-provider'
    };
    const viewId = pageMap[page];
    if(viewId){
      showView(viewId);
      window.scrollTo({top:0, behavior:'smooth'});
      // Wenn FAQ, auf Anbieter-Tab wechseln wenn Provider-Modus
      if(viewId === 'v-legal-faq' && isProvider){
        setTimeout(() => switchFaqTab('provider'), 100);
      }
      // URL aktualisieren für Provider-Mode
      if(isProvider){
        const urlMap = {
          'faq-provider': '/anbieter/hilfe/faq',
          'inserat-info-provider': '/anbieter/hilfe/inserat',
          'impressum-provider': '/anbieter/recht/impressum',
          'agb-provider': '/anbieter/recht/agb',
          'datenschutz': '/anbieter/recht/datenschutz',
          'datenschutz-provider': '/anbieter/recht/datenschutz'
        };
        const url = urlMap[page];
        if(url){
          pushViewState({view: `provider-${page}`, mode: mode}, url);
        }
      }
    }
  }
  
  // FAQ-Tab wechseln
  function switchFaqTab(tab){
    const customerTab = document.getElementById('faqTabCustomer');
    const providerTab = document.getElementById('faqTabProvider');
    const customerContent = document.getElementById('faqContentCustomer');
    const providerContent = document.getElementById('faqContentProvider');
    
    if(tab === 'customer'){
      if(customerTab){
        customerTab.style.background = '#fff';
        customerTab.style.borderBottom = '3px solid #FFD700';
        customerTab.style.fontWeight = '700';
        customerTab.style.color = '#334155';
      }
      if(providerTab){
        providerTab.style.background = '#f9f9f9';
        providerTab.style.borderBottom = '3px solid transparent';
        providerTab.style.fontWeight = '600';
        providerTab.style.color = '#666';
      }
      if(customerContent) customerContent.style.display = 'block';
      if(providerContent) providerContent.style.display = 'none';
    } else {
      if(providerTab){
        providerTab.style.background = '#fff';
        providerTab.style.borderBottom = '3px solid #FFD700';
        providerTab.style.fontWeight = '700';
        providerTab.style.color = '#334155';
      }
      if(customerTab){
        customerTab.style.background = '#f9f9f9';
        customerTab.style.borderBottom = '3px solid transparent';
        customerTab.style.fontWeight = '600';
        customerTab.style.color = '#666';
      }
      if(providerContent) providerContent.style.display = 'block';
      if(customerContent) customerContent.style.display = 'none';
    }
  }
  
  function goBackFromLegalPage(){
    // Zurück zur Profil-Seite (Kunde oder Anbieter)
    if(mode === 'provider'){
      showProviderProfile();
    } else {
      showProfile();
    }
  }

  // Provider Legal Links - öffnen statische Seiten
  const btnLegalImprint = document.getElementById('btnLegalImprint');
  if(btnLegalImprint){
    btnLegalImprint.onclick=()=>{
      showLegalPage('impressum');
    };
  }
  const btnLegalPrivacy = document.getElementById('btnLegalPrivacy');
  if(btnLegalPrivacy){
    btnLegalPrivacy.onclick=()=>{
      showLegalPage('datenschutz');
    };
  }
  const btnLegalTerms = document.getElementById('btnLegalTerms');
  if(btnLegalTerms){
    btnLegalTerms.onclick=()=>{
      showLegalPage('agb-kurz');
    };
  }
  
  // Provider-Profil: AGB | Datenschutz | Impressum sind im Footer per onclick gebunden (showLegalPage 'agb-provider', 'datenschutz-provider', 'impressum-provider').
  
  // Support-Kontakt öffnen (von Vertrauens-Segment)
  // Funktion ist bereits oben definiert: openSupportContact()
  // Wird automatisch von onclick="openSupportContact()" im HTML aufgerufen

  // Provider actions (Create Flow Sheet)
  // btnNewListing und btnFromCookbook werden nicht mehr verwendet
  const btnNewListing = document.getElementById('btnNewListing');
  if(btnNewListing) btnNewListing.style.display = 'none';
  const btnFromCookbook = document.getElementById('btnFromCookbook');
  if(btnFromCookbook) btnFromCookbook.style.display = 'none';
  
  // Kochbuch: "+ Gericht hinzufügen" öffnet IMMER Unified Flow
  const btnCookbookAdd = document.getElementById('btnCookbookAdd');
  if(btnCookbookAdd) btnCookbookAdd.onclick=()=> openDishFlow(null, 'cookbook');
  const btnCookbookAddSticky = document.getElementById('btnCookbookAddSticky');
  if(btnCookbookAddSticky) btnCookbookAddSticky.onclick=()=> openDishFlow(null, 'cookbook');

  // Kochbuch Action-Sheet: Bearbeiten (gelb oben), In den Wochenplan, Speichern, Teilen, Drucken, Jetzt inserieren (blau Abschluss), Löschen
  const cookbookActionEdit = document.getElementById('cookbookActionEdit');
  const cookbookActionWeek = document.getElementById('cookbookActionWeek');
  const cookbookActionSave = document.getElementById('cookbookActionSave');
  const cookbookActionShare = document.getElementById('cookbookActionShare');
  const cookbookActionPrint = document.getElementById('cookbookActionPrint');
  const cookbookActionLive = document.getElementById('cookbookActionLive');
  const cookbookActionDelete = document.getElementById('cookbookActionDelete');
  if(cookbookActionEdit) cookbookActionEdit.onclick=()=>{
    const ent = window._cookbookActionEntry;
    if(ent){ if(typeof haptic==='function') haptic(6); closeCookbookActionSheet(); startWizard('cookbook', {editId: ent.id}); }
  };
  if(cookbookActionWeek) cookbookActionWeek.onclick=()=>{
    const ent = window._cookbookActionEntry;
    if(ent){ if(typeof haptic==='function') haptic(6); selectedCookbookId = ent.id; closeCookbookActionSheet(); if(typeof openCookbookWeekSheet === 'function') openCookbookWeekSheet(); }
  };
  if(cookbookActionSave) cookbookActionSave.onclick=()=>{
    const ent = window._cookbookActionEntry;
    if(ent){ if(typeof haptic==='function') haptic(6); save(LS.cookbook, cookbook); closeCookbookActionSheet(); if(typeof showToast==='function') showToast('Gespeichert'); renderCookbook(); }
  };
  if(cookbookActionShare) cookbookActionShare.onclick=()=>{
    const ent = window._cookbookActionEntry;
    if(!ent) return;
    if(typeof haptic==='function') haptic(6);
    var shareUrl = (typeof getProviderShareUrl === 'function' ? getProviderShareUrl() : '') || (window.location.origin + (window.location.pathname || '') + (window.location.hash || ''));
    var providerName = (typeof provider !== 'undefined' && provider && provider.profile && provider.profile.businessName) ? provider.profile.businessName : 'Mittagio';
    var shareText = '🚀 Hunger? ' + (ent.dish || 'Gericht') + ' – ' + (typeof euro === 'function' ? euro(ent.price || 0) : (ent.price || '') + ' €') + '\n\n📍 ' + providerName + '\n\nJetzt Schlange überspringen & Abholnummer sichern:\n👉 ' + shareUrl + '\n\n#mittagio';
    if(typeof openShareSheet === 'function') openShareSheet(ent.dish || 'Gericht', shareText, shareUrl, 'Gericht teilen');
    else if(navigator.share) navigator.share({ title: ent.dish || 'Gericht', text: shareText, url: shareUrl }).then(function(){ if(typeof showToast === 'function') showToast('Geteilt!'); }).catch(function(){});
    else { try{ navigator.clipboard.writeText(shareUrl); if(typeof showToast === 'function') showToast('Link kopiert'); } catch(e){} }
    closeCookbookActionSheet();
  };
  if(cookbookActionPrint) cookbookActionPrint.onclick=()=>{
    const ent = window._cookbookActionEntry;
    if(ent && typeof printCookbookEntry === 'function'){ if(typeof haptic==='function') haptic(6); printCookbookEntry(ent); }
    closeCookbookActionSheet();
  };
  if(cookbookActionLive) cookbookActionLive.onclick=()=>{
    const ent = window._cookbookActionEntry;
    if(ent){ try{ if(navigator.vibrate) navigator.vibrate([10, 30, 10]); } catch(e){} closeCookbookActionSheet(); selectedCookbookId = ent.id; if(typeof openCookbookLiveSheet === 'function') openCookbookLiveSheet(); }
  };
  if(cookbookActionDelete) cookbookActionDelete.onclick=()=>{
    const ent = window._cookbookActionEntry;
    if(!ent) return;
    if(confirm(`"${ent.dish}" wirklich löschen?`)){
      const idx = cookbook.findIndex(c => String(c.id) === String(ent.id));
      if(idx >= 0){ cookbook.splice(idx, 1); save(LS.cookbook, cookbook); renderCookbook(); showToast('Gericht gelöscht'); }
    }
    closeCookbookActionSheet();
  };

  const btnOpenWeekPlan = document.getElementById('btnOpenWeekPlan');
  if(btnOpenWeekPlan) btnOpenWeekPlan.style.display = 'none';
  const btnPickupsFaq = document.getElementById('btnPickupsFaq');
  if(btnPickupsFaq){
    btnPickupsFaq.onclick=()=>{
      showProviderProfile();
      const box = document.getElementById('provFaqBox');
      if(box) box.style.display = 'block';
    };
  }

  // No-Limits: Toggle-Funktion für "Ausverkauft" / "Noch da" (im Psheet per Long-Press auf Karte)
  function toggleOfferSoldOut(offerId){
    const idx = offers.findIndex(x=>x.id===offerId);
    if(idx<0) return;
    const wasActive = offers[idx].active !== false;
    offers[idx].active = !wasActive;
    save(LS.offers, offers);
    showToast(wasActive ? 'Als ausverkauft markiert' : 'Wieder verfügbar', 2000);
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
  }

  const btnPsheetFertig = document.getElementById('btnPsheetFertig');
  if(btnPsheetFertig) btnPsheetFertig.onclick = closeProviderSheet;

  const btnPsheetLegendClose = document.getElementById('btnPsheetLegendClose');
  if(btnPsheetLegendClose){
    btnPsheetLegendClose.onclick = function(){
      var pop = document.getElementById('psheetLegendPopover');
      if(pop) pop.style.display = 'none';
    };
  }
  const btnPsheetPrintFromLegend = document.getElementById('btnPsheetPrintFromLegend');
  if(btnPsheetPrintFromLegend){
    btnPsheetPrintFromLegend.onclick = function(){
      if(!activeProviderOfferId) return;
      var o = offers.find(x=>x.id===activeProviderOfferId);
      if(o) printOffer(o);
      var pop = document.getElementById('psheetLegendPopover');
      if(pop) pop.style.display = 'none';
    };
  }
  document.getElementById('psheetLegendPopover') && document.getElementById('psheetLegendPopover').addEventListener('click', function(e){
    if(e.target === this){ this.style.display = 'none'; }
  });

  const btnWeekBack = document.getElementById('btnWeekBack');
  if(btnWeekBack){
    btnWeekBack.onclick=()=> showProviderHome();
  }
  const btnWeekRefresh = document.getElementById('btnWeekRefresh');
  if(btnWeekRefresh){
    btnWeekRefresh.onclick=()=>{ renderWeekPlan(); if(typeof showToast === 'function') showToast('Aktualisiert'); };
  }
  const btnWeekRefreshZone = document.getElementById('btnWeekRefreshZone');
  if(btnWeekRefreshZone){
    btnWeekRefreshZone.onclick=()=>{ renderWeekPlan(); if(typeof showToast === 'function') showToast('Aktualisiert'); };
  }
  const btnWeekPdf = document.getElementById('btnWeekPdf');
  if(btnWeekPdf){
    btnWeekPdf.onclick=()=>{
      printWeekCard();
    };
  }
  
  // Wochenplan teilen
  const btnWeekShare = document.getElementById('btnWeekShare');
  if(btnWeekShare){
    btnWeekShare.onclick=()=>{
      shareWeekPlan();
    };
  }
  
  // Wochenplan teilen – Magic Link: #/plan/[Anbieter-ID], Snapshot für Kunden-Ansicht, Web Share API
  var PUBLIC_PLAN_KEY = 'public_plan_';
  function shareWeekPlan(){
    const profile = normalizeProviderProfile(provider.profile || {});
    const providerName = profile.name || provider.email || 'Anbieter';
    const pid = providerId();
    const hasAbholnummer = !!profile.abholnummerEnabledByDefault;
    const logoUrl = (profile.logoData || '').trim() || (provider.logoData || '');
    const firstDishImage = (function(){
      for(let i=0;i<7;i++){
        const d = new Date(); d.setDate(d.getDate()+i);
        const key = isoDate(d);
        const live = (offers||[]).filter(o => o.providerId === pid && o.day === key && o.active !== false);
        const o = live[0];
        if(o && (o.photoData || o.imageUrl)) return o.photoData || o.imageUrl;
      }
      return (cookbook||[]).find(c => c.providerId === pid && (c.photoData || c.img))?.photoData || (cookbook||[]).find(c => c.providerId === pid)?.photoData || 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=400&q=80';
    })();
    var weekOffers = [];
    for(let i=0;i<7;i++){
      const d = new Date(); d.setDate(d.getDate()+i);
      const key = isoDate(d);
      (offers||[]).filter(o => o.providerId === pid && o.day === key && o.active !== false).forEach(o => {
        weekOffers.push({ day: fmtDay(new Date(key)), dayKey: key, dish: o.dish || o.title || 'Gericht', price: o.price || 0, imageUrl: o.photoData || o.imageUrl || firstDishImage, vorOrt: o.dineInPossible !== false, abholnummer: !!o.hasPickupCode, mehrweg: !!(profile.reuse && profile.reuse.enabled) });
      });
    }
    if(weekOffers.length === 0){
      showToast('Keine aktivierten Gerichte zum Teilen – zuerst für 4,99 € live schalten.');
      return;
    }
    var snapshot = { providerId: pid, providerName, logoUrl, firstDishImage, offers: weekOffers, updatedAt: Date.now() };
    try { localStorage.setItem(PUBLIC_PLAN_KEY + pid, JSON.stringify(snapshot)); } catch(e) {}
    var shareUrl = location.origin + location.pathname.replace(/\/$/, '') + '#/plan/' + encodeURIComponent(pid);
    var shareTitle = 'Unser Wochenplan ist online!';
    var weekMsg = typeof generateWhatsAppShareMessage === 'function' ? generateWhatsAppShareMessage('week') : null;
    if(weekMsg){ openSharePreviewModal(weekMsg); return; }
    var shareText = hasAbholnummer
      ? `📅 Hunger für die ganze Woche geplant? Schau dir unseren neuen Wochenplan an!\n\n📍 ${providerName}\n\n${weekOffers.slice(0, 5).map(o => `🍴 ${o.day}: ${o.dish} - ${euro(o.price)}`).join('\n')}${weekOffers.length > 5 ? `\n... und ${weekOffers.length - 5} weitere Leckereien!` : ''}\n\nJetzt für die Mittagsbox planen & Schlange überspringen:\n👉 ${shareUrl}\n\n#mittagio #wochenplan #mittagspause #lecker`
      : `📅 Hunger für die ganze Woche geplant? Schau dir unseren neuen Wochenplan an!\n\n📍 ${providerName}\n\n${weekOffers.slice(0, 5).map(o => `🍴 ${o.day}: ${o.dish} - ${euro(o.price)}`).join('\n')}${weekOffers.length > 5 ? `\n... und ${weekOffers.length - 5} weitere Leckereien!` : ''}\n\nJetzt online entdecken & entspannt genießen:\n👉 ${shareUrl}\n\n#mittagio #wochenplan #mittagspause #lecker`;
    if(navigator.share){
      navigator.share({ title: shareTitle, text: shareText, url: shareUrl }).then(() => { showToast('Wochenplan geteilt!'); }).catch((err) => {
        if(err.name !== 'AbortError'){ if(typeof copyToClipboard === 'function') copyToClipboard(shareText); showToast('Link kopiert!'); }
      });
    } else {
      if(typeof copyToClipboard === 'function') copyToClipboard(shareText);
      showToast('Link kopiert!');
    }
  }

  function showPlanPublicView(providerId){
    var el = document.getElementById('v-plan-public');
    var list = document.getElementById('planPublicList');
    var nameEl = document.getElementById('planPublicName');
    var logoEl = document.getElementById('planPublicLogo');
    var backEl = document.getElementById('planPublicBack');
    if(!el || !list) return;
    document.querySelectorAll('.view').forEach(v => { v.classList.remove('active'); v.style.setProperty('display', 'none', 'important'); });
    document.getElementById('customerNav') && (document.getElementById('customerNav').style.display = 'none');
    document.getElementById('providerNavWrap') && (document.getElementById('providerNavWrap').style.display = 'none');
    document.body.classList.remove('provider-mode');
    var raw = null;
    try { raw = localStorage.getItem(PUBLIC_PLAN_KEY + providerId); } catch(e) {}
    var data = raw ? (function(){ try { return JSON.parse(raw); } catch(e) { return null; } })() : null;
    if(!data || !data.offers || data.offers.length === 0){
      list.innerHTML = '<div style="text-align:center; padding:48px 24px;"><p style="font-size:16px; font-weight:700; color:#1a1a1a; margin-bottom:8px;">Wochenplan nicht verfügbar</p><p style="font-size:14px; color:#64748b;">Der Link ist abgelaufen oder der Anbieter hat den Plan noch nicht geteilt.</p><a href="#" onclick="location.hash=\'\'; if(typeof showDiscover===\'function\') showDiscover(); return false;" style="display:inline-block; margin-top:20px; font-size:15px; font-weight:700; color:var(--brand);">Zur App</a></div>';
      if(nameEl) nameEl.textContent = 'Wochenplan';
      if(logoEl) logoEl.style.backgroundImage = '';
    } else {
      if(nameEl) nameEl.textContent = data.providerName || 'Wochenplan';
      if(logoEl){ logoEl.style.backgroundImage = data.logoUrl ? 'url(' + data.logoUrl + ')' : ''; logoEl.style.backgroundColor = data.logoUrl ? 'transparent' : '#f1f3f5'; }
      function euro(n){ return (Number(n)||0).toFixed(2).replace('.',',') + ' €'; }
      var html = '';
      data.offers.forEach(function(o){
        var img = o.imageUrl || data.firstDishImage || '';
        var threePillars = '<div class="plan-public-pillars" style="display:flex; justify-content:center; gap:16px; padding:8px 0 12px; border-bottom:1px solid rgba(0,0,0,0.06); font-size:14px;"><span title="Vor Ort möglich">🍴</span><span title="Abholnummer aktiv">🧾</span><span title="Mehrweg verfügbar">🔄</span></div>';
        html += '<div class="plan-public-card" style="background:#fff; border-radius:20px; overflow:hidden; margin-bottom:16px; border:1px solid #e2e8f0; box-shadow:0 2px 12px rgba(0,0,0,0.04);"><div style="height:140px; background:#f1f3f5;"><img src="' + (img || '').replace(/"/g,'&quot;') + '" alt="" style="width:100%; height:100%; object-fit:cover;" onerror="this.style.display=\'none\'"></div>' + threePillars + '<div style="padding:14px 18px;"><div style="font-size:18px; font-weight:900; color:#1a1a1a;">' + (o.dish || 'Gericht').replace(/</g,'&lt;') + '</div><div style="font-size:14px; color:#64748b; margin-top:4px;">' + (o.day || '') + '</div><div style="font-size:16px; font-weight:800; color:#1a1a1a; margin-top:8px;">' + euro(o.price) + '</div></div></div>';
      });
      list.innerHTML = html;
    }
    if(backEl) backEl.onclick = function(e){ e.preventDefault(); location.hash = ''; if(typeof setMode === 'function') setMode('customer'); if(typeof showDiscover === 'function') showDiscover(); };
    el.style.display = 'block';
    el.classList.add('active');
  }

  function hidePlanPublicView(){
    var el = document.getElementById('v-plan-public');
    if(el){ el.style.display = 'none'; el.classList.remove('active'); }
  }

  // WhatsApp-Share-Vorschau: Message für Heute oder Woche generieren (mit *fett* für WhatsApp)
  function generateWhatsAppShareMessage(type){
    const profile = normalizeProviderProfile(provider.profile || {});
    const providerName = profile.name || provider.email || 'Anbieter';
    const pid = providerId();
    const shareUrlToday = (location.origin + (location.pathname || '').replace(/\/$/, '')) + '#provider/' + pid + '/today';
    const shareUrlWeek = (location.origin + (location.pathname || '').replace(/\/$/, '')) + '#/plan/' + encodeURIComponent(pid);
    const hasMehrweg = !!(profile.reuse && profile.reuse.enabled);

    if(type === 'today'){
      const todayKey = isoDate(new Date());
      const mineToday = (offers || []).filter(function(o){ return o.providerId === pid && o.day === todayKey && o.active !== false; });
      if(mineToday.length === 0) return null;
      const hasAbholnummer = !!profile.abholnummerEnabledByDefault || mineToday.some(function(o){ return o.hasPickupCode; });
      const todayOrders = typeof loadOrders === 'function' ? loadOrders() : [];
      const todayOfferIds = mineToday.map(function(o){ return o.id; });
      const firstPaidCode = todayOrders.filter(function(ord){ return ord.status === 'PAID' && ord.pickupCode && todayOfferIds.indexOf(ord.dishId) !== -1; })[0];
      const abholnummerStr = hasAbholnummer ? (firstPaidCode ? ('#' + (firstPaidCode.pickupCode || '')) : 'verfügbar') : '–';
      const dishesBlock = mineToday.map(function(o){ return '🥘 *' + (o.dish || o.title || 'Gericht').replace(/\*/g,'') + '* — ' + (typeof euro === 'function' ? euro(o.price || 0) : (Number(o.price)||0).toFixed(2).replace('.',',') + ' €'); }).join('\n');
      let msg = '🔪 *Frisch aus unserer Küche für heute!* 👨‍🍳\n\n' + dishesBlock + '\n\n*Service:*\n🍴 Vor Ort genießen\n🧾 Abholnummer: *' + abholnummerStr + '*\n';
      if(hasMehrweg) msg += '🔄 Mehrweg verfügbar\n';
      msg += '\nGuten Appetit! 📍\n' + shareUrlToday;
      return msg;
    }

    if(type === 'week'){
      const dayShort = ['So','Mo','Di','Mi','Do','Fr','Sa'];
      var weekOffers = [];
      for(var i = 0; i < 7; i++){
        var d = new Date(); d.setDate(d.getDate() + i);
        var key = isoDate(d);
        var dayName = dayShort[d.getDay()];
        var live = (offers || []).filter(function(o){ return o.providerId === pid && o.day === key && o.active !== false; });
        var dishStr = live.length ? live.map(function(o){ return o.dish || o.title || 'Gericht'; }).join(', ') : '–';
        weekOffers.push({ day: dayName, dish: dishStr });
      }
      var weekBlock = weekOffers.map(function(o){ return '🗓 ' + o.day + ': ' + o.dish; }).join('\n');
      var msg = '📅 *Dein Genuss-Plan für diese Woche!* 🥘\n\n' + weekBlock + '\n\n📲 Nutze die Abholnummer für schnellen Service! 🧾\n';
      if(hasMehrweg) msg += '🔄 Mehrweg-System aktiv.\n';
      msg += '\n' + shareUrlWeek;
      return msg;
    }
    return null;
  }

  var _sharePreviewCurrentMessage = '';
  function openSharePreviewModal(message){
    _sharePreviewCurrentMessage = message || '';
    var bd = document.getElementById('sharePreviewBd');
    var textEl = document.getElementById('sharePreviewText');
    if(!bd || !textEl) return;
    textEl.textContent = message;
    bd.style.display = 'flex';
    bd.style.alignItems = 'center';
    bd.style.justifyContent = 'center';
  }
  function closeSharePreviewModal(){
    var bd = document.getElementById('sharePreviewBd');
    if(bd) bd.style.display = 'none';
    _sharePreviewCurrentMessage = '';
  }
  function sharePreviewSendWhatsApp(){
    if(_sharePreviewCurrentMessage){
      window.open('whatsapp://send?text=' + encodeURIComponent(_sharePreviewCurrentMessage));
      closeSharePreviewModal();
      if(typeof showToast === 'function') showToast('WhatsApp geöffnet – Nachricht einfügen & senden!');
    }
  }

  // Tagesessen teilen: öffnet Share-Preview-Modal mit WhatsApp-Text
  function shareTodayOffers(){
    var msg = generateWhatsAppShareMessage('today');
    if(!msg){ showToast('Keine Gerichte für heute'); return; }
    openSharePreviewModal(msg);
  }
  // Fallback: direkter Share (wenn gewünscht)
  function shareTodayOffersDirect(){
    const todayKey = isoDate(new Date());
    const profile = normalizeProviderProfile(provider.profile || {});
    const providerName = profile.name || provider.email || 'Anbieter';
    const mineToday = offers.filter(o => o.providerId === providerId() && o.day === todayKey && o.active !== false);
    const hasAbholnummer = !!profile.abholnummerEnabledByDefault || mineToday.some(o => o.hasPickupCode);
    if(mineToday.length === 0){ showToast('Keine Gerichte für heute'); return; }
    const shareUrl = `${location.origin}${location.pathname}#provider/${providerId()}/today`;
    let shareText = `🚀 Hunger? Schau mal, was wir heute Leckeres für dich haben!\n\n📍 ${providerName}\n\n${mineToday.map(o => `🍴 ${o.dish || o.title || 'Gericht'} - ${euro(o.price || 0)}`).join('\n')}\n\nJetzt Schlange überspringen & Abholnummer sichern:\n👉 ${shareUrl}\n\n#mittagio #lunch #heutebeius`;
    if(!hasAbholnummer) shareText = `🚀 Hunger? Schau mal, was wir heute Leckeres für dich haben!\n\n📍 ${providerName}\n\n${mineToday.map(o => `🍴 ${o.dish || o.title || 'Gericht'} - ${euro(o.price || 0)}`).join('\n')}\n\nJetzt online entdecken & vorbeikommen:\n👉 ${shareUrl}\n\n#mittagio #lunch #heutebeius`;
    if(navigator.share){ navigator.share({ title: `Heute bei ${providerName}`, text: shareText, url: shareUrl }).then(() => showToast('Tagesessen geteilt!')).catch((err) => { if(err.name !== 'AbortError'){ copyToClipboard(shareText); showToast('Link kopiert!'); } }); } else { copyToClipboard(shareText); showToast('Link kopiert!'); }
  }

  // Provider ID (for demo)
  function providerId(){
    // stable per email
    const e = provider.email || 'provider';
    return 'prov_' + btoa(unescape(encodeURIComponent(e))).slice(0,16);
  }

  // --- Cookbook ---
  function openCookbookActionSheet(entry){
    if(!entry) return;
    window._cookbookActionEntry = entry;
    if(entry.id) selectedCookbookId = entry.id;
    const titleEl = document.getElementById('cookbookActionSheetTitle');
    if(titleEl) titleEl.textContent = entry.dish || 'Gericht';
    const bd = document.getElementById('cookbookActionSheetBd');
    const sheet = document.getElementById('cookbookActionSheet');
    if(bd){ bd.style.display = 'block'; bd.classList.add('active'); }
    if(sheet) sheet.style.display = 'block';
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }
  function closeCookbookActionSheet(){
    window._cookbookActionEntry = null;
    const bd = document.getElementById('cookbookActionSheetBd');
    const sheet = document.getElementById('cookbookActionSheet');
    if(bd){ bd.style.display = 'none'; bd.classList.remove('active'); }
    if(sheet) sheet.style.display = 'none';
  }

  function attachCookbookMagazineSwipe(cardEl, listLen){
    if(!cardEl || listLen <= 1) return;
    var startX = 0, startY = 0, deltaX = 0, deltaY = 0, SWIPE_THRESHOLD = 45, HORIZONTAL_LOCK = 12, mouseActive = false;
    function getX(e){ if(e.touches && e.touches[0]) return e.touches[0].clientX; if(e.changedTouches && e.changedTouches[0]) return e.changedTouches[0].clientX; return e.clientX || 0; }
    function getY(e){ if(e.touches && e.touches[0]) return e.touches[0].clientY; if(e.changedTouches && e.changedTouches[0]) return e.changedTouches[0].clientY; return e.clientY || 0; }
    function onStart(e){
      startX = getX(e); startY = getY(e); deltaX = 0; deltaY = 0; window._cookbookSwipeHandled = false;
    }
    function onMove(e){
      var x = getX(e), y = getY(e);
      deltaX = x - startX; deltaY = y - startY;
      if(Math.abs(deltaX) > HORIZONTAL_LOCK && Math.abs(deltaX) >= Math.abs(deltaY) && e.cancelable){ e.preventDefault(); }
    }
    function onEnd(e){
      if(!e) return;
      if(e.target && e.target.closest && e.target.closest('.cookbook-magazine-nav')) return;
      var absX = Math.abs(deltaX), absY = Math.abs(deltaY);
      if(absX >= SWIPE_THRESHOLD && absX > absY){
        window._cookbookSwipeHandled = true;
        if(e.cancelable) e.preventDefault();
        e.stopPropagation();
        if(deltaX < 0 && cookbookMagazineIndex < listLen - 1){ if(typeof haptic==='function') haptic(10); cookbookMagazineIndex++; renderCookbook(); }
        else if(deltaX > 0 && cookbookMagazineIndex > 0){ if(typeof haptic==='function') haptic(10); cookbookMagazineIndex--; renderCookbook(); }
      }
    }
    function onMouseUp(e){
      if(!mouseActive) return;
      mouseActive = false;
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
      onEnd(e);
    }
    function onMouseMove(e){ deltaX = e.clientX - startX; deltaY = e.clientY - startY; }
    cardEl.addEventListener('touchstart', onStart, { passive: true });
    cardEl.addEventListener('touchmove', onMove, { passive: false });
    cardEl.addEventListener('touchend', onEnd, { passive: false, capture: true });
    cardEl.addEventListener('mousedown', function(e){
      if(e.target.closest && e.target.closest('.cookbook-magazine-nav')) return;
      startX = e.clientX; startY = e.clientY; deltaX = 0; deltaY = 0; window._cookbookSwipeHandled = false;
      mouseActive = true;
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    });
  }

  /** Gesamtumsatz für ein Kochbuch-Gericht (aus Orders: gleicher Provider + gleicher Gerichtsname). */
  function getCookbookEntryRevenue(entry){
    var orders = typeof loadOrders === 'function' ? loadOrders() : [];
    var pid = typeof providerId === 'function' ? providerId() : '';
    var dishName = String(entry.dish || '').trim();
    var totalCents = 0;
    orders.forEach(function(ord){
      if(ord.status !== 'PAID' && ord.status !== 'PICKED_UP' && ord.status !== 'COMPLETED') return;
      if(String(ord.providerId) !== String(pid)) return;
      if(String(ord.providerId) !== String(pid)) return;
      var nameMatch = ord.dishName && String(ord.dishName).trim() === dishName;
      if(!nameMatch && typeof offers !== 'undefined' && offers && ord.dishId){ var o = offers.find(function(x){ return x.id === ord.dishId; }); nameMatch = o && String((o.dish||'').trim()) === dishName; }
      if(nameMatch) totalCents += (ord.total || 0);
    });
    return totalCents / 100;
  }

  /** Anzahl Bestellungen für ein Kochbuch-Gericht (für „Meistverkauft“ / Menge Stk.). */
  function getCookbookEntryOrderCount(entry){
    var orders = typeof loadOrders === 'function' ? loadOrders() : [];
    var pid = typeof providerId === 'function' ? providerId() : '';
    var dishName = String(entry.dish || '').trim();
    var count = 0;
    orders.forEach(function(ord){
      if(ord.status !== 'PAID' && ord.status !== 'PICKED_UP' && ord.status !== 'COMPLETED') return;
      if(String(ord.providerId) !== String(pid)) return;
      var nameMatch = ord.dishName && String(ord.dishName).trim() === dishName;
      if(!nameMatch && typeof offers !== 'undefined' && offers && ord.dishId){ var o = offers.find(function(x){ return x.id === ord.dishId; }); nameMatch = o && String((o.dish||'').trim()) === dishName; }
      if(nameMatch) count += 1;
    });
    return count;
  }

  function renderCookbook(){
    const box = document.getElementById('cookbookList');
    const magazineEl = document.getElementById('cookbookMagazine');
    const emptyEl = document.getElementById('cookbookEmpty');
    const pillsWrap = document.getElementById('cookbookCategoryPills');
    const scrollWrap = document.getElementById('cookbookScrollWrap');
    if(!pillsWrap) return;

    (function wireCookbookHeader(){
      var titleWrap = document.getElementById('cookbookTitleWrap');
      var searchWrap = document.getElementById('cookbookSearchWrap');
      var searchInput = document.getElementById('cookbookSearchInput');
      var btnSearch = document.getElementById('cookbookBtnSearch');
      var btnSort = document.getElementById('cookbookBtnSort');
      var sortDropdown = document.getElementById('cookbookSortDropdown');
      if(titleWrap) titleWrap.style.display = cookbookIsSearching ? 'none' : 'flex';
      if(searchWrap) searchWrap.style.display = cookbookIsSearching ? 'flex' : 'none';
      if(searchInput) searchInput.value = cookbookSearchTerm;
      if(btnSort){
        btnSort.style.background = cookbookShowSortMenu ? '#007AFF' : '#F5F5F7';
        btnSort.style.color = cookbookShowSortMenu ? '#fff' : '';
        btnSort.onclick = function(e){ e.stopPropagation(); if(typeof haptic==='function') haptic(6); cookbookShowSortMenu = !cookbookShowSortMenu; renderCookbook(); if(cookbookShowSortMenu) setTimeout(function(){ document.addEventListener('click', function closeSort(){ cookbookShowSortMenu = false; document.removeEventListener('click', closeSort); renderCookbook(); }); }, 0); };
      }
      if(sortDropdown){
        sortDropdown.style.display = cookbookShowSortMenu ? 'block' : 'none';
        var opts = [{ id: 'date', label: 'Neueste zuerst' }, { id: 'quantity', label: 'Meistverkauft' }, { id: 'price', label: 'Höchster Preis' }, { id: 'name', label: 'Alphabetisch' }];
        sortDropdown.innerHTML = opts.map(function(opt){
          var active = cookbookSortBy === opt.id;
          return '<button type="button" class="cookbook-sort-opt' + (active ? ' active' : '') + '" data-sort="' + opt.id + '" style="width:100%; text-align:left; padding:12px 14px; border:none; border-radius:12px; font-size:14px; font-weight:700; cursor:pointer; background:' + (active ? 'rgba(0,122,255,0.1)' : 'transparent') + '; color:' + (active ? '#007AFF' : '#1a1a1a') + ';">' + opt.label + '</button>';
        }).join('');
        sortDropdown.querySelectorAll('.cookbook-sort-opt').forEach(function(btn){
          btn.onclick = function(e){ e.stopPropagation(); if(typeof haptic==='function') haptic(6); cookbookSortBy = this.getAttribute('data-sort') || 'date'; cookbookShowSortMenu = false; cookbookMagazineIndex = 0; renderCookbook(); };
        });
      }
      if(btnSearch){
        btnSearch.textContent = cookbookIsSearching ? '✕' : '🔍';
        btnSearch.onclick = function(){ if(typeof haptic==='function') haptic(6); cookbookIsSearching = !cookbookIsSearching; if(!cookbookIsSearching) cookbookSearchTerm = ''; renderCookbook(); if(cookbookIsSearching && searchInput) setTimeout(function(){ searchInput.focus(); }, 50); };
      }
      if(searchInput){
        searchInput.oninput = function(){ cookbookSearchTerm = this.value; cookbookMagazineIndex = 0; renderCookbook(); };
        searchInput.onkeydown = function(e){ if(e.key === 'Escape'){ cookbookIsSearching = false; cookbookSearchTerm = ''; renderCookbook(); } };
      }
    })();

    let updated = false;
    cookbook = cookbook.map(entry=>{
      const out = {...entry};
      if(!out.createdAt){ out.createdAt = Date.now(); updated = true; }
      if(out.lastUsed === undefined){ out.lastUsed = null; updated = true; }
      return out;
    });
    if(updated) save(LS.cookbook, cookbook);

    if(pillsWrap){
      pillsWrap.style.display = cookbookIsSearching ? 'none' : 'flex';
      pillsWrap.innerHTML='';
      (COOKBOOK_CATEGORIES||['Alle','Fleisch','Eintopf','Snack','Vegetarisch']).forEach(function(cat){
        var b = document.createElement('button');
        b.type='button';
        b.className='cookbook-cat-pill' + (cookbookCategory===cat?' on':'');
        b.setAttribute('role','tab');
        b.setAttribute('aria-selected', cookbookCategory===cat ? 'true' : 'false');
        b.textContent = cat;
        b.onclick=function(){ if(typeof haptic==='function') haptic(6); cookbookCategory=cat; cookbookMagazineIndex=0; renderCookbook(); };
        pillsWrap.appendChild(b);
      });
    }

    const mine = cookbook.filter(x=>x.providerId===providerId());
    var filtered = mine;
    if(cookbookCategory && cookbookCategory!=='Alle'){
      filtered = mine.filter(function(x){
        var c = (x.category||'').trim();
        if(cookbookCategory==='Fleisch') return c==='Mit Fleisch'||c==='Fleisch';
        return c===cookbookCategory;
      });
    }
    if((cookbookSearchTerm||'').trim()){
      filtered = filtered.filter(function(e){ return (e.dish||'').toLowerCase().indexOf((cookbookSearchTerm||'').trim().toLowerCase()) !== -1; });
    }
    filtered = filtered.slice().sort(function(a,b){
      if(cookbookSortBy === 'date') return (b.lastUsed||b.createdAt||0) - (a.lastUsed||a.createdAt||0);
      if(cookbookSortBy === 'quantity') return (typeof getCookbookEntryOrderCount === 'function' ? getCookbookEntryOrderCount(b) : 0) - (typeof getCookbookEntryOrderCount === 'function' ? getCookbookEntryOrderCount(a) : 0);
      if(cookbookSortBy === 'price') return (Number(b.price)||0) - (Number(a.price)||0);
      if(cookbookSortBy === 'name') return (a.dish||'').localeCompare(b.dish||'', 'de');
      return 0;
    });
    const list = filtered;

    if(cookbookMagazineIndex >= list.length) cookbookMagazineIndex = Math.max(0, list.length - 1);
    selectedCookbookId = list.length ? list[cookbookMagazineIndex].id : null;

    if(!list.length){
      if(mine.length === 0){
        if(emptyEl){ emptyEl.style.display = 'block'; }
        if(magazineEl){ magazineEl.style.display = 'none'; }
        if(box){ box.style.display = 'none'; }
        var btnEmpty = document.getElementById('btnCookbookEmptyAdd');
        if(btnEmpty){
          btnEmpty.onclick = function(e){ e.preventDefault(); e.stopPropagation(); if(typeof openDishFlow === 'function') openDishFlow(null, 'cookbook'); };
        }
      } else {
        if(emptyEl) emptyEl.style.display = 'none';
        if(magazineEl){
          magazineEl.style.display = 'flex';
          magazineEl.innerHTML = '<div class="hint" style="text-align:center; padding:48px 24px; color:#86868B; font-size:15px;">In dieser Kategorie sind noch keine Gerichte.</div>';
        }
        if(box) box.style.display = 'none';
        selectedCookbookId = null;
      }
      if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
      return;
    }

    if(emptyEl) emptyEl.style.display = 'none';
    if(box) box.style.display = 'none';
    if(magazineEl){
      magazineEl.style.display = 'flex';
      if(!magazineEl._cookbookCardDelegation){
        magazineEl._cookbookCardDelegation = true;
        magazineEl.addEventListener('click', function(e){
          var card = e.target && e.target.closest ? e.target.closest('.cookbook-magazine-card') : null;
          if(!card || e.target.closest('.cookbook-magazine-nav')) return;
          var id = card.getAttribute('data-cookbook-entry-id');
          if(!id) return;
          var entry = (typeof cookbook !== 'undefined' && cookbook) ? cookbook.find(function(c){ return String(c.id) === String(id); }) : null;
          if(entry && typeof openCookbookActionSheet === 'function'){ if(typeof haptic === 'function') haptic(6); openCookbookActionSheet(entry); }
        });
        magazineEl.addEventListener('touchend', function(e){
          var card = e.target && e.target.closest ? e.target.closest('.cookbook-magazine-card') : null;
          if(!card || e.target.closest('.cookbook-magazine-nav')) return;
          if(e.cancelable) e.preventDefault();
          var id = card.getAttribute('data-cookbook-entry-id');
          if(!id) return;
          var entry = (typeof cookbook !== 'undefined' && cookbook) ? cookbook.find(function(c){ return String(c.id) === String(id); }) : null;
          if(entry && typeof openCookbookActionSheet === 'function'){ if(typeof haptic === 'function') haptic(6); openCookbookActionSheet(entry); }
        }, { passive: false });
      }
      var entry = list[cookbookMagazineIndex];
      var formatDayLabel = function(iso){
        if(!iso) return 'Neu';
        var d = new Date(iso);
        if(Number.isNaN(d.getTime())) return iso;
        var today = typeof isoDate === 'function' ? isoDate(new Date()) : '';
        var yesterday = typeof isoDate === 'function' ? isoDate(new Date(Date.now()-86400000)) : '';
        if(iso===today) return 'Heute';
        if(iso===yesterday) return 'Gestern';
        return d.toLocaleDateString('de-DE', {day:'2-digit', month:'short'});
      };
      var lastUsedLabel = !entry.lastUsed ? 'Neu' : formatDayLabel(entry.lastUsed);
      var lastPrice = entry.price != null ? (typeof euro === 'function' ? euro(entry.price) : entry.price + ' €') : '–';
      var orderCount = typeof getCookbookEntryOrderCount === 'function' ? getCookbookEntryOrderCount(entry) : 0;
      var qtyStr = orderCount > 0 ? orderCount + ' Portionen' : '–';
      var imgHtml = entry.photoData ? '<img src="'+esc(entry.photoData)+'" alt="" style="width:100%; height:100%; object-fit:cover; transition:transform 0.7s ease;" class="cookbook-magazine-img" />' : '<div style="width:100%; height:100%; background:#e5e7eb; display:flex; align-items:center; justify-content:center;"></div>';
      magazineEl.innerHTML = '<div class="cookbook-magazine-card" role="button" tabindex="0" style="width:88%; max-width:400px; background:#fff; border:1px solid rgba(255,255,255,0.5); border-radius:40px; box-shadow:0 20px 40px rgba(0,0,0,0.12); overflow:hidden; display:flex; flex-direction:column; cursor:pointer; position:relative; z-index:2; touch-action:none;">'+
        '<div class="cookbook-magazine-gloss" style="position:absolute; inset:0; pointer-events:none; z-index:1; background:linear-gradient(to top right, rgba(255,255,255,0.12) 0%, transparent 50%, rgba(255,255,255,0.06) 100%);"></div>'+
        '<div class="cookbook-magazine-img-wrap" style="overflow:hidden; position:relative;">'+
        imgHtml+
        '<div style="position:absolute; bottom:16px; left:16px; background:rgba(255,255,255,0.9); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); padding:8px 16px; border-radius:16px; box-shadow:0 2px 12px rgba(0,0,0,0.06);">'+
        '<p style="margin:0 0 2px; font-size:10px; font-weight:800; color:#1D1D1F; text-transform:uppercase; letter-spacing:-0.02em;">Zuletzt live</p>'+
        '<p style="margin:0; font-size:14px; font-weight:700; color:#1D1D1F;">'+esc(lastUsedLabel)+'</p></div></div>'+
        '<div style="padding:var(--card-padding, 20px); flex:1; display:flex; flex-direction:column; justify-content:space-between; background:#fff;">'+
        '<div><h2 style="margin:0 0 8px; font-size:28px; font-weight:900; color:#1D1D1F; line-height:0.95; letter-spacing:-0.03em;">'+esc(entry.dish||'Gericht')+'</h2>'+
        '<p style="margin:0; font-size:14px; font-weight:500; color:#94a3b8; font-style:italic;">Zuletzt verkauft</p></div>'+
        '<div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">'+
        '<div style="display:flex; flex-direction:column; gap:2px;"><span style="font-size:10px; font-weight:800; color:#d1d5db; text-transform:uppercase;">Menge</span><span style="font-size:18px; font-weight:700; color:#1D1D1F;">'+esc(qtyStr)+'</span></div>'+
        '<span class="price-pill">'+esc(lastPrice)+'</span>'+
        '</div></div></div>'+
        (list.length > 1 ? '<button type="button" class="cookbook-magazine-nav cookbook-magazine-prev" aria-label="Vorheriges" style="position:absolute; left:8px; top:50%; transform:translateY(-50%); width:48px; height:48px; border-radius:50%; border:1px solid rgba(255,255,255,0.6); background:rgba(255,255,255,0.7); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); box-shadow:0 4px 16px rgba(0,0,0,0.1); cursor:pointer; display:flex; align-items:center; justify-content:center; z-index:5;">‹</button>'+
        '<button type="button" class="cookbook-magazine-nav cookbook-magazine-next" aria-label="Nächstes" style="position:absolute; right:8px; top:50%; transform:translateY(-50%); width:48px; height:48px; border-radius:50%; border:1px solid rgba(255,255,255,0.6); background:rgba(255,255,255,0.7); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); box-shadow:0 4px 16px rgba(0,0,0,0.1); cursor:pointer; display:flex; align-items:center; justify-content:center; z-index:5;">›</button>' : '')+
        (list.length > 1 ? '<div class="cookbook-magazine-dots" id="cookbookMagazineDots">'+list.map(function(_, i){ return '<span class="cookbook-dot'+(i===cookbookMagazineIndex?' on':'')+'" aria-hidden="true"></span>'; }).join('')+'</div>' : '')+
        (list.length > 1 && !load(LS.cookbookSwipeHintShown, false) ? '<p class="cookbook-swipe-hint" id="cookbookSwipeHint">Wische zum Wechseln</p>' : '');
      magazineEl.style.position = 'relative';
      magazineEl.style.cursor = 'pointer';
      var openDetail = function(e){
        if(e && e.target && e.target.closest && e.target.closest('.cookbook-magazine-nav')) return;
        if(e && e.cancelable){ e.preventDefault(); e.stopPropagation(); }
        if(typeof haptic==='function') haptic(6);
        if(typeof openCookbookActionSheet==='function') openCookbookActionSheet(entry);
      };
      var cardEl = magazineEl.querySelector('.cookbook-magazine-card');
      if(cardEl){
        cardEl.style.pointerEvents = 'auto';
        cardEl.setAttribute('data-cookbook-entry-id', entry.id || '');
        cardEl.onclick = function(e){ e.stopPropagation(); openDetail(e); };
        cardEl.onkeydown = function(e){ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openDetail(e); } };
        cardEl.addEventListener('touchend', function(e){
          if(window._cookbookSwipeHandled){ window._cookbookSwipeHandled = false; return; }
          if(e.cancelable) e.preventDefault();
          e.stopPropagation();
          openDetail(null);
        }, { passive: false });
        if(list.length > 1) attachCookbookMagazineSwipe(cardEl, list.length);
      }
      magazineEl.onclick = function(e){ if(e.target.closest('.cookbook-magazine-nav')) return; openDetail(e); };
      magazineEl.addEventListener('touchend', function(e){
        if(e.target.closest('.cookbook-magazine-nav')) return;
        if(window._cookbookSwipeHandled){ window._cookbookSwipeHandled = false; return; }
        if(e.target.closest('.cookbook-magazine-card') || e.target === magazineEl){
          if(e.cancelable) e.preventDefault();
          openDetail(e);
        }
      }, { passive: false });
      var prevBtn = magazineEl.querySelector('.cookbook-magazine-prev');
      var nextBtn = magazineEl.querySelector('.cookbook-magazine-next');
      if(prevBtn) prevBtn.onclick = function(e){ e.stopPropagation(); e.preventDefault(); if(typeof haptic==='function') haptic(10); cookbookMagazineIndex = Math.max(0, cookbookMagazineIndex - 1); renderCookbook(); };
      if(nextBtn) nextBtn.onclick = function(e){ e.stopPropagation(); e.preventDefault(); if(typeof haptic==='function') haptic(10); cookbookMagazineIndex = Math.min(list.length - 1, cookbookMagazineIndex + 1); renderCookbook(); };
      var hintEl = document.getElementById('cookbookSwipeHint');
      if(hintEl && typeof save === 'function' && typeof LS !== 'undefined') setTimeout(function(){ save(LS.cookbookSwipeHintShown, true); }, 3000);
    }
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }

  function updateCookbookActionBar(){ /* Bar entfernt – CTAs auf Magazin-Karte */ }
  function clearCookbookSelection(){
    selectedCookbookId = null;
    cookbookMagazineIndex = 0;
  }
  function wireCookbookActionBar(){ /* Bar entfernt – CTAs auf Magazin-Karte */ }
  var cookbookLiveSheetChosenDate = null;
  function openCookbookLiveSheet(){
    if(!selectedCookbookId) return;
    var entry = (cookbook||[]).find(function(c){ return String(c.id) === String(selectedCookbookId); });
    if(!entry) return;
    var bd = document.getElementById('cookbookLiveSheetBd');
    var sheet = document.getElementById('cookbookLiveSheet');
    var dishEl = document.getElementById('cookbookLiveSheetDish');
    var priceEl = document.getElementById('cookbookLiveSheetPrice');
    var dateWrap = document.getElementById('cookbookLiveSheetDateWrap');
    var timeEl = document.getElementById('cookbookLiveSheetTime');
    var btn = document.getElementById('cookbookLiveSheetBtn');
    if(!bd || !sheet) return;
    cookbookLiveSheetChosenDate = isoDate(new Date());
    if(dishEl) dishEl.textContent = entry.dish || 'Gericht';
    if(priceEl) priceEl.textContent = euro(entry.price || 0);
    var profile = (typeof provider !== 'undefined' && provider && provider.profile) ? provider.profile : {};
    if(timeEl) timeEl.textContent = profile.mealWindow || '11:30 – 14:00';
    if(dateWrap){
      dateWrap.innerHTML = '';
      for(var i = 0; i < 7; i++){
        var d = new Date(); d.setDate(d.getDate() + i);
        var key = isoDate(d);
        var label = i === 0 ? 'Heute' : (i === 1 ? 'Morgen' : (d.getDate() + '.' + (d.getMonth()+1) + '.'));
        var btnDay = document.createElement('button');
        btnDay.type = 'button';
        btnDay.className = 'btn';
        btnDay.style.cssText = 'min-height:44px; padding:0 14px; border-radius:12px; font-size:14px; font-weight:700; ' + (key === cookbookLiveSheetChosenDate ? 'background:var(--prov-brand,#0ea5e9); color:#fff; border:none;' : 'background:#f1f3f5; color:#475569; border:2px solid #e2e8f0;');
        btnDay.textContent = label;
        btnDay.dataset.date = key;
        (function(k){ btnDay.onclick = function(){ if(typeof haptic === 'function') haptic(6); cookbookLiveSheetChosenDate = k; dateWrap.querySelectorAll('button').forEach(function(b){ var isSel = b.dataset.date === k; b.style.background = isSel ? 'var(--prov-brand,#0ea5e9)' : '#f1f3f5'; b.style.color = isSel ? '#fff' : '#475569'; b.style.border = isSel ? 'none' : '2px solid #e2e8f0'; }); }; })(key);
        dateWrap.appendChild(btnDay);
      }
    }
    if(btn){ btn.onclick = function(){ if(typeof haptic === 'function') haptic(6); if(typeof publishCookbookEntry === 'function') publishCookbookEntry(selectedCookbookId, cookbookLiveSheetChosenDate); closeCookbookLiveSheet(); clearCookbookSelection(); if(typeof renderCookbook === 'function') renderCookbook(); }; }
    bd.style.display = 'block';
    sheet.classList.add('active');
    if(typeof lucide !== 'undefined') setTimeout(function(){ lucide.createIcons(); }, 50);
  }
  function closeCookbookLiveSheet(){ var bd = document.getElementById('cookbookLiveSheetBd'); var sheet = document.getElementById('cookbookLiveSheet'); if(bd) bd.style.display = 'none'; if(sheet) sheet.classList.remove('active'); }
  function showCookbookVictoryOverlay(dayLabel, thenCallback){
    try { if(typeof haptic === 'function') haptic([12, 55, 12]); else if(navigator.vibrate) navigator.vibrate([12, 55, 12]); } catch(e){}
    var overlay = document.createElement('div');
    overlay.className = 'cookbook-victory-overlay';
    overlay.innerHTML = '<div class="check-wrap"><span>✓</span></div>';
    document.body.appendChild(overlay);
    if(typeof showToast === 'function') showToast('Gericht für ' + dayLabel + ' geplant!');
    setTimeout(function(){ overlay.remove(); if(thenCallback) thenCallback(); }, 1500);
  }
  function openCookbookWeekSheet(){
    if(!selectedCookbookId) return;
    var entry = (cookbook||[]).find(function(c){ return String(c.id) === String(selectedCookbookId); });
    if(!entry) return;
    var bd = document.getElementById('cookbookWeekSheetBd');
    var sheet = document.getElementById('cookbookWeekSheet');
    var dishEl = document.getElementById('cookbookWeekSheetDish');
    var daysWrap = document.getElementById('cookbookWeekSheetDays');
    if(!bd || !sheet || !daysWrap) return;
    if(dishEl) dishEl.textContent = entry.dish || 'Gericht';
    daysWrap.innerHTML = '';
    var dayNames = ['Mo','Di','Mi','Do','Fr','Sa','So'];
    for(var i = 0; i < 7; i++){
      var d = new Date(); d.setDate(d.getDate() + i);
      var key = isoDate(d);
      var label = (i === 0 ? 'Heute, ' : '') + dayNames[d.getDay() ? d.getDay()-1 : 6] + ' ' + d.getDate() + '.' + (d.getMonth()+1) + '.';
      var btnDay = document.createElement('button');
      btnDay.type = 'button';
      btnDay.className = 'cookbook-bar-btn cookbook-bar-secondary cookbook-week-day-btn';
      btnDay.style.flex = '1 1 40%';
      btnDay.textContent = label;
      (function(k, dayLabel){
        btnDay.onclick = function(){
          if(typeof addCookbookEntryToWeek === 'function') addCookbookEntryToWeek(k, selectedCookbookId);
          if(typeof showCookbookVictoryOverlay === 'function') showCookbookVictoryOverlay(dayLabel, function(){ closeCookbookWeekSheet(); clearCookbookSelection(); if(typeof renderCookbook === 'function') renderCookbook(); if(typeof renderProviderWeekPreviewNew === 'function') renderProviderWeekPreviewNew(); });
          else { closeCookbookWeekSheet(); clearCookbookSelection(); if(typeof renderCookbook === 'function') renderCookbook(); if(typeof renderProviderWeekPreviewNew === 'function') renderProviderWeekPreviewNew(); }
        };
      })(key, label);
      daysWrap.appendChild(btnDay);
    }
    bd.style.display = 'block';
    bd.classList.add('cookbook-week-bd-visible');
    sheet.classList.add('active', 'cookbook-week-visible');
    if(typeof lucide !== 'undefined') setTimeout(function(){ lucide.createIcons(); }, 50);
  }
  function closeCookbookWeekSheet(){
    var bd = document.getElementById('cookbookWeekSheetBd');
    var sheet = document.getElementById('cookbookWeekSheet');
    if(bd){ bd.style.display = 'none'; bd.classList.remove('cookbook-week-bd-visible'); }
    if(sheet) sheet.classList.remove('active', 'cookbook-week-visible');
  }

  function closeQuickPostSheet(){
    const bd = document.getElementById('quickPostBd');
    const sheet = document.getElementById('quickPostSheet');
    if(bd) bd.classList.remove('active');
    if(sheet) sheet.classList.remove('active');
  }

  function openQuickPostSheet(entryId, date){
    // Suche im Kochbuch nach dem Gericht
    const entry = cookbook.find(c => String(c.id) === String(entryId));
    if(!entry) {
      // Fallback: Wenn nicht im Kochbuch gefunden, direkt in den Wizard
      startWizard('listing', { dishId: entryId, date: date, skipQuickPost: true });
      return;
    }

    const bd = document.getElementById('quickPostBd');
    const sheet = document.getElementById('quickPostSheet');
    const summary = document.getElementById('quickPostSummary');
    const btnConfirm = document.getElementById('btnQuickPostConfirm');
    const btnWizard = document.getElementById('btnQuickPostWizard');

    if(!bd || !sheet || !summary) {
      // Fallback: Wenn UI-Elemente fehlen, in den Wizard
      startWizard('listing', { dishId: entryId, date: date, skipQuickPost: true });
      return;
    }

    const profile = normalizeProviderProfile(provider.profile || {});
    const time = profile.mealWindow || DEFAULT_MEAL_WINDOW;
    const price = euro(entry.price || 0);
    const dayLabel = date === isoDate(new Date()) ? 'Heute' : date;

    summary.innerHTML = `
      <div style="display:flex; gap:16px; align-items:center; margin-bottom:16px;">
        <img src="${entry.photoData || 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=200&q=60'}" style="width:60px; height:60px; border-radius:12px; object-fit:cover;">
        <div>
          <div style="font-weight:900; font-size:18px; color:#1a1a1a;">${esc(entry.dish)}</div>
          <div style="font-size:13px; font-weight:700; color:#1a1a1a;">${price}</div>
        </div>
      </div>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <div style="display:flex; align-items:center; gap:8px; font-size:14px; font-weight:600; color:#475569;">
          <i data-lucide="calendar" style="width:16px; height:16px;"></i>
          <span>${dayLabel}</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px; font-size:14px; font-weight:600; color:#475569;">
          <i data-lucide="clock" style="width:16px; height:16px;"></i>
          <span>Abholung: ${time} Uhr</span>
        </div>
        <div style="margin-top:8px; padding-top:12px; border-top:1px solid rgba(0,0,0,0.06); display:flex; justify-content:space-between; align-items:center;">
          <span style="font-size:13px; color:#64748b; font-weight:600;">Gebühr:</span>
          <span style="font-size:15px; font-weight:900; color:#FFD700;">4,99 €</span>
        </div>
      </div>
    `;

    btnConfirm.onclick = () => {
      closeQuickPostSheet();
      publishCookbookEntry(entryId, date);
    };

    btnWizard.onclick = () => {
      closeQuickPostSheet();
      startWizard('listing', { dishId: entryId, date: date, skipQuickPost: true });
    };

    bd.classList.add('active');
    sheet.classList.add('active');
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }

  function publishCookbookEntry(entryId, customDate = null){
    const entry = cookbook.find(c => String(c.id) === String(entryId));
    if(!entry) return;

    const profile = normalizeProviderProfile(provider.profile || {});
    
    // REGEL: Wenn kein Standard für Abholnummer im Profil, dann immer Abfrage-Wizard zeigen
    if(profile.abholnummerEnabledByDefault === undefined || profile.abholnummerEnabledByDefault === null){
      startWizard('listing', { 
        dishId: entryId, 
        date: customDate || isoDate(new Date()),
        skipToAbholnummer: true 
      });
      return;
    }

    const offer = normalizeOffer({
      id: cryptoId(),
      providerId: providerId(),
      providerName: profile.name || provider.email || 'Anbieter',
      providerStreet: profile.street||'',
      providerZip: profile.zip||'',
      providerCity: profile.city||'',
      providerLogoData: profile.logoData||'',
      dish: entry.dish||'',
      category: entry.category||'Vegetarisch',
      price: Number(entry.price||0),
      pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
      hasPickupCode: !!profile.abholnummerEnabledByDefault,
      dineInPossible: entry.dineInPossible !== false,
      allergens: entry.allergens||[],
      extras: entry.extras||[],
      reuse: entry.reuse||{enabled:!!profile.reuseEnabledByDefault, deposit:profile.reuseEnabledByDefault ? 2 : 0},
      imageUrl: entry.photoData || '',
      day: customDate || isoDate(new Date())
    });

    if(!offer.providerStreet){
      var p = normalizeProviderProfile(provider.profile || {});
      var hasAddr = !!(p.street && p.street.trim()) || (p.zip && p.city);
      if(!hasAddr){ showAddressRequiredModal(); return; }
      offer.providerStreet = p.street || buildAddress(p);
      offer.providerZip = p.zip; offer.providerCity = p.city;
    }

    // Gebühren-Modal zeigen (dort wird dann publishOffer + Erfolgs-Sheet aufgerufen)
    showPublishFeeModal(offer, () => {
      const idx = cookbook.findIndex(c => String(c.id) === String(entryId));
      if(idx >= 0){ cookbook[idx].lastUsed = Date.now(); }
      save(LS.cookbook, cookbook);
      renderCookbook();
    });
  }

  function publishWeekEntry(dayKey, entry){
    const cb = cookbook.find(c => String(c.id) === String(entry.cookbookId));
    if(!cb){
      alert('Gericht nicht gefunden.');
      return;
    }

    const profile = normalizeProviderProfile(provider.profile || {});
    const offer = normalizeOffer({
      id: cryptoId(),
      providerId: providerId(),
      providerName: profile.name || provider.email || 'Anbieter',
      providerStreet: profile.street||'',
      providerZip: profile.zip||'',
      providerCity: profile.city||'',
      providerLogoData: profile.logoData||'',
      dish: cb.dish||entry.dish||'',
      category: cb.category||'Vegetarisch',
      price: Number(cb.price||0),
      pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
      hasPickupCode: !!cb.hasPickupCode,
      dineInPossible: !!cb.dineInPossible,
      allergens: cb.allergens||[],
      extras: cb.extras||[],
      reuse: cb.reuse||{enabled:false,deposit:0},
      imageUrl: cb.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
      day: dayKey
    });

    if(!offer.providerStreet){
      var p = normalizeProviderProfile(provider.profile || {});
      var hasAddr = !!(p.street && p.street.trim()) || (p.zip && p.city);
      if(!hasAddr){ showAddressRequiredModal(); return; }
      offer.providerStreet = p.street || buildAddress(p);
      offer.providerZip = p.zip; offer.providerCity = p.city;
    }

    offers.unshift(offer);
    save(LS.offers, offers);

    const idx = cookbook.findIndex(c => String(c.id) === String(entry.cookbookId));
    if(idx>=0){ cookbook[idx].lastUsed = Date.now(); }
    save(LS.cookbook, cookbook);

    renderWeekPlan();
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
    renderStart();
    alert('Inserat veröffentlicht.');
  }

  // --- Wizard engine (Provider profile / Listing / Cookbook / Week) ---
  let w = { kind:null, step:0, data:{}, ctx:{} };
  let publishFeePendingOffer = null;

  const ALLERGENS_14 = [
    {name:'Gluten', short:'GL'},
    {name:'Krebstiere', short:'KR'},
    {name:'Eier', short:'EI'},
    {name:'Fisch', short:'FI'},
    {name:'Erdnüsse', short:'EN'},
    {name:'Soja', short:'SO'},
    {name:'Milch', short:'MI'},
    {name:'Schalenfrüchte', short:'SF'},
    {name:'Sellerie', short:'SE'},
    {name:'Senf', short:'SN'},
    {name:'Sesam', short:'SS'},
    {name:'Sulfite', short:'SU'},
    {name:'Lupinen', short:'LU'},
    {name:'Weichtiere', short:'WE'}
  ];
  /** Emoji pro Allergen (für kleine Pills). */
  const ALLERGEN_EMOJI = { GL:'🌾', KR:'🦐', EI:'🥚', FI:'🐟', EN:'🥜', SO:'🫘', MI:'🥛', SF:'🌰', SE:'🥬', SN:'🟡', SS:'⚪', SU:'🍷', LU:'🫘', WE:'🦑' };
  /** Gerichtname (lowercase) → vorgeschlagene Allergen-Codes (short). Bei Eingabe vorauswählen. */
  const DISH_ALLERGEN_SUGGESTIONS = {
    kürbissuppe:[], kartoffelsuppe:[], tomatensuppe:[], linsensuppe:[],
    schnitzel:['GL','EI'], gulasch:['GL'], käsespätzle:['GL','MI'], pasta:['GL','EI'],
    pizza:['GL','MI'], wrap:['GL'], burger:['GL','EI'], falafel:['SO'],
    lachs:['FI'], sushi:['FI'], thunfisch:['FI']
  };
  /** Gerichtname (lowercase) → Kategorie (Fleisch|Vegetarisch|Vegan|Salat) für Autovervollständigung. */
  const DISH_CATEGORY_SUGGESTIONS = {
    kürbissuppe:'Vegetarisch', kartoffelsuppe:'Vegetarisch', tomatensuppe:'Vegetarisch', linsensuppe:'Vegetarisch',
    schnitzel:'Fleisch', gulasch:'Fleisch', käsespätzle:'Vegetarisch', pasta:'Fleisch', pizza:'Fleisch',
    wrap:'Fleisch', burger:'Fleisch', falafel:'Vegan', lachs:'Fleisch', sushi:'Fleisch', thunfisch:'Fleisch',
    salat:'Salat', curry:'Fleisch', gemüsepfanne:'Vegetarisch', risotto:'Vegetarisch', lasagne:'Fleisch'
  };
  /** Goldene Sammelkarte: Kurze Beschreibungs-Snippets für Autovervollständigung [cite: 2026-01-29]. */
  const DISH_DESCRIPTION_SUGGESTIONS = {
    kürbissuppe:'… cremig, mit frischem Kürbis',
    kartoffelsuppe:'… hausgemacht, mit Einlage',
    tomatensuppe:'… frisch vom Feld',
    linsensuppe:'… würzig, mit Gemüse',
    schnitzel:'… knusprig paniert, hausgemacht',
    gulasch:'… nach Art des Hauses',
    käsespätzle:'… mit Röstzwiebeln',
    pasta:'… frisch zubereitet',
    pizza:'… aus dem Ofen',
    burger:'… mit frischem Salat',
    falafel:'… knusprig, mit Hummus',
    salat:'… mit saisonalem Gemüse',
    curry:'… aromatisch, nach Wahl',
    gemüsepfanne:'… frisch vom Feld',
    risotto:'… cremig, saisonal',
    lasagne:'… hausgemacht, mehrschichtig'
  };
  function getDescriptionSuggestionForDish(dishName){
    var n = String(dishName||'').trim().toLowerCase();
    if(!n) return null;
    for(var key in DISH_DESCRIPTION_SUGGESTIONS){
      if(n.includes(key) || key.includes(n)) return DISH_DESCRIPTION_SUGGESTIONS[key];
    }
    return null;
  }
  function getCategorySuggestionForDish(dishName){
    var n = String(dishName||'').trim().toLowerCase();
    if(!n) return null;
    for(var key in DISH_CATEGORY_SUGGESTIONS){
      if(n.includes(key) || key.includes(n)) return DISH_CATEGORY_SUGGESTIONS[key];
    }
    return null;
  }
  function getAllergenSuggestionsForDish(dishName){
    const n = String(dishName||'').trim().toLowerCase();
    if(!n) return [];
    for(const key of Object.keys(DISH_ALLERGEN_SUGGESTIONS)){
      if(n.includes(key) || key.includes(n)) return DISH_ALLERGEN_SUGGESTIONS[key] || [];
    }
    return [];
  }

  function openWizard(){
    const wbd = document.getElementById('wbd');
    const wizard = document.getElementById('wizard');
    if(wbd) wbd.classList.add('active');
    if(wizard) wizard.classList.add('active');
    pushViewState({wizard: true}, location.pathname);
    localStorage.setItem('mittagio_wizard_open', 'true');
  }
  /** .w-actions wurde entfernt – Navigation nur noch im #wContent (content-driven). */
  function clearWizardActionsBar(){ /* no-op */ }
  function restoreWizardActionsBar(){ /* no-op */ }
  /** @param {boolean} [clearDraft=false] - Bei true Entwurf löschen (z.B. nach erfolgreichem Speichern). Frage 5 A: Sonst Entwurf behalten für "Letzten Entwurf fortsetzen?" */
  function closeWizard(clearDraft){
    const wizard = document.getElementById('wizard');
    document.getElementById('wbd').classList.remove('active');
    if(wizard){ wizard.classList.remove('active'); wizard.removeAttribute('data-flow'); }
    restoreWizardActionsBar();
    localStorage.removeItem('mittagio_wizard_open');
    if(clearDraft) localStorage.removeItem('wizard_draft');
  }

  /**
   * UNIFIED DISH FLOW - Zentrale Funktion für alle Inserats-Buttons
   * Egal ob "Schnellschuss" für heute oder Wochenplan - immer derselbe Flow!
   * 
   * @param {string} [defaultDate] - Preselected date (ISO format, z.B. "2026-01-26")
   *                                  Wenn null/undefined: Heute
   *                                  Wenn vom Wochenplan: Gewählter Tag
   */
  /** entryPoint: 'dashboard' | 'cookbook' | 'week' – steuert Primär-/Sekundär-Buttons im Glass-Express (Action-Controller). */
  function openDishFlow(defaultDate = null, entryPoint = null){
    if(!provider || !provider.loggedIn){ if(typeof showToast === 'function') showToast('Bitte zuerst anmelden'); return; }
    var ctx = { date: defaultDate || isoDate(new Date()), fromWeek: entryPoint === 'week' };
    if(entryPoint) ctx.entryPoint = entryPoint;
    startListingFlow(ctx);
  }
  
  /**
   * MASTER INSERATSFLOW - Einziger Entry-Point
   * Wird IMMER verwendet für:
   * - Inserat erstellen
   * - Gericht hinzufügen (Kochbuch)
   * - Gericht hinzufügen (Wochenplan)
   * KEINE Sonderflows bauen!
   * 
   * @param {Object} context
   * @param {string} [context.source] - "cookbook" | "new" | undefined
   * @param {string} [context.dishId] - Kochbuch-Eintrag ID (wenn aus Kochbuch)
   * @param {string} [context.date] - Preselected date (ISO format)
   * @param {string} [context.editOfferId] - Offer ID (wenn bearbeiten)
   */
  function startListingFlow(context = {}){
    if(!provider || !provider.loggedIn){ if(typeof showToast === 'function') showToast('Bitte zuerst anmelden'); return; }
    // Action-Controller: Herkunft für Button-Logik (Dashboard / Kochbuch / Wochenplan)
    if(!context.entryPoint) context.entryPoint = context.dishId ? 'cookbook' : (context.fromWeek ? 'week' : 'dashboard');
    // QUICK-POST: Wenn aus Kochbuch, erst Bestätigung zeigen
    if(context.dishId && !context.editOfferId && !context.skipQuickPost){
      openQuickPostSheet(context.dishId, context.date || isoDate(new Date()));
      return;
    }
    // Entwurf-Wiederherstellung (nur Single-Page Inseratsflow – Schritt 0)
    if(!context.editOfferId){
      try {
        var draftStr = localStorage.getItem('wizard_draft');
        if(draftStr){
          var draft = JSON.parse(draftStr);
          if(draft && draft.kind === 'listing'){
            if(draft.step !== 0){ draft.step = 0; localStorage.setItem('wizard_draft', JSON.stringify(draft)); }
            showDraftRestorePrompt(function(choice){
              if(choice === 'restore'){
                draft.ctx = draft.ctx || {};
                draft.ctx.entryPoint = context.entryPoint || draft.ctx.entryPoint;
                draft.ctx.date = context.date || draft.ctx.date;
                draft.data = draft.data || {};
                draft.data.day = context.date || draft.data.day || (typeof isoDate === 'function' ? isoDate(new Date()) : '');
                draft.step = 0;
                w = draft;
                var wizardEl = document.getElementById('wizard');
                if(wizardEl) wizardEl.setAttribute('data-flow', 'listing');
                clearWizardActionsBar();
                openWizard();
                buildListingStep();
              } else {
                localStorage.removeItem('wizard_draft');
                startWizard('listing', context);
              }
            });
            return;
          }
        }
      } catch(e) { localStorage.removeItem('wizard_draft'); }
    }
    // Always use listing wizard (Master Flow)
    startWizard('listing', context);
  }

  /** Wendet einen automatischen Optimierungs-Filter auf ein Bild an (Food-Optimization). */
  async function applyAppetizerFilter(dataUrl) {
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        
        // CSS-Filter-Logik via Canvas: Sättigung, Kontrast, Helligkeit
        // Wir nutzen den Filter-Property des Contexts (modernere Browser unterstützen das)
        // Alternativ: Pixel-Manipulation (aber Filter ist performanter)
        ctx.filter = 'saturate(1.2) contrast(1.1) brightness(1.05) sepia(0.05)';
        ctx.drawImage(img, 0, 0);
        
        resolve(canvas.toDataURL('image/jpeg', 0.85));
      };
      img.onerror = () => resolve(dataUrl); // Fallback auf Original
      img.src = dataUrl;
    });
  }

  function startWizard(kind, ctx={}){
    w = { kind, step:0, data:{}, ctx };
    const wizardEl = document.getElementById('wizard');
    if(wizardEl) wizardEl.setAttribute('data-flow', kind === 'listing' ? 'listing' : (kind || ''));
    if(kind === 'listing') clearWizardActionsBar();
    else restoreWizardActionsBar();

    if(kind==='provider'){
      w.data = normalizeProviderProfile(JSON.parse(JSON.stringify(provider.profile||{})));
      buildProviderStep();
    }
    // Legacy-Cleanup: Kochbuch = InseratCard (Single-Source-of-Truth) [cite: 2026-01-29]
    if(kind==='cookbook'){
      kind = 'listing';
      ctx.entryPoint = 'cookbook';
      w.kind = 'listing';
      w.ctx = ctx;
      if(ctx.editId){
        const existing = cookbook.find(c => String(c.id) === String(ctx.editId));
        if(existing) w.data = JSON.parse(JSON.stringify(existing));
      }
      if(!w.data || !w.data.providerId){
        w.data = { providerId: providerId(), dish:'', category:'Vegetarisch', price:0, allergens:[], extras:[], reuse:{enabled:false, deposit:0}, photoData:'', hasPickupCode:false, dineInPossible:false, createdAt: Date.now(), lastUsed: null };
      }
      w.data.providerId = providerId();
      w.data.category = w.data.category || 'Vegetarisch';
      w.data.price = Number(w.data.price||0);
      w.data.allergens = Array.isArray(w.data.allergens) ? w.data.allergens : [];
      w.data.extras = Array.isArray(w.data.extras) ? w.data.extras : [];
      if(!w.data.reuse) w.data.reuse = {enabled:false, deposit:0};
      w.data.photoData = w.data.photoData || '';
      w.data.hasPickupCode = !!w.data.hasPickupCode;
      w.data.dineInPossible = !!w.data.dineInPossible;
      w.data.createdAt = w.data.createdAt || Date.now();
      if(w.data.lastUsed === undefined) w.data.lastUsed = null;
      if(wizardEl) wizardEl.setAttribute('data-flow', 'listing');
      clearWizardActionsBar();
      openWizard();
      buildListingStep();
      return;
    }
    if(kind==='listing'){
      // MASTER INSERATSFLOW - Always the same flow
      const profile = normalizeProviderProfile(provider.profile || {});
      
      // Case 1: Edit existing offer
      if(ctx.editOfferId){
        const existing = offers.find(o=>o.id===ctx.editOfferId);
        if(existing){
          const o = normalizeOffer(existing);
          w.data = {
            providerId: o.providerId || providerId(),
            dish: o.dish||'',
            category: o.category||'Vegetarisch',
            price: Number(o.price||0),
            pickupWindow: o.pickupWindow || profile.mealWindow || DEFAULT_MEAL_WINDOW,
            hasPickupCode: !!o.hasPickupCode,
            dineInPossible: !!o.dineInPossible,
            allergens: Array.isArray(o.allergens) ? [...o.allergens] : [],
            wantsAllergens: !!(o.allergens && Array.isArray(o.allergens) && o.allergens.length > 0),
            extras: Array.isArray(o.extras) ? JSON.parse(JSON.stringify(o.extras)) : [],
            reuse: o.reuse ? JSON.parse(JSON.stringify(o.reuse)) : {enabled:false, deposit:0},
            photoData: o.imageUrl || '',
            photoDataIsStandard: !!o.photoDataIsStandard,
            day: o.day,
            active: o.active !== false,
            cookbookId: null
          };
        }
      } 
      // Case 2: From cookbook (context.dishId or ctx.fromCookbookId)
      else if(ctx.dishId || ctx.fromCookbookId){
        const cookbookId = ctx.dishId || ctx.fromCookbookId;
        const x = cookbook.find(c => String(c.id) === String(cookbookId));
        if(x){
          // Prefill from cookbook – 3 Säulen/Abholzeiten: wo nicht im Kochbuch gesetzt, aus Profil
          const defaultVorOrt = (provider.profile && provider.profile.dineInPossibleDefault !== undefined) ? !!provider.profile.dineInPossibleDefault : true;
          const defaultAbholnummer = !!profile.abholnummerEnabledByDefault;
          const globalReuseEnabled = !!profile.reuseEnabledByDefault;
          const defaultReuseDeposit = (provider.profile && typeof provider.profile.reuseDepositDefault === 'number') ? provider.profile.reuseDepositDefault : 3;
          w.data = {
            providerId: providerId(),
            dish: x.dish || '',
            category: x.category || 'Vegetarisch',
            price: Number(x.price||0),
            pickupWindow: x.pickupWindow || profile.mealWindow || DEFAULT_MEAL_WINDOW,
            hasPickupCode: x.hasPickupCode !== undefined ? !!x.hasPickupCode : defaultAbholnummer,
            dineInPossible: x.dineInPossible !== undefined ? !!x.dineInPossible : defaultVorOrt,
            allergens: Array.isArray(x.allergens) ? [...x.allergens] : [],
            wantsAllergens: !!(x.allergens && Array.isArray(x.allergens) && x.allergens.length > 0),
            extras: Array.isArray(x.extras) ? JSON.parse(JSON.stringify(x.extras)) : [],
            reuse: x.reuse && (x.reuse.enabled !== undefined || x.reuse.deposit !== undefined) ? JSON.parse(JSON.stringify(x.reuse)) : { enabled: globalReuseEnabled, deposit: globalReuseEnabled ? defaultReuseDeposit : 0 },
            photoData: x.photoData || '',
            cookbookId: x.id,
            day: ctx.date || createFlowPreselectedDate || isoDate(new Date())
          };
        } else {
          const defaultVorOrt = (provider.profile && provider.profile.dineInPossibleDefault !== undefined) ? !!provider.profile.dineInPossibleDefault : true;
          const globalReuseEnabled = !!profile.reuseEnabledByDefault;
          w.data = {
            providerId: providerId(),
            dish:'', category:'Vegetarisch', price:0,
            pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
            hasPickupCode: !!profile.abholnummerEnabledByDefault,
            dineInPossible: defaultVorOrt,
            allergens:[],
            wantsAllergens: false,
            extras:[],
            reuse:{ enabled: globalReuseEnabled, deposit: globalReuseEnabled ? 3 : 0 },
            photoData:'',
            cookbookId:null,
            day: ctx.date || createFlowPreselectedDate || isoDate(new Date())
          };
        }
      } 
      // Case 3: Neues Gericht – 3 Säulen und Abholzeiten aus Profil übernehmen
      // First-Time: Leberkäse-Template laden [cite: 2026-01-29, 2026-02-16]
      else {
        const globalReuseEnabled = !!profile.reuseEnabledByDefault;
        const defaultVorOrt = (provider.profile && provider.profile.dineInPossibleDefault !== undefined) ? !!provider.profile.dineInPossibleDefault : true;
        const defaultAbholnummer = !!profile.abholnummerEnabledByDefault;
        const isFirstTimeLeberkaese = !localStorage.getItem('mittagio_provider_leberkaese_onboarding_done') && (offers || []).filter(function(o){ return o.providerId === providerId(); }).length === 0;
        const leberkaeseImageUrl = 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400&q=80';
        w.data = {
          providerId: providerId(),
          dish: isFirstTimeLeberkaese ? 'Dicke Scheibe Leberkäse mit Spätzle' : '',
          category: isFirstTimeLeberkaese ? 'Fleisch' : 'Vegetarisch',
          price: isFirstTimeLeberkaese ? 8.5 : 0,
          pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
          hasPickupCode: defaultAbholnummer,
          dineInPossible: isFirstTimeLeberkaese ? true : defaultVorOrt,
          allergens:[],
          wantsAllergens: false,
          extras:[],
          reuse:{ enabled: isFirstTimeLeberkaese ? true : globalReuseEnabled, deposit: (isFirstTimeLeberkaese || globalReuseEnabled) ? (provider.profile && typeof provider.profile.reuseDepositDefault === 'number' ? provider.profile.reuseDepositDefault : 3) : 0 },
          photoData: isFirstTimeLeberkaese ? leberkaeseImageUrl : '',
          photoDataIsStandard: !!isFirstTimeLeberkaese,
          cookbookId:null,
          day: ctx.date || createFlowPreselectedDate || isoDate(new Date())
        };
        if(isFirstTimeLeberkaese) ctx.isLeberkaeseOnboarding = true;
      }
      
      // Normalize data
      w.data.providerId = w.data.providerId || providerId();
      w.data.category = w.data.category || 'Vegetarisch';
      w.data.price = Number(w.data.price||0);
      w.data.pickupWindow = w.data.pickupWindow || profile.mealWindow || DEFAULT_MEAL_WINDOW;
      w.data.cookbookId = w.data.cookbookId || null;
      // Date preselect support
      if(ctx.date || createFlowPreselectedDate){
        w.data.day = ctx.date || createFlowPreselectedDate;
      } else if(!w.data.day){
        w.data.day = isoDate(new Date());
      }
      w.data.hasPickupCode = !!w.data.hasPickupCode;
      w.data.dineInPossible = !!w.data.dineInPossible;
      w.data.allergens = Array.isArray(w.data.allergens) ? w.data.allergens : [];
      if(w.data.wantsAllergens === undefined) w.data.wantsAllergens = !!(w.data.allergens && w.data.allergens.length > 0);
      w.data.extras = Array.isArray(w.data.extras) ? w.data.extras : [];
      // Mehrweg: aus Profil wenn nicht gesetzt
      if(!w.data.reuse) w.data.reuse = { enabled: !!profile.reuseEnabledByDefault, deposit: profile.reuseEnabledByDefault ? 3 : 0 };
      else if(w.data.reuse.enabled === undefined) w.data.reuse.enabled = !!profile.reuseEnabledByDefault;
      if(w.data.reuse.enabled && (w.data.reuse.deposit === undefined || w.data.reuse.deposit === 0)) w.data.reuse.deposit = (provider.profile && typeof provider.profile.reuseDepositDefault === 'number') ? provider.profile.reuseDepositDefault : 3;
      openWizard();
      buildListingStep();
    }
    // Legacy-Cleanup: Wochenplan = InseratCard mit Vorauswahl aus Kochbuch [cite: 2026-01-29]
    if(kind==='week'){
      const x = cookbook.find(c => String(c.id) === String(ctx.fromCookbookId));
      if(!x){ if(typeof showToast==='function') showToast('Bitte erst ein Gericht im Kochbuch speichern.'); else alert('Bitte erst ein Gericht im Kochbuch speichern.'); return; }
      kind = 'listing';
      ctx.entryPoint = 'week';
      ctx.dishId = ctx.fromCookbookId;
      ctx.date = ctx.date || isoDate(new Date());
      w.kind = 'listing';
      w.ctx = ctx;
      const profile = normalizeProviderProfile(provider.profile || {});
      const defaultVorOrt = (provider.profile && provider.profile.dineInPossibleDefault !== undefined) ? !!provider.profile.dineInPossibleDefault : true;
      const defaultAbholnummer = !!profile.abholnummerEnabledByDefault;
      const globalReuseEnabled = !!profile.reuseEnabledByDefault;
      const defaultReuseDeposit = (provider.profile && typeof provider.profile.reuseDepositDefault === 'number') ? provider.profile.reuseDepositDefault : 3;
      w.data = {
        providerId: providerId(),
        dish: x.dish || '',
        category: x.category || 'Vegetarisch',
        price: Number(x.price||0),
        pickupWindow: x.pickupWindow || profile.mealWindow || DEFAULT_MEAL_WINDOW,
        hasPickupCode: x.hasPickupCode !== undefined ? !!x.hasPickupCode : defaultAbholnummer,
        dineInPossible: x.dineInPossible !== undefined ? !!x.dineInPossible : defaultVorOrt,
        allergens: Array.isArray(x.allergens) ? [...x.allergens] : [],
        wantsAllergens: !!(x.allergens && x.allergens.length),
        extras: Array.isArray(x.extras) ? JSON.parse(JSON.stringify(x.extras)) : [],
        reuse: x.reuse ? JSON.parse(JSON.stringify(x.reuse)) : { enabled: globalReuseEnabled, deposit: defaultReuseDeposit },
        photoData: x.photoData || x.imageUrl || '',
        cookbookId: x.id,
        day: ctx.date
      };
      if(wizardEl) wizardEl.setAttribute('data-flow', 'listing');
      clearWizardActionsBar();
      openWizard();
      buildListingStep();
      return;
    }

    if(kind !== 'listing') openWizard();
  }

  // Common wizard buttons (DOM-Elemente #wBack/#wNext wurden entfernt – Navigation nur im #wContent; Refs bleiben für null-sichere No-Ops.)
  const wBackBtn = document.getElementById('wBack');
  const wNextBtn = document.getElementById('wNext');
  function setWizardNext(text, icon = 'chevron-right'){
    if(!wNextBtn) return;
    wNextBtn.innerHTML = `<span>${text}</span>` + (icon ? `<i data-lucide="${icon}" style="width:18px;height:18px;stroke-width:3;"></i>` : '');
    wNextBtn.style.display = 'flex';
    wNextBtn.style.alignItems = 'center';
    wNextBtn.style.justifyContent = 'center';
    wNextBtn.style.gap = '8px';
    if(typeof lucide !== 'undefined') lucide.createIcons();
  }
  const defaultWizardNext = ()=>{ w.step += 1; rebuildWizard(); };
  function setWizardNextDefault(){ if(wNextBtn) wNextBtn.onclick = defaultWizardNext; }

  if(wBackBtn) wBackBtn.onclick=()=>{
    if(w.step===0){ closeWizard(); return; }
    w.step -= 1;
    rebuildWizard();
  };
  setWizardNextDefault();

  function setWizardHeader(title, stepText){
    const titleEl = document.getElementById('wTitle');
    const stepEl = document.getElementById('wStep');
    if(titleEl) titleEl.textContent = title;
    if(stepEl) stepEl.textContent = stepText;
    const dotsEl = document.getElementById('wizardProgressDots');
    const wTop = document.querySelector('#wBox .w-top');
    const wQ = document.getElementById('wQ');
    const wHelp = document.getElementById('wHelp');
    const hideTop = (w.kind === 'listing' && w.step === 0);
    if(dotsEl) dotsEl.style.display = hideTop ? 'none' : '';
    if(wTop) wTop.style.display = hideTop ? 'none' : '';
    if(wQ) wQ.style.display = hideTop ? 'none' : '';
    if(wHelp) wHelp.style.display = hideTop ? 'none' : '';
    if(dotsEl && !hideTop){
      const m = String(stepText).match(/Schritt\s*(\d+)\s*von\s*(\d+)|(\d+)\/(\d+)/);
      const step = m ? parseInt(m[1] || m[3], 10) : 1;
      const total = m ? parseInt(m[2] || m[4], 10) : 5;
      dotsEl.innerHTML = '';
      for(let i = 0; i < total; i++){
        const dot = document.createElement('span');
        dot.className = 'wizard-dot' + (i < step ? ' active' : '');
        dot.setAttribute('aria-hidden', 'true');
        dotsEl.appendChild(dot);
      }
    }
  }
  function setWizardQuestion(q, help=''){ 
    document.getElementById('wQ').textContent = q;
    document.getElementById('wHelp').textContent = help;
  }
  function setWizardContent(node){
    const c = document.getElementById('wContent');
    if(!c) return;
    c.style.opacity='0';
    c.style.transform='translateY(8px)';
    c.style.transition='opacity 0.2s ease, transform 0.2s ease';
    c.innerHTML='';
    c.appendChild(node);
    requestAnimationFrame(function(){ requestAnimationFrame(function(){ c.style.opacity='1'; c.style.transform='translateY(0)'; }); });
  }

  function rebuildWizard(){
    if(w.kind==='provider') return buildProviderStep();
    if(w.kind==='listing') return buildListingStep();
  }

  function saveProviderProfileFromWizard(){
    const parsed = parseAddress(w.data.address || '');
    const street = parsed.street || w.data.street || '';
    const zip = parsed.zip || w.data.zip || '';
    const city = parsed.city || w.data.city || '';
    const address = parsed.address || buildAddress({street, zip, city});

    provider.profile = {
      name: w.data.name||'',
      address,
      street,
      zip,
      city,
      mealWindow: w.data.mealWindow || DEFAULT_MEAL_WINDOW,
      mealStart: w.data.mealStart || '11:30',
      mealEnd: w.data.mealEnd || '14:00',
      lunchWeekdays: Array.isArray(w.data.lunchWeekdays) ? w.data.lunchWeekdays : [1,2,3,4,5],
      phone: w.data.phone||'',
      email: w.data.email||'',
      website: w.data.website||'',
      logoData: w.data.logoData||'',
      reuseEnabledByDefault: !!w.data.reuseEnabledByDefault,
      abholnummerEnabledByDefault: !!w.data.abholnummerEnabledByDefault
    };
    save(LS.provider, provider);
    renderProviderProfile();
    renderProviderHome();
  }

  // --- Provider onboarding (step-by-step, no form) ---
  function buildProviderStep(){
    setWizardNextDefault();
    const total = 5;
    const stepText = `Schritt ${Math.min(w.step+1,total)} von ${total}`;
    setWizardHeader('Anbieter-Profil', stepText);

    if(w.step >= total){
      saveProviderProfileFromWizard();
      closeWizard();
      alert('Profil ist bereit.');
      return;
    }

    if(w.step===0){
      setWizardQuestion('Wie heißt dein Betrieb?', 'Du kannst den Namen jederzeit ändern.');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field';
      input.placeholder='z.B. Metzgerei Kurz';
      input.value = w.data.name || '';
      input.oninput=()=>{ w.data.name=input.value; };
      box.appendChild(input);
      const nav=document.createElement('div'); nav.style.cssText='display:flex;gap:10px;margin-top:20px;';
      const btnNext=document.createElement('button'); btnNext.type='button'; btnNext.className='btn'; btnNext.textContent='Weiter'; btnNext.onclick=()=>{ if(typeof haptic==='function') haptic(10); else if(navigator.vibrate) navigator.vibrate(10); w.step++; rebuildWizard(); };
      const btnAbort=document.createElement('button'); btnAbort.type='button'; btnAbort.className='btn secondary'; btnAbort.textContent='Abbrechen'; btnAbort.onclick=()=>{ if(typeof haptic==='function') haptic(10); else if(navigator.vibrate) navigator.vibrate(10); closeWizard(); };
      nav.appendChild(btnAbort); nav.appendChild(btnNext); box.appendChild(nav);
      setWizardContent(box);
      return;
    }

    if(w.step===1){
      setWizardQuestion('Adresse deines Betriebs?', 'Auto-Vervollständigung folgt (Demo).');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field';
      input.placeholder='z.B. Winterbacher Str. 24, 73614 Schorndorf';
      input.value = w.data.address || buildAddress(w.data) || '';
      input.oninput=()=>{ w.data.address=input.value; };
      box.appendChild(input);
      const h=document.createElement('div'); h.className='hint'; h.textContent='Tipp: Straße, PLZ, Ort - getrennt mit Komma.';
      box.appendChild(h);
      const nav=document.createElement('div'); nav.style.cssText='display:flex;gap:10px;margin-top:20px;';
      const btnBack=document.createElement('button'); btnBack.type='button'; btnBack.className='btn secondary'; btnBack.textContent='Zurück'; btnBack.onclick=()=>{ if(typeof haptic==='function') haptic(10); else if(navigator.vibrate) navigator.vibrate(10); w.step--; rebuildWizard(); };
      const btnNext=document.createElement('button'); btnNext.type='button'; btnNext.className='btn'; btnNext.textContent='Weiter'; btnNext.onclick=()=>{ if(typeof haptic==='function') haptic(10); else if(navigator.vibrate) navigator.vibrate(10); w.step++; rebuildWizard(); };
      nav.appendChild(btnBack); nav.appendChild(btnNext); box.appendChild(nav);
      setWizardContent(box);
      return;
    }

    if(w.step===2){
      setWizardQuestion('Wann können Gäste dein Essen genießen?', 'Standard aus Profil, optional anpassen.');
      if(!w.data.mealWindow) w.data.mealWindow = DEFAULT_MEAL_WINDOW;

      const current = w.data.mealWindow || DEFAULT_MEAL_WINDOW;
      const split = current.includes('–') ? current.split('–') : current.split('-');
      const startDefault = split[0] ? split[0].trim() : '11:30';
      const endDefault = split[1] ? split[1].trim() : '14:00';
      if(!w.data.mealStart) w.data.mealStart = startDefault;
      if(!w.data.mealEnd) w.data.mealEnd = endDefault;

      const box=document.createElement('div');
      const summary=document.createElement('div');
      summary.className='panel';
      summary.innerHTML = `<b>${esc(current)}</b><div class="hint">Standard aus Profil</div>`;
      box.appendChild(summary);

      const actions=document.createElement('div');
      actions.className='answers';
      const toggle=document.createElement('button');
      toggle.type='button';
      toggle.className='ans';
      toggle.textContent = w.data.mealCustom ? 'Fertig' : 'Essenszeit ändern';
      toggle.onclick=()=>{
        w.data.mealCustom = !w.data.mealCustom;
        rebuildWizard();
      };
      actions.appendChild(toggle);
      box.appendChild(actions);

      if(w.data.mealCustom){
        const updateMealWindow = ()=>{
          if(w.data.mealStart && w.data.mealEnd){
            w.data.mealWindow = `${w.data.mealStart} – ${w.data.mealEnd}`;
          }
        };

        const startLabel=document.createElement('div'); startLabel.className='hint'; startLabel.textContent='Start';
        const startRow=document.createElement('div'); startRow.className='answers';
        ['10:30','11:00','11:30','12:00'].forEach(t=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.mealStart===t?' on':'');
          b.textContent=t;
          b.onclick=()=>{ w.data.mealStart=t; updateMealWindow(); rebuildWizard(); };
          startRow.appendChild(b);
        });

        const endLabel=document.createElement('div'); endLabel.className='hint'; endLabel.textContent='Ende';
        const endRow=document.createElement('div'); endRow.className='answers';
        ['13:00','13:30','14:00','14:30'].forEach(t=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.mealEnd===t?' on':'');
          b.textContent=t;
          b.onclick=()=>{ w.data.mealEnd=t; updateMealWindow(); rebuildWizard(); };
          endRow.appendChild(b);
        });

        box.appendChild(document.createElement('div')).style.height='10px';
        box.appendChild(startLabel);
        box.appendChild(startRow);
        box.appendChild(document.createElement('div')).style.height='8px';
        box.appendChild(endLabel);
        box.appendChild(endRow);
      }

      const nav2=document.createElement('div'); nav2.style.cssText='display:flex;gap:10px;margin-top:20px;';
      const btnBack2=document.createElement('button'); btnBack2.type='button'; btnBack2.className='btn secondary'; btnBack2.textContent='Zurück'; btnBack2.onclick=()=>{ if(typeof haptic==='function') haptic(10); else if(navigator.vibrate) navigator.vibrate(10); w.step--; rebuildWizard(); };
      const btnNext2=document.createElement('button'); btnNext2.type='button'; btnNext2.className='btn'; btnNext2.textContent='Weiter'; btnNext2.onclick=()=>{ if(typeof haptic==='function') haptic(10); else if(navigator.vibrate) navigator.vibrate(10); w.step++; rebuildWizard(); };
      nav2.appendChild(btnBack2); nav2.appendChild(btnNext2); box.appendChild(nav2);
      setWizardContent(box);
      return;
    }

    if(w.step===3){
      setWizardQuestion('Logo hochladen?', 'Optional, später jederzeit austauschbar.');
      const wrap = document.createElement('div');
      const btns=document.createElement('div');
      btns.className='answers';

      const up=document.createElement('button');
      up.className='ans';
      up.type='button';
      up.textContent='Logo auswählen';
      up.onclick=async()=>{
        const file = await pickImage();
        if(!file) return;
        w.data.logoData = await toDataUrl(file);
        rebuildWizard();
      };

      const skip=document.createElement('button');
      skip.className='ans';
      skip.type='button';
      skip.textContent='Später';
      skip.onclick=()=>{ w.data.logoData=''; rebuildWizard(); };

      btns.appendChild(up);
      btns.appendChild(skip);
      wrap.appendChild(btns);

      if(w.data.logoData){
        const prev=document.createElement('div');
        prev.style.marginTop='10px';
        prev.innerHTML = `<div class="hint">Vorschau:</div><div class="plogo" style="width:60px;height:60px;border-radius:14px"><img src="${w.data.logoData}" alt="Logo" /></div>`;
        wrap.appendChild(prev);
      }
      const nav3=document.createElement('div'); nav3.style.cssText='display:flex;gap:10px;margin-top:20px;';
      const btnBack3=document.createElement('button'); btnBack3.type='button'; btnBack3.className='btn secondary'; btnBack3.textContent='Zurück'; btnBack3.onclick=()=>{ if(typeof haptic==='function') haptic(10); else if(navigator.vibrate) navigator.vibrate(10); w.step--; rebuildWizard(); };
      const btnNext3=document.createElement('button'); btnNext3.type='button'; btnNext3.className='btn'; btnNext3.textContent='Weiter'; btnNext3.onclick=()=>{ if(typeof haptic==='function') haptic(10); else if(navigator.vibrate) navigator.vibrate(10); w.step++; rebuildWizard(); };
      nav3.appendChild(btnBack3); nav3.appendChild(btnNext3); wrap.appendChild(nav3);
      setWizardContent(wrap);
      return;
    }

    if(w.step===4){
      setWizardQuestion('Profil ist bereit', 'Kurz prüfen, dann loslegen.');
      const box=document.createElement('div');
      const addr = buildAddress(w.data);
      const logo = w.data.logoData ? `<img src="${w.data.logoData}" alt="Logo" />` : `<img src="assets/provider-placeholder.png" alt="Logo" />`;

      const summary=document.createElement('div');
      summary.className='panel';
      summary.innerHTML = `
        <div style="display:flex;gap:10px;align-items:center;">
          <div class="plogo" style="width:52px;height:52px;border-radius:14px">${logo}</div>
          <div>
            <div style="font-weight:950">${esc(w.data.name || 'Betrieb')}</div>
            <div class="hint">${esc(addr || 'Adresse fehlt')}</div>
          </div>
        </div>
        <div class="row"><span>Essenszeit</span><b>${esc(w.data.mealWindow || DEFAULT_MEAL_WINDOW)}</b></div>
      `;

      const cta=document.createElement('button');
      cta.className='btn';
      cta.type='button';
      cta.textContent='Erstes Gericht erstellen';
      cta.onclick=()=>{
        if(typeof haptic==='function') haptic(10); else if(navigator.vibrate) navigator.vibrate(10);
        saveProviderProfileFromWizard();
        closeWizard();
        startWizard('listing');
      };
      const btnBack4=document.createElement('button'); btnBack4.type='button'; btnBack4.className='btn secondary'; btnBack4.textContent='Zurück'; btnBack4.onclick=()=>{ if(typeof haptic==='function') haptic(10); else if(navigator.vibrate) navigator.vibrate(10); w.step--; rebuildWizard(); };
      box.appendChild(summary);
      box.appendChild(btnBack4);
      box.appendChild(cta);
      setWizardContent(box);
      return;
    }
  }

  // --- Listing wizard (Punkt 6 final) ---
  function updateListingPreviewContent(target){
    target.innerHTML = '';
    const offer = previewOfferFromWizard();
    // Entfernung/Entfernung-Emoji für Anbieter-Vorschau entfernen (er weiß wo er ist)
    const card = offerCard(offer, {interactive:false, previewFromWizard:true});
    
    // Entferne Entfernungs-Info falls vorhanden
    const distanceInfo = card.querySelector('.listing-distance-info');
    if(distanceInfo) distanceInfo.remove();
    
    // Entferne Distanz-Badge (falls es eins gibt, z.B. oben rechts)
    const distBadge = card.querySelector('.dist-badge');
    if(distBadge) distBadge.remove();

    target.appendChild(card);
  }

  function attachListingPreview(box){
    const wrap = document.createElement('div');
    wrap.id = 'listingPreview';
    wrap.style.marginTop = '12px';
    updateListingPreviewContent(wrap);
    box.appendChild(wrap);
  }

  function refreshListingPreview(){
    const wrap = document.getElementById('listingPreview');
    if(wrap){ updateListingPreviewContent(wrap); }
  }

  // InseratCard State-Machine: Karte funktioniert in allen Kontexten (DRAFT, ARCHIV, PLANNED, LIVE)
  var CARD_STATE = { DRAFT: 'DRAFT', ARCHIV: 'ARCHIV', PLANNED: 'PLANNED', LIVE: 'LIVE' };
  function getCardState(offerOrDish, context){
    if(!offerOrDish && context !== 'wizard') return CARD_STATE.DRAFT;
    if(context === 'wizard' || context === 'flow') return CARD_STATE.DRAFT;
    var o = offerOrDish || {};
    var isOffer = !!o.day;
    var todayKey = typeof isoDate === 'function' ? isoDate(new Date()) : '';
    if(isOffer && o.day === todayKey && o.active !== false) return CARD_STATE.LIVE;
    if(isOffer && o.day) return CARD_STATE.PLANNED;
    return CARD_STATE.ARCHIV;
  }
  function getCardStateLabel(state){
    if(state === CARD_STATE.LIVE) return 'Live';
    if(state === CARD_STATE.PLANNED) return 'Geplant';
    if(state === CARD_STATE.ARCHIV) return 'Archiv';
    return 'Entwurf';
  }

  // ============================================================
  // INSERATCARD – Single-Source-of-Truth [cite: 2026-01-29]
  // Die Karte im Inseratsflow IST die Karte im Kochbuch IST die Karte im Wochenplan.
  // Keine Formular-Listen; Erstellung nur durch direkte Interaktion mit der Karte.
  // ============================================================
  function buildListingStep(){
    setWizardNextDefault();
    w.step = 0;
    setWizardHeader('', '');
    const profile = normalizeProviderProfile(provider.profile || {});
    const profileWindow = profile.mealWindow || DEFAULT_MEAL_WINDOW;
    const defaultReuseDeposit = (provider.profile && typeof provider.profile.reuseDepositDefault === 'number') ? provider.profile.reuseDepositDefault : 3;
    // 3 Säulen + Abholzeiten: aus Profil übernehmen, wenn noch nicht gesetzt
    if(!w.data.pickupWindow) w.data.pickupWindow = profileWindow;
    if(w.data.dineInPossible === undefined) w.data.dineInPossible = (provider.profile && provider.profile.dineInPossibleDefault !== undefined) ? !!provider.profile.dineInPossibleDefault : true;
    if(w.data.hasPickupCode === undefined) w.data.hasPickupCode = !!profile.abholnummerEnabledByDefault;
    if(!w.data.reuse) w.data.reuse = { enabled: !!profile.reuseEnabledByDefault, deposit: defaultReuseDeposit };
    else { if(w.data.reuse.enabled === undefined) w.data.reuse.enabled = !!profile.reuseEnabledByDefault; if(w.data.reuse.enabled && (w.data.reuse.deposit === undefined || w.data.reuse.deposit === 0)) w.data.reuse.deposit = defaultReuseDeposit; }
    if(typeof w.data.allergeneExpanded === 'undefined') w.data.allergeneExpanded = !!w.data.wantsAllergens;

    // Master Inseratsflow (Single-Page): Foto→Name→Beschreibung→Kategorie→Preis→Logistik→Allergene→Extras→Buttons
    {
      setWizardQuestion('', '');
      const box=document.createElement('div');
      box.className='liquid-master-panel glass-express-step0 inserat-universal-mask inserat-master-flow liquid-panel listing-glass-panel s25-floating-panel inserat-card';
      box.setAttribute('data-inserat-card','true');
      box.style.cssText='padding:0; overflow:hidden; display:flex; flex-direction:column; min-height:0;';
      const saveDraft = () => { localStorage.setItem('wizard_draft', JSON.stringify(w)); };
      const dismissKeyboard = ()=>{ try { if(document.activeElement && document.activeElement.blur) document.activeElement.blur(); } catch(e){} };
      const hapticLight = ()=>{ try { if(typeof haptic==='function') haptic(10); else if(navigator.vibrate) navigator.vibrate(10); } catch(e){} };
      var listingDebounceTimer = null; /* Debounce für Autovervollständigung + Bildvorschläge */
      var LISTING_IMAGES_BASE = 'https://images.unsplash.com/';
      var listingImageMap = {
        schnitzel: ['photo-1546069901-d5bfd2cbfb1f?w=400&q=80','photo-1565299624946-b28f40a0ae38?w=400&q=80','photo-1603133872878-684f208fb84b?w=400&q=80'],
        gulasch: ['photo-1547592166-23ac45744acd?w=400&q=80','photo-1544025162-d76694265947?w=400&q=80','photo-1565299624946-b28f40a0ae38?w=400&q=80'],
        roulade: ['photo-1603133872878-684f208fb84b?w=400&q=80','photo-1546069901-d5bfd2cbfb1f?w=400&q=80','photo-1544025162-d76694265947?w=400&q=80'],
        leberkaese: ['photo-1565299624946-b28f40a0ae38?w=400&q=80','photo-1546069901-d5bfd2cbfb1f?w=400&q=80','photo-1603133872878-684f208fb84b?w=400&q=80'],
        linsen: ['photo-1547592166-23ac45744acd?w=400&q=80','photo-1544025162-d76694265947?w=400&q=80','photo-1546069901-eacef0df6022?w=400&q=80'],
        kaesespaetzle: ['photo-1551183053-bf91a1d81141?w=400&q=80','photo-1546069901-d5bfd2cbfb1f?w=400&q=80','photo-1565299624946-b28f40a0ae38?w=400&q=80'],
        frikadelle: ['photo-1565299624946-b28f40a0ae38?w=400&q=80','photo-1546069901-d5bfd2cbfb1f?w=400&q=80','photo-1603133872878-684f208fb84b?w=400&q=80'],
        currywurst: ['photo-1565299624946-b28f40a0ae38?w=400&q=80','photo-1546069901-d5bfd2cbfb1f?w=400&q=80','photo-1603133872878-684f208fb84b?w=400&q=80'],
        default_meat: ['photo-1546069901-d5bfd2cbfb1f?w=400&q=80','photo-1603133872878-684f208fb84b?w=400&q=80','photo-1544025162-d76694265947?w=400&q=80'],
        default_veggie: ['photo-1546069901-eacef0df6022?w=400&q=80','photo-1512621776951-a57141f2e7ef?w=400&q=80','photo-1546069901-d5bfd2cbfb1f?w=400&q=80'],
        default_vegan: ['photo-1546069901-eacef0df6022?w=400&q=80','photo-1512621776951-a57141f2e7ef?w=400&q=80','photo-1546069901-d5bfd2cbfb1f?w=400&q=80'],
        default_salat: ['photo-1512621776951-a57141f2e7ef?w=400&q=80','photo-1546069901-eacef0df6022?w=400&q=80','photo-1546069901-d5bfd2cbfb1f?w=400&q=80']
      };
      function getListingSuggestionKey(){
        var text = (w.data.dish||'').toLowerCase().trim();
        var cat = w.data.category || 'Fleisch';
        for(var k in listingImageMap){ if(k.indexOf('default_')===0) continue; if(text.indexOf(k)!==-1) return k; }
        if(cat==='Fleisch') return 'default_meat'; if(cat==='Vegetarisch'||cat==='Vegan') return 'default_veggie'; if(cat==='Salat') return 'default_salat'; return 'default_meat';
      }
      function getListingSuggestionUrls(){
        var key = w.data.photoSuggestionKey || getListingSuggestionKey();
        var list = listingImageMap[key];
        if(!list) return [];
        var base = LISTING_IMAGES_BASE;
        return list.map(function(f){ return (f.indexOf('http')===0||f.indexOf('data:')===0) ? f : (base + f); });
      }
      function listingSuggestionsVisible(){ var cat = w.data.category; return !!cat || (w.data.photoSuggestionKey && listingImageMap[w.data.photoSuggestionKey]); }

      // 1. HERO – randlos oben (Edge-to-Edge), fixierter Header, 190px, Universal-X
      const photoTile=document.createElement('div');
      photoTile.className='inserat-photo-tile photo-header';
      photoTile.style.cssText='position:relative; overflow:hidden; flex-shrink:0; width:100%;';
      var closeX=document.createElement('div');
      closeX.className='close-wizard-x';
      closeX.setAttribute('role','button');
      closeX.setAttribute('aria-label','Schließen');
      if(w.data.photoData){
        photoTile.innerHTML='<img src="'+w.data.photoData+'" style="width:100%; height:100%; object-fit:cover; display:block;" alt=""><button type="button" class="inserat-photo-change" aria-label="Foto ändern"><i data-lucide="camera" style="width:14px;height:14px;stroke-width:2.5;"></i> 📷 Foto ändern</button>';
        const rem=photoTile.querySelector('.inserat-photo-change');
        if(rem) rem.onclick=(e)=>{ e.stopPropagation(); hapticLight(); w.data.photoData=''; w.data.photoDataIsStandard=false; saveDraft(); rebuildWizard(); };
      } else {
        var urls = getListingSuggestionUrls();
        var showSuggestions = listingSuggestionsVisible() && urls.length;
        var suggestionRow = '<div class="inserat-photo-suggestions-wrap" style="display:flex;gap:15px;justify-content:center;align-items:center;margin-top:8px;transition:opacity 0.3s;opacity:'+(showSuggestions ? '1' : '0')+';pointer-events:'+(showSuggestions ? 'auto' : 'none')+';"><span class="inserat-photo-placeholder-icon">📸</span><button type="button" class="inserat-photo-change" aria-label="Foto hinzufügen"><i data-lucide="camera" style="width:14px;height:14px;stroke-width:2.5;"></i> FOTO HINZUFÜGEN</button>';
        if(urls.length) for(var si=0;si<urls.length;si++) suggestionRow += '<img class="photo-suggestion" src="'+urls[si]+'" alt="" data-suggestion-index="'+si+'" style="width:60px;height:60px;object-fit:cover;border-radius:12px;">';
        suggestionRow += '</div>';
        photoTile.innerHTML='<div class="inserat-photo-placeholder" style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px;box-sizing:border-box;">'+suggestionRow+'</div>';
        var addBtn=photoTile.querySelector('.inserat-photo-change');
        if(addBtn) addBtn.onclick=async function(e){ e.stopPropagation(); hapticLight(); const f=await pickImage(); if(!f) return; let dataUrl=await toDataUrl(f); if(typeof applyAppetizerFilter==='function') dataUrl=await applyAppetizerFilter(dataUrl); if(typeof openPhotoEditor==='function') dataUrl=await openPhotoEditor(dataUrl, { onAccept: function(){} }); w.data.photoData=dataUrl; w.data.photoDataIsStandard=false; saveDraft(); rebuildWizard(); };
        photoTile.querySelectorAll('.photo-suggestion').forEach(function(img,idx){ img.onclick=function(e){ e.stopPropagation(); hapticLight(); var u=getListingSuggestionUrls()[idx]; if(u) w.data.photoData=u; w.data.photoDataIsStandard=true; saveDraft(); rebuildWizard(); }; });
        photoTile.onclick=async function(ev){ if(ev.target.closest('.inserat-photo-change')||ev.target.closest('.photo-suggestion')) return; hapticLight(); const f=await pickImage(); if(!f) return; let dataUrl=await toDataUrl(f); if(typeof applyAppetizerFilter==='function') dataUrl=await applyAppetizerFilter(dataUrl); if(typeof openPhotoEditor==='function') dataUrl=await openPhotoEditor(dataUrl, { onAccept: function(){} }); w.data.photoData=dataUrl; w.data.photoDataIsStandard=false; saveDraft(); rebuildWizard(); };
      }
      photoTile.appendChild(closeX);
      var priceStickerInserat=document.createElement('div');
      priceStickerInserat.className='inserat-price-on-image price-pill';
      priceStickerInserat.style.cssText='position:absolute; bottom:8px; right:8px; padding:6px 12px; border-radius:999px; font-weight:900; font-size:14px; background:rgba(255,215,0,0.95); color:#1a1a1a; box-shadow:0 2px 8px rgba(255,215,0,0.3); z-index:10;';
      priceStickerInserat.textContent=(Number(w.data.price)||0).toFixed(2).replace('.',',')+' €';
      photoTile.appendChild(priceStickerInserat);
      var selectionOverlay=document.createElement('div');
      selectionOverlay.className='selection-overlay';
      var selectionOverlayInner=document.createElement('div');
      selectionOverlayInner.className='selection-overlay-inner';
      selectionOverlay.appendChild(selectionOverlayInner);
      photoTile.appendChild(selectionOverlay);
      function closeHeaderSelection(){ hapticLight(); photoTile.classList.remove('is-selecting'); }
      function renderSelectionContent(type){
        selectionOverlayInner.innerHTML='';
        selectionOverlayInner.classList.remove('selection-overlay-inner--time');
        if(type==='allergens'){
          (typeof ALLERGENS_14!=='undefined'?ALLERGENS_14:[]).forEach(function(a){
            var code=a.short; var name=a.name||code; var active=(w.data.allergens||[]).includes(code);
            var emo=(typeof ALLERGEN_EMOJI!=='undefined'&&ALLERGEN_EMOJI[code])?ALLERGEN_EMOJI[code]:'';
            var pill=document.createElement('button'); pill.type='button'; pill.className='extra-pill inserat-allergen-pill' + (active ? ' active' : ''); pill.style.cssText='cursor:pointer;'; pill.textContent=(emo ? emo + ' ' : '') + name; pill.title=name;
            pill.onclick=function(){ hapticLight(); if(!w.data.allergens) w.data.allergens=[]; if(active){ w.data.allergens=w.data.allergens.filter(function(x){ return x!==code; }); } else{ w.data.allergens.push(code); } w.data.wantsAllergens=true; saveDraft(); pill.className='extra-pill inserat-allergen-pill' + ((w.data.allergens||[]).includes(code) ? ' active' : ''); var bar=photoTile.nextElementSibling; if(bar){ var fb=bar.querySelectorAll('.func-icon-btn'); if(fb[0]) fb[0].className='func-icon-btn ' + (!!(w.data.allergens&&w.data.allergens.length) ? 'active' : ''); } };
            selectionOverlayInner.appendChild(pill);
          });
        } else if(type==='extras'){
          var defaultExtras = [{ name:'Beilagensalat', price:2.5 }, { name:'Mayo', price:0.5 }, { name:'Ketchup', price:0.5 }, { name:'Soße', price:1 }, { name:'Brot', price:1.5 }];
          if(!Array.isArray(w.data.extras)) w.data.extras=[];
          defaultExtras.forEach(function(opt){
            var ex=w.data.extras.find(function(e){ return e.name===opt.name; }); var active=!!ex && Number(ex.price||0)>0; if(!ex) ex={ name:opt.name, price:0 };
            var pillWrap=document.createElement('div'); pillWrap.style.cssText='display:flex; align-items:center; gap:6px;';
            var btn=document.createElement('button'); btn.type='button'; btn.className='extra-pill' + (active ? ' active' : ''); btn.style.cssText='cursor:pointer;'; btn.textContent='➕ ' + opt.name;
            btn.onclick=function(){ hapticLight(); var idx=w.data.extras.findIndex(function(e){ return e.name===opt.name; }); if(idx>=0){ w.data.extras.splice(idx,1); } else{ w.data.extras.push({ name:opt.name, price:opt.price }); } saveDraft(); var hasEx=!!w.data.extras.find(function(e){ return e.name===opt.name; }) && Number((w.data.extras.find(function(e){ return e.name===opt.name; })||{}).price||0)>0; btn.className='extra-pill' + (hasEx ? ' active' : ''); var bar=photoTile.nextElementSibling; if(bar){ var fb=bar.querySelectorAll('.func-icon-btn'); if(fb[1]) fb[1].className='func-icon-btn ' + (!!(w.data.extras&&w.data.extras.length) ? 'active' : ''); } if(pillWrap.querySelector('input')){ var next=w.data.extras.find(function(e){ return e.name===opt.name; }); if(next&&Number(next.price||0)>0){ pillWrap.querySelector('input').value=Number(next.price).toFixed(2).replace('.',','); } else { var inpWrap=pillWrap.querySelector('span'); if(inpWrap) inpWrap.remove(); } } else if(hasEx){ var inpWrap=document.createElement('span'); inpWrap.style.cssText='display:inline-flex; align-items:center; background:rgba(255,255,255,0.6); border-radius:999px; padding:4px 8px;'; var plus=document.createElement('span'); plus.style.cssText='font-size:10px; font-weight:800; color:#10b981; margin-right:4px;'; plus.textContent='+'; var inp=document.createElement('input'); inp.type='text'; inp.inputMode='decimal'; inp.style.cssText='width:36px; background:transparent; border:none; padding:0; font-size:12px; font-weight:800; color:#10b981; outline:none;'; var e=w.data.extras.find(function(x){ return x.name===opt.name; }); inp.value=Number((e&&e.price)||0).toFixed(2).replace('.',','); inp.oninput=function(){ if(e) e.price=parseFloat((inp.value||'0').replace(',','.'))||0; saveDraft(); }; inp.onclick=function(ev){ ev.stopPropagation(); }; var eur=document.createElement('span'); eur.style.cssText='font-size:10px; font-weight:800; color:#10b981; margin-left:2px;'; eur.textContent='€'; inpWrap.appendChild(plus); inpWrap.appendChild(inp); inpWrap.appendChild(eur); pillWrap.appendChild(inpWrap); } };
            pillWrap.appendChild(btn);
            if(active){ var inpWrap=document.createElement('span'); inpWrap.style.cssText='display:inline-flex; align-items:center; background:rgba(255,255,255,0.6); border-radius:999px; padding:4px 8px;'; var plus=document.createElement('span'); plus.style.cssText='font-size:10px; font-weight:800; color:#10b981; margin-right:4px;'; plus.textContent='+'; var inp=document.createElement('input'); inp.type='text'; inp.inputMode='decimal'; inp.style.cssText='width:36px; background:transparent; border:none; padding:0; font-size:12px; font-weight:800; color:#10b981; outline:none;'; inp.value=Number(ex.price).toFixed(2).replace('.',','); inp.oninput=function(){ ex.price=parseFloat((inp.value||'0').replace(',','.'))||0; saveDraft(); }; inp.onclick=function(ev){ ev.stopPropagation(); }; var eur=document.createElement('span'); eur.style.cssText='font-size:10px; font-weight:800; color:#10b981; margin-left:2px;'; eur.textContent='€'; inpWrap.appendChild(plus); inpWrap.appendChild(inp); inpWrap.appendChild(eur); pillWrap.appendChild(inpWrap); }
            selectionOverlayInner.appendChild(pillWrap);
          });
        } else if(type==='time'){
          selectionOverlayInner.classList.add('selection-overlay-inner--time');
          var pwParts=(w.data.pickupWindow||'11:30 – 14:00').split(/\s*[–\-]\s*/);
          var tStart=(pwParts[0]||'11:30').trim();
          var tEnd=(pwParts[1]||'14:00').trim();
          if(tStart.length===4) tStart='0'+tStart;
          if(tEnd.length===4) tEnd='0'+tEnd;
          var row=document.createElement('div'); row.className='inserat-time-morph-row'; row.style.cssText='display:flex; align-items:center; justify-content:center; gap:12px; flex-wrap:wrap; padding:16px;';
          var inpStart=document.createElement('input'); inpStart.type='time'; inpStart.className='inserat-pickup-time-input'; inpStart.value=tStart; inpStart.style.cssText='padding:10px 14px; border-radius:12px; border:2px solid rgba(0,0,0,0.08); background:rgba(255,255,255,0.7); backdrop-filter:blur(10px); font-size:16px; font-weight:700;';
          var inpEnd=document.createElement('input'); inpEnd.type='time'; inpEnd.className='inserat-pickup-time-input'; inpEnd.value=tEnd; inpEnd.style.cssText='padding:10px 14px; border-radius:12px; border:2px solid rgba(0,0,0,0.08); background:rgba(255,255,255,0.7); backdrop-filter:blur(10px); font-size:16px; font-weight:700;';
          var upd=function(){ w.data.pickupWindow=inpStart.value+' – '+inpEnd.value; saveDraft(); var bar=photoTile.nextElementSibling; if(bar){ var pills=bar.querySelectorAll('.status-pill'); if(pills[2]) pills[2].className='status-pill active'; } };
          inpStart.onchange=function(){ hapticLight(); upd(); };
          inpEnd.onchange=function(){ hapticLight(); upd(); };
          row.appendChild(inpStart);
          row.appendChild(document.createTextNode(' – '));
          row.appendChild(inpEnd);
          var btnFertig=document.createElement('button'); btnFertig.type='button'; btnFertig.textContent='Fertig'; btnFertig.style.cssText='padding:10px 20px; border-radius:999px; border:none; background:#10b981; color:#fff; font-weight:700; cursor:pointer; margin-left:8px;'; btnFertig.onclick=function(){ hapticLight(); closeHeaderSelection(); rebuildWizard(); };
          row.appendChild(btnFertig);
          selectionOverlayInner.appendChild(row);
        }
      }
      function toggleHeaderSelection(type){ hapticLight(); renderSelectionContent(type); photoTile.classList.add('is-selecting'); }
      closeX.onclick=function(){ if(photoTile.classList.contains('is-selecting')){ hapticLight(); closeHeaderSelection(); } else { try{ if(typeof haptic==='function') haptic(15); else if(navigator.vibrate) navigator.vibrate(15); }catch(e){} closeWizard(); } };
      /* Keyboard-Avoidance: Header schrumpft bei Fokus auf Titel/Preis [cite: 2026-02-16] */
      function bindKeyboardAvoidance(){
        var panel=box;
        if(!panel) return;
        function addActive(){ panel.classList.add('inserat-keyboard-active'); }
        function removeActive(){ panel.classList.remove('inserat-keyboard-active'); }
        var titleInput=panel.querySelector('#step-name .inserat-detail-style-title, #step-name input.magnet-input');
        var priceInput=panel.querySelector('#step-price input.inserat-price-fintech, #step-price .inserat-price-input');
        if(titleInput){ titleInput.addEventListener('focus', addActive); titleInput.addEventListener('blur', removeActive); }
        if(priceInput){ priceInput.addEventListener('focus', addActive); priceInput.addEventListener('blur', removeActive); }
      }
      box.appendChild(photoTile);

      // 2. Unified Power-Bar: [Vor Ort] [Mehrweg] [Zeit] [Allergene] [Extras] – eine Leiste unter dem Foto-Header
      var pwParts=(w.data.pickupWindow||profileWindow).split(/\s*[–\-]\s*/);
      var timeStart=(pwParts[0]||'11:30').trim();
      var timeEnd=(pwParts[1]||'14:00').trim();
      if(timeStart.length===4) timeStart='0'+timeStart;
      if(timeEnd.length===4) timeEnd='0'+timeEnd;
      const powerBar=document.createElement('div');
      powerBar.className='inserat-power-bar inserat-unified-pills';
      powerBar.style.cssText='display:flex; flex-wrap:wrap; justify-content:center; align-items:center; gap:10px 16px; padding:12px 20px; border-bottom:1px solid rgba(0,0,0,0.04); flex-shrink:0; background:rgba(0,0,0,0.02);';
      var hasDineIn = !!w.data.dineInPossible;
      var hasReuse = !!(w.data.reuse && w.data.reuse.enabled);
      function addPowerPill(emo, label, active, toggleKey){
        const wrap=document.createElement('button');
        wrap.type='button';
        wrap.className='status-pill '+(active?'active':'inactive');
        wrap.setAttribute('aria-label', label);
        wrap.setAttribute('title', label);
        wrap.innerHTML='<span style="font-size:18px;">'+emo+'</span>';
        wrap.onclick=()=>{ hapticLight(); if(toggleKey==='reuse'){ w.data.reuse=w.data.reuse||{}; w.data.reuse.enabled=!w.data.reuse.enabled; } else w.data[toggleKey]=!w.data[toggleKey]; saveDraft(); rebuildWizard(); };
        powerBar.appendChild(wrap);
      }
      addPowerPill('🍴','Vor Ort', hasDineIn, 'dineInPossible');
      addPowerPill('🔄','Mehrweg', hasReuse, 'reuse');
      const hasTimeValue=!!(w.data.pickupWindow&&w.data.pickupWindow.trim())||(w.data.mealStart&&w.data.mealEnd);
      const timePill=document.createElement('button');
      timePill.type='button';
      timePill.className='status-pill '+(hasTimeValue?'active':'inactive');
      timePill.setAttribute('aria-label','Abholzeit bearbeiten');
      timePill.setAttribute('title','Zeit');
      timePill.innerHTML='<span style="font-size:18px;">🕒</span>';
      timePill.onclick=()=>{ toggleHeaderSelection('time'); };
      powerBar.appendChild(timePill);
      const hasAllergens=!!(w.data.allergens&&w.data.allergens.length);
      const allergenBarBtn=document.createElement('button');
      allergenBarBtn.type='button';
      allergenBarBtn.className='func-icon-btn ' + (hasAllergens ? 'active' : '');
      allergenBarBtn.textContent='🌾';
      allergenBarBtn.title='Allergene';
      allergenBarBtn.onclick=function(){ toggleHeaderSelection('allergens'); };
      powerBar.appendChild(allergenBarBtn);
      const hasExtras=!!(w.data.extras&&w.data.extras.length);
      const extrasBarBtn=document.createElement('button');
      extrasBarBtn.type='button';
      extrasBarBtn.className='func-icon-btn ' + (hasExtras ? 'active' : '');
      extrasBarBtn.textContent='➕';
      extrasBarBtn.title='Extras';
      extrasBarBtn.onclick=function(){ toggleHeaderSelection('extras'); };
      powerBar.appendChild(extrasBarBtn);
      var legendWrap=document.createElement('div'); legendWrap.style.cssText='position:relative; display:inline-flex; align-items:center;';
      var legendTrigger=document.createElement('button'); legendTrigger.type='button'; legendTrigger.className='power-bar-legend-trigger'; legendTrigger.setAttribute('aria-label','Infoseite Inseratsflow'); legendTrigger.setAttribute('title','Infoseite: Inserieren in unter 30 Sekunden'); legendTrigger.textContent='ⓘ'; legendTrigger.style.cssText='min-width:44px; min-height:44px; width:44px; height:44px; border:none; background:transparent; color:#94a3b8; font-size:14px; cursor:pointer; border-radius:50%; display:flex; align-items:center; justify-content:center; -webkit-tap-highlight-color:transparent;';
      var legendPop=document.createElement('div'); legendPop.className='power-bar-legend'; legendPop.setAttribute('role','tooltip'); legendPop.style.cssText='display:none; position:absolute; top:100%; right:0; margin-top:6px; padding:10px 14px; background:rgba(255,255,255,0.95); backdrop-filter:blur(12px); border-radius:12px; border:1px solid rgba(0,0,0,0.06); box-shadow:0 8px 24px rgba(0,0,0,0.1); font-size:11px; font-weight:600; color:#475569; line-height:1.5; z-index:50; white-space:nowrap;';
      legendPop.innerHTML='🍴 Vor Ort · 🔄 Mehrweg · 🕒 Zeit · 🌾 Allergene · ➕ Extras';
      legendTrigger.onclick=function(e){ e.stopPropagation(); hapticLight(); if(typeof showLegalPage==='function'){ showLegalPage('inserat-info-provider'); } else { var on=legendPop.style.display==='block'; legendPop.style.display=on?'none':'block'; if(!on) setTimeout(function(){ var closeLegend=function(ev){ if(!legendWrap.contains(ev.target)){ legendPop.style.display='none'; document.removeEventListener('click', closeLegend); } }; document.addEventListener('click', closeLegend); }, 0); } };
      legendWrap.appendChild(legendTrigger); legendWrap.appendChild(legendPop); powerBar.appendChild(legendWrap);
      box.appendChild(powerBar);

      const scrollArea=document.createElement('div');
      scrollArea.className='inserat-scroll-area scroll-content';

      // Titel wie Detailseite: „Was kochst du heute?“ + pulsierende Emerald-Unterlinie
      const stepName=document.createElement('div');
      stepName.id='step-name';
      stepName.className='inserat-section inserat-unified-title-wrap';
      const dishDatalist=document.createElement('datalist');
      dishDatalist.id='inserat-dish-datalist';
      const dishSuggestions = ['Kürbissuppe','Kartoffelsuppe','Tomatensuppe','Linsensuppe','Schnitzel','Gulasch','Käsespätzle','Pasta','Pizza','Wrap','Burger','Falafel','Lachs','Sushi','Thunfisch','Salat','Curry','Gemüsepfanne','Risotto','Lasagne'];
      dishSuggestions.forEach(function(name){ const o=document.createElement('option'); o.value=name; dishDatalist.appendChild(o); });
      stepName.appendChild(dishDatalist);
      const inputDish=document.createElement('input');
      inputDish.type='text';
      inputDish.className='inserat-detail-style-title magnet-input';
      inputDish.placeholder='Was kochst du heute?';
      inputDish.value=w.data.dish||'';
      inputDish.setAttribute('list','inserat-dish-datalist');
      inputDish.autocomplete='off';
      inputDish.oninput=()=>{
        w.data.dish=inputDish.value; saveDraft();
        if(listingDebounceTimer) clearTimeout(listingDebounceTimer);
        listingDebounceTimer=setTimeout(function(){
          listingDebounceTimer=null;
          var catSugg=getCategorySuggestionForDish(inputDish.value);
          if(catSugg&&['Fleisch','Vegetarisch','Vegan','Salat'].indexOf(catSugg)>=0){ w.data.category=catSugg; saveDraft(); }
          var suggested=getAllergenSuggestionsForDish(inputDish.value);
          if(suggested.length&&(!w.data.allergens||w.data.allergens.length===0)){ w.data.allergens=suggested.slice(); w.data.wantsAllergens=true; saveDraft(); }
          var descSugg=getDescriptionSuggestionForDish(inputDish.value);
          if(descSugg&&(!w.data.description||!w.data.description.trim())){ w.data.description=descSugg; saveDraft(); }
          rebuildWizard();
        }, 400);
      };
      inputDish.onblur=()=>{
        dismissKeyboard(); hapticLight();
        var catSugg=getCategorySuggestionForDish(inputDish.value);
        if(catSugg&&['Fleisch','Vegetarisch','Vegan','Salat'].indexOf(catSugg)>=0){ w.data.category=catSugg; saveDraft(); }
        var suggested=getAllergenSuggestionsForDish(inputDish.value);
        if(suggested.length&&(!w.data.allergens||w.data.allergens.length===0)){ w.data.allergens=suggested.slice(); w.data.wantsAllergens=true; saveDraft(); rebuildWizard(); }
      };
      stepName.appendChild(inputDish);
      const wrapDesc=document.createElement('div');
      wrapDesc.className='inserat-airbnb-field-wrap inserat-airbnb-desc-wrap inserat-desc-italic-wrap';
      wrapDesc.style.marginTop='0';
      const inputDesc=document.createElement('input');
      inputDesc.type='text';
      inputDesc.className='liquid-input liquid-input-focus inserat-desc-input inserat-airbnb-desc inserat-desc-italic';
      inputDesc.placeholder='… z.B. mit frischem saisonalen Gemüse …';
      inputDesc.value=w.data.description||'';
      inputDesc.oninput=()=>{ w.data.description=inputDesc.value; saveDraft(); };
      inputDesc.onblur=()=>{ dismissKeyboard(); hapticLight(); };
      wrapDesc.appendChild(inputDesc);
      stepName.appendChild(wrapDesc);
      scrollArea.appendChild(stepName);

      // Goldene Sammelkarte: Kategorie-Pills + Preis-Pill in einer Zeile (Preis rechtsbündig) [cite: 2026-02-16]
      const catPriceRow=document.createElement('div');
      catPriceRow.className='inserat-cat-price-row';
      catPriceRow.id='step-cat';
      const catValues = ['Fleisch','Vegetarisch','Vegan','Salat'];
      const catDisplayLabels = ['Mit Fleisch','Vegetarisch','Vegan','Salat'];
      const catEmojis = ['🥩','🥗','🌱','🥪'];
      const currentCat = w.data.category || 'Fleisch';
      if(!catValues.includes(currentCat)) w.data.category = 'Fleisch';
      const stepCat=document.createElement('div');
      stepCat.className='inserat-cat-pills';
      stepCat.style.display='flex'; stepCat.style.flexWrap='wrap'; stepCat.style.gap='8px';
      catValues.forEach((c,i)=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='extra-pill inserat-cat-pill' + (w.data.category===c ? ' active' : '');
        b.style.cssText='flex:0 0 auto; cursor:pointer;';
        b.textContent=(catEmojis[i]||'')+' '+catDisplayLabels[i];
        b.onclick=()=>{ hapticLight(); w.data.category=c; saveDraft(); rebuildWizard(); };
        stepCat.appendChild(b);
      });
      catPriceRow.appendChild(stepCat);
      const stepPriceWrap=document.createElement('div');
      stepPriceWrap.id='step-price';
      stepPriceWrap.className='inserat-price-pill-wrap';
      const inputPrice=document.createElement('input');
      inputPrice.type='text';
      inputPrice.className='inserat-price-pill-input inserat-price-fintech inserat-price-input';
      inputPrice.setAttribute('inputmode','decimal');
      inputPrice.placeholder='0,00';
      inputPrice.value=(w.data.price>0?Number(w.data.price).toFixed(2).replace('.',','):'');
      const updateProfit = function(val){
        var p = (parseFloat(String(val).replace(',','.')) || 0) * 30;
        var calcVal = document.getElementById('calc-val');
        if(calcVal) calcVal.textContent = p.toFixed(2).replace('.',',');
      };
      inputPrice.oninput=()=>{ var v=inputPrice.value.replace(',','.'); w.data.price=parseFloat(v)||0; saveDraft(); updateProfit(v); if(priceStickerInserat) priceStickerInserat.textContent=(Number(w.data.price)||0).toFixed(2).replace('.',',')+' €'; hapticLight(); };
      inputPrice.onblur=()=>{ if(w.data.price>0) inputPrice.value=Number(w.data.price).toFixed(2).replace('.',','); dismissKeyboard(); hapticLight(); };
      stepPriceWrap.appendChild(inputPrice);
      var eurSpan=document.createElement('span'); eurSpan.className='inserat-price-pill-euro'; eurSpan.textContent=' €'; stepPriceWrap.appendChild(eurSpan);
      catPriceRow.appendChild(stepPriceWrap);
      scrollArea.appendChild(catPriceRow);
      var p0=Number(w.data.price)||0;
      const prognoseWrap=document.createElement('div');
      prognoseWrap.className='inserat-prognose-wrap inserat-earnings inserat-umsatzprognose';
      prognoseWrap.innerHTML='<p style="margin:0; font-size:12px; font-weight:600; color:#94a3b8;">Umsatzprognose: <span id="calc-val">'+(p0*30).toFixed(2).replace('.',',')+'</span> €</p>';
      scrollArea.appendChild(prognoseWrap);
      if(w.ctx && w.ctx.isLeberkaeseOnboarding) prognoseWrap.classList.add('inserat-onboarding-price-pulse');


      box.appendChild(scrollArea);

      // 9. ACTION BUTTONS (sticky am unteren Rand – Referenz: gelb + grüner Rahmen, eine Zeile)
      var entryPoint = (w.ctx && w.ctx.entryPoint) || 'dashboard';
      var isInserierenRoute = (entryPoint === 'dashboard');
      var hasDish = !!(w.data.dish && String(w.data.dish).trim());
      var hasPrice = Number(w.data.price) > 0;
      var primaryValid = hasDish && hasPrice;

      const actionSection=document.createElement('section');
      actionSection.id='inserat-action-section';
      actionSection.className='inserat-action-section fixed-footer' + (isInserierenRoute ? ' inserat-action-pricing' : '');

      if(isInserierenRoute){
        var isLeberkaeseOnboarding = !!(w.ctx && w.ctx.isLeberkaeseOnboarding);
        var pricingLabel=document.createElement('div');
        pricingLabel.className='pricing-info-label' + (isLeberkaeseOnboarding ? ' inserat-onboarding-tooltip' : '');
        pricingLabel.setAttribute('role','button');
        pricingLabel.setAttribute('aria-label','Preisübersicht anzeigen');
        if(isLeberkaeseOnboarding) pricingLabel.setAttribute('data-tooltip','Hier kriegst du volle Transparenz');
        pricingLabel.textContent='Preisübersicht ⓘ';
        pricingLabel.onclick=function(e){ e.preventDefault(); e.stopPropagation(); hapticLight(); if(typeof openPricingFairnessOverlay==='function') openPricingFairnessOverlay(); };
        actionSection.appendChild(pricingLabel);
        const btnGratis=document.createElement('button');
        btnGratis.type='button';
        btnGratis.className='inserat-btn-primary inserat-btn-emerald';
        btnGratis.textContent='mit Abholnummer';
        btnGratis.onclick=function(){
          if(!primaryValid){ if(typeof showToast==='function') showToast('Bitte Gericht und Preis eingeben'); return; }
          if(btnGratis.classList.contains('is-loading')) return;
          if(typeof haptic==='function') haptic([30, 50, 30]);
          w.data.hasPickupCode=true; w.data.inseratFeeWaived=true; w.data.pricingOption='abholnummer';
          var o=previewOfferFromWizard();
          btnGratis.classList.add('is-loading');
          btnGratis.innerHTML='<span class="inserat-btn-spinner"></span>';
          btnGratis.disabled=true;
          if(btn499) btn499.disabled=true;
          setTimeout(function(){
            closeWizard(true);
            showPublishFeeModal(o);
          }, 800);
        };
        actionSection.appendChild(btnGratis);
        const btn499=document.createElement('button');
        btn499.type='button';
        btn499.className='inserat-btn-secondary inserat-btn-yellow-border';
        btn499.textContent='Nur Inserat';
        btn499.onclick=function(){ if(!primaryValid){ if(typeof showToast==='function') showToast('Bitte Gericht und Preis eingeben'); return; } if(btn499.disabled) return; if(typeof haptic==='function') haptic([30, 50, 30]); w.data.hasPickupCode=false; w.data.pricingOption=undefined; w.data.inseratFeeWaived=false; var o=previewOfferFromWizard(); closeWizard(true); showPublishFeeModal(o); };
        actionSection.appendChild(btn499);
      } else {
        const btnSave=document.createElement('button');
        btnSave.type='button';
        btnSave.style.cssText='width:100%; padding:20px; background:#10b981; color:#fff; font-size:16px; font-weight:800; border:none; border-radius:24px; cursor:pointer; box-shadow:0 10px 30px rgba(16,185,129,0.35); text-transform:uppercase;';
        btnSave.textContent=entryPoint==='cookbook' ? 'Im Kochbuch speichern' : 'Im Wochenplan speichern';
        btnSave.onclick=function(){
          if(!primaryValid){ if(typeof showToast==='function') showToast('Bitte Gericht und Preis eingeben'); return; }
          if(typeof haptic==='function') haptic(50);
          if(entryPoint==='cookbook'){
            var id=saveToCookbookFromWizard();
            if(id){
              closeWizard(true);
              showSaveSuccessSheet({
                title:'Im Kochbuch gespeichert',
                sub:'Dein Gericht ist in deinem Kochbuch.',
                dishName: w.data.dish||'',
                price: w.data.price,
                imageUrl: w.data.photoData||'',
                savedEntryId: id,
                savedDay: null,
                onFertig: function(){ if(typeof showToast==='function') showToast('Im Kochbuch gespeichert'); if(typeof showProviderCookbook==='function') showProviderCookbook(); },
                onLive: null
              });
            }
          }
          else if(entryPoint==='week'){
            var id=saveToCookbookFromWizard();
            if(id && w.data.day){
              if(!week[w.data.day]) week[w.data.day]=[];
              var c=cookbook.find(function(x){ return x.id===id; });
              if(c) week[w.data.day].push({ providerId:c.providerId, cookbookId:c.id, dish:c.dish, price:c.price });
              save(LS.week, week);
              closeWizard(true);
              showSaveSuccessSheet({
                title:'Im Wochenplan gespeichert',
                sub:'Dein Gericht ist im Wochenplan eingetragen.',
                dishName: w.data.dish||'',
                price: w.data.price,
                imageUrl: w.data.photoData||'',
                savedEntryId: id,
                savedDay: w.data.day,
                onFertig: function(){ if(typeof showToast==='function') showToast('Im Wochenplan gespeichert'); if(typeof showProviderWeek==='function') showProviderWeek(); },
                onLive: null
              });
            }
          }
        };
        actionSection.appendChild(btnSave);
      }
      box.appendChild(actionSection);

      if(w.ctx && w.ctx.isLeberkaeseOnboarding){
        box.style.position = 'relative';
        var overlay = document.createElement('div');
        overlay.className = 'inserat-onboarding-overlay';
        overlay.setAttribute('role','dialog');
        overlay.setAttribute('aria-label','Erstes Inserat');
        overlay.innerHTML = '<div class="inserat-onboarding-card"><p>Dein erstes Inserat ist bereit. Probier es kurz aus!</p><button type="button" class="inserat-onboarding-btn">Probier es aus</button></div>';
        var btn = overlay.querySelector('.inserat-onboarding-btn');
        if(btn) btn.onclick = function(){ hapticLight(); overlay.classList.add('is-dismissed'); };
        box.appendChild(overlay);
      }

      bindKeyboardAvoidance();
      setWizardContent(box);
      // Guided Interaction: leere Karte → Fokus Namensfeld (blinkender Cursor), kein Foto → Pulsieren [cite: 2026-01-29]
      setTimeout(function(){
        var isEmpty = !(w.data.dish && String(w.data.dish).trim()) && !w.data.photoData;
        var titleInput = box.querySelector('#step-name input.magnet-input, #step-name .inserat-detail-style-title');
        if(titleInput && isEmpty){ titleInput.focus(); }
        var photoEl = box.querySelector('.photo-header, .inserat-photo-tile');
        if(photoEl && !w.data.photoData) photoEl.classList.add('inserat-card-photo-pulse');
      }, 300);
      return;
    }

  }

  function previewOfferFromWizard(){
    const p = normalizeProviderProfile(provider.profile||{});
    let pickupWindow = w.data.pickupWindow || p.mealWindow || DEFAULT_MEAL_WINDOW;
    if(w.data.mealStart && w.data.mealEnd) pickupWindow = w.data.mealStart + ' – ' + w.data.mealEnd;
    return {
      id: 'preview',
      providerId: providerId(),
      providerName: p.name || provider.email || 'Anbieter',
      providerStreet: p.street||'',
      providerZip: p.zip||'',
      providerCity: p.city||'',
      providerLogoData: p.logoData||'',
      dish: w.data.dish||'Gericht',
      description: w.data.description||'',
      category: w.data.category||'Vegetarisch',
      price: Number(w.data.price||0),
      pickupWindow,
      imageUrl: w.data.photoData || PLACEHOLDER_IMAGE_URL,
      imagePlaceholder: !w.data.photoData,
      photoDataIsStandard: !!w.data.photoDataIsStandard,
      hasPickupCode: !!w.data.hasPickupCode || w.data.pricingOption === 'abholnummer',
      dineInPossible: !!w.data.dineInPossible,
      allergens: w.data.allergens||[],
      extras: w.data.extras||[],
      reuse: w.data.reuse||{enabled:false,deposit:0},
      day: w.data.day || isoDate(new Date()),
      active: w.data.active !== false,
      pricingOption: w.data.pricingOption || null,
      inseratFeeWaived: !!w.data.inseratFeeWaived || w.data.pricingOption === 'abholnummer'
    };
  }

  // Transaktions-Schema (pro Inserat): id, vendor_id, base_price, addon_pickup, addon_price, total_amount, timestamp
  /** TRANSACTION LOGIC & TERMINOLOGY: Nur „Abholnummer“ (nie Ticket/Abholcode/Code). Abholnummer-Upsell nur nach Publish (Geld-Route), nicht bei stillem Speichern. */
  const TX_BASE_PRICE = 4.99;   // fixed_fee (Inseratsgebühr)
  const TX_ADDON_PRICE = 0.89; // abholnummer_fee pro Vorgang
  function createInseratTransaction(offer){
    const inseratWaived = !!(offer && offer.inseratFeeWaived);
    const base = inseratWaived ? 0 : TX_BASE_PRICE;
    const addon_pickup = !!(offer && offer.hasPickupCode);
    const addon_price = addon_pickup ? TX_ADDON_PRICE : 0;
    const total_amount = base + addon_price;
    const txId = 'TX-' + (typeof cryptoId === 'function' ? cryptoId().slice(0, 8) : Date.now().toString(36).toUpperCase());
    return {
      id: txId,
      vendor_id: offer && offer.providerId,
      inserat_id: offer && offer.id,
      base_price: base,
      addon_pickup: addon_pickup,
      addon_price: addon_price,
      total_amount: total_amount,
      inserat_fee_waived: inseratWaived,
      timestamp: new Date().toISOString()
    };
  }
  function loadTransactions(){ return load(LS.transactions, []); }

  /** Rechnung als Druckansicht öffnen (Nutzer kann „Als PDF speichern“ wählen). */
  function openReceiptPrint(t){
    if(!t) return;
    var datum = t.timestamp ? new Date(t.timestamp).toLocaleDateString('de-DE', { day:'2-digit', month:'2-digit', year:'numeric' }) : '–';
    var posten = t.inserat_id ? ('Inserat · ' + (t.inserat_id || '')) : 'Inseratsgebühr';
    var betrag = (t.total_amount != null) ? Number(t.total_amount).toFixed(2).replace('.', ',') + ' €' : '4,99 €';
    var rechnungsnr = (t.id || 'R-' + (t.timestamp || '').slice(0,10).replace(/-/g,'') || '') + '';
    var html = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Rechnung Mittagio</title><style>body{font-family:system-ui,-apple-system,sans-serif;padding:40px;max-width:420px;margin:0 auto;color:#1a1a1a;} h1{font-size:22px;font-weight:800;margin:0 0 8px;} .meta{color:#64748b;font-size:13px;line-height:1.5;margin-bottom:28px;} table{width:100%;border-collapse:collapse;} th{text-align:left;padding:10px 0;border-bottom:1px solid #e5e7eb;font-size:12px;font-weight:700;color:#64748b;text-transform:uppercase;} td{padding:10px 0;border-bottom:1px solid #e5e7eb;} tr:last-child td{border-bottom:none;} .total{font-weight:800;font-size:20px;color:#16a34a;} .foot{margin-top:32px;padding-top:20px;border-top:1px solid #e5e7eb;font-size:11px;color:#94a3b8;line-height:1.5;} .print-hint{margin-top:16px;font-size:13px;color:#0A84FF;} @media print{.print-hint{display:none;} body{padding:20px;}}</style></head><body>' +
      '<h1>Rechnung</h1>' +
      '<div class="meta">Rechnungsnummer: ' + rechnungsnr.replace(/</g,'&lt;') + '<br><br>Mittagio · Mike Quach<br>Langäcker 2, 73635 Rudersberg<br>info@mittagio.de</div>' +
      '<table><tr><th>Datum</th><td>' + datum + '</td></tr><tr><th>Posten</th><td>' + (posten || 'Inseratsgebühr 4,99 €').replace(/</g,'&lt;') + '</td></tr><tr><th>Betrag (zahlbar sofort)</th><td class="total">' + betrag + '</td></tr></table>' +
      '<p class="foot">Kein Abo. Kein Vertrag. · Einmalige Inseratsgebühr. · USt.-Nr. siehe Impressum auf mittagio.de</p><p class="print-hint">💡 Zum Speichern: Drucken → „Als PDF speichern“ wählen.</p>' +
      '</body></html>';
    var w = window.open('', '_blank', 'noopener');
    if(w){ w.document.write(html); w.document.close(); w.focus(); setTimeout(function(){ w.print(); }, 300); }
  }

  function saveTransaction(tx){
    const list = loadTransactions();
    list.unshift(tx);
    save(LS.transactions, list);
  }

  // E-Mail-Template „Dein Inserat ist live!“ – für Backend/Versand oder Kopieren
  function getInseratLiveEmailTemplate(offer){
    const o = offer ? normalizeOffer(offer) : {};
    const dishName = o.dish || o.dishName || o.title || 'Dein Gericht';
    const providerName = o.providerName || (provider && provider.profile && provider.profile.name) || 'Anbieter';
    const day = o.day || (typeof isoDate === 'function' ? isoDate(new Date()) : '');
    const offerUrl = typeof buildOfferShareUrl === 'function' ? buildOfferShareUrl(offer) : (window.location.origin + window.location.pathname + '#/offer/' + (o.id || ''));
    const subject = 'Dein Inserat ist live! 🚀';
    const body = 'Hallo ' + providerName + ',\n\n' +
      'dein Gericht „' + dishName + '“ ist ab sofort auf Mittagio sichtbar.\n\n' +
      '🔗 Link zum Angebot: ' + offerUrl + '\n' +
      '📅 Datum: ' + day + '\n\n' +
      'Viel Erfolg beim Verkaufen!\n\n' +
      'Dein Mittagio-Team';
    return { subject: subject, body: body, offerUrl: offerUrl };
  }

  function publishOffer(o){
    const existingId = w.ctx && w.ctx.editOfferId ? w.ctx.editOfferId : null;
    const id = existingId || cryptoId();
    const out = {...o, id, day: o.day || w.data.day || isoDate(new Date()), active: o.active !== false};
    var profile = normalizeProviderProfile(provider.profile || {});
    if(!out.providerStreet && (profile.street || profile.zip || profile.city)) {
      out.providerStreet = profile.street || '';
      out.providerZip = profile.zip || '';
      out.providerCity = profile.city || '';
      if(!out.providerStreet && (out.providerZip || out.providerCity)) out.providerStreet = buildAddress(out);
    }
    var hasAddress = !!(out.providerStreet && out.providerStreet.trim()) || (out.providerZip && out.providerCity);
    if(!hasAddress){
      showAddressRequiredModal();
      return null;
    }
    if(existingId){
      const idx = offers.findIndex(x=>x.id===existingId);
      if(idx>=0){
        const prev = offers[idx];
        offers[idx] = {...prev, ...out, id: prev.id, day: out.day, active: out.active};
      } else {
        offers.unshift(out);
      }
    } else {
      offers.unshift(out);
      var tx = createInseratTransaction(out);
      saveTransaction(tx);
    }
    save(LS.offers, offers);
    
    // Reset createFlowPreselectedDate
    createFlowPreselectedDate = null;
    // restore default next button handler
    setWizardNextDefault();
    
    // Ostereier: Feuerwerk-Icon bei erstem Inserat
    const isFirstOffer = !existingId && offers.filter(x => x.providerId === providerId()).length === 1;
    if(isFirstOffer){
      showToast('🎉 Dein erstes Inserat ist live!', 4000);
    } else {
      showToast(existingId ? 'Inserat aktualisiert' : 'Inserat veröffentlicht');
    }
    
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
    renderStart();
    return out;
  }

  var publishFeeSuccessCallback = null;

  function showPublishFeeModal(offer, onPublished = null){
    publishFeePendingOffer = offer;
    publishFeeSuccessCallback = onPublished;
    const amountEl = document.getElementById('publishFeeAmount');
    const hintEl = document.getElementById('publishFeeAmountHint');
    if(amountEl){
      if(offer && (offer.inseratFeeWaived || offer.pricingOption === 'abholnummer')){
        amountEl.textContent = '0,00 €';
        if(hintEl) hintEl.textContent = 'Inserat kostenlos – Abholnummer 0,89 € pro Vorgang';
      } else if(offer && typeof offer.price === 'number' && offer.price !== 4.99){
        amountEl.textContent = (typeof euro === 'function' ? euro(offer.price) : (offer.price.toFixed(2) + ' €'));
        if(hintEl) hintEl.textContent = 'Einmalig heute für ' + (offer.dish || 'Auswahl');
      } else {
        amountEl.textContent = '4,99 €';
        if(hintEl) hintEl.textContent = 'Einmalig heute pro Gericht';
      }
    }
    const bd = document.getElementById('publishFeeBd');
    const sheet = document.getElementById('publishFeeSheet');
    if(sheet){ sheet.style.display = ''; sheet.style.visibility = ''; sheet.classList.add('active'); }
    if(bd) bd.classList.add('active');
  }
  function closePublishFeeModal(){
    publishFeePendingOffer = null;
    publishFeeSuccessCallback = null;
    const bd = document.getElementById('publishFeeBd');
    const sheet = document.getElementById('publishFeeSheet');
    if(bd) bd.classList.remove('active');
    if(sheet){ sheet.classList.remove('active'); }
  }
  function showAddressRequiredModal(){
    closePublishFeeModal();
    const bd = document.getElementById('addressRequiredBd');
    const sheet = document.getElementById('addressRequiredSheet');
    if(bd) bd.style.display = 'block';
    if(sheet) sheet.style.display = 'block';
  }
  function closeAddressRequiredModal(){
    const bd = document.getElementById('addressRequiredBd');
    const sheet = document.getElementById('addressRequiredSheet');
    if(bd) bd.style.display = 'none';
    if(sheet) sheet.style.display = 'none';
  }
  if(typeof window !== 'undefined'){ window.showAddressRequiredModal = showAddressRequiredModal; window.closeAddressRequiredModal = closeAddressRequiredModal; }
  var inseratSuccessCurrentOffer = null; // für WhatsApp / QR / Social-Export

  function buildOfferShareUrl(offer){
    const id = offer && (offer.id || offer);
    const base = location.origin + (location.pathname || '/');
    return base + (base.indexOf('#') >= 0 ? '' : (base.endsWith('/') ? '' : '/')) + '#offer/' + (id || '');
  }

  function buildWhatsAppShareText(offer){
    const d = normalizeOffer(offer);
    const dish = d.dish || d.title || 'Gericht';
    const price = typeof d.price === 'number' ? d.price.toFixed(2).replace('.', ',') : (d.price || '0,00');
    const link = buildOfferShareUrl(offer);
    return 'Heute bei uns: ' + dish + ' für nur ' + price + ' €! Jetzt schnell die Abholnummer sichern und Schlange überspringen: ' + link + ' – Mittagio: Zeit gespart mit der Abholnummer.';
  }

  function openQRPrintWindow(offer){
    const url = buildOfferShareUrl(offer);
    const d = normalizeOffer(offer);
    const dish = (d.dish || d.title || 'Gericht').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    const qrImg = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(url);
    const w = window.open('', '_blank', 'width=400,height=520');
    if(!w) return;
    w.document.write('<!DOCTYPE html><html><head><title>QR-Code – Mittagio</title><style>body{font-family:Inter,sans-serif;margin:24px;text-align:center;} .logo{font-size:22px;font-weight:900;color:#1a1a1a;margin-bottom:4px;} .slogan{font-size:12px;color:#6b7280;} img{margin:16px 0;} .dish{font-size:16px;font-weight:700;margin-top:8px;}</style></head><body><div class="logo">Mittagio</div><div class="slogan">Zeit gespart mit der Abholnummer</div><img src="' + qrImg + '" alt="QR-Code" width="200" height="200" /><div class="dish">' + dish + '</div><p style="font-size:11px;color:#9ca3af;margin-top:16px;">Scannen &rarr; Gericht öffnen &amp; Abholnummer sichern</p><script>window.onload=function(){window.print();};<\/script></body></html>');
    w.document.close();
  }

  function drawOfferSocialFallback(ctx, size, d){
    ctx.fillStyle = '#f8f7f2';
    ctx.fillRect(0, 0, size, size);
    ctx.fillStyle = '#e5e7eb';
    ctx.fillRect(40, 40, size - 80, size - 280);
    ctx.fillStyle = '#1a1a1a';
    ctx.font = 'bold 48px Inter, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(d.dish || d.title || 'Gericht', size/2, size - 220);
    ctx.font = 'bold 36px Inter, sans-serif';
    ctx.fillStyle = '#16a34a';
    ctx.fillText((d.price != null ? Number(d.price).toFixed(2) : '0,00') + ' €', size/2, size - 168);
    ctx.fillStyle = '#6b7280';
    ctx.font = '24px Inter, sans-serif';
    ctx.fillText('Mittagio – Zeit gespart mit der Abholnummer', size/2, size - 80);
  }

  function exportOfferSocialImage(offer, done){
    const d = normalizeOffer(offer);
    const size = 1080;
    const canvas = document.createElement('canvas');
    canvas.width = size;
    canvas.height = size;
    const ctx = canvas.getContext('2d');
    function finishExport(){
      try {
        canvas.toBlob(function(blob){
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'mittagio-' + (d.dish || 'gericht').replace(/\s+/g, '-').toLowerCase() + '.jpg';
          a.click();
          URL.revokeObjectURL(a.href);
          if(typeof showToast === 'function') showToast('Bild heruntergeladen');
          if(done) done();
        }, 'image/jpeg', 0.9);
      } catch(e){ if(done) done(); }
    }
    const imgSrc = d.imageUrl || d.photoData || d.img || '';
    if(!imgSrc){
      drawOfferSocialFallback(ctx, size, d);
      finishExport();
      return;
    }
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = function(){
      ctx.fillStyle = '#f8f7f2';
      ctx.fillRect(0, 0, size, size);
      const pad = 40;
      const imgW = size - pad * 2;
      const imgH = Math.round(imgW * (img.height / img.width));
      let sy = 0, sh = img.height;
      if(imgH > size - 280){ const scale = (size - 280) / imgH; sh = img.height / scale; sy = (img.height - sh) / 2; }
      ctx.drawImage(img, 0, sy, img.width, sh, pad, pad, imgW, Math.min(imgH, size - 280));
      const yText = size - 220;
      ctx.fillStyle = '#1a1a1a';
      ctx.font = 'bold 48px Inter, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(d.dish || d.title || 'Gericht', size/2, yText);
      const priceStr = (typeof d.price === 'number' ? d.price.toFixed(2) : d.price) + ' €';
      ctx.font = 'bold 36px Inter, sans-serif';
      ctx.fillStyle = '#16a34a';
      ctx.fillText(priceStr, size/2, yText + 52);
      ctx.fillStyle = '#6b7280';
      ctx.font = '24px Inter, sans-serif';
      ctx.fillText('Mittagio – Zeit gespart mit der Abholnummer', size/2, size - 80);
      finishExport();
    };
    img.onerror = function(){ drawOfferSocialFallback(ctx, size, d); finishExport(); };
    img.src = imgSrc;
  }

  function showInseratSuccessSheet(publishedOffer){
    inseratSuccessCurrentOffer = publishedOffer;
    const d = normalizeOffer(publishedOffer);
    
    // 1. Konfetti zünden [cite: 2026-01-26, 2026-02-16]
    createConfetti();
    try { localStorage.setItem('mittagio_provider_leberkaese_onboarding_done', '1'); } catch(e){}
    if(navigator.vibrate) navigator.vibrate([50, 30, 50]);

    var isLeberkaeseSuccess = (d.dish || '').indexOf('Leberkäse') !== -1;
    var checkmarkTitle = document.getElementById('inseratSuccessCheckmarkTitle');
    var checkmarkSub = document.getElementById('inseratSuccessCheckmarkSub');
    if(checkmarkTitle) checkmarkTitle.textContent = isLeberkaeseSuccess ? 'Geschafft! Dein Leberkäse ist online.' : 'Geschafft! Deine Abholnummern sind scharfgeschaltet.';
    if(checkmarkSub) checkmarkSub.textContent = isLeberkaeseSuccess ? 'Das war einfach, sicher – und jetzt verdienen wir Geld.' : 'Hungrige Gäste können dein Gericht jetzt finden.';

    if(typeof Notification !== 'undefined' && Notification.permission === 'granted'){
      try {
        new Notification(isLeberkaeseSuccess ? '🚀 Dein Leberkäse ist live!' : '🚀 Dein Inserat ist live!', {
          body: isLeberkaeseSuccess ? 'Dein erstes Inserat ist online. Ab jetzt können Gäste digital bestellen. Denk dran: Vor-Ort-Gäste kosten dich weiterhin 0,00 €!' : 'Dein Inserat ist online. Gäste können jetzt bestellen.',
          icon: '/mittagio/app/assets/icons/icon-192.png'
        });
      } catch(notifyErr){}
    }

    // Hero nur bei Abholnummer („Kunde zeigt Abholnummer“ – sonst irrelevant)
    const heroBlock = document.getElementById('inseratSuccessHero');
    if(heroBlock) heroBlock.style.display = d.hasPickupCode ? '' : 'none';
    const heroImg = document.getElementById('inseratSuccessHeroImg');
    if(heroImg && d.hasPickupCode){
      const heroUrl = d.imageUrl || d.photoData || '';
      if(heroUrl) heroImg.src = heroUrl;
    }
    // 2. Live Preview (Kompakt-Card: Bild, 3 Säulen, Titel & Preis)
    const previewEl = document.getElementById('inseratSuccessLivePreview');
    if(previewEl){
      const imgUrl = d.imageUrl || 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=400&q=60';
      const vorOrt = !!d.dineInPossible;
      const abholnummer = !!d.hasPickupCode;
      const mehrweg = !!(d.reuse && d.reuse.enabled);
      const pill = (on, label) => on ? '<span style="display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:8px;background:rgba(0,0,0,0.06);font-size:11px;font-weight:700;color:#1a1a1a;">' + label + '</span>' : '<span style="display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:8px;background:rgba(0,0,0,0.04);font-size:11px;font-weight:600;color:#94a3b8;opacity:0.8;">' + label + '</span>';
      const pillAbhol = abholnummer ? '<span style="display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:8px;background:rgba(59,130,246,0.15);font-size:11px;font-weight:700;color:#2563eb;">🧾 Abholnummer</span>' : pill(false, '🧾 Abholnummer');
      previewEl.innerHTML = `
        <img src="${imgUrl}" class="success-card-img" alt="">
        <div class="success-card-body" style="padding:12px 16px;">
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px; flex-wrap:wrap;">
            ${pill(vorOrt, '🍴 Vor Ort')}
            ${pillAbhol}
            ${pill(mehrweg, '🔄 Mehrweg')}
          </div>
          <div style="display:flex; justify-content:space-between; align-items:flex-start;">
            <h4 style="margin:0; font-size:17px; font-weight:900; color:#1a1a1a;">Dein ${esc(d.dish)} für ${euro(d.price)}</h4>
          </div>
          <div style="display:flex; align-items:center; gap:6px; margin-top:6px;">
            <span style="width:8px; height:8px; background:#22c55e; border-radius:50%;"></span>
            <span style="font-size:11px; font-weight:800; color:#22c55e; text-transform:uppercase;">Jetzt Live</span>
          </div>
        </div>
      `;
    }
    // 2b. Zusammenfassung des Deals (unterschieden: mit vs. ohne Abholnummer)
    const dealEl = document.getElementById('inseratSuccessDealSummary');
    if(dealEl){
      const feeWaived = !!d.inseratFeeWaived;
      const withPickup = !!d.hasPickupCode;
      const rawEnd = ((d.pickupWindow || '').split(/\s*[–\-]\s*/)[1] || (d.pickupWindow || '')).trim() || '14:00';
      let endTimeDisplay = '14:00';
      if(/^\d{1,2}:\d{2}$/.test(rawEnd)) endTimeDisplay = rawEnd;
      else if(/^\d{3,4}$/.test(rawEnd)) endTimeDisplay = rawEnd.slice(0,-2) + ':' + rawEnd.slice(-2);
      else if(rawEnd) endTimeDisplay = rawEnd;
      var dealLines = '<div style="font-size:12px; font-weight:800; color:#64748b; text-transform:uppercase; letter-spacing:0.04em; margin-bottom:10px;">Zusammenfassung des Deals</div>' +
        '<div style="font-size:14px; color:#1a1a1a; margin-bottom:6px;"><strong>Inseratsgebühr:</strong> ' + (feeWaived ? '0,00 € (Geschenkt!)' : '4,99 €') + '</div>';
      if(withPickup){
        dealLines += '<div style="font-size:14px; color:#1a1a1a; margin-bottom:6px;"><strong>Abrechnung:</strong> Du zahlst lediglich 0,89 € pro Abholnummer.</div>';
      } else {
        dealLines += '<div style="font-size:14px; color:#1a1a1a; margin-bottom:6px;">Deine Gäste sehen das Gericht <strong>ohne Abholnummer</strong> – Vor Ort oder Mitnehmen. Du zahlst nur die Inseratsgebühr.</div>';
      }
      dealLines += '<div style="font-size:14px; color:#1a1a1a;"><strong>Zeitfenster:</strong> Sichtbar bis ' + endTimeDisplay + ' Uhr</div>';
      dealEl.innerHTML = dealLines;
    }
    // 2c. Was passiert jetzt? (Text je nach Abholnummer)
    const whatNextEl = document.getElementById('inseratSuccessWhatNext');
    if(whatNextEl){
      if(d.hasPickupCode){
        whatNextEl.textContent = 'Sobald ein Kunde bestellt, erhält er eine Abholnummer. Diese wird dir in deiner Übersicht angezeigt, damit du das Gericht direkt zuordnen kannst.';
      } else {
        whatNextEl.textContent = 'Deine Gäste finden dein Gericht in der App und können vor Ort essen oder mitnehmen. Es wird keine Abholnummer vergeben – du hast nur die Inseratsgebühr von 4,99 € gezahlt.';
      }
    }

    const nextCodeEl = document.getElementById('inseratSuccessNextCode');
    const abholSection = document.getElementById('inseratSuccessAbholnummerSection');
    const todayKey = isoDate(new Date());
    const todayOrders = loadOrders().filter(o => {
      const offer = offers.find(off => off.id === o.dishId || (off.providerId === o.providerId && off.day === todayKey));
      return offer && offer.providerId === providerId() && o.status === 'PAID';
    });
    
    if(nextCodeEl) nextCodeEl.textContent = (todayOrders.length + 1);
    if(abholSection) abholSection.style.display = (d.hasPickupCode ? 'block' : 'none');
    
    var offerLink = buildOfferShareUrl(publishedOffer);
    var whatsAppText = buildWhatsAppShareText(publishedOffer);
    var whatsAppBtn = document.getElementById('inseratSuccessBtnWhatsApp');
    if(whatsAppBtn){
      var whatsAppUrl = 'https://api.whatsapp.com/send?text=' + encodeURIComponent(whatsAppText);
      whatsAppBtn.href = whatsAppUrl;
      whatsAppBtn.onclick = function(e){ e.preventDefault(); window.open(whatsAppUrl, '_blank', 'noopener'); return false; };
    }
    
    var btnPrintQR = document.getElementById('inseratSuccessBtnPrintQR');
    if(btnPrintQR){ btnPrintQR.onclick = function(){ openQRPrintWindow(publishedOffer); }; }
    
    var btnSocialImage = document.getElementById('inseratSuccessBtnSocialImage');
    if(btnSocialImage){ btnSocialImage.onclick = function(){ exportOfferSocialImage(publishedOffer); }; }
    
    const bd = document.getElementById('inseratSuccessBd');
    const sheet = document.getElementById('inseratSuccessSheet');
    if(bd) bd.classList.add('active');
    if(sheet) sheet.classList.add('active');
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }

  function createConfetti() {
    const container = document.getElementById('confettiContainer');
    if(!container) return;
    container.innerHTML = '';
    const colors = ['#10b981', '#059669', '#34d399', '#6ee7b7', '#a7f3d0'];
    for(let i=0; i<50; i++) {
      const c = document.createElement('div');
      c.className = 'confetti';
      c.style.left = Math.random() * 100 + '%';
      c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      c.style.width = (Math.random() * 8 + 5) + 'px';
      c.style.height = c.style.width;
      c.style.animationDelay = (Math.random() * 2) + 's';
      c.style.animationDuration = (Math.random() * 2 + 2) + 's';
      container.appendChild(c);
    }
  }

  function closeInseratSuccessSheet(){
    const bd = document.getElementById('inseratSuccessBd');
    const sheet = document.getElementById('inseratSuccessSheet');
    if(bd) bd.classList.remove('active');
    if(sheet) sheet.classList.remove('active');
    showProviderHome();
  }
  (function wirePublishAndSuccessSheets(){
    const btnPublishConfirm = document.getElementById('btnPublishConfirm');
    if(btnPublishConfirm){
      btnPublishConfirm.onclick = function(){
        if(!publishFeePendingOffer) return;
        if(typeof haptic === 'function') haptic(12);
        const offer = publishFeePendingOffer;
        const onSuccess = publishFeeSuccessCallback;
        const published = publishOffer(offer);
        closePublishFeeModal();
        if(published){
          showInseratSuccessSheet(published);
          if(typeof onSuccess === 'function'){ try { onSuccess(); } catch(e){ console.error(e); } }
        }
      };
    }
    const inseratSuccessBtnBack = document.getElementById('inseratSuccessBtnBack');
    if(inseratSuccessBtnBack) inseratSuccessBtnBack.onclick = function(){ var id = inseratSuccessCurrentOffer && inseratSuccessCurrentOffer.id; closeInseratSuccessSheet(); if(id && typeof openProviderOffer === 'function') openProviderOffer(id); };
    const inseratSuccessBtnNewListing = document.getElementById('inseratSuccessBtnNewListing');
    if(inseratSuccessBtnNewListing){
      inseratSuccessBtnNewListing.onclick = function(){
        closeInseratSuccessSheet();
        startListingFlow();
      };
    }
    const inseratSuccessBd = document.getElementById('inseratSuccessBd');
    if(inseratSuccessBd) inseratSuccessBd.onclick = closeInseratSuccessSheet;
    if(typeof window !== 'undefined'){
      window.closePublishFeeModal = closePublishFeeModal;
      window.closeInseratSuccessSheet = closeInseratSuccessSheet;
      window.closeSaveSuccessSheet = closeSaveSuccessSheet;
    }
    closePublishFeeModal();
    if(typeof closeQuickPostSheet === 'function') closeQuickPostSheet();
  })();

  (function wireAbholnummerExplainSheet(){
    var carousel = document.getElementById('abholnummerExplainCarousel');
    var dotsWrap = document.getElementById('abholnummerExplainDots');
    var btnNext = document.getElementById('abholnummerExplainBtnNext');
    var bd = document.getElementById('abholnummerExplainBd');
    var sheet = document.getElementById('abholnummerExplainSheet');
    var currentSlide = 0;
    var totalSlides = 5;
    function updateUI(){
      if(btnNext){
        btnNext.textContent = currentSlide >= totalSlides - 1 ? 'Fertig' : 'Weiter';
      }
      if(dotsWrap){
        dotsWrap.innerHTML = '';
        for(var i = 0; i < totalSlides; i++){
          var dot = document.createElement('button');
          dot.type = 'button';
          dot.className = 'abholnummer-explain-dot' + (i === currentSlide ? ' active' : '');
          dot.setAttribute('aria-label', 'Slide ' + (i + 1));
          (function(idx){ dot.onclick = function(){ currentSlide = idx; scrollToSlide(); updateUI(); }; })(i);
          dotsWrap.appendChild(dot);
        }
      }
    }
    function scrollToSlide(){
      if(!carousel) return;
      var slide = carousel.querySelector('.abholnummer-explain-slide[data-slide="' + currentSlide + '"]');
      if(slide) slide.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
      updateUI();
    }
    function openAbholnummerExplainSheet(){
      currentSlide = 0;
      updateUI();
      if(carousel) carousel.scrollLeft = 0;
      if(bd) bd.classList.add('active');
      if(sheet) sheet.classList.add('active');
      if(typeof lucide !== 'undefined') setTimeout(function(){ lucide.createIcons(); }, 50);
    }
    function closeAbholnummerExplainSheet(){
      if(bd) bd.classList.remove('active');
      if(sheet) sheet.classList.remove('active');
    }
    if(btnNext){
      btnNext.onclick = function(){
        if(currentSlide >= totalSlides - 1){ closeAbholnummerExplainSheet(); return; }
        currentSlide++;
        scrollToSlide();
      };
    }
    if(carousel){
      carousel.addEventListener('scroll', function(){
        var scrollLeft = carousel.scrollLeft;
        var slideWidth = carousel.offsetWidth;
        var idx = Math.round(scrollLeft / slideWidth);
        if(idx >= 0 && idx < totalSlides && idx !== currentSlide){ currentSlide = idx; updateUI(); }
      });
    }
    updateUI();
    if(typeof window !== 'undefined'){
      window.openAbholnummerExplainSheet = openAbholnummerExplainSheet;
      window.closeAbholnummerExplainSheet = closeAbholnummerExplainSheet;
    }
  })();

  function openPricingFairnessOverlay(){
    if(typeof haptic==='function') haptic(10); else if(navigator.vibrate) navigator.vibrate(10);
    var bd=document.getElementById('pricingFairnessBd'); var ov=document.getElementById('pricingFairnessOverlay');
    if(bd) bd.classList.add('active'); if(ov) ov.classList.add('active');
  }
  function closePricingFairnessOverlay(){
    if(typeof haptic==='function') haptic(10); else if(navigator.vibrate) navigator.vibrate(10);
    var bd=document.getElementById('pricingFairnessBd'); var ov=document.getElementById('pricingFairnessOverlay');
    if(bd) bd.classList.remove('active'); if(ov) ov.classList.remove('active');
  }
  if(typeof window !== 'undefined'){ window.openPricingFairnessOverlay = openPricingFairnessOverlay; window.closePricingFairnessOverlay = closePricingFairnessOverlay; }

  function saveToCookbookFromWizard(keepOpen=false){
    const now = Date.now();
    const base = {
      id: cryptoId(),
      providerId: providerId(),
      dish: w.data.dish||'',
      category: w.data.category||'Vegetarisch',
      price: Number(w.data.price||0),
      allergens: w.data.allergens||[],
      extras: w.data.extras||[],
      reuse: w.data.reuse||{enabled:false,deposit:0},
      photoData: w.data.photoData||'',
      hasPickupCode: !!w.data.hasPickupCode,
      dineInPossible: !!w.data.dineInPossible,
      createdAt: now,
      lastUsed: null
    };
    if(w.ctx && w.ctx.editId){
      var idx = cookbook.findIndex(function(c){ return c.id===w.ctx.editId; });
      if(idx>=0){
        var prev = cookbook[idx];
        cookbook[idx] = Object.assign({}, prev, base, { id: prev.id, createdAt: prev.createdAt || now, lastUsed: prev.lastUsed != null ? prev.lastUsed : null });
        save(LS.cookbook, cookbook);
        if(!keepOpen){ renderCookbook(); }
        return prev.id;
      }
    }
    {
      cookbook.push(base);
    }
    save(LS.cookbook, cookbook);
    if(!keepOpen){ renderCookbook(); }
    return base.id;
  }

  var saveSuccessSheetCtx = { savedEntryId: null, savedDay: null, onFertig: null, onLive: null };
  function showSaveSuccessSheet(opts){
    var title = (opts && opts.title) || 'Gespeichert!';
    var sub = (opts && opts.sub) || 'Dein Gericht ist gespeichert.';
    var dishName = (opts && opts.dishName) || '';
    var price = (opts && opts.price) != null ? (typeof euro === 'function' ? euro(opts.price) : Number(opts.price).toFixed(2).replace('.', ',') + ' €') : '';
    var imageUrl = (opts && opts.imageUrl) || '';
    saveSuccessSheetCtx.savedEntryId = opts && opts.savedEntryId;
    saveSuccessSheetCtx.savedDay = opts && opts.savedDay;
    saveSuccessSheetCtx.onFertig = opts && opts.onFertig;
    saveSuccessSheetCtx.onLive = opts && opts.onLive;
    var titleEl = document.getElementById('saveSuccessSheetTitle');
    var subEl = document.getElementById('saveSuccessSheetSub');
    var previewEl = document.getElementById('saveSuccessSheetPreview');
    if(titleEl) titleEl.textContent = title;
    if(subEl) subEl.textContent = sub;
    if(previewEl){
      var imgSrc = imageUrl || 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=400&q=60';
      var dishEsc = (dishName || 'Gericht').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
      previewEl.innerHTML = '<img src="' + imgSrc + '" class="success-card-img" alt=""><div class="success-card-body" style="padding:12px 16px;"><div style="display:flex; justify-content:space-between; align-items:flex-start;"><h4 style="margin:0; font-size:17px; font-weight:900; color:#1a1a1a;">' + dishEsc + '</h4>' + (price ? '<span style="background:#1a1a1a; color:#fff; padding:4px 10px; border-radius:8px; font-size:13px; font-weight:800;">' + price + '</span>' : '') + '</div></div>';
    }
    var bd = document.getElementById('saveSuccessSheetBd');
    var sheet = document.getElementById('saveSuccessSheet');
    if(bd) bd.classList.add('active');
    if(sheet) sheet.classList.add('active');
    try { if(typeof haptic === 'function') haptic([12, 55, 12]); } catch(e){}
  }
  function closeSaveSuccessSheet(){
    saveSuccessSheetCtx.savedEntryId = null;
    saveSuccessSheetCtx.savedDay = null;
    saveSuccessSheetCtx.onFertig = null;
    saveSuccessSheetCtx.onLive = null;
    var bd = document.getElementById('saveSuccessSheetBd');
    var sheet = document.getElementById('saveSuccessSheet');
    if(bd) bd.classList.remove('active');
    if(sheet) sheet.classList.remove('active');
  }
  (function wireSaveSuccessSheet(){
    var bd = document.getElementById('saveSuccessSheetBd');
    var btnFertig = document.getElementById('saveSuccessSheetBtnFertig');
    var btnLive = document.getElementById('saveSuccessSheetBtnLive');
    if(btnFertig) btnFertig.onclick = function(){
      if(typeof haptic === 'function') haptic(8);
      var onFertig = saveSuccessSheetCtx.onFertig;
      closeSaveSuccessSheet();
      if(typeof onFertig === 'function') onFertig();
    };
    if(btnLive) btnLive.onclick = function(){
      if(typeof haptic === 'function') haptic(12);
      var id = saveSuccessSheetCtx.savedEntryId;
      var day = saveSuccessSheetCtx.savedDay;
      closeSaveSuccessSheet();
      if(id && typeof publishCookbookEntry === 'function') publishCookbookEntry(id, day || (typeof isoDate === 'function' ? isoDate(new Date()) : null));
    };
  })();

  /** Erfolgs-Overlay beim Speichern (Kochbuch/Wochenplan): Titel + Check + „Fertig“, an body, kein Auto-Close. */
  function showSaveSuccessOverlay(title, thenCallback){
    try { if(typeof haptic==='function') haptic([12, 55, 12]); } catch(e){}
    var overlay = document.createElement('div');
    overlay.className = 'save-success-overlay';
    overlay.setAttribute('role', 'dialog');
    overlay.setAttribute('aria-label', title);
    overlay.style.cssText = 'position:fixed; inset:0; background:rgba(255,255,255,0.95); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); z-index:3500; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:24px; box-sizing:border-box;';
    var titleEsc = (title || 'Gespeichert').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    overlay.innerHTML = '<div style="display:flex; flex-direction:column; align-items:center; gap:20px; text-align:center; max-width:320px;">' +
      '<div style="width:80px; height:80px; border-radius:50%; background:rgba(16,185,129,0.15); border:3px solid #10b981; display:flex; align-items:center; justify-content:center;"><span style="font-size:44px; color:#059669;">✓</span></div>' +
      '<div style="font-size:20px; font-weight:900; color:#1a1a1a;">' + titleEsc + '</div>' +
      '<p style="margin:0; font-size:14px; color:#64748b;">Du findest es in deiner Übersicht.</p>' +
      '<button type="button" class="save-success-done-btn" style="width:100%; min-height:52px; border-radius:16px; background:#1a1a1a; color:#fff; font-size:16px; font-weight:800; border:none; cursor:pointer; margin-top:8px;">Fertig</button>' +
      '</div>';
    document.body.appendChild(overlay);
    var btn = overlay.querySelector('.save-success-done-btn');
    function dismiss(){ overlay.remove(); if(thenCallback) thenCallback(); }
    if(btn){ btn.onclick = function(){ if(typeof haptic==='function') haptic(8); dismiss(); }; }
  }

  // Alter Inseratsflow entfernt: showListingSuccessOverlay, openSlimDayPicker – nur noch InseratCard (buildListingStep)

  // --- Input helpers (thumb-friendly) ---
  function formatPriceInput(value){
    const num = Number(value||0);
    return num.toFixed(2).replace('.',',');
  }
  function parsePriceInput(raw){
    const cleaned = String(raw||'').trim().replace(',', '.').replace(/[^0-9.]/g,'');
    const num = parseFloat(cleaned);
    if(Number.isNaN(num)) return 0;
    return Math.round(num*100)/100;
  }
  function smartNumberToEuro(raw){
    const digits = String(raw||'').replace(/\D/g,'');
    if(!digits) return 0;
    const cents = parseInt(digits,10);
    return Math.round((cents/100)*100)/100;
  }
  function smartNumber(raw){
    const digits = String(raw||'').replace(/\D/g,'');
    if(!digits) return 0;
    return parseInt(digits,10);
  }

  // Image picker
  function pickImage(opts={}){
    return new Promise(resolve=>{
      const input=document.createElement('input');
      input.type='file';
      input.accept='image/*';
      if(opts.capture) input.capture='environment';
      input.onchange=()=> resolve(input.files && input.files[0] ? input.files[0] : null);
      input.click();
    });
  }
  function toDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload=()=>resolve(r.result);
      r.onerror=reject;
      r.readAsDataURL(file);
    });
  }
  async function urlToDataUrl(url){
    try {
      const r = await fetch(url, { mode: 'cors' });
      const blob = await r.blob();
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(blob);
      });
    } catch (e) {
      // Fallback: Galerie/Bibliothek (Unsplash etc.) – CORS oder fetch schlägt fehl → Bild per img + Canvas laden
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = function(){
          try {
            const canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            resolve(canvas.toDataURL('image/jpeg', 0.9));
          } catch (err) { reject(err); }
        };
        img.onerror = () => reject(new Error('Bild konnte nicht geladen werden'));
        img.src = url;
      });
    }
  }

  // Fotoeditor mit Filter & Zuschnitt
  // Foto-KI: Analysiert Foto mit GPT-4o Vision API
  async function analyzeFoodPhoto(imageDataUrl){
    try {
      // TODO: In Production: Echte GPT-4o Vision API Integration
      // Beispiel-Request:
      // const response = await fetch('https://api.openai.com/v1/chat/completions', {
      //   method: 'POST',
      //   headers: {
      //     'Authorization': `Bearer ${OPENAI_API_KEY}`,
      //     'Content-Type': 'application/json'
      //   },
      //   body: JSON.stringify({
      //     model: 'gpt-4o',
      //     messages: [{
      //       role: 'user',
      //       content: [
      //         { type: 'text', text: 'Analysiere dieses Food-Foto und extrahiere: Name des Gerichts, geschätzter Preis in EUR, Hauptzutaten (Liste). Antworte im JSON-Format: {name, price, ingredients: []}. KEINE Mengenschätzungen oder Kalorien.' },
      //         { type: 'image_url', image_url: { url: imageDataUrl } }
      //       ]
      //     }]
      //   })
      // });
      // const data = await response.json();
      // return JSON.parse(data.choices[0].message.content);
      
      // Demo: Simuliere KI-Analyse (wird später durch echte API ersetzt)
      await new Promise(resolve => setTimeout(resolve, 1500)); // Simuliere API-Latenz
      
      // Mock-Daten basierend auf häufigsten Gerichten
      const mockAnalysis = {
        name: 'Schnitzel mit Pommes',
        price: 8.50,
        ingredients: ['Schweinefleisch', 'Eier', 'Mehl', 'Semmelbrösel', 'Kartoffeln', 'Öl'],
        calories: 650
      };
      
      return mockAnalysis;
    } catch(err){
      console.error('Foto-KI Fehler:', err);
      return null;
    }
  }
  
  // Auto-Tagging: Vergleicht Zutaten mit 14 Hauptallergenen
  function tagAllergensFromIngredients(ingredients){
    const allergenMap = {
      'A': ['gluten', 'weizen', 'roggen', 'gerste', 'hafer', 'dinkel'],
      'B': ['krebstiere', 'krebs', 'garnelen', 'shrimps'],
      'C': ['eier', 'ei', 'eigelb', 'eiweiß'],
      'D': ['fisch', 'lachs', 'thunfisch', 'forelle'],
      'E': ['erdnüsse', 'erdnuss'],
      'F': ['soja', 'sojabohnen', 'tofu'],
      'G': ['milch', 'milchprodukte', 'käse', 'butter', 'sahne', 'joghurt'],
      'H': ['schalenfrüchte', 'mandeln', 'haselnüsse', 'walnüsse', 'cashew'],
      'I': ['sellerie'],
      'J': ['senf'],
      'K': ['sesam'],
      'L': ['schwefeldioxid', 'sulfite'],
      'M': ['lupinen'],
      'N': ['weichtiere', 'muscheln', 'austern']
    };
    
    const detectedAllergens = [];
    const ingredientsLower = ingredients.map(i => i.toLowerCase());
    
    Object.keys(allergenMap).forEach(code => {
      const keywords = allergenMap[code];
      if(keywords.some(keyword => ingredientsLower.some(ing => ing.includes(keyword)))){
        detectedAllergens.push(code);
      }
    });
    
    return detectedAllergens;
  }
  
  async function openPhotoEditor(imageDataUrl, opts){
    opts = opts || {};
    const onAccept = opts.onAccept;
    const useWizard = !onAccept;
    return new Promise(async (resolve)=>{
      const editor = document.createElement('div');
      editor.className='backdrop active';
      editor.style.zIndex='50';
      
      const editorContent = document.createElement('div');
      editorContent.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:24px;padding:24px;max-width:90vw;max-height:90vh;overflow:auto;z-index:51;box-shadow:0 8px 32px rgba(0,0,0,.2);';
      
      const aiAnalysisPromise = useWizard ? analyzeFoodPhoto(imageDataUrl) : Promise.resolve(null);
      
      const img = new Image();
      img.src = imageDataUrl;
      img.onload = async ()=>{
        const size = 400;
        const sourceSize = Math.min(img.width, img.height);
        const maxOffsetX = Math.max(0, img.width - sourceSize);
        const maxOffsetY = Math.max(0, img.height - sourceSize);
        let cropX = 50, cropY = 50;
        
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');
        
        function sourceX(){ return maxOffsetX * (cropX / 100); }
        function sourceY(){ return maxOffsetY * (cropY / 100); }
        
        function draw(){
          ctx.filter = 'brightness(1.1) contrast(1.15) saturate(1.1)';
          ctx.drawImage(img, sourceX(), sourceY(), sourceSize, sourceSize, 0, 0, size, size);
          previewImg.src = canvas.toDataURL('image/jpeg', 0.85);
        }
        
        const previewImg = document.createElement('img');
        previewImg.alt = '';
        previewImg.style.cssText = 'width:100%;max-width:400px;display:block;border-radius:12px;';
        const previewWrap = document.createElement('div');
        previewWrap.style.cssText = 'border-radius:16px;overflow:hidden;border:1px solid #eee;margin-bottom:16px;background:#f5f5f5';
        previewWrap.appendChild(previewImg);
        
        const heading = document.createElement('h3');
        heading.style.cssText = 'margin:0 0 16px;font-size:18px;font-weight:900;';
        heading.textContent = 'Foto bearbeiten';
        const hint = document.createElement('div');
        hint.className = 'hint';
        hint.style.marginBottom = '16px';
        hint.innerHTML = '✓ Filter: Helligkeit + Kontrast · Quadratischer Zuschnitt, verschiebbar';
        
        const slidersWrap = document.createElement('div');
        slidersWrap.style.marginBottom = '16px';
        if(maxOffsetX > 0){
          const rowH = document.createElement('div');
          rowH.style.marginBottom = '12px';
          const labelH = document.createElement('label');
          labelH.style.cssText = 'display:block;font-size:13px;margin-bottom:4px;';
          labelH.textContent = 'Ausschnitt horizontal';
          const rangeH = document.createElement('input');
          rangeH.type = 'range';
          rangeH.min = 0;
          rangeH.max = 100;
          rangeH.value = 50;
          rangeH.style.width = '100%';
          rangeH.oninput = ()=>{ cropX = Number(rangeH.value); draw(); };
          rowH.appendChild(labelH);
          rowH.appendChild(rangeH);
          slidersWrap.appendChild(rowH);
        }
        if(maxOffsetY > 0){
          const rowV = document.createElement('div');
          rowV.style.marginBottom = '12px';
          const labelV = document.createElement('label');
          labelV.style.cssText = 'display:block;font-size:13px;margin-bottom:4px;';
          labelV.textContent = 'Ausschnitt vertikal';
          const rangeV = document.createElement('input');
          rangeV.type = 'range';
          rangeV.min = 0;
          rangeV.max = 100;
          rangeV.value = 50;
          rangeV.style.width = '100%';
          rangeV.oninput = ()=>{ cropY = Number(rangeV.value); draw(); };
          rowV.appendChild(labelV);
          rowV.appendChild(rangeV);
          slidersWrap.appendChild(rowV);
        }
        
        draw();
        
        const aiResult = await aiAnalysisPromise;
        if(useWizard && aiResult && w && w.data){
          if(aiResult.name && !w.data.dish) w.data.dish = aiResult.name;
          if(aiResult.price && !w.data.price) w.data.price = aiResult.price;
          if(aiResult.ingredients && aiResult.ingredients.length > 0){
            const allergens = tagAllergensFromIngredients(aiResult.ingredients);
            if(allergens.length > 0 && !w.data.allergens){
              w.data.allergens = allergens;
              w.data.wantsAllergens = true;
            }
          }
          if(typeof showToast === 'function') showToast('KI-Analyse: ' + (aiResult.name || 'Gericht erkannt'));
        }
        
        function finish(dataUrl){
          editor.remove();
          if(onAccept){ onAccept(dataUrl); resolve(dataUrl); return; }
          if(w && w.data){ w.data.photoData = dataUrl; w.data.photoDataIsStandard = false; }
          if(typeof rebuildWizard === 'function') rebuildWizard();
          resolve(dataUrl);
        }
        
        const acceptBtn = document.createElement('button');
        acceptBtn.className = 'btn';
        acceptBtn.textContent = 'Übernehmen';
        acceptBtn.onclick = ()=> finish(canvas.toDataURL('image/jpeg', 0.85));
        
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn secondary';
        cancelBtn.textContent = 'Abbrechen';
        cancelBtn.style.marginLeft = '8px';
        cancelBtn.onclick = ()=>{ editor.remove(); resolve(null); };
        
        const btnRow = document.createElement('div');
        btnRow.style.display = 'flex';
        btnRow.style.gap = '8px';
        btnRow.appendChild(acceptBtn);
        btnRow.appendChild(cancelBtn);
        
        editorContent.appendChild(heading);
        editorContent.appendChild(previewWrap);
        editorContent.appendChild(hint);
        if(slidersWrap.children.length) editorContent.appendChild(slidersWrap);
        editorContent.appendChild(btnRow);
        
        editor.onclick = (e)=>{
          if(e.target === editor){ editor.remove(); resolve(null); }
        };
        
        editor.appendChild(editorContent);
        document.body.appendChild(editor);
      };
    });
  }

  // --- Pickup Code Screen Event Handlers ---
  const btnPickupCodeBack = document.getElementById('btnPickupCodeBack');
  if(btnPickupCodeBack){
    btnPickupCodeBack.onclick = () => {
      // Abholnummer-Ansicht explizit verstecken
      const pickupCodeView = document.getElementById('v-pickup-code');
      if(pickupCodeView){
        pickupCodeView.style.display = 'none';
        pickupCodeView.classList.remove('active');
      }
      showOrders(); // Zurück zu Abholnummern
    };
  }
  
  const btnCopyCode = document.getElementById('btnCopyCode');
  if(btnCopyCode){
    btnCopyCode.onclick = async () => {
      if(!currentPickupOrderId) return;
      const order = getOrderById(currentPickupOrderId);
      if(!order) return;
      // Code nur kopieren wenn PAID
      if(order.status !== 'PAID'){
        alert('Abholnummer wird nach erfolgreicher Zahlung generiert.');
        return;
      }
      const code = order.pickupCode || order.code || '';
      if(!code) return;
      
      // Clipboard API nutzen
      try{
        if(navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(code);
          btnCopyCode.innerHTML = '<i data-lucide="check"></i> Kopiert!';
          setTimeout(()=>{
            btnCopyCode.innerHTML = '<i data-lucide="copy"></i> Abholnummer kopieren';
            if(typeof lucide !== 'undefined') lucide.createIcons();
          }, 2000);
          if(typeof lucide !== 'undefined') lucide.createIcons();
          return;
        }
      } catch(e){
        // Fallback
      }
      
      // Fallback: select + copy
      const textarea = document.createElement('textarea');
      textarea.value = code;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      try{
        document.execCommand('copy');
        btnCopyCode.innerHTML = '<i data-lucide="check"></i> Kopiert!';
        setTimeout(()=>{
          btnCopyCode.innerHTML = '<i data-lucide="copy"></i> Abholnummer kopieren';
          if(typeof lucide !== 'undefined') lucide.createIcons();
        }, 2000);
        if(typeof lucide !== 'undefined') lucide.createIcons();
      } catch(e){
        // Fehler
      }
      document.body.removeChild(textarea);
    };
  }
  
  const btnOpenRoute = document.getElementById('btnOpenRoute');
  if(btnOpenRoute){
    btnOpenRoute.onclick = () => {
      if(!currentPickupOrderId) return;
      const order = getOrderById(currentPickupOrderId);
      if(!order) return;
      const address = order.providerAddress || '';
      if(address){
        // Route öffnen (öffnet Maps mit providerAddress)
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
        window.open(mapsUrl, '_blank');
      } else {
        alert('Adresse nicht verfügbar.');
      }
    };
  }
  
  const btnToOrders = document.getElementById('btnToOrders');
  if(btnToOrders){
    btnToOrders.onclick = () => {
      showOrders(); // Zu Abholnummern
    };
  }
  
  // --- Swipe Action-Buttons Handler ---
  // Reset-Button (Nochmal von vorne)
  const btnSwipeReset = document.getElementById('btnSwipeReset');
  if(btnSwipeReset){
    btnSwipeReset.onclick = () => {
      // SessionStorage leeren (Ablehnungen zurücksetzen)
      sessionStorage.removeItem('mittagio_disliked');
      
      // Index zurücksetzen
      currentSwipeIndex = 0;
      
      // Swipe-Stack neu rendern
      renderSwipeCards();
      
      // End-of-Stack Karte ausblenden
      const swipeEndOfStack = document.getElementById('swipeEndOfStack');
      if(swipeEndOfStack) swipeEndOfStack.style.display = 'none';
      
      showToast('Von vorne gestartet', 1500);
    };
  }
  
  // Zur Liste wechseln Button (falls Swipe-UI vorhanden)
  const btnSwipeToList = document.getElementById('btnSwipeToList');
  if(btnSwipeToList){
    btnSwipeToList.onclick = () => {
      switchDiscoverView('list');
    };
  }
  
  // --- boot ---
  // Einziger Demo-Anbieter: Thomas Kurz (40 Kochbuch, 3 Tagesinserate heute, 1 Woche × 3 Tagesessen). Kundenansicht zeigt nur ihn.
  if(offers.length === 0){
    seedExampleData(); // Leer – keine weiteren Demo-Anbieter
    seedDemoProvider(); // Metzgerei Thomas Kurz. Login: thomas@thomas-kurz.de oder demo@mittagio.de
  }
  offers = offers.map(normalizeOffer);
  save(LS.offers, offers);
  
  // Orders laden
  orders = loadOrders();
  
  // --- Route Handler: Checkout Success/Cancel + Abholnummer ---
  // Routes:
  //   /checkout/success?session_id=xxx OR ?orderId=xxx
  //   /checkout/cancel?orderId=xxx OR ?session_id=xxx
  //   /abholcode/:orderId (via URL hash or query param)
  {
    const urlParams = new URLSearchParams(window.location.search);
    const path = window.location.pathname;
    const hash = window.location.hash;
    
    // Success Route: /checkout/success
    if(path.includes('/checkout/success') || urlParams.has('session_id') || (urlParams.has('success') && urlParams.has('orderId'))){
      const sessionId = urlParams.get('session_id');
      const orderId = urlParams.get('orderId');
      
      if(sessionId || orderId){
        handleCheckoutSuccess(sessionId, orderId);
        // Clean URL (remove query params)
        window.history.replaceState({}, '', window.location.pathname);
      }
    }
    
    // Cancel Route: /checkout/cancel
    if(path.includes('/checkout/cancel') || (urlParams.has('cancel') && (urlParams.has('orderId') || urlParams.has('session_id')))){
      const orderId = urlParams.get('orderId');
      const sessionId = urlParams.get('session_id');
      if(orderId || sessionId){
        handleCheckoutCancel(orderId, sessionId);
        // Clean URL
        window.history.replaceState({}, '', window.location.pathname);
      }
    }
    
    // Legal Pages Routes: /impressum, /agb-kurz, /datenschutz, /faq; Version: /version; Admin: /admin
    if(hash){
      const legalRoutes = {
        '#/impressum': 'impressum',
        '#/agb-kurz': 'agb-kurz',
        '#/datenschutz': 'datenschutz',
        '#/faq': 'faq',
        '#/support': 'support'
      };
      if(legalRoutes[hash]){
        showLegalPage(legalRoutes[hash]);
      } else if(hash === '#/version'){
        showView(views.version || 'v-version');
      } else if(hash === '#/admin' && typeof showAdminView === 'function'){
        showAdminView();
      }
    }
    
    // Hash-Change Listener für Legal Pages, Version & Admin
    window.addEventListener('hashchange', function(){
      const hash = window.location.hash;
      const legalRoutes = {
        '#/impressum': 'impressum',
        '#/agb-kurz': 'agb-kurz',
        '#/datenschutz': 'datenschutz',
        '#/faq': 'faq',
        '#/support': 'support'
      };
      if(legalRoutes[hash]){
        showLegalPage(legalRoutes[hash]);
      } else if(hash === '#/version'){
        showView(views.version || 'v-version');
      } else if(hash === '#/admin' && typeof showAdminView === 'function'){
        showAdminView();
      }
    });
    
    // Abholnummer Route: /abholcode/:orderId
    // Support: /abholcode?orderId=xxx OR hash #abholcode/:orderId
    if(path.includes('/abholcode') || hash.includes('#abholcode/') || urlParams.has('abholcode')){
      let orderId = null;
      
      // Try hash first: #abholcode/:orderId
      if(hash.includes('#abholcode/')){
        orderId = hash.split('#abholcode/')[1]?.split('?')[0]?.split('#')[0];
      }
      
      // Try query param: ?abholcode=xxx or ?orderId=xxx
      if(!orderId){
        orderId = urlParams.get('abholcode') || urlParams.get('orderId');
      }
      
      if(orderId){
        showPickupCode(orderId);
        // Clean URL
        window.history.replaceState({}, '', window.location.pathname);
      }
    }
    
    // Share Route: /share/:offerId ODER #offer/:offerId (Deep Link aus WhatsApp/QR)
    let offerId = null;
    if(hash && hash.indexOf('#offer/') === 0){
      offerId = hash.replace('#offer/', '').split('?')[0].split('#')[0];
    }
    if(!offerId && (path.includes('/share/') || hash.includes('#share/') || urlParams.has('share'))){
      if(path.includes('/share/')) offerId = path.split('/share/')[1]?.split('?')[0]?.split('#')[0];
      if(!offerId && hash.includes('#share/')) offerId = hash.split('#share/')[1]?.split('?')[0]?.split('#')[0];
      if(!offerId) offerId = urlParams.get('share') || urlParams.get('offerId');
    }
    if(offerId){
      openOffer(offerId);
      window.history.replaceState({}, '', window.location.pathname);
    }
  } // Ende Route Handler Block
  
  // --- Stabilitäts-Sicherung: Status-Ampel & Connectivity-Check ---
  let connectivityCheckInterval = null;
  let lastConnectivityStatus = 'online';
  
  // Status-Ampel aktualisieren
  function updateStatusIndicator(status){
    const indicator = document.getElementById('providerStatusIndicator');
    const dot = document.getElementById('statusIndicatorDot');
    const text = document.getElementById('statusIndicatorText');
    
    if(!indicator || !dot || !text) return;
    
    // Entferne alle Animationen
    dot.style.animation = 'none';
    
    if(status === 'online'){
      dot.style.background = '#2ECC71';
      dot.style.boxShadow = '0 0 8px rgba(46,204,113,0.6)';
      dot.style.animation = 'pulse-green 2s infinite';
      text.textContent = 'In der Küche aktiv';
      text.style.color = 'rgba(255,255,255,0.9)';
      lastConnectivityStatus = 'online';
    } else if(status === 'offline'){
      dot.style.background = '#E34D4D';
      dot.style.boxShadow = '0 0 8px rgba(227,77,77,0.6)';
      dot.style.animation = 'blink-red 1s infinite';
      text.textContent = 'Offline!';
      text.style.color = '#E34D4D';
      lastConnectivityStatus = 'offline';
    } else if(status === 'connecting'){
      dot.style.background = '#FFD700';
      dot.style.boxShadow = '0 0 8px rgba(255,215,0,0.6)';
      dot.style.animation = 'pulse-yellow 1.5s infinite';
      text.textContent = 'Verbindung...';
      text.style.color = '#FFD700';
      lastConnectivityStatus = 'connecting';
    }
  }
  
  // Connectivity-Check (alle 10 Sekunden)
  function checkConnectivity(){
    const isOnline = navigator.onLine;
    
    // Zusätzlicher Ping-Test: aktuelle Seite (existiert immer), kein Favicon (404 auf GitHub Pages)
    if(isOnline){
      const pingUrl = (window.location.origin + (window.location.pathname || '/')) + '?t=' + Date.now();
      fetch(pingUrl, { method: 'HEAD', cache: 'no-cache' })
        .then((r) => {
          updateStatusIndicator(r.ok ? 'online' : 'offline');
        })
        .catch(() => {
          updateStatusIndicator('offline');
        });
    } else {
      updateStatusIndicator('offline');
    }
  }
  
  // Connectivity-Check starten (nur im Provider-Modus)
  function startConnectivityCheck(){
    if(connectivityCheckInterval) clearInterval(connectivityCheckInterval);
    
    // Initial-Check
    checkConnectivity();
    
    // Alle 10 Sekunden prüfen
    connectivityCheckInterval = setInterval(checkConnectivity, 10000);
    
    // Event-Listener für Online/Offline-Events
    window.addEventListener('online', () => {
      updateStatusIndicator('connecting');
      setTimeout(() => checkConnectivity(), 1000);
    });
    window.addEventListener('offline', () => {
      updateStatusIndicator('offline');
    });
  }
  
  // Connectivity-Check stoppen
  function stopConnectivityCheck(){
    if(connectivityCheckInterval){
      clearInterval(connectivityCheckInterval);
      connectivityCheckInterval = null;
    }
  }
  
  // Support-Hilfe öffnen (von Status-Ampel oder Support-Button)
  function openSupportHelp(){
    openSupportContact();
  }
  
  // Support-Kontakt öffnen
  function openSupportContact(){
    const bd = document.getElementById('supportContactBd');
    const sheet = document.getElementById('supportContactSheet');
    if(bd) bd.classList.add('active');
    if(sheet) sheet.classList.add('active');
    
    // Formular zurücksetzen
    const form = document.getElementById('supportContactForm');
    if(form) form.style.display = 'none';
    const message = document.getElementById('supportContactMessage');
    if(message) message.value = '';
    
    // Themen-Buttons zurücksetzen
    ['technik', 'abrechnung', 'feedback'].forEach(topic => {
      const btn = document.getElementById('supportTopic' + topic.charAt(0).toUpperCase() + topic.slice(1));
      if(btn){
        btn.style.border = '2px solid #eee';
        btn.style.background = '#fff';
      }
    });
    
    // Icons rendern
    if(typeof lucide !== 'undefined'){
      setTimeout(() => lucide.createIcons(), 50);
    }
  }
  
  // Support-Kontakt schließen
  function closeSupportContact(){
    const bd = document.getElementById('supportContactBd');
    const sheet = document.getElementById('supportContactSheet');
    if(bd) bd.classList.remove('active');
    if(sheet) sheet.classList.remove('active');
  }
  
  // Support-Thema auswählen
  let selectedSupportTopic = null;
  function selectSupportTopic(topic){
    selectedSupportTopic = topic;
    
    // Alle Buttons zurücksetzen
    ['technik', 'abrechnung', 'feedback'].forEach(t => {
      const btn = document.getElementById('supportTopic' + t.charAt(0).toUpperCase() + t.slice(1));
      if(btn){
        btn.style.border = '2px solid #eee';
        btn.style.background = '#fff';
      }
    });
    
    // Ausgewählten Button markieren
    const btn = document.getElementById('supportTopic' + topic.charAt(0).toUpperCase() + topic.slice(1));
    if(btn){
      btn.style.border = '2px solid #E34D4D';
      btn.style.background = 'rgba(227,77,77,0.05)';
    }
    
    // Formular anzeigen
    const form = document.getElementById('supportContactForm');
    if(form) form.style.display = 'block';
    
    // Textarea fokussieren
    const message = document.getElementById('supportContactMessage');
    if(message){
      setTimeout(() => message.focus(), 100);
    }
  }
  
  // Support-Kontakt absenden
  function submitSupportContact(){
    if(!selectedSupportTopic){
      showToast('Bitte wähle ein Thema aus');
      return;
    }
    
    const message = document.getElementById('supportContactMessage');
    const messageText = message ? message.value.trim() : '';
    
    if(!messageText){
      showToast('Bitte gib eine Nachricht ein');
      if(message) message.focus();
      return;
    }
    
    const profile = normalizeProviderProfile(provider.profile || {});
    const providerName = profile.name || provider.email || 'Anbieter';
    
    // Themen-Mapping
    const topicLabels = {
      'technik': 'Technik & App',
      'abrechnung': 'Abrechnung & Zahlung',
      'feedback': 'Feedback & Ideen'
    };
    
    // E-Mail vorbereiten
    const subject = encodeURIComponent(`Support-Anfrage: ${topicLabels[selectedSupportTopic] || 'Allgemein'}`);
    const body = encodeURIComponent(`Hallo Mike,\n\nIch habe eine Anfrage zum Thema: ${topicLabels[selectedSupportTopic] || 'Allgemein'}\n\n${messageText}\n\n---\nAnbieter: ${providerName}\nE-Mail: ${provider.email || 'Nicht angegeben'}\nStatus: ${lastConnectivityStatus === 'offline' ? 'Offline' : 'Online'}\nZeitpunkt: ${new Date().toLocaleString('de-DE')}`);
    
    // E-Mail öffnen
    window.location.href = `mailto:support@mittagio.de?subject=${subject}&body=${body}`;
    
    // Automatische Antwort-Mail senden (vorbereitet für Backend)
    sendSupportAutoReply(providerName, selectedSupportTopic);
    
    // Erfolgs-Toast
    showToast('E-Mail geöffnet – Vielen Dank für deine Nachricht!');
    
    // Sheet schließen nach kurzer Verzögerung
    setTimeout(() => {
      closeSupportContact();
    }, 1500);
  }
  
  // Automatische Antwort-Mail senden (vorbereitet für Backend)
  function sendSupportAutoReply(providerName, topic){
    // Themen-Mapping für Auto-Reply
    const topicLabels = {
      'technik': 'Technik & App',
      'abrechnung': 'Abrechnung & Zahlung',
      'feedback': 'Feedback & Ideen'
    };
    
    // TODO: In Production: Backend-Endpoint aufrufen
    // POST /api/send-support-auto-reply
    // Body: { providerId, providerName, providerEmail, topic, message, ... }
    
    // MVP: Log für Debugging
    const autoReplySubject = 'Deine Nachricht an das Mittagio-Team 🤝';
    const autoReplyBody = `Hallo ${providerName},\n\nvielen Dank für deine Nachricht! Wir haben deine Anfrage zum Thema ${topicLabels[topic] || 'Allgemein'} erhalten.\n\nDa wir wissen, dass es in der Küche oft stressig zugeht, geben wir Vollgas: Wir schauen uns dein Anliegen sofort an und melden uns innerhalb der nächsten 24 Stunden persönlich bei dir.\n\nIn der Zwischenzeit: Schau gerne in unsere 'Erste-Hilfe'-Checkliste in deinem Profil – oft lässt sich dort schon eine schnelle Lösung finden.\n\nBeste Grüße,\nMike von Mittagio`;
    
    if(false && typeof console !== 'undefined') console.log('[Support Auto-Reply]', {
      providerId: providerId(),
      providerName: providerName,
      providerEmail: provider.email,
      topic: topic,
      subject: autoReplySubject,
      body: autoReplyBody,
      timestamp: new Date().toISOString()
    });
    
    // In Production würde hier ein fetch() zum Backend erfolgen:
    /*
    fetch('/api/send-support-auto-reply', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        providerId: providerId(),
        providerName: providerName,
        providerEmail: provider.email,
        topic: topic,
        autoReplySubject: autoReplySubject,
        autoReplyBody: autoReplyBody
      })
    }).catch(err => console.error('Support Auto-Reply failed:', err));
    */
  }
  
  // Backup-E-Mail an Anbieter senden (vorbereitet für Backend-Integration)
  function sendBackupEmailToProvider(order){
    // TODO: In Production: Backend-Endpoint aufrufen
    // POST /api/send-backup-email
    // Body: { orderId, providerId, pickupCode, dishName, ... }
    
    // MVP: Log für Debugging
    if(false && typeof console !== 'undefined') console.log('[Backup-Email]', {
      orderId: order.id,
      providerId: order.providerId,
      pickupCode: order.pickupCode,
      dishName: order.dishName,
      timestamp: new Date().toISOString()
    });
    
    // In Production würde hier ein fetch() zum Backend erfolgen:
    /*
    fetch('/api/send-backup-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        orderId: order.id,
        providerId: order.providerId,
        pickupCode: order.pickupCode,
        dishName: order.dishName,
        providerEmail: provider.profile?.kitchenEmail || provider.email,
        timestamp: new Date().toISOString()
      })
    }).catch(err => console.error('Backup-Email failed:', err));
    */
  }
  
  // Auto-Reload-Logik (alle 30 Sekunden, nur wenn offline)
  function autoReloadIfNeeded(){
    if(!navigator.onLine && mode === 'provider'){
      // Wenn offline, versuche Seite neu zu laden (nur wenn wirklich nötig)
      const lastReload = load('mittagio_last_reload', 0);
      const now = Date.now();
      if(now - lastReload > 30000){ // Maximal alle 30 Sekunden
        save('mittagio_last_reload', now);
        // Leise Reload (ohne Benutzer zu stören)
        window.location.reload();
      }
    }
  }
  
  // Initialisierung startet
  renderChips();

  // init nav bindings
  if(mode==='provider' && !provider.loggedIn) mode='customer';
  if(mode==='start') mode='customer';
  
  // Single-Session: Cookie aus DB wiederherstellen, falls fehlt (z. B. nach Reload)
  if(mode === 'provider' && provider.loggedIn && provider.current_session_id && !getCookie(SESSION_COOKIE_NAME)){
    setCookie(SESSION_COOKIE_NAME, provider.current_session_id, SESSION_COOKIE_DAYS);
  }
  
  // Session-Validität prüfen BEVOR setMode aufgerufen wird (checkSingleSession)
  if(mode === 'provider' && provider.loggedIn){
    if(!checkSessionValidity()){
      // Session ungültig, wurde bereits ausgeloggt
      mode = 'customer';
    }
  }

  /* Verhindert, dass der Browser nach Reload die alte Scroll-Position wiederherstellt (Provider-Inhalt oben). */
  if(typeof history !== 'undefined' && history.scrollRestoration) history.scrollRestoration = 'manual';

  /* Scroll-Reset nach Reload: Browser stellt ggf. nach unserem JS wieder her – load+setTimeout schlägt das */
  function providerScrollReset(){
    if(!document.body.classList.contains('provider-mode')) return;
    window.scrollTo(0,0);
    if(document.documentElement) document.documentElement.scrollTop=0;
    if(document.body) document.body.scrollTop=0;
    var m=document.querySelector('main'); if(m) m.scrollTop=0;
  }
  window.addEventListener('load', function(){ setTimeout(providerScrollReset, 0); setTimeout(providerScrollReset, 100); });

  // Magic Link: #/plan/[Anbieter-ID] – öffentliche Wochenplan-Ansicht (Kunde sieht nur Verkaufspreis, 3 Säulen)
  var planMatch = (location.hash || '').match(/^#\/plan\/(.+)$/);
  var path = (window.location.pathname || '').replace(/\/$/, '');
  if(path.indexOf('/anbieter/hilfe/faq') !== -1 && typeof provider !== 'undefined' && provider && provider.loggedIn){
    setMode('provider');
    showLegalPage('faq-provider');
  } else if(path.indexOf('/anbieter/hilfe/inserat') !== -1 && typeof provider !== 'undefined' && provider && provider.loggedIn){
    setMode('provider');
    showLegalPage('inserat-info-provider');
  } else if(planMatch && typeof showPlanPublicView === 'function'){
    showPlanPublicView(decodeURIComponent(planMatch[1]));
  } else {
    setMode(mode);
    if(mode==='provider') providerScrollReset();
  }
  document.body.style.visibility = 'visible'; /* Init-Gate: nach View-Switch anzeigen */
  window.addEventListener('hashchange', function(){
    var m = (location.hash || '').match(/^#\/plan\/(.+)$/);
    if(m && typeof showPlanPublicView === 'function') showPlanPublicView(decodeURIComponent(m[1]));
    else if(typeof hidePlanPublicView === 'function'){ hidePlanPublicView(); setMode(mode); }
  });
  
  // WIZARD RESTORATION: Restore open wizard if needed (z. B. nach Refresh)
  try {
    const wizardOpen = localStorage.getItem('mittagio_wizard_open') === 'true';
    const draftStr = localStorage.getItem('wizard_draft');
    if(wizardOpen && draftStr){
      const draft = JSON.parse(draftStr);
      if(draft && draft.kind){
        // Global 'w' object is used by the wizard
        w = draft;
        var wizardEl = document.getElementById('wizard');
        if(wizardEl && w.kind === 'listing'){ wizardEl.setAttribute('data-flow', 'listing'); if(typeof clearWizardActionsBar === 'function') clearWizardActionsBar(); }
        openWizard();
        // Restore specific step content (Kochbuch = InseratCard)
        if(w.kind === 'listing') buildListingStep();
        else if(w.kind === 'provider') buildProviderStep();
        else if(w.kind === 'cookbook') { w.kind = 'listing'; if(wizardEl) wizardEl.setAttribute('data-flow', 'listing'); if(typeof clearWizardActionsBar === 'function') clearWizardActionsBar(); buildListingStep(); }
      }
    }
  } catch(e) { console.error('Failed to restore wizard state', e); }
  
  // Connectivity-Check starten wenn Provider-Modus
  if(mode === 'provider' && provider.loggedIn){
    startConnectivityCheck();
    // Auto-Reload-Check alle 30 Sekunden
    setInterval(autoReloadIfNeeded, 30000);
  }
  
  updateProfileView();
  
  if(mode === 'customer'){
    setTimeout(()=>{
      if(typeof renderDiscover !== 'undefined'){
        renderDiscover();
      }
      if(typeof lucide !== 'undefined'){
        setTimeout(()=> lucide.createIcons(), 150);
      }
    }, 100);
  }
  
  if(mode === 'start'){
    setTimeout(()=>{
      if(typeof renderStart !== 'undefined'){
        renderStart();
      }
    }, 200);
  }

  // Health-Check für die ganze Seite (einmal nach 500 ms)
  setTimeout(function mittagioHealthCheck(){
    var missing = [];
    var ids = [
      'v-discover','v-profile','v-cart','v-fav','v-orders','v-plan-public',
      'customerNav','discoverOffers','discoverEmpty','discoverCategoriesBar','discoverDaysBar',
      'providerLoginBd','providerLoginSheet','btnProviderLoginModal','btnProfileProviderPortal',
      'v-provider-home','v-provider-week','providerNavWrap'
    ];
    ids.forEach(function(id){
      if(!document.getElementById(id)) missing.push(id);
    });
    var activeViews = document.querySelectorAll('.view.active');
    var oneActive = activeViews.length === 1;
    if(missing.length === 0 && oneActive){
      if(typeof console !== 'undefined') console.log('Mittagio Health Check: OK');
    } else {
      if(typeof console !== 'undefined'){
        console.warn('Mittagio Health Check:', missing.length ? 'Fehlende IDs: ' + missing.join(', ') : 'OK', oneActive ? '' : 'Aktive Views: ' + activeViews.length + ' (erwartet 1)');
      }
    }
  }, 500);
</script>

<script>
  // Zweites Script: Zugriff auf Mode/LS nur über localStorage (eigener Scope)
  var MODE_KEY = 'mittagio_mode_v1';
  var ORDERS_KEY = 'mittagio_orders_v1';
  var OFFERS_KEY = 'mittagio_offers_v2';
  function getMode(){ try { return localStorage.getItem(MODE_KEY) || 'customer'; } catch(e){ return 'customer'; } }
  // Icon-Initialisierung (immer, nicht nur bei Service Worker)
  function initIcons(){
    if(typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function'){
      try { lucide.createIcons(); } catch(e) { console.warn('Lucide createIcons:', e); }
    } else {
      // Warte bis Lucide geladen ist (max. 2 Sekunden)
      let attempts = 0;
      const checkLucide = setInterval(()=>{
        attempts++;
        if(typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function'){
          try { lucide.createIcons(); } catch(err) { console.warn('Lucide createIcons:', err); }
          clearInterval(checkLucide);
        } else if(attempts > 20){ // Nach 2 Sekunden aufgeben
          clearInterval(checkLucide);
        }
      }, 100);
    }
  }

  // Beispieldaten laden: 10 Anbieter mit je 3 Gerichten und 10 Abholnummers
  // WICHTIG: seedExampleData() NACH seed() aufrufen, damit die neuen Daten nicht überschrieben werden
  // seedExampleData() wird am Ende aufgerufen (siehe unten)
  
  // Test-Funktion global verfügbar machen (in Browser-Konsole: testPickupCodeLogic() aufrufen)
  if(typeof testPickupCodeLogic !== 'undefined'){
    window.testPickupCodeLogic = testPickupCodeLogic;
  }

  // PWA (optional)
  // TEMPORÄR DEAKTIVIERT ZUM TESTEN
  if(false && 'serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      // Service Worker-Pfad relativ zum aktuellen Verzeichnis
      const swPath = document.querySelector('base') ? 'sw.js' : './sw.js';
      navigator.serviceWorker.register(swPath).catch(()=>{});
      // Icons initialisieren
      initIcons();
      // Profile-View aktualisieren
      if(typeof updateProfileView !== 'undefined'){
        updateProfileView();
      }
      // Startseite rendern, falls im start-Mode
      if(getMode() === 'start' && typeof renderStart !== 'undefined'){
        setTimeout(()=>{
          renderStart();
          initIcons();
        }, 100);
      }
    });
  } else {
    // Fallback: Icons auch ohne Service Worker initialisieren
    window.addEventListener('load', ()=>{
      initIcons();
      // Topbar: Kundefarben setzen, wenn initial aktive View eine Kundenseite ist
      const activeView = document.querySelector('.view.active');
      const topbar = document.querySelector('.topbar');
      if(topbar && activeView && activeView.classList.contains('customer-view')){
        topbar.classList.add('customer-context');
      }
      // Profile-View aktualisieren
      if(typeof updateProfileView !== 'undefined'){
        updateProfileView();
      }
      // Startseite rendern, falls im start-Mode
      if(getMode() === 'start' && typeof renderStart !== 'undefined'){
        setTimeout(()=>{
          renderStart();
          initIcons();
        }, 100);
      }
    });
  }
  
  // Offline/Online Event-Handler (Fallback-Verhalten)
  window.addEventListener('online', () => {
    // Optional: Toast anzeigen
    if(typeof showToast === 'function'){
      showToast('Verbindung wiederhergestellt', 2000);
    }
    // Optional: Daten neu laden
    if(getMode() === 'customer' && typeof renderDiscover === 'function'){
      renderDiscover();
    }
  });
  
  window.addEventListener('offline', () => {
    // Optional: Toast anzeigen
    if(typeof showToast === 'function'){
      showToast('Keine Internetverbindung', 3000);
    }
    // Hinweis: Service Worker ist deaktiviert, daher keine Offline-Funktionalität
  });

  // Icons nach jedem View-Wechsel aktualisieren
  if(typeof showView !== 'undefined'){
    const originalShowView = showView;
    showView = function(id){
      originalShowView(id);
      setTimeout(()=> initIcons(), 50);
    };
  }
  // ---------------------------------------------------------
  // LIVE SYNC & OFFLINE HANDLING
  // ---------------------------------------------------------
  function setupLiveSync(){
    window.addEventListener('storage', (e) => {
      if(e.key === ORDERS_KEY || e.key === OFFERS_KEY){
        if(typeof refreshCurrentView === 'function') refreshCurrentView();
      }
    });

    setInterval(() => {
      if(document.visibilityState === 'visible' && getMode() === 'provider'){
        if(typeof refreshCurrentView === 'function') refreshCurrentView(true);
      }
    }, 10000);

    function updateOnlineStatus(){
      const isOnline = navigator.onLine;
      let statusEl = document.getElementById('appOnlineStatus');
      if(!isOnline){
        if(!statusEl){
          statusEl = document.createElement('div');
          statusEl.id = 'appOnlineStatus';
          statusEl.style.cssText = 'position:fixed; bottom:0; left:0; right:0; background:#d32f2f; color:#fff; font-size:12px; font-weight:700; text-align:center; padding:6px; z-index:9999; box-shadow:0 -2px 10px rgba(0,0,0,0.2);';
          statusEl.textContent = '⚠️ Keine Internetverbindung – Offline-Modus aktiv';
          document.body.appendChild(statusEl);
        } else {
          statusEl.style.display = 'block';
        }
      } else {
        if(statusEl) statusEl.style.display = 'none';
      }
    }
    
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();
  }

  function refreshCurrentView(silent=false){
    const activeView = document.querySelector('.view.active');
    if(!activeView) return;
    if(activeView.id === 'v-provider-home'){ if(typeof renderProviderHome==='function') renderProviderHome(); }
    else if(activeView.id === 'v-provider-pickups'){ if(typeof renderProviderPickups==='function') renderProviderPickups(); }
  }

  setupLiveSync();
</script>
  <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js" async></script>
</body>
</html>
