  <!doctype html>
<html lang="de">
<head>
  <base href="/mittagio/app/">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=5,user-scalable=yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Mittagio</title>
  <meta name="theme-color" content="#FFD700" />
  <!-- Konzept-Icons: 1. Mehrweg (assets/icon-mehrweg.png) | 2. Essen vor Ort (assets/icon-essen-vor-ort.png) | 3. Abholnummer (assets/icon-abholnummer.png) -->
  <!-- Build: 2026-02-04 -->
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="assets/icons/icon-192.png" />
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png" />
  <script src="https://unpkg.com/lucide@latest" onload="if(typeof lucide !== 'undefined') lucide.createIcons();"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Montserrat:wght@400;600;700;900&family=Kalam:wght@400;700&family=Permanent+Marker&family=Nunito:wght@600;700;800&family=Quicksand:wght@500;600;700&display=swap');
    :root{
      /* Mittagio High-End Farbpalette */
      --bg:#F7F6F0; /* Standard-Hintergrund */
      --bg-polaroid:#E8E0D6; /* Gebleichte Eiche (Polaroid-Discovery Hintergrund) */
      --card:#FFFFFF;
      --text:#334155;   /* Slate Grey - edler als reines Schwarz */
      --muted:#6b6b6b;
      --border:#e7e1d5;
      --shadow:0 10px 24px rgba(0,0,0,.08);
      --shadow2:0 16px 40px rgba(0,0,0,.14);
      --radius:24px;     /* rounded-3xl for messenger vibe */
      --brand:#FFD700;   /* Mittagio Gold - PrimÃ¤r (Korb, Abholnummer-Buttons) */
      --brand2:#2ECC71;  /* Erfolgs-GrÃ¼n - Profit (Netto-Umsatz) */
      --brand3:#27AE60;  /* Mehrweg-GrÃ¼n - Dezent (Blatt-Icon) */
      --sticker-green:#27AE60; /* Preis-Sticker & Mehrweg-Badge (Polaroid-Card) */
      --danger:#E34D4D;
      --font-polaroid-marker:'Permanent Marker', 'Kalam', cursive;
      
      /* Design Tokens - PWA Light */
      /* Radius */
      --r-sm: 10px;
      --r-md: 14px;
      --r-lg: 18px;
      --r-xl: 24px;
      --r-full: 999px;
      
      /* Spacing */
      --s-1: 4px;
      --s-2: 8px;
      --s-3: 12px;
      --s-4: 16px;
      --s-5: 20px;
      --s-6: 24px;
      --s-8: 32px;
      
      /* Typography */
      --font-title: 18px;
      --font-title-lg: 20px;
      --font-body: 14px;
      --font-body-lg: 16px;
      --font-meta: 12px;
      --font-meta-sm: 13px;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;
      
      /* Colors (Light) */
      --color-bg: #FFFFFF;
      --color-surface: #FFFFFF;
      --color-border: #EAEAEA;
      --color-text: #1A1A1A;
      --color-text-secondary: #6B6B6B;
      --color-brand-yellow: #FFD700;  /* Mittagio Gold */
      --color-emerald: #10b981;       /* High-Tech-Gastro Akzent (Inseratsflow, Pills) */
      --color-success-green: #2ECC71;  /* Erfolgs-GrÃ¼n - Profit */
      --color-eco-green: #27AE60;      /* Mehrweg-GrÃ¼n - Dezent */
      --color-slate-text: #334155;     /* Slate Grey - Texte */
      --color-soft-yellow-bg: rgba(255, 204, 0, 0.15);
      --color-soft-green-bg: rgba(31, 157, 85, 0.12);
      --color-soft-grey-bg: rgba(0, 0, 0, 0.06);
      
      /* Icon Sizes */
      --icon-inline: 16px;
      --icon-inline-lg: 18px;
      --icon-header: 20px;
      --icon-header-lg: 22px;
      --icon-nav: 22px;
      --icon-nav-lg: 24px;
      
      /* Button Heights */
      --btn-height-min: 44px;
      --btn-height-md: 48px;
      
      /* Badge */
      --badge-height: 24px;
      --badge-px: 10px;
      --badge-px-lg: 12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Inter', 'Montserrat', system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-size:16px;
      line-height:1.5;
      background:var(--bg);
      color:var(--text);
      /* Touch-Optimierungen fÃ¼r Mobile */
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      touch-action: pan-y pinch-zoom; /* Vertikales Scrollen erlauben, horizontales Swipe verhindern */
      overscroll-behavior-y: none; /* Verhindert "Pull-to-Refresh" / Gelbe Leiste */
    }
    
    /* Hide Provider Status Indicator in Customer Mode (Fix Green Dot) */
    body:not(.provider-mode) #providerStatusIndicator,
    body:not(.provider-mode) #statusIndicatorDot {
      display: none !important;
    }
    
    a{color:inherit}

    /* App shell */
    .app{min-height:100%; padding-bottom:calc(78px + env(safe-area-inset-bottom, 0px));}
    .topbar{
      position:sticky; top:0; z-index:10;
      background:rgba(247,246,240,.92);
      backdrop-filter:saturate(160%) blur(8px);
      -webkit-backdrop-filter:saturate(160%) blur(8px);
      border-bottom:1px solid var(--border);
      padding-top:env(safe-area-inset-top, 0px);
      padding-left:env(safe-area-inset-left, 0);
      padding-right:env(safe-area-inset-right, 0);
    }
    .topbar-inner{max-width:980px; margin:0 auto; padding:12px 16px; display:flex; align-items:center; gap:10px;}
    .header-basket-btn{
      position:relative;
      background:none;
      border:none;
      cursor:pointer;
      padding:8px;
      transition:transform 0.2s ease, filter 0.3s ease;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .header-basket-btn:hover{
      transform:scale(1.1);
    }
    .header-basket-btn:active{
      transform:scale(0.95);
    }
    .header-basket-btn.bounce{
      animation:basketBounce 0.5s ease;
    }
    .header-basket-btn.glow{
      filter:drop-shadow(0 0 12px rgba(255,215,0,0.8));
    }
    @keyframes basketBounce{
      0%, 100%{transform:scale(1);}
      50%{transform:scale(1.2);}
    }
    .header-basket-badge{
      position:absolute;
      top:4px;
      right:4px;
      width:18px;
      height:18px;
      background:#FFD700;
      color:#2D3436;
      border-radius:50%;
      font-size:11px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
      border:2px solid #fff;
      box-shadow:0 2px 8px rgba(0,0,0,0.15);
    }
    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
      cursor:pointer;
      transition:opacity 0.2s ease;
    }
    .brand:hover{
      opacity:0.8;
    }
    .brand:active{
      opacity:0.6;
    }
    .brand-badge{
      width:38px; height:38px; border-radius:12px;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      box-shadow:0 8px 18px rgba(0,0,0,.16);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .brand-badge img{width:100%; height:100%; object-fit:cover; display:block}
    .brand-name{font-weight:900; letter-spacing:.06em; font-size:20px; white-space:nowrap}
    .spacer{flex:1}

    .chiprow{
      max-width:980px; margin:0 auto; padding:6px 14px 8px;
      display:flex; gap:8px; overflow:auto; -webkit-overflow-scrolling:touch;
    }
    
    /* Verzehrart-Buttons: Active-State mit gelber Hintergrundfarbe */
    .verzehrmodus-checkout-btn.active,
    .verzehrmodus-cart-btn.active{
      background:#FFD700 !important;
      border-color:#FFD700 !important;
      color:#2D3436 !important;
      font-weight:900 !important;
    }
    .verzehrmodus-checkout-btn:not(.active),
    .verzehrmodus-cart-btn:not(.active){
      background:#fff !important;
      border-color:#e7e1d5 !important;
      color:#666 !important;
      font-weight:600 !important;
    }
    .verzehrmodus-checkout-btn:hover:not(.active),
    .verzehrmodus-cart-btn:hover:not(.active){
      border-color:#FFD700 !important;
      background:#fffbf0 !important;
    }
    
    /* Pickup Card Styles (Dark Mode) */
    .pickup-card {
      background: #1c1c1e;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 16px;
      position: relative;
      overflow: hidden;
      transition: all 0.2s;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .pickup-card:active {
      transform: scale(0.98);
    }
    .pickup-card.status-done {
      opacity: 0.5;
      background: #2c2c2e;
    }
    .pickup-card.status-paid {
      border-color: rgba(46, 204, 113, 0.3);
    }
    .pickup-card.just-done {
      animation: pickupDoneAnim 0.4s ease forwards;
    }
    @keyframes pickupDoneAnim {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 1; background: #2ecc71; }
      100% { transform: scale(0.95); opacity: 0; }
    }
    
    .chip{
      flex:0 0 auto;
      border:1px solid var(--border);
      background:#f8f7f3;
      padding:10px 16px;
      border-radius:999px;
      font-size:14px;
      font-weight:800;
      color:#222;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .chip.active{
      border-color:rgba(31,157,85,.45);
      background:rgba(31,157,85,.12);
      box-shadow:0 10px 22px rgba(31,157,85,.12)
    }

    .pickup-group{
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      padding:10px;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .pickup-group + .pickup-group{margin-top:10px}
    .pickup-head{display:flex; align-items:center; justify-content:space-between; gap:8px; font-weight:900}
    .pickup-sub{font-size:12px; color:var(--muted)}
    .code-chip{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px; border:1px solid var(--border);
      background:#fff; font-size:12px; font-weight:900;
      margin:4px 6px 0 0; box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .code-chip.done{background:rgba(31,157,85,.12); border-color:rgba(31,157,85,.4); color:#1f9d55; text-decoration:line-through}

    /* Abholnummer Card Animation (Pulse/Shimmer) */
    /* Match-Screen Animationen */
    @keyframes scaleIn {
      0% { transform: scale(0); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    @keyframes slideUp {
      0% { transform: translateY(20px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    @keyframes abholnummerPulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
      }
      50% {
        transform: scale(1.01);
        box-shadow: 0 25px 30px -5px rgba(255,204,0,0.15), 0 15px 15px -5px rgba(255,204,0,0.08);
      }
    }
    @keyframes abholnummerShimmer {
      0% {
        background-position: -200% 0;
      }
      100% {
        background-position: 200% 0;
      }
    }
    .ticket-card-pulse {
      animation: abholnummerPulse 2s ease-in-out infinite;
    }
    .ticket-card-pulse::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: abholnummerShimmer 3s ease-in-out infinite;
    }

    .dayrow{
      max-width:980px; margin:0 auto; padding:0 14px 12px;
      display:flex; gap:8px; overflow:auto; -webkit-overflow-scrolling:touch;
    }
    .day{
      flex:0 0 auto;
      border:none;
      background:#fff;
      padding:12px 16px;
      border-radius:999px;
      font-size:14px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      border:1px solid var(--border);
    }
    .day.active{background:rgba(242,183,5,.14); border-color:rgba(242,183,5,.55)}

    main{max-width:980px; margin:0 auto; padding:16px}
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    @media (min-width:820px){ .grid{grid-template-columns:1fr 1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:20px;
      overflow:hidden;
      box-shadow:0 4px 16px rgba(0,0,0,.08);
      cursor:pointer;
      position:relative;
      margin-bottom:16px;
    }
    /* Polaroid-Discovery: WeiÃŸer Rand â€“ schmaler an den Seiten, breiter unter dem Text */
    .card.polaroid{
      background:#FFFFFF;
      border:none;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
      padding:0 6px 20px 6px; /* schmaler seitlich, breiter unten */
      display:flex;
      flex-direction:column;
      align-items:stretch;
      width:100%;
      max-width:100%;
      margin:0 auto;
      overflow:hidden;
      background:linear-gradient(135deg, #f5f1eb 0%, #ede8e0 100%);
      box-sizing:border-box;
    }
    @media (max-width: 480px) {
      .card.polaroid {
        padding:0 5px 16px 5px;
      }
    }
    .card.playful{
      border-color:rgba(242,183,5,.38);
      box-shadow:0 12px 26px rgba(242,183,5,.18);
    }
    .card.playful .body{
      background:linear-gradient(180deg,#fff, #fff4e6);
    }
    .card.playful .price{color:#b26b00}
    .card.playful .tag{background:rgba(242,183,5,.25)}
    .img{aspect-ratio:16/9; height:auto; min-height:120px; max-height:140px; background:#eee; position:relative; overflow:hidden; border-radius:20px 20px 0 0}
    .img img{width:100%; height:100%; object-fit:cover; display:block}
    /* Polaroid: Foto nimmt exakt 50% der KachelhÃ¶he ein */
    .card.polaroid .img{
      width:100%;
      height:50%; /* Exakt 50% der KartenhÃ¶he */
      min-height:140px;
      max-height:140px;
      border-radius:0;
      position:relative;
      overflow:hidden;
      flex-shrink:0;
    }
    
    /* Badge-Overlay oben links auf dem Bild */
    .badge-overlay {
      position: absolute;
      top: 8px;
      left: 8px;
      display: flex;
      gap: 6px;
      z-index: 10;
    }
    
    /* Der einzelne kreisrunde Badge-Button */
    .badge-icon {
      width: 28px;
      height: 28px;
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    /* Bild innerhalb des Badges */
    .badge-icon img {
      width: 18px;
      height: 18px;
      object-fit: contain;
    }
    
    /* 3 SÃ¤ulen: Modern Badges (Icon + Text) */
    .pillar-bars {
      display: flex;
      gap: 12px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(0,0,0,0.05);
    }
    .pillar-badge {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      opacity: 0.4;
      filter: grayscale(1);
      transition: all 0.3s ease;
    }
    .pillar-badge.active {
      opacity: 1;
      filter: grayscale(0);
    }
    
    .pillar-icon-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f0f0f0;
      color: #666;
      font-size: 14px;
      transition: all 0.3s;
    }
    .pillar-badge.active.green .pillar-icon-circle { background: rgba(39, 174, 96, 0.15); color: #27AE60; }
    .pillar-badge.active.yellow .pillar-icon-circle { background: rgba(255, 193, 7, 0.15); color: #f39c12; }
    .pillar-badge.active.blue .pillar-icon-circle { background: rgba(52, 152, 219, 0.15); color: #3498db; }
    
    .pillar-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #999;
      text-align: center;
    }
    .pillar-badge.active .pillar-label { color: #333; }
    
    .card.polaroid .img img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .provider-logo{
      display:flex; align-items:center; gap:8px;
      padding:12px 14px 0;
    }
    .plogo{
      width:28px; height:28px; border-radius:8px;
      background:#f2f2f2;
      overflow:hidden;
      border:1px solid var(--border);
      flex:0 0 auto;
    }
    .plogo img{width:100%; height:100%; object-fit:cover; display:block}
    .pname{font-size:14px; font-weight:900; color:#222; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; line-height:1.3}

    .body{padding:16px}
    .title{font-weight:950; font-size:18px; margin:0; line-height:1.3}
    .sub{margin:4px 0 0; color:#444; font-size:14px; line-height:1.4}
    
    /* Refactored Card Styles - weniger Text, mehr Icons */
    .card-heart{
      position:absolute; top:12px; right:12px; z-index:5;
      width:36px; height:36px; border-radius:50%;
      border:none; background:rgba(255,255,255,.9);
      backdrop-filter:blur(8px); display:flex;
      align-items:center; justify-content:center;
      cursor:pointer; transition:all .2s;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
    }
    .card-heart:hover{background:rgba(255,255,255,1); transform:scale(1.05)}
    .card-heart.on{background:rgba(255,204,0,.2)}
    .card-heart i{width:18px; height:18px; color:#999}
    .card-heart.on i{color:#e74c3c; fill:currentColor}
    
    .card-title-row{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:8px; margin-bottom:6px;
    }
    .card-title{
      font-weight:900; font-size:17px; margin:0;
      line-height:1.3; flex:1; min-width:0;
      display:-webkit-box; -webkit-line-clamp:2; line-clamp:2;
      -webkit-box-orient:vertical; overflow:hidden;
      color:#111;
    }
    .card-provider{
      font-size:13px; color:#666; margin:0 0 8px;
      line-height:1.3; font-weight:500;
      display:flex; align-items:center; gap:6px;
    }
    .card-provider .ico-inline{
      width:16px; height:16px; flex-shrink:0;
      color:var(--muted);
    }
    .card-provider .ico-inline svg{
      width:16px; height:16px;
    }
    .card-price{
      font-size:24px; font-weight:950; color:var(--brand);
      margin:0 0 10px; line-height:1;
    }
    .card-info-badges{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-bottom:10px; align-items:center;
    }
    .card-info-badge{
      display:inline-flex; align-items:center; gap:4px;
      font-size:13px; font-weight:600; color:#666;
      white-space:nowrap;
    }
    .card-info-badge .ico-inline{
      width:16px; height:16px; flex-shrink:0;
      color:var(--muted);
    }
    .card-info-badge .ico-inline svg{
      width:16px; height:16px;
    }
    .card-status-badges{
      display:flex; gap:6px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .card-status-badge{
      display:inline-flex; align-items:center; gap:4px;
      padding:4px 10px; border-radius:999px;
      font-size:11px; font-weight:600;
      background:rgba(0,0,0,.06); color:#666;
      white-space:nowrap;
    }
    .card-status-badge .ico-inline{
      width:14px; height:14px; flex-shrink:0;
    }
    .card-status-badge .ico-inline svg{
      width:14px; height:14px;
    }
    /* Abholnummer Badge: leicht hervorgehoben (Markenfarbe Gelb) */
    .card-status-badge.code{
      background:rgba(255,204,0,.2); color:#b8860b;
      font-weight:700;
    }
    .card-status-badge.code .ico-inline{color:#b8860b}
    /* Badge-Styles Abholnummer */
    .card-status-badge.dine{
      background:rgba(31,157,85,.12); color:#1f9d55;
    }
    .card-status-badge.dine .ico-inline{color:#1f9d55}
    /* Zum Mitnehmen Badge: neutrale weiche FÃ¼llung */
    .card-status-badge.pickup{
      background:rgba(0,0,0,.06); color:#666;
    }
    /* Konzept-Icons: Mehrweg, Essen vor Ort, Abholnummer (einheitliche GrÃ¶ÃŸe) */
    .concept-icon{ width:22px; height:22px; object-fit:contain; vertical-align:middle; flex-shrink:0; }
    .concept-icon-lg{ width:28px; height:28px; object-fit:contain; vertical-align:middle; flex-shrink:0; }
    .concept-icon-xl{ width:36px; height:36px; object-fit:contain; vertical-align:middle; flex-shrink:0; }

    .meta{display:flex; justify-content:space-between; align-items:flex-end; gap:12px; margin-top:12px}
    .price{font-weight:950; font-size:18px; color:#0f5c4c}
    .right{ text-align:right; font-size:13px; color:var(--muted); line-height:1.4 }
    .meta-line{display:flex; align-items:center; gap:6px; justify-content:flex-end}
    .tag{display:inline-block; margin-top:6px; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:900; background:rgba(242,183,5,.18)}

    .badge{
      position:absolute; top:12px; left:12px;
      background:rgba(17,17,17,.72);
      color:#fff;
      font-size:12px; font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      box-shadow:0 10px 22px rgba(0,0,0,.18);
      line-height:1.3;
    }
    .badge.code{left:auto; right:12px; background:rgba(31,157,85,.9)}
    .badge.dine{background:rgba(242,183,5,.9); color:#111}
    .badge.inactive{background:rgba(0,0,0,.45)}

    .heart{
      position:absolute; top:12px; right:12px;
      width:36px; height:36px; border-radius:999px;
      border:none; cursor:pointer;
      background:rgba(255,255,255,.92);
      box-shadow:0 10px 22px rgba(0,0,0,.16);
      font-size:16px;
      color:#bbb;
      display:flex; align-items:center; justify-content:center;
    }
    .heart.on{color:var(--danger)}

    /* Bottom nav - Glassmorphism Mittagio-Bar */
    .nav-badge{
      position:absolute; top:4px; right:8px;
      width:18px; height:18px;
      background:#FFD700; color:#2D3436;
      border-radius:50%; font-size:11px; font-weight:900;
      display:flex; align-items:center; justify-content:center;
      border:2px solid #fff; box-shadow:0 2px 8px rgba(0,0,0,0.15);
      z-index:10;
    }
    .navbtn.bounce{
      animation:basketBounce 0.5s ease;
    }
    .navbtn.glow{
      filter:drop-shadow(0 0 12px rgba(255,215,0,0.8));
    }
    @keyframes basketBounce{
      0%, 100%{transform:scale(1);}
      50%{transform:scale(1.15);}
    }
    .bottom{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      height:calc(60px + env(safe-area-inset-bottom, 20px));
      padding-bottom:env(safe-area-inset-bottom, 20px);
      padding-left:env(safe-area-inset-left, 0);
      padding-right:env(safe-area-inset-right, 0);
      background:rgba(255,255,255,.85);
      backdrop-filter:saturate(180%) blur(20px);
      -webkit-backdrop-filter:saturate(180%) blur(20px);
      border-top:1px solid rgba(231,225,213,.3);
      display:flex;
      box-shadow:0 -4px 20px rgba(0,0,0,.05);
    }
    .navbtn{
      flex:1; border:none; background:none; cursor:pointer;
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
      color:#777; font-size:11px; font-weight:600;
      padding:8px 4px; transition:color .2s;
      position:relative;
      -webkit-tap-highlight-color: transparent;
    }
    .navbtn * {
      pointer-events: none;
    }
    .navbtn .ico{font-size:22px; display:inline-flex; align-items:center; justify-content:center}
    .navbtn .ico svg{width:22px; height:22px; stroke-width:2}
    /* Bottom Navigation Icons: 22-24px */
    .navbtn.active{color:var(--brand)}
    .navbtn.active .ico svg{color:var(--brand); stroke:var(--brand)}
    .navbtn.active{color:var(--brand); font-weight:900}
    .navbtn .badge-notification{
      position:absolute; top:8px; right:calc(50% - 20px);
      width:8px; height:8px; border-radius:50%;
      background:var(--brand); border:2px solid rgba(255,255,255,.85);
    }

    /* Views */
    .view{display:none}
    .view.active{display:block}
    /* Abholnummer-Ansicht benÃ¶tigt flex-Layout */
    .view.active#v-pickup-code{display:flex !important}

    /* Kundenseiten: Einheitlicher Style von Seite 1 (Discovery) â€“ Farben & Look */
    .customer-view{
      background:var(--bg-polaroid);
      min-height:100vh;
      padding:0 12px 0;
      padding-bottom:calc(78px + env(safe-area-inset-bottom, 0px));
    }
    .customer-view .panel{
      background:rgba(255,255,255,0.95);
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
      border:1px solid rgba(0,0,0,0.06);
      border-radius:20px;
      box-shadow:0 4px 16px rgba(0,0,0,.06);
    }
    .customer-view .section-title{ color:#334155; }
    .customer-view .hint{ color:#64748b; }
    /* Topbar in Kundekontext: gleicher warmer Ton wie Seite 1 */
    .topbar.customer-context{
      background:rgba(232,224,214,0.92);
      border-bottom-color:rgba(0,0,0,0.08);
    }
    /* Provider-FAB und Abholnummer-Overlay in Kundenansicht nie anzeigen (auch beim Runterscrollen) */
    body:not(.provider-mode) #fabProviderAddOffer,
    body:not(.provider-mode) #fabProviderAddOfferLabel { display: none !important; }

    /* Sheets / modals â€“ Safe-Area fÃ¼r moderne Handys (S25, iPhone, Pixel) */
    .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.38); opacity:0; pointer-events:none; transition:opacity .2s; z-index:30}
    .backdrop.active{opacity:1; pointer-events:auto}
    .sheet{
      position:fixed; left:0; right:0; bottom:-120%; z-index:31;
      background:#fff; border-radius:22px 22px 0 0;
      box-shadow:var(--shadow2);
      transition:bottom .28s ease;
      max-height:92vh; overflow:auto;
      padding-left:env(safe-area-inset-left, 0);
      padding-right:env(safe-area-inset-right, 0);
      padding-bottom:env(safe-area-inset-bottom, 0);
    }
    .sheet.active{bottom:0}
    .handle{width:46px; height:5px; background:#ddd; border-radius:999px; margin:10px auto 6px}
    .sheet-img{height:260px; background:#eee}
    .sheet-img img{width:100%; height:100%; object-fit:cover; display:block}
    .sheet-body{padding:12px 14px 18px}
    .row{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px 0; border-top:1px solid #eee; font-size:15px; line-height:1.4}
    .btn{
      width:100%; border:none; cursor:pointer;
      border-radius:999px; padding:16px 20px; font-weight:950; font-size:16px;
      background:var(--brand); color:#111;
      line-height:1.4;
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn.secondary{background:#fff; border:1px solid var(--border)}
    .btn.ghost{background:#f8f7f3; border:1px solid var(--border)}
    .mini{font-size:13px; color:var(--muted); margin-top:8px; line-height:1.5}
    
    /* Primary CTA (Yellow, Dark Text, 56-64px) */
    .btn-primary{
      width:100%; border:none; cursor:pointer;
      border-radius:999px; padding:16px 20px; font-weight:950; font-size:16px;
      background:#f2b705; color:#111;
      line-height:1.4;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-height:56px; max-height:64px;
      transition:all .2s;
    }
    .btn-primary:active{
      background:#e6b800;
      transform:scale(0.98);
    }
    .btn-primary:disabled{
      opacity:.6; cursor:not-allowed; background:#f2b705;
    }
    .btn-primary.loading{
      opacity:.7; cursor:wait;
    }
    .btn-primary.success{
      background:#2e7d32; color:#fff;
    }

    .card-actions{display:flex; gap:8px; margin-top:12px}
    .card-action{
      flex:1; padding:0 16px; min-height:44px;
      border-radius:12px; border:none;
      background:#fff; font-weight:900; font-size:15px;
      cursor:pointer; transition:transform .1s, background .15s;
      display:flex; align-items:center; justify-content:center; gap:6px;
      text-align:center;
    }
    .card-action:active{transform:scale(.97)}
    .card-action.primary{
      background:var(--brand); color:#111;
      border:1px solid var(--brand);
      min-height:44px;
    }
    .card-action.primary:active{background:#e6b800}
    .card-action.ghost{background:#f8f7f3; border:1px solid var(--border)}
    .card-action:disabled{opacity:.5; cursor:not-allowed; background:#f5f5f5}

    /* Profile cards */
    .panel{background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:0 4px 16px rgba(0,0,0,.08); padding:16px; margin-bottom:16px}
    .panel h3{margin:0 0 10px; font-size:18px; font-weight:900; line-height:1.3}
    .section-title{font-weight:900; font-size:20px; margin:12px 0 8px; line-height:1.3}
    .rowlist{display:flex; flex-direction:column; gap:8px}
    .rowbtn{
      width:100%; border:1px solid var(--border); background:#fff; cursor:pointer;
      border-radius:14px; padding:12px; text-align:left; font-weight:900;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .rowbtn-left{display:flex; align-items:center; gap:10px; min-width:0}
    .rowbtn-ico{
      width:36px; height:36px; border-radius:10px; flex:0 0 auto;
      border:1px solid var(--border); background:#f8f7f3;
      display:flex; align-items:center; justify-content:center;
    }
    .rowbtn-ico svg{width:16px; height:16px}
    .rowbtn-text{min-width:0}
    .rowbtn-text span{display:block; font-weight:600; font-size:13px; color:var(--muted); margin-top:4px; line-height:1.4}
    .rowbtn .chev{font-size:20px; color:var(--muted)}
    .rowgroup-title{font-size:13px; font-weight:900; color:var(--muted); margin-top:8px; line-height:1.4}
    .profile-head{display:flex; align-items:center; gap:12px}
    .profile-head .plogo{width:56px; height:56px; border-radius:50%}
    .profile-meta{display:flex; flex-direction:column; gap:4px}
    .profile-chip{display:inline-flex; align-items:center; gap:6px; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900; background:#fff}
    .profile-actions{margin-top:10px}
    .profile-actions .btn{width:auto; margin-top:0}
    .row-group{margin-top:12px}
    .row-group .rowgroup-title{margin:0 0 8px}
    .row-muted{font-size:12px; color:var(--muted)}

    .tabrow{display:flex; gap:8px; flex-wrap:wrap}
    .tabrow .ans{font-size:12px; padding:8px 10px}
    /* Kochbuch: Fixed Layout â€“ Card = Bild (16:9) -> SÃ¤ulen (ðŸ´ðŸ§¾ðŸ”„) -> Daten */
    #v-provider-cookbook .cookbook-grid{
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:16px;
      margin-bottom:100px;
    }
    #v-provider-cookbook .cookbook-item{
      background:#fff;
      border:1px solid rgba(0,0,0,0.06);
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 2px 12px rgba(0,0,0,0.06);
      display:flex;
      flex-direction:column;
      position:relative;
      transition:transform 0.1s;
      font-family:system-ui,-apple-system,sans-serif;
    }
    #v-provider-cookbook .cookbook-item:active{ transform:scale(0.98); }
    /* Bild: 16:9 Querformat, clean (keine Schiefertafel) */
    #v-provider-cookbook .cookbook-item-header{
      position:relative;
      width:100%;
      aspect-ratio:16/9;
      background:#e5e7eb;
    }
    #v-provider-cookbook .cookbook-item-image{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    #v-provider-cookbook .cookbook-item-price-tag{
      position:absolute;
      bottom:8px;
      right:8px;
      background:rgba(0,0,0,0.7);
      color:#fff;
      font-weight:700;
      font-size:13px;
      padding:4px 8px;
      border-radius:8px;
    }
    #v-provider-cookbook .cookbook-item-menu{
      position:absolute;
      top:8px;
      right:8px;
      width:44px;
      height:44px;
      border-radius:50%;
      background:rgba(255,255,255,0.95);
      color:#334155;
      border:1px solid rgba(0,0,0,0.08);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:2;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    /* SÃ¤ulen: direkt unter dem Bild (ðŸ´ immer farbig, ðŸ§¾ bei Abholnummer farbig, ðŸ”„ bei Mehrweg farbig) */
    #v-provider-cookbook .cookbook-item-pillars{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      padding:8px 12px;
      background:#f8fafc;
      border-bottom:1px solid rgba(0,0,0,0.04);
      font-size:18px;
    }
    #v-provider-cookbook .cookbook-item-pillars .pillar-gray{ opacity:0.4; }
    #v-provider-cookbook .cookbook-item-body{ padding:12px; flex:1; display:flex; flex-direction:column; }
    #v-provider-cookbook .cookbook-item-title{ font-weight:800; font-size:15px; color:#1a1a1a; margin-bottom:6px; line-height:1.3; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    #v-provider-cookbook .cookbook-item-meta{ display:flex; align-items:center; gap:6px; margin-bottom:6px; flex-wrap:wrap; }
    #v-provider-cookbook .cookbook-item-badge{ font-size:11px; font-weight:600; padding:3px 8px; border-radius:6px; background:#e2e8f0; color:#475569; }
    #v-provider-cookbook .cookbook-item-allergens{ font-size:11px; color:#94a3b8; margin-bottom:4px; letter-spacing:0.02em; }
    #v-provider-cookbook .cookbook-item-info{ font-size:11px; color:#64748b; margin-left:auto; }
    #v-provider-cookbook .cookbook-item-revenue{ font-weight:800; font-size:14px; color:#1a1a1a; margin-top:4px; }
    #v-provider-cookbook .cookbook-item-cta-wrap{ margin-top:auto; }
    #v-provider-cookbook .cookbook-item-abholzusatz{ font-size:11px; color:#64748b; margin-bottom:4px; }
    #v-provider-cookbook .cookbook-item-btn{
      width:100%;
      min-height:48px;
      border-radius:12px;
      font-weight:800;
      font-size:14px;
      background:#10b981;
      color:#fff;
      border:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    #v-provider-cookbook .cookbook-tabs button{ flex:1; min-height:48px; border-radius:10px; font-weight:600; font-size:14px; border:none; background:transparent; color:#64748b; cursor:pointer; transition:all .2s; font-family:system-ui,-apple-system,sans-serif; }
    #v-provider-cookbook .cookbook-tabs button.on{ background:#10b981; color:#fff; font-weight:700; }
    
    /* Kochbuch Action-Sheet (Bottom Sheet) */
    #cookbookActionSheetBd{ z-index:999; }
    .cookbook-action-sheet{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:#404040;
      border-radius:20px 20px 0 0;
      padding:16px 20px calc(20px + env(safe-area-inset-bottom, 0));
      box-shadow:0 -4px 24px rgba(0,0,0,.4);
      z-index:1000;
    }
    .cookbook-action-sheet-handle{ width:40px; height:4px; background:rgba(255,255,255,0.3); border-radius:2px; margin:0 auto 16px; }
    .cookbook-action-sheet-title{ font-weight:800; font-size:18px; color:#fff; margin-bottom:16px; text-align:center; }
    .cookbook-action-sheet-btn{ width:100%; min-height:52px; border-radius:14px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.15); color:#fff; font-weight:700; font-size:15px; margin-bottom:10px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; }
    .cookbook-action-sheet-btn-danger{ color:#ff6b6b; border-color:rgba(255,107,107,0.4); }
    .cookbook-item{ position:relative; }
    .cookbook-actions{ display:none; }
    .cookbook-facts{ font-size:11px; color:rgba(255,255,255,0.5); margin-top:4px; }
    .cart-line{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 0; border-top:1px solid #eee}
    .cart-left{font-weight:700; flex:1; min-width:0}
    .cart-qty{display:flex; align-items:center; gap:6px}
    .qty-btn{border:1px solid var(--border); background:#fff; border-radius:999px; width:28px; height:28px; cursor:pointer; font-weight:900; transition:all .15s}
    .qty-btn:active{transform:scale(.95); background:#f5f5f5}
    .cart-price{font-weight:900; min-width:60px; text-align:right}
    /* Essenszeit Badge */
    .cart-window-badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 12px; border-radius:12px;
      background:rgba(255,204,0,.1); color:#b8860b;
      font-size:13px; font-weight:700; margin:8px 0;
    }
    .cart-window-badge i{width:16px; height:16px}
    /* Quick-Time-Chips */
    .cart-time-chips{
      display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px;
    }
    .cart-time-chip{
      padding:8px 14px; border-radius:12px;
      border:1px solid #ddd; background:#fff;
      font-size:13px; font-weight:600; color:#666;
      cursor:pointer; transition:all .15s;
    }
    .cart-time-chip:active{transform:scale(.96); background:#f5f5f5}
    .cart-time-chip.selected{
      background:var(--brand); color:#000; border-color:var(--brand);
    }
    /* Warenkorb leeren Button */
    .cart-clear-btn{
      display:inline-block; margin-top:12px;
      padding:8px 16px; border-radius:10px;
      background:#f5f5f5; color:#666;
      font-size:13px; font-weight:600;
      text-decoration:none; cursor:pointer;
      transition:all .15s;
    }
    .cart-clear-btn:hover{background:#eee}
    .cart-clear-btn:active{transform:scale(.98)}
    .order-item{border:1px solid var(--border); border-radius:14px; padding:10px; background:#fff; box-shadow:0 6px 14px rgba(0,0,0,.06)}
    .order-item.done{opacity:.65}
    .order-item + .order-item{margin-top:10px}
    .order-top{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .order-right{display:flex; flex-direction:column; align-items:flex-end; gap:6px}
    .order-code{
      border:1px solid var(--border); 
      background:#fff; 
      border-radius:10px; 
      padding:6px 10px; 
      font-weight:900; 
      cursor:pointer;
      transition:transform 0.1s ease;
    }
    .order-code:active{
      transform:scale(0.95);
    }
    .status-pill{display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; font-size:11px; font-weight:900; border:1px solid var(--border)}
    .status-pill.open{background:rgba(242,183,5,.12); color:#b37b00}
    .status-pill.done{background:rgba(31,157,85,.12); color:#1f9d55}
    .code-full{font-size:42px; font-weight:950; text-align:center; margin:10px 0}

    /* Pickup Card (Theken-Ansicht 2.0) */
    .pickup-card{
      background:#fff;
      border-radius:16px;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
      position:relative;
      overflow:hidden;
      transition:all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
      cursor:pointer;
      border-left:6px solid #e5e7eb; /* Default */
      display:flex;
      flex-direction:column;
      min-height:160px;
    }
    .pickup-card:active{ transform:scale(0.96); }
    .pickup-card.status-open{ border-left-color:#FFD700; }
    .pickup-card.status-paid{ border-left-color:#2ecc71; } /* Bezahlt & Bereit */
    .pickup-card.status-done{ opacity:0.6; filter:grayscale(100%); border-left-color:#999; box-shadow:none; background:#f9f9f9; }
    
    .pickup-card-header{
      padding:16px 16px 0;
      display:flex; justify-content:space-between; align-items:flex-start;
    }
    .pickup-card-code{
      font-size:42px; font-weight:900; line-height:1; color:#1a1a1a; letter-spacing:-0.03em;
    }
    .pickup-card-time{
      font-size:13px; font-weight:700; color:#666; background:#f0f2f5; padding:4px 8px; border-radius:8px;
    }
    .pickup-card-body{
      padding:12px 16px 16px;
      flex:1; display:flex; flex-direction:column; justify-content:flex-end;
    }
    .pickup-card-dish{
      font-size:16px; font-weight:700; line-height:1.3; color:#333; margin-bottom:4px;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
    }
    .pickup-card-customer{
      font-size:13px; color:#888; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .pickup-card-badge{
      position:absolute; top:12px; right:12px;
      background:#2ecc71; color:#fff; font-size:11px; font-weight:800; padding:4px 8px; border-radius:6px;
      box-shadow:0 2px 6px rgba(46,204,113,0.3);
    }
    
    /* Animation fÃ¼r Erledigt */
    @keyframes check-pop {
      0% { transform:scale(0); opacity:0; }
      50% { transform:scale(1.2); opacity:1; }
      100% { transform:scale(1); opacity:1; }
    }
    .check-overlay{
      position:absolute; inset:0; background:rgba(46,204,113,0.9);
      display:flex; align-items:center; justify-content:center;
      opacity:0; pointer-events:none; transition:opacity 0.2s;
    }
    .pickup-card.just-done .check-overlay{ opacity:1; }
    .pickup-card.just-done .check-icon{ animation:check-pop 0.3s ease-out forwards; }
    .quick-ticket{
      position:fixed; inset:0; z-index:31;
      background:linear-gradient(135deg, var(--brand) 0%, #FFD700 100%);
      display:flex; align-items:center; justify-content:center;
      transform:translateY(100%); transition:transform .3s cubic-bezier(.4,0,.2,1);
      padding:20px;
    }
    .quick-ticket.active{transform:translateY(0)}
    .quick-ticket-close{
      position:absolute; top:20px; right:20px;
      width:44px; height:44px; border-radius:50%;
      background:rgba(255,255,255,.2); backdrop-filter:blur(10px);
      border:2px solid rgba(255,255,255,.3);
      color:#fff; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      transition:background .2s;
    }
    .quick-ticket-close:hover{background:rgba(255,255,255,.3)}
    .quick-ticket-close i{width:24px; height:24px}
    .quick-ticket-content{
      width:100%; max-width:400px; text-align:center;
      color:#111;
    }
    .quick-ticket-header{
      margin-bottom:40px;
    }
    .quick-ticket-logo{
      width:80px; height:80px; border-radius:20px;
      background:#fff; border:4px solid rgba(255,255,255,.5);
      margin:0 auto 16px; overflow:hidden;
      box-shadow:0 8px 24px rgba(0,0,0,.2);
    }
    .quick-ticket-logo img{
      width:100%; height:100%; object-fit:cover;
    }
    .quick-ticket-provider{
      font-size:26px; font-weight:900; margin-bottom:10px; line-height:1.3;
    }
    .quick-ticket-time{
      font-size:15px; opacity:.8; font-weight:600; line-height:1.4;
    }
    .quick-ticket-code{
      background:#fff; border-radius:var(--radius);
      padding:32px 24px; margin-bottom:24px;
      box-shadow:0 12px 32px rgba(0,0,0,.2);
    }
    .quick-ticket-code-label{
      font-size:12px; font-weight:700; text-transform:uppercase;
      letter-spacing:.1em; color:var(--muted); margin-bottom:12px;
    }
    .quick-ticket-code-value{
      font-size:72px; font-weight:950; line-height:1;
      color:#111; font-family:'Inter', monospace;
      letter-spacing:.05em;
    }
    .quick-ticket-details{
      background:rgba(255,255,255,.3); backdrop-filter:blur(10px);
      border-radius:var(--radius); padding:20px;
      margin-bottom:20px;
    }
    .quick-ticket-detail-item{
      margin-bottom:16px;
    }
    .quick-ticket-detail-item:last-child{margin-bottom:0}
    .quick-ticket-detail-label{
      font-size:13px; font-weight:700; opacity:.7; margin-bottom:6px; line-height:1.4;
    }
    .quick-ticket-detail-value{
      font-size:17px; font-weight:900; line-height:1.4;
    }
    .quick-ticket-status{
      font-size:14px; font-weight:700; opacity:.8; line-height:1.4;
      margin-bottom:24px;
    }
    .quick-ticket-actions .btn{
      background:#fff; color:#111; box-shadow:0 8px 24px rgba(0,0,0,.2);
    }

    .print-view{display:none}
    @media print{
      body{background:#fff; color:#000}
      body > *:not(#printView){display:none !important}
      #printView{display:block}
      #printView .print-card{
        border:1px solid #ddd; border-radius:12px; padding:16px; margin-bottom:12px;
      }
      #printView h1{margin:0 0 8px; font-size:20px}
      #printView h2{margin:12px 0 6px; font-size:16px}
      #printView .print-row{display:flex; justify-content:space-between; gap:12px; margin-top:6px}
      #printView .print-muted{color:#555; font-size:12px}
      #printView .print-badge{display:inline-block; padding:4px 8px; border:1px solid #999; border-radius:999px; font-size:11px; font-weight:700}
      #printView .print-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
      #printView .pickup-code-display{width:120px; height:120px; border:2px solid var(--brand); border-radius:12px; background:#fff; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; color:#2D3436}
    }
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .bigbtn{
      border:none; cursor:pointer;
      border-radius:18px; padding:14px;
      background:linear-gradient(135deg,rgba(242,183,5,.18),rgba(31,157,85,.12));
      border:1px solid var(--border);
      text-align:left;
      font-weight:950;
    }
    .bigbtn span{display:block; font-weight:700; font-size:12px; color:var(--muted); margin-top:6px}

    /* Provider app header */
    .prov-pill{
      display:inline-flex; align-items:center; gap:8px;
      background:#fff; border:1px solid var(--border);
      padding:9px 12px; border-radius:999px;
      font-weight:950; font-size:13px;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .prov-pill::after {
      content: '';
      display: none;
    }
    .provider-header{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .provider-logo.compact{padding:0}
    .header-actions{display:flex; gap:8px; flex-wrap:wrap}
    .header-actions .btn{width:auto; margin-top:0}

    .snackbar{
      position:fixed; left:50%; bottom:90px; transform:translateX(-50%);
      background:#111; color:#fff; border-radius:999px; padding:10px 14px;
      display:flex; align-items:center; gap:10px; box-shadow:0 10px 24px rgba(0,0,0,.22);
      opacity:0; pointer-events:none; transition:opacity .2s ease;
      z-index:40; font-size:13px; font-weight:900;
    }
    .snackbar.active{opacity:1; pointer-events:auto}
    .snackbar button{
      border:none; background:#fff; color:#111; border-radius:999px; padding:6px 10px;
      font-size:12px; font-weight:900; cursor:pointer;
    }

    /* Wizard */
    .wizard{
      background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow);
      padding:12px;
    }
    .w-top{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .w-title{font-weight:950}
    .w-step{font-size:12px; color:var(--muted)}
    .w-q{margin:12px 0 10px; font-size:18px; font-weight:950; line-height:1.2}
    .w-help{margin:0 0 10px; color:var(--muted); font-size:13px}
    .answers{display:flex; flex-wrap:wrap; gap:8px}
    .ans{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-weight:950;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .ans.on{border-color:rgba(31,157,85,.4); background:rgba(31,157,85,.10)}
    .field{width:100%; padding:14px 16px; border-radius:14px; border:1px solid var(--border); font-size:16px; background:#fbfaf7; line-height:1.5}
    .w-actions{display:flex; gap:10px; margin-top:12px}
    .w-actions button{flex:1}

    /* Inseratflow: Helles, app-Ã¤hnliches Layout (kein Livebild, klares Layout) */
    #createFlowSheet.sheet--kitchen,
    #wizard.sheet--kitchen{
      background:#f0f2f5 !important;
      border-radius:20px 20px 0 0;
      max-height:92vh;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    #createFlowSheet.sheet--kitchen .handle,
    #wizard.sheet--kitchen .handle{ background:rgba(0,0,0,0.15); width:40px; margin:8px auto 4px; }
    #createFlowSheet.sheet--kitchen .sheet-body{
      padding:20px 20px 28px;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
    }
    #createFlowSheet.sheet--kitchen .create-flow-title{
      font-weight:800; font-size:20px; color:#1a1a1a; margin-bottom:8px; line-height:1.3;
    }
    #createFlowSheet.sheet--kitchen .create-flow-hint{
      font-size:13px; color:#64748b; margin-top:12px;
    }
    #createFlowSheet.sheet--kitchen .create-flow-btns{
      display:flex; flex-direction:column; gap:12px; margin-top:20px;
    }
    #createFlowSheet.sheet--kitchen .btn-create-primary{
      width:100%; min-height:52px; border-radius:14px; font-weight:800; font-size:16px; border:none;
      background:#FFD700; color:#1a1a1a; cursor:pointer; display:flex; align-items:center; justify-content:flex-start;
      padding:0 20px; gap:12px; transition:transform .15s, box-shadow .15s;
      box-shadow:0 2px 10px rgba(255,215,0,0.3);
    }
    #createFlowSheet.sheet--kitchen .btn-create-primary:active{ transform:scale(0.98); }
    #createFlowSheet.sheet--kitchen .btn-create-secondary{
      width:100%; min-height:52px; border-radius:14px; font-weight:700; font-size:15px;
      border:1px solid rgba(0,0,0,0.1); background:#fff; color:#1a1a1a;
      cursor:pointer; display:flex; align-items:center; justify-content:flex-start; padding:0 20px; gap:12px;
      transition:background .15s, border-color .15s; box-shadow:0 2px 8px rgba(0,0,0,.06);
    }
    #createFlowSheet.sheet--kitchen .btn-create-secondary:active{ background:#f8f9fa; }
    /* Wizard: app-like (ImmobilienScout24-Style â€“ klare Schritte, sticky Actions) */
    #wizard.sheet--kitchen .sheet-body.wizard-sheet-body{
      padding:16px 20px 0;
      overflow:hidden;
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    #wizard.sheet--kitchen .wizard{
      background:#fff;
      border:1px solid rgba(0,0,0,0.08);
      border-radius:20px;
      padding:20px;
      box-shadow:0 2px 16px rgba(0,0,0,.08);
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    #wizard.sheet--kitchen .wizard-progress-dots{
      display:flex;
      justify-content:center;
      gap:8px;
      margin-bottom:16px;
      flex-shrink:0;
    }
    #wizard.sheet--kitchen .wizard-dot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:rgba(0,0,0,0.15);
      transition:background .2s, transform .2s;
    }
    #wizard.sheet--kitchen .wizard-dot.active{
      background:#FFD700;
      transform:scale(1.2);
    }
    #wizard.sheet--kitchen .wizard-scroll{
      flex:1;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      margin:0 -20px;
      padding:0 20px 16px;
    }
    #wizard.sheet--kitchen .w-actions{
      flex-shrink:0;
      margin:0 -20px -20px;
      padding:16px 20px calc(16px + env(safe-area-inset-bottom, 0));
      background:#fff;
      border-top:1px solid rgba(0,0,0,0.05);
      border-radius:0 0 20px 20px;
      position:sticky; bottom:0; z-index:10;
      display:flex; gap:12px;
    }
    #wizard.sheet--kitchen .w-actions button{
      flex:1;
      height:52px; border-radius:14px; font-weight:700; font-size:16px; letter-spacing:0.02em;
    }
    #wizard.sheet--kitchen .w-actions button.secondary{ background:#f5f5f7; color:#1d1d1f; border:none; }
    #wizard.sheet--kitchen .w-actions button:not(.secondary){ background:var(--brand); color:#1d1d1f; box-shadow:0 4px 12px rgba(255,215,0,0.25); }
    #wizard.sheet--kitchen .wizard-footer{
      text-align:center; padding:8px 0 4px; font-size:9px; font-weight:700; color:#9ca3af; text-transform:uppercase; letter-spacing:0.03em;
    }
    #wizard.sheet--kitchen .w-top{ margin-bottom:16px; }
    #wizard.sheet--kitchen .w-title{ font-weight:800; font-size:18px; color:#1a1a1a; }
    #wizard.sheet--kitchen .w-step{ font-size:12px; color:#64748b; font-weight:600; }
    #wizard.sheet--kitchen .w-q{
      font-size:17px; font-weight:800; color:#1a1a1a; line-height:1.3; margin:0 0 6px;
    }
    #wizard.sheet--kitchen .w-help{ font-size:13px; color:#64748b; margin:0 0 16px; line-height:1.4; }
    #wizard.sheet--kitchen #wContent{
      margin-bottom:20px;
      min-height:40px;
    }
    #wizard.sheet--kitchen #wContent .answers{
      display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;
    }
    #wizard.sheet--kitchen #wContent .field{
      margin-top:0; margin-bottom:8px;
    }
    #wizard.sheet--kitchen #wContent input[type="checkbox"]{
      accent-color:var(--brand);
    }
    #wizard.sheet--kitchen .w-actions{
      display:flex; gap:12px; margin-top:20px; padding-top:16px; border-top:1px solid rgba(0,0,0,0.08);
    }
    #wizard.sheet--kitchen .w-actions button{ flex:1; min-height:48px; border-radius:14px; font-weight:700; }
    #wizard.sheet--kitchen .hint{ color:#64748b; font-size:13px; }
    #wizard.sheet--kitchen .panel{
      background:#f8f9fa; border:1px solid rgba(0,0,0,0.08); color:#1a1a1a;
      border-radius:12px; padding:14px; margin-top:12px;
    }
    #wizard.sheet--kitchen .panel .hint{ color:#64748b; }
    #wizard.sheet--kitchen .ans{
      background:#fff; border:1px solid rgba(0,0,0,0.12); color:#1a1a1a;
      padding:12px 16px; border-radius:14px; font-weight:700;
      min-height:44px;
      box-sizing:border-box;
      transition:background .15s, border-color .15s;
    }
    #wizard.sheet--kitchen #wContent .ans.ans--thumb{
      min-height:72px; min-width:72px;
    }
    #wizard.sheet--kitchen .ans:hover{ background:#f8f9fa; border-color:rgba(0,0,0,0.18); }
    #wizard.sheet--kitchen .ans.on{
      border-color:var(--brand); background:rgba(255,215,0,0.15); color:#1a1a1a;
    }
    #wizard.sheet--kitchen .field{
      background:#fff; border:1px solid rgba(0,0,0,0.12); color:#1a1a1a;
      border-radius:12px; padding:14px 16px; font-size:16px;
    }
    #wizard.sheet--kitchen .field::placeholder{ color:#94a3b8; }
    #wizard.sheet--kitchen .w-actions .btn:not(.secondary){
      background:#FFD700; color:#1a1a1a; border:none; box-shadow:0 2px 10px rgba(255,215,0,0.3);
    }
    #wizard.sheet--kitchen .w-actions .btn.secondary{
      background:#fff; border:1px solid rgba(0,0,0,0.12); color:#1a1a1a;
    }
    #wizard.sheet--kitchen .btn.ghost{
      background:#f8f9fa; border:1px solid rgba(0,0,0,0.1); color:#1a1a1a;
    }
    #wizard.sheet--kitchen .mini{ color:#64748b; font-size:12px; }
    /* Vorschau-Bereich (kein Livebild): kompakt, klar */
    #wizard.sheet--kitchen #listingPreview{
      margin-top:20px; padding-top:16px; border-top:1px solid rgba(0,0,0,0.08);
    }
    #wizard.sheet--kitchen #listingPreview .hint{
      font-size:12px; font-weight:600; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:10px;
    }
    #wizard.sheet--kitchen #listingPreview .listing-preview-badge{
      background:rgba(46,125,50,0.1); border:1px solid rgba(46,125,50,0.3); border-radius:12px; padding:12px;
    }
    #wizard.sheet--kitchen #listingPreview .listing-preview-badge div{ color:#2e7d32; font-weight:700; }
    #wizard.sheet--kitchen #listingPreview .listing-preview-subline{ color:#64748b; }
    #wizard.sheet--kitchen .listing-reuse-preview{
      background:rgba(31,157,85,0.08) !important; border:1px solid rgba(46,175,80,0.25) !important;
      border-radius:12px; padding:12px;
    }
    #wizard.sheet--kitchen .listing-reuse-preview span{ color:#1a1a1a; }
    #wizard.sheet--kitchen .listing-hint-box{
      background:#f8f9fa !important; border:1px solid rgba(0,0,0,0.08) !important;
      border-radius:12px; padding:12px;
    }
    #wizard.sheet--kitchen .listing-hint-box div{ color:#1a1a1a !important; }
    #wizard.sheet--kitchen .listing-cost-block{
      background:#f8f9fa !important; border:1px solid rgba(0,0,0,0.08); border-radius:12px; padding:14px;
    }
    #wizard.sheet--kitchen .listing-cost-block div{ color:#1a1a1a; }
    #wizard.sheet--kitchen .listing-cost-block .listing-cost-muted{ color:#64748b; }
    #wizard.sheet--kitchen .listing-cost-block.listing-cost-green{
      background:rgba(46,125,50,0.1) !important; border:1px solid rgba(46,125,50,0.3);
    }
    #wizard.sheet--kitchen .listing-cost-block.listing-cost-green div{ color:#2e7d32; }
    #wizard.sheet--kitchen .listing-datum-summary .listing-datum-day{ color:#1a1a1a; font-weight:800; }
    #wizard.sheet--kitchen .listing-datum-summary .hint{ color:#64748b; }

    /* Inseratflow: S25, blind-tap, <15s â€“ app-like, groÃŸe Touch-Ziele, intuitiv */
    #wizard[data-flow="listing"].sheet--kitchen .wizard-scroll{
      padding-bottom:12px;
    }
    #wizard[data-flow="listing"].sheet--kitchen .w-q{
      font-size:16px; margin-bottom:4px;
    }
    #wizard[data-flow="listing"].sheet--kitchen .w-help{
      font-size:12px; margin-bottom:12px; line-height:1.35;
    }
    #wizard[data-flow="listing"].sheet--kitchen #wContent .answers{
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:10px;
      margin-top:8px;
    }
    #wizard[data-flow="listing"].sheet--kitchen #wContent .answers.answers--full{
      grid-template-columns:1fr;
    }
    /* Inseratflow: Support-Layout (Buttons wie Support-Sheet) */
    #wizard[data-flow="listing"].sheet--kitchen #wContent .ans{
      min-height:52px !important;
      padding:var(--support-padding) var(--support-padding-lg) !important;
      font-size:15px !important;
      font-weight:700;
      border-radius:var(--support-border-radius);
      border:2px solid var(--support-border);
      background:#fff;
      -webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      justify-content:center;
      display:flex;
      align-items:center;
    }
    #wizard[data-flow="listing"].sheet--kitchen #wContent .ans.on{
      border:2px solid var(--brand);
      background:rgba(255,215,0,0.08);
    }
    #wizard[data-flow="listing"].sheet--kitchen #wContent .ans.ans--thumb{
      min-height:80px !important;
      min-width:80px !important;
      border-radius:var(--support-border-radius);
      padding:0;
    }
    #wizard[data-flow="listing"].sheet--kitchen #wContent .field{
      min-height:52px !important;
      padding:12px var(--support-padding) !important;
      font-size:16px !important;
      border-radius:var(--support-border-radius);
      border:1px solid #ddd;
      -webkit-tap-highlight-color:transparent;
    }
    #wizard[data-flow="listing"].sheet--kitchen .w-actions{
      padding:12px 20px calc(12px + env(safe-area-inset-bottom, 20px)) !important;
      gap:10px;
    }
    #wizard[data-flow="listing"].sheet--kitchen .w-actions .btn{
      min-height:54px !important;
      font-size:16px !important;
      font-weight:800;
      border-radius:var(--support-border-radius);
      padding:var(--support-padding) var(--support-padding-lg);
      touch-action:manipulation;
      -webkit-tap-highlight-color:transparent;
    }
    #wizard[data-flow="listing"].sheet--kitchen .w-actions .btn.secondary{
      border:2px solid var(--support-border);
      background:#fff;
    }
    #wizard[data-flow="listing"].sheet--kitchen .w-actions .btn:not(.secondary){
      flex:1;
      min-width:0;
    }
    #wizard[data-flow="listing"].sheet--kitchen .hint{
      font-size:12px; margin-bottom:6px;
    }
    /* S25 / schmale Displays: noch grÃ¶ÃŸere Tap-Ziele, safe-area */
    @media (max-width:430px){
      #wizard[data-flow="listing"].sheet--kitchen #wContent .ans{
        min-height:54px !important;
      }
      #wizard[data-flow="listing"].sheet--kitchen .w-actions .btn{
        min-height:56px !important;
      }
      #wizard[data-flow="listing"].sheet--kitchen .w-actions{
        padding:12px 16px calc(12px + env(safe-area-inset-bottom, 24px)) !important;
      }
    }

    /* Einheitliches Support-Layout: Anbieter + Inseratsflow (Buttons, Panels, AbstÃ¤nde wie Support-Sheet) */
    :root{
      --support-border:#e5e7eb;
      --support-border-radius:12px;
      --support-padding:16px;
      --support-padding-lg:24px;
    }
    /* Provider-App: MEIN BETRIEB â€“ Support-Layout Ã¼berall */
    :root{
      --provider-bg:#e8eaed;
      --provider-surface:#ffffff;
      --provider-surface-alt:#f1f3f4;
      --provider-border:#e5e7eb;
      --provider-text:#2D3436;
      --provider-text-muted:#5f6368;
    }
    [id^="v-provider-"]{
      background:var(--provider-bg) !important;
    }
    [id^="v-provider-"] .panel{
      background:var(--provider-surface) !important;
      color:var(--provider-text) !important;
      border:2px solid var(--provider-border) !important;
      box-shadow:none !important;
      border-radius:var(--support-border-radius) !important;
      padding:var(--support-padding) var(--support-padding-lg) !important;
    }
    [id^="v-provider-"] .panel div,
    [id^="v-provider-"] .panel span,
    [id^="v-provider-"] .panel label{
      color:var(--provider-text) !important;
    }
    [id^="v-provider-"] .panel .hint,
    [id^="v-provider-"] .provider-profile-section-title{
      color:var(--provider-text-muted) !important;
    }
    /* Status-Banner: nur dieser bleibt grÃ¼n mit WeiÃŸtext (Support-Layout) */
    #providerStatusBanner{
      background:linear-gradient(135deg, #2e7d32 0%, #1f5f23 100%) !important;
      color:#fff !important;
      border:2px solid #1f5f23 !important;
      box-shadow:none !important;
      border-radius:var(--support-border-radius) !important;
    }
    #providerStatusBanner *{ color:#fff !important; }
    /* Kunden-Nachfrage: heller Hintergrund, dunkle Schrift (lesbar) */
    #providerCustomerDemand{
      background:#fffbf0 !important;
      border:1px solid #e6c200 !important;
      color:var(--provider-text) !important;
      border-radius:6px !important;
    }
    #providerCustomerDemand #providerRequestCount{ color:var(--provider-text) !important; font-weight:800 !important; }
    #providerCustomerDemand .btn-primary{ background:#2e7d32 !important; color:#fff !important; }
    #providerPersonalSpar,
    #providerPersonalSpar *{
      background:var(--provider-surface-alt) !important;
      color:var(--provider-text) !important;
      border-color:var(--provider-border) !important;
    }
    #providerPersonalSpar strong{ color:var(--provider-text) !important; }
    [id^="v-provider-"] h1,[id^="v-provider-"] h2,[id^="v-provider-"] h3{
      color:var(--provider-text) !important;
    }
    #v-provider-home .provider-home-header,
    #v-provider-home .provider-home-header *,
    #v-provider-home h1{
      color:var(--provider-text) !important;
    }
    #v-provider-home .provider-home-header div:first-child{
      color:var(--provider-text-muted) !important;
    }
    [id^="v-provider-"] #provPickupsSubheader,
    [id^="v-provider-"] .hint{
      color:var(--provider-text-muted) !important;
    }
    #providerStatusIndicator{
      background:var(--provider-surface) !important;
      border:2px solid var(--provider-border) !important;
      box-shadow:0 1px 3px rgba(0,0,0,.08) !important;
      border-radius:var(--support-border-radius) !important;
    }
    #statusIndicatorText{ color:var(--provider-text) !important; }
    /* KPI-Karten: dunkle Schrift, lesbar */
    #kpiCardTagesessen,
    #kpiCardAbholungen,
    #kpiCardKochbuch{
      background:var(--provider-surface) !important;
      border:2px solid var(--provider-border) !important;
      border-radius:var(--support-border-radius) !important;
    }
    #kpiCardTagesessen div:first-child,
    #kpiCardAbholungen div:first-child,
    #kpiCardKochbuch div:first-child{
      color:var(--provider-text) !important;
    }
    #kpiCardTagesessen div:last-child,
    #kpiCardAbholungen div:last-child,
    #kpiCardKochbuch div:last-child{
      color:var(--provider-text-muted) !important;
    }
    #providerTimeTracker,
    #providerTimeTracker *{
      color:var(--provider-text) !important;
      background:var(--provider-surface) !important;
      border-color:var(--provider-border) !important;
    }
    #providerTimeTracker div:first-child,
    #providerTimeTracker div:last-child{
      color:var(--provider-text-muted) !important;
    }
    #providerTimeTracker #providerTimeSaved{ color:var(--provider-text) !important; }
    #providerTodayShare,
    #providerTodayShare .btn{ color:var(--provider-text) !important; background:var(--provider-surface) !important; border-color:var(--provider-border) !important; }
    /* Buttons im Provider-Bereich: Support-Layout (wie Support-Sheet) */
    [id^="v-provider-"] .btn,
    [id^="v-provider-"] .btn-primary,
    [id^="v-provider-"] button[class*="btn"]{
      border-radius:var(--support-border-radius) !important;
      min-height:48px !important;
      font-weight:700 !important;
      font-size:15px !important;
      padding:var(--support-padding) var(--support-padding-lg) !important;
      box-shadow:none !important;
      transition:border-color .15s, background .15s !important;
      -webkit-tap-highlight-color:transparent;
    }
    [id^="v-provider-"] .btn:active,
    [id^="v-provider-"] .btn-primary:active,
    [id^="v-provider-"] button[class*="btn"]:active{
      transform:scale(0.98) !important;
    }
    [id^="v-provider-"] .btn.secondary,
    [id^="v-provider-"] .btn.ghost{
      background:#fff !important;
      border:2px solid var(--support-border) !important;
      color:var(--provider-text) !important;
    }
    [id^="v-provider-"] .btn:not(.secondary):not(.ghost),
    [id^="v-provider-"] .btn-primary{
      border:2px solid transparent !important;
    }
    /* Bottom-Nav Provider: hell, modern */
    #providerNav{
      background:rgba(255,255,255,0.98) !important;
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
      border-top:1px solid var(--provider-border) !important;
      box-shadow:0 -2px 16px rgba(0,0,0,.06) !important;
    }
    #providerNav .navbtn{ color:var(--provider-text-muted); }
    #providerNav .navbtn.active{ color:var(--brand); }
    #providerNav .navbtn.active .ico svg{ color:var(--brand); stroke:var(--brand); }
    /* Provider Nav Light (App-Style): heller Tab-Bar */
    .provider-nav-light .navbtn{ color:#9ca3af; }
    .provider-nav-light .navbtn.active{ color:var(--brand); font-weight:800; }
    .provider-nav-light .navbtn.active .ico svg{ color:var(--brand); stroke:var(--brand); }
    [id^="v-provider-"] .panel h1,[id^="v-provider-"] .panel h2,[id^="v-provider-"] .panel h3,[id^="v-provider-"] .panel .section-title{ color:var(--provider-text) !important; }
    [id^="v-provider-"] .panel .hint{ color:var(--provider-text-muted) !important; }
    /* Dynamisch eingefÃ¼gter Inhalt: immer lesbar */
    #providerActiveOffersList,
    #providerActiveOffersList *,
    #providerTodayContent,
    #providerTodayContent *,
    #providerWeekDayContent,
    #providerWeekDayContent *{
      color:var(--provider-text) !important;
    }
    #providerActiveOffersList [style*="color:var(--muted)"],
    #providerTodayContent .hint,
    #providerWeekDayContent .hint{
      color:var(--provider-text-muted) !important;
    }
    /* FAB: moderner Schatten auf hellem Grund */
    #fabProviderAddOffer{
      box-shadow:0 4px 20px rgba(255,215,0,0.4) !important;
      transition:transform .15s ease, box-shadow .15s ease;
    }
    #fabProviderAddOffer:active{ transform:scale(0.95); }
    /* Provider Dashboard CTA: Hover/Active Scale (App-Style) */
    .provider-dashboard-cta:hover{ transform:scale(0.98); }
    .provider-dashboard-cta:active{ transform:scale(0.95); }

    /* FAB & Status-Indikator: Safe-Area fÃ¼r S25 / moderne Handys */
    #fabProviderAddOffer{
      bottom:calc(90px + env(safe-area-inset-bottom, 20px)) !important;
      right:calc(16px + env(safe-area-inset-right, 0)) !important;
    }
    #fabProviderAddOfferLabel{ right:calc(16px + env(safe-area-inset-right, 0)) !important; }
    #providerStatusIndicator{
      top:calc(16px + env(safe-area-inset-top, 0)) !important;
      right:calc(16px + env(safe-area-inset-right, 0)) !important;
    }

    /* FAQ accordion */
    .faq{margin-top:12px}
    details{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 14px rgba(0,0,0,.06);padding:14px 16px}
    details+details{margin-top:10px}
    summary{cursor:pointer;font-weight:950;font-size:15px;line-height:1.4}
    summary::-webkit-details-marker{display:none}
    details p{margin:10px 0 0;color:var(--muted);font-size:14px;line-height:1.6}
    .profile-faq-accordion details summary::-webkit-details-marker{display:none}

    /* helper */
    .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.25}

    .loc-row{display:flex; gap:8px; align-items:center}
    .pin-btn{
      border:1px solid var(--border); background:#fff; border-radius:14px;
      width:44px; height:44px; cursor:pointer; font-size:18px;
      display:flex; align-items:center; justify-content:center;
    }
    .ico-inline{display:inline-flex; align-items:center}
    .ico-inline svg{width:14px; height:14px; stroke:currentColor}
    .info-row{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; font-size:12px; color:var(--muted)}
    .info-item{
      display:inline-flex; align-items:center; gap:6px;
      background:#f8f7f3; border:1px solid var(--border);
      padding:5px 10px; border-radius:999px;
      font-size:13px; line-height:1.4;
    }

    /* Onboarding */
    .onboarding-step{
      max-width:600px; margin:0 auto;
    }
    .onboarding-header{
      display:flex; justify-content:space-between; align-items:flex-start;
    }
    .onboarding-progress{
      font-size:12px; font-weight:900; color:var(--muted);
      text-transform:uppercase; letter-spacing:.05em;
    }
    .onboarding-logo-preview:hover{
      border-color:var(--brand); background:#fff4e6;
    }
    .onboarding-logo-preview img{
      display:block;
    }
    .time-btn.active{
      background:var(--brand); border-color:var(--brand);
    }
    .onboarding-summary-item:last-child{
      margin-bottom:0;
    }

    /* Social Feed - Story-Leiste */
    .stories-container{
      padding:16px 14px 20px;
      max-width:980px; margin:0 auto;
    }
    .stories-scroll{
      display:flex; gap:16px; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:4px;
    }
    .story-item{
      flex:0 0 auto; display:flex; flex-direction:column; align-items:center; gap:8px;
      cursor:pointer;
    }
    .story-avatar{
      width:64px; height:64px; border-radius:50%;
      border:3px solid var(--brand);
      padding:2px; background:#fff;
      overflow:hidden; position:relative;
    }
    .story-avatar img{
      width:100%; height:100%; object-fit:cover; border-radius:50%;
    }
    .story-name{
      font-size:12px; font-weight:700; color:var(--text);
      max-width:64px; text-align:center; overflow:hidden; text-overflow:ellipsis;
      line-height:1.3;
    }

    /* Discover Page - App-like UX (PWA, Light Mode) */
    /* Toggle-Switch fÃ¼r Discover-View */
    .discover-view-toggle{
      margin-left:auto; /* Rechts ausrichten in Quick-Filters */
    }
    /* View-Toggle im Topbar */
    .discover-view-toggle-topbar{
      display:none;
    }
    
    /* Floating Action Button (FAB) fÃ¼r Modus-Wechsel */
    .fab-mode-toggle{
      position:fixed; bottom:calc(80px + env(safe-area-inset-bottom, 16px) + 20px); right:16px;
      width:56px; height:56px; border-radius:50%;
      background:rgba(255,255,255,.85);
      backdrop-filter:saturate(180%) blur(20px);
      -webkit-backdrop-filter:saturate(180%) blur(20px);
      border:1px solid rgba(231,225,213,.3);
      box-shadow:0 8px 24px rgba(0,0,0,.12), 0 0 0 1px rgba(0,0,0,.04);
      display:none; align-items:center; justify-content:center;
      cursor:pointer; z-index:25;
      transition:transform .2s ease, box-shadow .2s ease, background .2s ease;
      user-select:none;
    }
    .fab-mode-toggle:hover{
      transform:scale(1.05);
      box-shadow:0 12px 32px rgba(0,0,0,.16), 0 0 0 1px rgba(0,0,0,.06);
      background:rgba(255,255,255,.95);
    }
    .fab-mode-toggle:active{
      transform:scale(.95);
    }
    .fab-mode-toggle.pulsing{
      animation:fabPulse .4s ease-out;
    }
    @keyframes fabPulse{
      0%{transform:scale(1);}
      50%{transform:scale(1.15); box-shadow:0 12px 40px rgba(255,184,0,.3), 0 0 0 1px rgba(255,184,0,.2);}
      100%{transform:scale(1);}
    }
    .fab-mode-toggle i{
      width:24px; height:24px;
      color:#2D3436;
      transition:transform .2s ease;
    }
    .fab-mode-toggle.active i{
      transform:rotate(180deg);
    }
    
    /* Micro-Hint (Sprechblase beim ersten Start) */
    .fab-hint{
      position:absolute; bottom:calc(100% + 12px); right:0;
      background:#2D3436; color:#fff;
      padding:10px 14px; border-radius:12px;
      font-size:13px; font-weight:600; white-space:nowrap;
      box-shadow:0 4px 16px rgba(0,0,0,.2);
      opacity:0; pointer-events:none;
      transform:translateY(8px);
      transition:opacity .3s ease, transform .3s ease;
    }
    .fab-hint.show{
      opacity:1; transform:translateY(0);
    }
    .fab-hint::after{
      content:''; position:absolute; top:100%; right:20px;
      width:0; height:0;
      border-left:6px solid transparent;
      border-right:6px solid transparent;
      border-top:6px solid #2D3436;
    }
    .discover-calendar-wrapper{
      padding:6px 0 4px;
      border-top:1px solid rgba(0,0,0,.04);
      max-width:100%;
      margin:0 auto;
      box-sizing:border-box;
    }
    .discover-calendar-scroll{
      display:flex;
      gap:8px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding:0 14px;
      scrollbar-width:none;
    }
    .discover-calendar-scroll::-webkit-scrollbar{display:none}
    .toggle-switch{
      position:relative;
      width:64px;
      height:32px;
      background:#e0e0e0;
      border-radius:16px;
      border:none;
      cursor:pointer;
      transition:background 0.3s ease;
      display:flex;
      align-items:center;
      padding:4px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    .toggle-switch.active{
      background:var(--brand);
    }
    .toggle-icon{
      position:absolute;
      width:24px;
      height:24px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:opacity 0.3s ease, transform 0.3s ease;
      z-index:2;
    }
    .toggle-icon-list{
      left:4px;
      opacity:1;
    }
    .toggle-icon-match{
      right:4px;
      opacity:0.5;
    }
    .toggle-switch.active .toggle-icon-list{
      opacity:0.5;
    }
    .toggle-switch.active .toggle-icon-match{
      opacity:1;
    }
    .toggle-icon svg{
      width:18px;
      height:18px;
      stroke-width:2.5;
    }
    .toggle-slider{
      position:absolute;
      width:24px;
      height:24px;
      background:#fff;
      border-radius:50%;
      transition:transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:0 2px 4px rgba(0,0,0,0.2);
      left:4px;
      z-index:3;
    }
    .toggle-switch.active .toggle-slider{
    
    /* Status-Ampel Animationen */
    @keyframes pulse-green {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }
    @keyframes blink-red {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    @keyframes pulse-yellow {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }
    @keyframes pulse-green-dot {
      0%, 100% { 
        opacity: 1; 
        transform: scale(1);
        box-shadow: 0 0 12px rgba(39,174,96,0.8);
      }
      50% { 
        opacity: 0.8; 
        transform: scale(1.2);
        box-shadow: 0 0 20px rgba(39,174,96,1);
      }
    }
    
    /* Status-Ampel: Nur im Provider-Modus sichtbar */
    #providerStatusIndicator {
      display: none;
    }
    body.provider-mode #providerStatusIndicator {
      display: flex !important;
    }
      transform:translateX(32px);
    }
    
    /* Discover Header - Sticky, immer Ã¼ber Kategorie- und Tage-Leiste (z-index > 90) */
    .discover-header-sticky{
      position:sticky; top:0; z-index:100;
      background:rgba(255,255,255,.98); backdrop-filter:blur(20px);
      border-bottom:1px solid rgba(0,0,0,.06);
      box-shadow:0 2px 8px rgba(0,0,0,.04);
    }
    
    /* Ebene 1: Standortsuche (ganz oben) */
    .discover-location-search-row{
      padding:10px 16px 8px; max-width:100%; margin:0 auto;
      box-sizing:border-box;
    }
    .discover-location-search-input{
      width:100%; padding:12px 16px; border-radius:12px;
      border:1px solid rgba(0,0,0,.1); background:#fff;
      font-size:15px; font-weight:500; color:#333;
      outline:none; box-sizing:border-box;
    }
    .discover-location-search-input::placeholder{
      color:#999; font-weight:400;
    }
    .discover-location-search-input:focus{
      border-color:var(--brand); box-shadow:0 0 0 3px rgba(255,215,0,0.1);
    }
    /* Location-Autofill Suggestions */
    .location-suggestion-item{
      padding:10px 12px;
      cursor:pointer;
      border-bottom:1px solid rgba(0,0,0,0.05);
      transition:background 0.2s ease;
    }
    .location-suggestion-item:hover{
      background:rgba(0,0,0,0.05);
    }
    .location-suggestion-item:active{
      background:rgba(0,0,0,0.1);
    }
    .location-suggestion-item{
      padding:10px 12px;
      cursor:pointer;
      border-bottom:1px solid rgba(0,0,0,0.05);
      transition:background 0.2s ease;
    }
    .location-suggestion-item:hover{
      background:rgba(0,0,0,0.05);
    }
    .location-suggestion-item:active{
      background:rgba(0,0,0,0.1);
    }
    
    /* Ebene 2: Aktueller Standort zentriert (klickbar) */
    .discover-location-row{
      display:flex; justify-content:center; align-items:center;
      padding:6px 10px; max-width:100%; margin:0 auto;
      box-sizing:border-box;
    }
    .discover-location-pill-clickable{
      display:flex; align-items:center; gap:6px;
      padding:8px 14px; border-radius:20px;
      background:rgba(0,0,0,.04); border:1px solid rgba(0,0,0,.08);
      font-size:14px; font-weight:600; color:#333;
      cursor:pointer; transition:all 0.2s ease;
      border:none; background:transparent;
    }
    .discover-location-pill-clickable:hover{
      background:rgba(0,0,0,.06);
    }
    .discover-location-pill-clickable i{
      width:16px; height:16px; color:#666;
    }
    
    /* Ebene 2: Quick-Filter Buttons nebeneinander */
    .discover-quick-filters-row{
      display:flex; align-items:center; justify-content:center; gap:6px;
      padding:0 10px 6px; max-width:100%; margin:0 auto;
      box-sizing:border-box;
    }
    
    .quick-filter-btn{
      display:flex; align-items:center; gap:6px;
      padding:10px 16px; border-radius:24px;
      border:1px solid rgba(0,0,0,.1);
      background:#fff; color:#333;
      font-size:14px; font-weight:600;
      cursor:pointer; transition:all 0.2s ease;
      white-space:nowrap;
      box-shadow:0 2px 4px rgba(0,0,0,.05);
    }
    .quick-filter-btn i{
      width:18px; height:18px; flex-shrink:0;
    }
    .quick-filter-btn:hover{
      background:#f8f8f8;
      transform:translateY(-1px);
      box-shadow:0 4px 8px rgba(0,0,0,.08);
    }
    .quick-filter-btn.active{
      background:var(--brand);
      color:#2D3436; border-color:var(--brand);
      font-weight:700;
      box-shadow:0 4px 12px rgba(255,204,0,0.3);
    }
    
    .discover-header{
      position:relative;
    }
    /* Kompakte Standort-Pill (44-48px) - zentriert */
    .discover-location-pill{
      display:flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:24px;
      background:rgba(0,0,0,.04); border:1px solid rgba(0,0,0,.08);
      height:44px; box-sizing:border-box;
      max-width:280px; width:100%;
    }
    .discover-location-icon-left{
      width:18px; height:18px; flex-shrink:0; opacity:.7;
      color:#666;
    }
    .discover-location-input{
      flex:1; border:none; background:transparent;
      font-size:15px; font-weight:500; color:#333;
      outline:none; min-width:0;
    }
    .discover-location-input::placeholder{
      color:#999; font-weight:400;
    }
    .discover-location-btn{
      width:32px; height:32px; border-radius:50%;
      border:none; background:transparent;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; transition:background .2s;
      flex-shrink:0;
    }
    .discover-location-btn:hover{
      background:rgba(0,0,0,.05);
    }
    .discover-location-btn i{
      width:18px; height:18px; color:#666;
    }
    
    /* Filter-Leiste: Kategorien (schmal, dezent, farbige Icons) - Fixiert oben */
    .discover-categories-wrapper{
      padding:6px 0 8px;
      border-top:1px solid rgba(0,0,0,.04);
      max-width:980px; margin:0 auto;
      position:sticky;
      top:0;
      background:#fff;
      z-index:50;
      box-shadow:0 2px 8px rgba(0,0,0,0.02);
    }
    .discover-categories-scroll{
      display:flex; gap:6px; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding:0 10px; scrollbar-width:none;
    }
    .discover-categories-scroll::-webkit-scrollbar{display:none}
    .discover-category-chip{
      flex:0 0 auto; padding:6px 12px;
      height:32px; border-radius:16px; border:1px solid rgba(0,0,0,.08);
      font-size:12px; font-weight:600;
      display:flex; align-items:center; gap:6px;
      background:#f8f8f8; color:#333;
      cursor:pointer; transition:all 0.2s ease;
      background:#f1f5f9; color:#64748b;
      cursor:pointer; transition:all .2s;
      white-space:nowrap;
      display:flex; align-items:center; justify-content:center; gap:3px;
    }
    .discover-category-chip i{
      width:12px; height:12px; flex-shrink:0;
      opacity:0.7;
    }
    .discover-category-chip span{
      font-size:11px;
    }
    .discover-category-chip.active{
      background:var(--brand); color:#000;
      border-color:var(--brand);
      font-weight:900;
      box-shadow:0 2px 6px rgba(255,204,0,.3);
    }
    .discover-category-chip:not(.active){
      border-color:rgba(0,0,0,.08);
      background:#f1f5f9;
    }
    .discover-category-chip:active{
      transform:scale(.96);
    }
    
    /* Kalender (horizontal swipebar, ohne Ãœberschrift, distinct style) */
    .discover-calendar{
      padding:0 0 14px;
      max-width:980px; margin:0 auto;
      border-top:1px solid rgba(0,0,0,.06);
      margin-top:4px;
      padding-top:10px;
    }
    .discover-calendar-scroll{
      display:flex; gap:6px; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding:0 10px; scrollbar-width:none;
    }
    .discover-calendar-scroll::-webkit-scrollbar{display:none}
    .discover-day{
      flex:0 0 auto; padding:8px 14px;
      border-radius:16px; border:1.5px solid rgba(0,0,0,.15);
      font-size:13px; font-weight:600;
      background:#fff; color:#666;
      cursor:pointer; transition:all .2s;
      white-space:nowrap;
      min-width:50px; text-align:center;
    }
    .discover-day.active{
      background:var(--brand); color:#000;
      border-color:var(--brand);
      box-shadow:0 2px 6px rgba(255,204,0,.25);
      font-weight:900;
    }
    .discover-day:active{
      transform:scale(.96);
    }
    
    /* Quick-Filter Pill (groÃŸe Kapsel) */
    .discover-quick-filter-pill{
      transition:all 0.2s ease;
    }
    .discover-quick-filter-pill.active{
      background:var(--brand) !important;
      border-color:var(--brand) !important;
      color:#1a1a1a !important;
      font-weight:900 !important;
      box-shadow:0 2px 6px rgba(255,204,0,.3);
    }
    .discover-quick-filter-pill:active{
      transform:scale(.96);
    }
    
    /* Navigation: "Zur Liste wechseln" Button (sticky) */
    .discover-list-toggle-row{
      position:sticky; top:0; z-index:50;
      padding:8px 10px; background:rgba(255,255,255,0.95);
      backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px);
      border-bottom:1px solid rgba(0,0,0,.06);
      box-shadow:0 2px 8px rgba(0,0,0,.05);
      transition:box-shadow 0.2s ease;
    }
    .discover-list-toggle-row.scrolled{
      box-shadow:0 4px 12px rgba(0,0,0,.1);
    }
    .btn-list-toggle{
      width:100%; padding:12px 20px; border-radius:999px;
      border:1px solid rgba(0,0,0,.1); background:#fff;
      font-size:14px; font-weight:600; color:#333;
      cursor:pointer; transition:all 0.2s ease;
      display:flex; align-items:center; justify-content:center; gap:8px;
      box-shadow:0 2px 6px rgba(0,0,0,.08);
    }
    .btn-list-toggle:hover{
      background:#f8f8f8; transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(0,0,0,.12);
    }
    .btn-list-toggle:active{
      transform:translateY(0);
      box-shadow:0 2px 4px rgba(0,0,0,.1);
    }
    .btn-list-toggle i{
      width:18px; height:18px;
    }
    
    /* Angebots-Liste Container (kompakt, vertikal) */
    .discover-offers{
      max-width:980px; margin:0 auto; padding:12px 10px;
      display:flex; flex-direction:column; gap:6px;
      box-sizing:border-box;
    }
    /* Polaroid-Karten: ZufÃ¤llige Rotation fÃ¼r natÃ¼rlichen Look */
    .card.polaroid{
      transform:rotate(0deg);
      transition:transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card.polaroid:nth-child(3n+1){
      transform:rotate(-1deg);
    }
    .card.polaroid:nth-child(3n+2){
      transform:rotate(0.8deg);
    }
    .card.polaroid:nth-child(3n+3){
      transform:rotate(-0.5deg);
    }
    .card.polaroid:hover{
      transform:rotate(0deg) scale(1.03);
      box-shadow:0 6px 20px rgba(0,0,0,0.15), 0 4px 10px rgba(0,0,0,0.1);
      z-index:10;
    }
    /* Kompakte Horizontale Gericht-Karte (Slim-Card) - High Performance */
    /* Entscheidungs-Kacheln (2x2 Grid) */
    .decision-tiles-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      padding: 16px;
    }
    
    @media (min-width: 640px) {
      .decision-tiles-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }
    }
    
    @media (min-width: 1024px) {
      .decision-tiles-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
      }
    }
    
    .dish-card {
      display: flex;
      min-height: 88px;
      max-height: 100px;
      padding: 8px;
      background: #ffffff;
      border-radius: 14px;
      overflow: visible;
      border: 1px solid rgba(0,0,0,0.05);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      margin-bottom: 6px; /* Abstand zwischen Karten */
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
      max-width: 100%;
      box-sizing: border-box;
      width: 100%; /* Volle Breite fÃ¼r vertikale Liste */
    }
    .dish-card:active {
      transform: scale(0.98);
    }
    .dish-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    /* Linke Seite: Bild - Kompakt als Thumbnail (max. 100px quadratisch) */
    .dish-image-box {
      width: 100px;
      min-width: 100px;
      height: 100px;
      max-width: 100px;
      max-height: 100px;
      flex-shrink: 0;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border-radius: 12px;
    }
    .dish-image-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
    }
    /* Rechte Seite: Details (kompakt, ohne extra Padding) */
    .dish-details {
      flex: 1;
      padding: 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-width: 0;
    }
    /* Obere Zeile: Name & Preis */
    .dish-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
    }
    .dish-name {
      font-size: 20px; /* ErhÃ¶ht fÃ¼r bessere Lesbarkeit */
      font-weight: 900; /* KrÃ¤ftiger */
      color: #111;
      line-height: 1.3; /* Verbesserter Zeilenabstand */
      margin: 0;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Montserrat', 'Segoe UI', sans-serif;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    /* Favoriten Grid-Kachel: Basis (Jiggle + relative fÃ¼r X-Button) */
    .fav-grid-card {
      position: relative;
      background: #fff !important;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    /* Jiggle-Effekt: Leichtes, dauerhaftes Wackeln (Rotation Â±1.2Â°) */
    @keyframes jiggle {
      0%, 100% {
        transform: rotate(-1.2deg);
      }
      25% {
        transform: rotate(1.2deg);
      }
      50% {
        transform: rotate(-1.2deg);
      }
      75% {
        transform: rotate(1.2deg);
      }
    }
    
    /* Jiggle-Animation nur auf .fav-grid-card anwenden */
    .fav-grid-card {
      animation: fadeIn 0.3s ease-out, jiggle 3s ease-in-out infinite;
    }
    
    /* Exit-Animation: Kachel skaliert auf 0 und verschwindet, andere rÃ¼cken flÃ¼ssig nach */
    @keyframes removeCard {
      0% {
        opacity: 1;
        transform: scale(1) rotate(0deg);
      }
      100% {
        opacity: 0;
        transform: scale(0) rotate(0deg);
      }
    }
    
    .fav-grid-card.removing {
      animation: removeCard 0.25s ease-out forwards;
    }
    
    /* Skeleton Loading Animation (Pulse) */
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    .skeleton-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    .skeleton-bg {
      background-color: #e2e8f0; /* slate-200 */
    }
    .skeleton-bg-light {
      background-color: #f1f5f9; /* slate-100 */
    }
    
    /* Favoriten-Icon Bounce */
    @keyframes favBounce {
      0%, 100% { transform: scale(1); }
      25% { transform: scale(1.3); }
      50% { transform: scale(0.9); }
      75% { transform: scale(1.15); }
    }
    .fav-icon-bounce {
      animation: favBounce 0.5s ease-out;
    }
    @keyframes cartIconGlow {
      0%, 100% { filter: brightness(1); transform: scale(1); }
      50% { filter: brightness(1.4); transform: scale(1.15); }
    }
    .cart-icon-glow {
      animation: cartIconGlow 0.5s ease-out;
    }
    /* Flug-Animation: Thumbnail fliegt in die Mittagsbox */
    .fly-thumbnail {
      position: fixed;
      z-index: 10001;
      pointer-events: none;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    }
    .fly-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    
    /* Favoriten-Grid: Radikale Verkleinerung S25/iPhone â€“ 4 Kacheln ohne Scroll */
    #v-fav #favDishes.fav-dishes-grid,
    #v-fav #favDishes {
      display: grid !important;
      grid-template-columns: 1fr 1fr !important;
      gap: 8px !important;
      padding: 8px !important;
      max-width: 100%;
    }
    #v-fav .fav-grid-card {
      height: 100%;
      min-height: 220px !important;
      max-height: none;
      max-width: 170px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      border-radius: 12px !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
      border: 1px solid rgba(0,0,0,0.06);
      overflow: hidden;
    }
    #v-fav .fav-grid-card .fav-card-img-wrap {
      width: 100%;
      height: 110px !important;
      flex-shrink: 0;
      overflow: hidden;
      background: #f0f0f0;
    }
    #v-fav .fav-grid-card .fav-card-img-wrap img {
      width: 100%;
      height: 110px !important;
      object-fit: cover;
    }
    #v-fav .fav-grid-card .fav-card-body {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      padding: 6px 8px 8px;
    }
    #v-fav .fav-grid-card .fav-card-title {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 12px !important;
    }
    /* Preis-Badge Favoriten: klein & dezent (radikale Verkleinerung) */
    #v-fav .fav-card-price-sticker {
      position: absolute;
      bottom: 5px;
      right: 5px;
      padding: 2px 6px !important;
      border-radius: 4px !important;
      background: rgba(0,0,0,0.6) !important;
      font-weight: 700;
      font-size: 0.75rem !important;
      color: #fff;
      z-index: 10;
    }
    /* SÃ¤ulen-Mini: nur Emojis, zentriert */
    #v-fav .saeulen-mini {
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 4px 0;
    }
    #v-fav .saeulen-mini .emoji-icon {
      font-size: 1.1rem;
      opacity: 0.5;
    }
    #v-fav .saeulen-mini .emoji-icon.active {
      opacity: 1;
    }
    #v-fav .abholnummer-highlight {
      background: var(--brand);
      padding: 2px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
    }
    /* Favoriten-Header: schlank & verspielt â€“ "Deine Favoriten heute âš¡" */
    .fav-header-wrap {
      background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(255,250,240,0.96) 100%) !important;
    }
    .fav-header-title {
      font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
      font-weight: 700 !important;
      letter-spacing: 0.02em !important;
    }
    /* Share-Button: Icon ohne Rahmen, schwebt rechts neben Text */
    #btnFavShareHeader {
      border: none !important;
      background: transparent !important;
      box-shadow: none !important;
    }
    #v-fav #favContent {
      padding: 8px 8px 20px !important;
    }
    #v-fav .fav-grid-card .btn {
      min-height: 36px !important;
      font-size: 12px !important;
      border-radius: 10px !important;
    }
    /* Meins: letzte Bestellzeile ohne unteren Rand */
    #profileOrderHistoryList .profile-order-item:last-child,
    #profileOrderHistoryMore .profile-order-item:last-child {
      border-bottom: none !important;
    }
    
    /* Responsive Grid fÃ¼r Provider-Favoriten */
    @media (min-width: 768px) {
      #favProviders {
        grid-template-columns: repeat(auto-fill, minmax(256px, 1fr)) !important;
        gap: 20px !important;
        justify-items: center !important;
      }
    }
    @media (max-width: 480px) {
      #favProviders {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
        justify-items: center !important;
      }
    }
    
    /* Responsive Discovery-Liste: Vertikale Liste fÃ¼r alle BildschirmgrÃ¶ÃŸen (kompakt) */
    @media (max-width: 374px) {
      .discover-offers {
        padding: 10px 8px !important;
        gap: 5px !important;
      }
    }
    /* Provider-Layout: Optimiert fÃ¼r kleine Bildschirme (Samsung S25, ~360-412px) */
    @media (max-width: 420px) {
      [id^="v-provider-"]{ padding:16px 12px !important; }
      [id^="v-provider-"] h1{ font-size:26px !important; }
      [id^="v-provider-"] .panel{ padding:14px !important; border-radius:16px !important; }
      #providerStatusIndicator{ top:12px; right:12px; padding:6px 10px; }
      #providerStatusIndicator span{ font-size:11px; }
      /* KPI Cards 3er-Grid â†’ kleinere Schrift */
      #kpiCardTagesessen, #kpiCardAbholungen, #kpiCardKochbuch{ padding:14px 10px !important; }
      #kpiCardTagesessen div:first-child, #kpiCardAbholungen div:first-child, #kpiCardKochbuch div:first-child{ font-size:26px !important; }
      /* Provider-Nav: kompakter */
      #providerNav .navbtn{ font-size:10px; padding:8px 4px; }
      #providerNav .navbtn .ico svg{ width:20px; height:20px; }
    }
    @media (max-width: 360px) {
      [id^="v-provider-"]{ padding:12px 10px !important; }
      [id^="v-provider-"] h1{ font-size:24px !important; }
      #kpiCardTagesessen div:first-child, #kpiCardAbholungen div:first-child, #kpiCardKochbuch div:first-child{ font-size:22px !important; }
    }
    @media (min-width: 768px) {
      .discover-offers {
        padding: 16px 12px !important;
        gap: 8px !important;
      }
    }
    .dish-price {
      font-size: 16px;
      font-weight: 700;
      color: #111;
      white-space: nowrap;
    }
    /* Mittlere Zeile: Anbieter */
    .dish-provider {
      font-size: 13px;
      color: #666;
      font-weight: 500;
      margin-top: 4px;
    }
    /* Untere Zeile: Meta & Buttons */
    .dish-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
    }
    .distance-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 700;
      color: #444;
      background: #f0f0f0;
      padding: 4px 10px;
      border-radius: 8px;
      white-space: nowrap;
    }
    .action-group {
      display: flex;
      gap: 8px;
    }
    .btn-icon {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: 1px solid #f0f0f0;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #111;
      transition: all 0.2s ease;
      cursor: pointer;
      flex-shrink: 0;
    }
    .btn-icon:hover {
      background: #f9f9f9;
    }
    .btn-icon.heart-btn:hover {
      color: #ff4757;
      border-color: #ffdce0;
    }
    .btn-icon.heart-btn.active {
      color: #ff4757;
      background: #ffdce0;
      border-color: #ff4757;
    }
    .discover-list-badge{
      display:inline-flex; align-items:center; gap:3px;
      padding:4px 8px; border-radius:6px;
      font-size:10px; font-weight:700;
      background:rgba(0,0,0,.05); color:#666;
    }
    .discover-list-badge .ico-inline{
      width:14px; height:14px; flex-shrink:0;
    }
    .discover-list-badge .ico-inline svg{
      width:14px; height:14px;
    }
    .discover-list-badge.code{
      background:rgba(255,204,0,.15); color:#b8860b;
    }
    .discover-list-badge.dine{
      background:rgba(31,157,85,.1); color:#1f9d55;
    }
    .discover-list-badge.pickup{
      background:rgba(0,0,0,.05); color:#666;
    }
    .discover-list-actions{
      margin-top:auto; padding-top:8px;
    }
    .discover-list-btn{
      width:100%; padding:10px 14px; border-radius:10px;
      border:none; font-weight:900; font-size:14px;
      cursor:pointer; transition:transform .1s, background .15s;
      text-align:center; background:var(--brand); color:#111;
      display:flex; align-items:center; justify-content:center; gap:6px;
    }
    .discover-list-btn .ico-inline{
      width:18px; height:18px; flex-shrink:0;
    }
    .discover-list-btn .ico-inline svg{
      width:18px; height:18px;
    }
    .discover-list-btn:active{
      transform:scale(.97);
      background:#e6b800;
    }
    
    /* ============================================================
       MODERNE SMARTPHONES (S25, Galaxy S25, iPhone 15/16, Pixel 8)
       Daumenfreundlich: Touch-Ziele mind. 48px, Safe-Area, einhÃ¤ndig
       ============================================================ */
    @media (max-width:430px) and (min-height:700px){
      /* App: Safe-Area unten fÃ¼r Gestenleiste */
      .app{ padding-bottom:calc(78px + env(safe-area-inset-bottom, 20px)) !important; }
      .customer-view{ padding-bottom:calc(78px + env(safe-area-inset-bottom, 20px)) !important; }
      
      /* Bottom Nav: hÃ¶her fÃ¼r S25-Gesten, Touch mind. 48px */
      .bottom{
        height:calc(64px + env(safe-area-inset-bottom, 20px)) !important;
        padding-bottom:env(safe-area-inset-bottom, 20px) !important;
      }
      .navbtn{
        min-height:48px; padding:10px 8px !important;
        font-size:12px !important; font-weight:600;
      }
      .navbtn .ico svg{ width:24px !important; height:24px !important; }
      
      /* Provider Home: Abstand oben fÃ¼r Loch/Notch */
      [id^="v-provider-"]{
        padding-top:calc(20px + env(safe-area-inset-top, 0)) !important;
        padding-left:calc(20px + env(safe-area-inset-left, 0)) !important;
        padding-right:calc(20px + env(safe-area-inset-right, 0)) !important;
      }
      #v-provider-home{ padding:16px 16px 100px !important; }
      #v-provider-home h1{ font-size:28px !important; }
      
      /* KPI Cards: 3er Grid, Touch-freundlich */
      #v-provider-home [style*="grid-template-columns:repeat(3"]{ gap:10px !important; }
      #kpiCardTagesessen, #kpiCardAbholungen, #kpiCardKochbuch{
        padding:16px 10px !important; border-radius:16px !important;
        min-height:72px; display:flex; flex-direction:column; justify-content:center;
      }
      #kpiCardTagesessen div[style*="font-size:20px"],
      #kpiCardAbholungen div[style*="font-size:32px"],
      #kpiCardKochbuch div[style*="font-size:32px"]{
        font-size:26px !important;
      }
      
      #providerTimeTracker{ padding:18px !important; }
      #providerTimeTracker div[style*="font-size:36px"]{ font-size:30px !important; }
      #providerPersonalSpar{ padding:16px !important; }
      
      #v-provider-pickups, #v-provider-week, #v-provider-cookbook, #v-provider-profile{
        padding:16px 16px 100px !important;
      }
      #v-provider-profile{
        padding:20px 20px calc(90px + env(safe-area-inset-bottom, 0)) !important;
      }
      #v-provider-pickups h3, #v-provider-cookbook h1, #v-provider-week h1, #v-provider-profile h1{
        font-size:24px !important;
      }
      #v-provider-profile .panel{ padding:18px !important; border-radius:16px !important; margin-bottom:16px !important; }
      #v-provider-profile .provider-profile-section-title{ margin-top:24px; margin-bottom:12px; }
      #v-provider-profile .provider-profile-section-title:first-of-type{ margin-top:0; }
      
      /* Provider Bottom Nav: Safe-Area, Touch 48px */
      #providerNav{
        height:calc(64px + env(safe-area-inset-bottom, 20px)) !important;
        padding-bottom:env(safe-area-inset-bottom, 20px) !important;
      }
      #providerNav .navbtn{
        min-height:48px; padding:12px 8px !important; font-size:11px !important;
      }
      #providerNav .navbtn .ico svg{ width:22px !important; height:22px !important; }
      
      /* FAB: Ã¼ber Nav + Safe-Area */
      #fabProviderAddOffer{
        bottom:calc(80px + env(safe-area-inset-bottom, 20px)) !important;
        right:calc(20px + env(safe-area-inset-right, 0)) !important;
        width:56px !important; height:56px !important;
        min-width:56px; min-height:56px;
      }
      #fabProviderAddOfferLabel{ right:calc(20px + env(safe-area-inset-right, 0)) !important; }
      
      /* Sheets: max-height mit Safe-Area */
      .sheet{ max-height:calc(92vh - env(safe-area-inset-bottom, 0)) !important; }
      
      /* Buttons: Mindest-Touch 48px */
      .btn, .btn-primary, .btn-secondary{
        min-height:48px !important;
      }
      
      /* S25 / Daumenfreundlich: Inseratsflow & Create-Flow */
      #wizard.sheet--kitchen .w-actions button{
        min-height:52px !important;
        padding:14px 20px !important;
      }
      #wizard.sheet--kitchen .w-actions{
        padding:18px 20px calc(20px + env(safe-area-inset-bottom, 24px)) !important;
      }
      #wizard.sheet--kitchen #wContent .ans{
        min-height:48px !important;
        padding:14px 18px !important;
        min-width:0;
      }
      #wizard.sheet--kitchen #wContent .ans.ans--thumb{
        min-height:72px !important;
        min-width:72px !important;
      }
      #wizard.sheet--kitchen #wContent .answers{
        gap:10px !important;
      }
      #wizard.sheet--kitchen .field{
        min-height:48px !important;
        padding:16px 18px !important;
      }
      #wizard.sheet--kitchen .wizard-scroll{
        padding-bottom:24px !important;
      }
      #wizard.sheet--kitchen .handle{
        padding:12px 0 !important;
        margin:12px auto 8px !important;
        min-height:24px !important;
      }
      #createFlowSheet.sheet--kitchen .sheet-body{
        padding:20px 20px calc(24px + env(safe-area-inset-bottom, 24px)) !important;
      }
      #createFlowSheet.sheet--kitchen .btn-create-primary,
      #createFlowSheet.sheet--kitchen .btn-create-secondary{
        min-height:56px !important;
        padding:16px 20px !important;
      }
      
      /* Kochbuch: Daumenfreundlich (S25) */
      #v-provider-cookbook .cookbook-cta{ min-height:56px !important; }
      #v-provider-cookbook .cookbook-search,
      #v-provider-cookbook #cookbookSortSelect{ min-height:48px !important; }
      #v-provider-cookbook .cookbook-tabs button{ min-height:48px !important; }
      #v-provider-cookbook .cookbook-item-btn{ min-height:52px !important; }
      #v-provider-cookbook .cookbook-item-menu{ width:44px !important; height:44px !important; }
      #v-provider-cookbook .cookbook-action-sheet-btn{ min-height:52px !important; }
      
      .discover-offers{ padding:14px 12px !important; gap:12px !important; }
      .card.polaroid{ border-radius:18px !important; }
    }
    
    /* Extra kleine Phones (<375px, z.B. iPhone SE) */
    @media (max-width:374px){
      #v-provider-home{ padding:12px 8px 90px !important; }
      #v-provider-home h1{ font-size:22px !important; }
      #kpiCardTagesessen, #kpiCardAbholungen, #kpiCardKochbuch{ padding:10px 6px !important; }
      #kpiCardTagesessen div[style*="font-size:20px"],
      #kpiCardAbholungen div[style*="font-size:32px"],
      #kpiCardKochbuch div[style*="font-size:32px"]{ font-size:22px !important; }
    }
    /* Bild-Container (Discover-Karten): Quadratisch, zentriert */
    .card .img{
      width:100%; margin:0 0 12px;
      display:flex; justify-content:center; align-items:center;
      background:transparent;
      position:relative;
    }
    /* Back Navigation */
    .back-button{
      position:absolute; top:12px; left:12px;
      width:40px; height:40px;
      border-radius:50%; border:none;
      background:rgba(255,255,255,.9);
      backdrop-filter:blur(10px);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; z-index:10;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
    }
    .back-button i{
      width:20px; height:20px;
    }

    /* Chat-Bubbles Feed */
    .feed-container{
      max-width:980px; margin:0 auto; padding:0 16px 20px;
    }
    .chat-bubble{
      background:#fff; border:1px solid var(--border);
      border-radius:var(--radius); padding:16px;
      margin-bottom:16px; box-shadow:0 4px 12px rgba(0,0,0,.06);
      position:relative;
    }
    .chat-bubble-header{
      display:flex; align-items:center; gap:12px; margin-bottom:12px;
    }
    .chat-bubble-avatar{
      width:44px; height:44px; border-radius:50%;
      overflow:hidden; flex:0 0 auto;
      border:2px solid var(--border);
    }
    .chat-bubble-avatar img{
      width:100%; height:100%; object-fit:cover;
    }
    .chat-bubble-meta{
      flex:1; min-width:0;
    }
    .chat-bubble-name{
      font-weight:900; font-size:17px; margin-bottom:4px; line-height:1.3;
    }
    .chat-bubble-time{
      font-size:13px; color:var(--muted);
      display:flex; align-items:center; gap:6px; line-height:1.4;
    }
    .chat-bubble-distance{
      position:absolute; top:16px; right:16px;
      font-size:12px; font-weight:700; color:var(--muted);
      background:#f8f7f3; padding:5px 10px; border-radius:999px;
    }
    .chat-bubble-message{
      font-size:16px; line-height:1.6; color:var(--text);
      margin-bottom:14px;
    }
    .chat-bubble-image{
      width:100%; border-radius:16px; overflow:hidden;
      margin-bottom:12px; max-height:300px; object-fit:cover;
    }
    .chat-bubble-actions{
      display:flex; gap:10px; margin-top:12px;
    }
    .chat-bubble-btn{
      flex:1; padding:12px; border-radius:12px;
      border:none; font-weight:900; font-size:14px;
      cursor:pointer; transition:transform .1s;
    }
    .chat-bubble-btn:active{transform:scale(.98)}
    .chat-bubble-btn-primary{
      background:var(--brand); color:#111;
    }
    .chat-bubble-btn-secondary{
      background:#f8f7f3; border:1px solid var(--border); color:var(--text);
    }
    .feed-empty{
      max-width:980px; margin:0 auto;
    }
    
    /* Pickup Card (Theken-Ansicht 2.0) */
    .pickup-card{
      background:#fff;
      border-radius:16px;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
      position:relative;
      overflow:hidden;
      transition:all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
      cursor:pointer;
      border-left:6px solid #e5e7eb; /* Default */
      display:flex;
      flex-direction:column;
      min-height:160px;
    }
    .pickup-card:active{ transform:scale(0.96); }
    .pickup-card.status-open{ border-left-color:#FFD700; }
    .pickup-card.status-paid{ border-left-color:#2ecc71; } /* Bezahlt & Bereit */
    .pickup-card.status-done{ opacity:0.6; filter:grayscale(100%); border-left-color:#999; box-shadow:none; background:#f9f9f9; }
    
    .pickup-card-header{
      padding:16px 16px 0;
      display:flex; justify-content:space-between; align-items:flex-start;
    }
    .pickup-card-code{
      font-size:42px; font-weight:900; line-height:1; color:#1a1a1a; letter-spacing:-0.03em;
    }
    .pickup-card-time{
      font-size:13px; font-weight:700; color:#666; background:#f0f2f5; padding:4px 8px; border-radius:8px;
    }
    .pickup-card-body{
      padding:12px 16px 16px;
      flex:1; display:flex; flex-direction:column; justify-content:flex-end;
    }
    .pickup-card-dish{
      font-size:16px; font-weight:700; line-height:1.3; color:#333; margin-bottom:4px;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
    }
    .pickup-card-customer{
      font-size:13px; color:#888; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .pickup-card-badge{
      position:absolute; top:12px; right:12px;
      background:#2ecc71; color:#fff; font-size:11px; font-weight:800; padding:4px 8px; border-radius:6px;
      box-shadow:0 2px 6px rgba(46,204,113,0.3);
    }
    
    /* Animation fÃ¼r Erledigt */
    @keyframes check-pop {
      0% { transform:scale(0); opacity:0; }
      50% { transform:scale(1.2); opacity:1; }
      100% { transform:scale(1); opacity:1; }
    }
    .check-overlay{
      position:absolute; inset:0; background:rgba(46,204,113,0.9);
      display:flex; align-items:center; justify-content:center;
      opacity:0; pointer-events:none; transition:opacity 0.2s;
    }
    .pickup-card.just-done .check-overlay{ opacity:1; }
    .pickup-card.just-done .check-icon{ animation:check-pop 0.3s ease-out forwards; }
    /* Sticky Categories Bar */
    .discover-categories-sticky {
      position: sticky;
      top: 60px; /* Header height approx */
      z-index: 90;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 12px 16px;
      overflow-x: auto;
      white-space: nowrap;
      display: flex;
      gap: 10px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      margin-bottom: 16px;
      scrollbar-width: none; /* Firefox */
    }
    .discover-categories-sticky::-webkit-scrollbar { display: none; }
    
    .cat-pill {
      padding: 8px 16px;
      border-radius: 20px;
      background: #f2f2f2;
      color: #666;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .cat-pill:active { transform: scale(0.95); }
    .cat-pill.active {
      background: #1a1a1a;
      color: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .cat-pill i { width: 16px; height: 16px; }

    /* Kalender/Day-Pills â€“ moderner Look */
    .discover-days-sticky {
      gap: 10px;
      padding: 12px 16px;
      background: linear-gradient(180deg, rgba(255,248,240,0.98) 0%, rgba(247,246,240,0.95) 100%);
      border-bottom: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 2px 12px rgba(0,0,0,0.04);
    }
    .day-pill {
      flex-shrink: 0;
      min-width: 72px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 2px solid transparent;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      background: #fff;
      color: #64748b;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .day-pill:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 14px rgba(0,0,0,0.1);
      color: #334155;
    }
    .day-pill:active { transform: scale(0.97); }
    .day-pill.day-pill--today {
      background: linear-gradient(135deg, #FFD700 0%, #f2b705 100%);
      color: #1a1a1a;
      border-color: rgba(0,0,0,0.08);
      box-shadow: 0 4px 16px rgba(255,215,0,0.35);
    }
    .day-pill.day-pill--today:hover {
      box-shadow: 0 6px 20px rgba(255,215,0,0.45);
      transform: translateY(-2px);
    }
    .day-pill .day-pill-label { font-weight: 800; letter-spacing: -0.02em; }
    .day-pill .day-pill-date { font-size: 11px; font-weight: 600; opacity: 0.85; }

    /* Redesigned Offer Card (Modern App Style) */
    .offer-card-modern {
      background: #fff;
      border-radius: 24px;
      width: 95%;
      max-width: 95%;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
      margin-bottom: 24px;
      overflow: hidden;
      position: relative;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border: 1px solid rgba(0,0,0,0.02);
    }
    .offer-card-modern:active { transform: scale(0.98); }
    
    .ocm-image-container {
      position: relative;
      width: 100%;
      aspect-ratio: 4/3;
      background: #f0f0f0;
      overflow: hidden;
    }
    .ocm-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s ease;
    }
    
    .ocm-provider-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(8px);
      padding: 6px 12px 6px 6px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      font-size: 13px;
      font-weight: 700;
      color: #333;
      z-index: 2;
    }
    .ocm-provider-logo {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #eee;
      object-fit: cover;
    }
    
    .ocm-like-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      color: #333;
      z-index: 2;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .ocm-like-btn:active { transform: scale(0.8); }
    .ocm-like-btn.active { color: #e74c3c; fill: #e74c3c; }
    
    .ocm-price-tag {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: #1a1a1a;
      color: #fff;
      padding: 8px 14px;
      border-radius: 16px;
      font-weight: 800;
      font-size: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .ocm-content { padding: 16px 20px 20px; }
    .ocm-title {
      font-size: 18px;
      font-weight: 800;
      color: #1a1a1a;
      margin: 0 0 8px;
      line-height: 1.3;
    }
    .ocm-meta {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(0,0,0,0.05);
      font-size: 13px;
      color: #666;
      font-weight: 500;
    }
    .ocm-meta-item { display: flex; align-items: center; gap: 6px; }
    .ocm-meta-item i { width: 16px; height: 16px; color: #999; }
    /* Silicon-Valley Pills: dezente Pop-Animation beim Laden */
    .ocm-pills-row {
      animation: ocmPillPop 0.35s ease-out;
    }
    @keyframes ocmPillPop {
      from { opacity: 0; transform: scale(0.96); }
      to { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body>
<div class="app" id="app">
  <div class="topbar" id="topbar">
      <div class="topbar-inner">
        <!-- View-Toggle wurde in den discover-header verschoben -->
      <div class="spacer"></div>
<!-- modePill removed -->
    </div>
  </div>

  <main>
    <!-- START - Lunch-Feed (Social Style) - ENTFERNT -->


    <!-- CUSTOMER: Discover - App-like UX (Final Spec) -->
    <section class="view customer-view active" id="v-discover">
      <!-- Header: Einziger primÃ¤rer Header â€“ Standort | Logo | Ansicht-Toggle. Keine Filter-Leisten. -->
      <div class="discover-header-sticky discover-header-clean" style="background:rgba(232,224,214,0.92); backdrop-filter:saturate(160%) blur(8px); -webkit-backdrop-filter:saturate(160%) blur(8px); border-bottom:1px solid rgba(0,0,0,.06);">
        <div class="discover-header-row" style="position:relative; display:flex; align-items:center; padding:10px 16px; gap:8px;">
          <!-- Standort (links): Nadel-Logik â€“ Klick auf ðŸ“ = GPS, Klick auf Text = manuelle Eingabe -->
          <div style="position:relative; display:flex; align-items:center; gap:4px; flex-shrink:0;">
            <button type="button" id="btnDiscoverLocationGPS" aria-label="Standort per GPS" style="display:flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:50%; border:none; background:rgba(0,0,0,.04); color:#666; cursor:pointer; transition:all 0.2s ease; flex-shrink:0;">
              <i data-lucide="map-pin" style="width:18px;height:18px;"></i>
            </button>
            <button type="button" id="btnDiscoverLocationText" class="discover-location-pill-clickable" style="display:flex; align-items:center; gap:4px; padding:6px 12px; border-radius:16px; background:rgba(0,0,0,.04); border:none; font-size:13px; font-weight:600; color:#333; cursor:pointer; transition:all 0.2s ease; min-width:0;">
              <span id="discoverCurrentLocation" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">Standortâ€¦</span>
            </button>
            <!-- Standort-Dropdown: fixed, damit es immer sichtbar unter dem Button liegt (nicht von sticky-Bars verdeckt) -->
            <div id="discoverLocationExpanded" style="display:none; position:fixed; z-index:99999; background:#fff; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.2); border:1px solid rgba(0,0,0,0.1); overflow:hidden; min-width:280px; max-width:calc(100vw - 32px);">
              <div style="padding:16px;">
                <div style="font-size:10px; font-weight:800; color:#9ca3af; text-transform:uppercase; letter-spacing:0.06em; margin-bottom:12px;">Standort</div>
                <button type="button" id="discoverLocationBtnNadel" style="width:100%; padding:14px 16px; border-radius:12px; border:2px solid rgba(0,0,0,0.08); background:rgba(255,222,0,0.12); font-size:15px; font-weight:700; color:#1a1a1a; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:16px;">
                  <i data-lucide="map-pin" style="width:20px;height:20px;"></i>
                  <span>Mit Nadel (GPS)</span>
                </button>
                <div style="font-size:12px; color:#9ca3af; text-align:center; margin-bottom:12px;">Oder</div>
                <div style="font-size:11px; font-weight:700; color:#6b7280; margin-bottom:8px;">PLZ / Ort eingeben</div>
                <input type="text" id="discoverLocationInput" placeholder="PLZ oder Ort eingeben..." autocomplete="address-line2" style="width:100%; padding:12px 14px; border-radius:8px; border:2px solid rgba(0,0,0,0.1); font-size:16px; background:#fff; color:#1a1a1a; outline:none; transition:border-color 0.2s ease; box-sizing:border-box; -webkit-text-fill-color:#1a1a1a;" onfocus="this.style.borderColor='#FFD700';" onblur="this.style.borderColor='rgba(0,0,0,0.1)';" />
                <div id="discoverLocationSuggestions" style="max-height:min(200px, 40vh); overflow-y:auto; margin-top:8px;"></div>
                <button type="button" id="discoverLocationClose" style="margin-top:12px; width:100%; padding:10px; background:rgba(0,0,0,0.06); border:none; border-radius:8px; font-size:14px; font-weight:600; color:#333; cursor:pointer;">SchlieÃŸen</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sticky Categories Bar -->
      <div class="discover-categories-sticky" id="discoverCategoriesBar" style="z-index:90;">
        <!-- Wird dynamisch befÃ¼llt -->
      </div>
      
      <!-- Sticky Days Bar (Second Layer) -->
      <div class="discover-days-sticky" id="discoverDaysBar" style="position:sticky; top:115px; z-index:89; background:rgba(247,246,240,0.95); backdrop-filter:blur(10px); padding:8px 16px; overflow-x:auto; white-space:nowrap; display:flex; gap:10px; border-bottom:1px solid rgba(0,0,0,0.05); margin-bottom:16px; scrollbar-width:none;">
        <!-- Wird dynamisch befÃ¼llt -->
      </div>

      <!-- Angebots-Liste (horizontale List-Cards) -->
      <div class="discover-offers" id="discoverOffers">
        <!-- Wird dynamisch befÃ¼llt -->
      </div>
      
      <!-- Leerer Zustand (wenn keine Angebote) -->
      <div id="discoverEmpty" style="display:none; text-align:center; padding:80px 20px;">
        <div style="font-size:64px; margin-bottom:20px; opacity:.6;">ðŸ½ï¸</div>
        <div style="font-size:18px; font-weight:900; margin-bottom:10px; color:#333; line-height:1.4;">
          Noch keine Mittagsangebote in deiner NÃ¤he
        </div>
        <div style="display:flex; flex-direction:column; gap:12px; max-width:280px; margin:24px auto 0;">
          <button class="btn" type="button" onclick="openDiscoverLocationSearch();" style="width:100%;">
            Standort Ã¤ndern
          </button>
          <button class="btn secondary" type="button" onclick="setMode('provider')" style="width:100%;">
            Als Anbieter starten
          </button>
        </div>
      </div>
    </section>

    <!-- Provider-Billing: Modern Dark Mode -->
    <section class="view" id="v-provider-billing" style="background:#121212; min-height:100vh; padding:20px; padding-bottom:90px;">
      <!-- Sticky Header -->
      <div style="background:rgba(28,28,30,0.95); backdrop-filter:blur(20px); position:sticky; top:0; z-index:50; border-bottom:1px solid rgba(255,255,255,0.08); padding:16px 20px; margin:-20px -20px 24px; display:flex; align-items:center; justify-content:center;">
        <h1 style="margin:0; font-size:17px; font-weight:600; color:#fff;">Finanzen & Abrechnung</h1>
        <button id="btnBillingBack" class="btn ghost" type="button" style="position:absolute; left:10px; color:#0A84FF; font-size:16px; padding:8px; display:flex; align-items:center; gap:4px;">
          <i data-lucide="chevron-left" style="width:24px; height:24px;"></i> ZurÃ¼ck
        </button>
      </div>

      <!-- Kosten-Info-Box (wenn nÃ¶tig) -->
      <div id="billingCostInfo" style="background:rgba(46, 204, 113, 0.1); border:1px solid rgba(46, 204, 113, 0.3); border-radius:12px; padding:12px 16px; margin-bottom:24px; display:none;">
        <!-- Wird dynamisch befÃ¼llt -->
      </div>
      
      <!-- Balance Card -->
      <div class="panel" style="background:linear-gradient(135deg, #2c3e50 0%, #000000 100%); border-radius:20px; padding:24px; margin-bottom:24px; border:1px solid rgba(255,255,255,0.1); position:relative; overflow:hidden;">
        <div style="font-size:13px; color:rgba(255,255,255,0.6); margin-bottom:8px; text-transform:uppercase; letter-spacing:1px; font-weight:600;">Auszahlbarer Betrag</div>
        <div style="font-size:36px; font-weight:800; color:#fff; margin-bottom:16px; font-variant-numeric: tabular-nums;" id="billingAmount">0,00 â‚¬</div>
        <div class="hint" id="billingLast" style="color:rgba(255,255,255,0.5); font-size:13px;">Letzte Auszahlung: â€“</div>
        <i data-lucide="coins" style="position:absolute; right:-10px; bottom:-10px; width:100px; height:100px; color:rgba(255,255,255,0.05); transform:rotate(-15deg);"></i>
      </div>

      <!-- Filters & List -->
      <div class="panel" style="background:#1c1c1e; border-radius:18px; padding:20px; border:1px solid rgba(255,255,255,0.05);">
        <div style="margin-bottom:16px;">
          <div style="font-size:13px; color:rgba(255,255,255,0.4); margin-bottom:8px; font-weight:600;">Zeitraum & Status</div>
          <div class="answers" id="billingFilters" style="background:#2c2c2e; padding:4px; border-radius:10px; display:flex; gap:4px; margin-bottom:12px;"></div>
          <select class="field" id="billingMonth" style="background:#2c2c2e; border:none; color:#fff; border-radius:10px; padding:10px 14px; width:100%; font-size:15px; font-weight:500;">
            <option value="2026-01">Januar 2026</option>
            <option value="2025-12">Dezember 2025</option>
            <option value="2025-11">November 2025</option>
          </select>
        </div>
        
        <div id="billingList" class="hint" style="color:rgba(255,255,255,0.4); text-align:center; padding:32px 0;">
          Noch keine Abrechnungen vorhanden.
        </div>
      </div>
    </section>

    <!-- CUSTOMER: Favorites â€“ Fokus auf HEUTE, 2x2 Grid, Pull-to-Reveal -->
    <section class="view customer-view" id="v-fav">
      <div style="padding-bottom:100px;">
        <!-- Header: Titel linksbÃ¼ndig + Share-Icon rechts (verspielter App-Charakter) -->
        <div id="favHeader" class="fav-header-wrap" style="display:flex; align-items:center; justify-content:space-between; gap:12px; padding:20px 16px 12px; backdrop-filter:blur(10px); position:sticky; top:0; z-index:80; border-bottom:1px solid rgba(0,0,0,0.05);">
          <h1 id="favHeaderTitle" class="fav-header-title" style="font-size:20px; font-weight:700; margin:0; color:#1a1a1a; flex:1;">Deine Favoriten heute âš¡</h1>
          <button type="button" id="btnFavShareHeader" aria-label="Teilen" style="flex-shrink:0; width:40px; height:40px; border-radius:50%; border:none; background:transparent; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.2s ease; color:#666;" onmouseover="this.style.color='#1a1a1a';" onmouseout="this.style.color='#666';">
            <i data-lucide="share-2" style="width:20px;height:20px; stroke-width:2;"></i>
          </button>
        </div>
        
        <!-- Empty State -->
        <div id="favEmptyState" style="display:none; flex-direction:column; align-items:center; text-align:center; padding:60px 20px;">
          <div style="width:140px; height:140px; margin-bottom:24px; background:linear-gradient(135deg, #FFF5F5 0%, #FFE0E0 100%); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 30px rgba(231,76,60,0.15);">
            <i data-lucide="heart" style="width:64px; height:64px; color:#E34D4D; fill:#E34D4D;"></i>
          </div>
          <h3 style="font-size:22px; font-weight:900; margin:0 0 12px; color:#1a1a1a;">Noch keine Favoriten?</h3>
          <p style="font-size:16px; color:#666; margin:0 0 32px; line-height:1.6; max-width:300px;">
            Markiere Gerichte und Anbieter mit einem Herz, um sie hier wiederzufinden.
          </p>
          <button class="btn-primary" type="button" onclick="showDiscover();" style="width:100%; max-width:260px; min-height:56px; border-radius:16px; font-size:16px; font-weight:700; box-shadow:0 8px 20px rgba(0,0,0,0.1);">
            Jetzt entdecken
          </button>
        </div>
        
        <div id="favContent" style="padding:20px; display:none;">
          <!-- 1. Ausschlussspiel: 2x2 Grid (oberste 4 Gericht-Favoriten), Jiggle + X -->
          <div id="sectionDishesWrapper">
            <div id="favDishes" class="fav-dishes-grid" style="display:grid; grid-template-columns:repeat(2, 1fr); gap:12px; margin-bottom:20px;"></div>
            <div class="hint" id="emptyFavDishes" style="display:none; text-align:center; padding:24px; background:#f9f9f9; border-radius:16px; margin-bottom:20px;">
              <p style="font-size:14px; color:#666; margin:0;">Heute sind keine deiner Lieblingsgerichte verfÃ¼gbar.</p>
            </div>
            <!-- Share-Logik: Header-Button (btnFavShareHeader) + optionaler Fallback sichtbar nur wenn gewÃ¼nscht -->
            <div id="favShareWrap" style="display:none; margin-bottom:24px; text-align:center;">
              <button type="button" id="btnShareMyLunch" style="padding:10px 20px; background:rgba(0,0,0,0.05); border:1px solid rgba(0,0,0,0.08); border-radius:20px; font-size:14px; font-weight:600; color:#666; cursor:pointer; display:inline-flex; align-items:center; gap:8px; transition:all 0.2s ease;" onmouseover="this.style.background='rgba(255,215,0,0.15)'; this.style.borderColor='rgba(255,215,0,0.4)'; this.style.color='#1a1a1a';" onmouseout="this.style.background='rgba(0,0,0,0.05)'; this.style.borderColor='rgba(0,0,0,0.08)'; this.style.color='#666';">
                <i data-lucide="share-2" style="width:18px;height:18px;"></i>
                <span>Share my Lunch</span>
              </button>
            </div>
          </div>
          
          <!-- Trenner -->
          <div id="favProviderSeparator" style="height:32px; border-bottom:1px solid rgba(0,0,0,0.05); margin-bottom:32px;"></div>
          
          <!-- 2. Anbieter-Favoriten (Grayscale + Text wenn kein Angebot heute) -->
          <div id="sectionProvidersWrapper">
            <div class="section-title" id="sectionProviders" style="margin-bottom:16px; font-size:18px; font-weight:800; color:#1a1a1a;">Deine Lieblings-Anbieter heute</div>
            <div id="favProviders" style="display:flex; flex-direction:column; gap:12px;"></div>
            <div class="hint" id="emptyFavProviders" style="display:none;"></div>
          </div>
          
          <!-- Pull-to-Reveal: NÃ¤chste Tage erst nach Nach-unten-ziehen sichtbar -->
          <div id="favPullHint" style="display:none; text-align:center; padding:16px; margin-top:24px; font-size:13px; color:#999; font-weight:500;">
            Nach unten ziehen fÃ¼r Morgen &amp; Ãœbermorgen
          </div>
          <div id="favUpcomingPreview" style="margin-top:16px; display:none; opacity:0; transition:opacity 0.3s ease;">
            <div class="section-title" style="margin-bottom:16px; font-size:18px; font-weight:800; color:#1a1a1a;">Morgen &amp; Ãœbermorgen</div>
            <div id="favUpcomingDays" style="display:flex; flex-direction:column; gap:16px;"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- CUSTOMER: Orders -->
    <section class="view customer-view" id="v-orders">
      <div class="panel">
        <h3>Aktive Abholnummern</h3>
        <div class="hint">Deine aktiven Abholnummern</div>
        <div class="answers" id="ordersFilters" style="margin-top:12px;"></div>
        <div style="height:10px"></div>
        <div id="ordersList" class="hint">Noch keine Bestellungen.</div>
      </div>
    </section>

    <!-- CUSTOMER: Cart -->
    <section class="view customer-view" id="v-cart">
      <div style="padding:16px; padding-bottom:calc(90px + env(safe-area-inset-bottom, 0px));">
        <!-- Aktive Abholnummern (Wallet-Look) -->
        <div class="panel" id="cartActiveAbholnummern" style="margin-bottom:16px; padding:20px; display:none; border-radius:24px; box-shadow:0 4px 16px rgba(0,0,0,.08); background:rgba(255,255,255,0.98); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); border:2px dashed rgba(255,184,0,0.3); position:relative;">
          <h3 style="font-weight:900; font-size:22px; margin:0 0 20px; line-height:1.3; color:#2D3436; display:flex; align-items:center; gap:10px;">
            <span style="font-size:28px;">ðŸ§¾</span>
            <span>Aktive Abholnummern</span>
          </h3>
          <div id="cartActiveAbholnummernList" style="display:flex; flex-direction:column; gap:16px;"></div>
        </div>
        
        <!-- Warenkorb -->
        <div class="panel" style="padding:20px; border-radius:24px; box-shadow:0 4px 16px rgba(0,0,0,.08); background:rgba(255,255,255,0.95); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);">
          <h3 style="font-weight:900; font-size:24px; margin:0 0 20px; line-height:1.3; color:#2D3436;">Meine Mittagsbox</h3>
          
          <!-- Verzehrart-Auswahl (Header-Bereich) -->
          <div id="cartVerzehrart" style="margin-bottom:20px;">
            <label style="display:block; font-weight:700; font-size:15px; margin-bottom:12px; color:#2D3436;">Wo mÃ¶chtest du essen?</label>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
              <button type="button" id="cartBtnVorOrt" class="verzehrmodus-cart-btn" data-mode="vor_ort" style="padding:14px 16px; border-radius:14px; border:2px solid #e7e1d5; background:#fff; color:#666; font-weight:600; font-size:15px; cursor:pointer; transition:all 0.2s ease;">ðŸ´ Vor Ort essen</button>
              <button type="button" id="cartBtnMitnehmen" class="verzehrmodus-cart-btn" data-mode="mitnehmen" style="padding:14px 16px; border-radius:14px; border:2px solid #e7e1d5; background:#fff; color:#666; font-weight:600; font-size:15px; cursor:pointer; transition:all 0.2s ease;">ðŸ”„ Mitnehmen</button>
            </div>
          </div>
          
          <div id="cartBox" class="hint">Deine Mittagsbox ist leer.</div>
          <button class="btn" id="btnCheckout" type="button" style="display:none; width:100%; min-height:56px; font-size:18px; font-weight:800; margin-top:24px; padding:0 16px; background:#FFD700; color:#334155; border:none; border-radius:16px; box-shadow:0 4px 16px rgba(255,215,0,0.25); align-items:center; justify-content:center; gap:8px;">
            <span style="font-size:22px;">ðŸ§¾</span>
            <span>Abholnummer jetzt sichern</span>
          </button>
          <div class="mini" id="cartNote" style="display:none; margin-top:12px; padding:12px; background:rgba(255,184,0,0.08); border-radius:12px; font-size:12px; color:#666; line-height:1.5; text-align:center;">
            Du erhÃ¤ltst deine Abholnummer direkt nach der BestÃ¤tigung.
          </div>
          <!-- Footer: Nur Abholnummer (SÃ¤ule 2) â€“ minimalistisch -->
          <div id="cartTrustIcons" style="display:none; margin-top:16px; padding:12px 0; border-top:1px solid rgba(0,0,0,.06); justify-content:center; align-items:center;">
            <div style="display:flex; align-items:center; justify-content:center; gap:10px;">
              <span style="font-size:22px;">ðŸ§¾</span>
              <span style="font-size:13px; color:#64748b; font-weight:600;">Deine Abholnummer wird sofort generiert</span>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- CUSTOMER: One-Page Checkout (Checkout-Turbo) -->
    <section class="view" id="v-checkout" style="min-height:100vh; background:var(--bg);">
      <div style="padding:16px; padding-bottom:calc(90px + env(safe-area-inset-bottom, 0px)); max-width:600px; margin:0 auto;">
        <div class="panel" style="padding:20px; border-radius:24px; box-shadow:0 4px 16px rgba(0,0,0,.08); background:rgba(255,255,255,0.95); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);">
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
            <button class="back-button" type="button" id="btnCheckoutBack" aria-label="ZurÃ¼ck" style="background:none; border:none; padding:8px; cursor:pointer;">
              <i data-lucide="arrow-left"></i>
            </button>
            <h3 style="margin:0; flex:1; font-weight:900; font-size:24px; color:#2D3436;">Zahlung</h3>
          </div>
          
          <!-- BestellÃ¼bersicht -->
          <div id="checkoutSummary" style="margin-bottom:16px; padding:16px; background:#f8f9fa; border-radius:16px;">
            <!-- Wird dynamisch befÃ¼llt -->
          </div>
          
          <!-- Verzehrart (Vor Ort / Mitnehmen) -->
          <div id="checkoutVerzehrart" style="margin-bottom:24px;">
            <label style="display:block; font-weight:700; font-size:15px; margin-bottom:12px; color:#2D3436;">Wo mÃ¶chtest du essen?</label>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
              <button type="button" id="checkoutBtnVorOrt" class="verzehrmodus-checkout-btn" data-mode="vor_ort" style="padding:14px 16px; border-radius:14px; border:2px solid #e7e1d5; background:#fff; color:#666; font-weight:600; font-size:15px; cursor:pointer; transition:all 0.2s ease;">ðŸ´ Vor Ort essen</button>
              <button type="button" id="checkoutBtnMitnehmen" class="verzehrmodus-checkout-btn" data-mode="mitnehmen" style="padding:14px 16px; border-radius:14px; border:2px solid #e7e1d5; background:#fff; color:#666; font-weight:600; font-size:15px; cursor:pointer; transition:all 0.2s ease;">ðŸ”„ Mitnehmen</button>
            </div>
          </div>
          <!-- Verpackung (nur bei Mitnehmen) â€“ SÃ¤ule 3 ðŸ”„ -->
          <div id="checkoutVerpackung" style="display:none; margin-bottom:24px;">
            <label style="display:block; font-weight:700; font-size:15px; margin-bottom:12px; color:#2D3436;">Verpackung</label>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <button type="button" id="checkoutBtnEigenerBehaeltner" class="verpackung-btn" data-verpackung="eigener_behaeltner" style="padding:12px 14px; border-radius:12px; border:2px solid #e7e1d5; background:#fff; color:#666; font-weight:600; font-size:14px; cursor:pointer; transition:all 0.2s ease; text-align:center;">Eigener BehÃ¤lter<br><span style="font-size:12px; font-weight:700; color:#27AE60;">0,00 â‚¬</span></button>
              <button type="button" id="checkoutBtnMehrweg" class="verpackung-btn" data-verpackung="mehrweg" style="padding:12px 14px; border-radius:12px; border:2px solid #e7e1d5; background:#fff; color:#666; font-weight:600; font-size:14px; cursor:pointer; transition:all 0.2s ease; text-align:center;">Mehrweg-System ðŸ”„<br><span style="font-size:12px; font-weight:700; color:#64748b;">Pfand/Aufpreis</span></button>
            </div>
          </div>
          <!-- Abholzeit-Auswahl (15-Minuten-Takt) -->
          <div style="margin-bottom:24px;">
            <label style="display:block; font-weight:700; font-size:15px; margin-bottom:12px; color:#2D3436;">Wann holst du dein Essen ab?</label>
            <div id="checkoutTimeSlots" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-bottom:12px;">
              <!-- Wird dynamisch befÃ¼llt -->
            </div>
            <button type="button" id="btnOtherTime" class="time-chip-alternative" style="width:100%; min-height:44px; margin-top:8px; background:#f0f0f0; border:2px dashed #e7e1d5; border-radius:12px; color:#666; font-size:14px; font-weight:600; cursor:pointer; transition:all 0.2s ease; display:flex; align-items:center; justify-content:center; gap:8px;" onmouseover="this.style.borderColor='#FFD700'; this.style.background='rgba(255,215,0,0.1)'; this.style.color='#334155';" onmouseout="this.style.borderColor='#e7e1d5'; this.style.background='#f0f0f0'; this.style.color='#666';">
              <i data-lucide="clock" style="width:18px;height:18px;"></i>
              <span>ðŸ•’ Andere Zeit</span>
            </button>
            <div id="customTimeInputWrapper" style="display:none; margin-top:15px; padding:15px; background:#fff9e6; border-radius:12px; text-align:center;">
              <input type="time" id="checkoutPickupTimeCustom" min="11:30" max="14:00" style="width:100%; padding:14px; border:2px solid #FFD700; border-radius:12px; font-size:18px; font-weight:700; background:#fff; text-align:center; margin-bottom:8px;" />
              <p class="hint" style="font-size:12px; color:#666; margin:0; line-height:1.5;">Bitte zwischen 11:30 und 14:00 Uhr wÃ¤hlen</p>
            </div>
            <input type="hidden" id="checkoutPickupTime" value="" />
          </div>
          
          <!-- Kontaktdaten (minimal) -->
          <div style="margin-bottom:24px;">
            <label style="display:block; font-weight:700; font-size:15px; margin-bottom:12px; color:#2D3436;">Name (fÃ¼r Abholung)</label>
            <input type="text" id="checkoutName" placeholder="Dein Name" style="width:100%; padding:14px; border:2px solid #e7e1d5; border-radius:12px; font-size:16px; background:#fff;" />
          </div>
          
          <div style="margin-bottom:24px;">
            <label style="display:block; font-weight:700; font-size:15px; margin-bottom:12px; color:#2D3436;">E-Mail (optional, fÃ¼r Beleg)</label>
            <input type="email" id="checkoutEmail" placeholder="email@beispiel.de" style="width:100%; padding:14px; border:2px solid #e7e1d5; border-radius:12px; font-size:16px; background:#fff;" />
          </div>
          
          <!-- Zahlungsmethoden -->
          <div style="margin-bottom:24px;">
            <label style="display:block; font-weight:700; font-size:15px; margin-bottom:12px; color:#2D3436;">Zahlungsart</label>
            <div id="checkoutPaymentMethods" style="display:flex; flex-direction:column; gap:12px;">
              <!-- Apple Pay / Google Pay Buttons (wenn verfÃ¼gbar) -->
              <button class="btn" type="button" id="btnApplePay" style="display:none; width:100%; min-height:56px; background:#000; color:#fff; border:none; border-radius:12px; font-size:16px; font-weight:700; margin-bottom:8px;">
                <span style="font-size:20px;">ðŸŽ</span> Apple Pay
              </button>
              <button class="btn" type="button" id="btnGooglePay" style="display:none; width:100%; min-height:56px; background:#4285F4; color:#fff; border:none; border-radius:12px; font-size:16px; font-weight:700; margin-bottom:8px;">
                <span style="font-size:20px;">G</span> Google Pay
              </button>
              <!-- Standard Zahlung -->
              <button class="btn" type="button" id="btnStandardPayment" style="width:100%; min-height:56px; background:#FFD700; color:#334155; border:none; border-radius:12px; font-size:16px; font-weight:800; box-shadow:0 4px 16px rgba(255,215,0,0.25);">
                <i data-lucide="credit-card"></i> <span>Mit Karte bezahlen</span>
              </button>
            </div>
          </div>
          
          <!-- Guest-Checkout Hinweis -->
          <div style="padding:16px; background:rgba(255,184,0,0.08); border-radius:12px; font-size:13px; color:#666; line-height:1.5; text-align:center; margin-top:20px;">
            Kein Account nÃ¶tig. Nach dem Kauf kannst du optional ein Passwort festlegen, um Belege zu speichern.
          </div>
        </div>
      </div>
    </section>

    <!-- CUSTOMER: Pickup Code (Dynamisch generiert) -->
    <div id="pickupCodeContainer"></div>

    <!-- CUSTOMER: AbholBestÃ¤tigung (Success-View nach Zahlung) -->
    <section class="view customer-view" id="v-order-success" style="display:none; padding:24px 16px calc(90px + env(safe-area-inset-bottom, 0px)); min-height:100vh; background:var(--bg);">
      <div class="panel" style="padding:28px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,.06); background:#fff; border:1px solid rgba(0,0,0,.02); max-width:420px; margin:0 auto;">
        <div style="text-align:center; margin-bottom:24px;">
          <span style="font-size:48px;">ðŸ§¾</span>
          <h2 style="font-family:'Nunito',sans-serif; font-weight:800; font-size:20px; margin:16px 0 8px; color:#1a1a1a;">Zahlung erfolgreich</h2>
          <p class="hint" style="font-size:14px; color:#64748b; margin:0;">Zeige diese Nummer beim Abholen vor.</p>
        </div>
        <div style="text-align:center; padding:20px; background:rgba(255,215,0,0.12); border-radius:16px; border:2px solid rgba(255,215,0,0.3); margin-bottom:24px;">
          <div style="font-size:13px; font-weight:700; color:#64748b; margin-bottom:6px;">Deine Nummer</div>
          <div id="orderSuccessAbholnummer" style="font-family:monospace; font-size:32px; font-weight:900; letter-spacing:4px; color:#1a1a1a;">#1A</div>
        </div>
        <div id="orderSuccessSummary" style="display:flex; flex-direction:column; gap:12px; margin-bottom:24px;">
          <div id="orderSuccessZeit" style="display:flex; align-items:center; gap:10px; padding:12px 16px; background:#f8f9fa; border-radius:12px; font-size:15px; font-weight:600; color:#334155;"><span style="font-size:20px;">ðŸ•’</span> Abholung um 12:15 Uhr</div>
          <div id="orderSuccessModus" style="display:flex; align-items:center; gap:10px; padding:12px 16px; background:#f8f9fa; border-radius:12px; font-size:15px; font-weight:600; color:#334155;"><span style="font-size:20px;">ðŸ´</span> Vor Ort essen</div>
          <div id="orderSuccessVerpackung" style="display:none; align-items:center; gap:10px; padding:12px 16px; background:#f8f9fa; border-radius:12px; font-size:15px; font-weight:600; color:#334155;"><span style="font-size:20px;">ðŸ”„</span> Mehrweg-System</div>
        </div>
        <p class="hint" style="text-align:center; font-size:13px; color:#94a3b8; margin:0 0 24px;">Der Anbieter wurde informiert und bereitet deine Bestellung vor.</p>
        <button type="button" id="btnOrderSuccessDone" style="width:100%; min-height:52px; padding:0 20px; border-radius:16px; border:none; background:#FFD700; color:#1a1a1a; font-weight:800; font-size:16px; cursor:pointer; box-shadow:0 4px 0 0 #d1b600;">Erledigt</button>
      </div>
    </section>

    <!-- CUSTOMER: Profile "Meins" â€“ UI-Restore: Abholnummer, Bestellungen, Profil, PrÃ¤ferenzen, FAQ, Footer -->
    <section class="view customer-view" id="v-profile" style="padding:0 16px 100px;">
      <!-- Header (Logo & Nutzer-Avatar) â€“ IdentitÃ¤t -->
      <div class="panel profile-panel" id="profileHeaderCard" style="margin-top:0; padding:20px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,.06); background:#fff; border:1px solid rgba(0,0,0,.02);">
        <!-- Wird dynamisch befÃ¼llt -->
      </div>

      <!-- 1. Aktive Abholnummer (kompakte Kachel ðŸ§¾) -->
      <div class="panel profile-panel" id="profileAbholnummerSection" style="margin-top:16px; padding:18px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,.06); border:1px solid rgba(0,0,0,.02); display:none;">
        <div style="font-weight:800; font-size:15px; margin-bottom:12px; color:#1a1a1a; display:flex; align-items:center; gap:8px;">
          <span style="font-size:18px;">ðŸ§¾</span>
          <span>Aktive Abholnummer</span>
        </div>
        <div id="profileActiveAbholnummernList" style="display:flex; flex-direction:column; gap:10px;"></div>
      </div>

      <!-- 2. Meine Bestellungen (aufgewertete Historie: Thumbnail, Name, Anbieter, Datum, Preis, Pills) -->
      <div class="panel profile-panel" id="profileOrderHistorySection" style="margin-top:16px; padding:18px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,.06); border:1px solid rgba(0,0,0,.02);">
        <div style="font-family:'Nunito',sans-serif; font-weight:800; font-size:16px; margin-bottom:14px; color:#1a1a1a;">Meine Bestellungen</div>
        <div id="profileOrderHistoryList" style="display:flex; flex-direction:column; gap:0;"></div>
        <div id="profileOrderHistoryMore" style="display:none;"></div>
        <button type="button" id="btnProfileShowAllOrders" style="display:none; width:100%; margin-top:12px; padding:12px 16px; border-radius:12px; border:2px solid rgba(0,0,0,.08); background:#fff; color:#64748b; font-weight:700; font-size:14px; cursor:pointer;">Alle Bestellungen anzeigen</button>
      </div>

      <!-- 3. Profildaten (Name, E-Mail) â€“ sauberer Block -->
      <div class="panel profile-panel" id="profileVerwaltungSection" style="margin-top:16px; padding:18px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,.06); border:1px solid rgba(0,0,0,.02);">
        <div style="font-family:'Nunito',sans-serif; font-weight:800; font-size:16px; margin-bottom:12px; color:#1a1a1a;">Profildaten</div>
        <div id="profileVerwaltungContent" style="font-size:14px; color:#334155; line-height:1.6;">Name und E-Mail â€“ wird dynamisch befÃ¼llt.</div>
      </div>

      <!-- 4. Einstellungen: Mein Geschmack & Mehrweg (ðŸ”„) â€“ ohne ErklÃ¤rungstext -->
      <div class="panel profile-panel" id="profileTasteSection" style="margin-top:16px; padding:18px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,.06); border:1px solid rgba(0,0,0,.02);">
        <div style="font-family:'Nunito',sans-serif; font-weight:800; font-size:16px; margin-bottom:12px; color:#1a1a1a;">Einstellungen</div>
        <div style="font-weight:700; font-size:15px; margin-bottom:8px; color:#64748b;">Mein Geschmack</div>
        <div id="profileDietSwitches" style="display:flex; flex-direction:column; gap:10px;"></div>
        <div id="profileReuseSwitch" style="margin-top:14px;"></div>
      </div>

      <!-- 5. Die 3 Top-FAQs (Abholnummer, Probleme, Mehrweg) â€“ einklappbar am Ende -->
      <div class="panel profile-panel" style="margin-top:16px; padding:18px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,.06); border:1px solid rgba(0,0,0,.02);">
        <div style="font-family:'Nunito',sans-serif; font-weight:800; font-size:16px; margin-bottom:12px; color:#1a1a1a;">HÃ¤ufige Fragen</div>
        <div id="profileTopFaq" class="profile-faq-accordion" style="display:flex; flex-direction:column; gap:8px;">
          <details style="background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.06); overflow:hidden;">
            <summary style="padding:12px 14px; font-size:14px; font-weight:600; color:#1a1a1a; cursor:pointer; list-style:none; display:flex; align-items:center; gap:8px;">
              <span style="font-size:18px;">ðŸ§¾</span> Wie funktioniert die Abholnummer?
            </summary>
            <p style="margin:0; padding:0 14px 14px 14px; font-size:14px; line-height:1.5; color:#555;">Deine Abholnummer ist dein digitaler Bon. Zeige sie nach der Bestellung einfach beim Anbieter vor Ort auf deinem Smartphone vor. Ein Ausdruck ist nicht nÃ¶tig.</p>
          </details>
          <details style="background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.06); overflow:hidden;">
            <summary style="padding:12px 14px; font-size:14px; font-weight:600; color:#1a1a1a; cursor:pointer; list-style:none; display:flex; align-items:center; gap:8px;">
              <span style="font-size:18px;">ðŸ´</span> Was mache ich bei Problemen vor Ort?
            </summary>
            <p style="margin:0; padding:0 14px 14px 14px; font-size:14px; line-height:1.5; color:#555;">Wende dich bitte direkt an das Personal des Anbieters. Deine Abholnummer ist dein Zahlungsbeleg. Bei technischen Fragen erreichst du uns Ã¼ber den Support-Link im Impressum.</p>
          </details>
          <details style="background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.06); overflow:hidden;">
            <summary style="padding:12px 14px; font-size:14px; font-weight:600; color:#1a1a1a; cursor:pointer; list-style:none; display:flex; align-items:center; gap:8px;">
              <span style="font-size:18px;">ðŸ”„</span> Wo finde ich Mehrweg-Optionen?
            </summary>
            <p style="margin:0; padding:0 14px 14px 14px; font-size:14px; line-height:1.5; color:#555;">Achte auf das ðŸ”„-Icon beim Gericht. Wir arbeiten stetig daran, weitere Partner fÃ¼r unser Mehrweg-System zu gewinnen. Aktuell fÃ¼hren noch nicht alle Anbieter Mehrweg; dir werden aber weiterhin alle verfÃ¼gbaren Angebote angezeigt.</p>
          </details>
        </div>
        <button type="button" onclick="showLegalPage('support'); return false;" style="width:100%; margin-top:12px; padding:14px 16px; border-radius:12px; border:2px solid var(--brand); background:#fff; color:var(--brand); font-weight:700; font-size:15px; cursor:pointer;">Weitere Fragen &amp; Hilfe</button>
      </div>

      <!-- Footer: eine Zeile Datenschutz | Impressum | AGB -->
      <div class="profile-footer" style="margin-top:28px; padding:0 16px 32px; border-top:2px solid rgba(0,0,0,.06);">
        <div style="display:flex; flex-wrap:wrap; justify-content:center; gap:6px 10px; font-size:14px; margin-bottom:16px;">
          <a href="#/datenschutz" id="btnProfileDatenschutz" onclick="showLegalPage('datenschutz'); return false;" style="color:var(--muted); text-decoration:none;">Datenschutz</a>
          <span style="color:rgba(0,0,0,.2);">|</span>
          <a href="#/impressum" id="btnProfileImpressum" onclick="showLegalPage('impressum'); return false;" style="color:var(--muted); text-decoration:none;">Impressum</a>
          <span style="color:rgba(0,0,0,.2);">|</span>
          <a href="#/agb-kurz" id="btnProfileAGB" onclick="showLegalPage('agb-kurz'); return false;" style="color:var(--muted); text-decoration:none;">AGB</a>
        </div>
        <!-- Anbieter-Integration (Business-Modul) -->
        <div class="panel" id="profileProviderSection" style="margin-bottom:16px; padding:18px; border-radius:16px; background:#e8e8e8; border:1px solid rgba(0,0,0,.06);">
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;"><span style="font-size:20px;">ðŸ’¼</span><span style="font-weight:700; font-size:15px; color:#334155;">Dein Mittagessen anbieten</span></div>
          <p style="font-size:14px; color:#555; margin:0 0 14px; line-height:1.5;">Einfach und digital.</p>
          <button type="button" id="btnProfileProviderLogin" onclick="setMode('provider');" style="width:100%; min-height:48px; padding:12px 20px; border-radius:14px; border:none; background:#6b7280; color:#fff; font-weight:700; font-size:15px; cursor:pointer;" onmouseover="this.style.background='#4b5563';" onmouseout="this.style.background='#6b7280';">
            Zum Anbieter-Login
          </button>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
          <span style="font-size:12px; color:var(--muted);">made with â¤ï¸ by mittagio.de</span>
          <a href="#/version" id="linkVersion" style="font-size:11px; color:var(--muted); text-decoration:none;">v1.0.x</a>
        </div>
      </div>
    </section>

    <!-- PROVIDER: Login-Seite (E-Mail + Passwort), danach Dashboard oder Onboarding -->
    <section class="view" id="v-provider-login">
      <div class="panel">
        <h3>Anbieter-Login</h3>
        <div class="hint">Melde dich als Gastronom an</div>
        <input class="field" id="provEmail" type="email" placeholder="E-Mail-Adresse" autocomplete="email" style="margin-top:12px;" />
        <div style="height:10px"></div>
        <input class="field" id="provPass" type="password" placeholder="Passwort" autocomplete="current-password" />
        <button class="btn" type="button" id="btnProvLogin" style="margin-top:16px; background:#6b7280; color:#fff; border:none; transition:all 0.2s ease;" onmouseover="this.style.background='#4b5563';" onmouseout="this.style.background='#6b7280';">Einloggen</button>
        <button class="btn secondary" type="button" id="btnProvBack" style="margin-top:8px;">ZurÃ¼ck</button>
        <p class="hint" style="margin-top:12px;">Demo: beliebige E-Mail/Passwort -> du bist drin. (SpÃ¤ter: Firebase Auth.)</p>
      </div>
    </section>

    <!-- PROVIDER: Onboarding (ALT) -->
    <section class="view" id="v-provider-onboarding" style="display:none;">
      <!-- Schritt 1: Betriebsname -->
      <div class="panel onboarding-step" data-step="1">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 1 von 5</div>
          <button class="btn ghost" type="button" id="btnOnboardingBack" style="width:auto; padding:8px 12px; margin-top:8px;">
            â† ZurÃ¼ck
          </button>
        </div>
        <h3 style="margin-top:16px;">Wie heiÃŸt dein Betrieb?</h3>
        <div class="hint">Gib den Namen deines Restaurants, CafÃ©s oder Betriebs ein.</div>
        <input class="field" id="onboardingBusinessNameOld" type="text" placeholder="z.B. CafÃ© Sonnenschein" style="margin-top:12px;" />
        <button class="btn" type="button" id="btnOnboardingStep1Next" style="margin-top:16px;">Weiter</button>
      </div>

      <!-- Schritt 2: Adresse -->
      <div class="panel onboarding-step" data-step="2" style="display:none;">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 2 von 5</div>
          <button class="btn ghost" type="button" id="btnOnboardingStep2Back" style="width:auto; padding:8px 12px; margin-top:8px;">
            â† ZurÃ¼ck
          </button>
        </div>
        <h3 style="margin-top:16px;">Adresse deines Betriebs</h3>
        <div class="hint">Wo kÃ¶nnen GÃ¤ste dein Essen abholen?</div>
        <div class="loc-row" style="margin-top:12px;">
          <input class="field" id="onboardingAddress" type="text" placeholder="StraÃŸe und Hausnummer" />
          <button class="pin-btn" type="button" id="btnOnboardingLocationPin" aria-label="Standort setzen"></button>
        </div>
        <input class="field" id="onboardingPostalCode" type="text" placeholder="PLZ" style="margin-top:10px;" />
        <input class="field" id="onboardingCity" type="text" placeholder="Stadt" style="margin-top:10px;" />
        <button class="btn" type="button" id="btnOnboardingStep2Next" style="margin-top:16px;">Weiter</button>
      </div>

      <!-- Schritt 3: Essenszeit -->
      <div class="panel onboarding-step" data-step="3" style="display:none;">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 3 von 5</div>
          <button class="btn ghost" type="button" id="btnOnboardingStep3Back" style="width:auto; padding:8px 12px; margin-top:8px;">
            â† ZurÃ¼ck
          </button>
        </div>
        <h3 style="margin-top:16px;">Wann kÃ¶nnen GÃ¤ste dein Essen genieÃŸen?</h3>
        <div class="hint">WÃ¤hle die Standard-Zeiten fÃ¼r deine Essensausgabe.</div>
        
        <div style="margin-top:16px;">
          <div class="hint" style="margin-bottom:6px;">Startzeit</div>
          <div class="w-actions">
            <button class="btn secondary time-btn" type="button" data-time="11:00">11:00</button>
            <button class="btn secondary time-btn" type="button" data-time="11:30">11:30</button>
            <button class="btn secondary time-btn" type="button" data-time="12:00">12:00</button>
            <button class="btn secondary time-btn" type="button" data-time="12:30">12:30</button>
          </div>
          <input class="field" id="onboardingMealStart" type="time" placeholder="Startzeit" style="margin-top:10px;" />
        </div>

        <div style="margin-top:16px;">
          <div class="hint" style="margin-bottom:6px;">Endzeit</div>
          <div class="w-actions">
            <button class="btn secondary time-btn" type="button" data-time="14:00">14:00</button>
            <button class="btn secondary time-btn" type="button" data-time="14:30">14:30</button>
            <button class="btn secondary time-btn" type="button" data-time="15:00">15:00</button>
            <button class="btn secondary time-btn" type="button" data-time="15:30">15:30</button>
          </div>
          <input class="field" id="onboardingMealEnd" type="time" placeholder="Endzeit" style="margin-top:10px;" />
        </div>

        <button class="btn" type="button" id="btnOnboardingStep3Next" style="margin-top:20px;">Weiter</button>
      </div>

      <!-- Schritt 4: Logo -->
      <div class="panel onboarding-step" data-step="4" style="display:none;">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 4 von 5</div>
          <button class="btn ghost" type="button" id="btnOnboardingStep4Back" style="width:auto; padding:8px 12px; margin-top:8px;">
            â† ZurÃ¼ck
          </button>
        </div>
        <h3 style="margin-top:16px;">Logo hochladen</h3>
        <div class="hint">Optional: Lade ein Logo fÃ¼r deinen Betrieb hoch. Du kannst das auch spÃ¤ter machen.</div>
        
        <div style="margin-top:20px; text-align:center;">
          <div class="onboarding-logo-preview" id="onboardingLogoPreview" style="width:120px; height:120px; margin:0 auto; border-radius:18px; border:2px dashed var(--border); background:#f8f7f3; display:flex; align-items:center; justify-content:center; cursor:pointer; position:relative; overflow:hidden;">
            <div style="text-align:center; color:var(--muted); font-size:12px;">
              <div style="font-size:32px; margin-bottom:8px;">ðŸ“·</div>
              <div>Logo hinzufÃ¼gen</div>
            </div>
            <img id="onboardingLogoImg" style="display:none; width:100%; height:100%; object-fit:cover;" />
          </div>
          <input type="file" id="onboardingLogoInput" accept="image/*" style="display:none;" />
          <button class="btn secondary" type="button" id="btnOnboardingLogoRemove" style="margin-top:12px; display:none;">Logo entfernen</button>
        </div>

        <button class="btn" type="button" id="btnOnboardingStep4Next" style="margin-top:20px;">Weiter</button>
        <button class="btn ghost" type="button" id="btnOnboardingSkipLogo" style="margin-top:8px;">Ãœberspringen</button>
      </div>

      <!-- Schritt 5: Zusammenfassung -->
      <div class="panel onboarding-step" data-step="5" style="display:none;">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 5 von 5</div>
        </div>
        <h3 style="margin-top:16px;">Profil ist bereit! ðŸŽ‰</h3>
        <div class="hint">Hier ist eine Zusammenfassung deiner Angaben:</div>
        
        <div class="onboarding-summary" style="margin-top:20px; padding:16px; background:#f8f7f3; border-radius:14px; border:1px solid var(--border);">
          <div class="onboarding-summary-item" style="margin-bottom:12px;">
            <div style="font-weight:900; font-size:14px;" id="summaryBusinessName">â€“</div>
            <div class="hint" id="summaryAddress" style="margin-top:4px;">â€“</div>
          </div>
          <div class="onboarding-summary-item" style="margin-bottom:12px;">
            <div class="hint" style="margin-bottom:4px;">Essenszeit</div>
            <div style="font-weight:900;" id="summaryMealTime">â€“</div>
          </div>
          <div class="onboarding-summary-item" id="summaryLogoContainer" style="display:none;">
            <div class="hint" style="margin-bottom:4px;">Logo</div>
            <div id="summaryLogo" style="width:60px; height:60px; border-radius:12px; overflow:hidden; border:1px solid var(--border);">
              <img id="summaryLogoImg" style="width:100%; height:100%; object-fit:cover;" />
            </div>
          </div>
        </div>

        <button class="btn" type="button" id="btnOnboardingComplete" style="margin-top:24px;">Erstes Gericht erstellen</button>
        <button class="btn secondary" type="button" id="btnOnboardingEdit" style="margin-top:8px;">Angaben bearbeiten</button>
      </div>
    </section>

    <!-- PROVIDER: Hybrid Onboarding -->
    <section class="view" id="v-provider-onboarding-entry" style="background:linear-gradient(135deg, #121826 0%, #1a1a1a 100%); min-height:100vh; padding:20px; position:relative;">
      <!-- Hero Video Loop (Full-Screen Background mit Overlay) -->
      <div style="position:absolute; top:0; left:0; right:0; bottom:0; z-index:0; overflow:hidden;">
        <div style="width:100%; height:100%; background:linear-gradient(135deg, #FFD700 0%, #FFD700 100%); display:flex; align-items:center; justify-content:center; position:relative;">
          <div style="position:absolute; inset:0; background:rgba(0,0,0,0.6); z-index:1;"></div>
          <div style="text-align:center; color:#fff; z-index:2; position:relative;">
            <div style="font-size:64px; margin-bottom:16px;">ðŸ‘†</div>
            <div style="font-size:18px; font-weight:900;">Nummer sehen â†’ Antippen â†’ Erledigt</div>
          </div>
          <!-- Video wÃ¼rde hier eingefÃ¼gt: <video autoplay loop muted playsinline style="width:100%; height:100%; object-fit:cover; position:absolute; inset:0; z-index:0;"></video> -->
        </div>
      </div>
      
      <!-- Content (Ã¼ber Background) -->
      <div style="position:relative; z-index:1;">
      
      <div class="panel" style="padding:32px; text-align:center; max-width:480px; margin:0 auto; background:rgba(255,255,255,0.95); border-radius:24px; box-shadow:0 8px 32px rgba(0,0,0,0.3);">
        <h1 style="font-size:32px; font-weight:900; margin-bottom:16px; line-height:1.2; color:#2D3436;">Verdiene Zeit an der Theke.</h1>
        <p style="font-size:18px; line-height:1.5; margin-bottom:32px; color:#666; font-weight:600;">
          Stell dein Tagesgericht online, bevor der Ansturm kommt. Kein Telefon-Stress, keine Zettelwirtschaft.
        </p>
        
        <!-- 3-Punkte-ErklÃ¤rung mit groÃŸen Icons (animiert) -->
        <div id="onboardingExplanationPoints" style="display:flex; flex-direction:column; gap:20px; margin-bottom:32px; text-align:left;">
          <div class="onboarding-point" style="display:flex; align-items:start; gap:16px; opacity:0; transform:translateY(20px); transition:opacity 0.6s ease-out, transform 0.6s ease-out;">
            <div style="width:64px; height:64px; border-radius:16px; background:rgba(255,184,0,0.15); display:flex; align-items:center; justify-content:center; flex-shrink:0;">
              <i data-lucide="shield" style="width:32px; height:32px; color:#FFD700;"></i>
            </div>
            <div style="flex:1;">
              <div style="font-size:18px; font-weight:900; margin-bottom:6px; color:#2D3436;">Tages-Angebot live schalten</div>
              <div style="font-size:14px; color:#666; line-height:1.5;">Fokus aufs Handwerk: Wir kÃ¼mmern uns um die Sichtbarkeit, du dich ums Essen.</div>
            </div>
          </div>
          
          <div class="onboarding-point" style="display:flex; align-items:start; gap:16px; opacity:0; transform:translateY(20px); transition:opacity 0.6s ease-out, transform 0.6s ease-out;">
            <div style="width:64px; height:64px; border-radius:16px; background:rgba(255,184,0,0.15); display:flex; align-items:center; justify-content:center; flex-shrink:0;">
              <i data-lucide="hand" style="width:32px; height:32px; color:#FFD700;"></i>
            </div>
            <div style="flex:1;">
              <div style="font-size:18px; font-weight:900; margin-bottom:6px; color:#2D3436;">Abholung per Fingertipp</div>
              <div style="font-size:14px; color:#666; line-height:1.5;">Kein Scannen, kein Warten. Einfach die Abholnummer auf dem Display antippen und fertig.</div>
            </div>
          </div>
          
          <div class="onboarding-point" style="display:flex; align-items:start; gap:16px; opacity:0; transform:translateY(20px); transition:opacity 0.6s ease-out, transform 0.6s ease-out;">
            <div style="width:64px; height:64px; border-radius:16px; background:rgba(255,184,0,0.15); display:flex; align-items:center; justify-content:center; flex-shrink:0;">
              <i data-lucide="timer" style="width:32px; height:32px; color:#FFD700;"></i>
            </div>
            <div style="flex:1;">
              <div style="font-size:18px; font-weight:900; margin-bottom:6px; color:#2D3436;">Zeit gewinnen & Umsatz steigern</div>
              <div style="font-size:14px; color:#666; line-height:1.5;">Planbarkeit: Du weiÃŸt morgens schon, wie viele Portionen du vorbereiten musst.</div>
            </div>
          </div>
        </div>
        
        <!-- Interaktiver Tap-Moment: Demo-Kachel "49C" -->
        <div id="onboardingTapDemo" style="margin-bottom:24px; text-align:center;">
          <div style="font-size:14px; font-weight:600; color:#666; margin-bottom:12px;">So einfach geht's:</div>
          <div id="demoPickupCode" style="display:inline-block; padding:20px 32px; background:#fff; border:3px solid #FFD700; border-radius:20px; font-size:48px; font-weight:900; color:#2D3436; cursor:pointer; transition:all 0.2s ease; box-shadow:0 4px 16px rgba(255,215,0,0.2);" onclick="triggerTapDemo()">
            49C
          </div>
          <div id="tapDemoMessage" style="display:none; margin-top:16px; padding:12px 20px; background:rgba(76,175,80,0.1); border-radius:12px; font-size:16px; font-weight:700; color:#4caf50; animation:slideUp 0.4s ease-out;">
            So einfach gewinnst du Zeit! âš¡
          </div>
        </div>
        
        <!-- Badge: Garantiert ohne IT-Vorkenntnisse -->
        <div style="padding:12px 20px; background:rgba(46,125,50,0.12); border-radius:12px; margin-bottom:24px; display:inline-block;">
          <div style="font-size:14px; font-weight:700; color:#2e7d32;">âœ“ Garantiert ohne IT-Vorkenntnisse bedienbar</div>
        </div>
        
        <button class="btn-primary" type="button" id="btnOnboardingEntryStart" style="width:100%; min-height:64px; background:#FFD700; color:#111; font-weight:900; font-size:18px; border:none; border-radius:24px; box-shadow:0 25px 50px -12px rgba(255, 215, 0, 0.25); margin-bottom:12px; transition:transform 0.1s ease;">
          JETZT MEINE KÃœCHE ERÃ–FFNEN
        </button>
        <button class="btn secondary" type="button" id="btnOnboardingEntryLater" style="width:100%; min-height:52px; background:transparent; color:#666; border:2px solid #e7e1d5; border-radius:16px;">
          SpÃ¤ter starten
        </button>
        <div style="margin-top:24px; font-size:13px; color:#666; line-height:1.5;">
          <div style="font-weight:700; margin-bottom:4px;">InseratsgebÃ¼hr: 4,99 â‚¬. All-In ErfolgsgebÃ¼hr: 0,89 â‚¬. In 2 Minuten online.</div>
          <div>Inklusive automatischer Abrechnung & bezahlter BankgebÃ¼hren.</div>
        </div>
      </div>
    </section>

    <section class="view" id="v-provider-onboarding-first-dish">
      <div class="panel" style="padding:20px; padding-bottom:120px;">
        <h2 style="font-size:20px; font-weight:900; margin-bottom:20px;">Erstes Gericht anlegen</h2>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">Gerichtname *</label>
          <input class="field" type="text" id="onboardingDishName" placeholder="z.B. KÃ¼rbissuppe" required />
        </div>

        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">Preis (â‚¬) *</label>
          <input class="field" type="number" id="onboardingDishPrice" placeholder="z.B. 8,50" step="0.10" inputmode="decimal" required />
        </div>

        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">Kategorie *</label>
          <div style="display:flex; gap:8px;">
            <label class="radio-pill">
              <input type="radio" name="dishDiet" value="Fleisch" required>
              <span>Fleisch</span>
            </label>
            <label class="radio-pill">
              <input type="radio" name="dishDiet" value="Vegetarisch">
              <span>Veggie</span>
            </label>
            <label class="radio-pill">
              <input type="radio" name="dishDiet" value="Vegan">
              <span>Vegan</span>
            </label>
          </div>
          <style>
            .radio-pill input { display:none; }
            .radio-pill span {
              display:inline-block; padding:8px 16px; border-radius:20px;
              background:#f0f0f0; color:#333; font-weight:600; font-size:14px;
              border:1px solid transparent; cursor:pointer; transition:all 0.2s;
            }
            .radio-pill input:checked + span {
              background:#FFD700; color:#000; border-color:#e6c200;
              box-shadow:0 2px 4px rgba(0,0,0,0.1);
            }
          </style>
        </div>

        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">Beschreibung <span style="font-weight:400; color:#666;">(optional)</span></label>
          <textarea class="field" id="onboardingDishDesc" rows="3" placeholder="z.B. mit frischen KrÃ¤utern und Croutons" style="resize:none;"></textarea>
        </div>
        
        <div style="display:flex; gap:12px; margin-bottom:16px;">
          <div style="flex:1;">
            <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">Abholzeit von *</label>
            <input class="field" type="time" id="onboardingPickupTimeStart" required />
          </div>
          <div style="flex:1;">
            <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">bis *</label>
            <input class="field" type="time" id="onboardingPickupTimeEnd" required />
          </div>
        </div>
        
        <div style="margin-bottom:24px;">
          <div style="display:flex; gap:12px; margin-bottom:12px;">
            <button class="btn secondary" type="button" id="btnOnboardingAddPhoto" style="flex:1; min-height:52px; background:#FFD700; color:#334155; font-weight:700; border:none;">
              <i data-lucide="camera"></i><span>Foto aufnehmen</span>
            </button>
            <button class="btn secondary" type="button" id="btnOnboardingChooseProPhoto" style="flex:1; min-height:52px; background:#2d2d2d; color:#fff; font-weight:700; border:none;">
              <i data-lucide="image"></i><span>Aus Profi-Galerie</span>
            </button>
          </div>
          <div id="onboardingPhotoPreview" style="display:none; margin-top:12px; position:relative;">
            <img id="onboardingPhotoPreviewImg" style="width:100%; max-height:200px; object-fit:cover; border-radius:12px;" />
            <div id="onboardingPhotoWatermark" style="display:none; position:absolute; bottom:8px; left:8px; right:8px; background:rgba(0,0,0,0.7); color:#fff; padding:6px 12px; border-radius:8px; font-size:11px; text-align:center;">
              Serviervorschlag â€“ Original weicht ab
            </div>
          </div>
        </div>
        
        <!-- Profi-Galerie Modal -->
        <div class="backdrop" id="proPhotoBd" onclick="closeProPhotoGallery()" style="display:none;"></div>
        <div class="sheet" id="proPhotoSheet" style="max-width:600px; max-height:80vh; overflow:hidden; display:flex; flex-direction:column;">
          <div style="padding:20px; border-bottom:1px solid var(--border);">
            <h3 style="margin:0; font-size:20px; font-weight:900;">Profi-Galerie</h3>
            <p style="margin:8px 0 0; font-size:14px; color:#666;">WÃ¤hle ein hochwertiges Stock-Foto aus</p>
          </div>
          
          <!-- Kategorien-Tabs -->
          <div style="display:flex; gap:8px; padding:16px; border-bottom:1px solid var(--border); overflow-x:auto; scrollbar-width:none;">
            <button class="pro-photo-category-tab active" data-category="all" style="padding:8px 16px; border-radius:12px; background:#FFD700; color:#334155; font-weight:700; border:none; white-space:nowrap;">Alle</button>
            <button class="pro-photo-category-tab" data-category="klassiker" style="padding:8px 16px; border-radius:12px; background:#f5f5f5; color:#666; font-weight:600; border:none; white-space:nowrap;">Klassiker</button>
            <button class="pro-photo-category-tab" data-category="deftig" style="padding:8px 16px; border-radius:12px; background:#f5f5f5; color:#666; font-weight:600; border:none; white-space:nowrap;">Deftig</button>
            <button class="pro-photo-category-tab" data-category="eintoepfe" style="padding:8px 16px; border-radius:12px; background:#f5f5f5; color:#666; font-weight:600; border:none; white-space:nowrap;">EintÃ¶pfe</button>
            <button class="pro-photo-category-tab" data-category="modern" style="padding:8px 16px; border-radius:12px; background:#f5f5f5; color:#666; font-weight:600; border:none; white-space:nowrap;">Modern</button>
          </div>
          
          <!-- Zuletzt genutzt -->
          <div id="proPhotoRecent" style="padding:16px; border-bottom:1px solid var(--border); display:none;">
            <div style="font-size:14px; font-weight:700; margin-bottom:12px; color:#666;">Zuletzt genutzt</div>
            <div id="proPhotoRecentGrid" style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px;">
              <!-- Wird dynamisch befÃ¼llt -->
            </div>
          </div>
          
          <!-- Galerie-Grid -->
          <div style="flex:1; overflow-y:auto; padding:16px;">
            <div id="proPhotoGrid" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px;">
              <!-- Wird dynamisch befÃ¼llt -->
            </div>
          </div>
        </div>
        
        <div style="display:flex; gap:12px;">
          <button class="btn secondary" type="button" id="btnOnboardingFirstDishBack" style="flex:1; min-height:44px;">
            ZurÃ¼ck
          </button>
          <button class="btn-primary" type="button" id="btnOnboardingFirstDishNext" style="flex:1; min-height:56px;">
            Weiter
          </button>
        </div>
      </div>
    </section>

    <section class="view" id="v-provider-onboarding-signup">
      <div class="panel" style="padding:20px; padding-bottom:120px;">
        <h2 style="font-size:20px; font-weight:900; margin-bottom:8px;">Speichern & weitermachen</h2>
        <p style="font-size:14px; line-height:1.5; margin-bottom:24px; color:rgba(0,0,0,0.5);">
          Erstelle ein Konto, um dein Gericht zu speichern.
        </p>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">E-Mail *</label>
          <input class="field" type="email" id="onboardingEmail" placeholder="deine@email.de" required autocomplete="email" />
        </div>
        
        <div style="margin-bottom:24px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">Passwort *</label>
          <input class="field" type="password" id="onboardingPassword" placeholder="Mindestens 8 Zeichen" required autocomplete="new-password" />
        </div>
        
        <button class="btn-primary" type="button" id="btnOnboardingSignupCreate" style="width:100%; min-height:56px; margin-bottom:12px;">
          Konto erstellen
        </button>
        <button class="btn secondary" type="button" id="btnOnboardingSignupLater" style="width:100%; min-height:44px;">
          Ich habe schon ein Konto
        </button>
        
        <div style="margin-top:16px; font-size:12px; color:var(--muted); text-align:center;">
          InseratsgebÃ¼hr nur bei VerÃ¶ffentlichung Â· keine Mindestlaufzeit
        </div>
      </div>
    </section>

    <section class="view" id="v-provider-onboarding-business">
      <div class="panel" style="padding:20px;">
        <h2 style="font-size:20px; font-weight:900; margin-bottom:20px;">Dein Betrieb</h2>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">Betriebsname *</label>
          <input class="field" type="text" id="onboardingBusinessName" placeholder="z.B. CafÃ© Sonnenschein" required />
        </div>
        
        <div style="margin-bottom:24px;">
          <label style="display:block; font-size:14px; font-weight:600; margin-bottom:8px;">Stadt oder Adresse *</label>
          <input class="field" type="text" id="onboardingCityOrAddress" placeholder="z.B. Stuttgart oder HauptstraÃŸe 1, 70173 Stuttgart" required />
        </div>
        
        <div class="hint" style="font-size:13px; margin-bottom:24px; color:var(--muted);">
          Diese Angaben kannst du jederzeit Ã¤ndern.
        </div>
        
        <div style="display:flex; gap:12px;">
          <button class="btn secondary" type="button" id="btnOnboardingBusinessBack" style="flex:1; min-height:44px;">
            ZurÃ¼ck
          </button>
          <button class="btn-primary" type="button" id="btnOnboardingBusinessNext" style="flex:1; min-height:56px;">
            Weiter
          </button>
        </div>
      </div>
    </section>

    <section class="view" id="v-provider-onboarding-preview">
      <div class="panel" style="padding:20px;">
        <h2 style="font-size:20px; font-weight:900; margin-bottom:8px;">So sehen Kunden dein Gericht</h2>
        <p style="font-size:14px; line-height:1.5; margin-bottom:20px; color:var(--muted);">
          So erscheint dein Gericht spÃ¤ter fÃ¼r Kunden.
        </p>
        
        <div style="margin-bottom:20px; padding:12px; background:#f0f7f0; border-radius:12px; border:1px solid #4caf50;">
          <div style="font-weight:600; font-size:13px; color:#2e7d32; margin-bottom:4px;">Vorschau Â· noch nicht verÃ¶ffentlicht</div>
        </div>
        
        <div id="onboardingPreviewCard" style="margin-bottom:24px;">
          <!-- Wird dynamisch befÃ¼llt -->
        </div>
        
        <button class="btn-primary" type="button" id="btnOnboardingPreviewDashboard" style="width:100%; min-height:56px; margin-bottom:12px;">
          Weiter zum Dashboard
        </button>
        <button class="btn secondary" type="button" id="btnOnboardingPreviewEdit" style="width:100%; min-height:44px;">
          Gericht bearbeiten
        </button>
      </div>
    </section>

    <!-- PROVIDER APP - Dashboard 2.1 "Stolz & Performance" (#f8f7f2, klare Kennzahlen, 3 SÃ¤ulen Pills) -->
    <section class="view" id="v-provider-home" style="min-height:100vh; padding-bottom:120px; background:#f8f7f2;">
      
      <!-- 1. Header: Meine KÃ¼che & Kennzahlen -->
      <header style="background:#fff; padding:24px 20px; box-shadow:0 1px 3px rgba(0,0,0,0.06);">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:24px;">
          <span style="font-size:28px;">ðŸ”ª</span>
          <h1 style="margin:0; font-size:24px; font-weight:900; letter-spacing:-0.02em; color:#1a1a1a;">Meine KÃ¼che</h1>
        </div>
        <!-- Top Navigation / Archiv-Ãœbersicht: 3 Kennzahlen -->
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:0; margin-bottom:24px; border-bottom:1px solid #f1f1f1; padding-bottom:24px;">
          <div style="display:flex; flex-direction:column; align-items:center;">
            <span style="font-size:10px; font-weight:800; text-transform:uppercase; letter-spacing:0.1em; color:#9ca3af; margin-bottom:4px;">Tagesessen</span>
            <span id="dashboardTagesessenCount" style="font-size:24px; font-weight:900; color:#1a1a1a;">0</span>
          </div>
          <div style="display:flex; flex-direction:column; align-items:center; border-left:1px solid #f1f1f1; border-right:1px solid #f1f1f1;">
            <span style="font-size:10px; font-weight:800; text-transform:uppercase; letter-spacing:0.1em; color:#9ca3af; margin-bottom:4px;">Abholungen</span>
            <span id="dashboardAbholungenCount" style="font-size:24px; font-weight:900; color:#3b82f6;">0</span>
          </div>
          <div style="display:flex; flex-direction:column; align-items:center;">
            <span style="font-size:10px; font-weight:800; text-transform:uppercase; letter-spacing:0.1em; color:#9ca3af; margin-bottom:4px;">Kochbuch</span>
            <span id="dashboardKochbuchCount" style="font-size:24px; font-weight:900; color:#1a1a1a; opacity:0.4;">0</span>
          </div>
        </div>
        <!-- Finanzen: Umsatz heute (Netto nach GebÃ¼hren) -->
        <div style="display:flex; justify-content:space-between; align-items:center; padding:0 8px;">
          <span style="font-size:14px; font-weight:700; color:#9ca3af;">Mein Umsatz heute:</span>
          <div style="text-align:right;">
            <span id="dashboardUmsatzToday" style="font-size:24px; font-weight:900; color:#16a34a;">0,00 â‚¬</span>
            <p style="margin:4px 0 0; font-size:9px; font-weight:700; color:#9ca3af; text-transform:uppercase;">Netto nach GebÃ¼hren</p>
          </div>
        </div>
      </header>

      <!-- CTA: Jetzt inserieren (kompakt) -->
      <div style="padding:16px 20px;">
        <button type="button" id="btnProviderDashboardCTA" class="provider-dashboard-cta" style="width:100%; background:#ffde00; color:#1a1a1a; padding:16px 20px; border-radius:20px; border:none; box-shadow:0 4px 0 0 #d1b600; font-size:16px; font-weight:800; cursor:pointer; transition:transform 0.15s; display:flex; align-items:center; justify-content:center; gap:10px;">
          <span style="font-size:22px;">ï¼‹</span> JETZT FÃœR 4,99 â‚¬ INSERIEREN
        </button>
      </div>

      <div style="padding:0 20px 24px; max-width:28rem; margin:0 auto;">

        <!-- 2. Aktives Inserat: ImmoScout-Style (Bild + Live-Badge + Preis, Titel + Auge/Herz/Check, 3 SÃ¤ulen Pills) -->
        <section style="margin-bottom:24px;" id="providerActiveListingsSection">
          <div id="providerActiveListings" style="display:flex; flex-direction:column; gap:20px;"></div>
        </section>

        <!-- Quick-Info Leiste: Live Abholnummern (Referenz 97525) -->
        <section style="padding:16px; background:#fff; border-radius:16px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 1px 3px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04);">
          <span style="font-size:12px; font-weight:700; color:rgba(0,0,0,0.4); text-transform:uppercase;">Live Abholnummern</span>
          <div id="providerNextPickupPills" style="display:flex; gap:8px; overflow-x:auto; scrollbar-width:none;">
            <!-- Wird von renderProviderHome befÃ¼llt -->
          </div>
        </section>

        <!-- Quick Actions Grid - Light -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:24px;">
          <div id="kpiCardTagesessen" style="background:#fff; padding:16px; border-radius:20px; border:1px solid rgba(0,0,0,0.04); cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.03); transition:transform 0.1s;">
            <div style="width:40px; height:40px; background:rgba(255, 184, 0, 0.1); border-radius:12px; display:flex; align-items:center; justify-content:center; margin-bottom:12px;">
              <i data-lucide="utensils" style="color:#FFB800; width:20px; height:20px;"></i>
            </div>
            <div style="font-size:13px; font-weight:600; color:rgba(0,0,0,0.5); margin-bottom:4px;">Dein Tagesessen</div>
            <div id="kpiTagesessenDish" style="font-size:15px; font-weight:700; color:#1a1a1a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">â€“</div>
          </div>
          
          <div id="kpiCardKochbuch" style="background:#fff; padding:16px; border-radius:20px; border:1px solid rgba(0,0,0,0.04); cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.03); transition:transform 0.1s;">
            <div style="width:40px; height:40px; background:rgba(76, 175, 80, 0.1); border-radius:12px; display:flex; align-items:center; justify-content:center; margin-bottom:12px;">
              <i data-lucide="book-open" style="color:#4CAF50; width:20px; height:20px;"></i>
            </div>
            <div style="font-size:13px; font-weight:600; color:rgba(0,0,0,0.5); margin-bottom:4px;">Kochbuch</div>
            <div id="kpiKochbuchCount" style="font-size:15px; font-weight:700; color:#1a1a1a;">0 Gerichte</div>
          </div>
        </div>

        <!-- Wochenvorschau Section - Light -->
        <div style="margin-bottom:24px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding:0 4px;">
            <h3 style="font-size:18px; font-weight:800; color:#1a1a1a; margin:0;">Deine Woche</h3>
            <span style="font-size:13px; color:rgba(0,0,0,0.4); font-weight:500;">Planung</span>
          </div>
          
          <div style="background:#fff; border-radius:24px; padding:20px; border:1px solid rgba(0,0,0,0.04); box-shadow:0 2px 12px rgba(0,0,0,0.03);">
            <div class="dayrow" id="providerWeekDays" style="margin-bottom:16px; gap:8px; justify-content:space-between;"></div>
            <div id="providerWeekDayContent" style="min-height:80px; display:flex; align-items:center; justify-content:center; border:2px dashed rgba(0,0,0,0.08); border-radius:16px; color:rgba(0,0,0,0.3); font-size:14px; font-weight:500;">
              WÃ¤hle einen Tag
            </div>
          </div>
        </div>

        <!-- Empty State (Hidden by default) - Light -->
        <div id="providerEmptyDashboard" style="display:none; text-align:center; padding:40px 20px;">
          <div style="width:80px; height:80px; background:rgba(0,0,0,0.03); border-radius:50%; margin:0 auto 20px; display:flex; align-items:center; justify-content:center;">
            <i data-lucide="chef-hat" style="width:40px; height:40px; color:rgba(0,0,0,0.3);"></i>
          </div>
          <h3 style="font-size:20px; font-weight:800; color:#1a1a1a; margin-bottom:8px;">Willkommen!</h3>
          <p style="color:rgba(0,0,0,0.5); margin-bottom:24px;">Starte jetzt und erstelle dein erstes Gericht.</p>
          <button id="btnProviderEmptyAddDish" style="background:#FFD700; color:#000; border:none; padding:14px 24px; border-radius:14px; font-weight:700;">
            Erstes Gericht erstellen
          </button>
        </div>

      </div>

      <!-- FAB (Floating Action Button) -->
      <button class="fab" id="fabProviderAddOffer" type="button" aria-label="Gericht hinzufÃ¼gen" style="position:fixed; bottom:90px; right:16px; width:56px; height:56px; border-radius:28px; background:var(--brand); color:#111; border:none; box-shadow:0 4px 12px rgba(0,0,0,.2); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:900; z-index:20;">
        +
      </button>
      <div id="fabProviderAddOfferLabel" style="position:fixed; bottom:154px; right:16px; background:rgba(0,0,0,.8); color:#fff; padding:6px 12px; border-radius:8px; font-size:13px; white-space:nowrap; pointer-events:none; opacity:0; transition:opacity .2s; z-index:21;">
        + Inserat
      </div>
    </section>

    <section class="view" id="v-provider-pickups" style="background:#f4f4f4; min-height:100vh; padding-bottom:100px;">
      
      <!-- Modern Header (Light) -->
      <div style="background:rgba(255,255,255,0.98); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); position:sticky; top:0; z-index:50; border-bottom:1px solid rgba(0,0,0,0.06); padding:16px 20px; display:flex; align-items:center; justify-content:space-between;">
        <h1 style="margin:0; font-size:20px; font-weight:700; color:#1a1a1a;">Abholungen</h1>
        <div style="display:flex; gap:8px;">
          <button id="btnKitchenListPDF" style="background:rgba(0,0,0,0.05); border:none; width:36px; height:36px; border-radius:10px; display:flex; align-items:center; justify-content:center; color:#333;">
            <i data-lucide="file-text" style="width:18px; height:18px;"></i>
          </button>
          <button id="btnKitchenListEmail" style="background:rgba(0,0,0,0.05); border:none; width:36px; height:36px; border-radius:10px; display:flex; align-items:center; justify-content:center; color:#333;">
            <i data-lucide="mail" style="width:18px; height:18px;"></i>
          </button>
        </div>
      </div>

      <div style="padding:20px;">
        <!-- Subheader Status -->
        <div id="provPickupsSubheader" style="margin-bottom:20px; font-size:14px; color:rgba(0,0,0,0.6);">
          <!-- Wird dynamisch befÃ¼llt -->
        </div>
        
        <!-- Filter Toggle (Segmented Control Style - Light) -->
        <div class="answers" id="provPickupFilter" style="margin-bottom:24px; background:#fff; padding:4px; border-radius:12px; display:flex; border:1px solid rgba(0,0,0,0.06); box-shadow:0 2px 8px rgba(0,0,0,0.03);">
          <!-- Wird dynamisch befÃ¼llt -->
        </div>
        
        <!-- Empty States -->
        <div id="provPickupsEmpty" style="text-align:center; padding:60px 20px; display:none; color:rgba(0,0,0,0.5);">
          <!-- Wird dynamisch befÃ¼llt -->
        </div>
        
        <!-- Pickup Grid (Theken-Grid) -->
        <div id="provPickupsGrid" style="display:none; grid-template-columns:repeat(2, 1fr); gap:16px;">
          <!-- Wird dynamisch befÃ¼llt -->
        </div>
        
        <!-- Pickup List -->
        <div id="provPickupsList" style="display:none;">
          <!-- Wird dynamisch befÃ¼llt -->
        </div>
      </div>
    </section>

    <!-- Provider-Wochenplan: Modern Light Mode -->
    <section class="view" id="v-provider-week" style="background:#f4f4f4; min-height:100vh; padding:20px; padding-bottom:90px;">
      <!-- Sticky Header -->
      <div style="background:rgba(255,255,255,0.98); backdrop-filter:blur(20px); position:sticky; top:0; z-index:50; border-bottom:1px solid rgba(0,0,0,0.06); padding:16px 20px; margin:-20px -20px 24px; display:flex; align-items:center; justify-content:center;">
        <h1 style="margin:0; font-size:17px; font-weight:600; color:#1a1a1a;">Wochenplan</h1>
        <button id="btnWeekBack" class="btn ghost" type="button" style="position:absolute; left:10px; color:#0A84FF; font-size:16px; padding:8px; display:flex; align-items:center; gap:4px;">
          <i data-lucide="chevron-left" style="width:24px; height:24px;"></i> ZurÃ¼ck
        </button>
      </div>

      <div class="panel" style="background:#fff; border-radius:18px; padding:20px; border:1px solid rgba(0,0,0,0.05); box-shadow:0 4px 24px rgba(0,0,0,0.04);">
        <h3 style="color:#333; display:none;">Wochenplan</h3>
        <!-- Days Row -->
        <div class="dayrow" id="weekDays" style="padding:0 0 16px; max-width:none; border-bottom:1px solid rgba(0,0,0,0.06); margin-bottom:16px; gap:8px;"></div>
        
        <!-- Content List -->
        <div id="weekList" style="text-align:center; padding:40px 20px;">
          <div style="width:64px; height:64px; background:rgba(0,0,0,0.03); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 16px;">
            <i data-lucide="calendar" style="width:32px; height:32px; color:rgba(0,0,0,0.3);"></i>
          </div>
          <div style="font-weight:600; font-size:16px; margin-bottom:8px; color:#1a1a1a;">Keine Inserate geplant</div>
          <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:24px; color:rgba(0,0,0,0.5);">
            WÃ¤hle einen Tag, um Gerichte vorzuplanen.
          </div>
          <button class="btn secondary" type="button" id="btnWeekEmptyAdd" style="width:100%; min-height:48px; background:#FFD700; color:#000; font-weight:700; border-radius:12px; border:none;">
            Inserat hinzufÃ¼gen
          </button>
        </div>
        
        <!-- Actions -->
        <div style="display:flex; gap:12px; margin-top:24px; border-top:1px solid rgba(0,0,0,0.06); padding-top:20px;">
          <button class="btn secondary" type="button" id="btnWeekPdf" data-icon="print" style="display:none; flex:1; min-height:44px; background:rgba(0,0,0,0.05); border:none; color:#333; border-radius:12px; font-size:14px; font-weight:600;">PDF</button>
          <button class="btn secondary" type="button" id="btnWeekShare" data-icon="share-2" style="display:none; flex:1; min-height:44px; background:rgba(0,0,0,0.05); border:none; color:#333; border-radius:12px; font-size:14px; font-weight:600;">Teilen</button>
        </div>
      </div>
    </section>

    <!-- Kochbuch: Fixed Layout (Header + Suche | Card-System | Sticky CTA unten) -->
    <section class="view" id="v-provider-cookbook" style="background:#F5F5F5; min-height:100vh; padding:20px; padding-bottom:100px;">
      <!-- Oben: Kontext + Suche (starres Raster) -->
      <div style="background:#fff; border-radius:0; border-bottom:1px solid rgba(0,0,0,0.06); padding:16px 20px; margin:-20px -20px 20px -20px;">
        <h1 style="margin:0 0 16px 0; font-size:18px; font-weight:700; color:#1a1a1a; font-family:system-ui,-apple-system,sans-serif;">Mein Kochbuch</h1>
        <div style="position:relative;">
          <i data-lucide="search" style="position:absolute; left:14px; top:50%; transform:translateY(-50%); color:rgba(0,0,0,0.4); width:18px; height:18px;"></i>
          <input class="field cookbook-search" id="cookbookSearch" type="text" placeholder="Suchenâ€¦" style="width:100%; min-height:48px; background:#F5F5F5; border:1px solid rgba(0,0,0,0.08); color:#1a1a1a; border-radius:12px; padding:12px 12px 12px 42px; font-size:16px; font-weight:500; font-family:system-ui,-apple-system,sans-serif;" />
        </div>
        <div style="display:flex; gap:10px; margin-top:12px; align-items:center;">
          <select id="cookbookSortSelect" style="min-height:48px; padding:0 14px; border-radius:12px; background:#F5F5F5; border:1px solid rgba(0,0,0,0.08); color:#334155; font-size:14px; font-weight:600; min-width:0; flex:1; appearance:none; background-image:url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2216%22 height=%2216%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23334155%22 stroke-width=%222%22><path d=%22m6 9 6 6 6-6%22/></svg>'); background-repeat:no-repeat; background-position:right 10px center; padding-right:32px;">
            <option value="recent">Zuletzt</option>
            <option value="alpha">Aâ€“Z</option>
            <option value="priceAsc">Preis â†‘</option>
            <option value="priceDesc">Preis â†“</option>
          </select>
        </div>
      </div>
      <!-- Tabs: Gerichte | EntwÃ¼rfe (Light Segmented Control) -->
      <div class="cookbook-tabs" id="cookbookTabs" role="tablist" style="display:flex; background:#fff; border-radius:12px; padding:4px; margin-bottom:20px; border:1px solid rgba(0,0,0,0.06); box-shadow:0 1px 3px rgba(0,0,0,0.04);"></div>
      <!-- Mitte: Card-System (Bild -> SÃ¤ulen -> Daten) -->
      <div id="cookbookList" class="cookbook-grid"></div>
      <!-- Unten: Sticky Action (primÃ¤rer Button fixiert) -->
      <div class="cookbook-sticky-cta" style="position:fixed; bottom:0; left:0; right:0; padding:12px 20px; padding-bottom:calc(12px + env(safe-area-inset-bottom, 0)); background:#fff; border-top:1px solid rgba(0,0,0,0.06); z-index:40;">
        <button class="btn cookbook-cta" type="button" id="btnCookbookAddSticky" style="width:100%; min-height:48px; background:#10b981; color:#fff; font-weight:800; font-size:16px; border:none; border-radius:14px; display:flex; align-items:center; justify-content:center; gap:10px; font-family:system-ui,-apple-system,sans-serif;">
          <i data-lucide="plus-circle" style="width:22px;height:22px;"></i>
          <span>Neues Gericht anlegen</span>
        </button>
      </div>
    </section>

    <!-- Kochbuch: Action-Sheet (Bearbeiten / In Wochenplan / LÃ¶schen) -->
    <div class="backdrop" id="cookbookActionSheetBd" style="display:none; background:rgba(0,0,0,0.5);" onclick="closeCookbookActionSheet()"></div>
    <div class="cookbook-action-sheet" id="cookbookActionSheet" style="display:none;">
      <div class="cookbook-action-sheet-handle"></div>
      <div class="cookbook-action-sheet-title" id="cookbookActionSheetTitle">Gericht</div>
      <button type="button" class="cookbook-action-sheet-btn" id="cookbookActionEdit"><i data-lucide="edit"></i> Bearbeiten</button>
      <button type="button" class="cookbook-action-sheet-btn" id="cookbookActionWeek"><i data-lucide="calendar"></i> In Wochenplan</button>
      <button type="button" class="cookbook-action-sheet-btn cookbook-action-sheet-btn-danger" id="cookbookActionDelete"><i data-lucide="trash-2"></i> LÃ¶schen</button>
      <button type="button" class="cookbook-action-sheet-btn" onclick="closeCookbookActionSheet()">Abbrechen</button>
    </div>

    <!-- Provider-Profil: Silicon Valley Design â€“ Progressive Disclosure (#F2F2F7, weiÃŸe Cards 16px) -->
    <section class="view" id="v-provider-profile" style="background:#F2F2F7; min-height:100vh; padding-bottom:100px;">
      
      <!-- Hauptseite: Mein Profil (MenÃ¼-Liste mit Chevron) -->
      <div id="providerProfileMain" style="display:block;">
        <header style="background:#fff; border-radius:16px; margin:20px; padding:28px 24px; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
          <div class="plogo" id="providerProfileLogo" style="width:88px; height:88px; border-radius:50%; margin:0 auto 16px; border:1px solid rgba(0,0,0,0.08); box-shadow:0 4px 12px rgba(0,0,0,0.06); background-size:cover; background-position:center; background-color:#e5e5ea;"></div>
          <h2 id="providerProfileName" style="margin:0 0 8px; font-size:22px; font-weight:800; color:#1a1a1a; text-align:center; letter-spacing:-0.5px;">Betriebsname</h2>
          <p style="margin:0; font-size:13px; color:#8e8e93; text-align:center;">Status: 1 aktive Sitzung</p>
        </header>

        <div style="margin:0 20px; background:#fff; border-radius:16px; overflow:hidden; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
          <button type="button" id="providerProfileRowBusiness" class="provider-profile-row" style="width:100%; display:flex; align-items:center; justify-content:space-between; padding:18px 20px; background:none; border:none; border-bottom:1px solid #f2f2f7; font-size:17px; font-weight:500; color:#1a1a1a; text-align:left; cursor:pointer;"><span>Betrieb &amp; Sicherheit</span><i data-lucide="chevron-right" style="width:20px; height:20px; color:#c7c7cc;"></i></button>
          <button type="button" id="providerProfileRowTimes" class="provider-profile-row" style="width:100%; display:flex; align-items:center; justify-content:space-between; padding:18px 20px; background:none; border:none; border-bottom:1px solid #f2f2f7; font-size:17px; font-weight:500; color:#1a1a1a; text-align:left; cursor:pointer;"><span>Voreinstellungen: Mittagszeiten</span><i data-lucide="chevron-right" style="width:20px; height:20px; color:#c7c7cc;"></i></button>
          <button type="button" id="providerProfileRowService" class="provider-profile-row" style="width:100%; display:flex; align-items:center; justify-content:space-between; padding:18px 20px; background:none; border:none; border-bottom:1px solid #f2f2f7; font-size:17px; font-weight:500; color:#1a1a1a; text-align:left; cursor:pointer;"><span>Voreinstellungen: Service-Optionen</span><i data-lucide="chevron-right" style="width:20px; height:20px; color:#c7c7cc;"></i></button>
          <button type="button" id="providerProfileRowPayment" class="provider-profile-row" style="width:100%; display:flex; align-items:center; justify-content:space-between; padding:18px 20px; background:none; border:none; border-bottom:1px solid #f2f2f7; font-size:17px; font-weight:500; color:#1a1a1a; text-align:left; cursor:pointer;"><span>Zahlung &amp; Abrechnung</span><i data-lucide="chevron-right" style="width:20px; height:20px; color:#c7c7cc;"></i></button>
          <button type="button" id="providerProfileRowFaq" class="provider-profile-row" style="width:100%; display:flex; align-items:center; justify-content:space-between; padding:18px 20px; background:none; border:none; font-size:17px; font-weight:500; color:#1a1a1a; text-align:left; cursor:pointer;"><span>FAQ &amp; Support</span><i data-lucide="chevron-right" style="width:20px; height:20px; color:#c7c7cc;"></i></button>
        </div>
        <p id="providerProfileAddress" style="margin:16px 20px 0; font-size:13px; color:#8e8e93; text-align:center;" aria-hidden="true"></p>
      </div>

      <!-- Sub-Seite: Betrieb & Sicherheit -->
      <div id="providerProfileSubBusiness" style="display:none; padding:0 20px 24px;">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;"><button type="button" id="providerProfileBackBusiness" aria-label="ZurÃ¼ck" style="width:40px; height:40px; border-radius:50%; background:#fff; border:none; box-shadow:0 2px 8px rgba(0,0,0,0.08); cursor:pointer; display:flex; align-items:center; justify-content:center;"><i data-lucide="chevron-left" style="width:22px; height:22px;"></i></button><h2 style="margin:0; font-size:20px; font-weight:700; color:#1a1a1a;">Betrieb &amp; Sicherheit</h2></div>
        <div style="background:#fff; border-radius:16px; padding:20px; margin-bottom:16px; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
          <h3 style="margin:0 0 16px; font-size:15px; font-weight:600; color:#1a1a1a;">Kontaktdaten</h3>
          <p style="margin:0 0 12px; font-size:13px; color:#8e8e93;">Werden ins Inserat Ã¼bernommen.</p>
          <div style="margin-bottom:14px;"><label style="display:block; font-size:13px; color:#8e8e93; margin-bottom:6px;">Telefon</label><input type="tel" id="providerProfilePhone" placeholder="z.B. 07181 12345" style="width:100%; padding:12px 14px; border:1px solid #e5e5ea; border-radius:10px; font-size:16px;"></div>
          <div style="margin-bottom:14px;"><label style="display:block; font-size:13px; color:#8e8e93; margin-bottom:6px;">E-Mail</label><input type="email" id="providerProfileEmail" placeholder="geschaeft@betrieb.de" style="width:100%; padding:12px 14px; border:1px solid #e5e5ea; border-radius:10px; font-size:16px;"></div>
          <div><label style="display:block; font-size:13px; color:#8e8e93; margin-bottom:6px;">Webseite</label><input type="url" id="providerProfileWebsite" placeholder="https://..." style="width:100%; padding:12px 14px; border:1px solid #e5e5ea; border-radius:10px; font-size:16px;"></div>
        </div>
        <div style="background:#fff; border-radius:16px; padding:20px; margin-bottom:16px; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
          <h3 style="margin:0 0 12px; font-size:15px; font-weight:600; color:#1a1a1a;">Sicherheit</h3>
          <a href="#" id="btnProviderChangeEmail" style="display:flex; justify-content:space-between; align-items:center; padding:14px 0; text-decoration:none; color:#007aff; font-size:16px;">E-Mail &amp; Passwort Ã¤ndern <i data-lucide="chevron-right" style="width:18px; height:18px; color:#c7c7cc;"></i></a>
        </div>
        <div style="background:#fff; border-radius:16px; padding:20px; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
          <button type="button" id="btnProviderDeleteAccount" style="width:100%; padding:14px; font-size:16px; font-weight:600; color:#ff3b30; background:none; border:none; cursor:pointer; border-radius:10px;">Account dauerhaft lÃ¶schen</button>
        </div>
      </div>

      <!-- Sub-Seite: Voreinstellungen Mittagszeiten (15-Min-Wheel) -->
      <div id="providerProfileSubTimes" style="display:none; padding:0 20px 24px;">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;"><button type="button" id="providerProfileBackTimes" aria-label="ZurÃ¼ck" style="width:40px; height:40px; border-radius:50%; background:#fff; border:none; box-shadow:0 2px 8px rgba(0,0,0,0.08); cursor:pointer;"><i data-lucide="chevron-left" style="width:22px; height:22px;"></i></button><h2 style="margin:0; font-size:20px; font-weight:700; color:#1a1a1a;">Mittagszeiten</h2></div>
        <div style="background:#fff; border-radius:16px; padding:20px; margin-bottom:16px; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
          <p style="margin:0 0 16px; font-size:14px; color:#8e8e93;">15-Minuten-Schritte. Wird als Standard in jedes neue Inserat geladen (&lt; 30s Flow).</p>
          <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
            <div style="flex:1; min-width:120px;"><label style="display:block; font-size:13px; color:#8e8e93; margin-bottom:8px;">Start</label><select id="providerMealStart" style="width:100%; padding:14px; border:1px solid #e5e5ea; border-radius:10px; font-size:16px; background:#fff;"></select></div>
            <span style="color:#8e8e93; font-weight:600;">â€“</span>
            <div style="flex:1; min-width:120px;"><label style="display:block; font-size:13px; color:#8e8e93; margin-bottom:8px;">Ende</label><select id="providerMealEnd" style="width:100%; padding:14px; border:1px solid #e5e5ea; border-radius:10px; font-size:16px; background:#fff;"></select></div>
          </div>
          <div style="margin-top:16px; font-size:14px; color:#1a1a1a; margin-bottom:8px;">An welchen Tagen?</div>
          <div id="providerLunchWeekdays" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
        </div>
      </div>

      <!-- Sub-Seite: Service-Optionen (3 SÃ¤ulen Toggles) -->
      <div id="providerProfileSubService" style="display:none; padding:0 20px 24px;">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;"><button type="button" id="providerProfileBackService" aria-label="ZurÃ¼ck" style="width:40px; height:40px; border-radius:50%; background:#fff; border:none; box-shadow:0 2px 8px rgba(0,0,0,0.08); cursor:pointer;"><i data-lucide="chevron-left" style="width:22px; height:22px;"></i></button><h2 style="margin:0; font-size:20px; font-weight:700; color:#1a1a1a;">Service-Optionen</h2></div>
        <div style="background:#fff; border-radius:16px; overflow:hidden; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
          <div style="padding:16px 20px; border-bottom:1px solid #f2f2f7; display:flex; justify-content:space-between; align-items:center;">
            <div style="display:flex; align-items:center; gap:12px;"><span style="font-size:22px;">ðŸ´</span><div><div style="font-weight:600; color:#1a1a1a; font-size:16px;">Vor Ort essen</div><div style="font-size:13px; color:#8e8e93;">Anbieter entscheidet, ob aktiv</div></div></div>
            <label class="toggle-switch"><input type="checkbox" id="providerDineInEnabled"><span class="toggle-slider"></span></label>
          </div>
          <div style="padding:16px 20px; border-bottom:1px solid #f2f2f7; display:flex; justify-content:space-between; align-items:center;">
            <div style="display:flex; align-items:center; gap:12px;"><span style="font-size:22px;">ðŸ”„</span><div><div style="font-weight:600; color:#1a1a1a; font-size:16px;">Mehrweg-System</div><div style="font-size:13px; color:#8e8e93;">Nachhaltigkeits-Anzeige</div></div></div>
            <label class="toggle-switch"><input type="checkbox" id="providerReuseEnabled"><span class="toggle-slider"></span></label>
          </div>
          <div style="padding:16px 20px; display:flex; justify-content:space-between; align-items:flex-start;">
            <div style="display:flex; align-items:center; gap:12px;"><span style="font-size:22px;">ðŸ§¾</span><div><div style="font-weight:600; color:#1a1a1a; font-size:16px;">Abholnummer</div><div style="font-size:13px; color:#8e8e93;">Optional + 0,89 â‚¬. StandardmÃ¤ÃŸig AUS.</div></div></div>
            <label class="toggle-switch"><input type="checkbox" id="providerAbholnummerEnabled"><span class="toggle-slider"></span></label>
          </div>
        </div>
      </div>

      <!-- Sub-Seite: Zahlung & Abrechnung -->
      <div id="providerProfileSubPayment" style="display:none; padding:0 20px 24px;">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;"><button type="button" id="providerProfileBackPayment" aria-label="ZurÃ¼ck" style="width:40px; height:40px; border-radius:50%; background:#fff; border:none; box-shadow:0 2px 8px rgba(0,0,0,0.08); cursor:pointer;"><i data-lucide="chevron-left" style="width:22px; height:22px;"></i></button><h2 style="margin:0; font-size:20px; font-weight:700; color:#1a1a1a;">Zahlung &amp; Abrechnung</h2></div>
        <div style="background:#fff; border-radius:16px; padding:20px; margin-bottom:16px; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
          <h3 style="margin:0 0 12px; font-size:15px; font-weight:600; color:#1a1a1a;">Meine Kontodaten</h3>
          <p style="margin:0 0 16px; font-size:14px; color:#8e8e93;">Verwaltung des Zahlungsmittels fÃ¼r InseratsgebÃ¼hren (4,99 â‚¬ Basis).</p>
          <button type="button" id="btnBilling" style="width:100%; padding:14px; font-size:16px; font-weight:600; color:#007aff; background:#f2f2f7; border:none; border-radius:10px; cursor:pointer;">Zahlungsmethode verwalten</button>
        </div>
        <div style="background:#fff; border-radius:16px; padding:20px; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
          <h3 style="margin:0 0 12px; font-size:15px; font-weight:600; color:#1a1a1a;">Meine Abrechnungen</h3>
          <p style="margin:0 0 16px; font-size:14px; color:#8e8e93;">Chronologische Liste mit PDF-Download fÃ¼r die Buchhaltung.</p>
          <button type="button" id="btnBillingArchive" style="width:100%; padding:14px; font-size:16px; font-weight:600; color:#007aff; background:none; border:none; cursor:pointer; display:flex; align-items:center; justify-content:space-between;">Abrechnungen &amp; Rechnungsarchiv <i data-lucide="chevron-right" style="width:18px; height:18px; color:#c7c7cc;"></i></button>
        </div>
      </div>

      <!-- Sub-Seite: FAQ & Support -->
      <div id="providerProfileSubFaq" style="display:none; padding:0 20px 24px;">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;"><button type="button" id="providerProfileBackFaq" aria-label="ZurÃ¼ck" style="width:40px; height:40px; border-radius:50%; background:#fff; border:none; box-shadow:0 2px 8px rgba(0,0,0,0.08); cursor:pointer;"><i data-lucide="chevron-left" style="width:22px; height:22px;"></i></button><h2 style="margin:0; font-size:20px; font-weight:700; color:#1a1a1a;">FAQ &amp; Support</h2></div>
        <div id="providerFaqAccordion" style="background:#fff; border-radius:16px; overflow:hidden; margin-bottom:16px; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
          <details style="padding:16px 20px; border-bottom:1px solid #f2f2f7;"><summary style="font-weight:600; color:#1a1a1a; cursor:pointer;">Kosten (4,99 â‚¬ / 0,89 â‚¬)</summary><p style="margin:12px 0 0; font-size:14px; color:#8e8e93; line-height:1.5;">Fixpreis 4,99 â‚¬ pro Inserat. Abholnummer optional + 0,89 â‚¬ pro Vorgang inkl. GebÃ¼hren.</p></details>
          <details style="padding:16px 20px; border-bottom:1px solid #f2f2f7;"><summary style="font-weight:600; color:#1a1a1a; cursor:pointer;">Zeitfenster-Logik</summary><p style="margin:12px 0 0; font-size:14px; color:#8e8e93; line-height:1.5;">Nach Ende der Mittagszeit ist das Inserat automatisch offline. Keine BestandsfÃ¼hrung.</p></details>
          <details style="padding:16px 20px;"><summary style="font-weight:600; color:#1a1a1a; cursor:pointer;">Keine BestandsfÃ¼hrung</summary><p style="margin:12px 0 0; font-size:14px; color:#8e8e93; line-height:1.5;">Das System arbeitet zeitbasiert. Es wird nur das Zeitfenster verwaltet.</p></details>
        </div>
        <div style="display:flex; flex-direction:column; gap:12px; margin-bottom:24px;">
          <a href="#" id="providerSupportChat" style="display:flex; align-items:center; justify-content:center; gap:10px; padding:18px; background:#fff; border-radius:16px; font-size:17px; font-weight:600; color:#1a1a1a; text-decoration:none; box-shadow:0 2px 12px rgba(0,0,0,0.06);">Chat mit uns</a>
          <a href="mailto:support@mittagio.de" style="display:flex; align-items:center; justify-content:center; gap:10px; padding:18px; background:#fff; border-radius:16px; font-size:17px; font-weight:600; color:#1a1a1a; text-decoration:none; box-shadow:0 2px 12px rgba(0,0,0,0.06);">E-Mail schreiben</a>
        </div>
        <div style="background:#fff; border-radius:16px; overflow:hidden; box-shadow:0 2px 12px rgba(0,0,0,0.06);">
          <a href="#" onclick="showLegalPage('impressum-provider'); return false;" style="display:flex; justify-content:space-between; align-items:center; padding:16px 20px; text-decoration:none; color:#1a1a1a; font-size:16px; border-bottom:1px solid #f2f2f7;">Impressum <i data-lucide="chevron-right" style="color:#c7c7cc; width:18px;"></i></a>
          <a href="#" onclick="showLegalPage('agb-provider'); return false;" style="display:flex; justify-content:space-between; align-items:center; padding:16px 20px; text-decoration:none; color:#1a1a1a; font-size:16px; border-bottom:1px solid #f2f2f7;">AGB <i data-lucide="chevron-right" style="color:#c7c7cc; width:18px;"></i></a>
          <a href="#" onclick="showLegalPage('datenschutz-provider'); return false;" style="display:flex; justify-content:space-between; align-items:center; padding:16px 20px; text-decoration:none; color:#1a1a1a; font-size:16px;">Datenschutz <i data-lucide="chevron-right" style="color:#c7c7cc; width:18px;"></i></a>
        </div>
      </div>

      <!-- Logout (immer sichtbar am Ende der Hauptseite, per JS nach MenÃ¼ eingefÃ¼gt oder fix) -->
      <div style="margin:20px; text-align:center;">
        <button id="btnProvLogout" style="padding:12px 24px; font-size:15px; font-weight:600; color:#8e8e93; background:none; border:none; cursor:pointer;">Abmelden</button>
      </div>
      <div style="text-align:center; margin-bottom:24px;"><span style="font-size:12px; color:#c7c7cc;">Version 2.0.0 â€¢ Mittagio Provider App</span></div>
    </section>

    <!-- STATISCHE RECHTSTEXTE-SEITEN: KUNDEN -->
    <section class="view" id="v-legal-impressum">
      <div class="panel">
        <h1 style="font-size:24px; font-weight:900; margin-bottom:20px;">Impressum (Kunden)</h1>
        <div style="line-height:1.8; font-size:15px;">
          <p>
            <strong>Mike Quach</strong><br>
            LangÃ¤cker 2<br>
            73635 Rudersberg
          </p>
          <p style="margin-top:16px;">
            <strong>Kunden-Hilfe:</strong> <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a><br>
            <strong>Business:</strong> <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a>
          </p>
          <p style="margin-top:20px; padding-top:20px; border-top:1px solid #eee; font-size:13px; color:#666;">
            <strong>Plattformhinweis:</strong><br>
            Mittagio vermittelt Mittagsangebote lokaler Anbieter. Vertragspartner bei Bestellungen ist ausschlieÃŸlich der jeweilige Anbieter.
          </p>
        </div>
        <div style="margin-top:24px; padding-top:16px; border-top:1px solid #eee; text-align:center; font-size:13px; color:#94a3b8;">
          made with â¤ï¸ by mittagio.de
        </div>
        <div style="margin-top:16px; text-align:center; font-size:14px; color:#666;">
          <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a> Â· Kunden-Hilfe | <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a> Â· Business-Bereich
        </div>
        <button class="btn ghost" type="button" onclick="goBackFromLegalPage()" style="margin-top:20px; width:100%;">ZurÃ¼ck</button>
      </div>
    </section>

    <!-- Impressum fÃ¼r Anbieter (rechtlich eigenes Dokument) -->
    <section class="view" id="v-legal-impressum-provider" style="background:#323232; min-height:100vh; padding:20px; padding-bottom:90px;">
      <div class="panel" style="padding:20px; border-radius:20px; box-shadow:0 4px 20px rgba(0,0,0,.2); background:#404040; border:1px solid rgba(255,255,255,0.1);">
        <h1 style="font-size:24px; font-weight:900; margin-bottom:20px; color:#fff;">Impressum (Anbieter)</h1>
        <div style="line-height:1.8; font-size:15px; color:rgba(255,255,255,0.9);">
          <p>
            <strong>Mike Quach</strong><br>
            LangÃ¤cker 2<br>
            73635 Rudersberg
          </p>
          <p style="margin-top:16px;">
            <strong>Business-Support:</strong> <a href="mailto:support@mittagio.de" style="color:#FFD700;">support@mittagio.de</a><br>
            <strong>Kunden-Hilfe:</strong> <a href="mailto:info@mittagio.de" style="color:#FFD700;">info@mittagio.de</a>
          </p>
          <p style="margin-top:20px; padding-top:20px; border-top:1px solid rgba(255,255,255,0.1); font-size:13px; color:rgba(255,255,255,0.7);">
            <strong>Plattformhinweis:</strong><br>
            Mittagio ist eine Vermittlungsplattform fÃ¼r lokale Gastronomie. Als Anbieter nutzt du unsere digitale Infrastruktur zur Verwaltung deiner Mittagsangebote und zur Abwicklung von Online-Bestellungen.
          </p>
        </div>
        <div style="margin-top:24px; padding-top:16px; border-top:1px solid rgba(255,255,255,0.1); text-align:center; font-size:13px; color:rgba(255,255,255,0.6);">
          made with â¤ï¸ by mittagio.de
        </div>
        <div style="margin-top:16px; text-align:center; font-size:14px; color:rgba(255,255,255,0.7);">
          <a href="mailto:support@mittagio.de" style="color:#FFD700;">support@mittagio.de</a> Â· Business-Bereich
        </div>
        <button class="btn ghost" type="button" onclick="goBackFromLegalPage()" style="margin-top:20px; width:100%; background:#4a4a4a; border:1px solid rgba(255,255,255,0.12); color:rgba(255,255,255,0.85);">ZurÃ¼ck</button>
      </div>
    </section>

    <!-- AGB fÃ¼r Kunden -->
    <section class="view" id="v-legal-agb-kurz">
      <div class="panel">
        <h1 style="font-size:24px; font-weight:900; margin-bottom:20px;">AGB (Kunden)</h1>
        <div style="line-height:1.8; font-size:15px;">
          <p><strong>Mittagio ist Plattform, nicht VerkÃ¤ufer</strong></p>
          <p>Mittagio vermittelt Mittagsangebote lokaler Anbieter. Vertragspartner bei Bestellungen ist ausschlieÃŸlich der jeweilige Anbieter.</p>
          
          <p style="margin-top:20px;"><strong>Bestellung & Zahlung:</strong></p>
          <p>Du bestellst direkt beim Anbieter Ã¼ber unsere Plattform. Die Zahlung erfolgt sicher online. Nach erfolgreicher Zahlung erhÃ¤ltst du deine Abholnummer.</p>
          
          <p style="margin-top:20px;"><strong>Abholnummer:</strong></p>
          <p>Die Abholnummer dient als Zahlungs- & Abholnachweis. Zeige sie beim Abholen vor, um dein Essen zu erhalten.</p>
          
          <p style="margin-top:20px;"><strong>Stornierung:</strong></p>
          <p>Stornierungen sind bis zu einer bestimmten Frist vor der Abholzeit mÃ¶glich. Details findest du in der BestellÃ¼bersicht.</p>
          
          <p style="margin-top:20px;"><strong>Verantwortung:</strong></p>
          <p>Der Anbieter ist verantwortlich fÃ¼r Speisen, Preise und gesetzliche Vorgaben. Mittagio Ã¼bernimmt keine Haftung fÃ¼r die QualitÃ¤t der Speisen.</p>
          
          <p style="margin-top:20px;"><strong>Support:</strong></p>
          <p>Kunden-Hilfe: <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a></p>
        </div>
        <div style="margin-top:32px; padding-top:20px; border-top:1px solid #eee; text-align:center; font-size:14px; color:#666;">
          Fragen, Hilfe oder VorschlÃ¤ge? <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a>
        </div>
        <button class="btn ghost" type="button" onclick="goBackFromLegalPage()" style="margin-top:20px; width:100%;">ZurÃ¼ck</button>
      </div>
    </section>

    <!-- AGB fÃ¼r Anbieter -->
    <section class="view" id="v-legal-agb-provider" style="background:#323232; min-height:100vh; padding:20px; padding-bottom:90px;">
      <div class="panel" style="padding:20px; border-radius:20px; box-shadow:0 4px 20px rgba(0,0,0,.2); background:#404040; border:1px solid rgba(255,255,255,0.1);">
        <h1 style="font-size:24px; font-weight:900; margin-bottom:20px; color:#fff;">AGB (Anbieter)</h1>
        <div style="line-height:1.8; font-size:15px; color:rgba(255,255,255,0.9);">
          <p><strong>Mittagio ist Plattform, nicht VerkÃ¤ufer</strong></p>
          <p>Mittagio stellt dir eine digitale Infrastruktur zur Verwaltung deiner Mittagsangebote und zur Abwicklung von Online-Bestellungen zur VerfÃ¼gung.</p>
          
          <p style="margin-top:20px;"><strong>Kosten fÃ¼r Anbieter:</strong></p>
          <ul style="padding-left:20px; margin:8px 0;">
            <li>4,99 â‚¬ zzgl. MwSt. pro VerÃ¶ffentlichung</li>
            <li>0,89 â‚¬ zzgl. MwSt. pro Online-Bestellung inkl. aller Bank- & ZahlungsgebÃ¼hren (pro Bestellung, egal wie viele Gerichte)</li>
          </ul>
          
          <p style="margin-top:20px;"><strong>Service-Pauschale:</strong></p>
          <p>Die Service-Pauschale von 0,89 â‚¬ ist eine GebÃ¼hr fÃ¼r die Bereitstellung der digitalen Infrastruktur und Zahlungsabwicklung. Diese GebÃ¼hr fÃ¤llt bei jeder Bestellung an und wird auch bei Stornierungen zur Deckung der System- und Bankkosten einbehalten, da die Transaktions- und Systemkosten bereits bei der Buchung entstehen.</p>
          
          <p style="margin-top:20px;"><strong>Abholnummer:</strong></p>
          <p>Die Abholnummer dient als zentrales Beweismittel fÃ¼r die Warenausgabe und als Zahlungs- & Abholnachweis. Die AbwicklungsgebÃ¼hr fÃ¤llt auch bei Nicht-Abholung an.</p>
          
          <p style="margin-top:20px;"><strong>Verantwortung:</strong></p>
          <p>Du bist verantwortlich fÃ¼r Inhalte, Speisen und gesetzliche Vorgaben. Mittagio Ã¼bernimmt keine Haftung fÃ¼r deine Angebote.</p>
          
          <p style="margin-top:20px;"><strong>Support:</strong></p>
          <p><a href="mailto:support@mittagio.de" style="color:#FFD700;">support@mittagio.de</a></p>
        </div>
        <div style="margin-top:32px; padding-top:20px; border-top:1px solid rgba(255,255,255,0.1); text-align:center; font-size:14px; color:rgba(255,255,255,0.7);">
          Fragen, Hilfe oder VorschlÃ¤ge? <a href="mailto:support@mittagio.de" style="color:#FFD700;">support@mittagio.de</a>
        </div>
        <button class="btn ghost" type="button" onclick="goBackFromLegalPage()" style="margin-top:20px; width:100%; background:#4a4a4a; border:1px solid rgba(255,255,255,0.12); color:rgba(255,255,255,0.85);">ZurÃ¼ck</button>
      </div>
    </section>

    <!-- FAQ mit Reitern (Kunden & Anbieter) -->
    <section class="view" id="v-legal-faq" style="background:#F7F6F0; min-height:100vh; padding:20px; padding-bottom:90px;">
      <div class="panel" style="padding:0; overflow:hidden;">
        <h1 style="font-size:24px; font-weight:900; margin:20px 20px 0; padding-bottom:20px;">FAQ</h1>
        
        <!-- Reiter (Tabs) -->
        <div style="display:flex; border-bottom:2px solid #eee; background:#fff;">
          <button class="faq-tab-btn" id="faqTabCustomer" onclick="switchFaqTab('customer')" style="flex:1; padding:16px; background:#fff; border:none; border-bottom:3px solid #FFD700; font-weight:700; font-size:15px; color:#334155; cursor:pointer;">
            FÃ¼r Kunden
          </button>
          <button class="faq-tab-btn" id="faqTabProvider" onclick="switchFaqTab('provider')" style="flex:1; padding:16px; background:#f9f9f9; border:none; border-bottom:3px solid transparent; font-weight:600; font-size:15px; color:#666; cursor:pointer;">
            FÃ¼r Anbieter
          </button>
        </div>
        
        <!-- FAQ-Inhalt: Kunden (vollstÃ¤ndige Liste) -->
        <div id="faqContentCustomer" style="display:block; padding:20px; line-height:1.8; font-size:15px;">
          <h2 style="font-size:16px; font-weight:800; margin:0 0 12px; color:#1a1a1a; text-transform:uppercase; letter-spacing:0.5px;">Bestellungen &amp; Bezahlung</h2>
          <div style="margin-bottom:20px; padding-bottom:16px; border-bottom:1px solid #eee;">
            <h3 style="font-size:16px; font-weight:700; margin-bottom:6px; color:#2D3436;">Muss ich mich registrieren?</h3>
            <p style="margin:0; color:#666;">Ja, damit wir deine Abholnummer sicher zuordnen und dir deine Bestellhistorie anzeigen kÃ¶nnen.</p>
          </div>
          <div style="margin-bottom:20px; padding-bottom:16px; border-bottom:1px solid #eee;">
            <h3 style="font-size:16px; font-weight:700; margin-bottom:6px; color:#2D3436;">Wie bezahle ich mein Essen?</h3>
            <p style="margin:0; color:#666;">Die Bezahlung erfolgt digital direkt Ã¼ber die Plattform, damit du vor Ort keine Wartezeit an der Kasse hast.</p>
          </div>
          <div style="margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid #eee;">
            <h3 style="font-size:16px; font-weight:700; margin-bottom:6px; color:#2D3436;">Kann ich eine Bestellung stornieren?</h3>
            <p style="margin:0; color:#666;">Da die Mahlzeiten frisch fÃ¼r dich vorbereitet werden, ist eine Stornierung nach Ablauf des Zeitfensters leider nicht mÃ¶glich.</p>
          </div>

          <h2 style="font-size:16px; font-weight:800; margin:0 0 12px; color:#1a1a1a; text-transform:uppercase; letter-spacing:0.5px;">Anbieter &amp; Auswahl</h2>
          <div style="margin-bottom:20px; padding-bottom:16px; border-bottom:1px solid #eee;">
            <h3 style="font-size:16px; font-weight:700; margin-bottom:6px; color:#2D3436;">Warum sehe ich keine Mehrweg-Option bei meinem Anbieter?</h3>
            <p style="margin:0; color:#666;">Wir arbeiten daran, dass bald alle Partner Mehrweg anbieten. Aktuell liegt die Entscheidung noch beim jeweiligen Anbieter.</p>
          </div>
          <div style="margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid #eee;">
            <h3 style="font-size:16px; font-weight:700; margin-bottom:6px; color:#2D3436;">Sind die Allergene (Glutenfrei etc.) verlÃ¤sslich?</h3>
            <p style="margin:0; color:#666;">Ja, die Angaben stammen direkt vom Anbieter. Du kannst diese Filter in deinem Profil unter â€žMein Geschmackâ€œ voreinstellen.</p>
          </div>

          <h2 style="font-size:16px; font-weight:800; margin:0 0 12px; color:#1a1a1a; text-transform:uppercase; letter-spacing:0.5px;">Technik &amp; Account</h2>
          <div style="margin-bottom:20px; padding-bottom:16px; border-bottom:1px solid #eee;">
            <h3 style="font-size:16px; font-weight:700; margin-bottom:6px; color:#2D3436;">Wo finde ich meine alten Bestellungen?</h3>
            <p style="margin:0; color:#666;">Alle vergangenen Mahlzeiten sind in deinem Profil unter â€žMeine Bestellungenâ€œ chronologisch aufgelistet.</p>
          </div>
          <div style="margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid #eee;">
            <h3 style="font-size:16px; font-weight:700; margin-bottom:6px; color:#2D3436;">Wie Ã¤ndere ich meine Mail-Adresse?</h3>
            <p style="margin:0; color:#666;">Gehe in deinem Profil zum Bereich â€žProfildatenâ€œ â€“ dort kannst du deine E-Mail und deinen Namen jederzeit aktualisieren.</p>
          </div>
        </div>
        
        <!-- FAQ-Inhalt: Anbieter -->
        <div id="faqContentProvider" style="display:none; padding:20px; line-height:1.8; font-size:15px;">
          <div style="margin-bottom:24px; padding-bottom:20px; border-bottom:1px solid #eee;">
            <h3 style="font-size:18px; font-weight:700; margin-bottom:8px; color:#2D3436;">Wie funktioniert der KÃ¼chenmodus?</h3>
            <p style="margin:0; color:#666;">Der KÃ¼chenmodus ist dein digitales Cockpit. Hier siehst du live eingehende Bestellungen, kannst deine Mittagskarte verwalten und die Abholnummer-Liste fÃ¼r deine KÃ¼che ausdrucken oder per E-Mail versenden.</p>
          </div>
          
          <div style="margin-bottom:24px; padding-bottom:20px; border-bottom:1px solid #eee;">
            <h3 style="font-size:18px; font-weight:700; margin-bottom:8px; color:#2D3436;">Warum gibt es eine Service-Pauschale von 0,89 â‚¬?</h3>
            <p style="margin:0; color:#666;">Diese Pauschale ist dein â€žRundum-Sorglos-Paket". Wir Ã¼bernehmen die komplette Zahlungsabwicklung und die BankgebÃ¼hren fÃ¼r dich. Zudem sparst du massiv Personalzeit an der Kasse und hast keinen manuellen Buchungsaufwand mehr.</p>
          </div>
          
          <div style="margin-bottom:24px; padding-bottom:20px; border-bottom:1px solid #eee;">
            <h3 style="font-size:18px; font-weight:700; margin-bottom:8px; color:#2D3436;">Muss ich eine Mindestmenge an Essen angeben?</h3>
            <p style="margin:0; color:#666;">Nein. Du entscheidest flexibel, wann ein Gericht â€žAusverkauft" ist. Ein Klick im KÃ¼chenmodus genÃ¼gt, um das Angebot fÃ¼r den Tag zu beenden.</p>
          </div>
          
          <div style="margin-bottom:24px; padding-bottom:20px; border-bottom:1px solid #eee;">
            <h3 style="font-size:18px; font-weight:700; margin-bottom:8px; color:#2D3436;">Wie sicher ist die Auszahlung?</h3>
            <p style="margin:0; color:#666;">Wir arbeiten mit professionellen Zahlungsdienstleistern zusammen. Dein Umsatz wird gesammelt und regelmÃ¤ÃŸig direkt auf dein Bankkonto Ã¼berwiesen â€“ sauber aufgeschlÃ¼sselt fÃ¼r deine Buchhaltung.</p>
          </div>
        </div>
        
        <div style="margin-top:32px; padding:20px; border-top:1px solid #eee; text-align:center; font-size:14px; color:#666; background:#f9f9f9;">
          Weitere Fragen? Nutze den Button â€žWeitere Fragen &amp; Hilfeâ€œ in deinem Profil (Meins).
        </div>
        <button class="btn ghost" type="button" onclick="goBackFromLegalPage()" style="margin:0 20px 20px; width:calc(100% - 40px);">ZurÃ¼ck</button>
      </div>
    </section>

    <!-- Support-Seite (Kunden): erweiterte FAQs + Kontaktformular, keine E-Mail im UI -->
    <section class="view" id="v-support" style="background:#F7F6F0; min-height:100vh; padding:20px; padding-bottom:90px;">
      <div class="panel" style="padding:0; overflow:hidden;">
        <h1 style="font-size:24px; font-weight:900; margin:20px 20px 0; padding-bottom:20px;">Support &amp; Hilfe</h1>

        <!-- Erweiterte Kunden-FAQs (Zahlung, Stornierung, Account) -->
        <div style="padding:0 20px 20px;">
          <h2 style="font-size:16px; font-weight:800; margin:0 0 12px; color:#1a1a1a;">HÃ¤ufige Fragen</h2>
          <details style="background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.06); overflow:hidden; margin-bottom:8px;">
            <summary style="padding:12px 14px; font-size:14px; font-weight:600; color:#1a1a1a; cursor:pointer; list-style:none;">Wie bezahle ich mein Essen?</summary>
            <p style="margin:0; padding:0 14px 14px 14px; font-size:14px; line-height:1.5; color:#555;">Die Bezahlung erfolgt digital direkt Ã¼ber die Plattform. Nach erfolgreicher Zahlung erhÃ¤ltst du deine Abholnummer.</p>
          </details>
          <details style="background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.06); overflow:hidden; margin-bottom:8px;">
            <summary style="padding:12px 14px; font-size:14px; font-weight:600; color:#1a1a1a; cursor:pointer; list-style:none;">Kann ich eine Bestellung stornieren?</summary>
            <p style="margin:0; padding:0 14px 14px 14px; font-size:14px; line-height:1.5; color:#555;">Da die Mahlzeiten frisch fÃ¼r dich vorbereitet werden, ist eine Stornierung nach Ablauf des Zeitfensters leider nicht mÃ¶glich. Details findest du in der BestellÃ¼bersicht.</p>
          </details>
          <details style="background:#fff; border-radius:12px; border:1px solid rgba(0,0,0,.06); overflow:hidden; margin-bottom:8px;">
            <summary style="padding:12px 14px; font-size:14px; font-weight:600; color:#1a1a1a; cursor:pointer; list-style:none;">Wo finde ich meine Bestellungen / Account?</summary>
            <p style="margin:0; padding:0 14px 14px 14px; font-size:14px; line-height:1.5; color:#555;">Alle Bestellungen und deine Profildaten findest du unter â€žMeinsâ€œ in der App.</p>
          </details>
        </div>

        <!-- Kontaktformular -->
        <div style="padding:20px; border-top:1px solid #eee;">
          <h2 style="font-size:16px; font-weight:800; margin:0 0 16px; color:#1a1a1a;">Nachricht senden</h2>
          <form id="supportForm" style="display:flex; flex-direction:column; gap:14px;">
            <label style="font-size:14px; font-weight:600; color:#334155;">Betreff</label>
            <select id="supportSubject" required style="width:100%; padding:14px 16px; border-radius:12px; border:2px solid rgba(0,0,0,.1); font-size:15px; background:#fff;">
              <option value="">Bitte wÃ¤hlen</option>
              <option value="bestellung">Frage zu meiner Bestellung</option>
              <option value="abholnummer">Problem mit Abholnummer</option>
              <option value="lob">Lob &amp; Kritik</option>
              <option value="technisch">Technischer Fehler</option>
              <option value="sonstiges">Sonstiges</option>
            </select>
            <label style="font-size:14px; font-weight:600; color:#334155;">Abholnummer (optional)</label>
            <input type="text" id="supportPickupRef" placeholder="z.B. #1A" style="width:100%; padding:14px 16px; border-radius:12px; border:2px solid rgba(0,0,0,.1); font-size:15px; box-sizing:border-box;">
            <label style="font-size:14px; font-weight:600; color:#334155;">Nachricht</label>
            <textarea id="supportMessage" required rows="4" placeholder="Deine Nachrichtâ€¦" style="width:100%; padding:14px 16px; border-radius:12px; border:2px solid rgba(0,0,0,.1); font-size:15px; resize:vertical; box-sizing:border-box;"></textarea>
            <button type="submit" class="btn" id="btnSupportSubmit" style="width:100%; min-height:52px; font-weight:800; font-size:16px; border-radius:14px; background:var(--brand); color:#1a1a1a; border:none; cursor:pointer;">Nachricht senden</button>
          </form>
        </div>

        <div style="margin-top:24px; padding:20px; text-align:center; font-size:13px; color:#94a3b8;">made with â¤ï¸ by mittagio.de</div>
        <button class="btn ghost" type="button" onclick="goBackFromLegalPage()" style="margin:0 20px 20px; width:calc(100% - 40px);">ZurÃ¼ck</button>
      </div>
    </section>
    
    <!-- Anbieter-FAQ -->
    <section class="view" id="v-legal-faq-provider" style="background:#323232; min-height:100vh; padding:20px; padding-bottom:90px;">
      <div class="panel" style="padding:20px; border-radius:20px; box-shadow:0 4px 20px rgba(0,0,0,.2); background:#404040; border:1px solid rgba(255,255,255,0.1);">
        <h1 style="font-size:24px; font-weight:900; margin-bottom:20px; color:#fff;">FAQ fÃ¼r Anbieter</h1>
        <div style="line-height:1.8; font-size:15px; color:rgba(255,255,255,0.9);">
          
          <div style="margin-bottom:24px; padding-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1);">
            <h3 style="font-size:18px; font-weight:700; margin-bottom:8px; color:#fff;">Wie funktioniert der KÃ¼chenmodus?</h3>
            <p style="margin:0; color:rgba(255,255,255,0.8);">Der KÃ¼chenmodus ist dein digitales Cockpit. Hier siehst du live eingehende Bestellungen, kannst deine Mittagskarte verwalten und die Abholnummer-Liste fÃ¼r deine KÃ¼che ausdrucken oder per E-Mail versenden.</p>
          </div>
          
          <div style="margin-bottom:24px; padding-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1);">
            <h3 style="font-size:18px; font-weight:700; margin-bottom:8px; color:#fff;">Warum gibt es eine Service-Pauschale von 0,89 â‚¬?</h3>
            <p style="margin:0; color:rgba(255,255,255,0.8);">Diese Pauschale ist dein â€žRundum-Sorglos-Paket". Wir Ã¼bernehmen die komplette Zahlungsabwicklung und die BankgebÃ¼hren fÃ¼r dich. Zudem sparst du massiv Personalzeit an der Kasse und hast keinen manuellen Buchungsaufwand mehr.</p>
          </div>
          
          <div style="margin-bottom:24px; padding-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1);">
            <h3 style="font-size:18px; font-weight:700; margin-bottom:8px; color:#fff;">Muss ich eine Mindestmenge an Essen angeben?</h3>
            <p style="margin:0; color:rgba(255,255,255,0.8);">Nein. Du entscheidest flexibel, wann ein Gericht â€žAusverkauft" ist. Ein Klick im KÃ¼chenmodus genÃ¼gt, um das Angebot fÃ¼r den Tag zu beenden.</p>
          </div>
          
          <div style="margin-bottom:24px; padding-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1);">
            <h3 style="font-size:18px; font-weight:700; margin-bottom:8px; color:#fff;">Wie sicher ist die Auszahlung?</h3>
            <p style="margin:0; color:rgba(255,255,255,0.8);">Wir arbeiten mit professionellen Zahlungsdienstleistern zusammen. Dein Umsatz wird gesammelt und regelmÃ¤ÃŸig direkt auf dein Bankkonto Ã¼berwiesen â€“ sauber aufgeschlÃ¼sselt fÃ¼r deine Buchhaltung.</p>
          </div>
          
        </div>
        <div style="margin-top:32px; padding-top:20px; border-top:1px solid rgba(255,255,255,0.1); text-align:center; font-size:14px; color:rgba(255,255,255,0.6);">
          Weitere Fragen? <a href="mailto:support@mittagio.de" style="color:#FFD700;">support@mittagio.de</a>
        </div>
        <button class="btn ghost" type="button" onclick="goBackFromLegalPage()" style="margin-top:20px; width:100%; background:#383838; border:1px solid rgba(255,255,255,0.12); color:rgba(255,255,255,0.9);">ZurÃ¼ck</button>
      </div>
    </section>

    <section class="view" id="v-legal-datenschutz">
      <div class="panel">
        <h1 style="font-size:24px; font-weight:900; margin-bottom:20px;">DatenschutzerklÃ¤rung</h1>
        <div style="line-height:1.8; font-size:15px;">
          <p style="font-weight:700; margin-bottom:12px;">Verantwortlicher:</p>
          <p>
            MQ Mittagio UG (haftungsbeschrÃ¤nkt)<br>
            LangÃ¤cker 2, 73635 Rudersberg<br>
            Kunden-Hilfe: <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a><br>
            Business-Anfragen: <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a>
          </p>
          
          <p style="margin-top:24px; font-weight:700;">Datenminimierung:</p>
          <p>Wir speichern nur, was fÃ¼r die Zuordnung deiner Abholnummer und deiner ErnÃ¤hrungseinstellungen nÃ¶tig ist.</p>
          
          <p style="margin-top:24px; font-weight:700;">Sitzungssicherheit:</p>
          <p>Um Missbrauch vorzubeugen, erlauben wir nur eine aktive Session pro Account. Eine Neuanmeldung trennt bestehende Verbindungen.</p>
          
          <p style="margin-top:24px; font-weight:700;">Anbieter-Daten:</p>
          <p>Kommunikation fÃ¼r Business-Partner erfolgt strikt Ã¼ber <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a>.</p>
          
          <p style="margin-top:24px; font-weight:700;">Abholnummer:</p>
          <p>Die Abholnummer dient als Zahlungs-/Abholnachweis, zur Zuordnung und zum Missbrauchsschutz.</p>
          
          <p style="margin-top:24px; font-weight:700;">Online-Zahlung:</p>
          <p>Online-Zahlung erfolgt Ã¼ber externe Zahlungsdienstleister (z.B. Stripe). Wir speichern keine vollstÃ¤ndigen Zahlungsdaten (z.B. Kreditkartennummern).</p>
          
          <p style="margin-top:24px; font-weight:700;">Weitergabe:</p>
          <p>Daten werden nur an Zahlungsdienstleister und wenn gesetzlich erforderlich weitergegeben. Keine Werbeweitergabe.</p>
          
          <p style="margin-top:24px; font-weight:700;">Ihre Rechte:</p>
          <p>Sie haben das Recht auf Auskunft, Berichtigung, LÃ¶schung, EinschrÃ¤nkung und Widerspruch. Kontakt: <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a></p>
        </div>
        <div style="margin-top:32px; padding-top:20px; border-top:1px solid #eee; text-align:center; font-size:14px; color:#666;">
          Kunden-Hilfe: <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a> | Business: <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a>
        </div>
        <button class="btn ghost" type="button" onclick="goBackFromLegalPage()" style="margin-top:20px; width:100%;">ZurÃ¼ck</button>
      </div>
    </section>

    <!-- Datenschutz fÃ¼r Anbieter (rechtlich eigenes Dokument, Anbieter-spezifische Texte) -->
    <section class="view" id="v-legal-datenschutz-provider" style="background:#323232; min-height:100vh; padding:20px; padding-bottom:90px;">
      <div class="panel" style="padding:20px; border-radius:20px; box-shadow:0 4px 20px rgba(0,0,0,.2); background:#404040; border:1px solid rgba(255,255,255,0.1);">
        <h1 style="font-size:24px; font-weight:900; margin-bottom:20px; color:#fff;">DatenschutzerklÃ¤rung (Anbieter)</h1>
        <div style="line-height:1.8; font-size:15px; color:rgba(255,255,255,0.9);">
          <p style="font-weight:700; margin-bottom:12px;">Verantwortlicher:</p>
          <p>
            MQ Mittagio UG (haftungsbeschrÃ¤nkt)<br>
            LangÃ¤cker 2, 73635 Rudersberg<br>
            <strong>Business-Support:</strong> <a href="mailto:support@mittagio.de" style="color:#FFD700;">support@mittagio.de</a><br>
            Kunden-Hilfe: <a href="mailto:info@mittagio.de" style="color:#FFD700;">info@mittagio.de</a>
          </p>
          <p style="margin-top:24px; font-weight:700;">Anbieter-Daten & Zugang:</p>
          <p>FÃ¼r deinen Anbieter-Zugang speichern wir E-Mail, Passwort (verschlÃ¼sselt) und alle von dir angelegten Inhalte (Betrieb, Gerichte, Speisekarte). Diese Daten dienen ausschlieÃŸlich der Bereitstellung der Plattform und der Abwicklung von Bestellungen.</p>
          <p style="margin-top:24px; font-weight:700;">Sitzung & Sicherheit:</p>
          <p>Pro Anbieter-Account ist nur eine aktive Sitzung erlaubt. Eine neue Anmeldung beendet andere GerÃ¤te â€“ das schÃ¼tzt dein Konto vor Missbrauch.</p>
          <p style="margin-top:24px; font-weight:700;">Bestell- & Abholdaten:</p>
          <p>Bestellungen und Abholnummern werden zur Abwicklung und zum Nachweis gespeichert. Kundenbezogene Daten (z.â€¯B. Abholnummer, Name bei Bestellung) werden nur im erforderlichen Umfang und nicht fÃ¼r Werbezwecke genutzt.</p>
          <p style="margin-top:24px; font-weight:700;">Zahlungsdienstleister:</p>
          <p>Online-Zahlungen laufen Ã¼ber externe Anbieter (z.â€¯B. Stripe). Wir speichern keine vollstÃ¤ndigen Zahlungsdaten (z.â€¯B. Kreditkartennummern).</p>
          <p style="margin-top:24px; font-weight:700;">Weitergabe:</p>
          <p>Daten werden nur an Zahlungsdienstleister und bei gesetzlicher Verpflichtung weitergegeben. Keine Weitergabe zu Werbezwecken.</p>
          <p style="margin-top:24px; font-weight:700;">Deine Rechte:</p>
          <p>Auskunft, Berichtigung, LÃ¶schung, EinschrÃ¤nkung und Widerspruch. Anbieter-Anfragen bitte an <a href="mailto:support@mittagio.de" style="color:#FFD700;">support@mittagio.de</a>.</p>
        </div>
        <div style="margin-top:32px; padding-top:20px; border-top:1px solid rgba(255,255,255,0.1); text-align:center; font-size:14px; color:rgba(255,255,255,0.6);">
          <a href="mailto:support@mittagio.de" style="color:#FFD700;">support@mittagio.de</a> Â· Business-Bereich
        </div>
        <button class="btn ghost" type="button" onclick="goBackFromLegalPage()" style="margin-top:20px; width:100%; background:#383838; border:1px solid rgba(255,255,255,0.12); color:rgba(255,255,255,0.9);">ZurÃ¼ck</button>
      </div>
    </section>

    <!-- Versionsseite (Link im Footer: v1.0.x) -->
    <section class="view" id="v-version" style="background:#F7F6F0; min-height:100vh; padding:20px; padding-bottom:90px;">
      <div class="panel" style="max-width:480px; margin:0 auto;">
        <h1 style="font-size:24px; font-weight:900; margin-bottom:20px;">Version</h1>
        <p style="font-size:16px; color:#555; margin-bottom:16px;">Aktuelle App-Version: <strong>v1.0.0</strong></p>
        <p style="font-size:14px; color:#666; line-height:1.6;">Changelog und technische Details findest du hier. Bei Fragen: <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a></p>
        <button class="btn ghost" type="button" onclick="history.back();" style="margin-top:24px; width:100%;">ZurÃ¼ck</button>
      </div>
    </section>

    <section class="view" id="v-legal-agb-onboarding">
      <div class="panel">
        <h2 style="font-size:20px; font-weight:900; margin-bottom:16px;">AGB</h2>
        <div style="line-height:1.7; font-size:14px; max-height:60vh; overflow-y:auto;">
          <p><strong>Mittagio ist Plattform, nicht VerkÃ¤ufer</strong></p>
          <p>Mittagio vermittelt Mittagsangebote lokaler Anbieter. Vertragspartner bei Bestellungen ist ausschlieÃŸlich der jeweilige Anbieter.</p>
          
          <p style="margin-top:16px;"><strong>Kosten:</strong></p>
          <ul style="padding-left:20px; margin:8px 0;">
            <li>4,99 â‚¬ zzgl. MwSt. pro VerÃ¶ffentlichung</li>
            <li>0,89 â‚¬ zzgl. MwSt. pro Online-Bestellung inkl. aller Bank- & ZahlungsgebÃ¼hren (pro Bestellung, egal wie viele Gerichte)</li>
          </ul>
          
          <p style="margin-top:16px;"><strong>Abholnummer:</strong></p>
          <p>Abholnummer = Zahlungs- & Abholnachweis. AbwicklungsgebÃ¼hr fÃ¤llt auch bei Nicht-Abholung an.</p>
          
          <p style="margin-top:16px;"><strong>Verantwortung:</strong></p>
          <p>Anbieter ist verantwortlich fÃ¼r Inhalte/Speisen/gesetzliche Vorgaben.</p>
          
          <p style="margin-top:16px;"><strong>Support:</strong></p>
          <p>Business-Anfragen: <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a></p>
        </div>
      </div>
    </section>
      
      <div id="provFaqBox" style="display:none;">
        <div class="panel">
          <div class="section-title">FAQ (Anbieter)</div>
          <div class="faq">
            <details>
              <summary>Was ist Mittagio?</summary>
              <p>Mittagio ist eine Online-Plattform, auf der du dein Mittagsangebot sichtbar machst â€“ schnell, einfach und flexibel.</p>
            </details>
            <details>
              <summary>Wie verdiene ich damit Zeit?</summary>
              <p>Du legst Gerichte einmal an (Kochbuch) und verÃ¶ffentlichst sie mit einem Klick. Weniger Telefonate, weniger Chaos.</p>
            </details>
            <details>
              <summary>Muss Online-Zahlung aktiv sein?</summary>
              <p>Nein. Online-Zahlung ist optional. Abholnummern gibtâ€™s nur bei Online-Zahlung.</p>
            </details>
            <details>
              <summary>Wie kann ich mein Angebot teilen?</summary>
              <p>Mit einem Tap: WhatsApp, Instagram oder Homepage â€“ Text ist automatisch vorbereitet.</p>
            </details>
            <details>
              <summary>InseratsgebÃ¼hr / All-In ErfolgsgebÃ¼hr?</summary>
              <p>InseratsgebÃ¼hr: 4,99 â‚¬ einmalig pro Gericht. All-In ErfolgsgebÃ¼hr: 0,89 â‚¬ pro verkaufter Abholnummer (inkl. aller Bank- und Stripe-GebÃ¼hren). Keine Mindestlaufzeit.</p>
            </details>
            <details>
              <summary>Wie funktionieren Abholungen?</summary>
              <p>Wenn Abholnummer aktiv ist, werden die Nummern nach Gericht gruppiert angezeigt. Tippe eine Nummer an, sobald ein Gast abgeholt hat.</p>
            </details>
            <details>
              <summary>Warum Abholnummer?</summary>
              <p>Vorab bezahlt, weniger Chaos an der Ausgabe und ein klarer Ablauf pro Bestellung.</p>
            </details>
            <details>
              <summary>Was kostet die All-In ErfolgsgebÃ¼hr?</summary>
              <p>0,89 â‚¬ pro verkaufter Abholnummer. Diese GebÃ¼hr beinhaltet bereits alle Bank-, Stripe- und VerwaltungsgebÃ¼hren. (Auch wenn der Kunde mehrere Gerichte in einem Vorgang holt.)</p>
            </details>
            <details>
              <summary>Wie spare ich Zeit?</summary>
              <p>Speichere Gerichte im Kochbuch und verÃ¶ffentliche sie mit 2-3 Taps erneut.</p>
            </details>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Floating Action Button (FAB) fÃ¼r Modus-Wechsel -->


  <!-- CUSTOMER bottom nav - Mittagio-Bar -->
  <nav class="bottom" id="customerNav">
    <button class="navbtn active" data-go="discover" style="position:relative;">
      <div class="ico"><i data-lucide="utensils-crossed"></i></div>
      <div>Entdecken</div>
    </button>
    <button class="navbtn" data-go="fav" style="position:relative;">
      <div class="ico"><i data-lucide="heart"></i></div>
      <div>Favoriten</div>
    </button>
    <button class="navbtn" data-go="cart" style="position:relative;" id="bottomNavBasketBtn">
      <div class="ico"><i data-lucide="shopping-basket"></i></div>
      <div>Mittagsbox</div>
      <span id="bottomNavBasketBadge" class="nav-badge" style="display:none; position:absolute; top:4px; right:8px; width:18px; height:18px; background:#FFD700; color:#2D3436; border-radius:50%; font-size:11px; font-weight:900; display:flex; align-items:center; justify-content:center; border:2px solid #fff; box-shadow:0 2px 8px rgba(0,0,0,0.15);">0</span>
    </button>
    <button class="navbtn" data-go="profile" style="position:relative;">
      <div class="ico"><i data-lucide="user"></i></div>
      <div>Meins</div>
    </button>
  </nav>

    <!-- PROVIDER bottom nav: fixer ZurÃ¼ck-Button darÃ¼ber, heller Tab-Bar (App-Style) -->
  <div id="providerNavWrap" style="display:none; position:fixed; bottom:0; left:0; right:0; z-index:999; padding:0 env(safe-area-inset-right, 0) env(safe-area-inset-bottom, 0) env(safe-area-inset-left, 0);">
    <div id="providerNavBackRow" style="padding:0 20px 16px; display:none;">
      <button type="button" id="btnProviderNavBack" aria-label="ZurÃ¼ck" style="background:rgba(255,255,255,0.9); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); border:1px solid rgba(0,0,0,0.08); color:#1a1a1a; padding:10px 24px; border-radius:999px; font-size:15px; font-weight:700; cursor:pointer; display:inline-flex; align-items:center; gap:8px; box-shadow:0 2px 8px rgba(0,0,0,0.06);">â† ZurÃ¼ck</button>
    </div>
    <nav class="bottom provider-nav-light" id="providerNav" style="background:rgba(255,255,255,0.95); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); border-top:1px solid rgba(0,0,0,0.06); padding:16px 24px calc(16px + env(safe-area-inset-bottom, 0)); display:flex; justify-content:space-between; align-items:center;">
      <button class="navbtn active" data-pgo="provider-home"><div class="ico" data-icon="utensils" data-icon-only="1"></div><div>Meine KÃ¼che</div></button>
      <button class="navbtn" data-pgo="provider-pickups"><div class="ico" data-icon="receipt" data-icon-only="1"></div><div>Abholungen</div></button>
      <button class="navbtn" data-pgo="provider-cookbook"><div class="ico" data-icon="bookOpen" data-icon-only="1"></div><div>Kochbuch</div></button>
      <button class="navbtn" data-pgo="provider-profile"><div class="ico" data-icon="user" data-icon-only="1"></div><div>Meins</div></button>
    </nav>
  </div>
</div>

<!-- Publish Fee Modal (vor Inserats-VerÃ¶ffentlichung) -->
<div class="backdrop" id="publishFeeBd" onclick="closePublishFeeModal()" style="background:rgba(0,0,0,0.7); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); display:none;"></div>
<div class="sheet" id="publishFeeSheet" style="max-width:480px; border-radius:24px; overflow:hidden; display:none;">
  <div class="sheet-body" style="padding:28px;">
    <h3 style="margin:0 0 20px; font-size:22px; font-weight:900; color:#2D3436;">Inserat verÃ¶ffentlichen</h3>
    <div style="margin-bottom:24px; padding:20px; background:rgba(255,215,0,0.1); border-radius:16px; border:2px solid rgba(255,215,0,0.3);">
      <div style="font-weight:700; font-size:16px; color:#2D3436; margin-bottom:12px; display:flex; align-items:center; gap:8px;">
        <i data-lucide="info" style="width:20px;height:20px; color:#FFD700;"></i>
        <span>GebÃ¼hren-Ãœbersicht</span>
      </div>
      <div style="font-size:15px; line-height:1.6; color:#2D3436; margin-bottom:16px;">
        <div style="margin-bottom:12px;">
          <strong>InseratsgebÃ¼hr:</strong> <span style="color:#FFD700; font-weight:900;">4,99 â‚¬</span>
          <div style="font-size:13px; color:#666; margin-top:4px;">Einmalig pro Gericht fÃ¼r die Sichtbarkeit im Feed</div>
        </div>
        <div style="padding-top:12px; border-top:1px solid rgba(0,0,0,0.1);">
          <strong>All-In ErfolgsgebÃ¼hr:</strong> <span style="color:#1f9d55; font-weight:900;">0,89 â‚¬</span>
          <div style="font-size:13px; color:#666; margin-top:4px;">Pro verkaufter Abholnummer. Beinhaltet bereits alle Bank-, Stripe- und VerwaltungsgebÃ¼hren.</div>
        </div>
      </div>
    </div>
    <div style="display:flex; flex-direction:column; gap:12px;">
      <button class="btn-primary" type="button" id="btnPublishConfirm" style="width:100%; min-height:56px; font-size:16px; font-weight:700;">
        VerÃ¶ffentlichen
      </button>
      <button class="btn ghost" type="button" onclick="closePublishFeeModal();" style="width:100%; min-height:44px;">
        Abbrechen
      </button>
    </div>
  </div>
</div>

<!-- Inserat Live â€“ Erfolgs- & Monitoring-Sheet (Schritt 5 nach VerÃ¶ffentlichung) -->
<div class="backdrop" id="inseratSuccessBd" onclick="closeInseratSuccessSheet()" style="background:rgba(0,0,0,0.7); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); display:none;"></div>
<div class="sheet" id="inseratSuccessSheet" style="max-width:480px; border-radius:24px; overflow:hidden; display:none; background:#f8f7f2;">
  <div class="sheet-body" style="padding:24px 24px 120px;">
    <div style="text-align:center; padding-top:24px;">
      <div style="width:96px; height:96px; background:#dcfce7; color:#16a34a; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:48px; margin:0 auto 24px; box-shadow:0 2px 12px rgba(0,0,0,0.06); border:2px solid rgba(34,197,94,0.2);">âœ…</div>
      <h1 style="margin:0 0 8px; font-size:28px; font-weight:900; color:#1a1a1a; letter-spacing:-0.02em;">Inserat ist Live!</h1>
      <p style="margin:0 0 24px; font-size:12px; font-weight:700; color:#9ca3af; text-transform:uppercase; letter-spacing:0.05em;">4,99 â‚¬ erfolgreich abgebucht</p>
    </div>
    <div id="inseratSuccessMonitoringCard" style="background:#fff; border-radius:40px; padding:24px; margin-bottom:20px; box-shadow:0 10px 40px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
        <div style="text-align:left;">
          <span style="display:block; font-size:10px; font-weight:800; color:#9ca3af; text-transform:uppercase; letter-spacing:0.05em;">Aktueller Status</span>
          <h3 id="inseratSuccessDishName" style="margin:4px 0 0; font-size:20px; font-weight:900; color:#1a1a1a;">â€“</h3>
        </div>
        <div style="background:#ffde00; padding:8px 16px; border-radius:16px; font-weight:800; font-size:13px; color:#1a1a1a; box-shadow:0 2px 8px rgba(0,0,0,0.06);">LIVE ðŸ•’</div>
      </div>
      <div id="inseratSuccessAbholnummerSection" style="margin-bottom:20px;">
        <div style="display:flex; flex-direction:column; align-items:center; gap:12px; margin-bottom:16px;">
          <span style="font-size:10px; font-weight:800; color:#3b82f6; text-transform:uppercase; letter-spacing:0.05em;">NÃ¤chste Abholnummer</span>
          <div id="inseratSuccessNextCode" style="font-size:48px; font-weight:900; color:#1a1a1a; letter-spacing:-0.02em; background:#f9fafb; width:100%; padding:24px; text-align:center; border-radius:24px; border:2px dashed #e5e7eb;">#104</div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <button type="button" id="inseratSuccessBtnDone" style="background:#1a1a1a; color:#fff; padding:16px; border-radius:16px; font-weight:700; font-size:14px; border:none;">Erledigt (Ausgabe)</button>
          <button type="button" id="inseratSuccessBtnNext" style="background:#f3f4f6; color:#9ca3af; padding:16px; border-radius:16px; font-weight:700; font-size:14px; border:none;">NÃ¤chste: #105</button>
        </div>
      </div>
    </div>
    <div id="inseratSuccessRevenueRow" style="background:#fff; border-radius:24px; padding:20px; display:flex; justify-content:space-between; align-items:center; border:1px solid rgba(0,0,0,0.06);">
      <span style="font-weight:700; color:#6b7280;">Heutiger Umsatz:</span>
      <span id="inseratSuccessRevenue" style="font-size:24px; font-weight:900; color:#16a34a;">+ 0,00 â‚¬</span>
    </div>
  </div>
  <div style="position:fixed; bottom:0; left:0; right:0; padding:24px; background:linear-gradient(to top, #f8f7f2, transparent); text-align:center;">
    <button type="button" id="inseratSuccessBtnBack" style="color:#9ca3af; font-weight:700; font-size:14px; background:none; border:none; padding:12px;">ZurÃ¼ck zur Ãœbersicht (Dashboard)</button>
  </div>
  <div style="position:fixed; bottom:8px; left:0; right:0; text-align:center;">
    <span style="font-size:9px; font-weight:700; color:#d1d5db; text-transform:uppercase; letter-spacing:0.03em;">Schorndorf (Zentrum)</span>
  </div>
</div>

<!-- Offer sheet -->
<div class="backdrop" id="bd" onclick="closeSheet()" style="background:rgba(0,0,0,0.7);"></div>
<div class="sheet" id="sheet" style="background:rgba(255,255,255,0.98); color:#1a1a1a; border-top:2px solid rgba(0,0,0,0.08); box-shadow:0 -4px 20px rgba(0,0,0,0.08);">
  <div class="sheet-header" style="position:sticky; top:0; z-index:10; background:rgba(255,255,255,0.98); padding:12px 16px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid rgba(0,0,0,0.08); min-height:56px; overflow:visible; flex-shrink:0;">
    <button class="back-button" type="button" onclick="closeSheet()" aria-label="ZurÃ¼ck" style="background:rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.1); border-radius:50%; width:40px; height:40px; padding:0; cursor:pointer; display:flex; align-items:center; justify-content:center; color:#1a1a1a; transition:all 0.2s ease;" onmouseover="this.style.background='rgba(0,0,0,0.1)';" onmouseout="this.style.background='rgba(0,0,0,0.06)';">
      <i data-lucide="arrow-left" style="width:20px;height:20px;"></i>
    </button>
    <div style="font-weight:600; font-size:16px; color:#1a1a1a;">Angebot</div>
    <button class="share-button-header" type="button" id="btnShareHeader" aria-label="Teilen" style="background:rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.1); border-radius:20px; padding:8px 14px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px; color:#1a1a1a; font-size:14px; font-weight:600; transition:all 0.2s ease;" onmouseover="this.style.background='rgba(0,0,0,0.1)';" onmouseout="this.style.background='rgba(0,0,0,0.06)';">
      <i data-lucide="share-2" style="width:18px;height:18px;"></i>
      <span>Teilen</span>
    </button>
  </div>
  <div class="handle" style="background:rgba(0,0,0,0.15);"></div>
  
  <!-- Bild-Sektion: volle Breite, keine Overlays (UI-Spec Inserats-Detailansicht) -->
  <div style="position:relative; width:100%; aspect-ratio:16/10; max-height:280px; overflow:hidden; background:#f0f0f0;">
    <img id="sImg" alt="" style="width:100%; height:100%; object-fit:cover; display:block;" />
    <div id="sImgPlaceholder" style="position:absolute; top:0; left:0; right:0; bottom:0; background:#f0f0f0; display:none; align-items:center; justify-content:center; color:rgba(0,0,0,0.3); font-size:14px;">
      <i data-lucide="image" style="width:48px;height:48px;"></i>
    </div>
  </div>
  <!-- Favorit-Button neben Bild (nicht auf dem Bild) -->
  <div style="padding:8px 16px 0; display:flex; justify-content:flex-end;">
    <button id="sFavoriteBtn" type="button" aria-label="Favorit" style="width:40px; height:40px; border-radius:50%; background:rgba(255,255,255,0.95); border:1px solid rgba(0,0,0,0.08); display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.08);" onmouseover="this.style.background='rgba(0,0,0,0.04)';" onmouseout="this.style.background='rgba(255,255,255,0.95)';">
      <i data-lucide="heart" style="width:20px;height:20px; color:#e74c3c; fill:none;"></i>
    </button>
  </div>
  
  <!-- 3 SÃ¤ulen: direkt unter dem Bild (ðŸ´ immer, ðŸ§¾ nur bei Abholnummer, ðŸ”„ nur bei Mehrweg) -->
  <div id="sThreePillars" style="display:flex; justify-content:center; align-items:center; gap:12px; margin:0 16px 16px; padding:12px 0; flex-wrap:wrap; border-bottom:1px solid rgba(0,0,0,0.06);">
    <!-- Wird dynamisch befÃ¼llt -->
  </div>
  
  <!-- Mittags-Zeitfenster (Pill): "Abholung heute Mittag von X â€“ Y Uhr" -->
  <div id="sMealTime" style="display:flex; align-items:center; justify-content:center; margin:0 16px 16px; padding:10px 16px; background:rgba(0,0,0,0.04); border-radius:999px; border:1px solid rgba(0,0,0,0.08);">
    <span style="color:#333; font-size:14px; font-weight:600;"><span id="sMealTimeRange">â€“</span></span>
  </div>
  
  <div class="sheet-body" style="background:transparent; padding:16px;">
    <!-- Gerichtsname: fett und groÃŸ -->
    <div style="margin-top:0; margin-bottom:4px;">
      <div style="font-weight:900; font-size:22px; line-height:1.3; color:#1a1a1a;" id="sDish"></div>
    </div>
    <!-- Preis (aus Overlay hier in Details) -->
    <div id="sPriceRow" style="margin-bottom:12px; font-size:18px; font-weight:800; color:var(--brand);"></div>
    <!-- Anbieter (klickbar) -->
    <div style="margin-bottom:12px;">
      <button type="button" id="sProviderNameBtn" style="display:flex; align-items:center; gap:8px; background:none; border:none; padding:0; cursor:pointer; text-align:left; width:100%; color:inherit;">
        <i data-lucide="store" style="width:18px;height:18px; color:var(--brand); flex-shrink:0;"></i>
        <span id="sProviderName" style="font-weight:700; font-size:16px; color:#1a1a1a;"></span>
        <i data-lucide="chevron-right" style="width:16px;height:16px; color:#666; margin-left:auto;"></i>
      </button>
    </div>

    <!-- Logistik: Klickbare Kacheln ðŸš¶ FuÃŸweg & ðŸš— Fahrtweg (Ã¶ffnen Route in Google Maps), ohne blaue Link-Optik -->
    <div id="sDistanceInfo" style="display:none; margin-bottom:12px; gap:10px; flex-wrap:wrap; align-items:stretch;">
      <!-- Wird dynamisch: zwei Kacheln, je onclick â†’ Google Maps -->
    </div>

    <!-- Anbieter-Adresse (direkt unter Logistik-Kacheln) -->
    <div id="sProviderAddressRow" style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
      <i data-lucide="map-pin" style="width:16px;height:16px; color:#666;"></i>
      <span id="sProviderAddress" style="color:#555; font-size:14px; flex:1;"></span>
    </div>

    <!-- Allergene: KÃ¼rzel (A, C, G...) zwingend direkt unter Adresse, (â“˜) Ã¶ffnet Overlay mit ErklÃ¤rungen -->
    <div id="sAllergensWrap" style="margin-bottom:16px; padding:10px 14px; background:rgba(0,0,0,0.04); border-radius:12px; border:1px solid rgba(0,0,0,0.08); display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
      <span id="sAllergensCodes" style="color:#333; font-size:14px; font-weight:600;">â€“</span>
      <button type="button" onclick="showAllergensOverlay();" aria-label="Allergen-Legende" style="background:none; border:none; padding:0; cursor:pointer; font-size:16px; color:#666; line-height:1;" onmouseover="this.style.color='#1a1a1a';" onmouseout="this.style.color='#666';">â“˜</button>
    </div>
    <div id="sAllergensList" style="display:none;"><div id="sAllergens"></div></div>

    <!-- Sticky Bottom: Gelber CTA â€žIn die Mittagsbox legenâ€œ + Warnhinweis darunter -->
    <div style="position:sticky; bottom:0; background:transparent; padding:16px 0 24px; margin-top:24px; border-top:1px solid rgba(0,0,0,0.08); z-index:10;">
      <button class="btn-primary" type="button" id="btnPrimaryCTA" style="width:100%; min-height:56px; max-height:64px; background:#FFD700; color:#1a1a1a; font-weight:800; font-size:18px; border:none; border-radius:16px; box-shadow:0 4px 16px rgba(255,215,0,0.4); display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.2s ease;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 6px 20px rgba(255,215,0,0.5)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 16px rgba(255,215,0,0.4)';">
        <i data-lucide="shopping-basket" style="width:22px;height:22px;"></i>
        <span id="btnPrimaryCTAText">In die Mittagsbox legen</span>
      </button>
      <div id="sInfoHint" style="display:none; margin-top:8px; text-align:center; font-size:12px; color:#666; padding:0 16px; line-height:1.4;"></div>
    </div>
  </div>
</div>

<!-- Provider offer sheet -->
<div class="backdrop" id="pbd" onclick="closeProviderSheet()"></div>
<div class="sheet" id="psheet">
  <div class="handle"></div>
  <div class="sheet-body">
    <div id="pPreview"></div>
    <div class="row"><span>Status</span><b id="pStatus"></b></div>
    <div class="row"><span>Essenszeit</span><b id="pWindow"></b></div>
    <button class="btn" type="button" id="btnEditOffer" data-icon="edit">Bearbeiten</button>
    <button class="btn" type="button" id="btnToggleOffer" data-icon="action" style="background:var(--brand); color:#2D3436; font-weight:900;">Noch da</button>
    <button class="btn ghost" type="button" id="btnShareOffer" data-icon="share">Teilen</button>
    <button class="btn ghost" type="button" id="btnPrintOffer" data-icon="print">Drucken</button>
  </div>
</div>

<!-- Abholnummer (bildschirmfÃ¼llend) -->
<div class="backdrop" id="codeBd" onclick="closeCodeSheet()"></div>
<div class="quick-ticket" id="codeSheet">
  <button class="quick-ticket-close" onclick="closeCodeSheet()" aria-label="SchlieÃŸen">
    <i data-lucide="x"></i>
  </button>
  <div class="quick-ticket-content">
    <div class="quick-ticket-header">
      <div class="quick-ticket-logo" id="codeProviderLogo"></div>
      <div class="quick-ticket-provider" id="codeProvider">Anbieter</div>
      <div class="quick-ticket-time" id="codePickupWindow">Essenszeit: â€“</div>
    </div>
    <div class="quick-ticket-code">
      <div class="quick-ticket-code-label">Abholnummer</div>
      <div class="quick-ticket-code-value" id="codeText">A1</div>
    </div>
    <div class="quick-ticket-details">
      <div class="quick-ticket-detail-item">
        <div class="quick-ticket-detail-label">Gericht</div>
        <div class="quick-ticket-detail-value" id="codeSummary">â€“</div>
      </div>
      <div class="quick-ticket-detail-item">
        <div class="quick-ticket-detail-label">Abholzeit</div>
        <div class="quick-ticket-detail-value" id="codePickupTime">offen</div>
      </div>
    </div>
    <div class="quick-ticket-status" id="codeStatus">Status: offen</div>
    <div class="quick-ticket-actions">
      <button class="btn" type="button" id="btnToggleOrderStatus">Als abgeholt markieren</button>
    </div>
  </div>
</div>

<!-- Bestelldetail-Sheet (fÃ¼r Bestellungen ohne Abholnummer oder Ãœbersicht) -->
<div class="backdrop" id="orderDetailBd" onclick="closeOrderDetailSheet()"></div>
<div class="sheet" id="orderDetailSheet" style="max-width:420px; border-radius:24px; overflow:hidden;">
  <div class="handle"></div>
  <div class="sheet-body" style="padding:24px;">
    <div style="font-family:'Nunito',sans-serif; font-weight:800; font-size:18px; margin-bottom:20px; color:#1a1a1a;">Bestelldetails</div>
    <div id="orderDetailContent" style="display:flex; flex-direction:column; gap:14px; font-size:15px;">
      <!-- Wird dynamisch befÃ¼llt -->
    </div>
    <div id="orderDetailAbholnummerBlock" style="margin-top:20px; padding:16px; background:rgba(255,215,0,0.12); border-radius:16px; border:1px solid rgba(255,215,0,0.3); display:none;">
      <div style="font-weight:800; font-size:14px; margin-bottom:8px; color:#1a1a1a;">ðŸ§¾ Abholnummer</div>
      <div id="orderDetailCode" style="font-family:monospace; font-size:22px; font-weight:900; letter-spacing:2px; color:#1a1a1a; margin-bottom:12px;">â€“</div>
      <button type="button" id="btnOrderDetailShowCode" class="btn-primary" style="width:100%; min-height:48px; font-weight:800; border-radius:14px; background:#FFD700; color:#1a1a1a; border:none;">Abholnummer vorzeigen</button>
    </div>
    <button type="button" onclick="closeOrderDetailSheet()" style="margin-top:20px; width:100%; padding:14px; font-size:15px; font-weight:600; color:#64748b; background:transparent; border:1px solid rgba(0,0,0,.1); border-radius:14px; cursor:pointer;">SchlieÃŸen</button>
  </div>
</div>

<!-- Legal Sheets (Impressum, AGB, Datenschutz) -->
<div class="backdrop" id="legalBd" onclick="closeLegalSheet()"></div>
<!-- AGB Onboarding Modal (1-Screen) -->
<div class="backdrop" id="agbOnboardingBd" onclick="closeAgbOnboardingModal()"></div>
<div class="sheet" id="agbOnboardingSheet">
  <div class="handle"></div>
  <div class="sheet-body" style="padding:24px;">
    <div id="agbOnboardingContent">
      <!-- Wird dynamisch befÃ¼llt -->
    </div>
    <div style="display:flex; gap:12px; margin-top:20px;">
      <button class="btn" type="button" id="btnAgbOnboardingAccept" style="flex:1; min-height:56px;">
        Akzeptieren
      </button>
      <button class="btn secondary" type="button" id="btnAgbOnboardingCancel" style="flex:1; min-height:56px;">
        Abbrechen
      </button>
    </div>
  </div>
</div>

<div class="sheet" id="legalSheet">
  <div class="handle"></div>
  <div class="sheet-body" style="max-height:80vh; overflow-y:auto;">
    <div class="panel" id="legalContent">
      <!-- Wird dynamisch befÃ¼llt -->
    </div>
  </div>
</div>

<!-- FAQ Sheet (Alle Fragen) -->
<div class="backdrop" id="faqBd" onclick="closeFaqSheet()"></div>
<div class="sheet" id="faqSheet">
  <div class="handle"></div>
  <div class="sheet-body" style="max-height:85vh; overflow-y:auto; padding:16px;">
    <div style="font-weight:600; font-size:18px; margin-bottom:16px; line-height:1.3;">HÃ¤ufige Fragen</div>
    <div class="faq" id="faqSheetContent">
      <!-- Wird dynamisch befÃ¼llt -->
    </div>
  </div>
</div>

<!-- Pickup Detail Sheet (Sammel-Ansicht: Abholnummer + Gerichte + Vor Ort/Mehrweg + Alles Ã¼bergeben) -->
<div class="backdrop" id="pickupConfirmBd" onclick="closePickupConfirmSheet()"></div>
<div class="sheet" id="pickupConfirmSheet">
  <div class="handle"></div>
  <div class="sheet-body" style="padding:24px;">
    <div style="font-weight:700; font-size:14px; color:var(--muted); margin-bottom:4px;">Abholnummer</div>
    <div style="font-size:40px; font-weight:900; font-family:monospace; color:var(--brand); margin-bottom:8px; line-height:1;" id="pickupConfirmCode">#â€“</div>
    <div id="pickupConfirmIcons" style="display:flex; align-items:center; gap:10px; margin-bottom:20px; font-size:18px;">
      <span title="Vor Ort">ðŸ´</span><span title="Mehrweg">ðŸ”„</span><span title="Abholnummer">ðŸ§¾</span>
    </div>
    <div style="font-weight:700; font-size:15px; margin-bottom:10px; color:#1a1a1a;">Bestellte Gerichte</div>
    <div id="pickupConfirmDishes" style="display:flex; flex-direction:column; gap:10px; margin-bottom:24px;">
      <!-- Pro Gericht: Name + ðŸ´ Vor Ort oder ðŸ”„ Mehrweg + Extras -->
    </div>
    <div style="display:flex; flex-direction:column; gap:12px;">
      <button class="btn" type="button" id="btnPickupConfirmYes" style="width:100%; min-height:56px; font-size:16px; font-weight:800; background:#2e7d32; color:#fff; border:none;">
        Alles Ã¼bergeben &amp; Abgeholt
      </button>
      <button class="btn secondary" type="button" id="btnPickupConfirmNo" style="width:100%; min-height:50px; font-size:16px;">
        Abbrechen
      </button>
    </div>
  </div>
</div>
<!-- Erfolgs-Screen (nach Alles Ã¼bergeben) -->
<div id="pickupSuccessOverlay" style="display:none; position:fixed; inset:0; background:rgba(34,139,34,0.95); z-index:9999; align-items:center; justify-content:center; flex-direction:column; padding:24px;">
  <div style="font-size:64px; margin-bottom:16px;">âœ…</div>
  <div style="font-size:28px; font-weight:900; color:#fff; margin-bottom:8px;">Erfolgreich abgeholt!</div>
  <div id="pickupSuccessNetto" style="font-size:20px; font-weight:700; color:rgba(255,255,255,0.95);">Netto-Verdienst: 0,00 â‚¬</div>
  <button type="button" id="btnPickupSuccessUndo" style="margin-top:24px; padding:10px 20px; background:rgba(255,255,255,0.2); color:#fff; border:1px solid rgba(255,255,255,0.5); border-radius:12px; font-size:14px; font-weight:600; cursor:pointer;">Versehentlich? RÃ¼ckgÃ¤ngig</button>
</div>
<!-- Next-Step Popup (nÃ¤chste Abholnummern) -->
<div id="pickupNextStepOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:10000; align-items:center; justify-content:center; padding:24px;">
  <div style="background:#fff; border-radius:24px; padding:24px; max-width:360px; width:100%; box-shadow:0 8px 32px rgba(0,0,0,0.2);">
    <div id="pickupNextStepTitle" style="font-size:20px; font-weight:800; margin-bottom:16px; color:#1a1a1a;">ðŸŽ‰ Noch 0 Essen offen!</div>
    <div id="pickupNextStepList" style="display:flex; flex-direction:column; gap:10px; margin-bottom:20px;"></div>
    <button type="button" id="btnPickupNextStepUndo" style="width:100%; margin-bottom:10px; padding:12px; border-radius:14px; border:1px solid #e2e8f0; background:#f8fafc; font-size:14px; font-weight:600; color:#64748b; cursor:pointer;">Zuletzt rÃ¼ckgÃ¤ngig (versehentlich abgeholt)</button>
    <button type="button" id="btnPickupNextStepClose" style="width:100%; padding:14px; border-radius:14px; border:2px solid rgba(0,0,0,.1); background:#fff; font-weight:700; font-size:15px; cursor:pointer;">Fertig</button>
  </div>
</div>

<!-- Profil anlegen Sheet (Kunde) -->
<div class="backdrop" id="profileCreateBd" onclick="closeProfileCreateSheet()"></div>
<div class="sheet" id="profileCreateSheet" style="max-width:420px; border-radius:24px; overflow:hidden;">
  <div class="handle"></div>
  <div class="sheet-body" style="padding:24px;">
    <div style="text-align:center; margin-bottom:20px;">
      <div style="width:56px; height:56px; margin:0 auto 12px; background:linear-gradient(135deg, rgba(255,215,0,0.2) 0%, rgba(255,184,0,0.1) 100%); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:28px;">ðŸ‘¤</div>
      <h3 style="margin:0 0 6px; font-size:20px; font-weight:900; color:#2D3436;">Profil anlegen</h3>
      <p class="hint" style="font-size:14px; color:#666; line-height:1.4;">Bestelle schneller und finde deine Abholnummern wieder.</p>
    </div>
    <div style="display:flex; flex-direction:column; gap:14px;">
      <label style="font-size:13px; font-weight:600; color:#64748b;">Name (optional)</label>
      <input class="field" id="profileCreateName" type="text" placeholder="z.B. Max" autocomplete="name" style="width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border); font-size:16px; background:#fbfaf7;" />
      <label style="font-size:13px; font-weight:600; color:#64748b;">E-Mail-Adresse <span style="color:#e74c3c;">*</span></label>
      <input class="field" id="profileCreateEmail" type="email" placeholder="deine@email.de" autocomplete="email" style="width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border); font-size:16px; background:#fbfaf7;" />
      <button class="btn-primary" type="button" id="btnProfileCreateSubmit" style="width:100%; min-height:48px; font-size:16px; font-weight:700; margin-top:8px;">Profil anlegen</button>
      <button class="btn ghost" type="button" id="btnProfileCreateCancel" style="width:100%; min-height:44px;">Abbrechen</button>
    </div>
  </div>
</div>

<!-- Login Modal (Bottom Sheet) -->
<div class="backdrop" id="loginBd" onclick="closeLoginSheet()"></div>
<div class="sheet" id="loginSheet">
  <div class="handle"></div>
  <div class="sheet-body">
    <div class="panel">
      <h3 style="margin:0 0 8px;">Anmelden</h3>
      <div class="hint" style="margin-bottom:20px;">Melde dich an, um Abholnummer zu sichern</div>
      <input class="field" id="loginModalEmail" type="email" placeholder="E-Mail" autocomplete="email" />
      <div style="height:10px"></div>
      <input class="field" id="loginModalPass" type="password" placeholder="Passwort" autocomplete="current-password" />
      <button class="btn" type="button" id="btnLoginModalLogin" style="margin-top:16px; width:100%;">Anmelden</button>
      <div style="margin-top:12px; text-align:center;">
        <button class="btn ghost" type="button" id="btnLoginModalDemo" style="width:auto; padding:8px 16px;">Demo-Login (ohne Anmeldung)</button>
      </div>
    </div>
  </div>
</div>

<!-- Provider Login Modal (Business-Login) -->
<div class="backdrop" id="providerLoginBd" onclick="closeProviderLoginModal()" style="background:rgba(0,0,0,0.7); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); display:none;"></div>
<div class="sheet" id="providerLoginSheet" style="max-width:420px; border-radius:24px; overflow:hidden; display:none;">
  <div class="sheet-body" style="padding:32px;">
    <div style="text-align:center; margin-bottom:24px;">
      <div style="width:64px; height:64px; margin:0 auto 16px; background:linear-gradient(135deg, rgba(255,204,0,0.2) 0%, rgba(255,184,0,0.1) 100%); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:32px;">
        ðŸª
      </div>
      <h3 style="margin:0 0 8px; font-size:24px; font-weight:900; color:#2D3436;">MITTAGIO Business</h3>
      <p class="hint" style="font-size:14px; color:#666; line-height:1.5;">Dein Mittagessen anbieten â€“ einfach und digital.</p>
    </div>
    <div style="display:flex; flex-direction:column; gap:16px;">
      <input class="field" id="providerLoginEmail" type="email" placeholder="E-Mail-Adresse" autocomplete="email" style="width:100%; padding:14px 16px; border-radius:14px; border:1px solid var(--border); font-size:16px; background:#fbfaf7;" />
      <input class="field" id="providerLoginPass" type="password" placeholder="Passwort" autocomplete="current-password" style="width:100%; padding:14px 16px; border-radius:14px; border:1px solid var(--border); font-size:16px; background:#fbfaf7;" />
      <button class="btn-primary" type="button" id="btnProviderLoginModal" style="width:100%; min-height:52px; font-size:16px; font-weight:700; margin-top:8px; background:linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); color:#fff; border:none;">
        <i data-lucide="log-in" style="width:20px;height:20px;"></i>
        <span>Einloggen</span>
      </button>
      <button class="btn ghost" type="button" onclick="closeProviderLoginModal();" style="width:100%; min-height:44px;">
        Abbrechen
      </button>
    </div>
    <div class="hint" style="margin-top:20px; padding:12px; background:rgba(255,204,0,0.08); border-radius:12px; font-size:12px; color:#666; line-height:1.5; text-align:center;">
      Demo: Beliebige E-Mail/Passwort â†’ du bist drin.<br>(SpÃ¤ter: Firebase Auth)
    </div>
  </div>
</div>

<!-- Share sheet (MVP: nur WhatsApp + E-Mail) -->
<div class="backdrop" id="shareBd" onclick="closeShareSheet()"></div>
<div class="sheet" id="shareSheet">
  <div class="handle"></div>
  <div class="sheet-body">
    <div class="panel">
      <div style="font-weight:900; font-size:18px;">Inserat teilen</div>
      <div class="hint" id="shareSheetSubtitle" style="margin-top:4px;">
        <!-- Wird dynamisch befÃ¼llt -->
      </div>
    </div>
    <div class="answers" style="margin-top:16px;">
      <button class="ans" type="button" id="btnShareWhatsApp">
        <i data-lucide="message-circle"></i><span>WhatsApp</span>
      </button>
      <button class="ans" type="button" id="btnShareInstagram">
        <i data-lucide="share-2"></i><span>Instagram</span>
      </button>
      <button class="ans" type="button" id="btnShareCopy">
        <i data-lucide="copy"></i><span>Link kopieren</span>
      </button>
    </div>
  </div>
</div>

<!-- Create Flow Sheet (Gericht hinzufÃ¼gen) â€“ KÃ¼chenmodus -->
<div class="backdrop" id="createFlowBd" onclick="closeCreateFlowSheet()"></div>
<div class="sheet sheet--kitchen" id="createFlowSheet">
  <div class="handle"></div>
  <div class="sheet-body">
    <div class="create-flow-title">Gericht hinzufÃ¼gen</div>
    <div class="create-flow-btns">
      <button class="btn-create-primary" type="button" id="btnCreateNewDish">
        <span>âž•</span>
        <span>Neues Gericht erstellen</span>
      </button>
      <button class="btn-create-secondary" type="button" id="btnCreateFromCookbook">
        <span>ðŸ“–</span>
        <span>Aus Kochbuch auswÃ¤hlen</span>
      </button>
    </div>
    <div class="create-flow-hint hint" id="createFlowDateHint" style="display:none;"></div>
  </div>
</div>

<!-- Snackbar: Undo pickup -->
<div class="snackbar" id="pickupUndo">
  <span id="pickupUndoLabel">Abholung markiert</span>
  <button type="button" id="pickupUndoBtn">RÃ¼ckgÃ¤ngig</button>
</div>

<!-- Print view -->
<div id="printView" class="print-view"></div>

<!-- Provider Wizard sheet (single reusable) â€“ KÃ¼chenmodus -->
<div class="backdrop" id="wbd" onclick="closeWizard()"></div>
<div class="sheet sheet--kitchen" id="wizard">
  <div class="handle"></div>
  <div class="sheet-body wizard-sheet-body">
    <div class="wizard" id="wBox">
      <div class="wizard-progress-dots" id="wizardProgressDots" aria-hidden="true"></div>
      <div class="wizard-scroll">
        <div class="w-top">
          <div class="w-title" id="wTitle">Setup</div>
          <div class="w-step" id="wStep">Schritt 1 von 5</div>
        </div>
        <div class="w-q" id="wQ">â€¦</div>
        <p class="w-help" id="wHelp"></p>
        <div id="wContent"></div>
      </div>
      <div class="w-actions">
        <button class="btn secondary" type="button" id="wBack">ZurÃ¼ck</button>
        <button class="btn" type="button" id="wNext">Weiter</button>
      </div>
      <div class="wizard-footer" id="wizardFooter">Standort: Schorndorf (Zentrum)</div>
    </div>
  </div>
</div>

<!-- Login-Konflikt Modal (Ein-GerÃ¤t-Schranke) -->
<div class="backdrop" id="loginConflictBd" onclick="closeLoginConflictModal()" style="background:rgba(0,0,0,0.7); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); display:none;"></div>
<div class="sheet" id="loginConflictSheet" style="max-width:420px; border-radius:24px; overflow:hidden; display:none;">
  <div class="handle"></div>
  <div class="sheet-body" style="padding:24px;">
    <div style="text-align:center; margin-bottom:24px;">
      <div style="width:64px; height:64px; margin:0 auto 16px; background:linear-gradient(135deg, rgba(227,77,77,0.1) 0%, rgba(255,215,0,0.08) 100%); border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px solid rgba(227,77,77,0.3);">
        <i data-lucide="smartphone" style="width:32px;height:32px; color:#E34D4D;"></i>
      </div>
      <h2 style="margin:0 0 8px; font-size:24px; font-weight:900; color:#2D3436;">Anderes GerÃ¤t aktiv</h2>
      <p style="margin:0; font-size:15px; color:#666; line-height:1.5;">
        Du bist aktuell bereits auf einem anderen GerÃ¤t (z.B. Tablet Kasse) angemeldet. Mittagio unterstÃ¼tzt im Standard-Plan eine aktive Sitzung zur Zeit.
      </p>
    </div>
    
    <div style="display:flex; flex-direction:column; gap:12px; margin-bottom:20px;">
      <button class="btn" type="button" id="btnLoginConflictTakeover" style="width:100%; min-height:52px; background:#E34D4D; color:#fff; font-weight:800; border:none; border-radius:12px;">
        <i data-lucide="check-circle" style="width:20px;height:20px; margin-right:8px;"></i>
        Diesen Account hier nutzen
      </button>
      <button class="btn ghost" type="button" onclick="closeLoginConflictModal()" style="width:100%; min-height:44px;">
        Abbrechen
      </button>
    </div>
    
    <div style="padding-top:16px; border-top:1px solid #eee; text-align:center;">
      <p style="margin:0; font-size:12px; color:#666; line-height:1.5;">
        Du mÃ¶chtest KÃ¼che und Kasse gleichzeitig vernetzen?<br>
        <a href="mailto:support@mittagio.de" style="color:#E34D4D; text-decoration:none; font-weight:600;">Melde dich bei Mike fÃ¼r das Team-Upgrade.</a>
      </p>
    </div>
  </div>
</div>

<!-- Support-Kontakt Sheet (Layout = Vorlage fÃ¼r Anbieter + Inseratsflow) -->
<div class="backdrop" id="supportContactBd" onclick="closeSupportContact()" style="background:rgba(0,0,0,0.7); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);"></div>
<div class="sheet" id="supportContactSheet">
  <div class="handle"></div>
  <div class="sheet-body support-layout-body" style="padding:24px;">
    <div style="margin-bottom:24px;">
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
        <i data-lucide="heart" style="width:28px;height:28px; color:#E34D4D;"></i>
        <h2 style="margin:0; font-size:24px; font-weight:900; color:#2D3436;">Support & Hilfe</h2>
      </div>
      <p style="margin:0; font-size:14px; color:#666; line-height:1.5;">
        Egal ob Fragen zur Abholnummer oder Feedback zur App â€“ Mike freut sich auf deine Nachricht.
      </p>
    </div>
    
    <!-- 24h-Antwort-Garantie Badge -->
    <div class="support-style-badge" style="padding:16px; background:linear-gradient(135deg, rgba(46,204,113,0.1) 0%, rgba(39,174,96,0.08) 100%); border:2px solid rgba(46,204,113,0.3); border-radius:12px; margin-bottom:24px; text-align:center;">
      <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:8px;">
        <i data-lucide="clock" style="width:20px;height:20px; color:#2ECC71;"></i>
        <div style="font-weight:900; font-size:16px; color:#2ECC71;">24h-Antwort-Garantie</div>
      </div>
      <div style="font-size:13px; color:#666; line-height:1.5;">
        Wir schauen uns dein Anliegen sofort an und melden uns innerhalb der nÃ¤chsten 24 Stunden persÃ¶nlich bei dir.
      </div>
    </div>
    
    <!-- Themen-Auswahl -->
    <div style="margin-bottom:24px;">
      <div style="font-weight:700; font-size:15px; color:#2D3436; margin-bottom:12px;">Worum geht es?</div>
      <div style="display:flex; flex-direction:column; gap:12px;">
        <button class="btn secondary support-style-btn" type="button" onclick="selectSupportTopic('technik')" id="supportTopicTechnik" style="justify-content:flex-start; padding:16px; text-align:left; background:#fff; border:2px solid #e5e7eb; border-radius:12px;">
          <div style="display:flex; align-items:center; gap:12px; width:100%;">
            <i data-lucide="settings" style="width:24px;height:24px; color:#334155; flex-shrink:0;"></i>
            <div style="flex:1;">
              <div style="font-weight:700; font-size:15px; color:#2D3436; margin-bottom:4px;">Technik & App</div>
              <div style="font-size:12px; color:#666;">Probleme mit dem KÃ¼chenmodus, Abholnummern oder der App</div>
            </div>
          </div>
        </button>
        
        <button class="btn secondary support-style-btn" type="button" onclick="selectSupportTopic('abrechnung')" id="supportTopicAbrechnung" style="justify-content:flex-start; padding:16px; text-align:left; background:#fff; border:2px solid #e5e7eb; border-radius:12px;">
          <div style="display:flex; align-items:center; gap:12px; width:100%;">
            <i data-lucide="wallet" style="width:24px;height:24px; color:#334155; flex-shrink:0;"></i>
            <div style="flex:1;">
              <div style="font-weight:700; font-size:15px; color:#2D3436; margin-bottom:4px;">Abrechnung & Zahlung</div>
              <div style="font-size:12px; color:#666;">Fragen zu GebÃ¼hren, Auszahlungen oder Rechnungen</div>
            </div>
          </div>
        </button>
        
        <button class="btn secondary support-style-btn" type="button" onclick="selectSupportTopic('feedback')" id="supportTopicFeedback" style="justify-content:flex-start; padding:16px; text-align:left; background:#fff; border:2px solid #e5e7eb; border-radius:12px;">
          <div style="display:flex; align-items:center; gap:12px; width:100%;">
            <i data-lucide="message-square" style="width:24px;height:24px; color:#334155; flex-shrink:0;"></i>
            <div style="flex:1;">
              <div style="font-weight:700; font-size:15px; color:#2D3436; margin-bottom:4px;">Feedback & Ideen</div>
              <div style="font-size:12px; color:#666;">VorschlÃ¤ge zur Verbesserung oder Lob</div>
            </div>
          </div>
        </button>
      </div>
    </div>
    
    <!-- Kontaktformular (wird nach Themen-Auswahl angezeigt) -->
    <div id="supportContactForm" style="display:none;">
      <div style="margin-bottom:16px;">
        <label style="display:block; font-weight:600; font-size:14px; color:#2D3436; margin-bottom:8px;">Deine Nachricht</label>
        <textarea id="supportContactMessage" placeholder="Beschreibe dein Anliegen..." style="width:100%; min-height:120px; padding:12px 16px; border-radius:12px; border:1px solid #ddd; font-size:15px; font-family:inherit; resize:vertical;" rows="5"></textarea>
      </div>
      
      <button class="btn support-style-primary" type="button" onclick="submitSupportContact()" style="width:100%; min-height:52px; background:#E34D4D; color:#fff; font-weight:800; border:none; border-radius:12px;">
        <i data-lucide="send" style="width:20px;height:20px; margin-right:8px;"></i>
        Nachricht senden
      </button>
    </div>
    
    <button class="btn ghost support-style-btn" type="button" onclick="closeSupportContact()" style="width:100%; margin-top:16px; border:2px solid #e5e7eb; border-radius:12px;">Abbrechen</button>
  </div>
</div>

<script>
  // --- Storage keys ---
  const LS = {
    offers: 'mittagio_offers_v2',
    favs: 'mittagio_favs_v1',
    providerFavs: 'mittagio_provider_favs_v1',
    dishFavs: 'mittagio_dish_favs_v1',
    cart: 'mittagio_cart_v1',
    orders: 'mittagio_orders_v1',
    customer: 'mittagio_customer_v1',
    provider: 'mittagio_provider_v1',
    cookbook: 'mittagio_cookbook_v1',
    week: 'mittagio_week_v1',
    onboardingDraft: 'mittagio_onboarding_draft_v1',
    pickupDone: 'mittagio_pickup_done_v1',
    mode: 'mittagio_mode_v1',
    discoverView: 'mittagio_discover_view_v1',
    orderHistory: 'mittagio_order_history_v1',
    swipeOnboardingShown: 'mittagio_swipe_onboarding_shown_v1',
    providerSession: 'mittagio_provider_session_v1',
    favPillars: 'mittagio_fav_pillars_v1' // { [dishId]: { vorOrt, abholnummer, mehrweg } } â€“ 3-SÃ¤ulen beim Favorisieren einfrieren
  };
  const load = (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch { return d; } };
  const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

  function getFavPillars(dishId){ const m = load(LS.favPillars, {}); return m[dishId] || null; }
  function setFavPillars(dishId, pillars){ const m = load(LS.favPillars, {}); m[dishId] = pillars; save(LS.favPillars, m); }
  function renderPillarBars(vorOrt, abholnummer, mehrweg){
    // Hochwertige, app-like Icons mit Labels (statt Balken)
    // Design: Runde Badges mit Icon + Text darunter, horizontal angeordnet
    
    const styleBadge = (active, color) => `
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
      opacity:${active ? '1' : '0.4'}; filter:${active ? 'none' : 'grayscale(100%)'};
      transition:all 0.2s ease;
    `;
    
    const styleIcon = (color) => `
      width:36px; height:36px; border-radius:50%; background:${color}15; color:${color};
      display:flex; align-items:center; justify-content:center; border:1px solid ${color}30;
    `;
    
    const styleText = `font-size:10px; font-weight:600; color:#333; text-align:center; line-height:1.2; max-width:60px;`;

    return `
      <div style="display:flex; justify-content:center; gap:24px; padding:8px 0;">
        <!-- Vor Ort -->
        <div style="${styleBadge(vorOrt, '#27AE60')}">
          <div style="${styleIcon('#27AE60')}"><i data-lucide="utensils" style="width:18px;height:18px;"></i></div>
          <div style="${styleText}">Vor Ort</div>
        </div>
        
        <!-- Abholnummer: Aktiv = gelb #FFD700, Inaktiv = ausgegraut opacity 0.2 -->
        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; opacity:${abholnummer ? '1' : '0.2'}; filter:${abholnummer ? 'none' : 'grayscale(100%)'}; transition:all 0.2s ease;">
          <div style="width:36px; height:36px; border-radius:50%; background:${abholnummer ? '#FFD700' : 'rgba(0,0,0,0.08)'}; color:${abholnummer ? '#1a1a1a' : '#999'}; display:flex; align-items:center; justify-content:center; border:1px solid ${abholnummer ? 'rgba(255,215,0,0.6)' : 'rgba(0,0,0,0.1)'};">
            <i data-lucide="ticket" style="width:18px;height:18px;"></i>
          </div>
          <div style="${styleText}">Abholnummer</div>
        </div>
        
        <!-- Mehrweg -->
        <div style="${styleBadge(mehrweg, '#2980B9')}">
          <div style="${styleIcon('#2980B9')}"><i data-lucide="leaf" style="width:18px;height:18px;"></i></div>
          <div style="${styleText}">Mehrweg</div>
        </div>
      </div>
    `;
  }
  /** Favoriten-Mini: Nur Emojis (ðŸ´ ðŸ§¾ ðŸ”„), ðŸ§¾ mit gelbem Kreis wenn aktiv. */
  function renderPillarBarsFavMini(vorOrt, abholnummer, mehrweg){
    const wrap = (emoji, active, highlight) => highlight
      ? `<span class="abholnummer-highlight">${emoji}</span>`
      : `<span class="emoji-icon ${active ? 'active' : ''}">${emoji}</span>`;
    return `
      <div class="saeulen-mini">
        <span class="emoji-icon ${vorOrt ? 'active' : ''}">ðŸ´</span>
        ${wrap('ðŸ§¾', abholnummer, abholnummer)}
        <span class="emoji-icon ${mehrweg ? 'active' : ''}">ðŸ”„</span>
      </div>
    `;
  }
  /** Silicon-Valley Pills: Drei kompakte Status-Pills nebeneinander (ðŸ´ VOR ORT, ðŸ§¾ ABHOLNUMMER, ðŸ”„ MEHRWEG). Inaktiv: #eeeeee + grauer Text. */
  function renderPillarBarsDiscovery(vorOrt, abholnummer, mehrweg){
    const pill = (active, bg, emoji, labelActive, labelInactive) => {
      const bgColor = active ? bg : '#eeeeee';
      const textColor = active ? '#fff' : '#999';
      return `display:inline-flex; align-items:center; justify-content:center; gap:4px; height:24px; max-height:24px; padding:0 10px; border-radius:12px; font-size:11px; font-weight:800; color:${textColor}; letter-spacing:0.02em; white-space:nowrap; background:${bgColor};`;
    };
    return `
      <div class="ocm-pills-row" style="display:flex; flex-wrap:wrap; gap:6px; margin-top:8px;">
        <span style="${pill(vorOrt, '#27AE60', 'ðŸ´', 'VOR ORT', 'Kein Vor Ort')}">ðŸ´ ${vorOrt ? 'VOR ORT' : 'Kein Vor Ort'}</span>
        <span style="${pill(abholnummer, '#FFD700', 'ðŸ§¾', 'ABHOLNUMMER', 'Keine Abholnummer')}">ðŸ§¾ ${abholnummer ? 'ABHOLNUMMER' : 'Keine Abholnummer'}</span>
        <span style="${pill(mehrweg, '#2980B9', 'ðŸ”„', 'MEHRWEG', 'Kein Mehrweg')}">ðŸ”„ ${mehrweg ? 'MEHRWEG' : 'Kein Mehrweg'}</span>
      </div>
    `;
  }
  function clearFavPillars(dishId){ const m = load(LS.favPillars, {}); delete m[dishId]; save(LS.favPillars, m); }

  function renderDiscoverCategories(){
    const bar = document.getElementById('discoverCategoriesBar');
    if(!bar) return;
    
    // Kategorien definieren (User Wunsch: Fleisch, Salat, Veggie, Vegan...)
    const cats = [
      {id:'near', label:'In der NÃ¤he', icon:'map-pin'},
      {id:'Mit Fleisch', label:'Fleisch', icon:'beef'},
      {id:'Salat', label:'Salat', icon:'salad'},
      {id:'Vegetarisch', label:'Vegetarisch', icon:'leaf'},
      {id:'Vegan', label:'Vegan', icon:'sprout'},
      {id:'Fisch', label:'Fisch', icon:'fish'},
      {id:'Suppe', label:'Suppe', icon:'soup'},
    ];
    
    // Aktive Kategorie ermitteln
    const active = activeDiscoverFilter === 'near' || !activeDiscoverFilter || activeDiscoverFilter === 'all' ? 'near' : activeDiscoverFilter;
    
    bar.innerHTML = cats.map(c => `
      <button class="cat-pill ${active===c.id ? 'active' : ''}" onclick="selectDiscoverCategory('${c.id}')">
        <i data-lucide="${c.icon}"></i>
        <span>${c.label}</span>
      </button>
    `).join('');
    
    if(typeof lucide !== 'undefined') lucide.createIcons();
  }
  
  function getDayName(date){
    if(!date) return '';
    return ['So','Mo','Di','Mi','Do','Fr','Sa'][date.getDay()];
  }
  
  function renderDiscoverDays(){
    const bar = document.getElementById('discoverDaysBar');
    if(!bar) return;
    
    // Generiere nÃ¤chste 7 Tage
    const days = [];
    const today = new Date();
    for(let i=0; i<7; i++){
      const d = new Date(today);
      d.setDate(today.getDate() + i);
      const iso = d.toISOString().split('T')[0];
      
      let label = i===0 ? 'Heute' : i===1 ? 'Morgen' : i===2 ? 'Ãœbermorgen' : getDayName(d);
      days.push({ id: iso, label: label, date: d });
    }
    
    // Active Day (Global variable activeDay e.g. "2026-01-30")
    // Falls activeDay nicht gesetzt, nimm Heute
    if(!activeDay) activeDay = days[0].id;
    
    bar.innerHTML = days.map(d => {
      const isToday = activeDay === d.id;
      const dateStr = d.date.getDate() + '.' + (d.date.getMonth() + 1) + '.';
      return `<button class="day-pill ${isToday ? 'day-pill--today' : ''}" onclick="selectDiscoverDay('${d.id}')">
        <span class="day-pill-label">${d.label}</span>
        <span class="day-pill-date">${dateStr}</span>
      </button>`;
    }).join('');
  }
  
  window.selectDiscoverDay = function(dayIso){
    activeDay = dayIso;
    renderDiscoverDays();
    renderDiscover();
  };
  
  window.selectDiscoverCategory = function(catId){
    if(catId === 'near' || catId === 'all'){
      activeDiscoverFilter = 'near';
    } else {
      activeDiscoverFilter = catId;
    }
    renderDiscoverCategories(); // Update active state
    renderDiscover();
  };

  function createModernOfferCard(o){
    const data = normalizeOffer(o);
    const card = document.createElement('div');
    card.className = 'offer-card-modern';
    card.style.cursor = 'pointer';
    
    // PrÃ¼fe ob favorisiert
    const favorites = JSON.parse(localStorage.getItem('mittagio_favorites') || '[]');
    const dishKey = data.id;
    const isFavorited = favorites.includes(dishKey);
    
    // Image Container
    const imageContainer = document.createElement('div');
    imageContainer.className = 'ocm-image-container';
    
    const img = document.createElement('img');
    img.className = 'ocm-image';
    img.src = data.imageUrl || 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=800&q=80';
    img.loading = 'lazy';
    imageContainer.appendChild(img);
    
    // Provider Badge (Klickbar -> Landing Page)
    const providerBadge = document.createElement('div');
    providerBadge.className = 'ocm-provider-badge';
    // User Request: "Sidecom where the provider page Today's inscriptions and his weekly sermons"
    providerBadge.style.cursor = 'pointer';
    providerBadge.onclick = (e) => {
        e.stopPropagation();
        // Setze Filter auf diesen Provider und zeige Discovery (Landing Page Simulation)
        activeDiscoverFilter = 'provider';
        currentProviderFilter = data.providerId;
        renderDiscover();
        showToast(`Zeige alle Angebote von ${data.providerName}`);
    };
    // Logo (Simuliert)
    const logo = document.createElement('div');
    logo.className = 'ocm-provider-logo';
    if(data.providerLogoData){
       logo.innerHTML = `<img src="${data.providerLogoData}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" />`;
    } else {
       logo.innerHTML = `<span style="font-size:10px; font-weight:900; color:#666; display:flex; align-items:center; justify-content:center; width:100%; height:100%;">${(data.providerName||'A').charAt(0)}</span>`;
    }
    providerBadge.appendChild(logo);
    
    const pName = document.createElement('span');
    pName.textContent = data.providerName || 'Anbieter';
    providerBadge.appendChild(pName);
    imageContainer.appendChild(providerBadge);
    
    // Herz-Button (Like)
    const likeBtn = document.createElement('button');
    likeBtn.className = `ocm-like-btn ${isFavorited ? 'active' : ''}`;
    likeBtn.innerHTML = `<i data-lucide="heart" style="width:20px; height:20px; stroke-width:2.5; ${isFavorited ? 'fill:#e74c3c; color:#e74c3c;' : ''}"></i>`;
    
    // Favoriten-Handler
    likeBtn.onclick = (e) => {
        e.stopPropagation();
        e.preventDefault();
        
        // Toggle State
        const favorites = JSON.parse(localStorage.getItem('mittagio_favorites') || '[]');
        const dishKey = data.id;
        const index = favorites.indexOf(dishKey);
        
        if (index > -1) {
            // Entfernen
            favorites.splice(index, 1);
            localStorage.setItem('mittagio_favorites', JSON.stringify(favorites));
            
            // UI Update
            likeBtn.classList.remove('active');
            const icon = likeBtn.querySelector('svg') || likeBtn.querySelector('i'); // Support Lucide SVG or i
            if(icon){
                icon.style.fill = 'none';
                icon.style.color = 'currentColor';
            }
            
            showToast('Aus Favoriten entfernt');
        } else {
            // HinzufÃ¼gen
            favorites.push(dishKey);
            localStorage.setItem('mittagio_favorites', JSON.stringify(favorites));
            if(typeof dishFavs !== 'undefined' && !dishFavs.has(dishKey)){ dishFavs.add(dishKey); save(LS.dishFavs, Array.from(dishFavs)); }
            
            // UI Update
            likeBtn.classList.add('active');
            const icon = likeBtn.querySelector('svg') || likeBtn.querySelector('i');
            if(icon){
                icon.style.fill = '#e74c3c';
                icon.style.color = '#e74c3c';
            }
            
            if(typeof triggerFavoritesIconBounce === 'function') triggerFavoritesIconBounce();
            showToast('Zu Favoriten hinzugefÃ¼gt â¤ï¸');
            if(navigator.vibrate) navigator.vibrate(10);
            
            // Speichere 3-SÃ¤ulen Status
            const offerProvider = offers.find(p => p.providerId === data.providerId);
            const vorOrt = !!(offerProvider && (offerProvider.dineInPossible !== false || data.dineInPossible));
            const abholnummer = !!(offerProvider && (offerProvider.orderingEnabled !== false && (data.hasPickupCode || offerProvider.hasPickupCode)));
            const mehrweg = !!(offerProvider && (offerProvider.reuseEnabled || offerProvider.reuse));
            if(typeof setFavPillars === 'function') setFavPillars(dishKey, { vorOrt, abholnummer, mehrweg });
        }
    };
    
    imageContainer.appendChild(likeBtn);
    
    // Price Tag
    const priceTag = document.createElement('div');
    priceTag.className = 'ocm-price-tag';
    priceTag.textContent = euro(data.price);
    imageContainer.appendChild(priceTag);
    
    card.appendChild(imageContainer);
    
    // Content
    const body = document.createElement('div');
    body.className = 'ocm-content';
    
    const title = document.createElement('h3');
    title.className = 'ocm-title';
    title.textContent = data.dish || 'Gericht';
    body.appendChild(title);
    
    // 3 SÃ¤ulen als High-Contrast-Balken
    const stored = typeof getFavPillars === 'function' ? getFavPillars(dishKey) : null;
    const vorOrt = stored ? !!stored.vorOrt : (() => { const p = offers.find(x => x.providerId === data.providerId); return !!(p && (p.dineInPossible !== false || data.dineInPossible)); })();
    const abholnummer = stored ? !!stored.abholnummer : (() => { const p = offers.find(x => x.providerId === data.providerId); return !!(p && (p.orderingEnabled !== false && (data.hasPickupCode || p.hasPickupCode))); })();
    const mehrweg = stored ? !!stored.mehrweg : (() => { const p = offers.find(x => x.providerId === data.providerId); return !!(p && (p.reuse && p.reuse.enabled)); })();
    
    const barsWrap = document.createElement('div');
    barsWrap.style.cssText = 'padding:0 4px 0 0;';
    barsWrap.innerHTML = renderPillarBarsDiscovery(vorOrt, abholnummer, mehrweg);
    body.appendChild(barsWrap);
    
    // Gelber CTA: "In die Mittagsbox" (nur wenn Abholnummer)
    const ctaWrap = document.createElement('div');
    ctaWrap.style.cssText = 'padding:12px 16px 0;';
    const ctaBtn = document.createElement('button');
    ctaBtn.type = 'button';
    ctaBtn.className = 'btn';
    ctaBtn.style.cssText = 'width:100%; min-height:44px; border-radius:12px; background:#FFD700; color:#1a1a1a; font-weight:800; font-size:14px; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; transition:transform 0.2s, box-shadow 0.2s;';
    ctaBtn.innerHTML = (typeof iconMarkup === 'function' ? iconMarkup('shopping-basket') : '') + ' <span>In die Mittagsbox</span>';
    ctaBtn.onmouseover = () => { ctaBtn.style.transform = 'scale(1.02)'; ctaBtn.style.boxShadow = '0 4px 12px rgba(255,215,0,0.4)'; };
    ctaBtn.onmouseout = () => { ctaBtn.style.transform = 'scale(1)'; ctaBtn.style.boxShadow = 'none'; };
    ctaBtn.onclick = (e) => {
      e.stopPropagation();
      e.preventDefault();
      if(!abholnummer){ showToast('Keine Abholnummer â€“ nur ansehen.', 2000); return; }
      const thumb = card.querySelector('img');
      flyThumbnailToMittagsbox(thumb, () => {
        if(!addToCart(o)){ showToast('Fehler beim HinzufÃ¼gen.', 2000); return; }
        triggerHapticFeedback([20]);
        if(typeof triggerCartIconGlow === 'function') triggerCartIconGlow();
        showToast('In die Mittagsbox gelegt', 1500);
        if(typeof updateHeaderBasket === 'function') updateHeaderBasket();
      });
    };
    if(!abholnummer){ ctaBtn.style.background = '#e5e5e5'; ctaBtn.style.color = '#888'; ctaBtn.style.cursor = 'not-allowed'; ctaBtn.disabled = true; }
    ctaWrap.appendChild(ctaBtn);
    body.appendChild(ctaWrap);
    
    // Entfernungsangaben (ðŸš¶/ðŸš—) dezent ganz unten
    if(data.distanceKm != null){
      const walkingMinutes = Math.round(Number(data.distanceKm) * 12);
      const carMinutes = Math.round(Number(data.distanceKm) * 1.5);
      const walkingMeters = Math.round(Number(data.distanceKm) * 1000);
      const distanceText = walkingMeters < 1000 ? walkingMeters + 'm' : Number(data.distanceKm).toFixed(1) + 'km';
      const mobilityRow = document.createElement('div');
      mobilityRow.style.cssText = 'margin-top:12px; padding:8px 16px 0; font-size:11px; color:#999; font-weight:500; display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap; border-top:1px solid rgba(0,0,0,0.04);';
      mobilityRow.innerHTML = `<span>ðŸš¶ ${walkingMinutes} min</span><span style="color:#ccc;">|</span><span>ðŸš— ${carMinutes} min</span><span style="color:#ccc;">|</span><span>ðŸ“ ${distanceText}</span>`;
      body.appendChild(mobilityRow);
    }
    
    card.appendChild(body);
    
    card.onclick = (e) => {
      if(e.target.closest('button')) return;
      openOffer(data.id);
    };
    
    return card;
  }
  


  // --- Order Store (localStorage MVP) - MUSS VOR VERWENDUNG DEFINIERT SEIN ---
  /**
   * @typedef {Object} Order
   * @property {string} id
   * @property {number} createdAt
   * @property {number} updatedAt
   * @property {string} dishId
   * @property {string} dishName
   * @property {string} providerId
   * @property {string} providerName
   * @property {string} [providerAddress]
   * @property {number} quantity
   * @property {number} unitPrice - in cents
   * @property {number} total - in cents
   * @property {'PICKUP'} fulfillType - Immer "Zum Mitnehmen" (keine Vor-Ort-Option)
   * @property {string} [etaTime]
   * @property {'CREATED'|'PAYMENT_PENDING'|'PAID'|'CANCELLED'|'COMPLETED'|'PICKED_UP'} status
   * @property {'EUR'} currency
   * @property {string} [stripeCheckoutSessionId]
   * @property {string} [stripePaymentIntentId]
   * @property {string} [receiptEmail]
   * @property {string} [pickupCode] - nur bei PAID (Format: "2B")
   * @property {number} [pickupCodeActivatedAt] - nur bei PAID
   * @property {string} [pickupDate] - ISO date "YYYY-MM-DD"
   * @property {string} [pickupWindow] - e.g. "11:30â€“14:30"
   * @property {'A'|'B'|'C'|'D'|'E'} [dishLetter] - nur bei PAID
   * @property {number} [runningNumber] - nur bei PAID
   * @property {string} [offerId] - Reference to offer
   * @property {'PAID'|'PICKED_UP'} [status] - Extended status
   * @property {boolean} isGuest
   */
  
  /**
   * Load orders from localStorage
   * @returns {Order[]}
   */
  function loadOrders(){
    try {
      const stored = localStorage.getItem(LS.orders);
      if(!stored) return [];
      const parsed = JSON.parse(stored);
      return Array.isArray(parsed) ? parsed : [];
    } catch(e){
      console.error('Error loading orders:', e);
      return [];
    }
  }
  
  /**
   * Save orders to localStorage
   * @param {Order[]} ordersList
   */
  function saveOrders(ordersList){
    try {
      localStorage.setItem(LS.orders, JSON.stringify(ordersList || []));
    } catch(e){
      console.error('Error saving orders:', e);
    }
  }
  
  /**
   * Add a new order
   * @param {Order} order
   * @returns {Order}
   */
  function addOrder(order){
    // Guard: pickupCode nur bei PAID
    if(order.pickupCode && order.status !== 'PAID'){
      console.warn('pickupCode should only be set when status is PAID');
      order.pickupCode = undefined;
      order.pickupCodeActivatedAt = undefined;
    }
    
    const ordersList = loadOrders();
    ordersList.push(order);
    saveOrders(ordersList);
    return order;
  }
  
  /**
   * Update an existing order
   * @param {string} orderId
   * @param {Partial<Order>} patch
   * @returns {Order|null}
   */
  function updateOrder(orderId, patch){
    const ordersList = loadOrders();
    const index = ordersList.findIndex(o => o.id === orderId);
    if(index === -1){
      console.error('Order not found:', orderId);
      return null;
    }
    
    const order = ordersList[index];
    
    // Guard: pickupCode nur bei PAID
    if(patch.pickupCode && patch.status !== 'PAID' && order.status !== 'PAID'){
      console.warn('pickupCode should only be set when status is PAID');
      patch.pickupCode = undefined;
      patch.pickupCodeActivatedAt = undefined;
    }
    
    // Merge patch
    const updated = {
      ...order,
      ...patch,
      updatedAt: Date.now()
    };
    
    ordersList[index] = updated;
    saveOrders(ordersList);
    return updated;
  }
  
  /**
   * Get order by ID
   * @param {string} orderId
   * @returns {Order|null}
   */
  function getOrderById(orderId){
    const ordersList = loadOrders();
    return ordersList.find(o => o.id === orderId) || null;
  }
  
  /**
   * List active orders (CREATED, PAYMENT_PENDING, PAID)
   * @returns {Order[]}
   */
  function listActiveOrders(){
    const ordersList = loadOrders();
    return ordersList.filter(o => 
      o.status === 'CREATED' || 
      o.status === 'PAYMENT_PENDING' || 
      o.status === 'PAID'
    );
  }
  
  /**
   * Generate pickup code (legacy: random 5-char code)
   * @param {number} [len=5]
   * @returns {string}
   */
  function generatePickupCode(len = 5){
    const alphabet = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789'; // ohne O/I/0/1
    let code = '';
    for(let i = 0; i < len; i++){
      code += alphabet[Math.floor(Math.random() * alphabet.length)];
    }
    
    // Optional: ensure uniqueness (wenn collision, neu generieren)
    const ordersList = loadOrders();
    const existingCodes = ordersList
      .filter(o => o.pickupCode)
      .map(o => o.pickupCode);
    
    if(existingCodes.includes(code)){
      // Collision: neu generieren (max 10 Versuche)
      for(let attempt = 0; attempt < 10; attempt++){
        code = '';
        for(let i = 0; i < len; i++){
          code += alphabet[Math.floor(Math.random() * alphabet.length)];
        }
        if(!existingCodes.includes(code)) break;
      }
    }
    
    return code;
  }
  
  /**
   * Assign pickup code (deterministic, mock)
   * Single source of truth: Order record
   * @param {Object} params
   * @param {string} params.providerId - Provider ID
   * @param {string} params.pickupDate - ISO date "YYYY-MM-DD"
   * @param {string} params.dishId - Dish/Offer ID
   * @returns {{dishLetter: string, runningNumber: number, pickupCode: string}}
   */
  function assignPickupCode({providerId, pickupDate, dishId}){
    // 1) Get today's active offers for provider (same pickupDate)
    const todayOffers = offers
      .filter(o => o.providerId === providerId && o.day === pickupDate && o.active !== false)
      .sort((a, b) => {
        // 2) Sort deterministically (createdAt or sortIndex)
        const timeA = a.createdAt || 0;
        const timeB = b.createdAt || 0;
        if(timeA !== timeB) return timeA - timeB;
        return (a.id || '').localeCompare(b.id || '');
      });
    
    // 3) Determine dishLetter based on index: 0->A, 1->B, 2->C, 3->D, 4->E
    const dishIndex = todayOffers.findIndex(o => o.id === dishId);
    if(dishIndex === -1){
      // Fallback: use first dish (A)
      const dishLetter = 'A';
      const ordersList = loadOrders();
      // 4) Find existing orders for (providerId + pickupDate + dishLetter)
      const existingOrders = ordersList.filter(o => 
        o.providerId === providerId && 
        o.pickupDate === pickupDate && 
        o.dishLetter === dishLetter &&
        o.status === 'PAID'
      );
      // 5) runningNumber = existingCount + 1
      const runningNumber = existingOrders.length + 1;
      // 6) pickupCode = `${runningNumber}${dishLetter}`
      const pickupCode = `${runningNumber}${dishLetter}`;
      return {dishLetter, runningNumber, pickupCode};
    }
    
    const position = Math.min(dishIndex, 4); // Max 5 dishes (0-4)
    const dishLetter = String.fromCharCode(65 + position); // A=65, B=66, etc. (0â†’A, 1â†’B, ...)
    
    // 4) Find existing orders for (providerId + pickupDate + dishLetter)
    const ordersList = loadOrders();
    const existingOrders = ordersList.filter(o => 
      o.providerId === providerId && 
      o.pickupDate === pickupDate && 
      o.dishLetter === dishLetter &&
      o.status === 'PAID'
    );
    
    // 5) runningNumber = existingCount + 1
    const runningNumber = existingOrders.length + 1;
    
    // 6) pickupCode = `${runningNumber}${dishLetter}`
    const pickupCode = `${runningNumber}${dishLetter}`;
    
    return {dishLetter, runningNumber, pickupCode};
  }
  
  /**
   * Generate dish-letter pickup code (legacy wrapper, uses assignPickupCode)
   * @param {string} orderId - Order ID
   * @param {string} dishId - Dish/Offer ID
   * @param {string} providerIdVal - Provider ID (from order)
   * @param {string} day - ISO date string (YYYY-MM-DD)
   * @returns {{code: string, dishLetter: string, runningNumber: number}} - Format: "1A", "2A", "3B", etc.
   */
  function generateDishLetterPickupCode(orderId, dishId, providerIdVal, day){
    const pickupDate = day || isoDate(new Date());
    // Use assignPickupCode (deterministic)
    const result = assignPickupCode({providerId: providerIdVal, pickupDate, dishId});
    return {code: result.pickupCode, dishLetter: result.dishLetter, runningNumber: result.runningNumber};
  }

  // --- State ---
  let mode = load(LS.mode, 'customer'); // 'start' | 'customer' | 'provider' (Standard: 'customer' fÃ¼r Discover-Seite)
  // Angebote werden spÃ¤ter durch seedExampleData() oder seed() geladen
  // Zuerst aus localStorage laden, falls vorhanden
  let offers = load(LS.offers, []);
  const legacyFavs = load(LS.favs, []);
  let providerFavs = new Set(load(LS.providerFavs, legacyFavs));
  let dishFavs = new Set(load(LS.dishFavs, []));
  let cart = load(LS.cart, null); // {providerId, items:[{offerId, qty}]} or null
  let orders = loadOrders(); // Load via Order Store
  let customer = load(LS.customer, { 
    loggedIn:false, 
    name:null,
    email:null,
    dietaryPreferences: {
      vegan: false,
      vegetarian: false,
      glutenFree: false,
      lactoseFree: false
    },
    reuseEnabled: false
  });
  let provider = load(LS.provider, { loggedIn:false, email:null, profile:{ name:'', address:'', street:'', zip:'', city:'', mealWindow:'11:30 â€“ 14:00', mealStart:'11:30', mealEnd:'14:00', lunchWeekdays:[1,2,3,4,5], phone:'', email:'', website:'', logoData:'', reuseEnabledByDefault:false, abholnummerEnabledByDefault:false } });
  let cookbook = load(LS.cookbook, []); // [{id, dish, category, price, allergens[], extras?, reuse? , photoData?}]
  let week = load(LS.week, {}); // { 'YYYY-MM-DD': [cookbookId,...] }

  const CATEGORIES = ['Vegetarisch','Vegan','Fisch','Mit Fleisch'];
  const CAT_MAP = {
    'Vegan':'Vegan',
    'Vegetarisch':'Vegetarisch',
    'Fisch':'Fisch',
    'Mit Fleisch':'Fleisch',
    'Fleisch':'Fleisch',
    'GeflÃ¼gel':'GeflÃ¼gel',
    'Pasta':'Pasta',
    'Suppe':'Suppe',
    'Salat':'Salat',
    'Burger':'Burger',
    'Beilage':'Beilage'
  };
  /** Kategorie â†’ Emoji (Bestellhistorie & Pills) */
  const CAT_EMOJI = {
    'Vegan':'ðŸŒ±',
    'Vegetarisch':'ðŸŒ¿',
    'Fisch':'ðŸŸ',
    'Mit Fleisch':'ðŸ¥©',
    'Fleisch':'ðŸ¥©',
    'GeflÃ¼gel':'ðŸ—',
    'Pasta':'ðŸ',
    'Suppe':'ðŸ¥£',
    'Salat':'ðŸ¥—',
    'Burger':'ðŸ”',
    'Beilage':'ðŸŸ',
    'ðŸ¥©':'ðŸ¥©','ðŸ—':'ðŸ—','ðŸŸ':'ðŸŸ','ðŸŒ¿':'ðŸŒ¿','ðŸŒ±':'ðŸŒ±','ðŸ':'ðŸ','ðŸ¥£':'ðŸ¥£','ðŸ¥—':'ðŸ¥—','ðŸ”':'ðŸ”','ðŸŸ':'ðŸŸ'
  };
  const DISH_SUGGESTIONS = [
    {name:'KÃ¼rbissuppe', category:'Vegan'},
    {name:'Tomatensuppe mit Brot', category:'Vegan'},
    {name:'Pasta mit GemÃ¼se', category:'Vegetarisch'},
    {name:'KÃ¤sespÃ¤tzle', category:'Vegetarisch'},
    {name:'Salat Bowl', category:'Vegetarisch'},
    {name:'Falafel Teller', category:'Vegan'},
    {name:'Veggie Burger', category:'Vegan'},
    {name:'Schnitzel mit Pommes', category:'Fleisch'},
    {name:'Currywurst', category:'Fleisch'},
    {name:'Gulasch mit SpÃ¤tzle', category:'Fleisch'}
  ];

  // Day slider: today..+6
  // Format: "Montag, 24.01." (immer vollstÃ¤ndiger Wochentag + DD.MM.)
  function fmtDay(d, includeToday = false){
    const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
    const wd = weekdays[d.getDay()];
    const day = String(d.getDate()).padStart(2,'0');
    const month = String(d.getMonth()+1).padStart(2,'0');
    
    if(includeToday){
      const today = new Date();
      const isToday = d.toDateString() === today.toDateString();
      if(isToday){
        return `Heute, ${wd} ${day}.${month}.`;
      }
    }
    
    return `${wd}, ${day}.${month}.`;
  }
  
  // Format date with time range: "Montag, 24.01. Â· 11:30â€“14:30"
  function fmtDateWithTime(d, timeRange){
    const dateStr = fmtDay(d);
    return timeRange ? `${dateStr} Â· ${timeRange}` : dateStr;
  }
  
  function isoDate(d){ return d.toISOString().slice(0,10); }

  let activeCat = null;
  let activeDay = isoDate(new Date());
  let providerWeekDay = isoDate(new Date());
  let pickupSort = 'code'; // Default: sort by code (1A, 1B, 1C, 2A, 2B...)
  let pickupFilter = 'offen'; // 'offen' | 'abgeholt'
  let cookbookSort = 'recent';
  let cookbookQuery = '';
  let cookbookTab = 'dishes';
  let weekPlanDay = isoDate(new Date());
  let locationQuery = ''; // Wird durch Auto-GPS oder manuelle Eingabe gesetzt; Fallback: Schorndorf (73614)
  let userLat = null;
  let userLng = null;
  const SCHORNDORF_LAT = 48.8014;
  const SCHORNDORF_LNG = 9.5282;
  const DEFAULT_LOCATION_FALLBACK = 'Schorndorf';
  let pickupDone = new Set(load(LS.pickupDone, []));
  let activeOrderId = null;
  let ordersFilter = 'offen';
  let pickupUndoKey = null;
  let pickupUndoTimer = null;
  let billingFilter = 'month';
  let billingMonth = '2026-01';

  // --- Seed demo offers (Testanbieter) ---
  function seed(){
    // Testdaten immer erstellen (zum Testen)
    const today = isoDate(new Date());
    offers = [
      // 4 Testanbieter Ã— 4 Gerichte (mit Bildern & je Abholnummers)
      
      // 1. Pizzeria Bella Vista (Stuttgart)
      {id: cryptoId(), providerId: 'p_bellavista', providerName: 'Pizzeria Bella Vista', address: 'HauptstraÃŸe 45, 70173 Stuttgart', title: 'LeberkÃ¤se mit SpÃ¤tzle', price: 6.90, time: '11:30 â€“ 14:30', diet: 'Fleisch', day: today, img: 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 3},
      {id: cryptoId(), providerId: 'p_bellavista', providerName: 'Pizzeria Bella Vista', address: 'HauptstraÃŸe 45, 70173 Stuttgart', title: 'Pizza Quattro Formaggi', price: 8.50, time: '11:30 â€“ 14:30', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1571997478779-2adcbbe9ab2f?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 4},
      {id: cryptoId(), providerId: 'p_bellavista', providerName: 'Pizzeria Bella Vista', address: 'HauptstraÃŸe 45, 70173 Stuttgart', title: 'Pasta Carbonara', price: 8.80, time: '11:30 â€“ 14:30', diet: 'Fleisch', day: today, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 2},
      {id: cryptoId(), providerId: 'p_bellavista', providerName: 'Pizzeria Bella Vista', address: 'HauptstraÃŸe 45, 70173 Stuttgart', title: 'Insalata Caprese', price: 7.20, time: '11:30 â€“ 14:30', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 3},

      // 2. Asia Wok Express (TÃ¼bingen)
      {id: cryptoId(), providerId: 'p_asiawok', providerName: 'Asia Wok Express', address: 'Neckarhalde 8, 72070 TÃ¼bingen', title: 'HÃ¤hnchen Teriyaki', price: 8.90, time: '11:00 â€“ 14:00', diet: 'Fleisch', day: today, img: 'https://images.unsplash.com/photo-1603133872878-684f208fb84b?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 5},
      {id: cryptoId(), providerId: 'p_asiawok', providerName: 'Asia Wok Express', address: 'Neckarhalde 8, 72070 TÃ¼bingen', title: 'Gebratene Nudeln mit GemÃ¼se', price: 7.50, time: '11:00 â€“ 14:00', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1569718212165-3a8278d5f624?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 4},
      {id: cryptoId(), providerId: 'p_asiawok', providerName: 'Asia Wok Express', address: 'Neckarhalde 8, 72070 TÃ¼bingen', title: 'Pad Thai', price: 8.40, time: '11:00 â€“ 14:00', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 3},
      {id: cryptoId(), providerId: 'p_asiawok', providerName: 'Asia Wok Express', address: 'Neckarhalde 8, 72070 TÃ¼bingen', title: 'FrÃ¼hlingsrollen (4 StÃ¼ck)', price: 6.80, time: '11:00 â€“ 14:00', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1529692236671-f1f6cf9683ba?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 6},

      // 3. Burger House (Ludwigsburg)
      {id: cryptoId(), providerId: 'p_burgerhouse', providerName: 'Burger House', address: 'WilhelmstraÃŸe 12, 71634 Ludwigsburg', title: 'Classic Cheeseburger', price: 8.90, time: '11:30 â€“ 14:00', diet: 'Fleisch', day: today, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 4},
      {id: cryptoId(), providerId: 'p_burgerhouse', providerName: 'Burger House', address: 'WilhelmstraÃŸe 12, 71634 Ludwigsburg', title: 'Veggie Burger', price: 7.90, time: '11:30 â€“ 14:00', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1525059696034-4967a7290027?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 3},
      {id: cryptoId(), providerId: 'p_burgerhouse', providerName: 'Burger House', address: 'WilhelmstraÃŸe 12, 71634 Ludwigsburg', title: 'Chicken Burger', price: 9.20, time: '11:30 â€“ 14:00', diet: 'Fleisch', day: today, img: 'https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 5},
      {id: cryptoId(), providerId: 'p_burgerhouse', providerName: 'Burger House', address: 'WilhelmstraÃŸe 12, 71634 Ludwigsburg', title: 'Sweet Potato Fries', price: 4.50, time: '11:30 â€“ 14:00', diet: 'Vegan', day: today, img: 'https://images.unsplash.com/photo-1573080496219-bb080dd4f877?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 8},

      // 4. Green Garden (Esslingen)
      {id: cryptoId(), providerId: 'p_greengarden', providerName: 'Green Garden', address: 'Marktplatz 7, 73728 Esslingen', title: 'Avocado-Bowl', price: 9.50, time: '11:00 â€“ 14:00', diet: 'Vegan', day: today, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 4},
      {id: cryptoId(), providerId: 'p_greengarden', providerName: 'Green Garden', address: 'Marktplatz 7, 73728 Esslingen', title: 'Quinoa-Salat', price: 8.20, time: '11:00 â€“ 14:00', diet: 'Vegan', day: today, img: 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 5},
      {id: cryptoId(), providerId: 'p_greengarden', providerName: 'Green Garden', address: 'Marktplatz 7, 73728 Esslingen', title: 'Falafel-Wrap', price: 7.80, time: '11:00 â€“ 14:00', diet: 'Vegan', day: today, img: 'https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 6},
      {id: cryptoId(), providerId: 'p_greengarden', providerName: 'Green Garden', address: 'Marktplatz 7, 73728 Esslingen', title: 'GemÃ¼se-Curry', price: 8.60, time: '11:00 â€“ 14:00', diet: 'Vegan', day: today, img: 'https://images.unsplash.com/photo-1546069901-d5bfd2cbfb1f?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 3},
    ];
    save(LS.offers, offers);
  }

  // --- Beispieldaten: 10 Anbieter in Jena, je 3 Gerichte â€“ erscheinen in Kundenansicht (Discovery/Swipe) ---
  function seedExampleData(){
    const today = isoDate(new Date());
    const providerNames = [
      {id: 'p_01', name: 'Pizzeria Bella Vista', address: 'KollÃ©gienstraÃŸe 12, 07743 Jena', street: 'KollÃ©gienstraÃŸe 12', zip: '07743', city: 'Jena', distanceKm: 0.4},
      {id: 'p_02', name: 'Asia Wok Express', address: 'Neugasse 8, 07743 Jena', street: 'Neugasse 8', zip: '07743', city: 'Jena', distanceKm: 0.6},
      {id: 'p_03', name: 'Burger House', address: 'Johannisplatz 5, 07743 Jena', street: 'Johannisplatz 5', zip: '07743', city: 'Jena', distanceKm: 0.5},
      {id: 'p_04', name: 'Green Garden', address: 'Leutragraben 4, 07743 Jena', street: 'Leutragraben 4', zip: '07743', city: 'Jena', distanceKm: 0.3},
      {id: 'p_05', name: 'La Trattoria', address: 'SchillerstraÃŸe 22, 07745 Jena', street: 'SchillerstraÃŸe 22', zip: '07745', city: 'Jena', distanceKm: 0.8},
      {id: 'p_06', name: 'Sushi Bar Tokyo', address: 'Wagnergasse 15, 07743 Jena', street: 'Wagnergasse 15', zip: '07743', city: 'Jena', distanceKm: 0.5},
      {id: 'p_07', name: 'Curry & Co', address: 'Teichgraben 6, 07743 Jena', street: 'Teichgraben 6', zip: '07743', city: 'Jena', distanceKm: 0.7},
      {id: 'p_08', name: 'Veggie Delight', address: 'LÃ¶bdergraben 10, 07743 Jena', street: 'LÃ¶bdergraben 10', zip: '07743', city: 'Jena', distanceKm: 0.4},
      {id: 'p_09', name: 'Steakhouse Premium', address: 'Engelplatz 2, 07743 Jena', street: 'Engelplatz 2', zip: '07743', city: 'Jena', distanceKm: 0.6},
      {id: 'p_10', name: 'Bio Bistro', address: 'WeigelstraÃŸe 18, 07743 Jena', street: 'WeigelstraÃŸe 18', zip: '07743', city: 'Jena', distanceKm: 0.9}
    ];

    const dishTemplates = [
      // Verschiedene Kategorien
      {dish: 'KÃ¼rbissuppe', category: 'Vegan', price: 6.50, img: 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Pasta Carbonara', category: 'Mit Fleisch', price: 8.80, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Salat Bowl', category: 'Vegetarisch', price: 7.90, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'HÃ¤hnchen Teriyaki', category: 'Mit Fleisch', price: 9.20, img: 'https://images.unsplash.com/photo-1603133872878-684f208fb84b?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Falafel Teller', category: 'Vegan', price: 7.50, img: 'https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'KÃ¤sespÃ¤tzle', category: 'Vegetarisch', price: 7.20, img: 'https://images.unsplash.com/photo-1546069901-d5bfd2cbfb1f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Pizza Margherita', category: 'Vegetarisch', price: 8.50, img: 'https://images.unsplash.com/photo-1571997478779-2adcbbe9ab2f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Lachs mit GemÃ¼se', category: 'Fisch', price: 10.50, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Veggie Burger', category: 'Vegan', price: 7.90, img: 'https://images.unsplash.com/photo-1525059696034-4967a7290027?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Schnitzel mit Pommes', category: 'Mit Fleisch', price: 9.80, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Quinoa-Salat', category: 'Vegan', price: 8.20, img: 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Thunfisch-Steak', category: 'Fisch', price: 11.20, img: 'https://images.unsplash.com/photo-1569718212165-3a8278d5f624?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Gulasch mit SpÃ¤tzle', category: 'Mit Fleisch', price: 9.50, img: 'https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'GemÃ¼se-Curry', category: 'Vegan', price: 8.60, img: 'https://images.unsplash.com/photo-1546069901-d5bfd2cbfb1f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Risotto ai Funghi', category: 'Vegetarisch', price: 8.90, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Sushi Platte', category: 'Fisch', price: 12.50, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Steak mit Beilagen', category: 'Mit Fleisch', price: 13.90, img: 'https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Buddha Bowl', category: 'Vegan', price: 8.80, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Caprese Salat', category: 'Vegetarisch', price: 7.40, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Fischfilet mit Kartoffeln', category: 'Fisch', price: 10.80, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Chili con Carne', category: 'Mit Fleisch', price: 8.70, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Avocado-Bowl', category: 'Vegan', price: 9.50, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Mozzarella-Pasta', category: 'Vegetarisch', price: 8.30, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Lachs-Tartar', category: 'Fisch', price: 11.90, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Hamburger Classic', category: 'Mit Fleisch', price: 8.90, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Tofu-Wrap', category: 'Vegan', price: 7.60, img: 'https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'GemÃ¼se-Lasagne', category: 'Vegetarisch', price: 9.20, img: 'https://images.unsplash.com/photo-1546069901-d5bfd2cbfb1f?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Forelle blau', category: 'Fisch', price: 10.40, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Rinderbraten', category: 'Mit Fleisch', price: 12.50, img: 'https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1200&q=60'},
      {dish: 'Power-Smoothie Bowl', category: 'Vegan', price: 6.90, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60'}
    ];

    const newOffers = [];
    const newCookbook = [];
    const newOrders = [];

    providerNames.forEach((provider, pIdx) => {
      // 3 Gerichte pro Provider (verschiedene Kategorien)
      const dishIndices = [
        (pIdx * 3) % dishTemplates.length,
        ((pIdx * 3 + 1) % dishTemplates.length),
        ((pIdx * 3 + 2) % dishTemplates.length)
      ];

      dishIndices.forEach((dishIdx, dIdx) => {
        const template = dishTemplates[dishIdx];
        const cookbookId = cryptoId();
        const offerId = cryptoId();

        // Kochbuch-Eintrag
        newCookbook.push({
          id: cookbookId,
          providerId: provider.id,
          dish: template.dish,
          category: template.category,
          price: template.price,
          allergens: [],
          extras: [],
          reuse: {enabled: false, deposit: 0},
          photoData: template.img,
          hasPickupCode: true,
          dineInPossible: false, // Keine Vor-Ort-Option - nur Abholnummer
          createdAt: Date.now() - (pIdx * 86400000) - (dIdx * 3600000),
          lastUsed: Date.now() - (pIdx * 86400000) - (dIdx * 3600000)
        });

        // Offer (Inserat fÃ¼r heute) â€“ distanceKm fÃ¼r Kundenansicht (Discovery/Swipe, â€ž10 Minâ€œ-Filter)
        newOffers.push({
          id: offerId,
          providerId: provider.id,
          providerName: provider.name,
          providerStreet: provider.street,
          providerZip: provider.zip,
          providerCity: provider.city,
          address: provider.address,
          dish: template.dish,
          category: template.category,
          price: template.price,
          pickupWindow: '11:30 â€“ 14:00',
          day: today,
          imageUrl: template.img,
          hasPickupCode: true,
          dineInPossible: true,
          distanceKm: provider.distanceKm != null ? provider.distanceKm : (0.3 + (pIdx * 0.07) + (dIdx * 0.02)),
          allergens: [],
          extras: [],
          reuse: {enabled: (pIdx % 3) === 0, deposit: 0},
          active: true,
          createdAt: Date.now() - (pIdx * 3600000) - (dIdx * 600000)
        });
      });
    });

    // Schorndorf Test-Karten (3-Balken-Vergleich): Karte A Full Service, Karte B Basic Service
    const schorndorfAddress = 'Marktplatz 1, 73614 Schorndorf';
    newOffers.push({
      id: cryptoId(),
      providerId: 'p_schorndorf_metzgerei',
      providerName: 'Metzgerei aus Schorndorf',
      providerStreet: 'Marktplatz 1',
      providerZip: '73614',
      providerCity: 'Schorndorf',
      address: schorndorfAddress,
      dish: 'LeberkÃ¤se mit Kartoffelsalat',
      category: 'Mit Fleisch',
      price: 7.90,
      pickupWindow: '11:30 â€“ 14:00',
      day: today,
      imageUrl: 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60',
      hasPickupCode: true,
      dineInPossible: true,
      distanceKm: 0.3,
      allergens: [],
      reuse: { enabled: true, deposit: 0 },
      active: true
    });
    newOffers.push({
      id: cryptoId(),
      providerId: 'p_schorndorf_baecker',
      providerName: 'BÃ¤cker am Marktplatz',
      providerStreet: 'HauptstraÃŸe 10',
      providerZip: '73614',
      providerCity: 'Schorndorf',
      address: 'HauptstraÃŸe 10, 73614 Schorndorf',
      dish: 'Belegtes BrÃ¶tchen mit Salat',
      category: 'Vegetarisch',
      price: 5.20,
      pickupWindow: '08:00 â€“ 12:00',
      day: today,
      imageUrl: 'https://images.unsplash.com/photo-1529692236671-f1f6cf9683ba?auto=format&fit=crop&w=1200&q=60',
      hasPickupCode: false,
      dineInPossible: true,
      distanceKm: 0.2,
      allergens: [],
      reuse: { enabled: false, deposit: 0 },
      active: true
    });

    // Zuerst Offers speichern, damit assignPickupCode sie verwenden kann
    // WICHTIG: Ersetze alte Offers, damit keine Duplikate entstehen
    offers = [...newOffers];
    save(LS.offers, offers);

    // Jetzt Bestellungen mit Abholnummers erstellen
    providerNames.forEach((provider, pIdx) => {
      const dishIndices = [
        (pIdx * 3) % dishTemplates.length,
        ((pIdx * 3 + 1) % dishTemplates.length),
        ((pIdx * 3 + 2) % dishTemplates.length)
      ];

      dishIndices.forEach((dishIdx, dIdx) => {
        const template = dishTemplates[dishIdx];
        // Finde das entsprechende Offer
        const offer = newOffers.find(o => 
          o.providerId === provider.id && 
          o.dish === template.dish
        );
        if(!offer) return;

        // 10 Bestellungen pro Provider (mit Abholnummers)
        // Verteilung: 3-4 pro Gericht
        const ordersPerDish = dIdx === 0 ? 4 : (dIdx === 1 ? 3 : 3);
        for(let o = 0; o < ordersPerDish; o++){
          const orderId = cryptoId();
          const pickupCode = assignPickupCode({
            providerId: provider.id,
            pickupDate: today,
            dishId: offer.id
          });

          newOrders.push({
            id: orderId,
            createdAt: Date.now() - (pIdx * 3600000) - (dIdx * 600000) - (o * 60000),
            updatedAt: Date.now() - (pIdx * 3600000) - (dIdx * 600000) - (o * 60000),
            dishId: offer.id,
            dishName: template.dish,
            providerId: provider.id,
            providerName: provider.name,
            providerAddress: provider.address,
            quantity: 1,
            unitPrice: Math.round(template.price * 100), // in cents
            total: Math.round(template.price * 100),
            fulfillType: 'PICKUP',
            status: 'PAID',
            currency: 'EUR',
            pickupCode: pickupCode.pickupCode,
            pickupCodeActivatedAt: Date.now() - (pIdx * 3600000) - (dIdx * 600000) - (o * 60000),
            pickupDate: today,
            pickupWindow: '11:30 â€“ 14:00',
            dishLetter: pickupCode.dishLetter,
            runningNumber: pickupCode.runningNumber,
            offerId: offer.id,
            isGuest: false
          });
        }
      });
    });

    // Speichern (Offers bereits oben gespeichert)
    // Ersetze Cookbook komplett fÃ¼r Demo (keine Duplikate)
    const existingCookbook = cookbook.filter(c => !providerNames.some(p => p.id === c.providerId));
    cookbook = [...existingCookbook, ...newCookbook];
    save(LS.cookbook, cookbook);

    const existingOrders = loadOrders();
    const allOrders = [...existingOrders, ...newOrders];
    saveOrders(allOrders);

    console.log(`âœ… Beispieldaten erstellt: ${providerNames.length} Anbieter, ${newCookbook.length} Kochbuch-EintrÃ¤ge, ${newOffers.length} Inserate, ${newOrders.length} Bestellungen`);
    return {providers: providerNames.length, cookbook: newCookbook.length, offers: newOffers.length, orders: newOrders.length};
  }

  // --- Test-Funktion fÃ¼r Abholnummer-Logik ---
  function testPickupCodeLogic(){
    console.log('ðŸ§ª Teste Abholnummer-Logik...');
    const today = isoDate(new Date());
    
    // Test 1: PrÃ¼fe ob Beispieldaten vorhanden sind
    const allOrders = loadOrders();
    const allOffers = offers;
    const todayOrders = allOrders.filter(o => o.pickupDate === today && o.status === 'PAID');
    const todayOffers = allOffers.filter(o => o.day === today && o.active !== false);
    
    console.log(`ðŸ“Š Test 1 - Daten vorhanden:`);
    console.log(`  - Heutige Bestellungen: ${todayOrders.length}`);
    console.log(`  - Heutige Inserate: ${todayOffers.length}`);
    
    if(todayOrders.length === 0){
      console.warn('âš ï¸ Keine Bestellungen fÃ¼r heute gefunden. seedExampleData() ausfÃ¼hren?');
      return false;
    }
    
    // Test 2: PrÃ¼fe Abholnummer-Format
    console.log(`\nðŸ“Š Test 2 - Abholnummer-Format:`);
    const codes = todayOrders.map(o => o.pickupCode).filter(Boolean);
    const invalidCodes = codes.filter(c => !/^\d+[A-E]$/.test(c));
    if(invalidCodes.length > 0){
      console.error(`âŒ UngÃ¼ltige Codes gefunden: ${invalidCodes.join(', ')}`);
      return false;
    }
    console.log(`  âœ… Alle ${codes.length} Codes haben gÃ¼ltiges Format (z.B. "1A", "2B")`);
    
    // Test 3: PrÃ¼fe Eindeutigkeit pro Provider/Tag
    console.log(`\nðŸ“Š Test 3 - Eindeutigkeit pro Provider/Tag:`);
    const providers = [...new Set(todayOrders.map(o => o.providerId))];
    let allUnique = true;
    providers.forEach(pid => {
      const providerOrders = todayOrders.filter(o => o.providerId === pid);
      const providerCodes = providerOrders.map(o => o.pickupCode);
      const uniqueCodes = [...new Set(providerCodes)];
      if(providerCodes.length !== uniqueCodes.length){
        console.error(`âŒ Provider ${pid}: Duplikate gefunden!`);
        console.error(`  Codes: ${providerCodes.join(', ')}`);
        allUnique = false;
      } else {
        console.log(`  âœ… Provider ${pid}: ${providerCodes.length} eindeutige Codes`);
      }
    });
    if(!allUnique) return false;
    
    // Test 4: PrÃ¼fe dishLetter-Zuordnung
    console.log(`\nðŸ“Š Test 4 - dishLetter-Zuordnung:`);
    providers.forEach(pid => {
      const providerOffers = todayOffers.filter(o => o.providerId === pid).sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0));
      const providerOrders = todayOrders.filter(o => o.providerId === pid);
      
      // Erwartete Letters: A, B, C (fÃ¼r 3 Gerichte)
      const expectedLetters = ['A', 'B', 'C'];
      const actualLetters = [...new Set(providerOrders.map(o => o.dishLetter).filter(Boolean))].sort();
      
      console.log(`  Provider ${pid}:`);
      console.log(`    - Inserate: ${providerOffers.length} (erwartet: 3)`);
      console.log(`    - Bestellungen: ${providerOrders.length} (erwartet: 10)`);
      console.log(`    - dishLetters: ${actualLetters.join(', ')} (erwartet: A, B, C)`);
      
      // PrÃ¼fe ob Letters korrekt zugeordnet sind
      providerOffers.forEach((offer, idx) => {
        const expectedLetter = expectedLetters[idx] || 'A';
        const ordersForOffer = providerOrders.filter(o => o.offerId === offer.id);
        const lettersForOffer = [...new Set(ordersForOffer.map(o => o.dishLetter))];
        if(lettersForOffer.length !== 1 || lettersForOffer[0] !== expectedLetter){
          console.warn(`    âš ï¸ Offer "${offer.dish}" hat unerwartete Letters: ${lettersForOffer.join(', ')} (erwartet: ${expectedLetter})`);
        } else {
          console.log(`    âœ… Offer "${offer.dish}": Letter ${expectedLetter}, ${ordersForOffer.length} Bestellungen`);
        }
      });
    });
    
    // Test 5: PrÃ¼fe runningNumber-Sequenz
    console.log(`\nðŸ“Š Test 5 - runningNumber-Sequenz:`);
    providers.forEach(pid => {
      const providerOrders = todayOrders.filter(o => o.providerId === pid);
      const letters = ['A', 'B', 'C'];
      letters.forEach(letter => {
        const ordersForLetter = providerOrders.filter(o => o.dishLetter === letter).sort((a,b) => a.runningNumber - b.runningNumber);
        if(ordersForLetter.length > 0){
          const numbers = ordersForLetter.map(o => o.runningNumber);
          const expected = Array.from({length: ordersForLetter.length}, (_, i) => i + 1);
          const isSequential = JSON.stringify(numbers) === JSON.stringify(expected);
          if(!isSequential){
            console.error(`âŒ Provider ${pid}, Letter ${letter}: Sequenz fehlerhaft!`);
            console.error(`  Gefunden: ${numbers.join(', ')}`);
            console.error(`  Erwartet: ${expected.join(', ')}`);
          } else {
            console.log(`  âœ… Provider ${pid}, Letter ${letter}: Sequenz korrekt (1-${numbers.length})`);
          }
        }
      });
    });
    
    // Test 6: PrÃ¼fe assignPickupCode Funktion direkt
    console.log(`\nðŸ“Š Test 6 - assignPickupCode Funktion:`);
    if(todayOffers.length > 0 && providers.length > 0){
      const testProvider = providers[0];
      const testOffers = todayOffers.filter(o => o.providerId === testProvider).sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0));
      if(testOffers.length > 0){
        const testOffer = testOffers[0];
        const testResult = assignPickupCode({
          providerId: testProvider,
          pickupDate: today,
          dishId: testOffer.id
        });
        console.log(`  Test fÃ¼r Provider ${testProvider}, Offer "${testOffer.dish}":`);
        console.log(`    - dishLetter: ${testResult.dishLetter} (erwartet: A)`);
        console.log(`    - runningNumber: ${testResult.runningNumber}`);
        console.log(`    - pickupCode: ${testResult.pickupCode}`);
        
        const existingCount = todayOrders.filter(o => 
          o.providerId === testProvider && 
          o.pickupDate === today && 
          o.dishLetter === testResult.dishLetter &&
          o.status === 'PAID'
        ).length;
        const expectedRunningNumber = existingCount + 1;
        if(testResult.runningNumber === expectedRunningNumber){
          console.log(`    âœ… runningNumber korrekt (${testResult.runningNumber} = ${existingCount} + 1)`);
        } else {
          console.error(`    âŒ runningNumber falsch! Gefunden: ${testResult.runningNumber}, Erwartet: ${expectedRunningNumber}`);
        }
      }
    }
    
    console.log(`\nâœ… Alle Tests abgeschlossen!`);
    return true;
  }

  // --- UI helpers ---
  function euro(n){
    const v = Number(n||0);
    return v.toFixed(2).replace('.',',') + ' â‚¬';
  }
  function cryptoId(){
    return 'id_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
  }
  function esc(s){
    return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[c]));
  }

  /** Erstes Wort aus Allergen-Label (z. B. "ErdnÃ¼sse" statt "ErdnÃ¼sse und daraus gewonnene Erzeugnisse"). */
  function allergenFirstWord(label){
    if(!label) return '';
    return String(label).trim().split(/\s+/)[0] || label;
  }

  /** Standardisierte Allergen-Ãœbersetzung (ALLERGENE_OVERLAY_SPEC.md). Anbieter wÃ¤hlt KÃ¼rzel; nur zutreffende anzeigen. */
  const ALLERGENE_STANDARD = {
    'A':'Glutenhaltiges Getreide (Weizen, Roggen, Gerste etc.)',
    'B':'Krebstiere und daraus gewonnene Erzeugnisse',
    'C':'Eier und daraus gewonnene Erzeugnisse',
    'D':'Fische und daraus gewonnene Erzeugnisse',
    'E':'ErdnÃ¼sse und daraus gewonnene Erzeugnisse',
    'F':'Sojabohnen und daraus gewonnene Erzeugnisse',
    'G':'Milch und Milchprodukte (einschlieÃŸlich Laktose)',
    'H':'SchalenfrÃ¼chte (Mandeln, HaselnÃ¼sse, WalnÃ¼sse etc.)',
    'L':'Sellerie und daraus gewonnene Erzeugnisse',
    'M':'Senf und daraus gewonnene Erzeugnisse',
    'N':'Sesamsamen und daraus gewonnene Erzeugnisse',
    'O':'Schwefeldioxid und Sulfite',
    'P':'Lupinen und daraus gewonnene Erzeugnisse',
    'R':'Weichtiere und daraus gewonnene Erzeugnisse'
  };
  const ALLERGENE_NAME_TO_CODE = { 'Gluten':'A','Laktose':'G','Sellerie':'L','Milch':'G','Eier':'C','Fisch':'D','ErdnÃ¼sse':'E','Soja':'F','Senf':'M','Sesam':'N','Schwefeldioxid':'O','Lupinen':'P','Krebstiere':'B','SchalenfrÃ¼chte':'H','Weichtiere':'R' };
  /** Flache Checkliste Aâ€“R fÃ¼r Inseratsflow (Spec). */
  const ALLERGENE_CHECKLIST_A_R = Object.entries(ALLERGENE_STANDARD).map(([code,label])=>({code,label})).filter(x=>/[A-R]/.test(x.code));

  const ICONS = {
    plus:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>',
    book:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M4 4.5A2.5 2.5 0 0 1 6.5 2H20v15H6.5A2.5 2.5 0 0 0 4 17.5z"/></svg>',
    share:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="m16 6-4-4-4 4"/><path d="M12 2v14"/></svg>',
    'share-2':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="m8.59 13.51 6.83 3.98"/><path d="m15.41 6.51-6.82 3.98"/></svg>',
    print:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 14h12v8H6z"/></svg>',
    edit:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>',
    action:'<svg viewBox="0 0 24 24" fill="currentColor"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/></svg>',
    heart:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.8 6.6a5 5 0 0 0-7.1 0L12 8.3l-1.7-1.7a5 5 0 1 0-7.1 7.1L12 22l8.8-8.3a5 5 0 0 0 0-7.1Z"/></svg>',
    heartFilled:'<svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><path d="M20.8 6.6a5 5 0 0 0-7.1 0L12 8.3l-1.7-1.7a5 5 0 1 0-7.1 7.1L12 22l8.8-8.3a5 5 0 0 0 0-7.1Z"/></svg>',
    cart:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2h12l2 7H4z"/><path d="M4 9h16v11a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V9Z"/></svg>',
    'shopping-cart':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>',
    'shopping-basket':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 8 3 20h18L19 8"/><path d="M9 8V6a3 3 0 0 1 6 0v2"/></svg>',
    location:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s7-7.2 7-12a7 7 0 1 0-14 0c0 4.8 7 12 7 12z"/><circle cx="12" cy="10" r="2.5"/></svg>',
    star:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 2 3 7 7 .6-5.2 4.5 1.6 7L12 17l-6.4 4.1 1.6-7L2 9.6 9 9z"/></svg>',
    box:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7l9-4 9 4-9 4-9-4Z"/><path d="M3 7v10l9 4 9-4V7"/><path d="M12 11v10"/></svg>',
    leaf:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 14c6-8 14-8 16-6-2 8-10 16-18 14 0-6 2-8 2-8Z"/><path d="M6 14c2 0 6 0 10-4"/></svg>',
    flame:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2s3 4 3 7a3 3 0 1 1-6 0c0-3 3-7 3-7Z"/><path d="M5.5 14.5a6.5 6.5 0 1 0 13 0c0-3.5-2.5-6.5-6.5-9-4 2.5-6.5 5.5-6.5 9Z"/></svg>',
    calendar:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>',
    eye:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6S2 12 2 12Z"/><circle cx="12" cy="12" r="3"/></svg>',
    info:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 10v6"/><path d="M12 7h.01"/></svg>',
    card:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/></svg>',
    home:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 11.5 12 4l9 7.5"/><path d="M5 10.5V20h14v-9.5"/></svg>',
    user:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20a8 8 0 0 1 16 0"/></svg>',
    compass:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M15 9l-2 6-6 2 2-6 6-2Z"/></svg>',
    receipt:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2h12v20l-3-2-3 2-3-2-3 2Z"/><path d="M8 6h8M8 10h8M8 14h6"/></svg>',
    bookOpen:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 5h7a4 4 0 0 1 4 4v12H6a4 4 0 0 0-4 4Z"/><path d="M22 5h-7a4 4 0 0 0-4 4v12h7a4 4 0 0 1 4 4Z"/></svg>',
    clock:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 7v6l4 2"/></svg>',
    globe:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M3 12h18"/><path d="M12 3a12 12 0 0 1 0 18"/><path d="M12 3a12 12 0 0 0 0 18"/></svg>',
    link:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 1 0-7l2-2a5 5 0 0 1 7 7l-2 2"/><path d="M14 11a5 5 0 0 1 0 7l-2 2a5 5 0 0 1-7-7l2-2"/></svg>',
    message:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a4 4 0 0 1-4 4H7l-4 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/></svg>',
    camera:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h4l2-3h4l2 3h4v12H4z"/><circle cx="12" cy="13" r="3"/></svg>',
    mail:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="m3 7 9 6 9-6"/></svg>',
    shield:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2 20 5v6c0 5-3.5 9-8 11-4.5-2-8-6-8-11V5z"/></svg>',
    file:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>',
    wallet:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7h18a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H3z"/><path d="M3 7V5a2 2 0 0 1 2-2h14"/><path d="M17 12h4"/></svg>',
    utensils:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 2v6a4 4 0 0 0 8 0V2"/><path d="M8 2v10"/><path d="M16 2v20"/><path d="M20 2v6a2 2 0 0 1-2 2h-2"/></svg>',
    // Mittagio Icon Set (Lucide Icons - Outline only)
    carrot:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2.5 16.88a1 1 0 0 1-.32-1.43l1.5-2.5a1 1 0 0 1 1.37-.37L8 15l5-5-2-2-5 5-3.13-1.95a1 1 0 0 0-1.37.37l-2.5 1.5a1 1 0 0 0-.5.88Z"/><path d="M16 21h5a1 1 0 0 0 1-1v-5"/><path d="M21 16l-5 5"/><path d="M11 2L9 4l5 5 2-2-5-5Z"/></svg>',
    drumstick:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15.5 9.5 12 13l-1-1-1 1c-1 1-2.5 1.5-4 1l-1 1c-.5.5-1 1.5-1 2.5 0 1 .5 1.5 1 2l2 2c.5.5 1 .5 1.5 0l1-1c-.5-1.5 0-3 1-4l1-1 1 1 3.5-3.5Z"/><path d="M20 2v10"/><path d="M22 4h-4"/></svg>',
    fish:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 10s3-3 8-3 8 3 8 3-3 3-8 3-8-3-8-3Z"/><path d="M4 10v4"/><path d="M8 10v4"/><path d="M12 10v4"/><path d="M16 10v4"/><path d="M2 16s3-3 8-3 8 3 8 3"/><path d="M2 4s3 3 8 3 8-3 8-3"/></svg>',
    'key-round':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="15" r="4"/><path d="m10 15 6-6"/><path d="m18 5 2 2"/><path d="m20 5-2 2"/></svg>',
    'credit-card':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/></svg>',
    'shopping-bag':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>',
    package:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 18v-8Z"/><path d="M3.27 6.96 12 12.01l8.73-5.05"/><path d="M12 22.08V12"/></svg>',
    'utensils-crossed':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15.5-1-.5.5"/><path d="M15 2v5"/><path d="M12 22V8"/><path d="M12 2v3"/><path d="M19 22V11"/><path d="M19 2v4"/><path d="M2 22l20-20"/></svg>',
    store:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7v13h16V7"/><path d="M4 7l2-5h12l2 5"/><path d="M9 12v6"/><path d="M15 12v6"/></svg>',
    'calendar-days':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/><path d="M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01M16 18h.01"/></svg>',
    'map-pin':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>',
    copy:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>',
    check:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6 9 17l-5-5"/></svg>',
    'arrow-left':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>',
    'maximize-2':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6"/><path d="M9 21H3v-6"/><path d="M21 3l-7 7"/><path d="M3 21l7-7"/></svg>',
    x:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg>',
    'alert-circle':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>'
  };
  // MITTAGIO Master-Icons: Spezielle Icons fÃ¼r Abholnummer, Vor Ort, Mehrweg
  function getMittagioMasterIcon(type){
    // type: 'pickup-code' | 'dine-in' | 'reuse'
    if(type === 'pickup-code'){
      // Abholnummer: "A1", Schwarz-WeiÃŸ-Kontrast
      return `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="stroke-width:2.5;">
        <rect x="4" y="6" width="16" height="12" rx="2" stroke="currentColor" fill="none"/>
        <path d="M4 10h16" stroke="currentColor" stroke-linecap="round"/>
        <text x="12" y="16" font-family="Arial, sans-serif" font-size="8" font-weight="900" text-anchor="middle" fill="currentColor">A1</text>
        <path d="M18 8l2-2M18 16l2 2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>`;
    } else if(type === 'dine-in'){
      // Vor Ort: Gekreuztes Besteck (Gabel und Messer), schlichte, dicke LinienfÃ¼hrung
      return `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="stroke-width:2.5;">
        <path d="M8 3v18M8 3l4 4M8 3L4 7" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M16 3v18M16 3l-4 4M16 3l4 4" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="12" cy="12" r="1.5" fill="currentColor"/>
      </svg>`;
    } else if(type === 'reuse'){
      // Mehrweg: Kreislauf-Symbol (zwei Pfeile im Kreis) mit Blatt in der Mitte, organische Form
      return `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="stroke-width:2;">
        <path d="M12 4c-4.4 0-8 3.6-8 8s3.6 8 8 8" stroke="currentColor" stroke-linecap="round" fill="none"/>
        <path d="M12 4l4 4-4 4" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        <path d="M12 20c4.4 0 8-3.6 8-8s-3.6-8-8-8" stroke="currentColor" stroke-linecap="round" fill="none"/>
        <path d="M12 20L8 16l4-4" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        <path d="M12 9c-1.5 1.5-1.5 3.5 0 5" stroke="currentColor" stroke-linecap="round" fill="none" style="stroke-width:1.5;"/>
        <path d="M12 9l-1 1 1 1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" fill="none" style="stroke-width:1.5;"/>
      </svg>`;
    }
    return '';
  }
  
  const iconMarkup = (name, opts={})=> {
    const iconName = opts.fill && ICONS[name + 'Filled'] ? name + 'Filled' : name;
    return ICONS[iconName] ? `<span class="ico-inline">${ICONS[iconName]}</span>` : '';
  };
  function applyStaticIcons(){
    document.querySelectorAll('[data-icon]').forEach(el=>{
      if(el.dataset.iconApplied) return;
      const iconOnly = el.dataset.iconOnly === '1';
      const label = el.dataset.label || el.textContent.trim();
      el.dataset.label = label;
      if(iconOnly){
        el.innerHTML = iconMarkup(el.dataset.icon);
      } else {
        el.innerHTML = `${iconMarkup(el.dataset.icon)}<span>${esc(label)}</span>`;
      }
      el.dataset.iconApplied = '1';
    });
  }

  function seededInfoKey(str){
    const s = String(str||'');
    let h = 0;
    for(let i=0;i<s.length;i++){ h = (h*31 + s.charCodeAt(i)) % 10000; }
    return h;
  }
  function seededInfo(str){
    const h = seededInfoKey(str);
    const distanceKm = Number((0.5 + (h % 80) / 10).toFixed(1));
    const rating = Number((4 + (h % 9) / 10).toFixed(1));
    const ratingCount = 30 + (h % 400);
    // No-Limits: Keine Mengenangaben mehr
    return {distanceKm, rating, ratingCount};
  }

  const DEFAULT_MEAL_WINDOW = '11:30 â€“ 14:00';
  const INSERT_FEE = 4.99;       // InseratsgebÃ¼hr fix (â‚¬)
  const ABHOLNUMMER_FEE = 0.89;  // Abholnummer-GebÃ¼hr pro Verkauf (inkl. Stripe/Bank)
  const SUCCESS_FEE = ABHOLNUMMER_FEE; // Alias

  /** Dish-DB fÃ¼r Smart-Input + Bibliothek (name â†’ 3 Bilder). Semantisch sortiert. */
  const DISH_DB = [
    {dish:'KÃ¼rbissuppe', category:'Vegan', img:'https://images.unsplash.com/photo-1476718406336-bb5a9690ee2a?auto=format&fit=crop&w=600&q=80'},
    {dish:'Pasta Carbonara', category:'Mit Fleisch', img:'https://images.unsplash.com/photo-1612874742237-6526221588e3?auto=format&fit=crop&w=600&q=80'},
    {dish:'Salat Bowl', category:'Vegetarisch', img:'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=600&q=80'},
    {dish:'HÃ¤hnchen Teriyaki', category:'Mit Fleisch', img:'https://images.unsplash.com/photo-1555126634-323283e090fa?auto=format&fit=crop&w=600&q=80'},
    {dish:'Falafel Teller', category:'Vegan', img:'https://images.unsplash.com/photo-1593001874117-c99c800e3eb7?auto=format&fit=crop&w=600&q=80'},
    {dish:'KÃ¤sespÃ¤tzle', category:'Vegetarisch', img:'https://images.unsplash.com/photo-1627856429547-0624d08c8485?auto=format&fit=crop&w=600&q=80'},
    {dish:'Pizza Margherita', category:'Vegetarisch', img:'https://images.unsplash.com/photo-1574071318508-1cdbab80d002?auto=format&fit=crop&w=600&q=80'},
    {dish:'Schnitzel mit Pommes', category:'Mit Fleisch', img:'https://images.unsplash.com/photo-1599921841143-819065d5d431?auto=format&fit=crop&w=600&q=80'},
    {dish:'Veggie Burger', category:'Vegan', img:'https://images.unsplash.com/photo-1550547660-d9450f859349?auto=format&fit=crop&w=600&q=80'},
    {dish:'Gulasch', category:'Mit Fleisch', img:'https://images.unsplash.com/photo-1588509653491-b0db37996c9c?auto=format&fit=crop&w=600&q=80'},
    {dish:'GemÃ¼se-Curry', category:'Vegan', img:'https://images.unsplash.com/photo-1604152135912-04a022e23696?auto=format&fit=crop&w=600&q=80'},
    {dish:'Risotto', category:'Vegetarisch', img:'https://images.unsplash.com/photo-1476124369491-e7addf5db371?auto=format&fit=crop&w=600&q=80'},
    {dish:'Buddha Bowl', category:'Vegan', img:'https://images.unsplash.com/photo-1543339308-43e59d6b73a6?auto=format&fit=crop&w=600&q=80'},
    {dish:'Lachs mit GemÃ¼se', category:'Fisch', img:'https://images.unsplash.com/photo-1519708227418-c8fd9a32b7a2?auto=format&fit=crop&w=600&q=80'},
    {dish:'Sushi Platte', category:'Fisch', img:'https://images.unsplash.com/photo-1553621042-f6e147245754?auto=format&fit=crop&w=600&q=80'},
    {dish:'Caprese Salat', category:'Vegetarisch', img:'https://images.unsplash.com/photo-1529312266912-b33cf6227e2f?auto=format&fit=crop&w=600&q=80'},
    {dish:'Avocado Toast', category:'Vegan', img:'https://images.unsplash.com/photo-1588137372308-15f75323ca8d?auto=format&fit=crop&w=600&q=80'},
    {dish:'Wrap', category:'Vegetarisch', img:'https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=600&q=80'},
    {dish:'Lasagne', category:'Mit Fleisch', img:'https://images.unsplash.com/photo-1574868352503-c8d3014383c8?auto=format&fit=crop&w=600&q=80'},
    {dish:'Chili con Carne', category:'Mit Fleisch', img:'https://images.unsplash.com/photo-1543545811-71a1d43c86dd?auto=format&fit=crop&w=600&q=80'}
  ];

  /** Smart-Input: Eigenhistorie zuerst, dann DISH_DB. Liefert {dish, category, img?}. */
  function getDishSuggestionsSmartInput(q){
    const qn = String(q||'').trim().toLowerCase();
    const out = [];
    const seen = new Set();
    const pid = typeof providerId === 'function' ? providerId() : '';
    ['cookbook','offers'].forEach(src=>{
      const list = src==='cookbook' ? (typeof cookbook!=='undefined'?cookbook:[]) : (typeof offers!=='undefined'?offers:[]);
      (list||[]).forEach(x=>{
        const name = (x.dish||x.title||'').trim();
        if(!name || seen.has(name.toLowerCase())) return;
        if(src==='cookbook' && x.providerId!==pid) return;
        if(src==='offers' && x.providerId!==pid) return;
        if(qn && !name.toLowerCase().includes(qn)) return;
        seen.add(name.toLowerCase());
        out.push({ dish: name, category: x.category||x.diet||'Vegetarisch', img: x.photoData||x.imageUrl||x.img });
      });
    });
    DISH_DB.forEach(x=>{
      const n = (x.dish||'').trim();
      if(!n || seen.has(n.toLowerCase())) return;
      if(qn && !n.toLowerCase().includes(qn)) return;
      seen.add(n.toLowerCase());
      out.push({ dish: n, category: x.category||'Vegetarisch', img: x.img });
    });
    return out.slice(0, 12);
  }

  /** Bis zu 3 Bilder semantisch zum Gerichtsnamen (fÃ¼r Bibliothek). */
  function getDishImagesForName(name){
    const n = String(name||'').trim().toLowerCase();
    if(!n) return DISH_DB.slice(0,3).map(x=>x.img);
    const match = DISH_DB.filter(x=>(x.dish||'').toLowerCase().includes(n) || n.includes((x.dish||'').toLowerCase()));
    const urls = [...match.map(x=>x.img)];
    const rest = DISH_DB.filter(x=>!urls.includes(x.img));
    while(urls.length<3 && rest.length) urls.push(rest.shift().img);
    return urls.slice(0,3);
  }

  function buildAddress(p){
    if(p && p.address && String(p.address).trim()) return String(p.address).trim();
    const rest = [p?.zip, p?.city].filter(Boolean).join(' ').trim();
    return [p?.street, rest].filter(Boolean).join(', ');
  }

  function parseAddress(addr){
    const raw = String(addr||'').trim();
    const out = { address: raw, street:'', zip:'', city:'' };
    if(!raw) return out;
    const parts = raw.split(',').map(s=>s.trim()).filter(Boolean);
    if(parts.length){ out.street = parts[0]; }
    if(parts.length > 1){
      const rest = parts.slice(1).join(', ');
      const m = rest.match(/^(\d{4,6})\s*(.*)$/);
      if(m){ out.zip = m[1]; out.city = m[2] || ''; }
      else { out.city = rest; }
    }
    return out;
  }

  function normalizeProviderProfile(p){
    const base = { name:'', address:'', street:'', zip:'', city:'', mealWindow:DEFAULT_MEAL_WINDOW, mealStart:'11:30', mealEnd:'14:00', lunchWeekdays:[1,2,3,4,5], phone:'', email:'', website:'', logoData:'', kitchenEmail:'', autoSelloutTime:'', reuseEnabledByDefault:false, abholnummerEnabledByDefault:false };
    const out = {...base, ...(p||{})};
    if(!out.address){ out.address = buildAddress(out); }
    if(!out.mealWindow){ out.mealWindow = DEFAULT_MEAL_WINDOW; }
    if(!Array.isArray(out.lunchWeekdays)){ out.lunchWeekdays = [1,2,3,4,5]; }
    return out;
  }
  /** Wochentage-Array zu Anzeige-Text (1=Mo â€¦ 7=So) */
  function formatLunchWeekdays(arr){
    const labels = ['','Mo','Di','Mi','Do','Fr','Sa','So'];
    if(!arr || arr.length===0) return 'â€“';
    const sorted = [...arr].sort((a,b)=>a-b);
    if(sorted.length===7) return 'Moâ€“So';
    if(sorted.length===5 && sorted[0]===1 && sorted[4]===5) return 'Moâ€“Fr';
    return sorted.map(d=>labels[d]).filter(Boolean).join(', ');
  }

  function normalizeOffer(o){
    const out = {...(o||{})};
    if(!out.dish && out.title) out.dish = out.title;
    if(!out.imageUrl && out.img) out.imageUrl = out.img;
    if(!out.pickupWindow && out.time) out.pickupWindow = out.time;
    if(!out.category && out.diet) out.category = out.diet;

    if(out.address && (!out.providerStreet && !out.providerZip && !out.providerCity)){
      const parsed = parseAddress(out.address);
      out.providerStreet = out.providerStreet || parsed.street || '';
      out.providerZip = out.providerZip || parsed.zip || '';
      out.providerCity = out.providerCity || parsed.city || '';
    }
    out.providerStreet = out.providerStreet || '';
    out.providerZip = out.providerZip || '';
    out.providerCity = out.providerCity || '';
    out.hasPickupCode = !!out.hasPickupCode;
    out.dineInPossible = !!out.dineInPossible;
    if(out.active === undefined) out.active = true;
    const info = seededInfo(out.dish || out.providerName || out.providerId);
    if(out.distanceKm == null) out.distanceKm = info.distanceKm;
    if(out.rating == null) out.rating = info.rating;
    if(out.ratingCount == null) out.ratingCount = info.ratingCount;
    // Status wird nur Ã¼ber active gesteuert
    return out;
  }

  // --- Navigation ---
  const views = {
    start:'v-discover',
    discover:'v-discover', fav:'v-fav', orders:'v-orders', cart:'v-cart', profile:'v-profile',
    pickupCode:'v-pickup-code',
    checkout:'v-checkout',
    orderSuccess:'v-order-success', // AbholBestÃ¤tigung nach Zahlung
    providerLogin:'v-provider-login',
    providerOnboardingEntry:'v-provider-onboarding-entry',
    providerOnboardingFirstDish:'v-provider-onboarding-first-dish',
    providerOnboardingSignup:'v-provider-onboarding-signup',
    providerOnboardingBusiness:'v-provider-onboarding-business',
    providerOnboardingPreview:'v-provider-onboarding-preview',
    providerHome:'v-provider-home', providerPickups:'v-provider-pickups', providerCookbook:'v-provider-cookbook',
    providerProfile:'v-provider-profile', providerBilling:'v-provider-billing', providerWeek:'v-provider-week',
    legalImpressum:'v-legal-impressum', legalImpressumProvider:'v-legal-impressum-provider', legalAgbKurz:'v-legal-agb-kurz', legalAgbProvider:'v-legal-agb-provider', legalDatenschutz:'v-legal-datenschutz', legalAgbOnboarding:'v-legal-agb-onboarding', legalFaq:'v-legal-faq', legalSupport:'v-support', legalFaqProvider:'v-legal-faq-provider', version:'v-version'
  };

  function setCustomerNavActive(go){
    document.querySelectorAll('#customerNav .navbtn').forEach(b=>b.classList.toggle('active', b.dataset.go===go));
  }
  function setProviderNavActive(go){
    document.querySelectorAll('#providerNav .navbtn').forEach(b=>b.classList.toggle('active', b.dataset.pgo===go));
  }

  function showView(id){
    // Alle Views verstecken (inklusive explizites display:none fÃ¼r Abholnummer-Ansicht)
    document.querySelectorAll('.view').forEach(v=>{
      v.classList.remove('active');
      // Sicherstellen, dass Abholnummer-Ansicht definitiv versteckt ist, wenn nicht aktiv
      if(v.id === 'v-pickup-code' && id !== 'v-pickup-code'){
        v.style.display = 'none';
      }
    });
    const view = document.getElementById(id);
    if(!view){
      console.error('View not found:', id);
      // Fallback zur Discover-Seite
      const fallbackView = document.getElementById(views.discover || 'v-discover');
      if(fallbackView){
        fallbackView.classList.add('active');
    window.scrollTo({top:0,behavior:'smooth'});
      }
      return;
    }
    view.classList.add('active');
    // CSS-Regel Ã¼bernimmt jetzt das Display (flex fÃ¼r pickup-code, block fÃ¼r andere)
    if(id === 'v-checkout' || id === 'v-order-success'){
      view.style.display = 'block';
    }
    window.scrollTo({top:0,behavior:'smooth'});
    
    // Fullscreen-Abholnummer-Modal beim View-Wechsel schlieÃŸen (verhindert grÃ¼nes Overlay auf allen Seiten)
    if(typeof closeFullscreenCode === 'function') closeFullscreenCode();
    
    // Topbar: Kundefarben (Seite-1-Style) wenn Kundenseite aktiv
    const topbar = document.querySelector('.topbar');
    const customerViewIds = [views.start, views.discover, views.fav, views.orders, views.cart, views.profile, views.orderSuccess].filter(Boolean);
    if(topbar){
      if(customerViewIds.indexOf(id) !== -1) topbar.classList.add('customer-context');
      else topbar.classList.remove('customer-context');
    }
    
    // Topbar-Toggle nur in Discover-View anzeigen
    const toggleTopbar = document.getElementById('toggleDiscoverViewTopbar');
    if(toggleTopbar){
      toggleTopbar.style.display = (id === views.discover) ? 'flex' : 'none';
    }
    
    // FAB (Lust auf Inspiration?) nur auf Discover anzeigen â€“ sonst immer ausblenden
    const fabModeToggle = document.getElementById('fabModeToggle');
    if(fabModeToggle && id !== views.discover){
      fabModeToggle.style.display = 'none';
    }
  }

  function setMode(next, opts){
    opts = opts || {};
    mode = next;
    save(LS.mode, mode);

    const isProv = mode==='provider';
    const isStart = mode==='start';
    const isCustomer = mode==='customer';
    const customerNav = document.getElementById('customerNav');
    const providerNavWrap = document.getElementById('providerNavWrap');
    const providerNav = document.getElementById('providerNav');
    const modePill = document.getElementById('modePill');
    const statusIndicator = document.getElementById('providerStatusIndicator');
    
    if(customerNav) customerNav.style.display = (isCustomer || isStart) ? 'flex' : 'none';
    if(providerNavWrap) providerNavWrap.style.display = isProv ? 'block' : 'none';
    if(modePill) modePill.style.display = isProv ? 'inline-flex' : 'none';
    if(statusIndicator) statusIndicator.style.display = (isProv && provider.loggedIn) ? 'flex' : 'none';
    

    
    if(isProv && provider.loggedIn){
      document.body.classList.add('provider-mode');
    } else {
      document.body.classList.remove('provider-mode');
    }
    
    updateHeaderBasket();

    if(opts.skipView) return;

    if(isStart){
      if(!customer.loggedIn){
        setMode('customer');
        showDiscover();
        return;
      }
      showStart();
      return;
    }

    if(isProv){
      if(!provider.loggedIn){
        showView(views.providerLogin);
      } else {
        showProviderHome();
      }
    } else {
      showDiscover();
    }
  }

  // Logo-Click Handler (Home-Button)
  function handleLogoClick(){
    // Je nach Mode zur entsprechenden Startseite navigieren
    if(mode === 'provider'){
      showProviderHome();
    } else if(mode === 'start'){
      showStart();
    } else {
      // Customer Mode: Zur Discover-Seite
      showDiscover();
    }
  }
  
  /** Verhindert Browser-Warnung "pushState in trivial session history": bei nur einem Eintrag replaceState nutzen. */
  function pushViewState(state, url){
    url = url || location.pathname;
    if (typeof history.replaceState === 'function' && history.length === 1)
      history.replaceState(state, '', url);
    else if (typeof history.pushState === 'function')
      history.pushState(state, '', url);
  }

  // --- Start ---
  function showStart(){
    // Navigation auf "Entdecken" setzen (auch wenn wir auf Startseite sind)
    const navBtn = document.querySelector('#customerNav button[data-go="discover"]');
    if(navBtn){
      document.querySelectorAll('#customerNav .navbtn').forEach(b=>b.classList.remove('active'));
      navBtn.classList.add('active');
    }
    showView(views.start);
    renderStart();
    pushViewState({view: 'start', mode: mode}, location.pathname);
  }

  // --- Customer views ---
  function showDiscover(){
    setCustomerNavActive('discover');
    showView(views.discover);
    renderChips();
    renderDiscover();
    // Provider-FAB ausblenden (nur fÃ¼r Anbieter sichtbar)
    const fabProvider = document.getElementById('fabProviderAddOffer');
    const fabProviderLabel = document.getElementById('fabProviderAddOfferLabel');
    if(fabProvider) fabProvider.style.display = 'none';
    if(fabProviderLabel) fabProviderLabel.style.display = 'none';
    // Alle pickupCodeContainer leeren (falls vorhanden)
    document.querySelectorAll('[id="pickupCodeContainer"]').forEach(function(el){ el.innerHTML = ''; });
    // ZusÃ¤tzlich: dynamische Abholnummer-View (v-pickup-code-dynamic) explizit entfernen, falls sie auÃŸerhalb des Containers existiert
    const dynamicView = document.getElementById('v-pickup-code-dynamic');
    if(dynamicView && dynamicView.parentNode) dynamicView.parentNode.removeChild(dynamicView);
    // FAB anzeigen
    const fabModeToggle = document.getElementById('fabModeToggle');
    if(fabModeToggle) fabModeToggle.style.display = 'flex';
    // Topbar-Toggle anzeigen (nur in Discover-View)
    const toggleTopbar = document.getElementById('toggleDiscoverViewTopbar');
    if(toggleTopbar) toggleTopbar.style.display = 'flex';
    pushViewState({view: 'discover', mode: mode}, location.pathname);
  }
  function showFav(){
    setCustomerNavActive('fav');
    showView(views.fav);
    // Toggle im Topbar ausblenden
    const toggleTopbar = document.getElementById('toggleDiscoverViewTopbar');
    if(toggleTopbar) toggleTopbar.style.display = 'none';
    renderFavorites();
    // Vorschau-Sektion initial verstecken
    const upcomingPreview = document.getElementById('favUpcomingPreview');
    if(upcomingPreview){
      upcomingPreview.style.display = 'none';
      upcomingPreview.style.opacity = '0';
    }
    pushViewState({view: 'fav', mode: mode}, location.pathname);
  }
  function showOrders(){
    setCustomerNavActive('orders');
    showView(views.orders);
    renderOrders();
    pushViewState({view: 'orders', mode: mode}, location.pathname);
  }
  function showCart(){
    setCustomerNavActive('cart');
    showView(views.cart);
    renderCart();
    pushViewState({view: 'cart', mode: mode}, location.pathname);
  }
  function showProfile(){
    setCustomerNavActive('profile');
    // Abholnummer-Ansicht explizit verstecken, bevor Profil-Seite angezeigt wird
    const pickupCodeView = document.getElementById('v-pickup-code');
    if(pickupCodeView){
      pickupCodeView.style.display = 'none';
      pickupCodeView.classList.remove('active');
    }
    showView(views.profile);
    updateProfileView();
    lucide.createIcons();
    pushViewState({view: 'profile', mode: mode}, location.pathname);
  }
  
  // --- Abholnummer: kompakte Kachel + codeSheet ---
  let currentPickupOrderId = null;
  
  /** Ã–ffnet das Abholnummer-Sheet mit Order-Daten. */
  function openCodeSheetWithOrder(order){
    if(!order) return;
    const code = order.pickupCode || order.code || '';
    activeOrderId = order.id;
    const codeTextEl = document.getElementById('codeText');
    const codeProviderEl = document.getElementById('codeProvider');
    const codeSummaryEl = document.getElementById('codeSummary');
    const codePickupWindowEl = document.getElementById('codePickupWindow');
    const codePickupTimeEl = document.getElementById('codePickupTime');
    const codeStatusEl = document.getElementById('codeStatus');
    const btnToggle = document.getElementById('btnToggleOrderStatus');
    const isPickedUp = order.status === 'PICKED_UP' || order.status === 'abgeholt';
    if(codeTextEl) codeTextEl.textContent = code || 'â€“';
    if(codeProviderEl) codeProviderEl.textContent = order.providerName || 'Anbieter';
    if(codeSummaryEl) codeSummaryEl.textContent = order.dishName || order.summary || 'â€“';
    if(codePickupWindowEl) codePickupWindowEl.textContent = order.pickupWindow ? 'Essenszeit: ' + order.pickupWindow : 'Essenszeit: â€“';
    if(codePickupTimeEl) codePickupTimeEl.textContent = order.pickupTime || 'offen';
    if(codeStatusEl) codeStatusEl.textContent = isPickedUp ? 'Status: abgeholt' : 'Status: offen';
    if(btnToggle) btnToggle.textContent = isPickedUp ? 'Als offen markieren' : 'Als abgeholt markieren';
    const logoEl = document.getElementById('codeProviderLogo');
    if(logoEl){
      const offer = (typeof offers !== 'undefined' && offers && offers.length) ? offers.find(o => o.providerName === order.providerName) : null;
      if(offer && offer.providerLogo) logoEl.innerHTML = '<img src="' + (offer.providerLogo || '') + '" alt="Logo" />';
      else logoEl.innerHTML = '';
    }
    document.getElementById('codeBd').classList.add('active');
    document.getElementById('codeSheet').classList.add('active');
    if(typeof lucide !== 'undefined') setTimeout(function(){ lucide.createIcons(); }, 50);
  }
  
  function showPickupCode(orderId){
    const order = getOrderById(orderId);
    if(!order){
      showToast('Bestellung nicht gefunden');
      showDiscover();
      return;
    }
    if(order.status !== 'PAID' && order.status !== 'PICKED_UP'){
      showToast('Zahlung noch nicht bestÃ¤tigt');
      showOrders();
      return;
    }
    currentPickupOrderId = orderId;
    openCodeSheetWithOrder(order);
  }
  
  function renderPickupCode(order){}

  // --- Provider views ---
  function showProviderHome(){
    // Session-ValiditÃ¤t prÃ¼fen
    if(!checkSessionValidity()){
      // Session ungÃ¼ltig, wurde bereits ausgeloggt
      return;
    }
    
    setProviderNavActive('provider-home');
    showView(views.providerHome);
    renderProviderHome();
    
    // Connectivity-Check starten wenn Provider-Modus aktiv
    if(mode === 'provider' && provider.loggedIn){
      startConnectivityCheck();
      // Status-Ampel Icons rendern
      if(typeof lucide !== 'undefined'){
        setTimeout(() => lucide.createIcons(), 50);
      }
    }
    
    // FAB anzeigen
    const fab = document.getElementById('fabProviderAddOffer');
    const fabLabel = document.getElementById('fabProviderAddOfferLabel');
    if(fab) fab.style.display = 'flex';
    if(fabLabel) fabLabel.style.display = 'block';
    // ZurÃ¼ck-Zeile Ã¼ber der Nav ausblenden (nur auf Sub-Views sichtbar)
    const providerNavBackRow = document.getElementById('providerNavBackRow');
    if(providerNavBackRow) providerNavBackRow.style.display = 'none';
    
    pushViewState({view: 'provider-home', mode: mode}, location.pathname);
  }
  function showProviderPickups(){
    setProviderNavActive('provider-pickups');
    showView(views.providerPickups);
    renderProviderPickups();
    const fab = document.getElementById('fabProviderAddOffer');
    const fabLabel = document.getElementById('fabProviderAddOfferLabel');
    if(fab) fab.style.display = 'none';
    if(fabLabel) fabLabel.style.display = 'none';
    const providerNavBackRow = document.getElementById('providerNavBackRow');
    if(providerNavBackRow) providerNavBackRow.style.display = 'block';
    pushViewState({view: 'provider-pickups', mode: mode}, location.pathname);
  }
  function showProviderWeek(){
    setProviderNavActive('provider-home');
    showView(views.providerWeek);
    renderWeekPlan();
    // FAB ausblenden
    const fab = document.getElementById('fabProviderAddOffer');
    const fabLabel = document.getElementById('fabProviderAddOfferLabel');
    if(fab) fab.style.display = 'none';
    if(fabLabel) fabLabel.style.display = 'none';
    
    // Browser-Verlauf aktualisieren
    pushViewState({view: 'provider-week', mode: mode}, location.pathname);
  }
  function showProviderCookbook(){
    setProviderNavActive('provider-cookbook');
    showView(views.providerCookbook);
    renderCookbook();
    const fab = document.getElementById('fabProviderAddOffer');
    const fabLabel = document.getElementById('fabProviderAddOfferLabel');
    if(fab) fab.style.display = 'none';
    if(fabLabel) fabLabel.style.display = 'none';
    const providerNavBackRow = document.getElementById('providerNavBackRow');
    if(providerNavBackRow) providerNavBackRow.style.display = 'block';
    pushViewState({view: 'provider-cookbook', mode: mode}, location.pathname);
  }
  function showProviderProfileSub(subId){
    const main = document.getElementById('providerProfileMain');
    const subs = ['providerProfileSubBusiness','providerProfileSubTimes','providerProfileSubService','providerProfileSubPayment','providerProfileSubFaq'];
    if(main) main.style.display = subId ? 'none' : 'block';
    var targetId = subId ? 'providerProfileSub' + subId.charAt(0).toUpperCase() + subId.slice(1) : '';
    subs.forEach(function(id){
      var el = document.getElementById(id);
      if(el) el.style.display = (subId && id === targetId) ? 'block' : 'none';
    });
    if(subId === 'times' && typeof renderProviderProfileMealSelects === 'function') renderProviderProfileMealSelects();
    if(typeof lucide !== 'undefined') setTimeout(function(){ lucide.createIcons(); }, 50);
  }
  function showProviderProfile(){
    setProviderNavActive('provider-profile');
    showView(views.providerProfile);
    showProviderProfileSub(null);
    renderProviderProfile();
    const fab = document.getElementById('fabProviderAddOffer');
    const fabLabel = document.getElementById('fabProviderAddOfferLabel');
    if(fab) fab.style.display = 'none';
    if(fabLabel) fabLabel.style.display = 'none';
    const providerNavBackRow = document.getElementById('providerNavBackRow');
    if(providerNavBackRow) providerNavBackRow.style.display = 'block';
    pushViewState({view: 'provider-profile', mode: mode}, location.pathname);
  }
  function showProviderBilling(){
    setProviderNavActive('provider-profile');
    showView(views.providerBilling);
    renderBilling();
    
    // Browser-Verlauf aktualisieren
    pushViewState({view: 'provider-billing', mode: mode}, location.pathname);
  }

  // --- Chips render ---
  function renderChips(){
    const catEl = document.getElementById('catChips');
    const dayEl = document.getElementById('dayChips');
    if(!catEl || !dayEl){
      return;
    }
    catEl.innerHTML='';
    // Discover Filter Chips: "In der NÃ¤he" (default) + Kategorien
    const discoverCats = [
      {id: 'near', label: 'In der NÃ¤he', icon: null},
      {id: 'Vegan', label: 'Vegan', icon: 'leaf'},
      {id: 'Vegetarisch', label: 'Vegetarisch', icon: 'carrot'},
      {id: 'Fisch', label: 'Fisch', icon: 'fish'},
      {id: 'Mit Fleisch', label: 'Mit Fleisch', icon: 'drumstick'}
    ];
    
    discoverCats.forEach(cat=>{
      const b=document.createElement('button');
      b.className='discover-category-chip' + (activeDiscoverFilter === cat.id ? ' active' : '');
      b.innerHTML = cat.icon ? `${iconMarkup(cat.icon)}<span>${esc(cat.label)}</span>` : `<span>${esc(cat.label)}</span>`;
      b.onclick=()=>{
        activeDiscoverFilter = cat.id;
        renderChips();
        renderDiscover();
      };
      catEl.appendChild(b);
    });

    dayEl.innerHTML='';
    // Date Swipebar: Heute + nÃ¤chste 6 Tage
    const today = new Date();
    for(let i=0;i<7;i++){
      const d=new Date(today); d.setDate(d.getDate()+i);
      const key=isoDate(d);
      const b=document.createElement('button');
      b.className='discover-calendar-day'+(activeDay===key?' active':'');
      // Format: "Heute" fÃ¼r heute, sonst "Montag, 24.01."
      if(i===0){
        b.textContent = 'Heute';
      } else {
        b.textContent = fmtDay(d);
      }
      b.onclick=()=>{ activeDay=key; renderChips(); renderDiscover(); };
      dayEl.appendChild(b);
    }
  }

  function renderStartChips(){
    const catEl = document.getElementById('startCatChips');
    const dayEl = document.getElementById('startDayChips');
    if(!catEl || !dayEl){
      return;
    }
    catEl.innerHTML='';
    CATEGORIES.forEach(c=>{
      const b=document.createElement('button');
      b.className='chip'+(activeCat===c?' active':'');
      // Icon Mapping: Vegan=leaf, Vegetarisch=carrot, Mit Fleisch=drumstick
      const iconName = c==='Vegan' ? 'leaf' : (c==='Vegetarisch' ? 'carrot' : 'drumstick');
      b.innerHTML = `${iconMarkup(iconName)}<span>${esc(c)}</span>`;
      b.onclick=()=>{
        activeCat = activeCat===c ? null : c;
        renderStart();
        renderDiscover();
      };
      catEl.appendChild(b);
    });

    dayEl.innerHTML='';
    for(let i=0;i<5;i++){
      const d=new Date(); d.setDate(d.getDate()+i);
      const key=isoDate(d);
      const b=document.createElement('button');
      b.className='day'+(activeDay===key?' active':'');
      b.textContent = fmtDay(d);
      b.onclick=()=>{ activeDay=key; renderStart(); renderDiscover(); };
      dayEl.appendChild(b);
    }
  }

  function renderStart(){
    renderStartChips();
    renderStartDiscover();
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }

  function renderStartDiscover(){
    const grid = document.getElementById('startOfferGrid');
    const empty = document.getElementById('startEmptyOffers');
    const loc = document.getElementById('startLocationInput');
    
    if(!grid || !empty) return;

    // Standort-Suche
    if(loc){
      if(loc.value !== locationQuery) loc.value = locationQuery || '';
      loc.oninput=()=>{ locationQuery = loc.value; renderStart(); renderDiscover(); };
    }

    let list = offers.filter(o => o.day === activeDay && o.active !== false);

    if(activeCat){
      const cat = CAT_MAP[activeCat] || activeCat;
      list = list.filter(o => (o.category||'') === cat);
    }

    const q = String(locationQuery||'').trim().toLowerCase();
    if(q){
      list = list.filter(o=>{
        const data = normalizeOffer(o);
        const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity});
        return String(addr||'').toLowerCase().includes(q);
      });
    }

    // Normale Kacheln rendern
    grid.innerHTML='';
    empty.textContent = q ? 'Keine Angebote fÃ¼r diesen Standort.' : 'Noch keine Angebote. Demo: Als Anbieter ein Inserat erstellen.';
    empty.style.display = list.length ? 'none' : 'block';

    list.slice(0,6).forEach(o=> grid.appendChild(offerCard(o, {context:'start'})));
  }

  function createChatBubble(offer){
    const data = normalizeOffer(offer);
    const bubble = document.createElement('div');
    bubble.className='chat-bubble';
    bubble.onclick=()=>openOffer(data.id);
    
    const timeAgo = 'vor 2h'; // Placeholder
    const distance = data.distanceKm ? `${Number(data.distanceKm).toFixed(1)} km` : '';
    // Food type icon (keine Emojis)
    const foodTypeIcon = data.category === 'Vegan' ? 'leaf' : 
                         data.category === 'Vegetarisch' ? 'carrot' : 
                         data.category === 'Mit Fleisch' ? 'drumstick' : 
                         data.category === 'Fisch' ? 'fish' : '';
    
    bubble.innerHTML=`
      <div class="chat-bubble-header">
        <div class="chat-bubble-avatar">
          <img src="${esc(data.imageUrl || 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60')}" alt="${esc(data.providerName || '')}" />
        </div>
        <div class="chat-bubble-meta">
          <div class="chat-bubble-name">${esc(data.providerName || 'Anbieter')}</div>
          <div class="chat-bubble-time">
            ${iconMarkup('clock')}
            <span>${timeAgo}</span>
          </div>
        </div>
        ${distance ? `<div class="chat-bubble-distance">${distance}</div>` : ''}
      </div>
      ${data.imageUrl ? `<img src="${esc(data.imageUrl)}" alt="${esc(data.dish || '')}" class="chat-bubble-image" />` : ''}
      <div class="chat-bubble-message">
        Hey! Heute gibt's ${foodTypeIcon ? iconMarkup(foodTypeIcon) : ''} <strong>${esc(data.dish || 'Gericht')}</strong> fÃ¼r <strong>${euro(data.price || 0)}</strong> â€“ wer ist dabei?
      </div>
      <div class="chat-bubble-actions">
        <button class="chat-bubble-btn chat-bubble-btn-primary" onclick="event.stopPropagation(); const o=offers.find(x=>x.id==='${data.id}'); if(o) openOffer('${data.id}');">Dabei sein</button>
      </div>
    `;
    
    return bubble;
  }

  // --- Discover render (App-like UX, PWA, Light Mode) ---
  let activeDiscoverFilter = 'near'; // 'near', 'Vegan', 'Vegetarisch', 'Mit Fleisch', 'provider'
  let currentProviderFilter = null; // Provider-ID fÃ¼r Provider-Filter
  
  // Location-Autofill: Deutsche StÃ¤dte & PLZ (Demo-Daten)
  const locationSuggestions = [
    'Schorndorf', '73614', '73614 Schorndorf',
    'Jena', 'Erfurt', 'Weimar', 'Gera', 'Leipzig', 'Dresden', 'Berlin', 'MÃ¼nchen', 'Hamburg', 'KÃ¶ln',
    'Frankfurt', 'Stuttgart', 'DÃ¼sseldorf', 'Dortmund', 'Essen', 'Bremen', 'Hannover', 'NÃ¼rnberg',
    '07743', '07745', '07747', '07749', '99084', '99085', '99086', '99087', '99088', '99089', '99090',
    '99423', '99424', '99425', '99427', '99428', '07545', '07546', '07548', '07549', '07551', '07552'
  ];
  
  function filterLocationSuggestions(query){
    if(!query || query.length < 2) return [];
    const q = query.toLowerCase();
    return locationSuggestions.filter(loc => 
      loc.toLowerCase().includes(q) || 
      (q.length >= 3 && loc.toLowerCase().startsWith(q))
    ).slice(0, 5);
  }
  
  function renderDiscover(){
    // Date Bar rendern (neu)
    renderDiscoverDays();
    
    // Date Bar rendern (neu)
    if(typeof renderDiscoverDays === 'function') renderDiscoverDays();
    
    // Location-Autofill: Toggle & Input-Handler
    const btnDiscoverLocationGPS = document.getElementById('btnDiscoverLocationGPS');
    const btnDiscoverLocationText = document.getElementById('btnDiscoverLocationText');
    const discoverLocationExpanded = document.getElementById('discoverLocationExpanded');
    const discoverLocationInput = document.getElementById('discoverLocationInput');
    const discoverLocationSuggestions = document.getElementById('discoverLocationSuggestions');
    const discoverCurrentLocation = document.getElementById('discoverCurrentLocation');
    
    if(!locationQuery && !userLat){ locationQuery = DEFAULT_LOCATION_FALLBACK; userLat = SCHORNDORF_LAT; userLng = SCHORNDORF_LNG; if(discoverCurrentLocation) discoverCurrentLocation.textContent = DEFAULT_LOCATION_FALLBACK; }
    
    if(btnDiscoverLocationText && discoverLocationExpanded && discoverLocationInput){
      // Klick auf Text = manuelle Eingabe mit AutovervollstÃ¤ndigung
      btnDiscoverLocationText.onclick = (e)=>{
        e.preventDefault();
        e.stopPropagation();
        triggerHapticFeedback([10]);
        const isExpanded = discoverLocationExpanded.style.display === 'block';
        if(!isExpanded){
          const rect = btnDiscoverLocationText.getBoundingClientRect();
          discoverLocationExpanded.style.top = (rect.bottom + 6) + 'px';
          discoverLocationExpanded.style.left = Math.max(16, rect.left) + 'px';
          discoverLocationExpanded.style.right = 'auto';
          discoverLocationExpanded.style.display = 'block';
          discoverLocationInput.value = (locationQuery && locationQuery !== 'Aktueller Standort') ? locationQuery : '';
          if(typeof lucide !== 'undefined') lucide.createIcons();
          setTimeout(() => discoverLocationInput.focus(), 100);
        } else {
          discoverLocationExpanded.style.display = 'none';
          discoverLocationInput.value = '';
          if(discoverLocationSuggestions) discoverLocationSuggestions.innerHTML = '';
        }
      };
      
      // Location-Input mit Autofill
      discoverLocationInput.oninput = ()=>{
        const query = discoverLocationInput.value.trim();
        if(query.length >= 2){
          const suggestions = filterLocationSuggestions(query);
          if(suggestions.length > 0){
            discoverLocationSuggestions.innerHTML = suggestions.map(loc => {
              const safe = String(loc).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
              return `<div class="location-suggestion-item" data-loc="${safe}" style="padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(0,0,0,0.05); transition:background 0.2s ease;" onmouseover="this.style.background='rgba(0,0,0,0.05)';" onmouseout="this.style.background='transparent';">
                <div style="display:flex; align-items:center; gap:8px;">
                  <i data-lucide="map-pin" style="width:14px;height:14px; color:#666;"></i>
                  <span style="font-size:14px; font-weight:500; color:#333;">${safe}</span>
                </div>
              </div>`;
            }).join('');
            if(typeof lucide !== 'undefined') lucide.createIcons();
          } else {
            discoverLocationSuggestions.innerHTML = '';
          }
        } else {
          discoverLocationSuggestions.innerHTML = '';
        }
      };
      
      // Delegierter Klick auf VorschlÃ¤ge (data-loc statt onclick â€“ vermeidet Sonderzeichen-Bugs)
      discoverLocationSuggestions.onclick = (e)=>{
        const item = e.target.closest('.location-suggestion-item');
        if(item){
          const loc = item.getAttribute('data-loc');
          if(loc) selectLocation(loc);
        }
      };
      
      // Enter-Taste: Ersten Vorschlag auswÃ¤hlen oder aktuellen Wert Ã¼bernehmen
      discoverLocationInput.onkeydown = (e)=>{
        if(e.key === 'Enter'){
          e.preventDefault();
          const query = discoverLocationInput.value.trim();
          if(query){
            selectLocation(query);
          }
        } else if(e.key === 'Escape'){
          discoverLocationExpanded.style.display = 'none';
          discoverLocationInput.value = '';
          discoverLocationSuggestions.innerHTML = '';
        }
      };
      
      // SchlieÃŸen-Button im Standort-Dropdown
      const discoverLocationClose = document.getElementById('discoverLocationClose');
      if(discoverLocationClose){
        discoverLocationClose.onclick = () => {
          discoverLocationExpanded.style.display = 'none';
          discoverLocationInput.value = '';
          discoverLocationSuggestions.innerHTML = '';
        };
      }
      
      // Standort: Nadel (GPS) nur auf Klick â€“ kein Auto-GPS (vermeidet Flimmern/Fehler auf dem Handy)
      function requestUserLocation(){
        if(!navigator.geolocation){
          if(typeof showToast === 'function') showToast('GPS nicht verfÃ¼gbar', 2000);
          if(discoverLocationExpanded) discoverLocationExpanded.style.display = 'block';
          if(discoverLocationInput) discoverLocationInput.focus();
          return;
        }
        if(discoverCurrentLocation) discoverCurrentLocation.textContent = 'Ermittelnâ€¦';
        if(typeof showToast === 'function') showToast('Standort wird ermitteltâ€¦', 1000);
        navigator.geolocation.getCurrentPosition(
          (position)=>{
            userLat = position.coords.latitude;
            userLng = position.coords.longitude;
            locationQuery = 'Aktueller Standort';
            if(discoverCurrentLocation) discoverCurrentLocation.textContent = 'ðŸ“ Aktueller Standort';
            if(discoverLocationExpanded) discoverLocationExpanded.style.display = 'none';
            if(typeof showToast === 'function') showToast('Standort aktualisiert', 1500);
            renderDiscover();
          },
          (err)=>{
            locationQuery = DEFAULT_LOCATION_FALLBACK;
            userLat = SCHORNDORF_LAT;
            userLng = SCHORNDORF_LNG;
            if(discoverCurrentLocation) discoverCurrentLocation.textContent = DEFAULT_LOCATION_FALLBACK;
            if(discoverLocationExpanded) discoverLocationExpanded.style.display = 'none';
            renderDiscover();
          },
          { enableHighAccuracy: true, timeout: 12000, maximumAge: 300000 }
        );
      }
      if(btnDiscoverLocationGPS){ btnDiscoverLocationGPS.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); triggerHapticFeedback([10]); requestUserLocation(); }; }
      var discoverLocationBtnNadel = document.getElementById('discoverLocationBtnNadel');
      if(discoverLocationBtnNadel){ discoverLocationBtnNadel.onclick = function(){ triggerHapticFeedback([10]); requestUserLocation(); }; }
    }
    
    // Aktuellen Standort anzeigen (Fallback: Demo-Text wenn weder GPS noch Eingabe)
    if(discoverCurrentLocation){
      discoverCurrentLocation.textContent = locationQuery || 'Standortâ€¦';
    }
    const swipeLocationCity = document.getElementById('swipeLocationCity');
    if(swipeLocationCity){
      swipeLocationCity.textContent = locationQuery || 'Standortâ€¦';
    }
    
    // Globale Funktion fÃ¼r Location-Auswahl (Schorndorf setzt Koordinaten fÃ¼r Filter)
    window.selectLocation = function(loc){
      locationQuery = loc;
      if(/schorndorf|73614/i.test(String(loc))){
        userLat = SCHORNDORF_LAT;
        userLng = SCHORNDORF_LNG;
      }
      if(discoverCurrentLocation) discoverCurrentLocation.textContent = loc;
      // Swipe-Location synchronisieren
      const swipeLocationCity = document.getElementById('swipeLocationCity');
      if(swipeLocationCity) swipeLocationCity.textContent = loc;
      if(discoverLocationInput) discoverLocationInput.value = '';
      if(discoverLocationSuggestions) discoverLocationSuggestions.innerHTML = '';
      if(discoverLocationExpanded) discoverLocationExpanded.style.display = 'none';
      locationExpanded = false;
      triggerHapticFeedback([10]);
      renderDiscover();
    };
    
    // Standort-Suchfeld Ã¶ffnen (z. B. aus leerem Zustand â€žStandort Ã¤ndernâ€œ â€“ ohne prompt)
    window.openDiscoverLocationSearch = function(){
      const exp = document.getElementById('discoverLocationExpanded');
      const inp = document.getElementById('discoverLocationInput');
      if(exp && inp){
        exp.style.display = 'block';
        inp.value = (locationQuery && locationQuery !== DEFAULT_LOCATION_FALLBACK && locationQuery !== 'Aktueller Standort') ? locationQuery : '';
        inp.placeholder = 'PLZ oder Ort eingeben...';
        setTimeout(function(){ inp.focus(); }, 120);
        if(typeof lucide !== 'undefined') lucide.createIcons();
      }
    };
    
    // Search-Button: Expandiert Suchfeld bei Klick
    const btnDiscoverSearch = document.getElementById('btnDiscoverSearch');
    const discoverSearchExpanded = document.getElementById('discoverSearchExpanded');
    const discoverSearchInput = document.getElementById('discoverSearchInput');
    let searchExpanded = false;
    
    if(btnDiscoverSearch && discoverSearchExpanded && discoverSearchInput){
      btnDiscoverSearch.onclick = (e)=>{
        e.preventDefault();
        e.stopPropagation();
        triggerHapticFeedback([10]);
        
        if(!searchExpanded){
          discoverSearchExpanded.style.display = 'block';
          setTimeout(() => {
            discoverSearchInput.focus();
          }, 100);
          searchExpanded = true;
        } else {
          discoverSearchExpanded.style.display = 'none';
          discoverSearchInput.value = '';
          searchExpanded = false;
          renderDiscover();
        }
      };
      
      // Search-Input Handler
      discoverSearchInput.oninput = ()=>{
        const query = discoverSearchInput.value.trim().toLowerCase();
        if(query){
          // Filtere Angebote nach Suchbegriff
          // Wird in renderDiscover() berÃ¼cksichtigt
          locationQuery = query; // TemporÃ¤r fÃ¼r Suche nutzen
          renderDiscover();
        } else {
          locationQuery = '';
          renderDiscover();
        }
      };
      
      // ESC zum SchlieÃŸen
      discoverSearchInput.onkeydown = (e)=>{
        if(e.key === 'Escape'){
          discoverSearchExpanded.style.display = 'none';
          discoverSearchInput.value = '';
          searchExpanded = false;
          locationQuery = '';
          renderDiscover();
        }
      };
    }
    
    // Standard-Start: App Ã¶ffnet sich immer in Listenform
    if(discoverViewMode !== 'list'){
      discoverViewMode = 'list';
      save(LS.discoverView, discoverViewMode);
    }
    switchDiscoverView(discoverViewMode);
    
    // Angebote filtern: Nur heute + Zeit-Filter (10 Min Gehzeit oder 15 Min Fahrzeit)
    let list = offers.filter(o => o.day === activeDay && o.active !== false);
    
    // Zeit-Filter: Standard 10 Min Gehzeit (5 km/h = 12 Min/km), optional 15 Min Fahrzeit (50 km/h = 1.2 Min/km)
    if(activeTimeFilter === 'walking'){
      // Standard: Gehzeit <= 10 Min
      list = list.filter(o => {
        const data = normalizeOffer(o);
        if(data.distanceKm == null) return false; // Keine Entfernung = ausblenden
        const walkingMinutes = Math.round(Number(data.distanceKm) * 12);
        return walkingMinutes <= 10;
      });
    } else if(activeTimeFilter === 'driving'){
      // Erweitert: Fahrzeit <= 15 Min
      list = list.filter(o => {
        const data = normalizeOffer(o);
        if(data.distanceKm == null) return false; // Keine Entfernung = ausblenden
        const carMinutes = Math.round(Number(data.distanceKm) * 1.2);
        return carMinutes <= 15;
      });
    }
    
    // ErnÃ¤hrungs-PrÃ¤ferenzen Filter (aus Profil)
    if(customer && customer.dietaryPreferences){
      const prefs = customer.dietaryPreferences;
      list = list.filter(o => {
        const normalized = normalizeOffer(o);
        const category = normalized.category || '';
        const allergens = normalized.allergens || [];
        
        // Vegan: Nur "Vegan" Kategorie
        if(prefs.vegan && category !== 'Vegan') return false;
        
        // Vegetarisch: "Vegan" oder "Vegetarisch" (aber nicht "Mit Fleisch" oder "Fisch")
        if(prefs.vegetarian && (category === 'Mit Fleisch' || category === 'Fisch')) return false;
        
        // Glutenfrei: Keine glutenhaltigen Allergene
        if(prefs.glutenFree && allergens.some(a => 
          a.toLowerCase().includes('gluten') || 
          a.toLowerCase().includes('weizen') ||
          a.toLowerCase().includes('dinkel')
        )) return false;
        
        // Laktosefrei: Keine laktosehaltigen Allergene
        if(prefs.lactoseFree && allergens.some(a => 
          a.toLowerCase().includes('laktose') || 
          a.toLowerCase().includes('milch') ||
          a.toLowerCase().includes('kÃ¤se')
        )) return false;
        
        return true;
      });
    }
    
    // Provider-Filter (wenn aktiv)
    if(activeDiscoverFilter === 'provider' && currentProviderFilter){
      list = list.filter(o => o.providerId === currentProviderFilter);
    }
    
    // Kategorie-Filter (entferne doppelte "In der NÃ¤he" Filterung)
    if(activeDiscoverFilter !== 'near' && activeDiscoverFilter !== 'provider'){
      const cat = CAT_MAP[activeDiscoverFilter] || activeDiscoverFilter;
      list = list.filter(o => (o.category||'') === cat);
    }
    // "In der NÃ¤he" zeigt alle Angebote (keine zusÃ¤tzliche Filterung)
    
    // Standort-Filter
    const q = String(locationQuery||'').trim().toLowerCase();
    if(q){
      list = list.filter(o=>{
        const data = normalizeOffer(o);
        const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity});
        return String(addr||'').toLowerCase().includes(q);
      });
    }
    
    // List Cards rendern (Modern Style)
    const offersEl = document.getElementById('discoverOffers');
    const emptyEl = document.getElementById('discoverEmpty');
    
    // Categories rendern (nur einmal oder bei Ã„nderung)
    renderDiscoverCategories();

    if(offersEl && emptyEl){
      // Skeleton-Loader anzeigen wÃ¤hrend Daten geladen werden
      offersEl.innerHTML = '';
      for(let i = 0; i < 3; i++){
        offersEl.appendChild(createSlimCardSkeleton());
      }
      
      // Kurze VerzÃ¶gerung fÃ¼r bessere UX (simuliert Ladezeit)
      setTimeout(() => {
      offersEl.innerHTML = '';
      emptyEl.style.display = list.length ? 'none' : 'block';
      
      // Entscheidungs-Kacheln (2x2 Grid) - Heute-Fokus mit 3 SÃ¤ulen
      // PrÃ¼fe ob Grid-Modus aktiviert werden soll (kann spÃ¤ter als Toggle implementiert werden)
      const useDecisionTiles = false; // Standard: Liste, kann auf true gesetzt werden fÃ¼r Grid
      
      if(useDecisionTiles){
        // ... grid code ...
      } else {
        // Modern List Cards
        list.forEach(o=> {
          const card = createModernOfferCard(o);
          offersEl.appendChild(card);
        });
      }
    
      // Icons aktualisieren nach dem Rendern
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
      }, 300); // 300ms Delay fÃ¼r realistische Ladezeit
    }
    
    // Demo: Match-Screen Test (kann spÃ¤ter durch Swipe-System ersetzt werden)
    // Wenn ein Gericht angeklickt wird und es hasPickupCode hat, kÃ¶nnte man showMatchModal aufrufen
  }
  
  // Swipe-View State (mit LocalStorage-Persistenz)
  let discoverViewMode = load(LS.discoverView, 'list'); // 'list' oder 'swipe'
  
  // Zeit-Filter State (Standard: 10 Min Gehzeit)
  let activeTimeFilter = load('mittagio_timeFilter', 'walking'); // 'walking' (10 min) oder 'driving' (15 min)
  
  // Swipe-Location-Info aktualisieren
  function updateSwipeLocationInfo(){
    const swipeLocationCity = document.getElementById('swipeLocationCity');
    const swipeReachabilityText = document.getElementById('swipeReachabilityText');
    const discoverCurrentLocation = document.getElementById('discoverCurrentLocation');
    
    // Standort synchronisieren (nur der Stadtname, nicht das Icon)
    if(swipeLocationCity && discoverCurrentLocation){
      const citySpan = swipeLocationCity.querySelector('.city');
      if(citySpan){
        citySpan.textContent = discoverCurrentLocation.textContent || DEFAULT_LOCATION_FALLBACK;
      } else {
        // Fallback: Falls .city nicht existiert, gesamten Text aktualisieren
        swipeLocationCity.innerHTML = `<span class="icon">ðŸ“</span><span class="city">${discoverCurrentLocation.textContent || DEFAULT_LOCATION_FALLBACK}</span>`;
      }
    } else if(swipeLocationCity){
      const citySpan = swipeLocationCity.querySelector('.city');
      if(citySpan){
        citySpan.textContent = locationQuery || DEFAULT_LOCATION_FALLBACK;
      } else {
        swipeLocationCity.innerHTML = `<span class="icon">ðŸ“</span><span class="city">${locationQuery || DEFAULT_LOCATION_FALLBACK}</span>`;
      }
    }
    
    // Erreichbarkeits-Info aktualisieren (basierend auf aktivem Zeit-Filter)
    if(swipeReachabilityText){
      if(activeTimeFilter === 'walking'){
        swipeReachabilityText.textContent = 'In deiner NÃ¤he (ðŸ‘£ 10 Min. / ðŸš— 15 Min.)';
      } else {
        swipeReachabilityText.textContent = 'In deiner NÃ¤he (ðŸ‘£ 10 Min. / ðŸš— 15 Min.)';
      }
    }
  }
  
  // Initialisiere FAB State
  setTimeout(() => {
    if(typeof syncToggleState === 'function') syncToggleState();
  }, 100);
  let swipeCards = [];
  let currentSwipeIndex = 0;
  
  function switchDiscoverView(mode){
    mode = 'list'; // Force list (Swipe removed)
    discoverViewMode = 'list';
    save(LS.discoverView, mode); // PrÃ¤ferenz speichern
    
    const listEl = document.getElementById('discoverOffers');
    const swipeEl = document.getElementById('discoverSwipe');
    
    if(mode === 'swipe'){
      if(listEl) listEl.style.display = 'none';
      if(swipeEl) {
        swipeEl.style.display = 'flex';
        swipeEl.style.flexDirection = 'column';
        swipeEl.style.alignItems = 'center';
        swipeEl.style.justifyContent = 'flex-start';
        swipeEl.style.height = 'calc(100vh - 180px)';
        swipeEl.style.minHeight = '480px';
        swipeEl.style.maxHeight = 'none';
        swipeEl.style.padding = '12px 0';
        swipeEl.style.width = '100%';
        swipeEl.style.overflow = 'hidden';
      }
      swipeFiltersSelected = false;
      const intro = document.getElementById('swipeFilterIntro');
      const area = document.getElementById('swipeStackArea');
      if(intro){ intro.style.display = 'block'; }
      if(area){ area.style.display = 'none'; }
      setupSwipeFilterHandlers();
      updateSwipeLocationInfo();
    } else {
      if(listEl) listEl.style.display = 'block';
      if(swipeEl) {
        swipeEl.style.display = 'none';
        swipeEl.style.height = '75vh';
        swipeEl.style.minHeight = '480px';
        swipeEl.style.maxHeight = '600px';
      }
    }
    
    if(typeof lucide !== 'undefined'){
      setTimeout(() => lucide.createIcons(), 50);
    }
  }
  
  // SwipeCards rendern - ENTFERNT
  function renderSwipeCards(){ return;
    // Standort und Erreichbarkeits-Info aktualisieren
    updateSwipeLocationInfo();
    const swipeStack = document.getElementById('swipeStack');
    const swipeEmpty = document.getElementById('swipeEmpty');
    if(!swipeStack) return;
    
    // Filtere Angebote: Nur heute + Zeit-Filter (10 Min Gehzeit oder 15 Min Fahrzeit)
    // KEINE Kategorie-Filter, KEINE ErnÃ¤hrungs-PrÃ¤ferenzen - reiner Ãœberraschungs-Modus
    let list = offers.filter(o => o.day === activeDay && o.active !== false);
    
    // Zeit-Filter: Standard 10 Min Gehzeit (5 km/h = 12 Min/km), optional 15 Min Fahrzeit (50 km/h = 1.2 Min/km)
    if(activeTimeFilter === 'walking'){
      // Standard: Gehzeit <= 10 Min
      list = list.filter(o => {
        const data = normalizeOffer(o);
        if(data.distanceKm == null) return false; // Keine Entfernung = ausblenden
        const walkingMinutes = Math.round(Number(data.distanceKm) * 12);
        return walkingMinutes <= 10;
      });
    } else if(activeTimeFilter === 'driving'){
      // Erweitert: Fahrzeit <= 15 Min
      list = list.filter(o => {
        const data = normalizeOffer(o);
        if(data.distanceKm == null) return false; // Keine Entfernung = ausblenden
        const carMinutes = Math.round(Number(data.distanceKm) * 1.2);
        return carMinutes <= 15;
      });
    }
    
    const q = String(locationQuery||'').trim().toLowerCase();
    if(q){
      list = list.filter(o=>{
        const data = normalizeOffer(o);
        const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity});
        return String(addr||'').toLowerCase().includes(q);
      });
    }
    
    // Kategorie-Filter (Fleisch / Vegetarisch / Salat)
    if(activeSwipePreference){
      list = list.filter(o => {
        const data = normalizeOffer(o);
        const cat = (data.category || data.diet || '').toLowerCase();
        if(activeSwipePreference === 'fleisch') return cat.includes('fleisch') || cat.includes('meat');
        if(activeSwipePreference === 'vegetarisch') return cat.includes('vegetarisch') || cat.includes('vegan') || cat.includes('veggie');
        if(activeSwipePreference === 'salat') return cat.includes('salat') || cat.includes('bowl') || cat.includes('salad');
        return false;
      });
    }
    
    // Filter: Entferne bereits gelikte oder abgelehnte Gerichte
    const favorites = JSON.parse(localStorage.getItem('mittagio_favorites') || '[]');
    const disliked = JSON.parse(sessionStorage.getItem('mittagio_disliked') || '[]');
    
    list = list.filter(o => {
      const data = normalizeOffer(o);
      const dishKey = data.id;
      // Zeige nur Gerichte, die weder geliked noch abgelehnt wurden
      return !favorites.includes(dishKey) && !disliked.includes(dishKey);
    });
    
    swipeCards = list;
    currentSwipeIndex = 0;
    
    swipeStack.innerHTML = '';
    
    // Debug-Overlay aktualisieren
    const debugOverlay = document.getElementById('swipeCurrentIndex');
    if(debugOverlay){
      debugOverlay.textContent = '0';
    }
    
    if(swipeCards.length === 0){
      if(swipeEmpty) swipeEmpty.style.display = 'block';
      const swipeEndOfStack = document.getElementById('swipeEndOfStack');
      if(swipeEndOfStack) swipeEndOfStack.style.display = 'none';
      return;
    }
    
    if(swipeEmpty) swipeEmpty.style.display = 'none';
    const swipeEndOfStack = document.getElementById('swipeEndOfStack');
    if(swipeEndOfStack) swipeEndOfStack.style.display = 'none';
    
    // Erstelle nur die ersten 3 Karten (Performance)
    const cardsToShow = Math.min(3, swipeCards.length);
    for(let i = 0; i < cardsToShow; i++){
      const card = createSwipeCard(swipeCards[i], i);
      swipeStack.appendChild(card);
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }
  
  // SwipeCard erstellen - ENTFERNT
  function createSwipeCard(offer, index){ return null;
    const data = normalizeOffer(offer);
    const card = document.createElement('div');
    card.className = 'swipe-card';
    card.dataset.offerId = data.id;
    card.dataset.swipeIndex = index;
    card.dataset.category = (data.category || data.diet || '').toLowerCase(); // FÃ¼r Filter-Logik
    card.style.zIndex = 100 - index;
    
    // Tinder-Stack: Random Rotation (-2Â° bis +2Â°) fÃ¼r Stapel-Effekt
    const randomRotation = (Math.random() * 4 - 2); // -2 bis +2 Grad
    const scale = 1 - index * 0.04;
    const translateY = index * 12;
    card.style.transform = `translate(-50%, calc(-50% + ${translateY}px)) scale(${scale}) rotate(${index > 0 ? randomRotation : 0}deg)`;
    card.style.opacity = index === 0 ? 1 : 0.92;
    
    // Float/Waber-Animation nur fÃ¼r die aktive (oberste) Karte
    if(index === 0){
      card.classList.add('active-float');
    }
    
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    
    // PrÃ¼fe Provider-Daten fÃ¼r Badges
    const offerProvider = offers.find(p => p.providerId === data.providerId);
    const orderingEnabled = offerProvider && (offerProvider.orderingEnabled !== false && (data.hasPickupCode || offerProvider.hasPickupCode));
    const hasReuseSupport = offerProvider && (offerProvider.reuseEnabled || offerProvider.reuse || (offerProvider.providerProfile && offerProvider.providerProfile.reuseEnabled));
    const hasDineIn = offerProvider && (offerProvider.dineInPossible !== false || data.dineInPossible);
    
    // PrÃ¼fe ob Gericht bereits favorisiert ist
    const favorites = JSON.parse(localStorage.getItem('mittagio_favorites') || '[]');
    const dishKey = data.id;
    const isFavorited = favorites.includes(dishKey);
    
    // Mittagessen-Tinder: 3 SÃ¤ulen als Balken unter dem Anbieter (keine Icons auf dem Bild)
    card.innerHTML = `
      <div class="swipe-card-content">
        <!-- Bild mit Herz-Icon und Preis-Sticker (ohne SÃ¤ulen-Overlay) -->
        <div class="swipe-card-image-wrapper">
          <div class="swipe-card-image">
            <img src="${esc(imgSrc)}" alt="${esc(data.dish||'')}" />
            <div class="swipe-card-heart-icon" style="position:absolute; top:12px; right:12px; width:44px; height:44px; background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 8px rgba(0,0,0,0.15); z-index:15; cursor:pointer; transition:all 0.2s ease;" title="${isFavorited ? 'Aus Favoriten entfernen' : 'Zu Favoriten hinzufÃ¼gen'}">
              <span style="font-size:20px; ${isFavorited ? 'color:#E34D4D;' : 'color:#999;'}">${isFavorited ? 'â¤ï¸' : 'ðŸ¤'}</span>
            </div>
            <div class="swipe-card-price-sticker">${euro(data.price)}</div>
          </div>
        </div>
        
        <!-- Titel-Sektion: Direkt unter dem Bild -->
        <div class="swipe-card-title-section" style="width:100%; padding:16px 12px 0; text-align:center;">
          <h2 class="swipe-card-title">${esc(data.dish||'Gericht')}</h2>
          <p class="swipe-card-provider">${esc(data.providerName||'Anbieter')}</p>
          <div style="margin-top:12px; padding:0 8px;">${renderPillarBars(hasDineIn, orderingEnabled, hasReuseSupport)}</div>
        </div>
        
        <!-- Logistik-Sektion: Distanzen, Essenszeit & Allergene -->
        <div class="swipe-card-logistics-section" style="width:100%; padding:12px 16px 0; margin-top:8px;">
          ${(() => {
            // Distanzberechnung
            const distanceKm = data.distanceKm || 0;
            const walkingMeters = Math.round(distanceKm * 1000);
            const walkingMinutes = Math.round(distanceKm * 12); // 5 km/h = 12 Min/km
            const carMinutes = Math.round(distanceKm * 1.2); // 50 km/h = 1.2 Min/km
            
            // Essenszeit formatieren
            let timeWindowHtml = '';
            if(data.pickupWindow){
              const timeMatch = data.pickupWindow.match(/(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/);
              if(timeMatch){
                const fromTime = timeMatch[1] + ':' + timeMatch[2];
                const toTime = timeMatch[3] + ':' + timeMatch[4];
                timeWindowHtml = `<div style="display:flex; align-items:center; gap:6px; font-size:13px; color:#666; margin-bottom:8px;">
                  <span>ðŸ•’</span>
                  <span>von ${fromTime} bis ${toTime} Uhr</span>
                </div>`;
              }
            }
            
            // Allergene-Link (nur wenn vorhanden)
            let allergensHtml = '';
            if(data.allergens && Array.isArray(data.allergens) && data.allergens.length > 0){
              const allergenCount = data.allergens.length;
              allergensHtml = `<div style="display:flex; align-items:center; gap:6px; font-size:13px; color:#666; cursor:pointer; text-decoration:underline; margin-top:8px;" onclick="showSwipeAllergensOverlay('${esc(data.id)}'); event.stopPropagation();" title="Allergene anzeigen">
                <span>Allergene anzeigen</span>
                <span style="font-size:12px;">â“˜</span>
              </div>`;
            }
            
            return `
              <!-- Doppelte Distanzanzeige: Parallel -->
              <div style="display:flex; justify-content:center; align-items:center; gap:20px; margin-bottom:8px; flex-wrap:wrap;">
                <div style="display:flex; align-items:center; gap:6px; font-size:13px; color:#666;">
                  <span>ðŸš¶</span>
                  <span>${walkingMeters < 1000 ? walkingMeters + 'm' : (walkingMeters / 1000).toFixed(1) + 'km'} â€¢ ${walkingMinutes} Min</span>
                </div>
                <div style="display:flex; align-items:center; gap:6px; font-size:13px; color:#666;">
                  <span>ðŸš—</span>
                  <span>${distanceKm.toFixed(1)}km â€¢ ${carMinutes} Min</span>
                </div>
              </div>
              
              ${timeWindowHtml}
              
              ${allergensHtml}
            `;
          })()}
        </div>
      </div>
    `;
    
    // Herz-Icon Click-Handler
    const heartIcon = card.querySelector('.swipe-card-heart-icon');
    if(heartIcon){
      heartIcon.onclick = (e) => {
        e.stopPropagation();
        triggerHapticFeedback([10]);
        const favorites = JSON.parse(localStorage.getItem('mittagio_favorites') || '[]');
        const dishKey = data.id;
        
        if(favorites.includes(dishKey)){
          // Entfernen
          const index = favorites.indexOf(dishKey);
          favorites.splice(index, 1);
          localStorage.setItem('mittagio_favorites', JSON.stringify(favorites));
          heartIcon.querySelector('span').innerHTML = 'ðŸ¤ðŸ´';
          heartIcon.querySelector('span').style.color = '#999';
          showToast('Aus Favoriten entfernt', 1000);
        } else {
          // HinzufÃ¼gen
          favorites.push(dishKey);
          localStorage.setItem('mittagio_favorites', JSON.stringify(favorites));
          heartIcon.querySelector('span').innerHTML = 'â¤ï¸ðŸ´';
          heartIcon.querySelector('span').style.color = '#E34D4D';
          showToast('Zu Favoriten hinzugefÃ¼gt', 1000);
        }
      };
    }
    
    return card;
  }
  
  // Allergene-Overlay fÃ¼r Swipe-Karten
  window.showSwipeAllergensOverlay = function(offerId){
    const offer = offers.find(x => x.id === offerId);
    if(!offer) return;
    
    const o = normalizeOffer(offer);
    if(!o || !o.allergens || o.allergens.length === 0) return;
    
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; display:flex; align-items:center; justify-content:center; padding:20px;';
    overlay.onclick = (e) => {
      if(e.target === overlay) {
        document.body.removeChild(overlay);
      }
    };
    
    const content = document.createElement('div');
    content.style.cssText = 'background:linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); border-radius:24px; padding:24px; max-width:420px; width:100%; border:2px solid rgba(255,255,255,0.1); box-shadow:0 8px 32px rgba(0,0,0,0.5); max-height:90vh; overflow:hidden; display:flex; flex-direction:column;';
    content.onclick = (e) => e.stopPropagation();
    
    // Allergene-Mapping (vereinfacht - sollte mit ALLERGENE_STANDARD arbeiten)
    const raw = o.allergens.map(a => String(a||'').trim());
    const codes = [];
    raw.forEach(v => {
      const u = v.toUpperCase();
      if(typeof ALLERGENE_STANDARD !== 'undefined' && ALLERGENE_STANDARD[u]){ 
        codes.push(u); 
        return; 
      }
      // Fallback: Direkt verwenden wenn kein Mapping vorhanden
      if(u.length === 1 && u >= 'A' && u <= 'R'){
        codes.push(u);
      }
    });
    const seen = {};
    const unique = codes.filter(c => { if(seen[c]) return false; seen[c]=1; return true; });
    
    const allergenList = unique.map(code => {
      const fullLabel = (typeof ALLERGENE_STANDARD !== 'undefined' && ALLERGENE_STANDARD[code]) 
        ? ALLERGENE_STANDARD[code] 
        : `Allergen ${code}`;
      const firstWord = typeof allergenFirstWord === 'function' ? allergenFirstWord(fullLabel) : String(fullLabel).trim().split(/\s+/)[0] || fullLabel;
      return `<div style="display:flex; align-items:center; gap:10px; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.1);">
        <i data-lucide="shield-alert" style="width:20px;height:20px;color:rgba(255,255,255,0.8);flex-shrink:0;"></i>
        <span style="color:rgba(255,255,255,0.9); font-weight:700; font-size:14px; flex-shrink:0;">${esc(code)}</span>
        <span style="color:rgba(255,255,255,0.85); font-size:14px;">${esc(firstWord)}</span>
      </div>`;
    }).join('');
    
    const disclaimer = 'FÃ¼r die Richtigkeit und AktualitÃ¤t der Angaben ist ausschlieÃŸlich der Anbieter verantwortlich. Bei schweren Allergien halten Sie bitte RÃ¼cksprache mit dem Personal vor Ort.';
    
    content.innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; flex-shrink:0;">
        <h3 style="color:#fff; font-size:20px; font-weight:900; margin:0;">Allergene & Informationen</h3>
        <button type="button" onclick="this.closest('[style*=\\'position:fixed\\']').remove();" style="background:none; border:none; color:#fff; cursor:pointer; padding:4px; display:flex; align-items:center; justify-content:center;">
          <i data-lucide="x" style="width:20px;height:20px;"></i>
        </button>
      </div>
      <div style="padding:12px 14px; background:rgba(255,255,255,0.06); border-radius:12px; border:1px solid rgba(255,255,255,0.1); margin-bottom:16px; flex-shrink:0; font-size:12px; color:rgba(255,255,255,0.85); line-height:1.5;">
        ${esc(disclaimer)}
      </div>
      <div style="max-height:280px; overflow-y:auto; flex:1; min-height:0;">
        ${allergenList || '<p style="color:rgba(255,255,255,0.5); font-size:14px;">Keine passenden Allergene in der Standard-Liste.</p>'}
      </div>
    `;
    
    overlay.appendChild(content);
    document.body.appendChild(overlay);
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  };
  
  // Button-Handler fÃ¼r Polaroid-Modus: Rot (Nein), Grau (Weiter), GrÃ¼n (Ja)
  function setupSwipeButtons(){
    // Exit-Button (X oben rechts) - bereits im neuen Header vorhanden
    const btnExit = document.getElementById('btnSwipeExit');
    if(btnExit){
      btnExit.onclick = () => {
        switchDiscoverView('list');
        showToast('Zur Listenansicht gewechselt');
      };
    }
    
    // Share-Button (oben rechts im Header)
    const btnShare = document.getElementById('btnSwipeShare');
    if(btnShare){
      btnShare.onclick = () => {
        triggerHapticFeedback([10]);
        const swipeStack = document.getElementById('swipeStack');
        if(!swipeStack) return;
        const allCards = Array.from(swipeStack.querySelectorAll('.swipe-card')).filter(c => {
          if(!c || !c.style) return false;
          const opacity = c.style.opacity;
          return opacity !== '0' && opacity !== '0px' && opacity !== 0 && c.style.display !== 'none';
        });
        const currentCard = allCards.length > 0 ? allCards[0] : null;
        if(currentCard && currentCard.dataset){
          const offerId = currentCard.dataset.offerId;
          const offer = offers.find(o => o.id === offerId);
          if(offer){
            const data = normalizeOffer(offer);
            const shareText = `Schau dir "${data.dish}" von ${data.providerName} auf MITTAGIO an! ðŸ½ï¸`;
            const shareUrl = window.location.href.split('#')[0] + '#offer=' + offerId;
            
            if(navigator.share){
              navigator.share({
                title: data.dish,
                text: shareText,
                url: shareUrl
              }).catch(() => {
                // Fallback: Kopiere URL in Zwischenablage
                navigator.clipboard.writeText(shareUrl);
                showToast('Link kopiert!', 2000);
              });
            } else {
              // Fallback: Kopiere URL in Zwischenablage
              navigator.clipboard.writeText(shareUrl);
              showToast('Link kopiert!', 2000);
            }
          }
        }
      };
    }
    
    // Standort-Info beim Swipe-Modus aktualisieren
    updateSwipeLocationInfo();
    
    // Rot-Button: Nein (Ablehnen)
    const btnReject = document.getElementById('btnSwipeReject');
    // X-Button: Ablehnen (Fly-Out Links)
    if(btnReject){
      btnReject.onclick = () => {
        const swipeStack = document.getElementById('swipeStack');
        if(!swipeStack) return;
        const allCards = Array.from(swipeStack.querySelectorAll('.swipe-card:not(.fly-out-left):not(.fly-out-right)')).filter(c => c.style.opacity !== '0');
        const currentCard = allCards.length > 0 ? allCards[0] : null;
        if(!currentCard || !currentCard.dataset) return;
        const offerId = currentCard.dataset.offerId;
        const offer = offers.find(o => o.id === offerId);
        if(offer){
          triggerHapticFeedback([20]);
          rejectOffer(offer);
          currentCard.classList.remove('active-float');
          currentCard.classList.add('fly-out-left');
          setTimeout(() => {
            if(currentCard.parentNode) currentCard.remove();
            currentSwipeIndex++;
            setTimeout(() => showNextSwipeCard(), 50);
          }, 450);
        }
      };
    }
    
    // Herz-Button: Zustimmen / Match (Fly-Out Rechts)
    const btnLike = document.getElementById('btnSwipeLike');
    if(btnLike){
      btnLike.onclick = () => {
        const swipeStack = document.getElementById('swipeStack');
        if(!swipeStack) return;
        const allCards = Array.from(swipeStack.querySelectorAll('.swipe-card:not(.fly-out-left):not(.fly-out-right)')).filter(c => c.style.opacity !== '0');
        const currentCard = allCards.length > 0 ? allCards[0] : null;
        if(!currentCard || !currentCard.dataset) return;
        const offerId = currentCard.dataset.offerId;
        const offer = offers.find(o => o.id === offerId);
        if(offer){
          triggerHapticFeedback([20, 10, 30]);
          acceptOffer(offer);
          currentCard.classList.remove('active-float');
          currentCard.classList.add('fly-out-right');
          setTimeout(() => {
            if(currentCard.parentNode) currentCard.remove();
            currentSwipeIndex++;
            setTimeout(() => showNextSwipeCard(), 50);
          }, 450);
        }
      };
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(() => lucide.createIcons(), 50);
    }
  }
  
  // Button-basierte Interaktion
  
  // Haptic Feedback (verbessert: kurze, dezent Vibration)
  function triggerHapticFeedback(pattern = [15]){
    if('vibrate' in navigator){
      navigator.vibrate(pattern); // Standard: 15ms, oder Pattern wie [10, 5, 10]
    }
  }
  
  function rejectOffer(offer){
    // Nein = Ablehnen - In SessionStorage speichern
    if(!offer || !offer.id){
      console.error('Invalid offer in rejectOffer:', offer);
      return;
    }
    
    const data = normalizeOffer(offer);
    const dishKey = data.id;
    
    // Zu Ablehnungs-Liste hinzufÃ¼gen (SessionStorage - nur fÃ¼r diese Session)
    const disliked = JSON.parse(sessionStorage.getItem('mittagio_disliked') || '[]');
    if(!disliked.includes(dishKey)){
      disliked.push(dishKey);
      sessionStorage.setItem('mittagio_disliked', JSON.stringify(disliked));
    }
    
    showToast('Gericht abgelehnt', 1000);
  }
  
  function acceptOffer(offer){
    if(!offer || !offer.id){
      console.error('Invalid offer in acceptOffer:', offer);
      return;
    }
    
    const data = normalizeOffer(offer);
    const dishKey = data.id;
    const offerProvider = offers.find(p => p.providerId === data.providerId);
    const vorOrt = !!(offerProvider && (offerProvider.dineInPossible !== false || data.dineInPossible));
    const abholnummer = !!(offerProvider && (offerProvider.orderingEnabled !== false && (data.hasPickupCode || offerProvider.hasPickupCode)));
    const mehrweg = !!(offerProvider && (offerProvider.reuseEnabled || offerProvider.reuse || (offerProvider.providerProfile && offerProvider.providerProfile.reuseEnabled)));
    
    // 3-SÃ¤ulen einfrieren: Status beim Favorisieren speichern
    setFavPillars(dishKey, { vorOrt, abholnummer, mehrweg });
    
    const favorites = JSON.parse(localStorage.getItem('mittagio_favorites') || '[]');
    if(!favorites.includes(dishKey)){
      favorites.push(dishKey);
      localStorage.setItem('mittagio_favorites', JSON.stringify(favorites));
    }
    if(!dishFavs.has(dishKey)){
      dishFavs.add(dishKey);
      save(LS.dishFavs, Array.from(dishFavs));
    }
    
    triggerHapticFeedback([20, 10, 30]);
    
    // "Lecker!" Match-Overlay anzeigen
    showMatchOverlay(data);
    
    // Favoriten-Icon in Nav bouncen lassen
    triggerFavoritesIconBounce();
    
    // Favoriten-Seite aktualisieren
    if(typeof renderFavorites === 'function') renderFavorites();
  }
  
  // "Lecker!" Match-Overlay anzeigen
  function showMatchOverlay(data){
    // Entferne eventuell vorhandenes Overlay
    const existingOverlay = document.getElementById('matchOverlayTinder');
    if(existingOverlay) existingOverlay.remove();
    
    const overlay = document.createElement('div');
    overlay.id = 'matchOverlayTinder';
    overlay.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:2000; display:flex; align-items:center; justify-content:center;';
    overlay.innerHTML = `
      <div class="match-overlay" style="text-align:center; padding:40px; max-width:320px;">
        <div style="font-size:80px; margin-bottom:16px;">ðŸ˜‹</div>
        <h2 style="color:#fff; font-size:36px; font-weight:900; margin:0 0 12px; letter-spacing:2px;">Lecker!</h2>
        <p style="color:rgba(255,255,255,0.8); font-size:16px; margin:0 0 24px; line-height:1.5;">${esc(data.dish || 'Gericht')} wurde zu deinen Favoriten hinzugefÃ¼gt.</p>
        <div style="display:flex; gap:12px; justify-content:center;">
          <button type="button" onclick="document.getElementById('matchOverlayTinder').remove(); showFav();" style="padding:14px 28px; background:#FFD700; color:#1a1a1a; font-weight:800; font-size:15px; border:none; border-radius:12px; cursor:pointer;">Zu Favoriten</button>
          <button type="button" onclick="document.getElementById('matchOverlayTinder').remove();" style="padding:14px 28px; background:rgba(255,255,255,0.15); color:#fff; font-weight:700; font-size:15px; border:none; border-radius:12px; cursor:pointer;">Weiter</button>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
    
    // Auto-close nach 3s
    setTimeout(() => {
      if(overlay.parentNode) overlay.remove();
    }, 3000);
  }
  
  // Favoriten-Icon in Bottom-Nav bouncen
  function triggerFavoritesIconBounce(){
    const favNavBtn = document.querySelector('#customerNav button[data-go="fav"]');
    if(!favNavBtn) return;
    const icon = favNavBtn.querySelector('.ico');
    if(icon){
      icon.classList.add('fav-icon-bounce');
      setTimeout(() => icon.classList.remove('fav-icon-bounce'), 600);
    }
  }
  
  // === MITTAGESSEN-TINDER: Erst Filtern, dann Swipen ===
  let activeSwipePreference = null;
  let swipeFiltersSelected = false;
  
  function setupSwipeFilterHandlers(){
    document.querySelectorAll('.swipe-pref-btn').forEach(btn => {
      btn.onclick = () => onSwipeFilterSelect('pref', btn.dataset.pref);
    });
    document.querySelectorAll('.swipe-dist-btn').forEach(btn => {
      btn.onclick = () => onSwipeFilterSelect('dist', btn.dataset.dist);
    });
  }
  
  function onSwipeFilterSelect(type, value){
    triggerHapticFeedback([10]);
    if(type === 'pref'){
      if(activeSwipePreference === value){ activeSwipePreference = null; updatePrefButtonState(null); }
      else { activeSwipePreference = value; updatePrefButtonState(value); }
      if(!swipeFiltersSelected) activeTimeFilter = activeTimeFilter || 'walking';
    } else {
      activeTimeFilter = value;
      updateDistanceButtonState(value);
      if(!swipeFiltersSelected) activeSwipePreference = activeSwipePreference || null;
    }
    save('mittagio_timeFilter', activeTimeFilter);
    
    if(!swipeFiltersSelected){
      swipeFiltersSelected = true;
      const intro = document.getElementById('swipeFilterIntro');
      const area = document.getElementById('swipeStackArea');
      if(intro) intro.style.display = 'none';
      if(area) area.style.display = 'flex';
      renderSwipeCards();
      showToast('Karten geladen â€“ viel SpaÃŸ beim Swipen!', 1500);
    } else {
      renderSwipeCards();
      const label = type === 'pref' ? (value === 'fleisch' ? 'Fleisch' : value === 'vegetarisch' ? 'Vegetarisch' : 'Salat') : (value === 'walking' ? 'Zu Fuss' : 'Auto');
      showToast('Filter: ' + label, 1000);
    }
  }
  
  function updatePrefButtonState(activePref){
    document.querySelectorAll('.swipe-pref-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.pref === activePref);
    });
  }
  
  function updateDistanceButtonState(activeDist){
    document.querySelectorAll('.swipe-dist-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.dist === activeDist);
    });
  }
  
  window.toggleSwipeMenu = function(){
    showToast('MenÃ¼: In Entwicklung', 1500);
  };
  
  // Fly-to-Favorites Animation: Gericht fliegt zum Herz-Icon
  function triggerFlyToFavoritesAnimation(offer){
    const data = normalizeOffer(offer);
    const card = document.querySelector('.swipe-card[data-offer-id="' + data.id + '"]');
    if(!card) return;
    
    const img = card.querySelector('.swipe-card-image img');
    if(!img) return;
    
    // Finde das Favoriten-Icon in der Bottom Nav
    const favNavBtn = document.querySelector('#customerNav button[data-go="fav"]');
    if(!favNavBtn) return;
    
    // TemporÃ¤re Kopie des Bildes erstellen
    const flyImg = img.cloneNode(true);
    flyImg.style.cssText = `
      position:fixed;
      width:100px;
      height:100px;
      object-fit:cover;
      border-radius:16px;
      z-index:9999;
      pointer-events:none;
      box-shadow:0 8px 24px rgba(0,0,0,0.3);
      transition:all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    `;
    
    const cardRect = card.getBoundingClientRect();
    const favRect = favNavBtn.getBoundingClientRect();
    
    flyImg.style.left = cardRect.left + (cardRect.width / 2) - 50 + 'px';
    flyImg.style.top = cardRect.top + (cardRect.height * 0.3) + 'px';
    
    document.body.appendChild(flyImg);
    
    // Animation zum Herz-Icon
    setTimeout(() => {
      flyImg.style.left = favRect.left + (favRect.width / 2) - 50 + 'px';
      flyImg.style.top = favRect.top + (favRect.height / 2) - 50 + 'px';
      flyImg.style.transform = 'scale(0.2) rotate(360deg)';
      flyImg.style.opacity = '0';
    }, 50);
    
    // Heart-Reaction: Bounce + Glow
    setTimeout(() => {
      favNavBtn.classList.add('bounce', 'glow');
      
      // Cleanup
      setTimeout(() => {
        favNavBtn.classList.remove('bounce', 'glow');
      }, 500);
    }, 300);
    
    // Cleanup
    setTimeout(() => {
      if(flyImg.parentNode) flyImg.parentNode.removeChild(flyImg);
    }, 700);
  }
  
  // Anbieter-Quick-View (Modal mit Adresse & Maps-Link)
  function openProviderQuickView(providerId){
    const providerOffers = offers.filter(o => o.providerId === providerId && o.active !== false);
    if(providerOffers.length === 0) return;
    
    const provider = normalizeOffer(providerOffers[0]);
    const address = buildAddress({
      street: provider.providerStreet,
      zip: provider.providerZip,
      city: provider.providerCity,
      address: provider.address
    });
    
    // Modal erstellen
    const modal = document.createElement('div');
    modal.className = 'backdrop active';
    modal.style.zIndex = '100';
    modal.onclick = () => {
      modal.remove();
    };
    
    const content = document.createElement('div');
    content.style.cssText = `
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      background:#fff;
      border-radius:24px;
      padding:24px;
      max-width:90vw;
      width:400px;
      box-shadow:0 8px 32px rgba(0,0,0,0.2);
      z-index:101;
    `;
    content.onclick = (e) => e.stopPropagation();
    
    content.innerHTML = `
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
        <div style="width:48px; height:48px; border-radius:12px; background:rgba(255,215,0,0.15); display:flex; align-items:center; justify-content:center;">
          <i data-lucide="store" style="width:24px;height:24px; color:#FFD700;"></i>
        </div>
        <div style="flex:1;">
          <div style="font-weight:900; font-size:18px; color:#2D3436; margin-bottom:4px;">${esc(provider.providerName || 'Anbieter')}</div>
          <div style="font-size:14px; color:#666; display:flex; align-items:center; gap:6px;">
            <i data-lucide="map-pin" style="width:14px;height:14px;"></i>
            <span>${esc(address)}</span>
          </div>
        </div>
        <button onclick="this.closest('.backdrop').remove();" style="background:none; border:none; padding:8px; cursor:pointer; border-radius:8px; transition:background 0.2s;" onmouseover="this.style.background='#f5f5f5';" onmouseout="this.style.background='none';">
          <i data-lucide="x" style="width:20px;height:20px; color:#666;"></i>
        </button>
      </div>
      <div style="display:flex; flex-direction:column; gap:12px;">
        <button class="btn-primary" type="button" onclick="openGoogleMapsRoute('${esc(providerId)}'); this.closest('.backdrop').remove();" style="width:100%; min-height:48px; font-weight:700;">
          <i data-lucide="navigation" style="width:20px;height:20px;"></i> <span>Anfahrt</span>
        </button>
        ${provider.distanceKm != null ? (() => {
          const walkingMinutes = Math.round(Number(provider.distanceKm) * 12);
          const walkingTimeText = walkingMinutes < 1 ? '< 1 Min.' : `${walkingMinutes} Min.`;
          return `<div style="text-align:center; font-size:13px; color:#666; padding:8px; display:flex; align-items:center; justify-content:center; gap:4px;"><i data-lucide="navigation" style="width:14px;height:14px;"></i> <span>${walkingTimeText} zu FuÃŸ</span></div>`;
        })() : ''}
      </div>
    `;
    
    modal.appendChild(content);
    document.body.appendChild(modal);
    
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }
  
  // Google Maps Route Ã¶ffnen (fÃ¼r einen oder mehrere Anbieter)
  function openGoogleMapsRoute(providerId){
    // Wenn kein providerId, dann Multi-Vendor aus Korb
    if(!providerId){
      if(!cart || !cart.items.length) return;
      const providerIds = new Set();
      cart.items.forEach(it => {
        const o = offers.find(x => x.id === it.offerId);
        if(o) providerIds.add(o.providerId);
      });
      
      if(providerIds.size === 0) return;
      if(providerIds.size === 1){
        openGoogleMapsRoute(Array.from(providerIds)[0]);
        return;
      }
      
      // Mehrere Anbieter: Optimale Route mit Waypoints
      const addresses = [];
      Array.from(providerIds).forEach(id => {
        const o = offers.find(x => x.providerId === id && x.active !== false);
        if(o){
          const p = normalizeOffer(o);
          const addr = buildAddress({
            street: p.providerStreet,
            zip: p.providerZip,
            city: p.providerCity
          });
          if(addr) addresses.push(encodeURIComponent(addr));
        }
      });
      
      if(addresses.length === 0) return;
      
      // Google Maps mit Waypoints (optimale Route)
      if(addresses.length > 1){
        const waypoints = addresses.slice(0, -1).join('|');
        const destination = addresses[addresses.length - 1];
        const url = `https://www.google.com/maps/dir/?api=1&origin=My+Location&waypoints=${waypoints}&destination=${destination}`;
        window.open(url, '_blank');
      } else {
        const url = `https://www.google.com/maps/search/?api=1&query=${addresses[0]}`;
        window.open(url, '_blank');
      }
      return;
    }
    
    // Einzelner Anbieter
    const o = offers.find(x => x.providerId === providerId && x.active !== false);
    if(!o) return;
    
    const p = normalizeOffer(o);
    const address = buildAddress({
      street: p.providerStreet,
      zip: p.providerZip,
      city: p.providerCity
    });
    
    if(!address) return;
    
    const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
    window.open(url, '_blank');
  }
  
  // NÃ¤chste Karte anzeigen
  function showNextSwipeCard(){
    const swipeStack = document.getElementById('swipeStack');
    if(!swipeStack) return;
    
    // CRITICAL FIX: Reset alle State-Variablen vor dem Update
    // Stelle sicher, dass keine Swipe-Gesten mehr aktiv sind
    // WICHTIG: Dies verhindert, dass alte State-Variablen aus Closure die neue Karte blockieren
    const allCards = swipeStack.querySelectorAll('.swipe-card');
    allCards.forEach(card => {
      if(card && card.style){
        // Entferne alle Swipe-Klassen und setze State zurÃ¼ck
        card.classList.remove('swiping');
        card.style.transition = '';
        // Entferne haptisches Feedback Flag
        if(card.dataset) card.dataset.hapticTriggered = '';
      }
    });
    
    // Speicher-Bereinigung: Entferne alle entfernten Karten aus dem DOM
    allCards.forEach(card => {
      if(!card || !card.parentNode || !card.style || card.style.opacity === '0'){
        // Karte wurde bereits entfernt oder ist unsichtbar - entferne sie komplett
        if(card && card.parentNode && card.style){
          // CRITICAL FIX: Setze display:none BEVOR entfernt wird, um Events zu blockieren
          card.style.display = 'none';
          // Cleanup: Entferne alle Event-Listener durch Klonen und Ersetzen
          const newCard = card.cloneNode(true);
          card.parentNode.replaceChild(newCard, card);
          card.remove();
        }
      }
    });
    
    // Verschiebe alle verbleibenden Karten nach oben (zentriert)
    // Performance-Fix: PrÃ¼fe ob Elemente noch existieren
    let cards = Array.from(swipeStack.querySelectorAll('.swipe-card')).filter(c => {
      if(!c || !c.parentNode || !c.style) return false; // Element existiert nicht mehr
      // CRITICAL FIX: Filtere auch display:none Karten aus
      if(c.style.display === 'none') return false;
      // Filtere Karten mit opacity 0 oder swipe-Klassen
      const opacity = c.style.opacity;
      if(opacity === '0' || opacity === '0px') return false;
      if(c.classList.contains('swipe-left') || c.classList.contains('swipe-right')) return false;
      return true;
    });
    
    // CRITICAL FIX: Stelle sicher, dass die oberste Karte (index 0) korrekt konfiguriert ist
    // BUGFIX: Index-Problem beheben - stelle sicher, dass currentSwipeIndex korrekt ist
    // Wenn keine Karten mehr sichtbar sind, aber noch Karten im Array sind, lade die nÃ¤chste
    if(cards.length === 0 && currentSwipeIndex < swipeCards.length){
      const nextCard = createSwipeCard(swipeCards[currentSwipeIndex], 0);
      if(nextCard && swipeStack) {
        swipeStack.appendChild(nextCard);
        cards = [nextCard];
      }
    }
    
    // CRITICAL FIX: Wenn weniger als 3 Karten vorhanden sind UND noch weitere Karten verfÃ¼gbar sind, lade sie VORHER
    // Dies verhindert, dass der Stack leer wird
    while(cards.length < 3 && currentSwipeIndex + cards.length < swipeCards.length){
      const nextIndex = currentSwipeIndex + cards.length;
      if(nextIndex < swipeCards.length){
        const nextCard = createSwipeCard(swipeCards[nextIndex], cards.length);
        if(nextCard && swipeStack) {
          swipeStack.appendChild(nextCard);
          cards.push(nextCard);
        } else {
          break; // Verhindere Endlosschleife
        }
      } else {
        break;
      }
    }
    
    // CRITICAL FIX: Aktualisiere cards-Array nach dem Laden neuer Karten
    cards = Array.from(swipeStack.querySelectorAll('.swipe-card')).filter(c => {
      if(!c || !c.parentNode || !c.style) return false;
      if(c.style.display === 'none') return false;
      const opacity = c.style.opacity;
      if(opacity === '0' || opacity === '0px') return false;
      if(c.classList.contains('swipe-left') || c.classList.contains('swipe-right')) return false;
      return true;
    });
    
    cards.forEach((card, i) => {
      if(!card || !card.parentNode || !card.style) return; // Sicherheitscheck
      
      // CRITICAL FIX: Aktualisiere den Index als data-Attribut fÃ¼r dynamische PrÃ¼fung
      if(card.dataset) card.dataset.swipeIndex = String(currentSwipeIndex + i);
      
      // Reset Transform und Transition fÃ¼r sauberen Neustart
      card.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
      card.style.zIndex = String(100 - i);
      const scale = 1 - i * 0.05;
      const translateY = i * 10;
      card.style.transform = `translate(-50%, calc(-50% + ${translateY}px)) scale(${scale})`;
      card.style.opacity = i === 0 ? '1' : '0.95';
      
      // CRITICAL: Die oberste Karte (i === 0) muss interaktiv sein und Event-Listener erhalten
      if(i === 0){
        card.style.pointerEvents = 'auto';
        card.style.cursor = 'grab';
        card.style.display = 'block';
        card.style.willChange = 'transform';
        card.classList.remove('swipe-left', 'swipe-right', 'swiping', 'fly-out-left', 'fly-out-right');
        card.classList.add('active-float'); // Tinder Float/Waber Animation
        card.style.opacity = '1';
        card.style.visibility = 'visible';
        // Tinder: Random Rotation fÃ¼r Stack-Effekt entfernen bei aktiver Karte
        card.style.transform = `translate(-50%, -50%) scale(1)`;
      } else {
        card.style.pointerEvents = 'none';
        card.classList.remove('active-float');
        // Tinder: Random Rotation beibehalten fÃ¼r Stack-Effekt
        const randomRotation = (Math.random() * 4 - 2);
        card.style.transform = `translate(-50%, calc(-50% + ${translateY}px)) scale(${scale}) rotate(${randomRotation}deg)`;
      }
    });
    
    // Diese Logik wurde nach oben verschoben, um sicherzustellen, dass Karten VORHER geladen werden
    
    // End-of-Stack: Wenn keine Karten mehr, zeige Abschlusskarte
    const swipeEndOfStack = document.getElementById('swipeEndOfStack');
    const swipeEmpty = document.getElementById('swipeEmpty');
    
    // CRITICAL FIX: PrÃ¼fe sowohl ob keine Karten mehr sichtbar sind UND ob alle Karten durchgesehen wurden
    const allCardsVisible = Array.from(swipeStack.querySelectorAll('.swipe-card')).filter(c => {
      if(!c || !c.style) return false;
      const opacity = c.style.opacity;
      return opacity !== '0' && opacity !== '0px' && opacity !== 0 && c.style.display !== 'none';
    }).length;
    
    if(allCardsVisible === 0 && currentSwipeIndex >= swipeCards.length){
      if(swipeEndOfStack) swipeEndOfStack.style.display = 'block';
      if(swipeEmpty) swipeEmpty.style.display = 'none';
    } else {
      if(swipeEndOfStack) swipeEndOfStack.style.display = 'none';
      if(swipeEmpty) swipeEmpty.style.display = 'none';
    }
    
    // Debug-Overlay aktualisieren
    const debugOverlay = document.getElementById('swipeCurrentIndex');
    if(debugOverlay){
      debugOverlay.textContent = currentSwipeIndex;
    }
    
    // Cleanup: Entferne Event-Listener von entfernten Karten (verhindert Memory Leaks)
    // Performance-Fix: Aggressiveres Cleanup nach jedem Swipe
    setTimeout(() => {
      if(!swipeStack) return;
      const removedCards = swipeStack.querySelectorAll('.swipe-card[style*="opacity: 0"]');
      removedCards.forEach(card => {
        if(card && card.parentNode){
          // Entferne alle Event-Listener durch Klonen
          const newCard = card.cloneNode(true);
          card.parentNode.replaceChild(newCard, card);
          card.remove();
        }
      });
      
      // ZusÃ¤tzlicher Cleanup: Entferne Karten die nicht mehr sichtbar sind
      const allCards = swipeStack.querySelectorAll('.swipe-card');
      allCards.forEach(card => {
        if(card && (card.style.opacity === '0' || !card.parentNode || card.offsetParent === null)){
          if(card.parentNode) card.remove();
        }
      });
    }, 300);
  }
  
  // FAB (Floating Action Button) fÃ¼r Modus-Wechsel
  const fabModeToggle = document.getElementById('fabModeToggle');
  const fabModeIcon = document.getElementById('fabModeIcon');
  const fabHint = document.getElementById('fabHint');
  
  // Toggle-Switch Handler im Header
  const toggleDiscoverViewTopbar = document.getElementById('toggleDiscoverViewTopbar');
  
  function syncToggleState(){
    const isSwipe = discoverViewMode === 'swipe';
    
    // Topbar-Toggle
    // Moderner Toggle: Aktiven Zustand setzen und Icon wechseln
    if(toggleDiscoverViewTopbar){
      const iconEl = toggleDiscoverViewTopbar.querySelector('#toggleDiscoverViewIcon');
      if(isSwipe){
        toggleDiscoverViewTopbar.classList.add('active');
        if(iconEl) iconEl.setAttribute('data-lucide', 'list');
      } else {
        toggleDiscoverViewTopbar.classList.remove('active');
        if(iconEl) iconEl.setAttribute('data-lucide', 'grid-3x3');
      }
      if(typeof lucide !== 'undefined' && iconEl) lucide.createIcons();
    }
    
    // FAB aktualisieren
    if(fabModeToggle){
      if(isSwipe){
        fabModeToggle.classList.add('active');
        // Icon wechseln: Sparkles (Inspiration) â†’ Liste
        if(fabModeIcon){
          fabModeIcon.setAttribute('data-lucide', 'list');
          if(typeof lucide !== 'undefined') lucide.createIcons();
        }
      } else {
        fabModeToggle.classList.remove('active');
        // Icon wechseln: Liste â†’ Sparkles (Inspiration)
        if(fabModeIcon){
          fabModeIcon.setAttribute('data-lucide', 'sparkles');
          if(typeof lucide !== 'undefined') lucide.createIcons();
        }
      }
    }
  }
  
  // FAB Click-Handler mit Puls-Animation
  if(fabModeToggle){
    fabModeToggle.onclick = () => {
      // Puls-Animation
      fabModeToggle.classList.add('pulsing');
      setTimeout(() => fabModeToggle.classList.remove('pulsing'), 400);
      
      // Modus wechseln
      const newMode = discoverViewMode === 'list' ? 'swipe' : 'list';
      switchDiscoverView(newMode);
      save(LS.discoverView, newMode);
      syncToggleState();
      
      // Haptic Feedback (falls unterstÃ¼tzt)
      if(navigator.vibrate) navigator.vibrate(10);
    };
  }
  

  
  // Micro-Hint beim ersten Start (nur einmal anzeigen)
  const fabHintShown = load('fabHintShown', false);
  if(fabModeToggle && fabHint && !fabHintShown){
    // Zeige FAB nur in Discover-View
    function showFabInDiscover(){
      const currentView = document.querySelector('.view.active');
      if(currentView && currentView.id === 'v-discover'){
        fabModeToggle.style.display = 'flex';
        // Zeige Hint nach kurzer VerzÃ¶gerung
        setTimeout(() => {
          if(fabHint) fabHint.classList.add('show');
        }, 500);
        // Verstecke Hint nach 2 Sekunden
        setTimeout(() => {
          if(fabHint) fabHint.classList.remove('show');
          save('fabHintShown', true);
        }, 2500);
      } else {
        fabModeToggle.style.display = 'none';
      }
    }
    
    // Beim ersten Laden
    showFabInDiscover();
    
    // Beim View-Wechsel
    const originalShowView = window.showView;
    if(originalShowView){
      window.showView = function(viewId){
        originalShowView(viewId);
        setTimeout(showFabInDiscover, 100);
      };
    }
  } else if(fabModeToggle){
    // Hint bereits gezeigt - zeige FAB nur in Discover
    function showFabInDiscover(){
      const currentView = document.querySelector('.view.active');
      if(currentView && currentView.id === 'v-discover'){
        fabModeToggle.style.display = 'flex';
      } else {
        fabModeToggle.style.display = 'none';
      }
    }
    showFabInDiscover();
    
    // Beim View-Wechsel
    const originalShowView = window.showView;
    if(originalShowView){
      window.showView = function(viewId){
        originalShowView(viewId);
        setTimeout(showFabInDiscover, 100);
      };
    }
  }
  
  // Initialer Zustand setzen
  setTimeout(() => {
    syncToggleState();
    if(fabModeToggle){
      const currentView = document.querySelector('.view.active');
      if(currentView && currentView.id === 'v-discover'){
        fabModeToggle.style.display = 'flex';
      }
    }
  }, 200);
  
  // Initiale Ansicht beim ersten Laden setzen
  if(discoverViewMode === 'swipe'){
    switchDiscoverView('swipe');
  } else {
    switchDiscoverView('list');
  }
  
  // Skeleton-Loader fÃ¼r Slim-Cards (Loading-State)
  function createSlimCardSkeleton(){
    const skeleton = document.createElement('div');
    skeleton.className = 'dish-card skeleton-pulse';
    skeleton.innerHTML = `
      <div style="display:flex; gap:12px; align-items:flex-start;">
        <!-- Bild-Platzhalter -->
        <div class="skeleton-bg" style="width:100px; height:100px; max-width:100px; max-height:100px; flex-shrink:0; border-radius:12px;"></div>
        
        <!-- Text-Platzhalter -->
        <div style="flex:1; display:flex; flex-direction:column; justify-content:space-between; min-width:0; padding:2px 0;">
          <div>
            <!-- Name & Preis Zeile -->
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px; margin-bottom:4px;">
              <div class="skeleton-bg" style="height:16px; border-radius:4px; flex:1; max-width:66%;"></div>
              <div class="skeleton-bg" style="height:16px; border-radius:4px; width:25%;"></div>
            </div>
            <!-- Anbieter-Platzhalter -->
            <div class="skeleton-bg-light" style="height:10px; border-radius:4px; width:50%; margin-bottom:6px;"></div>
          </div>
          
          <!-- Info-Zeile Platzhalter -->
          <div style="display:flex; gap:12px; margin-top:auto;">
            <div class="skeleton-bg-light" style="height:10px; border-radius:4px; width:48px;"></div>
            <div class="skeleton-bg-light" style="height:10px; border-radius:4px; width:48px;"></div>
          </div>
        </div>
      </div>
    `;
    return skeleton;
  }
  
  // Entscheidungs-Kachel (Heute-Fokus): 2x2 Grid mit 3 SÃ¤ulen in unterer Leiste
  function createDecisionTile(o, opts={}){
    const data = normalizeOffer(o);
    const interactive = opts.interactive !== false;
    const card = document.createElement('div');
    card.className = 'decision-tile';
    card.style.cssText = `
      position: relative;
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      flex-direction: column;
      aspect-ratio: 1;
    `;
    
    if(interactive){
      card.onclick = () => openOffer(data.id);
      card.onmouseover = () => {
        card.style.transform = 'scale(1.02)';
        card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
      };
      card.onmouseout = () => {
        card.style.transform = 'scale(1)';
        card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
      };
    }
    
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    
    // Bild-Container (mit Overlay fÃ¼r 3 SÃ¤ulen)
    const imgContainer = document.createElement('div');
    imgContainer.style.cssText = `
      position: relative;
      width: 100%;
      flex: 1;
      overflow: hidden;
      background: #f0f0f0;
    `;
    
    const img = document.createElement('img');
    img.src = imgSrc;
    img.alt = data.dish || '';
    img.style.cssText = `
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    `;
    imgContainer.appendChild(img);
    
    // Rotes X oben rechts (Ausschlussverfahren)
    const dismissBtn = document.createElement('button');
    dismissBtn.type = 'button';
    dismissBtn.style.cssText = `
      position: absolute;
      top: 8px;
      right: 8px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(231, 76, 60, 0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 2px solid #fff;
      color: #fff;
      font-size: 18px;
      font-weight: 900;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 20;
      box-shadow: 0 2px 8px rgba(231, 76, 60, 0.4);
      transition: transform 0.2s ease;
    `;
    dismissBtn.textContent = 'Ã—';
    dismissBtn.onclick = (e) => {
      e.stopPropagation();
      triggerHapticFeedback([10]);
      // Kachel ausblenden (Ausschlussverfahren)
      card.style.opacity = '0';
      card.style.transform = 'scale(0.9)';
      setTimeout(() => {
        if(card.parentNode) card.parentNode.removeChild(card);
      }, 200);
      showToast('Gericht ausgeschlossen');
    };
    dismissBtn.onmouseover = () => {
      dismissBtn.style.transform = 'scale(1.1)';
    };
    dismissBtn.onmouseout = () => {
      dismissBtn.style.transform = 'scale(1)';
    };
    imgContainer.appendChild(dismissBtn);
    
    // 3 SÃ¤ulen in unterer Leiste (im Bild-Overlay)
    const pillarsRow = document.createElement('div');
    pillarsRow.style.cssText = `
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0.3) 50%, transparent 100%);
      padding: 12px 8px 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      z-index: 10;
    `;
    
    const offerProvider = offers.find(p => p.providerId === data.providerId);
    const orderingEnabled = offerProvider && (offerProvider.orderingEnabled !== false && (data.hasPickupCode || offerProvider.hasPickupCode));
    const hasDineIn = offerProvider && (offerProvider.dineInPossible !== false || data.dineInPossible);
    const hasReuse = offerProvider && (offerProvider.reuse && offerProvider.reuse.enabled);
    
    // SÃ¤ule 1: Vor Ort ðŸ´
    const pillar1 = document.createElement('div');
    pillar1.style.cssText = `
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: ${hasDineIn ? 'rgba(255,255,255,0.95)' : 'rgba(255,255,255,0.4)'};
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      opacity: ${hasDineIn ? '1' : '0.4'};
      filter: ${hasDineIn ? 'none' : 'grayscale(100%)'};
    `;
    pillar1.textContent = 'ðŸ´';
    pillarsRow.appendChild(pillar1);
    
    // SÃ¤ule 2: Abholnummer ðŸ§¾
    const pillar2 = document.createElement('div');
    pillar2.style.cssText = `
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: ${orderingEnabled ? 'rgba(255,255,255,0.95)' : 'rgba(255,255,255,0.4)'};
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      opacity: ${orderingEnabled ? '1' : '0.4'};
      filter: ${orderingEnabled ? 'none' : 'grayscale(100%)'};
    `;
    pillar2.textContent = 'ðŸ§¾';
    pillarsRow.appendChild(pillar2);
    
    // SÃ¤ule 3: Mehrweg ðŸ”„ - ENTFERNT (nur noch im Profil)
    
    imgContainer.appendChild(pillarsRow);
    card.appendChild(imgContainer);
    
    // Footer: Name & Preis in Gelb
    const footer = document.createElement('div');
    footer.style.cssText = `
      background: var(--brand);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 60px;
    `;
    
    const dishName = document.createElement('div');
    dishName.style.cssText = `
      font-weight: 900;
      font-size: 14px;
      color: #1a1a1a;
      line-height: 1.3;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    `;
    dishName.textContent = data.dish || 'Gericht';
    footer.appendChild(dishName);
    
    const price = document.createElement('div');
    price.style.cssText = `
      font-weight: 900;
      font-size: 18px;
      color: #1a1a1a;
    `;
    price.textContent = euro(data.price);
    footer.appendChild(price);
    
    card.appendChild(footer);
    
    return card;
  }
  
  // List Card fÃ¼r Discover-Seite (Kompaktes horizontales Design - Slim-Card)
  function createDiscoverListCard(o){
    const data = normalizeOffer(o);
    const card = document.createElement('div');
    card.className = 'dish-card';
    
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    
    // Favorit-Status prÃ¼fen
    const dishKey = data.id;
    const isFav = dishFavs.has(dishKey);
    
    // Gehzeit berechnen
    let walkingTimeText = '';
    if(data.walkingTimeText){
      walkingTimeText = data.walkingTimeText;
    } else if(data.distanceKm != null){
      const walkingMinutes = Math.round(Number(data.distanceKm) * 12);
      walkingTimeText = walkingMinutes < 1 ? '< 1 Min.' : `${walkingMinutes} Min.`;
    }
    
    // Eco-Badge: Mehrweg-Option (wenn Anbieter es unterstÃ¼tzt)
    const offerProvider = offers.find(p => p.providerId === data.providerId);
    const hasReuseSupport = offerProvider && (offerProvider.reuseEnabled || offerProvider.reuse || (offerProvider.providerProfile && offerProvider.providerProfile.reuseEnabled));
    
    // Service-Label prÃ¼fen (Abholnummer vs. Nur Info)
    const hasAbholnummer = data.hasPickupCode || false;
    const serviceLabel = hasAbholnummer 
      ? {text: 'Abholnummer', icon: 'ðŸ§¾', color: '#27AE60', bg: 'rgba(39,174,96,0.15)', border: 'rgba(39,174,96,0.3)'}
      : {text: 'Nur Info', icon: 'ðŸ‘ï¸', color: '#64748b', bg: 'rgba(100,116,139,0.1)', border: 'rgba(100,116,139,0.2)'};
    
    // Kompaktes horizontales Layout: Bild links (quadratisch), Text rechts
    card.innerHTML = `
      <div style="display:flex; gap:12px; align-items:flex-start;">
        <!-- Kompaktes Bild links (quadratisch, max. 100px) -->
        <div style="position:relative; width:100px; height:100px; max-width:100px; max-height:100px; flex-shrink:0; border-radius:12px; overflow:hidden; background:#f0f0f0;">
        <img src="${esc(imgSrc)}" alt="${esc(data.dish||'')}" style="width:100%; height:100%; object-fit:cover;" />
          <!-- Service-Label (oben links) -->
          <div style="position:absolute; top:4px; left:4px; background:${serviceLabel.bg}; border:1px solid ${serviceLabel.border}; color:${serviceLabel.color}; padding:3px 6px; border-radius:6px; font-size:9px; font-weight:700; display:flex; align-items:center; gap:3px; box-shadow:0 2px 4px rgba(0,0,0,0.2); backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px); z-index:6; white-space:nowrap;">
            <span style="font-size:10px;">${serviceLabel.icon}</span>
            <span>${serviceLabel.text}</span>
          </div>
          <!-- Eco-Badge: Mehrweg-Konzept-Icon - ENTFERNT (nur noch im Profil) -->
          <!-- Favorit-Button (oben rechts) -->
          <button class="btn-icon-overlay" onclick="event.stopPropagation(); toggleDishFav('${dishKey}'); const btn=this.querySelector('i'); setTimeout(()=>{const isFav=dishFavs.has('${dishKey}'); btn.style.fill=isFav?'currentColor':''; btn.style.color=isFav?'#e74c3c':'#666'; if(typeof lucide !== 'undefined') lucide.createIcons();}, 10);" title="Favorit" style="position:absolute; top:4px; right:4px; width:28px; height:28px; border-radius:50%; background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.15); transition:transform 0.2s ease; z-index:5;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
            <i data-lucide="heart" style="width:14px;height:14px;${isFav ? 'fill:currentColor; color:#e74c3c;' : 'color:#666;'}"></i>
          </button>
        </div>
        
        <!-- Info-Bereich rechts (flex:1 fÃ¼r volle Breite) -->
        <div style="flex:1; display:flex; flex-direction:column; justify-content:space-between; min-width:0; padding:2px 0;">
          <!-- Name & Preis in einer Zeile -->
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px; margin-bottom:4px;">
            <h3 class="dish-name" style="font-weight:900; font-size:15px; line-height:1.3; margin:0; color:#111; letter-spacing:-0.2px; flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">${esc(data.dish||'Gericht')}</h3>
            <div class="dish-price" style="font-size:16px; color:var(--brand); font-weight:900; flex-shrink:0; white-space:nowrap;">${euro(data.price)}</div>
      </div>
          
          <!-- Anbieter-Name (klein, uppercase) -->
          <p style="font-size:10px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin:0 0 6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
            ${esc(data.providerName||'Anbieter')}
          </p>
          
          <!-- Info-Zeile: Gehzeit & Zeit-Slot (kompakt) -->
          <div style="display:flex; align-items:center; gap:12px; font-size:10px; font-weight:700; color:#64748b; margin-top:auto;">
            ${walkingTimeText ? `<span style="display:flex; align-items:center; gap:3px;">
              <i data-lucide="navigation" style="width:11px;height:11px; color:var(--brand);"></i>
              <span>${walkingTimeText}</span>
            </span>` : ''}
            ${data.pickupWindow ? `<span style="display:flex; align-items:center; gap:3px;">
              <i data-lucide="clock" style="width:11px;height:11px; color:#94a3b8;"></i>
              <span>${esc(data.pickupWindow)}</span>
            </span>` : ''}
          </div>
        </div>
      </div>
    `;
    
    // Klick auf Karte Ã¶ffnet immer Detailansicht (nicht direkt Bestellung)
    card.onclick = (e)=>{
      if(e.target.closest('.btn-icon-overlay')) return; // Button-Handler Ã¼bernimmt
      openOffer(data.id); // Immer Detailansicht Ã¶ffnen
    };
    
    return card;
  }

  function offerCard(o, opts={}){
    const data = normalizeOffer(o);
    const interactive = opts.interactive !== false;
    const isPolaroid = opts.context === 'customer' || opts.context === 'discover';
    const offerProvider = offers.find(p => p.providerId === data.providerId);
    const orderingEnabled = offerProvider && (offerProvider.orderingEnabled !== false && (data.hasPickupCode || offerProvider.hasPickupCode));
    const hasDineIn = offerProvider && (offerProvider.dineInPossible !== false || data.dineInPossible);
    const hasReuse = offerProvider && (offerProvider.reuse && offerProvider.reuse.enabled);
    const card=document.createElement('div');
    card.className='card';
    if(isPolaroid){
      card.classList.add('polaroid');
    } else if(opts.context === 'start' || opts.context === 'customer'){
      card.classList.add('playful');
    }
    if(interactive){
      card.onclick=()=>openOffer(data.id);
    } else {
      card.style.cursor='default';
    }

    // Image (Polaroid: 50% HÃ¶he fÃ¼r kompakte Sammelkarte)
    const img=document.createElement('div');
    img.className='img';
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    
    if(isPolaroid){
      // Kompakte Polaroid-Karte: Foto nimmt exakt 50% HÃ¶he ein
      img.style.cssText = 'position:relative; width:100%; height:50%; min-height:140px; max-height:140px; overflow:hidden; background:#f0f0f0;';
      img.innerHTML = `<img alt="${esc(data.dish||'')}" src="${esc(imgSrc)}" style="width:100%; height:100%; object-fit:cover;" />`;
      
      // Keine Icons mehr auf dem Bild â€“ 3 SÃ¤ulen als Balken unter dem Anbieter
      
      // Preis-Sticker: Rechts unten auf Foto
      const priceSticker = document.createElement('div');
      priceSticker.style.cssText = 'position:absolute; bottom:8px; right:8px; width:48px; height:48px; border-radius:50%; background:#27AE60; border:3px solid #fff; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:12px; color:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.2); z-index:10;';
      priceSticker.textContent = euro(data.price);
      img.appendChild(priceSticker);
      if(data.photoDataIsStandard){
        const symbolHint = document.createElement('div');
        symbolHint.style.cssText = 'position:absolute; bottom:8px; left:8px; right:56px; background:rgba(255,255,255,0.85); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); padding:6px 10px; border-radius:12px; border:1px solid rgba(255,255,255,0.4); z-index:10;';
        symbolHint.innerHTML = '<p style="margin:0; font-size:10px; font-weight:800; color:#1a1a1a; text-transform:uppercase; display:flex; align-items:center; gap:6px;"><span>â„¹ï¸</span> Symbolbild: Abweichungen zum Original mÃ¶glich</p>';
        img.appendChild(symbolHint);
      }
    } else {
      img.style.position = 'relative';
      img.style.overflow = 'hidden';
      img.innerHTML = `<img alt="${esc(data.dish||'')}" src="${esc(imgSrc)}" style="width:100%; height:100%; object-fit:cover;" />`;
      if(data.photoDataIsStandard){
        const symbolHint = document.createElement('div');
        symbolHint.style.cssText = 'position:absolute; bottom:8px; left:8px; right:8px; background:rgba(255,255,255,0.85); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); padding:6px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.4);';
        symbolHint.innerHTML = '<p style="margin:0; font-size:10px; font-weight:800; color:#1a1a1a; text-transform:uppercase; display:flex; align-items:center; gap:6px;"><span>â„¹ï¸</span> Symbolbild: Abweichungen zum Original mÃ¶glich</p>';
        img.appendChild(symbolHint);
      }
    }

    // Polaroid: 3 SÃ¤ulen (ðŸ´ ðŸ”„ ðŸ§¾) direkt unter dem Bild â€“ Konzept: Icons unter Bild, dann Name/Preis/Zeit
    if(isPolaroid){
      const barsWrap = document.createElement('div');
      barsWrap.style.cssText = 'padding:10px 16px; background:#fff; border-top:1px solid rgba(0,0,0,0.04);';
      barsWrap.innerHTML = renderPillarBars(hasDineIn, orderingEnabled, hasReuse);
      card.appendChild(img);
      card.appendChild(barsWrap);
    }

    // Heart Icon (Favorit) - rechts oben (kein Text, nur Icon)
    const dishKey = data.id;
    const heart=document.createElement('button');
    heart.className='card-heart'+(dishFavs.has(dishKey)?' on':'');
    heart.type='button';
    heart.innerHTML = dishFavs.has(dishKey) ? iconMarkup('heart', {fill:true}) : iconMarkup('heart');
    heart.onclick=(e)=>{ e.stopPropagation(); toggleDishFav(dishKey); };
    if(interactive){ card.appendChild(heart); }
    if(!isPolaroid){ card.appendChild(img); }

    // Body
    const body=document.createElement('div');
    body.className='body';
    if(isPolaroid){
      // Polaroid: WeiÃŸer Hintergrund fÃ¼r Body (Holz nur im View-Hintergrund) - Clean-up: Keine grauen Linien/Schattenboxen
      body.style.cssText = 'background:#fff; padding:0; flex:1; display:flex; flex-direction:column; border:none; box-shadow:none;';
    }
    
    // Polaroid: Gerichtname in Marker-Schrift mit Teilen-Icon
    if(isPolaroid){
      const titleRow = document.createElement('div');
      titleRow.style.cssText = 'margin-top:12px; padding:0 16px; display:flex; align-items:center; justify-content:space-between; gap:8px;';
      
      const title = document.createElement('h3');
      title.style.cssText = "font-family:'Kalam', 'Comic Sans MS', 'Marker Felt', cursive; font-weight:700; font-size:18px; color:#000; text-transform:none; letter-spacing:0.5px; line-height:1.3; margin:0; flex:1; text-align:center;";
      title.textContent = data.dish || 'Gericht';
      titleRow.appendChild(title);
      
      // Teilen-Icon rechts neben dem Namen
      const shareBtn = document.createElement('button');
      shareBtn.type = 'button';
      shareBtn.style.cssText = 'width:32px; height:32px; border-radius:50%; background:rgba(0,0,0,0.05); border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; flex-shrink:0; transition:background 0.2s ease;';
      shareBtn.onmouseover = () => { shareBtn.style.background = 'rgba(0,0,0,0.1)'; };
      shareBtn.onmouseout = () => { shareBtn.style.background = 'rgba(0,0,0,0.05)'; };
      shareBtn.onclick = (e) => {
        e.stopPropagation();
        shareOffer(data);
      };
      shareBtn.innerHTML = iconMarkup('share-2', {size: 16});
      titleRow.appendChild(shareBtn);
      
      body.appendChild(titleRow);
    } else {
      // Standard-Titelzeile: Dish name (max 2 Zeilen)
    const titleRow = document.createElement('div');
    titleRow.className='card-title-row';
    const title = document.createElement('h3');
    title.className='card-title';
    title.textContent = data.dish || 'Gericht';
    titleRow.appendChild(title);
    body.appendChild(titleRow);
    }
    
    // Anbieter: Restaurant-Name (nur bei Polaroid) â€“ SÃ¤ulen bereits unter Bild
    if(isPolaroid){
      const providerEl = document.createElement('p');
      providerEl.style.cssText = 'margin:8px 0 0; padding:0 16px; text-align:center; font-size:13px; font-weight:600; color:#666; cursor:pointer; transition:opacity 0.2s ease;';
      providerEl.onmouseover = () => { providerEl.style.opacity = '0.7'; };
      providerEl.onmouseout = () => { providerEl.style.opacity = '1'; };
      providerEl.innerHTML = `<i data-lucide="store" style="width:14px;height:14px; margin-right:4px;"></i> <span>${esc(data.providerName || 'Anbieter')}</span>`;
      providerEl.onclick = (e) => {
        e.stopPropagation();
        if(data.providerId){
          activeDiscoverFilter = 'provider';
          currentProviderFilter = data.providerId;
          renderDiscover();
          showToast(`Angebote von ${esc(data.providerName || 'Anbieter')}`);
        }
      };
      body.appendChild(providerEl);
      
      // Icons initialisieren (fÃ¼r die neuen Badges)
      if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
      
      // MobilitÃ¤ts-Zeile: Minimalistisch, einzeilig, kleine Schrift (10-12px)
      if(data.distanceKm != null){
        const mobilityRow = document.createElement('div');
        mobilityRow.style.cssText = 'margin-top:6px; padding:0 16px; display:flex; align-items:center; justify-content:center; gap:10px; font-size:11px; color:#666; font-weight:500; line-height:1.4;';
        
        // Gehzeit: 5 km/h = 12 Minuten pro km
        const walkingMinutes = Math.round(Number(data.distanceKm) * 12);
        const walkingMeters = Math.round(Number(data.distanceKm) * 1000);
        const walkingTimeText = walkingMinutes < 1 ? '< 1' : walkingMinutes;
        
        // Autofahrt: 50 km/h = 1.2 Minuten pro km
        const carMinutes = Math.round(Number(data.distanceKm) * 1.2);
        const carTimeText = carMinutes < 1 ? '< 1' : carMinutes;
        
        // Entfernung: Meter oder Kilometer formatieren
        const distanceText = walkingMeters < 1000 ? `${walkingMeters}m` : `${Number(data.distanceKm).toFixed(1)}km`;
        
        // Minimalistisches Design: Icons + Zeiten/Entfernung, einzeilig
        mobilityRow.innerHTML = `
          <span style="display:inline-flex; align-items:center; gap:3px; white-space:nowrap;">
            <span style="font-size:14px; line-height:1;">ðŸš¶</span>
            <span>${walkingTimeText} min</span>
          </span>
          <span style="color:#999; font-size:10px;">|</span>
          <span style="display:inline-flex; align-items:center; gap:3px; white-space:nowrap;">
            <span style="font-size:14px; line-height:1;">ðŸš—</span>
            <span>${carTimeText} min</span>
          </span>
          <span style="color:#999; font-size:10px;">|</span>
          <span style="display:inline-flex; align-items:center; gap:3px; white-space:nowrap;">
            <span style="font-size:14px; line-height:1;">ðŸ“</span>
            <span>${distanceText}</span>
          </span>
        `;
        body.appendChild(mobilityRow);
      }
    } else {
      // Standard: Anbieter mit Store-Icon
      const providerEl = document.createElement('p');
      providerEl.className='card-provider';
      providerEl.style.cursor = 'pointer';
      providerEl.style.textDecoration = 'underline';
      providerEl.style.textDecorationColor = 'rgba(0,0,0,0.2)';
      providerEl.style.transition = 'opacity 0.2s ease';
      providerEl.onmouseover = () => { providerEl.style.opacity = '0.7'; };
      providerEl.onmouseout = () => { providerEl.style.opacity = '1'; };
      providerEl.innerHTML = `<i data-lucide="store" style="width:16px;height:16px;"></i> <span>${esc(data.providerName || 'Anbieter')}</span>`;
      providerEl.onclick = (e) => {
        e.stopPropagation();
        if(data.providerId){
          activeDiscoverFilter = 'provider';
          currentProviderFilter = data.providerId;
          renderDiscover();
          showToast(`Angebote von ${esc(data.providerName || 'Anbieter')}`);
        }
      };
      body.appendChild(providerEl);
    }
    
    // Preis: Nur bei Nicht-Polaroid (bei Polaroid ist Preis auf dem Bild)
    if(!isPolaroid){
    const price = document.createElement('div');
    price.className='card-price';
    price.textContent = euro(data.price);
    body.appendChild(price);
    }
    
    // Info-Zeile: Nur bei Nicht-Polaroid (bei Polaroid wird MobilitÃ¤ts-Zeile verwendet)
    if(!isPolaroid){
      const infoRow = document.createElement('div');
      infoRow.className='card-info-badges';
      
      // clock: timeRange
      if(data.pickupWindow){
        const timeBadge = document.createElement('span');
        timeBadge.className='card-info-badge';
        timeBadge.innerHTML = `${iconMarkup('clock')} <span>${esc(data.pickupWindow)}</span>`;
        infoRow.appendChild(timeBadge);
      }
      
      // map-pin: distance
      if(data.distanceKm != null){
        const distBadge = document.createElement('span');
        distBadge.className='card-info-badge';
        distBadge.innerHTML = `${iconMarkup('map-pin')} <span>${Number(data.distanceKm).toFixed(1)}</span>`;
        infoRow.appendChild(distBadge);
      }
      
      // food type: leaf (Vegan), carrot (Vegetarian), drumstick (Meat), fish (Fish)
      const foodTypeIcon = data.category === 'Vegan' ? 'leaf' : 
                           data.category === 'Vegetarisch' ? 'carrot' : 
                           data.category === 'Mit Fleisch' ? 'drumstick' : 
                           data.category === 'Fisch' ? 'fish' : '';
      if(foodTypeIcon){
        const typeBadge = document.createElement('span');
        typeBadge.className='card-info-badge';
        typeBadge.innerHTML = iconMarkup(foodTypeIcon);
        infoRow.appendChild(typeBadge);
      }
      
      // Max 4 Icons pro Info-Zeile
      if(infoRow.children.length > 4){
        while(infoRow.children.length > 4){
          infoRow.removeChild(infoRow.lastChild);
        }
      }
      
      if(infoRow.children.length > 0){
        body.appendChild(infoRow);
      }
    }
    
    // Actions: Primary CTA "In die Mittagsbox" (gelber Button ohne graue Box)
    if(interactive){
      if(isPolaroid){
        // Polaroid: Gelber Button direkt auf weiÃŸem Rand (ohne graue Box)
        const orderBtn = document.createElement('button');
        orderBtn.type = 'button';
        orderBtn.style.cssText = 'width:calc(100% - 32px); margin:12px 16px; min-height:48px; background:#FFCC00; color:#1a1a1a; font-weight:900; font-size:16px; border:none; border-radius:12px; box-shadow:0 4px 12px rgba(255,204,0,0.3); display:flex; align-items:center; justify-content:center; gap:8px; cursor:pointer; transition:transform 0.2s ease, box-shadow 0.2s ease;';
        orderBtn.onmouseover = () => {
          orderBtn.style.transform = 'translateY(-2px)';
          orderBtn.style.boxShadow = '0 6px 16px rgba(255,204,0,0.4)';
        };
        orderBtn.onmouseout = () => {
          orderBtn.style.transform = 'translateY(0)';
          orderBtn.style.boxShadow = '0 4px 12px rgba(255,204,0,0.3)';
        };
        orderBtn.innerHTML = `${iconMarkup('shopping-basket')} <span>In die Mittagsbox</span>`;
        orderBtn.disabled = !data.hasPickupCode;
        if(orderBtn.disabled){
          orderBtn.style.opacity = '0.5';
          orderBtn.style.cursor = 'not-allowed';
        }
        orderBtn.onclick = (e) => {
          e.stopPropagation();
          if(orderBtn.disabled) return;
          const thumb = card.querySelector('img');
          flyThumbnailToMittagsbox(thumb, () => handleOrderClick(data));
        };
        body.appendChild(orderBtn);
      } else {
        // Standard: Mit grauer Box
        const actions=document.createElement('div');
        actions.className='card-actions';
        
        const orderBtn=document.createElement('button');
        orderBtn.type='button';
        orderBtn.className='card-action primary';
        orderBtn.innerHTML = `${iconMarkup('shopping-basket')} <span>In die Mittagsbox</span>`;
        orderBtn.disabled = !data.hasPickupCode;
        orderBtn.onclick=(e)=>{ e.stopPropagation(); const thumb = card.querySelector('img'); flyThumbnailToMittagsbox(thumb, () => handleOrderClick(data)); };
        
        actions.appendChild(orderBtn);
        body.appendChild(actions);
      }
    }

    if(!isPolaroid) card.appendChild(img);
    card.appendChild(body);
    
    // Icons aktualisieren (fÃ¼r Heart Icon)
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
    
    return card;
  }

  function providerCard(o, opts={}){
    const data = normalizeOffer(o);
    const interactive = opts.interactive !== false;
    const showActions = opts.showActions === true;
    const isToday = data.day === (opts.todayKey || isoDate(new Date()));
    const statusLine = data.hasPickupCode ? (isToday ? 'Abholnummer Â· Heute' : 'Abholnummer') : '';
    const card=document.createElement('div');
    card.className='card';
    card.style.cursor = interactive ? 'pointer' : 'default';
    if(interactive){
      card.onclick=()=>openProviderOffer(data.id);
    }

    const profile = normalizeProviderProfile(provider.profile || {});
    const imgSrc = data.imageUrl || data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    const windowText = data.pickupWindow || profile.mealWindow || '';

    const img=document.createElement('div');
    img.className='img';
    img.innerHTML = `
      <img alt="${esc(data.dish||'Gericht')}" src="${esc(imgSrc)}" />
      ${data.active===false?'<div class="badge inactive">Inaktiv</div>':''}
      ${data.hasPickupCode?'<div class="badge code">Abholnummer</div>':''}
      ${data.dineInPossible?'<div class="badge dine">Vor Ort</div>':''}
    `;

    const body=document.createElement('div');
    body.className='body';
    body.innerHTML = `
      <p class="title">${esc(data.dish||'Gericht')}</p>
      <p class="sub">Essenszeit: ${esc(windowText || 'â€”')}</p>
      ${statusLine ? `<div class="tag">${esc(statusLine)}</div>` : ''}
      <div class="meta">
        <div class="price">${euro(data.price)}</div>
        <div class="right">
          <div>${esc(data.category||'')}</div>
        </div>
      </div>
    `;

    const info=document.createElement('div');
    info.className='info-row';
    const addInfo = (icon, text)=>{
      const item=document.createElement('div');
      item.className='info-item';
      item.innerHTML = `${iconMarkup(icon)}<span>${esc(text)}</span>`;
      info.appendChild(item);
    };
    if(data.hasPickupCode) addInfo('hash', 'Abholnummer');
    if(data.dineInPossible) addInfo('utensils', 'Vor Ort');
    if(info.childElementCount){ body.appendChild(info); }

    if(showActions){
      const actions=document.createElement('div');
      actions.className='card-actions';

      const actBtn=document.createElement('button');
      actBtn.type='button';
      actBtn.className='card-action';
      actBtn.innerHTML = `${iconMarkup('action')}<span>Aktionen</span>`;
      actBtn.onclick=(e)=>{ e.stopPropagation(); openProviderOffer(data.id); };

      const shareBtn=document.createElement('button');
      shareBtn.type='button';
      shareBtn.className='card-action';
      shareBtn.innerHTML = `${iconMarkup('share')}<span>Teilen</span>`;
      shareBtn.onclick=(e)=>{ e.stopPropagation(); shareOffer(data); };

      const printBtn=document.createElement('button');
      printBtn.type='button';
      printBtn.className='card-action';
      printBtn.innerHTML = `${iconMarkup('print')}<span>Drucken</span>`;
      printBtn.onclick=(e)=>{ e.stopPropagation(); printOffer(data); };

      actions.appendChild(actBtn);
      actions.appendChild(shareBtn);
      actions.appendChild(printBtn);
      body.appendChild(actions);
    }

    card.appendChild(img);
    card.appendChild(body);
    return card;
  }

  function toggleProviderFav(providerId){
    if(!providerId) return;
    if(providerFavs.has(providerId)) providerFavs.delete(providerId); else providerFavs.add(providerId);
    const arr = Array.from(providerFavs);
    save(LS.providerFavs, arr);
    // keep legacy key for compatibility
    save(LS.favs, arr);
    renderDiscover();
    renderStart();
    renderFavorites();
    updateSheetFavs();
  }

  // Haptics-Funktion fÃ¼r Vibrations-Feedback
  function triggerHapticFeedback(pattern = [15]){
    if(navigator.vibrate){
      try {
        navigator.vibrate(pattern);
      } catch(e){
        // Fallback: Ignoriere Fehler
      }
    }
  }

  function toggleDishFav(offerId){
    if(!offerId) return;
    triggerHapticFeedback([15]);
    if(dishFavs.has(offerId)){
      dishFavs.delete(offerId);
      clearFavPillars(offerId);
    } else {
      dishFavs.add(offerId);
      const offer = offers.find(o => o.id === offerId);
      if(offer){
        const data = normalizeOffer(offer);
        const prov = offers.find(p => p.providerId === data.providerId);
        const vorOrt = !!(prov && (prov.dineInPossible !== false || data.dineInPossible));
        const abholnummer = !!(prov && (prov.orderingEnabled !== false && (data.hasPickupCode || prov.hasPickupCode)));
        const mehrweg = !!(prov && (prov.reuseEnabled || prov.reuse || (prov.providerProfile && prov.providerProfile.reuseEnabled)));
        setFavPillars(offerId, { vorOrt, abholnummer, mehrweg });
      }
    }
    save(LS.dishFavs, Array.from(dishFavs));
    renderDiscover();
    renderStart();
    renderFavorites();
    updateSheetFavs();
  }
  
  // Favoriten-Kachel: Kompaktes Grid-Layout (Dashboard-Style)
  function createFavoriteCard(o){
    const data = normalizeOffer(o);
    const card = document.createElement('div');
    card.className = 'fav-grid-card';
    card.setAttribute('data-fav-id', data.id);
    card.style.position = 'relative';
    card.style.background = '#FFFFFF';
    card.style.borderRadius = '16px';
    card.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.08)';
    card.style.border = '1px solid rgba(0,0,0,0.06)';
    card.style.overflow = 'hidden';
    card.style.transition = 'transform 0.2s ease, opacity 0.3s ease, box-shadow 0.2s ease';
    card.style.cursor = 'pointer';
    card.style.display = 'flex';
    card.style.flexDirection = 'column';
    
    // Hover-Effekt
    card.onmouseenter = () => {
      card.style.transform = 'translateY(-2px)';
      card.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.12)';
    };
    card.onmouseleave = () => {
      card.style.transform = 'translateY(0)';
      card.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.08)';
    };
    
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    
    // Kompaktes Bild (reduzierte HÃ¶he fÃ¼r Grid)
    const img = document.createElement('div');
    img.style.position = 'relative';
    img.style.height = '96px'; // Kompakt: 96px statt 256px
    img.style.overflow = 'hidden';
    img.style.background = '#f0f0f0';
    const imgEl = document.createElement('img');
    imgEl.src = imgSrc;
    imgEl.alt = esc(data.dish||'Gericht');
    imgEl.style.width = '100%';
    imgEl.style.height = '100%';
    imgEl.style.objectFit = 'cover';
    img.appendChild(imgEl);
    
    // X-Icon oben rechts zum Entfernen (Schnell-Streichen)
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.style.position = 'absolute';
    removeBtn.style.top = '6px';
    removeBtn.style.right = '6px';
    removeBtn.style.zIndex = '10';
    removeBtn.style.background = 'rgba(255,255,255,0.95)';
    removeBtn.style.backdropFilter = 'blur(8px)';
    removeBtn.style.webkitBackdropFilter = 'blur(8px)';
    removeBtn.style.border = 'none';
    removeBtn.style.borderRadius = '50%';
    removeBtn.style.width = '28px';
    removeBtn.style.height = '28px';
    removeBtn.style.display = 'flex';
    removeBtn.style.alignItems = 'center';
    removeBtn.style.justifyContent = 'center';
    removeBtn.style.cursor = 'pointer';
    removeBtn.style.padding = '0';
    removeBtn.style.boxShadow = '0 2px 6px rgba(0,0,0,0.15)';
    removeBtn.style.transition = 'transform 0.2s ease, background 0.2s ease';
    removeBtn.innerHTML = '<i data-lucide="x" style="width:16px;height:16px;color:#E34D4D;stroke-width:3;"></i>';
    removeBtn.onmouseenter = () => {
      removeBtn.style.transform = 'scale(1.1)';
      removeBtn.style.background = '#fff';
    };
    removeBtn.onmouseleave = () => {
      removeBtn.style.transform = 'scale(1)';
      removeBtn.style.background = 'rgba(255,255,255,0.95)';
    };
    removeBtn.onclick = (e) => {
      e.stopPropagation();
      e.preventDefault();
      // Haptics beim Entfernen
      triggerHapticFeedback([15]);
      // Animation: Ausblenden
      card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      card.style.opacity = '0';
      card.style.transform = 'scale(0.9)';
      // Nach Animation entfernen
      setTimeout(() => {
      toggleDishFav(data.id);
        // Grid automatisch neu anordnen durch Re-Render
        renderFavorites();
      }, 300);
    };
    img.appendChild(removeBtn);
    
    // Kompakter Content-Bereich
    const body = document.createElement('div');
    body.style.padding = '8px';
    body.style.flex = '1';
    body.style.display = 'flex';
    body.style.flexDirection = 'column';
    body.style.gap = '4px';
    body.innerHTML = `
      <p style="font-size:10px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin:0; line-height:1.2; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${esc(data.providerName||'Anbieter')}</p>
      <p style="font-size:13px; font-weight:900; color:#1a1a1a; margin:0; line-height:1.3; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">${esc(data.dish||'Gericht')}</p>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:auto; padding-top:4px;">
        <span style="font-size:14px; font-weight:900; color:var(--brand);">${euro(data.price)}</span>
            </div>
    `;
    
    card.appendChild(img);
    card.appendChild(body);
    
    // Klick auf Karte Ã¶ffnet Details (nicht auf Remove-Button)
    card.onclick = (e) => {
      // Ignoriere Klicks auf Remove-Button
      if(e.target.closest('button[type="button"]')) return;
      openOffer(data.id);
    };
    
    return card;
  }
  
  // Favorit zur Mittagsbox hinzufÃ¼gen
  function addFavoriteToCart(o){
    const data = normalizeOffer(o);
    
    // PrÃ¼fe ob Gericht Abholnummer hat
    if(!data.hasPickupCode){
      showToast('Dieses Gericht hat keine Abholnummer. Bitte wÃ¤hle ein anderes Gericht.', 3000);
      return;
    }
    
    // BestÃ¤tigung
    const confirmed = confirm(`Dieses Gericht fÃ¼r heute wÃ¤hlen?\n\n${esc(data.dish||'Gericht')}\n${euro(data.price)}\n\nNach der Zahlung erhÃ¤ltst du deine Abholnummer.`);
    if(!confirmed) return;
    
    // Gericht hinzufÃ¼gen (statt "Zur Mittagsbox" - verboten fÃ¼r Endkunden)
    if(addToCart(o)){
      showToast('Gericht hinzugefÃ¼gt!', 2000);
      updateHeaderBasket();
      
      // Zur Mittagsbox navigieren (dort kann der Nutzer dann zur Kasse gehen)
      setTimeout(() => {
        showCart();
      }, 500);
    } else {
      showToast('Fehler beim HinzufÃ¼gen. Bitte erneut versuchen.', 3000);
    }
  }

  // Heute-Fokus: Immer nur heute anzeigen (kein Day-Switcher mehr)
  let activeFavDay = isoDate(new Date()); // Immer heute
  
  function renderFavorites(){
    const provGrid=document.getElementById('favProviders');
    const provEmpty=document.getElementById('emptyFavProviders');
    const dishGrid=document.getElementById('favDishes');
    const dishEmpty=document.getElementById('emptyFavDishes');
    const favEmptyState = document.getElementById('favEmptyState');
    const favContent = document.getElementById('favContent');
    if(!provGrid || !dishGrid || !provEmpty || !dishEmpty) return;
    
    // Day-Switcher ENTFERNT: Fokus zu 100% auf dem aktuellen Tag
    // activeFavDay wird immer auf heute gesetzt
    activeFavDay = isoDate(new Date());
    
    // Verstecke Day-Switcher falls noch vorhanden
    const daySwitcher = document.getElementById('favDaySwitcher');
    if(daySwitcher) daySwitcher.style.display = 'none';

    const candidates = offers
      .filter(o => o.active !== false && providerFavs.has(o.providerId) && o.day === activeFavDay)
      .sort((a,b)=>String(b.day||'').localeCompare(String(a.day||'')));
    const bestByProvider = new Map();
    candidates.forEach(o=>{
      if(!bestByProvider.has(o.providerId)) bestByProvider.set(o.providerId, o);
    });
    const providerList = Array.from(bestByProvider.values());

    const dishList = offers
      .filter(o => o.active !== false && dishFavs.has(o.id) && o.day === activeFavDay)
      .sort((a,b)=>String(b.day||'').localeCompare(String(a.day||'')));

    // Empty State: Wenn beide Listen leer sind, zeige zentrierten Empty State
    const hasAnyFavorites = providerList.length > 0 || dishList.length > 0;
    
    if(favEmptyState){
      favEmptyState.style.display = hasAnyFavorites ? 'none' : 'flex';
      // Stelle sicher, dass Flex-Layout aktiv ist
      if(!hasAnyFavorites){
        favEmptyState.style.flexDirection = 'column';
        favEmptyState.style.alignItems = 'center';
        favEmptyState.style.textAlign = 'center';
      }
    }
    if(favContent){
      favContent.style.display = hasAnyFavorites ? 'block' : 'none';
    }
    
    // Provider Section - "Deine Lieblings-Anbieter heute"
    const sectionProvidersWrapper = document.getElementById('sectionProvidersWrapper');
    const favProviderSeparator = document.getElementById('favProviderSeparator');
    provGrid.innerHTML='';
    
    // Zeige Sektion nur wenn es Anbieter-Favoriten gibt
    if(sectionProvidersWrapper){
      sectionProvidersWrapper.style.display = providerFavs.size > 0 ? 'block' : 'none';
    }
    if(favProviderSeparator){
      favProviderSeparator.style.display = (providerFavs.size > 0 && dishList.length > 0) ? 'block' : 'none';
    }
    
    const sectionProviders = document.getElementById('sectionProviders');
    if(sectionProviders) sectionProviders.style.display = providerList.length > 0 ? 'block' : 'none';
    provEmpty.style.display = providerList.length ? 'none' : 'block';
    
    // Alle favorisierten Anbieter durchgehen (nicht nur die mit Angeboten fÃ¼r heute)
    const allFavoritedProviders = Array.from(providerFavs);
    const providerMap = new Map();
    
    // Erstelle Map aller Anbieter mit ihren Angeboten fÃ¼r heute
    allFavoritedProviders.forEach(providerId => {
      const providerOffers = offers.filter(o => 
        o.providerId === providerId && 
        o.active !== false && 
        o.day === activeFavDay
      );
      // Finde erstes Angebot des Providers fÃ¼r Provider-Daten (Name, etc.)
      const firstOffer = offers.find(p => p.providerId === providerId);
      if(firstOffer){
        // Erstelle Provider-Objekt aus Angebot-Daten
        const providerData = {
          providerId: providerId,
          providerName: normalizeOffer(firstOffer).providerName || 'Anbieter',
          orderingEnabled: firstOffer.hasPickupCode !== false,
          dineInPossible: firstOffer.dineInPossible !== false,
          reuse: firstOffer.reuse || {enabled: false}
        };
        providerMap.set(providerId, {
          provider: providerData,
          offers: providerOffers,
          hasOfferToday: providerOffers.length > 0
        });
      }
    });
    
    // Rendere alle favorisierten Anbieter
    Array.from(providerMap.values()).forEach(({provider, offers: providerOffers, hasOfferToday}) => {
      if(provider){
        try {
          const providerCard = createFavoriteProviderCard(provider, providerOffers, hasOfferToday);
          provGrid.appendChild(providerCard);
        } catch(err){
          console.error('Error rendering provider favorite:', err, provider);
        }
      }
    });

    // Dish Section: Oberste 4 Gericht-Favoriten im 2x2 Grid (Jiggle + X)
    dishGrid.innerHTML='';
    const sectionDishesWrapper = document.getElementById('sectionDishesWrapper');
    if(sectionDishesWrapper) sectionDishesWrapper.style.display = dishList.length > 0 ? 'block' : 'none';
    dishEmpty.style.display = dishList.length ? 'none' : 'block';
    const topFour = dishList.slice(0, 4);
    topFour.forEach(o=>{
      if(o?.id){
        try {
          const favCard = createFavoriteGridCard(o);
          dishGrid.appendChild(favCard);
        } catch(err){
          console.error('Error rendering dish favorite:', err, o);
        }
      }
    });
    
    // Share (Web Share API) â€“ Logik-Weiche:
    // IF User wÃ¤hlt 'Team-Bestellung': Variante 2 (Direkt-Warenkorb-Link) â€“ zukÃ¼nftig
    // ELSE IF Abholnummer ðŸ§¾ vorhanden: Variante 1 (Fokus Zeitersparnis / Skip-the-line)
    // ELSE (Keine Abholnummer): Variante 3 (Fokus Gericht & Treffen â€“ â€žLockerer Lunchâ€œ)
    const favShareWrap = document.getElementById('favShareWrap');
    if(favShareWrap) favShareWrap.style.display = 'none';
    const baseUrl = window.location.href.split('#')[0] || window.location.origin || '';
    const firstDish = topFour.length > 0 ? normalizeOffer(topFour[0]) : null;
    const firstProviderName = (providerList.length > 0 && !firstDish) ? (normalizeOffer(providerList[0]).providerName || 'Mittagio') : null;
    const firstHasAbholnummer = firstDish && (() => {
      const o = topFour[0];
      const p = offers.find(x => x.providerId === (o && o.providerId));
      return !!(p && (p.orderingEnabled !== false && ((o && (o.hasPickupCode || o.orderingEnabled)) || (p.hasPickupCode))));
    })();
    // Smart-Share: Anbietername aus Favoriten-Kachel; abholnummer â†’ â€žskippenâ€œ vs. â€žMittag machenâ€œ
    const shareFavAction = () => {
      try {
        const providerName = (firstDish && firstDish.providerName) ? firstDish.providerName : (firstProviderName || 'Mittagio');
        const dishName = (firstDish && (firstDish.dish || firstDish.title)) ? (firstDish.dish || firstDish.title) : '';
        const linkToDish = (firstDish && firstDish.id) ? (baseUrl + '#offer=' + firstDish.id) : baseUrl;
        let shareText;
        if(firstHasAbholnummer){
          shareText = `Schau mal! Hier meine Favoriten heute bei ${providerName}! ðŸ´ Ich nehm die Abholnummer ðŸ§¾, dann kÃ¶nnen wir die Schlange einfach skippen. Kommst du mit? ${linkToDish}`;
        } else {
          shareText = `Schau mal! Hier meine Favoriten heute bei ${providerName}! ðŸ´ Sieht richtig gut aus, oder? Sollen wir heute dort Mittag machen? ${linkToDish}`;
        }
        const shareTitle = dishName ? `${dishName} â€“ ${providerName} | Mittagio` : 'Mein Mittag â€“ Mittagio';
        const doFallback = () => {
          try {
            if(navigator.clipboard && navigator.clipboard.writeText){
              navigator.clipboard.writeText(shareText).then(() => {
                if(typeof showToast === 'function') showToast('Link kopiert â€“ zum Teilen einfÃ¼gen');
              }).catch(() => {
                if(typeof showToast === 'function') showToast('Teilen: Link zum EinfÃ¼gen bereit');
              });
            } else {
              if(typeof showToast === 'function') showToast('Teilen: ' + shareTitle);
            }
          } catch(e2){
            if(typeof showToast === 'function') showToast('Teilen vorbereitet');
          }
        };
        if(navigator.share && typeof navigator.share === 'function'){
          navigator.share({ title: shareTitle, text: shareText, url: linkToDish })
            .then(() => { if(typeof showToast === 'function') showToast('Geteilt'); })
            .catch((err) => { if(err && err.name === 'AbortError') return; doFallback(); });
        } else {
          doFallback();
        }
      } catch(e){
        if(typeof showToast === 'function') showToast('Teilen nicht mÃ¶glich â€“ bitte Link manuell kopieren');
      }
    };
    const btnFavShareHeader = document.getElementById('btnFavShareHeader');
    if(btnFavShareHeader){
      btnFavShareHeader.style.display = (topFour.length > 0 || providerList.length > 0) ? 'flex' : 'none';
      btnFavShareHeader.onclick = function(e){ e.preventDefault(); e.stopPropagation(); shareFavAction(); };
    }
    const btnShareMyLunch = document.getElementById('btnShareMyLunch');
    if(btnShareMyLunch) btnShareMyLunch.onclick = shareFavAction;
    
    // Pull-Hinweis: anzeigen wenn es Favoriten fÃ¼r Morgen/Ãœbermorgen gibt
    const favPullHint = document.getElementById('favPullHint');
    const hasUpcoming = offers.some(o => o.active !== false && (dishFavs.has(o.id) || providerFavs.has(o.providerId)) && o.day !== activeFavDay);
    if(favPullHint) favPullHint.style.display = hasUpcoming ? 'block' : 'none';
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
    
    // Vorschau auf kommende Tage rendern
    renderFavoritesUpcomingPreview();
    
    // Scroll-Listener fÃ¼r Vorschau-Sektion einrichten
    setupFavoritesScrollListener();
  }
  
  // Vorschau auf kommende Tage (Morgen, Ãœbermorgen)
  function renderFavoritesUpcomingPreview(){
    const upcomingPreview = document.getElementById('favUpcomingPreview');
    const upcomingDays = document.getElementById('favUpcomingDays');
    if(!upcomingPreview || !upcomingDays) return;
    
    upcomingDays.innerHTML = '';
    
    const today = new Date();
    const upcomingDaysList = [];
    
    // Morgen und Ãœbermorgen
    for(let i = 1; i <= 2; i++){
      const d = new Date(today);
      d.setDate(d.getDate() + i);
      const dayKey = isoDate(d);
      const dayLabel = i === 1 ? 'Morgen' : fmtDay(d).split(',')[0];
      
      // Favoriten fÃ¼r diesen Tag finden
      const dayDishes = offers.filter(o => 
        o.active !== false && 
        dishFavs.has(o.id) && 
        o.day === dayKey
      );
      
      if(dayDishes.length > 0){
        upcomingDaysList.push({
          dayKey: dayKey,
          dayLabel: dayLabel,
          dishes: dayDishes
        });
      }
    }
    
    // Zeige Vorschau nur wenn es Gerichte gibt
    if(upcomingDaysList.length > 0){
      upcomingDaysList.forEach(({dayKey, dayLabel, dishes}) => {
        const daySection = document.createElement('div');
        daySection.style.cssText = 'margin-bottom:20px;';
        
        const dayTitle = document.createElement('div');
        dayTitle.style.cssText = 'font-size:14px; font-weight:700; color:#666; margin-bottom:10px; text-transform:uppercase; letter-spacing:0.5px;';
        dayTitle.textContent = dayLabel;
        daySection.appendChild(dayTitle);
        
        // Horizontale Scroll-Liste fÃ¼r kompakte Darstellung
        const scrollContainer = document.createElement('div');
        scrollContainer.style.cssText = 'display:flex; gap:10px; overflow-x:auto; padding-bottom:8px; scrollbar-width:thin; -webkit-overflow-scrolling:touch;';
        scrollContainer.style.scrollbarWidth = 'thin';
        
        dishes.forEach(o => {
          const data = normalizeOffer(o);
          const miniCard = createUpcomingDayCard(data, dayKey);
          scrollContainer.appendChild(miniCard);
        });
        
        daySection.appendChild(scrollContainer);
        upcomingDays.appendChild(daySection);
      });
    }
  }
  
  // Kompakte Karte fÃ¼r kommende Tage
  function createUpcomingDayCard(data, dayKey){
    const card = document.createElement('div');
    card.style.cssText = 'flex:0 0 auto; width:140px; background:#fff; border-radius:10px; border:1px solid rgba(0,0,0,0.08); box-shadow:0 1px 3px rgba(0,0,0,0.06); overflow:hidden; cursor:pointer; transition:transform 0.2s ease, box-shadow 0.2s ease;';
    
    card.onmouseover = () => {
      card.style.transform = 'translateY(-2px)';
      card.style.boxShadow = '0 2px 6px rgba(0,0,0,0.1)';
    };
    card.onmouseout = () => {
      card.style.transform = 'translateY(0)';
      card.style.boxShadow = '0 1px 3px rgba(0,0,0,0.06)';
    };
    
    card.onclick = () => {
      openOffer(data.id);
    };
    
    // Mini-Bild (kompakt)
    const img = document.createElement('div');
    img.style.cssText = 'width:100%; height:80px; background:#f0f0f0; overflow:hidden; position:relative;';
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    img.innerHTML = `<img src="${esc(imgSrc)}" alt="${esc(data.dish||'')}" style="width:100%; height:100%; object-fit:cover;" />`;
    card.appendChild(img);
    
    // Body
    const body = document.createElement('div');
    body.style.cssText = 'padding:8px;';
    
    // Gerichtname (kompakt)
    const title = document.createElement('div');
    title.style.cssText = "font-family:'Kalam', 'Comic Sans MS', 'Marker Felt', cursive; font-weight:700; font-size:12px; color:#000; margin-bottom:4px; line-height:1.2; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;";
    title.textContent = data.dish || 'Gericht';
    body.appendChild(title);
    
    // Restaurant-Name (sehr kompakt)
    const provider = document.createElement('div');
    provider.style.cssText = 'font-size:10px; color:#999; margin-bottom:6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;';
    provider.textContent = data.providerName || 'Anbieter';
    body.appendChild(provider);
    
    // 3 SÃ¤ulen-Icons (dezent, klein)
    const offerProvider = offers.find(p => p.providerId === data.providerId);
    const orderingEnabled = offerProvider && (offerProvider.orderingEnabled !== false && (data.hasPickupCode || offerProvider.hasPickupCode));
    const hasDineIn = offerProvider && (offerProvider.dineInPossible !== false || data.dineInPossible);
    const hasReuse = offerProvider && (offerProvider.reuse && offerProvider.reuse.enabled);
    
    const iconsRow = document.createElement('div');
    iconsRow.style.cssText = 'display:flex; align-items:center; justify-content:center; gap:6px;';
    iconsRow.innerHTML = `
      <span style="font-size:14px; opacity:${hasDineIn ? '1' : '0.3'};" title="Vor Ort">ðŸ´</span>
      <span style="font-size:14px; opacity:${orderingEnabled ? '1' : '0.3'};" title="Abholnummer">ðŸ§¾</span>
      <span style="font-size:14px; opacity:${hasReuse ? '1' : '0.3'};" title="Mehrweg">ðŸ”„</span>
    `;
    body.appendChild(iconsRow);
    
    card.appendChild(body);
    return card;
  }
  
  // Scroll-Listener fÃ¼r Vorschau-Sektion
  function setupFavoritesScrollListener(){
    const favContent = document.getElementById('favContent');
    const upcomingPreview = document.getElementById('favUpcomingPreview');
    if(!favContent || !upcomingPreview) return;
    
    let lastScrollTop = 0;
    let previewShown = false;
    
    const checkScroll = () => {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const favContentBottom = favContent.offsetTop + favContent.offsetHeight;
      const viewportBottom = scrollTop + window.innerHeight;
      
      // Zeige Vorschau wenn Nutzer unter Anbieter-Favoriten scrollt oder hochzieht
      if(!previewShown && (scrollTop > favContentBottom - window.innerHeight * 0.8 || scrollTop < lastScrollTop)){
        previewShown = true;
        upcomingPreview.style.display = 'block';
        // Fade-in Animation
        setTimeout(() => {
          upcomingPreview.style.opacity = '1';
        }, 50);
      }
      
      lastScrollTop = scrollTop;
    };
    
    // Initial check
    checkScroll();
    
    // Scroll-Listener
    window.addEventListener('scroll', checkScroll, {passive: true});
    
    // Touch-Listener fÃ¼r "hochziehen"
    let touchStartY = 0;
    favContent.addEventListener('touchstart', (e) => {
      touchStartY = e.touches[0].clientY;
    }, {passive: true});
    
    favContent.addEventListener('touchmove', (e) => {
      const touchY = e.touches[0].clientY;
      // Wenn Nutzer nach oben zieht (pull up)
      if(touchY > touchStartY + 50 && !previewShown){
        previewShown = true;
        upcomingPreview.style.display = 'block';
        setTimeout(() => {
          upcomingPreview.style.opacity = '1';
        }, 50);
      }
    }, {passive: true});
  }
  
  // Favoriten-Grid-Karte: homogenes Layout (fixe HÃ¶he, 1:1 Bild, 3 SÃ¤ulen unter Bild, Abholnummer #FFD700, CTA unten)
  function createFavoriteGridCard(o){
    const data = normalizeOffer(o);
    const card = document.createElement('div');
    card.className = 'fav-grid-card card';
    card.setAttribute('data-fav-id', data.id);
    card.style.cssText = 'position:relative; border-radius:24px; overflow:hidden; cursor:pointer;';
    
    // X-Button oben rechts
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.style.cssText = 'position:absolute; top:8px; right:8px; z-index:20; width:28px; height:28px; border-radius:50%; background:rgba(255,255,255,0.95); backdrop-filter:blur(8px); border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.15);';
    removeBtn.innerHTML = '<span style="font-size:18px; color:#E34D4D; font-weight:900;">âœ•</span>';
    removeBtn.onclick = (e) => { e.stopPropagation(); e.preventDefault(); triggerHapticFeedback([15]); card.classList.add('removing'); setTimeout(() => { toggleDishFav(data.id); renderFavorites(); }, 300); };
    card.appendChild(removeBtn);
    
    // Bild 1:1 (quadratisch)
    const imgWrap = document.createElement('div');
    imgWrap.className = 'fav-card-img-wrap';
    imgWrap.style.cssText = 'position:relative;';
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    imgWrap.innerHTML = `<img alt="${esc(data.dish||'')}" src="${esc(imgSrc)}" />`;
    const priceSticker = document.createElement('div');
    priceSticker.className = 'fav-card-price-sticker';
    priceSticker.textContent = euro(data.price);
    imgWrap.appendChild(priceSticker);
    card.appendChild(imgWrap);
    
    // Body: 3 SÃ¤ulen direkt unter Bild, dann Titel (ellipsis), dann CTA
    const body = document.createElement('div');
    body.className = 'fav-card-body body';
    body.style.cssText = 'background:#fff; padding:8px 10px 12px; flex:1; min-height:0; display:flex; flex-direction:column;';
    
    const dishKey = data.id;
    const stored = typeof getFavPillars === 'function' ? getFavPillars(dishKey) : null;
    const vorOrt = stored ? !!stored.vorOrt : (() => { const p = offers.find(x => x.providerId === data.providerId); return !!(p && (p.dineInPossible !== false || data.dineInPossible)); })();
    const abholnummer = stored ? !!stored.abholnummer : (() => { const p = offers.find(x => x.providerId === data.providerId); return !!(p && (p.orderingEnabled !== false && (data.hasPickupCode || p.hasPickupCode))); })();
    const mehrweg = stored ? !!stored.mehrweg : (() => { const p = offers.find(x => x.providerId === data.providerId); return !!(p && (p.reuse && p.reuse.enabled)); })();
    
    const barsWrap = document.createElement('div');
    barsWrap.style.cssText = 'flex-shrink:0;';
    barsWrap.innerHTML = typeof renderPillarBarsFavMini === 'function' ? renderPillarBarsFavMini(vorOrt, abholnummer, mehrweg) : (typeof renderPillarBarsDiscovery === 'function' ? renderPillarBarsDiscovery(vorOrt, abholnummer, mehrweg) : '');
    body.appendChild(barsWrap);
    
    const title = document.createElement('h3');
    title.className = 'fav-card-title';
    title.style.cssText = "font-family:'Kalam',cursive; font-weight:700; font-size:14px; color:#1a1a1a; margin:4px 0 0; padding:0; line-height:1.3; text-align:center;";
    title.textContent = data.dish || 'Gericht';
    body.appendChild(title);
    
    const ctaWrap = document.createElement('div');
    ctaWrap.style.cssText = 'margin-top:auto; padding-top:10px;';
    const ctaBtn = document.createElement('button');
    ctaBtn.type = 'button';
    ctaBtn.className = 'btn';
    ctaBtn.style.cssText = 'width:100%; min-height:40px; border-radius:12px; background:#FFD700; color:#1a1a1a; font-weight:800; font-size:13px; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px; transition:transform 0.2s, box-shadow 0.2s;';
    ctaBtn.innerHTML = (typeof iconMarkup === 'function' ? iconMarkup('shopping-basket') : '') + ' <span>In die Mittagsbox</span>';
    ctaBtn.onmouseover = () => { ctaBtn.style.transform = 'scale(1.02)'; ctaBtn.style.boxShadow = '0 4px 12px rgba(255,215,0,0.4)'; };
    ctaBtn.onmouseout = () => { ctaBtn.style.transform = 'scale(1)'; ctaBtn.style.boxShadow = 'none'; };
    ctaBtn.onclick = (e) => {
      e.stopPropagation();
      e.preventDefault();
      if(!abholnummer){ showToast('Keine Abholnummer â€“ nur ansehen.', 2000); return; }
      const thumb = card.querySelector('img');
      flyThumbnailToMittagsbox(thumb, () => {
        if(!addToCart(o)){ showToast('Fehler beim HinzufÃ¼gen.', 2000); return; }
        triggerHapticFeedback([20]);
        triggerCartIconGlow();
        showToast('In die Mittagsbox gelegt', 1500);
        if(typeof updateHeaderBasket === 'function') updateHeaderBasket();
      });
    };
    if(!abholnummer){ ctaBtn.style.background = '#e5e5e5'; ctaBtn.style.color = '#888'; ctaBtn.style.cursor = 'not-allowed'; ctaBtn.disabled = true; }
    ctaWrap.appendChild(ctaBtn);
    body.appendChild(ctaWrap);
    
    card.appendChild(body);
    
    card.onclick = (e) => {
      if(e.target.closest('button')) return;
      openOffer(data.id);
    };
    
    return card;
  }
  
  function triggerCartIconGlow(){
    const btn = document.getElementById('bottomNavBasketBtn');
    if(!btn) return;
    const ico = btn.querySelector('.ico');
    if(ico){ ico.classList.add('cart-icon-glow'); setTimeout(() => ico.classList.remove('cart-icon-glow'), 600); }
  }

  /**
   * Animation: Thumbnail verkleinert sich und fliegt in das Mittagsbox-Icon.
   * sourceEl = Bild-Element (img oder Container mit img); onComplete = Callback nach Ende.
   */
  function flyThumbnailToMittagsbox(sourceEl, onComplete){
    if(typeof onComplete !== 'function') onComplete = function(){};
    const targetBtn = document.getElementById('bottomNavBasketBtn');
    if(!targetBtn){ onComplete(); return; }
    const targetEl = targetBtn.querySelector('.ico') || targetBtn;
    const imgEl = sourceEl && (sourceEl.tagName === 'IMG' ? sourceEl : sourceEl.querySelector('img'));
    const src = imgEl && (imgEl.src || imgEl.getAttribute('src'));
    if(!src || !imgEl){ onComplete(); return; }
    const srcRect = imgEl.getBoundingClientRect();
    const targetRect = targetEl.getBoundingClientRect();
    const fly = document.createElement('div');
    fly.className = 'fly-thumbnail';
    const img = document.createElement('img');
    img.src = src;
    img.alt = '';
    fly.appendChild(img);
    fly.style.left = srcRect.left + 'px';
    fly.style.top = srcRect.top + 'px';
    fly.style.width = srcRect.width + 'px';
    fly.style.height = srcRect.height + 'px';
    fly.style.transition = 'none';
    document.body.appendChild(fly);
    const startCenterX = srcRect.left + srcRect.width / 2;
    const startCenterY = srcRect.top + srcRect.height / 2;
    const targetCenterX = targetRect.left + targetRect.width / 2;
    const targetCenterY = targetRect.top + targetRect.height / 2;
    const tx = targetCenterX - startCenterX;
    const ty = targetCenterY - startCenterY;
    requestAnimationFrame(function(){
      requestAnimationFrame(function(){
        fly.style.transition = 'transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.5s ease';
        fly.style.transform = 'translate(' + tx + 'px, ' + ty + 'px) scale(0.12)';
        fly.style.opacity = '0.85';
        setTimeout(function(){
          fly.remove();
          onComplete();
        }, 520);
      });
    });
  }

  // Anbieter-Favoriten-Karte: Kompakte Zeile mit Name, Text und 3 Icons
  function createFavoriteProviderCard(providerData, offersToday, hasOfferToday){
    const card = document.createElement('div');
    card.className = 'fav-provider-card';
    card.style.cssText = `
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 16px;
      background:#fff;
      border-radius:12px;
      border:1px solid rgba(0,0,0,0.08);
      box-shadow:0 1px 4px rgba(0,0,0,0.05);
      transition:all 0.2s ease;
      ${!hasOfferToday ? 'filter:grayscale(100%); opacity:0.5;' : ''}
    `;
    
    // Hover-Effekt nur wenn Angebot vorhanden
    if(hasOfferToday){
      card.onmouseover = () => {
        card.style.transform = 'translateY(-2px)';
        card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
      };
      card.onmouseout = () => {
        card.style.transform = 'translateY(0)';
        card.style.boxShadow = '0 1px 4px rgba(0,0,0,0.05)';
      };
    }
    
    // Anbieter-Logo/Icon (links)
    const logo = document.createElement('div');
    logo.style.cssText = 'width:48px; height:48px; border-radius:12px; background:#f0f0f0; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:24px;';
    logo.textContent = 'ðŸ½ï¸';
    card.appendChild(logo);
    
    // Text-Bereich (Mitte)
    const textArea = document.createElement('div');
    textArea.style.cssText = 'flex:1; min-width:0;';
    
    const name = document.createElement('div');
    name.style.cssText = 'font-size:15px; font-weight:700; color:#1a1a1a; margin-bottom:4px; line-height:1.3;';
    name.textContent = providerData.providerName || 'Anbieter';
    textArea.appendChild(name);
    
    if(hasOfferToday && offersToday.length > 0){
      const offer = offersToday[0];
      const data = normalizeOffer(offer);
      const text = document.createElement('div');
      text.style.cssText = 'font-size:13px; color:#666; line-height:1.4;';
      text.textContent = data.dish || 'Heute verfÃ¼gbar';
      textArea.appendChild(text);
    } else {
      const text = document.createElement('div');
      text.style.cssText = 'font-size:13px; color:#999; font-style:italic; line-height:1.4;';
      text.textContent = 'Aktuell kein Angebot fÃ¼r heute hinterlegt.';
      textArea.appendChild(text);
    }
    
    card.appendChild(textArea);
    
    // 3 SÃ¤ulen-Icons (rechts)
    const orderingEnabled = providerData.orderingEnabled !== false && (offersToday.length > 0 && offersToday.some(o => normalizeOffer(o).hasPickupCode));
    const hasDineIn = providerData.dineInPossible !== false || (offersToday.length > 0 && offersToday.some(o => normalizeOffer(o).dineInPossible));
    const hasReuse = providerData.reuse && providerData.reuse.enabled;
    
    const iconsRow = document.createElement('div');
    iconsRow.style.cssText = 'display:flex; align-items:center; gap:8px; flex-shrink:0;';
    
    // Vor Ort ðŸ´
    const icon1 = document.createElement('span');
    icon1.style.cssText = `font-size:20px; opacity:${hasDineIn ? '1' : '0.3'};`;
    icon1.textContent = 'ðŸ´';
    icon1.title = 'Vor Ort essen mÃ¶glich';
    iconsRow.appendChild(icon1);
    
    // Abholnummer ðŸ§¾ (gelb markiert wenn verfÃ¼gbar)
    const icon2 = document.createElement('span');
    if(orderingEnabled){
      icon2.style.cssText = 'font-size:20px; opacity:1; background:linear-gradient(135deg, rgba(255,215,0,0.3) 0%, rgba(255,184,0,0.2) 100%); border-radius:50%; padding:4px; display:inline-flex; align-items:center; justify-content:center;';
    } else {
      icon2.style.cssText = 'font-size:20px; opacity:0.3;';
    }
    icon2.textContent = 'ðŸ§¾';
    icon2.title = 'Abholnummer verfÃ¼gbar';
    iconsRow.appendChild(icon2);
    
    // Mehrweg ðŸ”„
    const icon3 = document.createElement('span');
    icon3.style.cssText = `font-size:20px; opacity:${hasReuse ? '1' : '0.3'};`;
    icon3.textContent = 'ðŸ”„';
    icon3.title = 'Mehrweg mÃ¶glich';
    iconsRow.appendChild(icon3);
    
    card.appendChild(iconsRow);
    
    // Klick auf Karte: Zu Anbieter-Detail oder Discovery mit Filter
    if(hasOfferToday && offersToday.length > 0){
      card.style.cursor = 'pointer';
      card.onclick = () => {
        activeDiscoverFilter = 'provider';
        currentProviderFilter = providerData.providerId;
        renderDiscover();
        showDiscover();
        showToast(`Angebote von ${esc(providerData.providerName || 'Anbieter')}`);
      };
    }
    
    return card;
  }

  function genPickupCode(){
    return generatePickupCode();
  }

  function renderOrders(){
    // Orders aus localStorage laden
    orders = loadOrders();
    
    const box = document.getElementById('ordersList');
    const filters = document.getElementById('ordersFilters');
    if(!box) return;
    if(filters){
      filters.innerHTML='';
      [
        {id:'offen', label:'Offen'},
        {id:'abgeholt', label:'Abgeholt'},
        {id:'alle', label:'Alle'}
      ].forEach(f=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(ordersFilter===f.id?' on':'');
        b.textContent=f.label;
        b.onclick=()=>{ ordersFilter=f.id; renderOrders(); };
        filters.appendChild(b);
      });
    }
    if(!orders.length){
      box.textContent = 'Noch keine Bestellungen.';
      return;
    }
    const fmt = (ts)=>{
      const d = new Date(ts);
      if(Number.isNaN(d.getTime())) return '';
      return fmtDay(d);
    };
    const list = orders.filter(o=>{
      if(ordersFilter==='alle') return true;
      // Map status for filter matching
      const status = o.status || 'offen';
      if(ordersFilter === 'offen'){
        // Show PAID orders (not picked up)
        return status === 'PAID';
      }
      if(ordersFilter === 'abgeholt'){
        // Show PICKED_UP or COMPLETED orders
        return status === 'PICKED_UP' || status === 'COMPLETED' || o.pickupStatus === 'PICKED_UP';
      }
      return status === ordersFilter;
    });
    list.sort((a,b)=>{
      if(ordersFilter === 'alle'){
        const sa = a.status || 'offen';
        const sb = b.status || 'offen';
        // Sortierung: PAID > PAYMENT_PENDING > CREATED > andere
        const priority = { 'PAID': 1, 'PAYMENT_PENDING': 2, 'CREATED': 3, 'offen': 4 };
        const pa = priority[sa] || 5;
        const pb = priority[sb] || 5;
        if(pa !== pb) return pa - pb;
      }
      return (b.createdAt||0) - (a.createdAt||0);
    });
    if(!list.length){
      box.textContent = 'Keine passenden Bestellungen.';
      return;
    }
    box.innerHTML = list.map(o=>{
      // Status-Anzeige
      const status = o.status || 'offen';
      // Check for PICKED_UP status (from pickupStatus field or status)
      // Single source of truth: Order record
      const isPickedUp = status === 'PICKED_UP' || status === 'COMPLETED' || o.pickupStatus === 'PICKED_UP' || status === 'abgeholt';
      const statusLabel = isPickedUp ? 'Abgeholt âœ…' :
                         status === 'CREATED' ? 'Erstellt' :
                         status === 'PAYMENT_PENDING' ? 'Zahlung ausstehend' :
                         status === 'PAID' ? 'Bezahlt' :
                         status === 'CANCELLED' ? 'Abgebrochen' :
                         status;
      const isDone = isPickedUp;
      const code = o.pickupCode || o.code || '';
      // Code nur anzeigen wenn PAID (Guard)
      const showCode = status === 'PAID' && code;
      
      return `
      <div class="order-item ${isDone ? 'done' : ''}">
        <div class="order-top">
          <div>
            <div style="font-weight:900">${esc(o.providerName || 'Anbieter')}</div>
            <div class="hint">${esc(o.dishName || o.summary || '')}</div>
          </div>
          <div class="order-right">
            ${showCode ? `<button class="order-code" type="button" data-id="${esc(o.id||'')}" data-code="${esc(code)}">${esc(code)}</button>` : ''}
            <div class="status-pill ${isDone ? 'done' : 'open'}">${esc(statusLabel)}</div>
          </div>
        </div>
        <div class="hint" style="margin-top:6px;">
          ${o.total ? `Gesamt: ${euro(o.totalCents ? (o.totalCents / 100) : (o.total || 0))} Â· ` : ''}${o.etaTime ? `Abholzeit: ${esc(o.etaTime)} Â· ` : ''}${fmt(o.createdAt)}
        </div>
      </div>
    `;
    }).join('');

    box.querySelectorAll('.order-code').forEach(btn=>{
      btn.onclick=()=> {
        const orderId = btn.getAttribute('data-id') || '';
        showPickupCode(orderId); // Ã–ffnet Abholnummer-Sheet (quick-ticket)
      };
    });
  }

  function openCodeSheet(orderId){
    const order = getOrderById(orderId) || (typeof orders !== 'undefined' && orders ? orders.find(o=>o.id===orderId) : null);
    if(!order) return;
    openCodeSheetWithOrder(order);
  }
  function closeCodeSheet(){
    document.getElementById('codeBd').classList.remove('active');
    document.getElementById('codeSheet').classList.remove('active');
    activeOrderId = null;
  }

  /** Bestelldetail-Sheet: Zeigt Gericht, Anbieter, Datum, Status; bei PAID/PICKED_UP zusÃ¤tzlich Abholnummer. */
  function showOrderDetail(orderId){
    const order = getOrderById(orderId);
    if(!order){
      showToast('Bestellung nicht gefunden');
      return;
    }
    const dateStr = order.pickupDate || (order.createdAt ? new Date(order.createdAt).toLocaleDateString('de-DE') : 'â€“');
    const statusText = order.status === 'PICKED_UP' || order.status === 'abgeholt' ? 'Abgeholt' : (order.status === 'PAID' ? 'Bezahlt' : order.status || 'â€“');
    const content = document.getElementById('orderDetailContent');
    if(content){
      content.innerHTML = `
        <div><span style="color:#64748b;">Gericht</span><br><strong>${esc(order.dishName || order.summary || 'Bestellung')}</strong></div>
        <div><span style="color:#64748b;">Anbieter</span><br><strong>${esc(order.providerName || 'Anbieter')}</strong></div>
        <div><span style="color:#64748b;">Datum</span><br><strong>${esc(dateStr)}</strong></div>
        <div><span style="color:#64748b;">Status</span><br><strong>${esc(statusText)}</strong></div>
      `;
    }
    const block = document.getElementById('orderDetailAbholnummerBlock');
    const codeEl = document.getElementById('orderDetailCode');
    const btnShowCode = document.getElementById('btnOrderDetailShowCode');
    const isPaidOrPickedUp = order.status === 'PAID' || order.status === 'PICKED_UP' || order.status === 'abgeholt';
    if(block){
      if(isPaidOrPickedUp && (order.pickupCode || order.code)){
        block.style.display = 'block';
        if(codeEl) codeEl.textContent = order.pickupCode || order.code || 'â€“';
        if(btnShowCode){
          btnShowCode.onclick = function(){ closeOrderDetailSheet(); openCodeSheetWithOrder(order); };
        }
      } else {
        block.style.display = 'none';
      }
    }
    document.getElementById('orderDetailBd').classList.add('active');
    document.getElementById('orderDetailSheet').classList.add('active');
  }

  function closeOrderDetailSheet(){
    document.getElementById('orderDetailBd').classList.remove('active');
    document.getElementById('orderDetailSheet').classList.remove('active');
  }

  // --- Offer sheet ---
  let activeOfferId=null;
  let activeProviderOfferId=null;
  // Navigation History fÃ¼r Back-Button
  let navigationHistory = [];
  
  function openOffer(id){
    const raw = offers.find(x=>x.id===id);
    if(!raw) return;
    const o = normalizeOffer(raw);
    activeOfferId=id;
    
    // History speichern (inkl. Scroll-Position)
    navigationHistory.push({
      view: mode === 'start' ? 'start' : 'discover',
      locationQuery: locationQuery,
      activeCat: activeCat,
      activeDay: activeDay,
      activeFilter: activeDiscoverFilter,
      scrollY: window.scrollY
    });

    const sImg = document.getElementById('sImg');
    const sDish = document.getElementById('sDish');
    
    // Foto-Handling mit Platzhalter
    const sImgPlaceholder = document.getElementById('sImgPlaceholder');
    if(sImg){
      const imgSrc = o.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
      sImg.src = imgSrc;
      sImg.onerror = () => {
        if(sImgPlaceholder) sImgPlaceholder.style.display = 'flex';
        if(sImg) sImg.style.display = 'none';
      };
      sImg.onload = () => {
        if(sImgPlaceholder) sImgPlaceholder.style.display = 'none';
        if(sImg) sImg.style.display = 'block';
      };
    }
    if(sDish) sDish.textContent = o.dish || '';
    
    // Preis in Details (nicht auf dem Bild)
    const sPriceRow = document.getElementById('sPriceRow');
    if(sPriceRow){ sPriceRow.textContent = euro(o.price); sPriceRow.style.display = 'block'; }
    
    // 3 SÃ¤ulen: nur anzeigen was gilt â€“ ðŸ´ immer, ðŸ§¾ nur bei Abholnummer, ðŸ”„ nur bei Mehrweg
    const sThreePillars = document.getElementById('sThreePillars');
    if(sThreePillars){
      const offerProvider = offers.find(p => p.providerId === o.providerId);
      const orderingEnabled = offerProvider && (offerProvider.orderingEnabled !== false && (o.hasPickupCode || offerProvider.hasPickupCode));
      const hasReuseSupport = offerProvider && (offerProvider.reuseEnabled || offerProvider.reuse || (offerProvider.providerProfile && offerProvider.providerProfile.reuseEnabled));
      const hasDineIn = o.dineInPossible !== false;
      const pillars = [];
      pillars.push(`<div style="display:flex; align-items:center; gap:10px; padding:10px 14px; background:rgba(0,0,0,0.06); border-radius:14px; border:1px solid rgba(0,0,0,0.08);"><span style="font-size:24px;">ðŸ´</span><span style="color:#1a1a1a; font-size:14px; font-weight:700;">Vor Ort</span></div>`);
      if(hasReuseSupport) pillars.push(`<div style="display:flex; align-items:center; gap:10px; padding:10px 14px; background:rgba(39,174,96,0.12); border-radius:14px; border:1px solid rgba(39,174,96,0.25);"><span style="font-size:24px;">ðŸ”„</span><span style="color:#1a1a1a; font-size:14px; font-weight:700;">Mehrweg</span></div>`);
      if(orderingEnabled) pillars.push(`<div style="display:flex; align-items:center; gap:10px; padding:10px 14px; background:rgba(255,215,0,0.2); border-radius:14px; border:1px solid rgba(255,215,0,0.4);"><span style="font-size:24px;">ðŸ§¾</span><span style="color:#1a1a1a; font-size:14px; font-weight:700;">Abholnummer</span></div>`);
      sThreePillars.innerHTML = pillars.join('');
    }
    
    // Mittags-Zeitfenster (Pill): "Abholung heute Mittag von X â€“ Y Uhr"
    const sMealTimeRange = document.getElementById('sMealTimeRange');
    const sMealTimeWrap = document.getElementById('sMealTime');
    if(sMealTimeRange && sMealTimeWrap){
      if(o.pickupWindow){
        const timeMatch = o.pickupWindow.match(/(\d{1,2}:\d{2})\s*[â€“-]\s*(\d{1,2}:\d{2})/);
        sMealTimeRange.textContent = timeMatch && timeMatch[1] && timeMatch[2] ? `Abholung heute Mittag von ${timeMatch[1]} â€“ ${timeMatch[2]} Uhr` : `Abholung heute Mittag ${o.pickupWindow} Uhr`;
        sMealTimeWrap.style.display = 'flex';
      } else { sMealTimeRange.textContent = 'â€“'; sMealTimeWrap.style.display = 'flex'; }
    }
    
    // Anbieter-Modul: Name (klickbar â†’ alle Gerichte dieses Anbieters) + Adresse + Entfernungsangaben
    const sProviderName = document.getElementById('sProviderName');
    const sProviderNameBtn = document.getElementById('sProviderNameBtn');
    const sProviderAddress = document.getElementById('sProviderAddress');
    const sDistanceInfo = document.getElementById('sDistanceInfo');
    if(sProviderName) sProviderName.textContent = o.providerName || 'Anbieter';
    if(sProviderNameBtn){
      sProviderNameBtn.onclick = () => {
        closeSheet();
        activeDiscoverFilter = 'provider';
        currentProviderFilter = o.providerId;
        if(typeof showView === 'function') showView(views.discover || 'v-discover');
        if(typeof renderDiscover === 'function') renderDiscover();
        if(typeof renderDiscoverCategories === 'function') renderDiscoverCategories();
        showToast('Alle Gerichte von ' + (o.providerName || 'Anbieter'), 2000);
      };
    }
    const addr = buildAddress({address:o.address, street:o.providerStreet, zip:o.providerZip, city:o.providerCity});
    if(sProviderAddress) sProviderAddress.textContent = addr || 'Adresse nicht verfÃ¼gbar';
    
    // Logistik: Zwei klickbare Kacheln (ðŸš¶ FuÃŸweg, ðŸš— Fahrtweg) â€“ Klick Ã¶ffnet Route in Google Maps, ohne blaue Link-Optik
    if(sDistanceInfo && o.distanceKm != null){
      const walkingMinutes = Math.round(Number(o.distanceKm) * 12);
      const carMinutes = Math.round(Number(o.distanceKm) * 1.2);
      const walkingTimeText = walkingMinutes < 1 ? '< 1 Min.' : walkingMinutes + ' Min.';
      const carTimeText = carMinutes < 1 ? '< 1 Min.' : carMinutes + ' Min.';
      const providerIdForMaps = o.providerId;
      const tileStyle = 'flex:1; min-width:100px; padding:12px 14px; border-radius:12px; border:1px solid rgba(0,0,0,0.1); background:rgba(0,0,0,0.04); color:#333; font-size:14px; font-weight:600; cursor:pointer; text-align:center; transition:all 0.2s ease; text-decoration:none;';
      sDistanceInfo.style.display = 'flex';
      sDistanceInfo.innerHTML = `
        <button type="button" style="${tileStyle}" onmouseover="this.style.background='rgba(0,0,0,0.08)'; this.style.borderColor='rgba(0,0,0,0.15)';" onmouseout="this.style.background='rgba(0,0,0,0.04)'; this.style.borderColor='rgba(0,0,0,0.1)';" onclick="openGoogleMapsRoute('${esc(providerIdForMaps)}');">ðŸš¶ FuÃŸweg Â· ${walkingTimeText}</button>
        <button type="button" style="${tileStyle}" onmouseover="this.style.background='rgba(0,0,0,0.08)'; this.style.borderColor='rgba(0,0,0,0.15)';" onmouseout="this.style.background='rgba(0,0,0,0.04)'; this.style.borderColor='rgba(0,0,0,0.1)';" onclick="openGoogleMapsRoute('${esc(providerIdForMaps)}');">ðŸš— Fahrtweg Â· ${carTimeText}</button>
      `;
    } else if(sDistanceInfo){
      sDistanceInfo.style.display = 'none';
    }
    
    // Status Badge (dynamisch basierend auf ordering_enabled)
    const statusBadgeEl = document.getElementById('sStatusBadge');
    const offerProvider = offers.find(p => p.providerId === o.providerId);
    const orderingEnabled = offerProvider && (offerProvider.orderingEnabled !== false && (o.hasPickupCode || offerProvider.hasPickupCode));
    
    if(statusBadgeEl){
      if(orderingEnabled){
        // Express-Anbieter: Badge "Nur mit Abholnummer"
        statusBadgeEl.innerHTML = '<span style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px; background:rgba(39,174,96,0.12); border-radius:8px; color:#27AE60; font-size:13px; font-weight:700; border:1px solid rgba(39,174,96,0.2);">âš¡ Nur mit Abholnummer</span>';
      } else {
        // Info-Anbieter: Status "Nur Info"
        statusBadgeEl.innerHTML = '<span style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px; background:rgba(100,116,139,0.1); border-radius:8px; color:#64748b; font-size:13px; font-weight:600; border:1px solid rgba(100,116,139,0.2);">ðŸ‘ï¸ Nur Info</span>';
      }
    }

    // Badges Row (max 3) - Eco-Badge fÃ¼r Mehrweg-Option
    const badgesEl = document.getElementById('sBadges');
    if(badgesEl){
      badgesEl.innerHTML = '';
      const badges = [];
      // Mehrweg-Badge (hÃ¶chste PrioritÃ¤t) - offerProvider bereits oben deklariert
      const hasReuseSupport = offerProvider && (offerProvider.reuseEnabled || offerProvider.reuse || (offerProvider.providerProfile && offerProvider.providerProfile.reuseEnabled));
      if(hasReuseSupport && badges.length < 3) badges.push({class:'eco', text:'Mehrweg mÃ¶glich', icon:'leaf', emoji:'ðŸŒ¿'});
      if(orderingEnabled && badges.length < 3) badges.push({class:'code', text:'Abholnummer', icon:'hash'});
      if(!orderingEnabled && badges.length < 3) badges.push({class:'pickup', text:'Zum Mitnehmen', icon:'shopping-bag'});
      
      badges.slice(0, 3).forEach(badge => {
        const badgeEl = document.createElement('span');
        badgeEl.className = `card-status-badge ${badge.class}`;
        if(badge.class === 'eco'){
          badgeEl.style.background = 'rgba(39,174,96,0.1)';
          badgeEl.style.color = '#27AE60';
          badgeEl.style.border = '1px solid rgba(39,174,96,0.2)';
          badgeEl.innerHTML = `<img src="assets/icon-mehrweg.png" alt="Mehrweg" class="concept-icon" style="width:16px;height:16px; margin-right:4px;"><span>${esc(badge.text)}</span>`;
        } else if(badge.class === 'code'){
          badgeEl.innerHTML = `<img src="assets/icon-abholnummer.png" alt="Abholnummer" class="concept-icon" style="width:16px;height:16px; margin-right:4px;"> <span>${esc(badge.text)}</span>`;
        } else {
          badgeEl.innerHTML = `<i data-lucide="${badge.icon}" style="width:14px;height:14px;"></i> <span>${esc(badge.text)}</span>`;
        }
        badgesEl.appendChild(badgeEl);
      });
    }
    
    // Info Row (Icons: clock, map-pin, food icon)
    const infoRowEl = document.getElementById('sInfoRow');
    if(infoRowEl){
      infoRowEl.innerHTML = '';
      if(o.pickupWindow){
        const day = o.day ? new Date(o.day) : new Date();
        const dateStr = fmtDateWithTime(day, o.pickupWindow);
        const timeEl = document.createElement('div');
        timeEl.style.display = 'flex';
        timeEl.style.alignItems = 'center';
        timeEl.style.gap = '6px';
        timeEl.innerHTML = `${iconMarkup('clock')} <span>${esc(dateStr)}</span>`;
        infoRowEl.appendChild(timeEl);
      }
      // Entfernt: Einzelnes Navi-Icon - Entfernungsangaben werden in sDistanceInfo angezeigt
      // Food type icon (exactly one)
      const foodTypeIcon = o.category === 'Vegan' ? 'leaf' : 
                           o.category === 'Vegetarisch' ? 'carrot' : 
                           o.category === 'Fisch' ? 'fish' :
                           o.category === 'Mit Fleisch' ? 'drumstick' : '';
      if(foodTypeIcon){
        const foodEl = document.createElement('div');
        foodEl.innerHTML = iconMarkup(foodTypeIcon);
        infoRowEl.appendChild(foodEl);
      }
    }
    
    // Address Card (addr bereits oben deklariert, wiederverwenden)
    const maps = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
    const addressFullEl = document.getElementById('sAddressFull');
    if(addressFullEl){
      const fullAddr = [
        o.providerName || '',
        o.providerStreet || '',
        o.providerZip || '',
        o.providerCity || ''
      ].filter(Boolean).join(', ');
      addressFullEl.textContent = fullAddr || addr || '-';
    }
    
    // Allergene: KÃ¼rzel (A, C, G...) direkt sichtbar unter Adresse, (â“˜) Ã¶ffnet Overlay
    const aw = document.getElementById('sAllergensWrap');
    const sAllergensCodes = document.getElementById('sAllergensCodes');
    const sAllergens = document.getElementById('sAllergens');
    if(aw){
      if(o.allergens && o.allergens.length){
        aw.style.display = 'flex';
        const r = o.allergens.map(a => String(a||'').trim());
        const codes = [];
        r.forEach(v => {
          const u = v.toUpperCase();
          if(ALLERGENE_STANDARD[u]){ codes.push(u); return; }
          const nk = Object.keys(ALLERGENE_NAME_TO_CODE).find(k => k.toLowerCase() === v.toLowerCase());
          const c = nk ? ALLERGENE_NAME_TO_CODE[nk] : null;
          if(c && ALLERGENE_STANDARD[c]) codes.push(c);
        });
        const seen = {};
        const uniq = codes.filter(c => { if(seen[c]) return false; seen[c]=1; return true; });
        if(sAllergensCodes) sAllergensCodes.textContent = uniq.length ? uniq.join(', ') : 'â€“';
        if(sAllergens){
          const firstWord = (l) => (typeof allergenFirstWord === 'function' ? allergenFirstWord(l) : String(l||'').trim().split(/\s+/)[0]) || l;
          const list = uniq.map(c => {
            const label = ALLERGENE_STANDARD[c];
            const word = firstWord(label);
            return `<div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
              <i data-lucide="shield-alert" style="width:16px;height:16px;color:rgba(255,255,255,0.7);flex-shrink:0;"></i>
              <span style="font-weight:700; color:rgba(255,255,255,0.9);">${esc(c)}</span>
              <span style="color:rgba(255,255,255,0.75); font-size:12px;">${esc(word)}</span>
            </div>`;
          }).join('');
          sAllergens.innerHTML = list || '';
          if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
        }
      } else {
        aw.style.display = 'flex';
        if(sAllergensCodes) sAllergensCodes.textContent = 'â€“';
      }
    }

    // Extras
    const ew = document.getElementById('sExtrasWrap');
    if(ew){
      if(o.extras && o.extras.length){
        ew.style.display='block';
        const sx = document.getElementById('sExtras');
        if(sx) sx.textContent = o.extras.map(e=>`${e.name} (+${euro(e.price)})`).join(' Â· ');
      } else ew.style.display='none';
    }

    // Reuse
    const rw = document.getElementById('sReuseWrap');
    if(rw){
      if(o.reuse && o.reuse.enabled){
        rw.style.display='block';
        const sr = document.getElementById('sReuse');
        if(sr) sr.textContent = `Pfand ${euro(o.reuse.deposit)}`;
      } else rw.style.display='none';
    }

    // Eco-Badge fÃ¼r Mehrweg-Option (zusÃ¤tzlich zu Reuse-Wrap) - offerProvider bereits oben deklariert
    const ecoBadgeEl = document.getElementById('sEcoBadge');
    if(ecoBadgeEl){
      const hasReuseSupport = offerProvider && (offerProvider.reuseEnabled || offerProvider.reuse || (offerProvider.providerProfile && offerProvider.providerProfile.reuseEnabled));
      if(hasReuseSupport){
        ecoBadgeEl.style.display = 'block';
        ecoBadgeEl.innerHTML = `<div style="padding:8px 12px; background:rgba(39,174,96,0.1); border-radius:8px; font-size:13px; font-weight:700; color:#27AE60; display:inline-flex; align-items:center; gap:6px; border:1px solid rgba(39,174,96,0.2);"><img src="assets/icon-mehrweg.png" alt="Mehrweg" class="concept-icon"> <span>Mehrweg mÃ¶glich</span></div>`;
      } else {
        ecoBadgeEl.style.display = 'none';
      }
    }

    // Primary CTA (dynamisch basierend auf Abholnummer) - offerProvider und orderingEnabled bereits oben deklariert
    const primaryCTA = document.getElementById('btnPrimaryCTA');
    const primaryCTAText = document.getElementById('btnPrimaryCTAText');
    const sInfoHint = document.getElementById('sInfoHint');
    
    if(primaryCTA && primaryCTAText){
      // Reset states
      primaryCTA.disabled = false;
      primaryCTA.className = 'btn-primary';
      primaryCTA.classList.remove('loading', 'success');
      
      // Check if offer is active/available
      const isActive = o.active !== false;
      const todayKey = isoDate(new Date());
      const isToday = o.day === todayKey;
      const isAvailable = isActive && isToday;
      
      if(!isAvailable){
        // Disabled state with reason
        primaryCTA.disabled = true;
        if(!isActive){
          primaryCTAText.textContent = 'Angebot nicht verfÃ¼gbar';
        } else if(!isToday){
          primaryCTAText.textContent = 'Angebot nicht mehr verfÃ¼gbar';
        } else {
          primaryCTAText.textContent = 'Nicht verfÃ¼gbar';
        }
        primaryCTA.onclick = null;
      } else if(orderingEnabled){
        // Express-Anbieter (ordering_enabled): CTA "In die Mittagsbox legen"
        primaryCTAText.textContent = 'In die Mittagsbox legen';
        if(sInfoHint){
          sInfoHint.textContent = '';
          sInfoHint.style.display = 'none';
        }
        primaryCTA.onclick = () => {
          // Loading state
          primaryCTA.disabled = true;
          primaryCTA.classList.add('loading');
          primaryCTAText.textContent = 'Wird hinzugefÃ¼gt...';
          
          // Automatisch als Favorit speichern
          const favorites = JSON.parse(localStorage.getItem('mittagio_favorites') || '[]');
          const dishKey = o.id;
          if(!favorites.includes(dishKey)){
            favorites.push(dishKey);
            localStorage.setItem('mittagio_favorites', JSON.stringify(favorites));
            // Auch in dishFavs Set hinzufÃ¼gen
            if(!dishFavs.has(dishKey)){
              dishFavs.add(dishKey);
              save(LS.dishFavs, Array.from(dishFavs));
            }
            // Herz-Icon aktualisieren (rot leuchtend)
            const favBtn = document.getElementById('sFavoriteBtn');
            if(favBtn){
              const heartIcon = favBtn.querySelector('i[data-lucide="heart"]');
              if(heartIcon){
                heartIcon.style.fill = '#e74c3c';
                heartIcon.style.color = '#e74c3c';
              }
            }
          }
          
          // Animation: Thumbnail fliegt in Mittagsbox, dann addToCart
          const sImg = document.getElementById('sImg');
          flyThumbnailToMittagsbox(sImg, () => {
            if(addToCart(o)){
              triggerCartIconGlow();
              primaryCTA.classList.remove('loading');
              primaryCTA.classList.add('success');
              primaryCTAText.textContent = 'Erfolgreich!';
              showToast('Gericht hinzugefÃ¼gt!');
              if(typeof updateHeaderBasket === 'function') updateHeaderBasket();
              setTimeout(() => {
                showCart();
                setTimeout(() => {
                  primaryCTA.disabled = false;
                  primaryCTA.classList.remove('success');
                  primaryCTAText.textContent = 'In die Mittagsbox legen';
                }, 500);
              }, 300);
            } else {
              primaryCTA.disabled = false;
              primaryCTA.classList.remove('loading');
              primaryCTAText.textContent = 'In die Mittagsbox legen';
              showToast('Fehler beim HinzufÃ¼gen. Bitte erneut versuchen.');
            }
          });
        };
      } else {
        // Info-Anbieter (ordering_enabled = false): Button "In die Mittagsbox legen" mit Disclaimer
        primaryCTAText.textContent = 'In die Mittagsbox legen';
        if(sInfoHint){
          sInfoHint.textContent = 'Anbieter nimmt nicht an Abholnummer teil';
          sInfoHint.style.display = 'block';
          sInfoHint.style.color = '#666';
        }
        
        primaryCTA.disabled = false;
        primaryCTA.className = 'btn-primary';
        primaryCTA.style.background = '#FFD700';
        primaryCTA.style.color = '#1a1a1a';
        primaryCTA.style.cursor = 'pointer';
        primaryCTA.onclick = () => {
          // Automatisch als Favorit speichern
          const favorites = JSON.parse(localStorage.getItem('mittagio_favorites') || '[]');
          const dishKey = o.id;
          if(!favorites.includes(dishKey)){
            favorites.push(dishKey);
            localStorage.setItem('mittagio_favorites', JSON.stringify(favorites));
            // Auch in dishFavs Set hinzufÃ¼gen
            if(!dishFavs.has(dishKey)){
              dishFavs.add(dishKey);
              save(LS.dishFavs, Array.from(dishFavs));
            }
            // Herz-Icon aktualisieren (rot leuchtend)
            const favBtn = document.getElementById('sFavoriteBtn');
            if(favBtn){
              const heartIcon = favBtn.querySelector('i[data-lucide="heart"]');
              if(heartIcon){
                heartIcon.style.fill = '#e74c3c';
                heartIcon.style.color = '#e74c3c';
              }
            }
          }
          
          // Request-Counter erhÃ¶hen (LocalStorage fÃ¼r Demo)
          const requestKey = `abholnummer_request_${o.providerId}_${isoDate(new Date())}`;
          const currentCount = parseInt(localStorage.getItem(`provider_${o.providerId}_requests`) || '0', 10);
          localStorage.setItem(`provider_${o.providerId}_requests`, String(currentCount + 1));
          localStorage.setItem(requestKey, 'true');
          
          // Haptics
          triggerHapticFeedback([10, 20]);
          
          // Success-Feedback
          primaryCTA.disabled = true;
          primaryCTA.classList.add('success');
          primaryCTAText.textContent = 'Vielen Dank! âœ“';
          showToast('Deine Anfrage wurde Ã¼bermittelt. Der Anbieter wird benachrichtigt.', 3000);
          
          // Reset nach 2 Sekunden
          setTimeout(() => {
            primaryCTA.disabled = false;
            primaryCTA.classList.remove('success');
            primaryCTAText.textContent = 'In die Mittagsbox legen';
          }, 2000);
        };
      }
    }
    
    // Herz-Icon Handler (Favorit)
    const sFavoriteBtn = document.getElementById('sFavoriteBtn');
    if(sFavoriteBtn){
      const favorites = JSON.parse(localStorage.getItem('mittagio_favorites') || '[]');
      const dishKey = o.id;
      const isFavorite = favorites.includes(dishKey);
      
      // Initial state: Herz gefÃ¼llt wenn Favorit (rot leuchtend)
      const heartIcon = sFavoriteBtn.querySelector('i[data-lucide="heart"]');
      if(heartIcon){
        if(isFavorite){
          heartIcon.style.fill = '#e74c3c';
          heartIcon.style.color = '#e74c3c';
        } else {
          heartIcon.style.fill = 'none';
          heartIcon.style.color = '#e74c3c';
        }
      }
      
      sFavoriteBtn.onclick = (e) => {
        e.stopPropagation();
        const favorites = JSON.parse(localStorage.getItem('mittagio_favorites') || '[]');
        const dishKey = o.id;
        const isFavorite = favorites.includes(dishKey);
        
        if(isFavorite){
          // Entfernen
          const index = favorites.indexOf(dishKey);
          favorites.splice(index, 1);
          localStorage.setItem('mittagio_favorites', JSON.stringify(favorites));
          dishFavs.delete(dishKey);
          save(LS.dishFavs, Array.from(dishFavs));
          if(heartIcon){
            heartIcon.style.fill = 'none';
          }
          showToast('Von Favoriten entfernt');
        } else {
          // HinzufÃ¼gen
          favorites.push(dishKey);
          localStorage.setItem('mittagio_favorites', JSON.stringify(favorites));
          dishFavs.add(dishKey);
          save(LS.dishFavs, Array.from(dishFavs));
          if(heartIcon){
            heartIcon.style.fill = '#e74c3c';
          }
          showToast('Zu Favoriten hinzugefÃ¼gt â¤ï¸');
        }
        if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
      };
    }
    
    // Share nur im Header (btnShareHeader) â€“ kein doppeltes Teilen-Icon mehr
    
    // Allergene-Overlay (ALLERGENE_OVERLAY_SPEC.md): Titel, Sticky-Disclaimer, standardisierte KÃ¼rzel-Liste
    window.showAllergensOverlay = function(){
      const o = normalizeOffer(offers.find(x => x.id === activeOfferId));
      if(!o || !o.allergens || o.allergens.length === 0) return;
      
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; display:flex; align-items:center; justify-content:center; padding:20px;';
      overlay.onclick = (e) => {
        if(e.target === overlay) {
          document.body.removeChild(overlay);
        }
      };
      
      const content = document.createElement('div');
      content.style.cssText = 'background:linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); border-radius:24px; padding:24px; max-width:420px; width:100%; border:2px solid rgba(255,255,255,0.1); box-shadow:0 8px 32px rgba(0,0,0,0.5); max-height:90vh; overflow:hidden; display:flex; flex-direction:column;';
      content.onclick = (e) => e.stopPropagation();
      
      const raw = o.allergens.map(a => String(a||'').trim());
      const codes = [];
      raw.forEach(v => {
        const u = v.toUpperCase();
        if(ALLERGENE_STANDARD[u]){ codes.push(u); return; }
        const nameKey = Object.keys(ALLERGENE_NAME_TO_CODE).find(k => k.toLowerCase() === v.toLowerCase());
        const c = nameKey ? ALLERGENE_NAME_TO_CODE[nameKey] : null;
        if(c && ALLERGENE_STANDARD[c]) codes.push(c);
      });
      const seen = {};
      const unique = codes.filter(c => { if(seen[c]) return false; seen[c]=1; return true; });
      
      const allergenList = unique.map(code => {
        const label = ALLERGENE_STANDARD[code];
        const firstWord = typeof allergenFirstWord === 'function' ? allergenFirstWord(label) : (label||'').trim().split(/\s+/)[0] || label;
        return `<div style="display:flex; align-items:center; gap:10px; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.1);">
          <i data-lucide="shield-alert" style="width:20px;height:20px;color:rgba(255,255,255,0.8);flex-shrink:0;"></i>
          <span style="color:rgba(255,255,255,0.9); font-weight:700; font-size:14px; flex-shrink:0;">${esc(code)}</span>
          <span style="color:rgba(255,255,255,0.85); font-size:14px;">${esc(firstWord)}</span>
        </div>`;
      }).join('');
      
      const disclaimer = 'FÃ¼r die Richtigkeit und AktualitÃ¤t der Angaben ist ausschlieÃŸlich der Anbieter verantwortlich. Bei schweren Allergien halten Sie bitte RÃ¼cksprache mit dem Personal vor Ort.';
      
      content.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; flex-shrink:0;">
          <h3 style="color:#fff; font-size:20px; font-weight:900; margin:0;">Allergene & Informationen</h3>
          <button type="button" onclick="this.closest('[style*=\\'position:fixed\\']').remove();" style="background:none; border:none; color:#fff; cursor:pointer; padding:4px; display:flex; align-items:center; justify-content:center;">
            <i data-lucide="x" style="width:20px;height:20px;"></i>
          </button>
        </div>
        <div style="padding:12px 14px; background:rgba(255,255,255,0.06); border-radius:12px; border:1px solid rgba(255,255,255,0.1); margin-bottom:16px; flex-shrink:0; font-size:12px; color:rgba(255,255,255,0.85); line-height:1.5;">
          ${esc(disclaimer)}
        </div>
        <div style="max-height:280px; overflow-y:auto; flex:1; min-height:0;">
          ${allergenList || '<p style="color:rgba(255,255,255,0.5); font-size:14px;">Keine passenden Allergene in der Standard-Liste.</p>'}
        </div>
      `;
      
      overlay.appendChild(content);
      document.body.appendChild(overlay);
      if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
    };
    
    // Route Button in Address Card (nur bei OHNE Abholnummer sichtbar)
    // offerProvider bereits oben deklariert
    if(btnOpenRoute){
      if(!o.hasPickupCode){
        btnOpenRoute.style.display = 'block';
        btnOpenRoute.onclick = () => {
          // Verwende bereits vorhandene addr-Variable fÃ¼r Maps-Link
          const routeMaps = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
          window.open(routeMaps, '_blank');
        };
      } else {
        btnOpenRoute.style.display = 'none';
      }
    }

    updateSheetFavs();

    document.getElementById('bd').classList.add('active');
    document.getElementById('sheet').classList.add('active');
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }

  function updateSheetFavs(){
    const providerBtn = document.getElementById('btnFav');
    const dishBtn = document.getElementById('btnDishFav');
    if(!activeOfferId){
      if(providerBtn) providerBtn.textContent='Anbieter speichern';
      if(dishBtn) dishBtn.textContent='Gericht speichern';
      return;
    }
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    const providerKey = o.providerId;
    const dishKey = o.id;
    if(providerBtn){
      const label = providerKey && providerFavs.has(providerKey) ? 'Anbieter entfernen' : 'Anbieter speichern';
      providerBtn.innerHTML = `${iconMarkup('heart')}<span>${esc(label)}</span>`;
    }
    if(dishBtn){
      const label = dishKey && dishFavs.has(dishKey) ? 'Von Speiseplan entfernen' : 'Auf meinen Speiseplan';
      dishBtn.innerHTML = `${iconMarkup('utensils')}<span>${esc(label)}</span>`;
    }
  }

  function closeSheet(){
    document.getElementById('bd').classList.remove('active');
    document.getElementById('sheet').classList.remove('active');
    
    // ZurÃ¼ck zur vorherigen Ansicht (inkl. Scroll-Position)
    if(navigationHistory.length > 0){
      const prev = navigationHistory.pop();
      locationQuery = prev.locationQuery || '';
      activeCat = prev.activeCat || null;
      activeDay = prev.activeDay || isoDate(new Date());
      activeDiscoverFilter = prev.activeFilter || 'near';
      
      if(prev.view === 'start'){
        showStart();
      } else {
        showDiscover();
      }
      
      // Scroll-Position wiederherstellen
      if(prev.scrollY !== undefined){
        setTimeout(()=>{
          window.scrollTo({top: prev.scrollY, behavior: 'auto'});
        }, 100);
      }
    }
  }
  
  // --- Match-Screen (nach Rechts-Swipe) ---
  let currentMatchOffer = null;
  
  function showMatchModal(offer){
    if(!offer) return;
    const matchBd = document.getElementById('matchBd');
    const matchSheet = document.getElementById('matchSheet');
    if(!matchBd || !matchSheet) return; // Match-Modal (Swipe) entfernt
    currentMatchOffer = offer;
    const data = normalizeOffer(offer);
    
    matchBd.classList.add('active');
    matchSheet.classList.add('active');
    
    // Daten fÃ¼llen
    const dishImageEl = document.getElementById('matchDishImage');
    const dishNameEl = document.getElementById('matchDishName');
    const providerNameEl = document.getElementById('matchProviderName');
    const distanceEl = document.getElementById('matchDistance');
    const fastWegEl = document.getElementById('matchFastWeg');
    
    if(dishImageEl){
      const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
      dishImageEl.innerHTML = `<img src="${esc(imgSrc)}" alt="${esc(data.dish||'')}" style="width:100%; height:100%; object-fit:cover;" />`;
    }
    if(dishNameEl) dishNameEl.textContent = data.dish || 'Gericht';
    if(providerNameEl) providerNameEl.textContent = data.providerName || 'Anbieter';
    if(distanceEl){
      const distance = data.distanceKm != null ? `${Math.round(data.distanceKm * 1000)}m` : '';
      distanceEl.textContent = distance ? `Nur ${distance} von dir entfernt` : 'In deiner NÃ¤he';
    }
    
    // Fast weg Badge (wenn ausverkauft oder fast ausverkauft)
    if(fastWegEl){
      // No-Limits: Keine "Fast weg" Logik mehr - Status wird Ã¼ber active gesteuert
      fastWegEl.style.display = 'none';
    }
    
    // Konfetti-Animation
    triggerMatchConfetti();
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(() => lucide.createIcons(), 50);
    }
  }
  
  function closeMatchModal(){
    const matchBd = document.getElementById('matchBd');
    const matchSheet = document.getElementById('matchSheet');
    if(matchBd) matchBd.classList.remove('active');
    if(matchSheet) matchSheet.classList.remove('active');
    currentMatchOffer = null;
  }
  
  function triggerMatchConfetti(){
    const canvas = document.getElementById('matchConfetti');
    if(!canvas) return;
    
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    
    const particles = [];
    const colors = ['#FFD700', '#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1'];
    
    for(let i = 0; i < 50; i++){
      particles.push({
        x: canvas.width / 2,
        y: canvas.height / 2,
        vx: (Math.random() - 0.5) * 10,
        vy: (Math.random() - 0.5) * 10 - 5,
        color: colors[Math.floor(Math.random() * colors.length)],
        size: Math.random() * 6 + 4,
        life: 1
      });
    }
    
    function animate(){
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      particles.forEach((p, i) => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.2; // Gravity
        p.life -= 0.02;
        
        if(p.life > 0){
          ctx.globalAlpha = p.life;
          ctx.fillStyle = p.color;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
          ctx.fill();
        } else {
          particles.splice(i, 1);
        }
      });
      
      if(particles.length > 0){
        requestAnimationFrame(animate);
      }
    }
    animate();
  }
  
  // Match Modal Handlers
  const btnMatchReserve = document.getElementById('btnMatchReserve');
  if(btnMatchReserve){
    btnMatchReserve.onclick = () => {
      if(currentMatchOffer){
        closeMatchModal();
        // Direkt zum Checkout
        const data = normalizeOffer(currentMatchOffer);
        if(data.hasPickupCode){
          handleOrderClick(currentMatchOffer);
        } else {
          openOffer(currentMatchOffer.id);
        }
      }
    };
  }
  
  const btnMatchLater = document.getElementById('btnMatchLater');
  if(btnMatchLater){
    btnMatchLater.onclick = () => {
      if(currentMatchOffer){
        // Zu Favoriten hinzufÃ¼gen
        toggleDishFav(currentMatchOffer.id);
        closeMatchModal();
        showToast('Gericht zu Favoriten hinzugefÃ¼gt');
      }
    };
  }
  
  // Backdrop Handler
  const matchBd = document.getElementById('matchBd');
  if(matchBd){
    matchBd.onclick = () => {
      closeMatchModal();
    };
  }
  
  // Android Hardware-Back unterstÃ¼tzen
  window.addEventListener('popstate', function(e){
    // AGB Onboarding Modal schlieÃŸen
    if(document.getElementById('agbOnboardingSheet') && document.getElementById('agbOnboardingSheet').classList.contains('active')){
      closeAgbOnboardingModal();
      e.preventDefault();
      return;
    }
    // Pickup Confirmation Sheet schlieÃŸen
    if(document.getElementById('pickupConfirmSheet') && document.getElementById('pickupConfirmSheet').classList.contains('active')){
      closePickupConfirmSheet();
      e.preventDefault();
      pushViewState(null, location.pathname);
      return;
    }
    // Create Flow Sheet schlieÃŸen
    if(document.getElementById('createFlowSheet') && document.getElementById('createFlowSheet').classList.contains('active')){
      closeCreateFlowSheet();
      e.preventDefault();
      pushViewState(null, location.pathname);
      return;
    }
    // FAQ Sheet schlieÃŸen
    if(document.getElementById('faqSheet') && document.getElementById('faqSheet').classList.contains('active')){
      closeFaqSheet();
      e.preventDefault();
      pushViewState(null, location.pathname);
      return;
    }
    // Login Modal schlieÃŸen
    if(document.getElementById('loginSheet') && document.getElementById('loginSheet').classList.contains('active')){
      closeLoginSheet();
      e.preventDefault();
      pushViewState(null, location.pathname);
      return;
    }
    // Provider Login Modal schlieÃŸen
    if(document.getElementById('providerLoginSheet') && document.getElementById('providerLoginSheet').style.display !== 'none'){
      closeProviderLoginModal();
      e.preventDefault();
      pushViewState(null, location.pathname);
      return;
    }
    // Wizard schlieÃŸen
    if(document.getElementById('wizard') && document.getElementById('wizard').classList.contains('active')){
      closeWizard();
      e.preventDefault();
      pushViewState(null, location.pathname);
      return;
    }
    // Sheet schlieÃŸen
    if(document.getElementById('sheet') && document.getElementById('sheet').classList.contains('active')){
      closeSheet();
      e.preventDefault();
      pushViewState(null, location.pathname);
      return;
    }
    // Onboarding back navigation
    const currentView = document.querySelector('.view.active');
    if(currentView && currentView.id.startsWith('v-provider-onboarding')){
      if(currentView.id === 'v-provider-onboarding-preview'){
        showOnboardingBusiness();
        e.preventDefault();
        pushViewState(null, location.pathname);
        return;
      } else if(currentView.id === 'v-provider-onboarding-business'){
        showOnboardingSignup();
        e.preventDefault();
        pushViewState(null, location.pathname);
        return;
      } else if(currentView.id === 'v-provider-onboarding-signup'){
        showOnboardingFirstDish(!!onboardingDraftDish);
        e.preventDefault();
        pushViewState(null, location.pathname);
        return;
      } else if(currentView.id === 'v-provider-onboarding-first-dish'){
        showOnboardingEntry(!!onboardingDraftDish);
        e.preventDefault();
        pushViewState(null, location.pathname);
        return;
      } else if(currentView.id === 'v-provider-onboarding-entry'){
        // Animation fÃ¼r 3-Punkt-ErklÃ¤rung
        setTimeout(() => {
          const points = document.querySelectorAll('#onboardingExplanationPoints .onboarding-point');
          points.forEach((point, index) => {
            setTimeout(() => {
              point.style.opacity = '1';
              point.style.transform = 'translateY(0)';
            }, index * 200);
          });
          // Icons aktualisieren
          if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 100);
        }, 100);
        // Exit onboarding, go to login or customer mode
        if(provider.loggedIn){
          showProviderHome();
        } else {
          setMode('customer');
          showProfile();
        }
        e.preventDefault();
        pushViewState(null, location.pathname);
        return;
      }
    }
    
    // In-App Navigation: ZurÃ¼ck zu vorheriger View innerhalb der App
    // PrÃ¼fe ob wir in einer Customer-View sind
    if(currentView){
      const viewId = currentView.id;
      if(viewId === 'v-fav'){
        showDiscover();
        e.preventDefault();
        return;
      } else if(viewId === 'v-cart'){
        showDiscover();
        e.preventDefault();
        return;
      } else if(viewId === 'v-orders'){
        showProfile();
        e.preventDefault();
        return;
      } else if(viewId === 'v-profile'){
        showDiscover();
        e.preventDefault();
        return;
      } else if(viewId === 'v-discover'){
        showStart();
        e.preventDefault();
        return;
      } else if(viewId === 'v-start'){
        // Bleib auf Start oder gehe zu Discover
        showStart();
        e.preventDefault();
        return;
      }
    }
    
    // Provider Views
    if(mode === 'provider'){
      const providerView = currentView ? currentView.id : '';
      if(providerView === 'v-provider-profile'){
        showProviderHome();
        e.preventDefault();
        return;
      } else if(providerView === 'v-provider-pickups'){
        showProviderHome();
        e.preventDefault();
        return;
      } else if(providerView === 'v-provider-cookbook'){
        showProviderHome();
        e.preventDefault();
        return;
      } else if(providerView === 'v-provider-billing'){
        showProviderProfile();
        e.preventDefault();
        return;
      }
    }
  });

  function openProviderOffer(id){
    const raw = offers.find(x=>x.id===id);
    if(!raw) return;
    const o = normalizeOffer(raw);
    activeProviderOfferId = id;
    const profile = normalizeProviderProfile(provider.profile || {});
    const offerProvider = offers.find(p => p.providerId === o.providerId);
    const orderingEnabled = offerProvider && (offerProvider.orderingEnabled !== false && (o.hasPickupCode || offerProvider.hasPickupCode));
    const hasReuse = offerProvider && (offerProvider.reuseEnabled || offerProvider.reuse || (offerProvider.providerProfile && offerProvider.providerProfile.reuseEnabled));
    const windowText = o.pickupWindow || profile.mealWindow || '11:30 â€“ 14:00';
    const timeMatch = windowText.match(/(\d{1,2}:\d{2})\s*[â€“-]\s*(\d{1,2}:\d{2})/);
    const timePillText = timeMatch && timeMatch[1] && timeMatch[2] ? `Abholung heute Mittag von ${timeMatch[1]} â€“ ${timeMatch[2]} Uhr` : `Abholung heute Mittag ${windowText} Uhr`;
    const imgSrc = o.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    const pillars = [];
    pillars.push('<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(0,0,0,0.06);border-radius:12px;"><span style="font-size:20px;">ðŸ´</span><span style="font-size:13px;font-weight:700;color:#1a1a1a;">Vor Ort</span></div>');
    if(hasReuse) pillars.push('<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(39,174,96,0.12);border-radius:12px;"><span style="font-size:20px;">ðŸ”„</span><span style="font-size:13px;font-weight:700;color:#1a1a1a;">Mehrweg</span></div>');
    if(orderingEnabled) pillars.push('<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(255,215,0,0.2);border-radius:12px;"><span style="font-size:20px;">ðŸ§¾</span><span style="font-size:13px;font-weight:700;color:#1a1a1a;">Abholnummer</span></div>');
    const catLabel = (o.category && CAT_EMOJI[o.category]) ? (CAT_EMOJI[o.category] + ' ' + (o.category || '')) : (o.category || '');
    const allergenStr = (o.allergens && o.allergens.length) ? (Array.isArray(o.allergens) ? o.allergens.slice(0,5).join(', ') : String(o.allergens)) : '';

    const preview = document.getElementById('pPreview');
    preview.innerHTML = `
      <div style="width:100%; background:#fff; border-radius:16px; overflow:hidden; border:1px solid rgba(0,0,0,0.06);">
        <div style="position:relative; width:100%; aspect-ratio:16/10; max-height:200px; overflow:hidden; background:#f0f0f0;"><img src="${esc(imgSrc)}" alt="${esc(o.dish||'')}" style="width:100%; height:100%; object-fit:cover;" /></div>
        <div style="display:flex; align-items:center; gap:10px; padding:12px 16px; border-bottom:1px solid rgba(0,0,0,0.06); flex-wrap:wrap;">${pillars.join('')}</div>
        <div style="display:flex; justify-content:center; padding:10px 16px; background:rgba(0,0,0,0.04); border-bottom:1px solid rgba(0,0,0,0.06);"><span style="font-size:13px; font-weight:600; color:#333;">${esc(timePillText)}</span></div>
        <div style="padding:16px;">
          <div style="font-weight:900; font-size:18px; color:#1a1a1a; margin-bottom:8px;">${esc(o.dish || 'Gericht')}</div>
          ${catLabel ? `<span style="display:inline-block; padding:4px 10px; border-radius:8px; background:#e2e8f0; font-size:12px; font-weight:600; color:#475569; margin-bottom:8px;">${esc(catLabel)}</span>` : ''}
          ${allergenStr ? `<div style="font-size:12px; color:#64748b; margin-bottom:8px;">${esc(allergenStr)}</div>` : ''}
          <div style="font-size:18px; font-weight:800; color:var(--brand);">${euro(o.price || 0)}</div>
        </div>
      </div>
    `;

    document.getElementById('pStatus').textContent = o.active===false ? 'Ausverkauft' : 'Noch da';
    document.getElementById('pWindow').textContent = o.pickupWindow || profile.mealWindow || '-';
    
    // No-Limits: Prominenter "Ausverkauft" / "Noch da" Toggle
    const toggleBtn = document.getElementById('btnToggleOffer');
    if(toggleBtn){
      if(o.active === false){
        toggleBtn.textContent = 'Wieder verfÃ¼gbar';
        toggleBtn.style.background = '#4caf50';
        toggleBtn.style.color = '#fff';
      } else {
        toggleBtn.textContent = 'Ausverkauft';
        toggleBtn.style.background = '#E34D4D';
        toggleBtn.style.color = '#fff';
      }
    }

    document.getElementById('pbd').classList.add('active');
    document.getElementById('psheet').classList.add('active');
  }

  function closeProviderSheet(){
    document.getElementById('pbd').classList.remove('active');
    document.getElementById('psheet').classList.remove('active');
  }

  function buildShareText(o){
    const dish = o.dish || o.title || 'Gericht';
    const profile = normalizeProviderProfile(provider.profile || {});
    const providerName = o.providerName || profile.name || 'Anbieter';
    const pickup = o.pickupWindow || profile.mealWindow || 'â€”';
    return `${providerName}\nHeute zu Mittag: ${dish}\n${euro(o.price)}\n${pickup}\nPowered by Mittagio`;
  }

  function setPrintView(html){
    const pv = document.getElementById('printView');
    if(!pv) return;
    pv.innerHTML = html;
  }
  function clearPrintView(){
    const pv = document.getElementById('printView');
    if(!pv) return;
    pv.innerHTML = '';
  }
  window.addEventListener('afterprint', clearPrintView);

  function printHtml(html){
    setPrintView(html);
    window.print();
    setTimeout(clearPrintView, 300);
  }

  function buildOfferPrintHtml(o){
    const data = normalizeOffer(o);
    const profile = normalizeProviderProfile(provider.profile || {});
    const name = data.providerName || profile.name || 'Anbieter';
    const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity}) || buildAddress(profile);
    const badges = [];
    const offerProvider = offers.find(p => p.providerId === data.providerId);
    const orderingEnabled = offerProvider && (offerProvider.orderingEnabled !== false && (data.hasPickupCode || offerProvider.hasPickupCode));
    if(orderingEnabled) badges.push('Abholnummer');
    return `
      <div class="print-card">
        <div style="display:flex;align-items:center;gap:12px;">
          ${profile.logoData ? `<img src="${profile.logoData}" alt="Logo" style="width:56px;height:56px;border-radius:12px;object-fit:cover" />` : ''}
          <div>
            <h1>${esc(name)}</h1>
            <div class="print-muted">${esc(addr || '')}</div>
          </div>
        </div>
        <h2>${esc(data.dish || 'Gericht')}</h2>
        <div class="print-row">
          <div><b>Preis:</b> ${euro(data.price || 0)}</div>
          <div><b>Essenszeit:</b> ${esc(data.pickupWindow || profile.mealWindow || '')}</div>
        </div>
        <div style="margin-top:8px;">
          ${badges.map(b=>`<span class="print-badge">${esc(b)}</span>`).join(' ')}
        </div>
      </div>
    `;
  }

  function buildWeekCardHtml(){
    const profile = normalizeProviderProfile(provider.profile || {});
    const days = [];
    for(let i=0;i<5;i++){
      const d = new Date(); d.setDate(d.getDate()+i);
      days.push(isoDate(d));
    }
    const dayBlocks = days.map(key=>{
      const items = (week[key]||[])
        .filter(x=>x.providerId===providerId() && x.active !== false)
        .map(entry=>{
          const cb = cookbook.find(c=>c.id===entry.cookbookId);
          const name = cb?.dish || entry.dish || 'Gericht';
          const price = cb?.price || 0;
          const windowText = cb?.pickupWindow || profile.mealWindow || '';
          return `
            <div class="print-row">
              <div>
                <div>${esc(name)}</div>
                <div class="print-muted">${esc(windowText)}</div>
              </div>
              <div>${euro(price)}</div>
            </div>
          `;
        });
      const label = key ? fmtDay(new Date(key)) : key;
      return `
        <div class="print-card">
          <h2>${esc(label)}</h2>
          ${items.length ? items.join('') : '<div class="print-muted">Keine Gerichte geplant.</div>'}
        </div>
      `;
    }).join('');

    return `
      <div class="print-card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <div>
            <h1>${esc(profile.name || 'Anbieter')}</h1>
            <div class="print-muted">${esc(buildAddress(profile) || '')}</div>
            <div class="print-muted">Essenszeit: ${esc(profile.mealWindow || '')}</div>
            <div class="print-muted" style="margin-top:6px;"><b>Unsere Gerichte â€“ nÃ¤chste Tage</b></div>
          </div>
          ${profile.logoData ? `<img src="${profile.logoData}" alt="Logo" style="width:72px;height:72px;border-radius:14px;object-fit:cover" />` : ''}
        </div>
      </div>
      <div class="print-grid">
        ${dayBlocks}
      </div>
      <div class="print-card" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div>
          <div style="font-weight:900">Mittagio</div>
          <div class="print-muted">Dein Mittag. Lokal. Frisch. Digital.</div>
        </div>
        <div style="text-align:center;">
          <div class="pickup-code-display">Abholnummer</div>
          <div class="print-muted">Ein Tap genÃ¼gt</div>
        </div>
      </div>
    `;
  }

  function printOffer(o){
    if(!o) return;
    printHtml(buildOfferPrintHtml(o));
  }

  function printCookbookEntry(entry){
    if(!entry) return;
    const profile = normalizeProviderProfile(provider.profile || {});
    const offer = normalizeOffer({
      dish: entry.dish,
      category: entry.category,
      price: entry.price,
      pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
      providerName: profile.name || provider.email || 'Anbieter',
      providerStreet: profile.street||'',
      providerZip: profile.zip||'',
      providerCity: profile.city||'',
      providerLogoData: profile.logoData||'',
      hasPickupCode: !!entry.hasPickupCode,
      dineInPossible: !!entry.dineInPossible,
      allergens: entry.allergens||[],
      extras: entry.extras||[],
      reuse: entry.reuse||{enabled:false,deposit:0}
    });
    printHtml(buildOfferPrintHtml(offer));
  }

  function printWeekCard(){
    printHtml(buildWeekCardHtml());
  }

  // Share Payload fÃ¼r Offer Details
  let sharePayload = { subject: '', body: '', url: '' };
  
  function openShareSheet(subject, body, url=location.href, subtitle=''){
    sharePayload = { subject, body, url };
    
    // Dynamischen Untertitel setzen
    const subtitleEl = document.getElementById('shareSheetSubtitle');
    if(subtitleEl){
      subtitleEl.textContent = subtitle || 'Empfiehl dieses Mittagsangebot weiter';
    }
    
    document.getElementById('shareBd').classList.add('active');
    document.getElementById('shareSheet').classList.add('active');
  }

  function closeShareSheet(){
    document.getElementById('shareBd').classList.remove('active');
    document.getElementById('shareSheet').classList.remove('active');
  }
  
  // Create Flow Sheet
  function openCreateFlowSheet(){
    const sheet = document.getElementById('createFlowSheet');
    const hint = document.getElementById('createFlowDateHint');
    if(sheet && hint){
      if(createFlowPreselectedDate){
        const d = new Date(createFlowPreselectedDate);
        const weekday = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'][d.getDay()];
        const dateStr = `${d.getDate()}.${String(d.getMonth()+1).padStart(2,'0')}.`;
        hint.textContent = `FÃ¼r: ${weekday}, ${dateStr}`;
        hint.style.display = 'block';
      } else {
        hint.style.display = 'none';
      }
      document.getElementById('createFlowBd').classList.add('active');
      sheet.classList.add('active');
    }
  }
  
  function closeCreateFlowSheet(){
    document.getElementById('createFlowBd').classList.remove('active');
    document.getElementById('createFlowSheet').classList.remove('active');
    createFlowPreselectedDate = null;
  }
  
  // Create Flow Handlers - Beide Ã¶ffnen Master-Flow
  const btnCreateFromCookbook = document.getElementById('btnCreateFromCookbook');
  if(btnCreateFromCookbook){
    btnCreateFromCookbook.onclick = () => {
      closeCreateFlowSheet();
      // Navigate to cookbook - user selects entry there, then "Inserieren" opens Master-Flow
      showProviderCookbook();
    };
  }
  
  const btnCreateNewDish = document.getElementById('btnCreateNewDish');
  if(btnCreateNewDish){
    btnCreateNewDish.onclick = () => {
      closeCreateFlowSheet();
      // Unified Flow: openDishFlow mit Datum
      openDishFlow(createFlowPreselectedDate);
    };
  }
  
  // Offer More Menu
  function openOfferMoreMenu(offerId){
    const offer = offers.find(o => o.id === offerId);
    if(!offer) return;
    
    const actions = [
      {label: 'Bearbeiten', action: () => {
        closeCreateFlowSheet(); // Falls offen
        startListingFlow({editOfferId: offerId});
      }},
      {label: 'Duplizieren', action: () => {
        const newOffer = {...offer, id: cryptoId(), createdAt: Date.now()};
        offers.unshift(newOffer);
        save(LS.offers, offers);
        renderProviderHome();
        renderDiscover();
        showToast('Inserat dupliziert');
      }},
      {label: 'Pausieren', action: () => {
        offer.active = false;
        save(LS.offers, offers);
        renderProviderHome();
        renderDiscover();
        showToast('Inserat pausiert');
      }},
      {label: 'LÃ¶schen', action: () => {
        if(confirm('Inserat wirklich lÃ¶schen?')){
          const idx = offers.findIndex(o => o.id === offerId);
          if(idx >= 0){
            offers.splice(idx, 1);
            save(LS.offers, offers);
            renderProviderHome();
            renderDiscover();
            showToast('Inserat gelÃ¶scht');
          }
        }
      }}
    ];
    
    // Simple prompt-based menu (spÃ¤ter kann ein Sheet verwendet werden)
    const choice = prompt(`Aktion fÃ¼r "${offer.dish || offer.title}":\n1. Bearbeiten\n2. Duplizieren\n3. Pausieren\n4. LÃ¶schen\n\nNummer eingeben:`);
    const idx = parseInt(choice) - 1;
    if(idx >= 0 && idx < actions.length){
      actions[idx].action();
    }
  }
  
  // Toast helper
  function showToast(message){
    // Simple snackbar-style toast
    let toast = document.getElementById('toast');
    if(!toast){
      toast = document.createElement('div');
      toast.id = 'toast';
      toast.style.cssText = 'position:fixed; bottom:90px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.85); color:#fff; padding:12px 20px; border-radius:12px; font-size:14px; z-index:100; opacity:0; transition:opacity .3s; pointer-events:none;';
      document.body.appendChild(toast);
    }
    toast.textContent = message;
    toast.style.opacity = '1';
    setTimeout(() => {
      toast.style.opacity = '0';
    }, 3000);
  }

  async function copyShareLink(){
    const url = sharePayload.url || location.href;
    if(navigator.clipboard && navigator.clipboard.writeText){
      try{ 
        await navigator.clipboard.writeText(url);
        alert('Link kopiert!');
        return true;
      }catch{}
    }
    prompt('Link kopieren:', url);
    return false;
  }
  
  function shareViaWhatsApp(subject, body, url){
    const text = `${subject}\n\n${body}\n\nðŸ‘‰ Jetzt anschauen:\n${url}`;
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
    window.open(whatsappUrl, '_blank');
  }
  
  function shareViaInstagram(subject, body, url){
    // Instagram unterstÃ¼tzt keine direkten Share-Links, daher Link kopieren + Hinweis
    const text = `${subject}\n\n${body}\n\nðŸ‘‰ Jetzt anschauen:\n${url}`;
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).then(() => {
        showToast('Text kopiert! FÃ¼ge ihn in deinen Instagram-Post ein.');
      }).catch(() => {
        prompt('Text fÃ¼r Instagram kopieren:', text);
      });
    } else {
      prompt('Text fÃ¼r Instagram kopieren:', text);
    }
  }

  function shareOffer(o, useWebShare = true){
    if(!o) return;
    const data = normalizeOffer(o);
    // Share-Link Format: https://mittagio.de/share/[Gericht-ID]
    const shareUrl = `https://mittagio.de/share/${o.id}`;
    // Fallback-URL fÃ¼r direkten Zugriff in der App
    const appUrl = `${location.origin}${location.pathname}#offer/${o.id}`;
    
    const providerName = data.providerName || 'Anbieter';
    const dishName = data.dish || 'Gericht';
    const price = euro(data.price);
    
    // Titel fÃ¼r Open Graph / Share-Vorschau
    const shareTitle = `Schau mal, was es heute bei ${providerName} gibt!`;
    // Beschreibung fÃ¼r Open Graph / Share-Vorschau
    const shareDescription = `${dishName} fÃ¼r nur ${price} â‚¬. Hol es dir mit deiner Abholnummer Ã¼ber die Mittagio App.`;
    // VollstÃ¤ndiger Share-Text fÃ¼r WhatsApp & Co.
    const shareText = `${shareTitle}\n\n${shareDescription}\n\n${shareUrl}`;
    
    // Web Share API (wenn verfÃ¼gbar)
    if(navigator.share && useWebShare){
      navigator.share({
        title: shareTitle,
        text: shareDescription,
        url: shareUrl
      }).then(() => {
        showToast('Geteilt!');
      }).catch((err) => {
        // Fallback: Link kopieren
        if(err.name !== 'AbortError'){
          copyToClipboard(shareText);
          showToast('Link kopiert!');
        }
      });
      return;
    }
    
    // Fallback: Link kopieren + Toast
    copyToClipboard(shareText);
    showToast('Link kopiert!');
  }
  
  // Helper: Link in Zwischenablage kopieren
  function copyToClipboard(text){
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).catch(() => {
        // Fallback fÃ¼r Ã¤ltere Browser
        fallbackCopyToClipboard(text);
      });
    } else {
      fallbackCopyToClipboard(text);
    }
  }
  
  function fallbackCopyToClipboard(text){
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
      document.execCommand('copy');
    } catch(err) {
      console.error('Fallback copy failed:', err);
    }
    document.body.removeChild(textArea);
  }
  
  // Web Share API fÃ¼r Kunden (BestÃ¤tigungsseite)
  function shareOrderConfirmation(order){
    if(!order) return;
    const dishName = order.dishName || 'Gericht';
    const providerName = order.providerName || 'Anbieter';
    
    if(navigator.share){
      navigator.share({
        title: 'Mein Mittagessen heute!',
        text: `Schlange stehen gespart! Hab mir gerade ${dishName} bei ${providerName} gesichert. ðŸ–ðŸ“± #mittagio`,
        url: location.href
      }).then(() => {
        showToast('Geteilt!');
      }).catch((err) => {
        console.log('Share failed:', err);
      });
    } else {
      // Fallback: Link kopieren
      const text = `Schlange stehen gespart! Hab mir gerade ${dishName} bei ${providerName} gesichert. ðŸ–ðŸ“± #mittagio ${location.href}`;
      navigator.clipboard.writeText(text).then(() => {
        showToast('Link kopiert!');
      });
    }
  }
  
  // Web Share API fÃ¼r Anbieter (Heute teilen)
  function shareProviderOffer(offer){
    if(!offer) return;
    const data = normalizeOffer(offer);
    const dishName = data.dish || 'Gericht';
    const price = euro(data.price || 0);
    
    if(navigator.share){
      navigator.share({
        title: `${dishName} - ${price}`,
        text: `Heute bei mir: ${dishName} fÃ¼r ${price}. Nur online vorbestellbar auf Mittagio.de`,
        url: `${location.origin}${location.pathname}#offer/${offer.id}`
      }).then(() => {
        showToast('Geteilt!');
      }).catch((err) => {
        console.log('Share failed:', err);
      });
    } else {
      // Fallback: Share Sheet
      shareOffer(offer);
    }
  }

  function addToCart(o){
    if(!o || !o.hasPickupCode){
      alert('Ohne Abholnummer nur ansehen.');
      return false;
    }
    // Multi-Vendor erlaubt (keine Warnung mehr, nur Info im Korb)
    if(!cart){ cart = { providerId:o.providerId, providerName:o.providerName, items:[], pickupTime:'' }; }
    const idx = cart.items.findIndex(i=>i.offerId===o.id);
    if(idx>=0) cart.items[idx].qty += 1; else cart.items.push({offerId:o.id, qty:1});
    save(LS.cart, cart);
    updateHeaderBasket();
    return true;
  }

  function handleOrderClick(o){
    // KEIN Login-Zwang: Gast kann direkt bestellen
    if(addToCart(o)){
      showCart();
    } else {
      openOffer(o.id);
    }
  }

  const btnFav = document.getElementById('btnFav');
  if(btnFav) btnFav.onclick=()=>{
    if(!activeOfferId) return;
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    toggleProviderFav(o.providerId);
  };
  const btnDishFav = document.getElementById('btnDishFav');
  if(btnDishFav) btnDishFav.onclick=()=>{
    if(!activeOfferId) return;
    toggleDishFav(activeOfferId);
  };
  // Share Button im Header (Offer Detail Page)
  const btnShareHeader = document.getElementById('btnShareHeader');
  if(btnShareHeader) btnShareHeader.onclick=()=>{
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    shareOffer(o);
  };
  
  const btnShare = document.getElementById('btnShare');
  if(btnShare) btnShare.onclick=()=>{
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    shareOffer(o);
  };
  
  // Share Sheet Actions
  const btnShareWhatsApp = document.getElementById('btnShareWhatsApp');
  if(btnShareWhatsApp) btnShareWhatsApp.onclick=()=>{
    shareViaWhatsApp(sharePayload.subject, sharePayload.body, sharePayload.url);
    closeShareSheet();
  };
  
  const btnShareInstagram = document.getElementById('btnShareInstagram');
  if(btnShareInstagram) btnShareInstagram.onclick=()=>{
    shareViaInstagram(sharePayload.subject, sharePayload.body, sharePayload.url);
    closeShareSheet();
  };
  
  const btnShareCopy = document.getElementById('btnShareCopy');
  if(btnShareCopy) btnShareCopy.onclick=()=>{
    copyShareLink();
    closeShareSheet();
  };
  
  const btnCodeClose = document.getElementById('btnCodeClose');
  if(btnCodeClose) btnCodeClose.onclick=()=> closeCodeSheet();
  const btnToggleOrderStatus = document.getElementById('btnToggleOrderStatus');
  if(btnToggleOrderStatus) btnToggleOrderStatus.onclick=()=>{
    if(!activeOrderId) return;
    const order = getOrderById(activeOrderId);
    if(order){
      const newStatus = order.status === 'PICKED_UP' || order.status === 'abgeholt' ? 'PAID' : 'PICKED_UP';
      updateOrder(activeOrderId, { status: newStatus, pickupCodeActivatedAt: newStatus === 'PICKED_UP' ? Date.now() : null });
      openCodeSheetWithOrder(getOrderById(activeOrderId));
      if(typeof updateProfileView === 'function') updateProfileView();
    } else if(typeof orders !== 'undefined' && orders){
      const idx = orders.findIndex(o=>o.id===activeOrderId);
      if(idx>=0){
        orders[idx].status = orders[idx].status === 'abgeholt' ? 'offen' : 'abgeholt';
        if(typeof save === 'function') save(LS.orders, orders);
        if(typeof renderOrders === 'function') renderOrders();
        openCodeSheet(activeOrderId);
      }
    }
  };
  
  // --- Login Modal ---
  function openLoginSheet(){
    document.getElementById('loginBd').classList.add('active');
    document.getElementById('loginSheet').classList.add('active');
    // Focus auf E-Mail-Input
    setTimeout(()=>{
      const emailInput = document.getElementById('loginModalEmail');
      if(emailInput) emailInput.focus();
    }, 300);
  }
  
  function closeLoginSheet(){
    document.getElementById('loginBd').classList.remove('active');
    document.getElementById('loginSheet').classList.remove('active');
  }
  
  // Login Modal Backdrop Handler
  const loginBd = document.getElementById('loginBd');
  if(loginBd){
    loginBd.onclick = () => {
      closeLoginSheet();
    };
  }
  
  // Login Modal Handler
  const btnLoginModalLogin = document.getElementById('btnLoginModalLogin');
  if(btnLoginModalLogin){
    btnLoginModalLogin.onclick=()=>{
      const email = document.getElementById('loginModalEmail').value.trim();
      const pass = document.getElementById('loginModalPass').value.trim();
      if(!email || !pass){
        alert('Bitte E-Mail und Passwort eingeben.');
        return;
      }
      customer.loggedIn = true;
      customer.name = customer.name || email.split('@')[0];
      customer.email = email;
      save(LS.customer, customer);
      updateProfileView();
      closeLoginSheet();
      // Nach Login zur Discover-Seite
      setMode('customer');
      showDiscover();
    };
  }
  
  const btnLoginModalDemo = document.getElementById('btnLoginModalDemo');
  if(btnLoginModalDemo){
    btnLoginModalDemo.onclick=()=>{
      customer.loggedIn = true;
      customer.name = customer.name || 'Mike';
      save(LS.customer, customer);
      updateProfileView();
      closeLoginSheet();
      // Nach Demo-Login zur Discover-Seite
      setMode('customer');
      showDiscover();
    };
  }

  applyStaticIcons();
  const locBtn = document.getElementById('btnLocationPin');
  if(locBtn){
    locBtn.innerHTML = iconMarkup('location');
    locBtn.onclick=()=>{
      alert('Standort gesetzt. Du kannst jederzeit wechseln.');
    };
  }
  const startLocBtn = document.getElementById('btnStartLocationPin');
  if(startLocBtn){
    startLocBtn.innerHTML = iconMarkup('location');
    startLocBtn.onclick=()=>{
      alert('Standort gesetzt. Du kannst jederzeit wechseln.');
    };
  }
  const startNearBtn = document.getElementById('btnStartNear');
  if(startNearBtn){
    startNearBtn.onclick=()=>{
      alert('Zeige Angebote in deiner NÃ¤he.');
      renderStart();
    };
  }

  const btnAddCart = document.getElementById('btnAddCart');
  if(btnAddCart){
    btnAddCart.onclick=()=>{
      const o = offers.find(x=>x.id===activeOfferId);
      if(!o) return;
      if(!addToCart(o)) return;
      closeSheet();
      showCart();
    };
  }

  // Header-Basket aktualisieren (Badge mit Anzahl)
  function updateHeaderBasket(){
    const bottomNavBasketBadge = document.getElementById('bottomNavBasketBadge');
    if(!bottomNavBasketBadge) return;
    
    const raw = load(LS.cart, []);
    const cart = (raw != null && raw !== undefined) ? raw : [];
    const itemCount = (cart && cart.items && Array.isArray(cart.items))
      ? cart.items.reduce((sum, it) => sum + (it && it.qty != null ? it.qty : 0), 0)
      : (Array.isArray(cart) ? cart.length : 0);
    
    if(itemCount > 0){
      bottomNavBasketBadge.textContent = itemCount > 99 ? '99+' : itemCount;
      bottomNavBasketBadge.style.display = 'flex';
    } else {
      bottomNavBasketBadge.style.display = 'none';
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }
  
  // --- Cart ---
  function renderCart(){
    const box=document.getElementById('cartBox');
    const btn=document.getElementById('btnCheckout');
    const note=document.getElementById('cartNote');
    
    // Button-Click-Handler: Daten an nÃ¤chsten Prozessschritt Ã¼bergeben
    // Wird in renderCart() gesetzt, um sicherzustellen, dass die aktuellen Cart-Daten verwendet werden
    if(btn){
      btn.onclick = () => {
        // Gesammelte Daten: Verzehrmodus (ðŸ´/ðŸ”„), gewÃ¤hlte Zeit und Preis
        if(!cart || !cart.items || cart.items.length === 0){
          showToast('Deine Mittagsbox ist leer', 2000);
          return;
        }
        
        // Validierung: Verzehrmodus muss gesetzt sein
        if(!cart.verzehrmodus){
          cart.verzehrmodus = 'mitnehmen'; // Standard
          save(LS.cart, cart);
        }
        
        // Validierung: Abholzeit sollte gesetzt sein
        if(!cart.pickupTime){
          showToast('Bitte wÃ¤hle eine Abholzeit', 2000);
          return;
        }
        
        // Daten an Checkout Ã¼bergeben (Verzehrmodus, pickupTime, Preis werden automatisch aus cart Ã¼bernommen)
        showCheckout();
      };
    }

    if(!cart || !cart.items.length){
      // Empty State: Picknick-Motiv (Verzehrart irrelevant)
      box.innerHTML = `
        <div style="text-align:center; padding:60px 20px;">
          <div style="width:140px; height:140px; margin:0 auto 24px; background:linear-gradient(135deg, rgba(255,215,0,0.1) 0%, rgba(255,184,0,0.15) 100%); border-radius:50%; display:flex; align-items:center; justify-content:center;">
            <i data-lucide="shopping-basket" style="width:80px;height:80px;color:#1a1a1a;"></i>
          </div>
          <h3 style="font-size:22px; font-weight:900; margin-bottom:12px; color:#111; font-family:'Inter', 'Montserrat', sans-serif;">Dein Korb ist noch leer â€“ Zeit fÃ¼r ein Match!</h3>
          <p style="font-size:15px; color:#666; margin-bottom:32px; line-height:1.6; max-width:320px; margin-left:auto; margin-right:auto;">Swipe dich durch leckere Gerichte und fÃ¼lle deine Mittagsbox.</p>
          <button class="btn-primary" type="button" onclick="showDiscover();" style="width:100%; max-width:280px; margin:0 auto; min-height:52px; font-size:16px; font-weight:700;">
            <i data-lucide="compass" style="width:20px;height:20px;"></i> <span>Jetzt Essen swipen</span>
          </button>
        </div>
      `;
      btn.style.display='none';
      note.style.display='none';
      if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
      updateHeaderBasket();
      return;
    }

    if(!cart.verzehrmodus) cart.verzehrmodus = 'mitnehmen';
    let total=0;
    let canCheckout = true;
    const firstOffer = cart.items.length ? offers.find(x=>x.id===cart.items[0].offerId) : null;
    const firstOfferNormalized = firstOffer ? normalizeOffer(firstOffer) : null;
    const windowText = firstOfferNormalized && firstOfferNormalized.pickupWindow ? firstOfferNormalized.pickupWindow : '';
    const lines = cart.items.map(it=>{
      const o = offers.find(x=>x.id===it.offerId);
      if(!o) return '';
      const normalized = normalizeOffer(o);
      if(!normalized.hasPickupCode) canCheckout = false;
      const lineTotal = Number(normalized.price||0) * it.qty;
      total += lineTotal;
      return `
        <div class="cart-line">
          <div class="cart-left">${esc(normalized.dish || normalized.title || 'Gericht')}</div>
          <div class="cart-qty">
            <button class="qty-btn" type="button" data-action="dec" data-id="${esc(o.id)}">-</button>
            <div>${it.qty}</div>
            <button class="qty-btn" type="button" data-action="inc" data-id="${esc(o.id)}">+</button>
          </div>
          <div class="cart-price">${euro(lineTotal)}</div>
        </div>
      `;
    }).filter(Boolean);

    // Standard-Zeit-Slots im 15-Minuten-Takt (11:30, 12:00, 12:15, etc.)
    const TIME_SLOTS = ['11:30', '11:45', '12:00', '12:15', '12:30', '12:45', '13:00', '13:15', '13:30', '13:45', '14:00'];
    
    // Filtere Zeiten basierend auf aktueller Uhrzeit (mindestens 15 Min in Zukunft)
    const now = new Date();
    const currentMinutes = now.getHours() * 60 + now.getMinutes();
    const availableSlots = TIME_SLOTS.filter(slot => {
      const [h, m] = slot.split(':').map(Number);
      const slotMinutes = h * 60 + m;
      return slotMinutes >= currentMinutes + 15; // Mindestens 15 Min Vorlauf
    });
    
    // Wenn keine Slots verfÃ¼gbar, zeige alle (fÃ¼r spÃ¤tere Zeiten)
    const slotsToShow = availableSlots.length > 0 ? availableSlots : TIME_SLOTS.slice(0, 6);
    
    // Speichere TIME_SLOTS global fÃ¼r Checkout
    window.TIME_SLOTS = TIME_SLOTS;
    window.currentMinutes = currentMinutes;
    
    // Generiere Time-Chips
    const timeChips = slotsToShow.map(t => 
      `<button class="cart-time-chip ${cart.pickupTime === t ? 'selected' : ''}" type="button" data-time="${t}" style="padding:10px 16px; border-radius:12px; border:2px solid ${cart.pickupTime === t ? '#FFD700' : '#e7e1d5'}; background:${cart.pickupTime === t ? '#FFD700' : '#fff'}; color:${cart.pickupTime === t ? '#2D3436' : '#666'}; font-weight:${cart.pickupTime === t ? '900' : '600'}; font-size:14px; cursor:pointer; transition:all 0.2s ease;">${t} Uhr</button>`
    ).join('');
    
    // Multi-Vendor-Check: PrÃ¼fe ob verschiedene Anbieter im Korb sind
    const uniqueProviders = new Set();
    cart.items.forEach(it => {
      const o = offers.find(x => x.id === it.offerId);
      if(o) uniqueProviders.add(o.providerId);
    });
    const hasMultipleProviders = uniqueProviders.size > 1;
    const multiVendorWarning = hasMultipleProviders ? `
      <div style="margin-bottom:16px; padding:12px 16px; background:rgba(255,215,0,0.15); border-left:4px solid #FFD700; border-radius:8px;">
        <div style="font-weight:700; font-size:14px; color:#2D3436; margin-bottom:4px; display:flex; align-items:center; gap:6px;">
          <i data-lucide="alert-triangle" style="width:16px;height:16px; color:#FFD700;"></i>
          Abholung an verschiedenen Standorten
        </div>
        <div style="font-size:13px; color:#666; line-height:1.5;">Du hast Essen von ${uniqueProviders.size} verschiedenen Anbietern. Plane genug Zeit fÃ¼r die Abholung ein!</div>
      </div>
    ` : '';
    
    // Gruppiere Items nach Anbieter
    const itemsByProvider = new Map();
    cart.items.forEach(it => {
      const o = offers.find(x => x.id === it.offerId);
      if(!o) return;
      const providerId = o.providerId;
      if(!itemsByProvider.has(providerId)){
        itemsByProvider.set(providerId, {
          provider: normalizeOffer(o),
          items: []
        });
      }
      itemsByProvider.get(providerId).items.push({offer: o, qty: it.qty});
    });
    
    // Rendere Items gruppiert nach Anbieter
    let groupedLines = '';
    itemsByProvider.forEach((group, providerId) => {
      const provider = group.provider;
      const providerLines = group.items.map(({offer, qty}) => {
        const normalized = normalizeOffer(offer);
        const lineTotal = Number(normalized.price||0) * qty;
        return `
          <div class="cart-line" style="padding-left:${hasMultipleProviders ? '20px' : '0'};">
            <div class="cart-left">${esc(normalized.dish || normalized.title || 'Gericht')}</div>
            <div class="cart-qty">
              <button class="qty-btn" type="button" data-action="dec" data-id="${esc(offer.id)}">-</button>
              <div>${qty}</div>
              <button class="qty-btn" type="button" data-action="inc" data-id="${esc(offer.id)}">+</button>
            </div>
            <div class="cart-price">${euro(lineTotal)}</div>
          </div>
        `;
      }).join('');
      
      groupedLines += `
        <div style="margin-bottom:${hasMultipleProviders ? '20px' : '0'};">
          <div style="font-size:16px; font-weight:900; margin-bottom:12px; display:flex; align-items:center; gap:8px; cursor:pointer;" onclick="openProviderQuickView('${esc(providerId)}');">
            <i data-lucide="store" style="width:18px;height:18px; color:#666;"></i>
            <span>${esc(provider.providerName || 'Anbieter')}</span>
            <i data-lucide="chevron-right" style="width:16px;height:16px; color:#999; margin-left:auto;"></i>
          </div>
          ${providerLines}
        </div>
      `;
    });
    
    box.innerHTML = `
      ${multiVendorWarning}
      ${groupedLines}
      ${windowText ? `
        <div class="cart-window-badge" style="margin-top:16px;">
          <i data-lucide="clock"></i>
          <span>Essenszeit: ${esc(windowText)}</span>
        </div>
      ` : ''}
      <div class="row" style="margin-top:20px;"><span style="font-weight:700; font-size:15px;">Wann holst du dein Essen ab?</span></div>
      <div class="cart-time-chips" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-top:12px; margin-bottom:12px;">
        ${timeChips}
      </div>
      ${hasMultipleProviders ? `<div class="hint" style="margin-top:8px; font-size:12px; color:#666;">Diese Zeit gilt fÃ¼r alle gewÃ¤hlten Standorte.</div>` : ''}
      ${hasMultipleProviders ? (() => {
        // Berechne Gesamtgehzeit fÃ¼r Route mit mehreren Stopps
        let totalWalkingMinutes = 0;
        const providerDistances = [];
        Array.from(uniqueProviders).forEach(providerId => {
          const o = offers.find(x => x.providerId === providerId && x.active !== false);
          if(o && o.distanceKm != null){
            const walkingMinutes = Math.round(Number(o.distanceKm) * 12); // 5 km/h = 12 Min/km
            providerDistances.push(walkingMinutes);
            totalWalkingMinutes += walkingMinutes;
          }
        });
        // GeschÃ¤tzte Gesamtzeit: Summe der Gehzeiten + 2 Min pro Stopp fÃ¼r Abholung
        const pickupTimePerStop = 2;
        const totalTime = totalWalkingMinutes + (uniqueProviders.size * pickupTimePerStop);
        const totalTimeText = totalTime < 60 ? `${totalTime} Min.` : `${Math.floor(totalTime / 60)} Std. ${totalTime % 60} Min.`;
        
        return `
        <div style="margin-top:16px; padding:12px 16px; background:rgba(31,157,85,0.1); border-left:4px solid #1f9d55; border-radius:8px;">
          <div style="font-weight:700; font-size:13px; color:#1f9d55; margin-bottom:6px; display:flex; align-items:center; gap:6px;">
            <i data-lucide="navigation" style="width:16px;height:16px;"></i>
            Optimale Abhol-Route verfÃ¼gbar
          </div>
          <div style="font-size:12px; color:#666; margin-bottom:8px; line-height:1.4;">
            GeschÃ¤tzte Gesamtzeit: <span style="font-weight:700; color:#1f9d55;">${totalTimeText} zu FuÃŸ</span> (inkl. ${uniqueProviders.size} Stopps)
          </div>
          <button type="button" onclick="openGoogleMapsRoute();" style="width:100%; padding:10px 16px; background:#1f9d55; color:#fff; border:none; border-radius:8px; font-weight:700; font-size:14px; cursor:pointer; transition:transform 0.2s ease;" onmouseover="this.style.transform='scale(1.02)';" onmouseout="this.style.transform='scale(1)';">
            <i data-lucide="navigation" style="width:16px;height:16px;"></i> Route starten
          </button>
        </div>
      `;
      })() : ''}
      <div class="row" style="margin-top:24px; padding-top:20px; padding-right:48px; border-top:2px solid #eee; position:relative; display:flex; justify-content:space-between; align-items:center;">
        <span style="font-size:18px; font-weight:900;">Gesamt</span>
        <b style="font-size:20px; color:var(--brand); padding-right:8px; min-width:4em; text-align:right;">${euro(total)}</b>
        <button type="button" id="clearCartIcon" class="cart-clear-icon" style="position:absolute; top:20px; right:0; width:36px; height:36px; border-radius:50%; border:none; background:rgba(0,0,0,0.05); display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.2s ease; color:#666;" onmouseover="this.style.background='rgba(227,77,77,0.1)'; this.style.color='#e74c3c';" onmouseout="this.style.background='rgba(0,0,0,0.05)'; this.style.color='#666';" title="Mittagsbox leeren">
          <i data-lucide="trash-2" style="width:18px;height:18px;"></i>
        </button>
      </div>
    `;

    // Warenkorb leeren mit Sicherheitsabfrage (Bottom-Sheet)
    const clearCartBtn = document.getElementById('clearCartIcon');
    if(clearCartBtn){
      clearCartBtn.onclick=(e)=>{
        e.preventDefault();
        e.stopPropagation();
        // Bottom-Sheet fÃ¼r BestÃ¤tigung Ã¶ffnen
        const confirmSheet = document.createElement('div');
        confirmSheet.style.cssText = 'position:fixed; bottom:0; left:0; right:0; background:#fff; border-radius:24px 24px 0 0; padding:24px; box-shadow:0 -4px 20px rgba(0,0,0,0.15); z-index:1000; max-width:480px; margin:0 auto;';
        confirmSheet.innerHTML = `
          <div style="text-align:center; margin-bottom:20px;">
            <div style="width:64px; height:64px; margin:0 auto 16px; background:rgba(227,77,77,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center;">
              <i data-lucide="trash-2" style="width:32px;height:32px; color:#e74c3c;"></i>
            </div>
            <h3 style="font-size:20px; font-weight:900; margin:0 0 8px; color:#2D3436;">Mittagsbox wirklich leeren?</h3>
            <p style="font-size:14px; color:#666; margin:0; line-height:1.5;">Alle Gerichte werden entfernt.</p>
          </div>
          <div style="display:flex; gap:12px;">
            <button type="button" id="confirmClearCart" style="flex:1; min-height:52px; background:#e74c3c; color:#fff; border:none; border-radius:16px; font-weight:700; font-size:16px; cursor:pointer;">Ja, leeren</button>
            <button type="button" id="cancelClearCart" style="flex:1; min-height:52px; background:#f0f0f0; color:#666; border:none; border-radius:16px; font-weight:700; font-size:16px; cursor:pointer;">Abbrechen</button>
          </div>
        `;
        document.body.appendChild(confirmSheet);
        if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
        
        // Backdrop
        const backdrop = document.createElement('div');
        backdrop.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:999;';
        document.body.appendChild(backdrop);
        
        const closeSheet = () => {
          document.body.removeChild(confirmSheet);
          document.body.removeChild(backdrop);
        };
        
        document.getElementById('confirmClearCart').onclick = () => {
          cart = null;
          save(LS.cart, cart);
          renderCart();
          updateHeaderBasket();
          closeSheet();
          showToast('Mittagsbox geleert', 2000);
        };
        
        document.getElementById('cancelClearCart').onclick = closeSheet;
        backdrop.onclick = closeSheet;
      };
    }
    
    // Quick-Time-Chips Handler
    box.querySelectorAll('.cart-time-chip').forEach(chip=>{
      chip.onclick=()=>{
        const time = chip.getAttribute('data-time');
        cart.pickupTime = time;
        save(LS.cart, cart);
        renderCart();
      };
    });
    
    // Die Logik ist jetzt im Header-Bereich implementiert (cartBtnVorOrt, cartBtnMitnehmen)
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);

    box.querySelectorAll('.qty-btn').forEach(btnEl=>{
      btnEl.onclick=()=>{
        const id = btnEl.getAttribute('data-id');
        const action = btnEl.getAttribute('data-action');
        const idx = cart.items.findIndex(i=>i.offerId===id);
        if(idx<0) return;
        if(action==='inc') cart.items[idx].qty += 1;
        if(action==='dec') cart.items[idx].qty -= 1;
        if(cart.items[idx].qty <= 0) cart.items.splice(idx,1);
        save(LS.cart, cart);
        renderCart();
      };
    });

    btn.style.display='block';
    btn.disabled = !canCheckout;
    
    // Trust-Icons anzeigen
    const trustIcons = document.getElementById('cartTrustIcons');
    if(trustIcons){
      trustIcons.style.display = canCheckout ? 'flex' : 'none';
      if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
    }
    
    // Note anzeigen
    if(note){
      note.style.display = canCheckout ? 'block' : 'none';
    }
    // CTA-Text: Zahlung ist Pflicht (Stripe Checkout, Gastzahlung)
    if(canCheckout){
      // Alle Items haben hasPickupCode = true â†’ Stripe Checkout (Gastzahlung, Zahlung Pflicht)
      // Button mit ðŸ§¾ Emoji und "Abholnummer" Text
      btn.innerHTML = `<span style="font-size:22px;">ðŸ§¾</span><span>Weiter zur Zahlung</span>`;
      btn.style.display = 'flex';
      btn.style.alignItems = 'center';
      btn.style.justifyContent = 'center';
      btn.style.gap = '8px';
    } else {
      // Kein Payment mÃ¶glich â†’ Button deaktiviert
      btn.innerHTML = `${iconMarkup('alert-circle')}<span>Zahlung nicht mÃ¶glich</span>`;
    }
    
    // Header-Basket aktualisieren
    updateHeaderBasket();
    note.style.display='block';
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }

  const btnCheckout = document.getElementById('btnCheckout');
  // --- Checkout Navigation ---
  function showCheckout(){
    if(!cart || !cart.items || !cart.items.length){
      showCart();
      return;
    }
    
    // PrÃ¼fe ob Payment mÃ¶glich ist
    const hasPayment = cart.items.every(it=>{
      const o = offers.find(x=>x.id===it.offerId);
      return o && normalizeOffer(o).hasPickupCode;
    });
    
    if(!hasPayment){
      alert('Diese Bestellung enthÃ¤lt Gerichte ohne Abholnummer. Bitte wÃ¤hle Angebote mit Abholnummer aus.');
      return;
    }
    
    // Gesamtpreis berechnen
    let total = 0;
    cart.items.forEach(it=>{
      const o = offers.find(x=>x.id===it.offerId);
      if(o){
        const normalized = normalizeOffer(o);
        total += Number(normalized.price||0) * it.qty;
      }
    });
    
    if(total <= 0){
      alert('Bitte wÃ¤hle mindestens ein Gericht aus.');
      return;
    }
    
    // Checkout-View rendern
    renderCheckout(total);
    
    // View anzeigen
    showView(views.checkout);
    setCustomerNavActive('cart'); // Cart bleibt aktiv
    
    // History fÃ¼r Back-Button
    if(!isNavigatingBack){
      navigationHistory.push({
        view: 'cart',
        locationQuery: locationQuery || '',
        activeCat: activeCat || null,
        activeDay: activeDay || isoDate(new Date()),
        activeFilter: activeDiscoverFilter || 'near',
        scrollY: window.scrollY
      });
      pushViewState({view: 'checkout'}, '#checkout');
    }
  }
  
  function renderCheckout(total){
    if(!cart) cart = { items: [] };
    if(!cart.verzehrmodus) cart.verzehrmodus = 'mitnehmen';
    save(LS.cart, cart);
    
    // Zeitauswahl im 15-Minuten-Takt rendern
    const TIME_SLOTS = window.TIME_SLOTS || ['11:30', '11:45', '12:00', '12:15', '12:30', '12:45', '13:00', '13:15', '13:30', '13:45', '14:00'];
    const currentMinutes = window.currentMinutes || (new Date().getHours() * 60 + new Date().getMinutes());
    let selectedTime = cart && cart.pickupTime ? cart.pickupTime : '';
    
    // Auto-Auswahl: NÃ¤chster verfÃ¼gbarer Slot (wenn noch keine Zeit gewÃ¤hlt)
    if(!selectedTime){
      const availableSlots = TIME_SLOTS.filter(t => {
        const [h, m] = t.split(':').map(Number);
        return (h * 60 + m) >= currentMinutes + 15;
      });
      if(availableSlots.length > 0){
        selectedTime = availableSlots[0];
        if(!cart) cart = {items: []};
        cart.pickupTime = selectedTime;
        save(LS.cart, cart);
      }
    }
    
    const checkoutTimeSlots = document.getElementById('checkoutTimeSlots');
    if(checkoutTimeSlots){
      checkoutTimeSlots.innerHTML = TIME_SLOTS.map(t => {
        const [h, m] = t.split(':').map(Number);
        const slotMinutes = h * 60 + m;
        const isAvailable = slotMinutes >= currentMinutes + 15;
        const isSelected = selectedTime === t;
        return `<button type="button" class="time-slot-btn ${isSelected ? 'selected' : ''} ${!isAvailable ? 'disabled' : ''}" data-time="${t}" style="padding:12px; border-radius:12px; border:2px solid ${isSelected ? '#FFD700' : '#e7e1d5'}; background:${isSelected ? '#FFD700' : '#fff'}; color:${isSelected ? '#2D3436' : isAvailable ? '#666' : '#ccc'}; font-weight:${isSelected ? '900' : '600'}; font-size:14px; cursor:${isAvailable ? 'pointer' : 'not-allowed'}; transition:all 0.2s ease; opacity:${isAvailable ? '1' : '0.5'};">
          ${t}
        </button>`;
      }).join('');
      
      // Handler fÃ¼r Time-Slots
      checkoutTimeSlots.querySelectorAll('.time-slot-btn:not(.disabled)').forEach(btn => {
        btn.onclick = () => {
          const time = btn.getAttribute('data-time');
          if(!cart) cart = {items: []};
          cart.pickupTime = time;
          save(LS.cart, cart);
          
          // Custom Input ausblenden
          const customInputWrapper = document.getElementById('customTimeInputWrapper');
          if(customInputWrapper) customInputWrapper.style.display = 'none';
          const customInput = document.getElementById('checkoutPickupTimeCustom');
          if(customInput) customInput.value = '';
          
          // UI aktualisieren
          checkoutTimeSlots.querySelectorAll('.time-slot-btn').forEach(b => {
            const isSelected = b.getAttribute('data-time') === time;
            b.classList.toggle('selected', isSelected);
            b.style.borderColor = isSelected ? '#FFD700' : '#e7e1d5';
            b.style.background = isSelected ? '#FFD700' : '#fff';
            b.style.color = isSelected ? '#2D3436' : '#666';
            b.style.fontWeight = isSelected ? '900' : '600';
          });
          
          const hiddenInput = document.getElementById('checkoutPickupTime');
          if(hiddenInput) hiddenInput.value = time;
        };
      });
    }
    
    // "Andere Uhrzeit wÃ¤hlen" Button Handler
    const btnOtherTime = document.getElementById('btnOtherTime');
    const customTimeInputWrapper = document.getElementById('customTimeInputWrapper');
    const customTimeInput = document.getElementById('checkoutPickupTimeCustom');
    if(btnOtherTime && customTimeInputWrapper && customTimeInput){
      btnOtherTime.onclick = () => {
        const isVisible = customTimeInputWrapper.style.display !== 'none';
        customTimeInputWrapper.style.display = isVisible ? 'none' : 'block';
        if(!isVisible){
          customTimeInput.focus();
          // Alle Slots deselektieren
          if(checkoutTimeSlots){
            checkoutTimeSlots.querySelectorAll('.time-slot-btn').forEach(b => {
              b.classList.remove('selected');
              b.style.borderColor = '#e7e1d5';
              b.style.background = '#fff';
              b.style.color = '#666';
              b.style.fontWeight = '600';
            });
          }
          // Wenn bereits eine Custom-Zeit gesetzt ist, diese anzeigen
          if(cart && cart.pickupTime && !TIME_SLOTS.includes(cart.pickupTime)){
            // Format fÃ¼r time-Input: HH:MM
            const timeParts = cart.pickupTime.replace(' Uhr', '').split(':');
            if(timeParts.length === 2){
              customTimeInput.value = `${timeParts[0].padStart(2, '0')}:${timeParts[1].padStart(2, '0')}`;
            }
          }
        }
      };
      
      customTimeInput.onchange = () => {
        const customTime = customTimeInput.value;
        if(customTime){
          // Validierung: Zwischen 11:30 und 14:00
          const [h, m] = customTime.split(':').map(Number);
          const timeMinutes = h * 60 + m;
          const minMinutes = 11 * 60 + 30; // 11:30
          const maxMinutes = 14 * 60; // 14:00
          
          if(timeMinutes >= minMinutes && timeMinutes <= maxMinutes){
            // Format: "HH:MM Uhr"
            const formattedTime = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')} Uhr`;
            if(!cart) cart = {items: []};
            cart.pickupTime = formattedTime;
            save(LS.cart, cart);
            const hiddenInput = document.getElementById('checkoutPickupTime');
            if(hiddenInput) hiddenInput.value = formattedTime;
            showToast('Zeit gespeichert âœ“', 1500);
          } else {
            showToast('Bitte wÃ¤hle eine Zeit zwischen 11:30 und 14:00 Uhr', 3000);
            customTimeInput.value = '';
          }
        }
      };
    }
    
    // Hidden Input setzen
    const hiddenInput = document.getElementById('checkoutPickupTime');
    if(hiddenInput && selectedTime) hiddenInput.value = selectedTime;
    
    // Verzehrart-Buttons (Vor Ort / Mitnehmen)
    const btnVorOrt = document.getElementById('checkoutBtnVorOrt');
    const btnMitnehmen = document.getElementById('checkoutBtnMitnehmen');
    const vm = cart.verzehrmodus || 'mitnehmen';
    
    // Active-State: Gelbe Hintergrundfarbe fÃ¼r ausgewÃ¤hlten Button
    const updateVerzehrartButtons = () => {
      const isVorOrt = vm === 'vor_ort';
      const isMitnehmen = vm === 'mitnehmen';
      
      if(btnVorOrt){
        btnVorOrt.classList.toggle('active', isVorOrt);
        btnVorOrt.style.borderColor = isVorOrt ? '#FFD700' : '#e7e1d5';
        btnVorOrt.style.background = isVorOrt ? '#FFD700' : '#fff';
        btnVorOrt.style.color = isVorOrt ? '#2D3436' : '#666';
        btnVorOrt.style.fontWeight = isVorOrt ? '900' : '600';
      }
      
      if(btnMitnehmen){
        btnMitnehmen.classList.toggle('active', isMitnehmen);
        btnMitnehmen.style.borderColor = isMitnehmen ? '#FFD700' : '#e7e1d5';
        btnMitnehmen.style.background = isMitnehmen ? '#FFD700' : '#fff';
        btnMitnehmen.style.color = isMitnehmen ? '#2D3436' : '#666';
        btnMitnehmen.style.fontWeight = isMitnehmen ? '900' : '600';
      }
    };
    
    updateVerzehrartButtons();
    
    // Interaktions-Logik: Status an Anbieter-Datensatz senden
    if(btnVorOrt){
      btnVorOrt.onclick = () => {
        cart.verzehrmodus = 'vor_ort';
        save(LS.cart, cart);
        
        // Signal an Anbieter: Porzellan/Besteck vorbereiten
        cart.items.forEach(item => {
          const offer = offers.find(o => o.id === item.offerId);
          if(offer && offer.providerId){
            // Verzehrart wird beim Erstellen der Bestellung an den Anbieter Ã¼bermittelt
            // Der Anbieter sieht in seinem Dashboard: "Vor Ort essen" fÃ¼r diese Bestellung
            console.log(`[Anbieter-Signal] ${offer.providerId}: Vor Ort essen gewÃ¤hlt - Porzellan/Besteck vorbereiten`);
          }
        });
        
        renderCheckout(total);
      };
    }
    
    if(btnMitnehmen){
      btnMitnehmen.onclick = () => {
        cart.verzehrmodus = 'mitnehmen';
        if(!cart.verpackung) cart.verpackung = 'mehrweg';
        save(LS.cart, cart);
        
        // Signal an Anbieter: Einpacken in Box/Mehrweg
        cart.items.forEach(item => {
          const offer = offers.find(o => o.id === item.offerId);
          if(offer && offer.providerId){
            console.log(`[Anbieter-Signal] ${offer.providerId}: Mitnehmen gewÃ¤hlt - Einpacken in Box/Mehrweg`);
          }
        });
        
        renderCheckout(total);
      };
    }
    
    // Verpackung (nur bei Mitnehmen) â€“ Anzeige + Buttons im Time-Slot-Stil
    const verpackungWrap = document.getElementById('checkoutVerpackung');
    const btnEigenerBehaeltner = document.getElementById('checkoutBtnEigenerBehaeltner');
    const btnMehrweg = document.getElementById('checkoutBtnMehrweg');
    const isMitnehmen = (cart.verzehrmodus || 'mitnehmen') === 'mitnehmen';
    if(verpackungWrap) verpackungWrap.style.display = isMitnehmen ? 'block' : 'none';
    
    const verpackung = cart.verpackung || 'mehrweg';
    const setVerpackungActive = (btn, active) => {
      if(!btn) return;
      btn.style.borderColor = active ? '#FFD700' : '#e7e1d5';
      btn.style.background = active ? '#FFD700' : '#fff';
      btn.style.color = active ? '#2D3436' : '#666';
      btn.style.fontWeight = active ? '900' : '600';
    };
    if(btnEigenerBehaeltner){
      setVerpackungActive(btnEigenerBehaeltner, verpackung === 'eigener_behaeltner');
      btnEigenerBehaeltner.onclick = () => {
        cart.verpackung = 'eigener_behaeltner';
        save(LS.cart, cart);
        setVerpackungActive(btnEigenerBehaeltner, true);
        setVerpackungActive(btnMehrweg, false);
      };
    }
    if(btnMehrweg){
      setVerpackungActive(btnMehrweg, verpackung === 'mehrweg');
      btnMehrweg.onclick = () => {
        cart.verpackung = 'mehrweg';
        save(LS.cart, cart);
        setVerpackungActive(btnMehrweg, true);
        setVerpackungActive(btnEigenerBehaeltner, false);
      };
    }
    
    const summaryEl = document.getElementById('checkoutSummary');
    if(!summaryEl) return;
    
    // BestellÃ¼bersicht rendern
    let summaryHTML = '<div style="font-weight:700; font-size:16px; margin-bottom:16px; color:#2D3436;">BestellÃ¼bersicht</div>';
    cart.items.forEach(it=>{
      const o = offers.find(x=>x.id===it.offerId);
      if(o){
        const normalized = normalizeOffer(o);
        const lineTotal = Number(normalized.price||0) * it.qty;
        summaryHTML += `
          <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid rgba(0,0,0,.08);">
            <div>
              <div style="font-weight:600; font-size:15px; color:#2D3436;">${esc(normalized.dish||'Gericht')} Ã— ${it.qty}</div>
              <div style="font-size:13px; color:#666; margin-top:4px;">${esc(normalized.providerName||'Anbieter')}</div>
            </div>
            <div style="font-weight:700; font-size:16px; color:#2D3436;">${euro(lineTotal)}</div>
          </div>
        `;
      }
    });
    summaryHTML += `
      <div style="display:flex; justify-content:space-between; align-items:center; padding-top:16px; margin-top:16px; border-top:2px solid #2D3436;">
        <div style="font-weight:900; font-size:18px; color:#2D3436;">Gesamt</div>
        <div style="font-weight:900; font-size:24px; color:#FFB800;">${euro(total)}</div>
      </div>
    `;
    summaryEl.innerHTML = summaryHTML;
    
    // Apple Pay / Google Pay Buttons prÃ¼fen (wenn verfÃ¼gbar)
    const btnApplePay = document.getElementById('btnApplePay');
    const btnGooglePay = document.getElementById('btnGooglePay');
    if(btnApplePay){
      // PrÃ¼fe ob Apple Pay verfÃ¼gbar ist (in Production: window.ApplePaySession?.canMakePayments())
      btnApplePay.style.display = 'none'; // MVP: Ausgeblendet, in Production aktivieren
    }
    if(btnGooglePay){
      // PrÃ¼fe ob Google Pay verfÃ¼gbar ist
      btnGooglePay.style.display = 'none'; // MVP: Ausgeblendet, in Production aktivieren
    }
    
    // Standard Payment Button Handler
    const btnStandardPayment = document.getElementById('btnStandardPayment');
    if(btnStandardPayment){
      btnStandardPayment.onclick = () => {
        processCheckoutPayment(total);
      };
    }
    
    // Back Button
    const btnCheckoutBack = document.getElementById('btnCheckoutBack');
    if(btnCheckoutBack){
      btnCheckoutBack.onclick = () => {
        showCart();
      };
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(() => lucide.createIcons(), 50);
    }
  }
  
  function processCheckoutPayment(total){
    // Name validieren
    const nameInput = document.getElementById('checkoutName');
    const name = nameInput ? nameInput.value.trim() : '';
    if(!name){
      alert('Bitte gib deinen Namen fÃ¼r die Abholung ein.');
      if(nameInput) nameInput.focus();
      return;
    }
    
    // Abholzeit auslesen
    const pickupTimeSelect = document.getElementById('checkoutPickupTime');
    const pickupTime = pickupTimeSelect ? pickupTimeSelect.value : 'asap';
    const pickupTimeText = pickupTime === 'asap' ? 'So schnell wie mÃ¶glich' : `${pickupTime} Uhr`;
    
    // E-Mail (optional)
    const emailInput = document.getElementById('checkoutEmail');
    const email = emailInput ? emailInput.value.trim() : '';
    
    // Cart mit neuen Daten aktualisieren
    cart.pickupTime = pickupTimeText;
    cart.customerName = name;
    cart.customerEmail = email;
    save(LS.cart, cart);
    
    // Order mit Status CREATED erstellen
    const orderCreated = createOrderFromCart(cart, 'CREATED');
    if(!orderCreated){
      alert('Fehler beim Erstellen der Bestellung.');
      return;
    }
    
    // Order wird auf PAYMENT_PENDING gesetzt
    updateOrder(orderCreated.id, { status: 'PAYMENT_PENDING' });
    
    // Stripe Checkout starten
    startStripeCheckout(total, cart, orderCreated.id);
  }
  
  if(btnCheckout){
    btnCheckout.onclick=()=>{
      showCheckout();
    };
  }
  
  /**
   * Create order from cart
   * @param {Object} cartData
   * @param {'CREATED'|'PAYMENT_PENDING'} initialStatus
   * @returns {Order|null}
   */
  function createOrderFromCart(cartData, initialStatus){
    if(!cartData || !cartData.items || !cartData.items.length) return null;
    
    const firstOffer = cartData.items.length ? offers.find(x=>x.id===cartData.items[0].offerId) : null;
    const firstOfferNormalized = firstOffer ? normalizeOffer(firstOffer) : null;
    
    // Gesamtpreis berechnen (in Cents)
    let totalCents = 0;
    const items = cartData.items.map(it=>{
      const o = offers.find(x=>x.id===it.offerId);
      if(!o) return null;
      const normalized = normalizeOffer(o);
      const unitPriceCents = Math.round(Number(normalized.price||0) * 100);
      const lineTotalCents = unitPriceCents * it.qty;
      totalCents += lineTotalCents;
      return {
        dishId: o.id,
        dishName: normalized.dish || normalized.title || 'Gericht',
        quantity: it.qty,
        unitPriceCents: unitPriceCents
      };
    }).filter(Boolean);
    
    const now = Date.now();
    /** @type {Order} */
    const order = {
      id: cryptoId(),
      createdAt: now,
      updatedAt: now,
      dishId: items[0]?.dishId || '',
      verzehrmodus: cartData.verzehrmodus || 'mitnehmen', // Verzehrart an Anbieter Ã¼bermitteln: 'vor_ort' = Porzellan/Besteck vorbereiten, 'mitnehmen' = Einpacken in Box/Mehrweg
      offerId: items[0]?.dishId || '', // Same as dishId for MVP
      dishName: items.map(i => `${i.dishName} x ${i.quantity}`).join(', '),
      providerId: cartData.providerId || '',
      providerName: cartData.providerName || 'Anbieter',
      providerAddress: firstOfferNormalized ? buildAddress({
        address: firstOfferNormalized.address,
        street: firstOfferNormalized.providerStreet,
        zip: firstOfferNormalized.providerZip,
        city: firstOfferNormalized.providerCity
      }) : '',
      quantity: cartData.items.reduce((sum, it) => sum + it.qty, 0),
      unitPrice: items[0]?.unitPriceCents || 0,
      total: totalCents,
      fulfillType: cartData.verzehrmodus === 'vor_ort' ? 'DINE_IN' : 'PICKUP', // FÃ¼r KompatibilitÃ¤t
      etaTime: cartData.pickupTime || '',
      abholzeit: cartData.pickupTime || '',
      status: initialStatus,
      currency: 'EUR',
      stripeCheckoutSessionId: undefined,
      stripePaymentIntentId: undefined,
      receiptEmail: undefined,
      pickupCode: undefined, // Abholnummer; wird bei PAID gesetzt
      abholnummer: undefined, // Alias fÃ¼r Anbieter-Output; bei PAID = pickupCode
      pickupCodeActivatedAt: undefined, // Nur bei PAID
      pickupDate: undefined, // Wird bei PAID gesetzt
      pickupWindow: firstOfferNormalized && firstOfferNormalized.pickupWindow ? firstOfferNormalized.pickupWindow : '',
      dishLetter: undefined, // Wird bei PAID gesetzt
      runningNumber: undefined, // Wird bei PAID gesetzt
      isGuest: true,
      // KompatibilitÃ¤t
      summary: items.map(i => `${i.dishName} x ${i.quantity}`).join(', '),
      code: null,
      pickupTime: cartData.pickupTime || '',
      pickupWindow: firstOfferNormalized && firstOfferNormalized.pickupWindow ? firstOfferNormalized.pickupWindow : '',
      unitPriceCents: items[0]?.unitPriceCents || 0,
      totalCents: totalCents,
      paymentIntentId: null,
      verpackung: cartData.verpackung || null // SÃ¤ule 3: eigener_behaeltner | mehrweg (nur bei Mitnehmen)
    };
    
    return addOrder(order);
  }
  
  // --- Stripe Checkout (Gastzahlung, Zahlung Pflicht) ---
  /**
   * Start Stripe Checkout flow
   * @param {number} total - Total amount in EUR (not cents)
   * @param {Object} cartData - Cart data
   * @param {string} orderId - Order ID
   */
  function startStripeCheckout(total, cartData, orderId){
    // TODO: Replace with real Stripe integration
    // In Production:
    //   1. Backend-Endpoint: POST /api/create-checkout-session
    //   2. Request Body: { orderId, items: cartData.items, total, pickupTime, ... }
    //   3. Backend erstellt Stripe Checkout Session (mode: 'payment', allow_promotion_codes: true)
    //   4. Session-URL erhalten: session.url
    //   5. window.location.href = session.url; (Ã¶ffnet Stripe Checkout)
    //   6. Nach Zahlung: Stripe leitet zurÃ¼ck zu success_url?session_id=xxx
    //   7. Webhook bestÃ¤tigt Zahlung â†’ handleCheckoutSuccess(session_id)
    
    // MVP Demo: Simuliere Stripe Checkout
    const sessionId = 'demo_session_' + cryptoId();
    
    // Speichere session_id in Order (wird spÃ¤ter bei Success verwendet)
    updateOrder(orderId, {
      stripeCheckoutSessionId: sessionId
    });
    
    // Demo: Simuliere erfolgreiche Zahlung
    // In Production: window.location.href = session.url;
    if(confirm(`Stripe Checkout wÃ¼rde jetzt geÃ¶ffnet.\n\nGesamtbetrag: ${euro(total)}\n\nGastzahlung mÃ¶glich (E-Mail nur fÃ¼r Zahlungsbeleg, kein Login erforderlich).\n\nDemo: Zahlung erfolgreich simulieren?`)){
      // Simuliere Success-Return
      handleCheckoutSuccess(sessionId, orderId);
    } else {
      // Simuliere Cancel
      handleCheckoutCancel(orderId);
    }
  }
  
  /**
   * Handle Stripe Checkout Success Return
   * Route: /checkout/success?session_id=xxx OR ?orderId=xxx
   * @param {string} [sessionId] - Stripe session ID (optional)
   * @param {string} [orderId] - Order ID (optional, if sessionId not available)
   */
  function handleCheckoutSuccess(sessionId, orderId){
    // TODO: In Production, verify payment via Webhook
    // For now: MVP assumes payment is successful if we reach this point
    
    let order = null;
    
    // Find order: priority: orderId > sessionId
    if(orderId){
      order = getOrderById(orderId);
    } else if(sessionId){
      // Find order by session_id
      const ordersList = loadOrders();
      order = ordersList.find(o => o.stripeCheckoutSessionId === sessionId);
    }
    
    // Fehler-UI: Bestellung nicht gefunden
    if(!order){
      console.error('Order not found for checkout success', { sessionId, orderId });
      // Zeige Fehler-UI
      const errorView = document.createElement('div');
      errorView.className = 'panel';
      errorView.style.padding = '40px 20px';
      errorView.style.textAlign = 'center';
      errorView.innerHTML = `
        <div style="font-size:48px; margin-bottom:20px;">âš ï¸</div>
        <h3 style="margin-bottom:12px;">Bestellung nicht gefunden</h3>
        <p class="hint" style="margin-bottom:24px;">Die Bestellung konnte nicht gefunden werden.</p>
        <button class="btn" type="button" onclick="showDiscover()" style="width:100%; min-height:44px;">
          <i data-lucide="compass"></i> Zur Entdecken-Seite
        </button>
      `;
      document.body.appendChild(errorView);
      showView(null); // Hide all views
      if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
      return;
    }
    
    // Wenn Order noch nicht PAID: auf PAID setzen und Code generieren
    if(order.status !== 'PAID'){
      if(order.status !== 'PAYMENT_PENDING'){
        console.warn('Order status is not PAYMENT_PENDING:', order.status);
      }
      
      // Mark as PAID and generate pickup code
      completePayment(order.id, {
        stripeCheckoutSessionId: sessionId || order.stripeCheckoutSessionId,
        paymentIntentId: 'pi_' + cryptoId(), // Would come from Stripe webhook
        receiptEmail: 'customer@example.com' // Would come from Stripe
      });
    } else {
      // Bereits PAID: direkt zu Abholnummer navigieren
      showPickupCode(order.id);
    }
  }
  
  /**
   * Handle Stripe Checkout Cancel
   * Route: /checkout/cancel?orderId=xxx OR ?session_id=xxx
   * @param {string} [orderId] - Order ID (optional)
   * @param {string} [sessionId] - Stripe session ID (optional)
   */
  function handleCheckoutCancel(orderId, sessionId){
    let order = null;
    
    // Find order: priority: orderId > sessionId
    if(orderId){
      order = getOrderById(orderId);
    } else if(sessionId){
      const ordersList = loadOrders();
      order = ordersList.find(o => o.stripeCheckoutSessionId === sessionId);
    }
    
    if(!order){
      // Fallback: direkt zum Warenkorb
      showCart();
      return;
    }
    
    // Set status to CANCELLED
    updateOrder(order.id, {
      status: 'CANCELLED'
    });
    
    // UI: "Zahlung abgebrochen" + Button "ZurÃ¼ck zum Warenkorb"
    // Navigate back to cart
    showCart();
    
    // Zeige Info (optional, kann auch weggelassen werden)
    setTimeout(() => {
      const cartBox = document.getElementById('cartBox');
      if(cartBox){
        const infoDiv = document.createElement('div');
        infoDiv.className = 'hint';
        infoDiv.style.cssText = 'background:#fff3cd; border:1px solid #ffc107; border-radius:12px; padding:12px; margin-bottom:16px; text-align:center;';
        infoDiv.innerHTML = 'â„¹ï¸ Zahlung abgebrochen';
        cartBox.insertBefore(infoDiv, cartBox.firstChild);
      }
    }, 100);
  }
  
  /**
   * Complete payment (set status to PAID and generate pickup code)
   * @param {string} orderId
   * @param {Object} paymentData
   * @param {string} [paymentData.stripeCheckoutSessionId]
   * @param {string} [paymentData.paymentIntentId]
   * @param {string} [paymentData.receiptEmail]
   */
  function completePayment(orderId, paymentData){
    const order = getOrderById(orderId);
    if(!order){
      console.error('Order not found:', orderId);
      return;
    }
    
    // Get offer to determine day and pickup window
    const offer = offers.find(o => o.id === order.dishId || o.id === order.offerId);
    const pickupDate = offer ? offer.day : isoDate(new Date());
    const pickupWindow = offer ? (offer.pickupWindow || '') : (order.pickupWindow || '');
    
    // Assign pickup code (deterministic, mock)
    // Single source of truth: Order record
    const {dishLetter, runningNumber, pickupCode} = assignPickupCode({
      providerId: order.providerId,
      pickupDate: pickupDate,
      dishId: order.dishId || order.offerId
    });
    const now = Date.now();
    
    // Order auf PAID setzen (pickupCode wird hier gesetzt, da status=PAID)
    // WICHTIG: LocalStorage-Persistenz - sofort speichern fÃ¼r Offline-Sicherheit
    const updatedOrder = updateOrder(orderId, {
      status: 'PAID',
      stripeCheckoutSessionId: paymentData.stripeCheckoutSessionId,
      stripePaymentIntentId: paymentData.paymentIntentId,
      receiptEmail: paymentData.receiptEmail,
      pickupCode: pickupCode,
      abholnummer: pickupCode,
      pickupCodeActivatedAt: now,
      pickupDate: pickupDate,
      pickupWindow: pickupWindow,
      dishLetter: dishLetter,
      runningNumber: runningNumber,
      // KompatibilitÃ¤t
      code: pickupCode,
      paymentStatus: 'PAID',
      paymentIntentId: paymentData.paymentIntentId
    });
    
    if(!updatedOrder){
      console.error('Failed to update order');
      return;
    }
    
    // Warenkorb leeren
    cart = null;
    save(LS.cart, cart);
    renderCart();
    
    // Orders aktualisieren
    orders = loadOrders();
    renderOrders();
    
    // NOTFALL-MAIL: Backup-E-Mail an Anbieter (wenn Provider-Modus)
    if(mode === 'provider' && order.providerId === providerId()){
      sendBackupEmailToProvider(updatedOrder);
    }
    
    // Akustisches "Pling" bei neuem Verkauf (nur fÃ¼r Provider)
    if(mode === 'provider' && order.providerId === providerId()){
      playSaleSound();
      // Dashboard aktualisieren
      renderProviderHome();
      renderProviderPickups();
    }
    
    // Anbieter-Schnittstelle: Datensatz fÃ¼r Dashboard (Metzger/Gastro weiÃŸ sofort, wie anrichten)
    sendOrderToProviderDashboard(updatedOrder);
    
    // AbholBestÃ¤tigung (Success-View) anzeigen
    showOrderSuccess(updatedOrder);
  }
  
  /**
   * AbholBestÃ¤tigung: Success-View nach Zahlung (Abholnummer, Zeit, Modus, Verpackung).
   * @param {Order} order - Bestellung mit status PAID, pickupCode, pickupTime, verzehrmodus, verpackung
   */
  function showOrderSuccess(order){
    if(!order){
      showDiscover();
      return;
    }
    const code = order.pickupCode || order.abholnummer || order.code || 'â€“';
    const zeit = order.pickupTime || order.abholzeit || order.etaTime || 'â€“';
    const modus = order.verzehrmodus || 'mitnehmen';
    const verpackung = order.verpackung || null;
    const isMitnehmen = modus === 'mitnehmen';
    
    const abholnummerEl = document.getElementById('orderSuccessAbholnummer');
    const zeitEl = document.getElementById('orderSuccessZeit');
    const modusEl = document.getElementById('orderSuccessModus');
    const verpackungWrap = document.getElementById('orderSuccessVerpackung');
    const btnDone = document.getElementById('btnOrderSuccessDone');
    
    if(abholnummerEl) abholnummerEl.textContent = '#' + code;
    if(zeitEl) zeitEl.innerHTML = '<span style="font-size:20px;">ðŸ•’</span> Abholung um ' + (zeit.indexOf('Uhr') >= 0 ? zeit : zeit + ' Uhr');
    if(modusEl){
      if(modus === 'vor_ort'){
        modusEl.innerHTML = '<span style="font-size:20px;">ðŸ´</span> Vor Ort essen';
      } else {
        modusEl.innerHTML = '<span style="font-size:20px;">ðŸ”„</span> Mitnehmen';
      }
    }
    if(verpackungWrap){
      if(isMitnehmen && verpackung){
        verpackungWrap.style.display = 'flex';
        verpackungWrap.innerHTML = verpackung === 'eigener_behaeltner'
          ? '<span style="font-size:20px;">ðŸ”„</span> Eigener BehÃ¤lter'
          : '<span style="font-size:20px;">ðŸ”„</span> Mehrweg-System';
      } else {
        verpackungWrap.style.display = 'none';
      }
    }
    if(btnDone){
      btnDone.onclick = () => {
        showDiscover();
      };
    }
    
    showView(views.orderSuccess);
    setCustomerNavActive('cart');
  }
  
  /**
   * Simuliert Ãœbermittlung an Anbieter-Dashboard (abholnummer, zeit, modus, verpackung).
   * In Production: POST an Backend â†’ Anbieter-Dashboard aktualisiert sich.
   */
  function sendOrderToProviderDashboard(order){
    const payload = {
      abholnummer: order.pickupCode || order.abholnummer || order.code,
      zeit: order.pickupTime || order.abholzeit || order.etaTime,
      modus: order.verzehrmodus === 'vor_ort' ? 'vor_ort' : 'mitnehmen',
      verpackung: order.verpackung || (order.verzehrmodus === 'mitnehmen' ? 'mehrweg' : null),
      providerId: order.providerId,
      dishName: order.dishName,
      quantity: order.quantity
    };
    if(typeof console !== 'undefined' && console.log){
      console.log('[Anbieter-Dashboard] Bestellung Ã¼bermittelt:', payload);
    }
    // Optional: In Production hier z.B. EventBus oder API-Call
    // window.dispatchEvent(new CustomEvent('order-paid', { detail: payload }));
  }

  // --- Start actions ---
  const startCustomerBtn = document.getElementById('btnStartCustomer');
  if(startCustomerBtn){
    startCustomerBtn.onclick=()=>{
      setMode('customer');
    };
  }
  const startProviderBtn = document.getElementById('btnStartProvider');
  if(startProviderBtn){
    startProviderBtn.onclick=()=>{
      setMode('provider');
    };
  }

  // --- Profile View ("Mein Mittagio") - Zalando-Prinzip ---
  function updateProfileView(){
    const isLoggedIn = customer.loggedIn;
    const firstName = customer.name ? customer.name.split(' ')[0] : '';
    const fullName = customer.name || 'Gast';
    
    // Initialen fÃ¼r Avatar
    const initials = fullName.split(' ').map(n => n[0]?.toUpperCase() || '').join('').slice(0, 2) || '?';
    
    // Discover-Header-Avatar (rechts) mit Initialen oder Platzhalter
    const btnDiscoverAvatar = document.getElementById('btnDiscoverProfileAvatar');
    if(btnDiscoverAvatar){
      if(isLoggedIn && initials && initials !== '?'){
        btnDiscoverAvatar.textContent = initials;
        btnDiscoverAvatar.style.background = 'linear-gradient(135deg, #FFD700 0%, #FFD700 100%)';
        btnDiscoverAvatar.style.fontSize = '14px';
      } else {
        btnDiscoverAvatar.textContent = 'ðŸ‘¤';
        btnDiscoverAvatar.style.background = 'rgba(0,0,0,.06)';
        btnDiscoverAvatar.style.fontSize = '16px';
      }
    }
    
    // Header-Card (IdentitÃ¤t)
    const headerCard = document.getElementById('profileHeaderCard');
    if(headerCard){
      if(isLoggedIn){
        headerCard.innerHTML = `
          <div style="display:flex; align-items:center; gap:16px;">
            <div style="width:64px; height:64px; border-radius:50%; background:linear-gradient(135deg, #FFD700 0%, #FFD700 100%); display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:900; color:#334155; box-shadow:0 4px 12px rgba(255,215,0,0.3); flex-shrink:0;">
              ${initials}
            </div>
            <div style="flex:1; min-width:0;">
              <div style="font-weight:900; font-size:22px; margin-bottom:4px; color:#2D3436; line-height:1.2;">Hallo ${esc(firstName || 'Kunde')} ðŸ‘‹</div>
              <div class="hint" style="font-size:14px; color:#666; line-height:1.4;">Dein persÃ¶nlicher Mittagsbereich</div>
            </div>
          </div>
        `;
      } else {
        headerCard.innerHTML = `
          <div>
            <div style="font-family:'Nunito',sans-serif; font-weight:800; font-size:20px; margin-bottom:2px; color:#1a1a1a; line-height:1.25; letter-spacing:0.02em;">Willkommen bei Mittagio ðŸ‘‹</div>
            <div style="font-size:11px; font-weight:600; color:#94a3b8; margin-bottom:8px; text-transform:uppercase; letter-spacing:0.06em;">Anmeldung</div>
            <p class="hint" style="font-size:14px; color:#64748b; line-height:1.45; margin:0 0 14px;">Bestelle schneller und finde deine Abholnummern wieder.</p>
            <button class="btn-primary" type="button" id="btnProfileCreateAccount" style="width:100%; max-width:220px; min-height:46px; font-weight:800; font-size:15px; border-radius:14px; background:#FFD700; color:#1a1a1a; border:none; box-shadow:0 4px 0 0 #d1b600;">
              Profil anlegen
            </button>
          </div>
        `;
        const btn = document.getElementById('btnProfileCreateAccount');
        if(btn) btn.onclick = () => { openProfileCreateSheet(); };
      }
    }
    
    // Mein Geschmack + Nachhaltigkeit nur bei "Mein Profil" (eingeloggt)
    const tasteSection = document.getElementById('profileTasteSection');
    if(tasteSection) tasteSection.style.display = isLoggedIn ? 'block' : 'none';
    
    // Quick-History (Aktive Abholnummern)
    const abholnummerSection = document.getElementById('profileAbholnummerSection');
    const abholnummerList = document.getElementById('profileActiveAbholnummernList');
    const allOrders = loadOrders();
    const hasOrders = Array.isArray(allOrders) && allOrders.length > 0; // Bug-Fix: Sauber definiert
    
    // Heutige aktive Abholnummern (PAID, nicht PICKED_UP)
    const today = isoDate(new Date());
    const activeAbholnummern = allOrders.filter(o => 
      o.status === 'PAID' && 
      o.pickupDate === today && 
      (!o.pickupCodeActivatedAt || o.pickupCodeActivatedAt === null) // Noch nicht abgeholt
    );
    
    if(abholnummerSection && abholnummerList){
      if(activeAbholnummern.length > 0){
        abholnummerSection.style.display = 'block';
        abholnummerList.innerHTML = activeAbholnummern.map(order => {
          const code = order.pickupCode || 'â€“';
          return `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:16px; background:#f8f9fa; border-radius:16px; border:2px solid rgba(255,215,0,0.2); cursor:pointer; transition:all 0.2s ease;" onclick="showPickupCode('${esc(order.id)}');" onmouseover="this.style.borderColor='rgba(255,215,0,0.5)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.borderColor='rgba(255,215,0,0.2)'; this.style.transform='translateY(0)';">
              <div style="flex:1; min-width:0;">
                <div style="font-weight:900; font-size:18px; color:#2D3436; margin-bottom:4px; font-family:monospace; letter-spacing:2px;">${esc(code)}</div>
                <div style="font-size:13px; color:#666; display:flex; align-items:center; gap:6px;">
                  <i data-lucide="store" style="width:14px;height:14px;"></i>
                  <span>${esc(order.providerName || 'Anbieter')}</span>
                </div>
              </div>
              <i data-lucide="chevron-right" style="width:20px;height:20px; color:#999; flex-shrink:0;"></i>
            </div>
          `;
        }).join('');
      } else {
        abholnummerSection.style.display = 'none';
      }
    }
    
    // Profil-Verwaltung (Name, E-Mail)
    const verwaltungEl = document.getElementById('profileVerwaltungContent');
    if(verwaltungEl){
      if(isLoggedIn && (customer.name || customer.email)){
        verwaltungEl.innerHTML = `
          <div style="display:flex; flex-direction:column; gap:8px;">
            <div><strong>Name</strong><br><span style="color:#334155;">${esc(customer.name || 'â€“')}</span></div>
            <div><strong>E-Mail</strong><br><span style="color:#334155;">${esc(customer.email || 'â€“')}</span></div>
          </div>
        `;
      } else {
        verwaltungEl.textContent = 'Name und E-Mail â€“ wird nach Anmeldung angezeigt.';
      }
    }
    
    // Meine Bestellungen (aufgewertete Historie: Thumbnail, Name, Anbieter, Datum, Preis, Kategorie- und Allergen-Pills)
    const orderHistoryEl = document.getElementById('profileOrderHistoryList');
    const orderHistoryMore = document.getElementById('profileOrderHistoryMore');
    const btnShowAllOrders = document.getElementById('btnProfileShowAllOrders');
    const PROFILE_ORDER_PLACEHOLDER_IMG = 'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=120&h=120&fit=crop';
    const buildOrderRow = (o) => {
      const offer = typeof offers !== 'undefined' && offers ? offers.find(x => x.id === o.dishId || x.id === o.offerId) : null;
      const data = offer ? normalizeOffer(offer) : {};
      const imgUrl = data.imageUrl || data.img || PROFILE_ORDER_PLACEHOLDER_IMG;
      const category = data.category || data.diet || '';
      const catLabel = CAT_MAP[category] || category || '';
      const catEmoji = CAT_EMOJI[category] || CAT_EMOJI[catLabel] || 'ðŸ½ï¸';
      const allergens = (data.allergens || []).slice(0, 4);
      const allergenPills = allergens.map(a => {
        const label = typeof a === 'string' ? a : (a && a.label) || '';
        const word = label ? (typeof allergenFirstWord === 'function' ? allergenFirstWord(label) : String(label).trim().split(/\s+/)[0]) : '';
        return word ? word.charAt(0).toUpperCase() : '';
      }).filter(Boolean);
      const dateStr = o.pickupDate || (o.createdAt ? new Date(o.createdAt).toLocaleDateString('de-DE') : 'â€“');
      const priceStr = o.total != null ? euro(Number(o.total)/100) : (o.unitPrice != null ? euro(Number(o.unitPrice)/100) : 'â€“');
      const pillsHtml = (catLabel ? `<span style="display:inline-flex; align-items:center; gap:4px; padding:4px 8px; border-radius:8px; background:#f1f5f9; font-size:11px; font-weight:700; color:#475569;">${catEmoji} ${esc(catLabel)}</span>` : '') +
        (allergenPills.length ? allergenPills.map(c => `<span style="display:inline-flex; align-items:center; justify-content:center; min-width:20px; padding:2px 6px; border-radius:6px; background:#e2e8f0; font-size:11px; font-weight:700; color:#64748b;">${esc(c)}</span>`).join('') : '');
      return `
        <div class="profile-order-item" data-order-id="${esc(o.id)}" role="button" tabindex="0" style="padding:12px 0; border-bottom:1px solid rgba(0,0,0,.06); display:flex; align-items:flex-start; gap:12px; cursor:pointer; transition:background 0.2s ease; border-radius:12px; margin:0 -4px; padding-left:4px; padding-right:4px;" onmouseover="this.style.background='rgba(0,0,0,.04)'" onmouseout="this.style.background='transparent'">
          <div style="width:56px; height:56px; border-radius:12px; overflow:hidden; flex-shrink:0; background:#f0f0f0;">
            <img src="${esc(imgUrl)}" alt="" style="width:100%; height:100%; object-fit:cover;" loading="lazy" />
          </div>
          <div style="flex:1; min-width:0;">
            <div style="font-weight:800; font-size:15px; color:#1a1a1a;">${esc(o.dishName || o.summary || 'Bestellung')}</div>
            <div style="font-size:13px; color:#64748b; margin-top:2px;">${esc(o.providerName || 'Anbieter')}</div>
            ${pillsHtml ? `<div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:8px;">${pillsHtml}</div>` : ''}
          </div>
          <div style="text-align:right; flex-shrink:0;">
            <div style="font-size:12px; color:#64748b;">${esc(dateStr)}</div>
            <div style="font-weight:800; font-size:15px; color:var(--brand); margin-top:2px;">${esc(priceStr)}</div>
            <i data-lucide="chevron-right" style="width:18px; height:18px; color:#94a3b8; margin-top:4px; display:block; margin-left:auto;"></i>
          </div>
        </div>
      `;
    };
    if(orderHistoryEl){
      const allOrdersForHistory = loadOrders();
      const sorted = (allOrdersForHistory || []).slice().sort((a, b) => (b.createdAt || b.updatedAt || 0) - (a.createdAt || a.updatedAt || 0));
      if(sorted.length === 0){
        orderHistoryEl.innerHTML = '<p style="margin:0; color:#64748b; font-size:14px;">Noch keine Bestellungen.</p>';
        if(orderHistoryMore) orderHistoryMore.style.display = 'none';
        if(orderHistoryMore) orderHistoryMore.innerHTML = '';
        if(btnShowAllOrders) btnShowAllOrders.style.display = 'none';
      } else {
        const showCount = 3;
        const first = sorted.slice(0, showCount);
        const rest = sorted.slice(showCount);
        orderHistoryEl.innerHTML = first.map(buildOrderRow).join('');
        if(orderHistoryMore){
          orderHistoryMore.innerHTML = rest.map(buildOrderRow).join('');
          orderHistoryMore.style.display = rest.length > 0 ? 'none' : 'none';
        }
        if(btnShowAllOrders){
          btnShowAllOrders.style.display = rest.length > 0 ? 'block' : 'none';
          btnShowAllOrders.textContent = 'Alle Bestellungen anzeigen';
          btnShowAllOrders.onclick = function(){
            if(orderHistoryMore && orderHistoryMore.style.display === 'none'){
              orderHistoryMore.style.display = 'flex';
              orderHistoryMore.style.flexDirection = 'column';
              orderHistoryMore.style.gap = '0';
              btnShowAllOrders.textContent = 'Weniger anzeigen';
            } else {
              orderHistoryMore.style.display = 'none';
              btnShowAllOrders.textContent = 'Alle Bestellungen anzeigen';
            }
          };
        }
        if(!orderHistoryEl._orderDetailBound){
          orderHistoryEl._orderDetailBound = true;
          const handleOrderClick = (container) => {
            if(!container) return;
            container.addEventListener('click', function(e){
              const row = e.target.closest('.profile-order-item');
              if(!row) return;
              const id = row.getAttribute('data-order-id');
              if(id) showOrderDetail(id);
            });
            container.addEventListener('keydown', function(e){
              if(e.key !== 'Enter' && e.key !== ' ') return;
              const row = e.target.closest('.profile-order-item');
              if(!row) return;
              const id = row.getAttribute('data-order-id');
              if(id){ e.preventDefault(); showOrderDetail(id); }
            });
          };
          handleOrderClick(orderHistoryEl);
          handleOrderClick(orderHistoryMore);
        }
        if(typeof lucide !== 'undefined') setTimeout(function(){ lucide.createIcons(); }, 50);
      }
    }
    
    // ErnÃ¤hrungs-Zentrale (PrÃ¤ferenzen)
    const dietSection = document.getElementById('profileDietSwitches');
    if(dietSection){
      if(!customer.dietaryPreferences) customer.dietaryPreferences = { vegan: false, vegetarian: false, glutenFree: false, lactoseFree: false };
      if(customer.reuseEnabled === undefined) customer.reuseEnabled = false;
      const prefs = customer.dietaryPreferences;
      
      const switches = [
        { key: 'vegan', label: 'Vegan', icon: 'leaf' },
        { key: 'vegetarian', label: 'Vegetarisch', icon: 'sprout' },
        { key: 'glutenFree', label: 'Glutenfrei', icon: 'wheat-off' },
        { key: 'lactoseFree', label: 'Laktosefrei', icon: 'milk-off' }
      ];
      
      dietSection.innerHTML = switches.map(s => {
        const isActive = prefs[s.key] || false;
        return `
          <div style="display:flex; align-items:center; justify-content:space-between; padding:16px; background:${isActive ? 'rgba(255,215,0,0.1)' : '#f8f9fa'}; border-radius:16px; border:2px solid ${isActive ? '#FFD700' : 'transparent'}; transition:all 0.2s ease;">
            <div style="flex:1; min-width:0;">
              <div style="display:flex; align-items:center; gap:10px;">
                <i data-lucide="${s.icon}" style="width:20px;height:20px; color:${isActive ? '#FFD700' : '#666'};"></i>
                <span style="font-weight:700; font-size:15px; color:#2D3436;">${esc(s.label)}</span>
              </div>
            </div>
            <label style="position:relative; width:52px; height:32px; cursor:pointer; flex-shrink:0;">
              <input type="checkbox" ${isActive ? 'checked' : ''} style="opacity:0; position:absolute; width:0; height:0;" onchange="toggleDietaryPreference('${s.key}', this.checked);">
              <span style="position:absolute; top:0; left:0; right:0; bottom:0; background:${isActive ? '#FFD700' : '#ccc'}; border-radius:999px; transition:all 0.3s ease;">
                <span style="position:absolute; top:2px; left:${isActive ? '22px' : '2px'}; width:28px; height:28px; background:#fff; border-radius:50%; box-shadow:0 2px 4px rgba(0,0,0,0.2); transition:all 0.3s ease;"></span>
              </span>
            </label>
          </div>
        `;
      }).join('');
    }
    
    // Mehrweg-Option (Nachhaltigkeit)
    const reuseSection = document.getElementById('profileReuseSwitch');
    const ecoBadge = document.getElementById('profileEcoBadge');
    const ecoBadgeCount = document.getElementById('ecoBadgeCount');
    
    if(reuseSection){
      if(!customer.reuseEnabled) customer.reuseEnabled = false;
      const isReuseEnabled = customer.reuseEnabled || false;
      
      // ZÃ¤hle Mehrweg-Nutzungen aus Bestellungen (loadOrders)
      const ordersForReuse = loadOrders();
      const reuseCount = Array.isArray(ordersForReuse) ? ordersForReuse.filter(o => o.reuseEnabled === true).length : 0;
      
      reuseSection.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; padding:16px; background:${isReuseEnabled ? 'rgba(31,157,85,0.1)' : '#f8f9fa'}; border-radius:16px; border:2px solid ${isReuseEnabled ? '#1f9d55' : 'transparent'}; transition:all 0.2s ease;">
          <div style="flex:1; min-width:0;">
            <div style="display:flex; align-items:center; gap:10px;">
              <span style="font-size:18px;">ðŸ”„</span>
              <span style="font-weight:700; font-size:15px; color:#2D3436;">Mehrweg</span>
            </div>
          </div>
          <label style="position:relative; width:52px; height:32px; cursor:pointer; flex-shrink:0;">
            <input type="checkbox" ${isReuseEnabled ? 'checked' : ''} style="opacity:0; position:absolute; width:0; height:0;" onchange="toggleReuseOption(this.checked);">
            <span style="position:absolute; top:0; left:0; right:0; bottom:0; background:${isReuseEnabled ? '#1f9d55' : '#ccc'}; border-radius:999px; transition:all 0.3s ease;">
              <span style="position:absolute; top:2px; left:${isReuseEnabled ? '22px' : '2px'}; width:28px; height:28px; background:#fff; border-radius:50%; box-shadow:0 2px 4px rgba(0,0,0,0.2); transition:all 0.3s ease;"></span>
            </span>
          </label>
        </div>
      `;
      
      // Eco-Badge anzeigen wenn aktiviert
      if(ecoBadge && ecoBadgeCount){
        if(isReuseEnabled && reuseCount > 0){
          ecoBadge.style.display = 'block';
          ecoBadgeCount.textContent = reuseCount;
        } else {
          ecoBadge.style.display = 'none';
        }
      }
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }
  
  // ErnÃ¤hrungs-PrÃ¤ferenz Toggle
  function toggleDietaryPreference(key, value){
    if(!customer.dietaryPreferences) customer.dietaryPreferences = { vegan: false, vegetarian: false, glutenFree: false, lactoseFree: false };
    if(customer.reuseEnabled === undefined) customer.reuseEnabled = false;
    customer.dietaryPreferences[key] = value;
    save(LS.customer, customer);
    updateProfileView();
    
    // Feed sofort neu rendern mit Filter
    if(typeof renderDiscover === 'function'){
      renderDiscover();
    }
  }
  
  // Mehrweg-Option Toggle
  function toggleReuseOption(enabled){
    customer.reuseEnabled = enabled;
    save(LS.customer, customer);
    updateProfileView();
    
    if(enabled){
      showToast('Mehrweg-Option aktiviert ðŸŒ±', 2000);
    } else {
      showToast('Mehrweg-Option deaktiviert', 1500);
    }
  }
  
  // Support-Actions Handler
  function handleSupportAction(action){
    if(action === 'openHelp'){
      // Kunden-Hilfe: info@mittagio.de (Mike Quach, Rudersberg)
      showToast('Kunden-Hilfe: info@mittagio.de', 2000);
      // E-Mail-Client Ã¶ffnen
      window.location.href = 'mailto:info@mittagio.de?subject=Hilfe%20bei%20Mittagio';
    } else if(action === 'showDatenschutz'){
      showView(views.legalDatenschutz);
    } else if(action === 'showImpressum'){
      showView(views.legalImpressum);
    } else if(action === 'logout'){
      if(confirm('MÃ¶chtest du dich wirklich abmelden?')){
        customer.loggedIn = false;
        customer.name = null;
        customer.email = null;
        save(LS.customer, customer);
        updateProfileView();
      }
    }
  }
  
  // Provider Login Modal
  function showProviderLoginModal(){
    const providerLoginBd = document.getElementById('providerLoginBd');
    const providerLoginSheet = document.getElementById('providerLoginSheet');
    if(providerLoginBd) providerLoginBd.style.display = 'block';
    if(providerLoginSheet) providerLoginSheet.style.display = 'block';
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(() => lucide.createIcons(), 50);
    }
  }
  
  function closeProviderLoginModal(){
    const providerLoginBd = document.getElementById('providerLoginBd');
    const providerLoginSheet = document.getElementById('providerLoginSheet');
    if(providerLoginBd) providerLoginBd.style.display = 'none';
    if(providerLoginSheet) providerLoginSheet.style.display = 'none';
    // Felder leeren
    const emailField = document.getElementById('providerLoginEmail');
    const passField = document.getElementById('providerLoginPass');
    if(emailField) emailField.value = '';
    if(passField) passField.value = '';
  }
  
  // Provider Login Handler
  const btnProviderLoginModal = document.getElementById('btnProviderLoginModal');
  if(btnProviderLoginModal){
    btnProviderLoginModal.onclick = () => {
      const email = document.getElementById('providerLoginEmail').value.trim();
      const pass = document.getElementById('providerLoginPass').value.trim();
      if(!email || !pass){
        showToast('Bitte E-Mail und Passwort eingeben.', 2000);
        return;
      }
      
      // Session-Check: PrÃ¼fe ob bereits eine aktive Session existiert
      const existingSession = load(LS.providerSession, null);
      const currentSessionId = load('mittagio_current_session_id', null);
      
      // Wenn bereits eine Session existiert und es ist nicht die aktuelle Session
      if(existingSession && existingSession.email === email && existingSession.sessionId !== currentSessionId){
        // Login-Konflikt: Zeige Modal
        openLoginConflictModal(email, () => {
          // Ãœbernahme bestÃ¤tigt: Neue Session erstellen
          performProviderLogin(email);
        });
        return;
      }
      
      // Normale Login-DurchfÃ¼hrung
      performProviderLogin(email);
    };
  }
  
  // Provider-Login durchfÃ¼hren (mit Session-Management)
  function performProviderLogin(email){
    const newSessionId = cryptoId();
    const sessionData = {
      email: email,
      sessionId: newSessionId,
      createdAt: Date.now(),
      lastActivity: Date.now()
    };
    save(LS.providerSession, sessionData);
    save('mittagio_current_session_id', newSessionId);
    provider.loggedIn = true;
    provider.email = email;
    save(LS.provider, provider);
    closeProviderLoginModal();
    showToast('Erfolgreich eingeloggt! ðŸŽ‰', 2000);
    if(typeof updateProfileView === 'function') updateProfileView();
    setMode('provider', { skipView: true });
    if(provider.onboardingCompleted){
      showProviderHome();
    } else {
      showOnboardingEntry(!!load(LS.onboardingDraft, null));
    }
  }
  
  // Login-Konflikt Modal Ã¶ffnen
  function openLoginConflictModal(email, onConfirm){
    const bd = document.getElementById('loginConflictBd');
    const sheet = document.getElementById('loginConflictSheet');
    if(bd) bd.classList.add('active');
    if(sheet) sheet.classList.add('active');
    
    // Ãœbernahme-Button Handler
    const btnTakeover = document.getElementById('btnLoginConflictTakeover');
    if(btnTakeover){
      btnTakeover.onclick = () => {
        closeLoginConflictModal();
        if(onConfirm) onConfirm();
      };
    }
    
    // Icons rendern
    if(typeof lucide !== 'undefined'){
      setTimeout(() => lucide.createIcons(), 50);
    }
  }
  
  // Login-Konflikt Modal schlieÃŸen
  function closeLoginConflictModal(){
    const bd = document.getElementById('loginConflictBd');
    const sheet = document.getElementById('loginConflictSheet');
    if(bd) bd.classList.remove('active');
    if(sheet) sheet.classList.remove('active');
  }
  
  // Session-ValiditÃ¤t prÃ¼fen (bei App-Start und regelmÃ¤ÃŸig)
  function checkSessionValidity(){
    if(mode !== 'provider' || !provider.loggedIn) return true;
    
    const currentSessionId = load('mittagio_current_session_id', null);
    const storedSession = load(LS.providerSession, null);
    
    // Wenn keine Session-ID vorhanden oder Session nicht mehr gÃ¼ltig
    if(!currentSessionId || !storedSession || storedSession.sessionId !== currentSessionId){
      // Session ungÃ¼ltig: Ausloggen
      provider.loggedIn = false;
      save(LS.provider, provider);
      localStorage.removeItem('mittagio_current_session_id');
      showToast('Deine Sitzung wurde auf einem anderen GerÃ¤t beendet.', 3000);
      setMode('customer');
      showProfile();
      return false;
    }
    
    // Session aktualisieren (lastActivity) - nur wenn noch aktiv
    if(storedSession.email === provider.email){
      storedSession.lastActivity = Date.now();
      save(LS.providerSession, storedSession);
    }
    
    return true;
  }
  
  // Session-AktivitÃ¤t aktualisieren (bei User-Interaktionen)
  function updateSessionActivity(){
    if(mode === 'provider' && provider.loggedIn){
      const storedSession = load(LS.providerSession, null);
      const currentSessionId = load('mittagio_current_session_id', null);
      if(storedSession && storedSession.sessionId === currentSessionId){
        storedSession.lastActivity = Date.now();
        save(LS.providerSession, storedSession);
      }
    }
  }
  
  // Session-AktivitÃ¤t bei wichtigen Aktionen aktualisieren
  // (wird bei renderProviderHome, renderProviderPickups, etc. aufgerufen)
  
  // Session-Check regelmÃ¤ÃŸig durchfÃ¼hren (alle 30 Sekunden)
  setInterval(() => {
    if(mode === 'provider' && provider.loggedIn){
      checkSessionValidity();
    }
  }, 30000);
  
  // Enter-Taste im Login-Modal
  const providerLoginEmail = document.getElementById('providerLoginEmail');
  const providerLoginPass = document.getElementById('providerLoginPass');
  if(providerLoginEmail && providerLoginPass){
    [providerLoginEmail, providerLoginPass].forEach(field => {
      field.onkeydown = (e) => {
        if(e.key === 'Enter'){
          e.preventDefault();
          if(btnProviderLoginModal) btnProviderLoginModal.click();
        }
      };
    });
  }

  // Logout-Handler (wenn vorhanden)
  const btnUnifiedLogout = document.getElementById('btnUnifiedLogout');
  if(btnUnifiedLogout){
    btnUnifiedLogout.onclick=()=>{
      customer.loggedIn = false;
      customer.name = null;
      customer.email = null;
      save(LS.customer, customer);
      updateProfileView();
      showProfile();
    };
  }

  // Provider Switch (wenn vorhanden)
  const btnSwitchToProvider = document.getElementById('btnSwitchToProvider');
  if(btnSwitchToProvider){
    btnSwitchToProvider.onclick=()=>{
      if(!provider.loggedIn){
        setMode('provider');
      } else {
        showProviderHome();
      }
    };
  }

  // --- Hybrid Onboarding System ---
  let onboardingDraftDish = load(LS.onboardingDraft, null);
  
  function showOnboardingEntry(hasDraft = false){
    showView(views.providerOnboardingEntry);
    
    // Show returning banner if draft exists
    const entryPanel = document.querySelector('#v-provider-onboarding-entry .panel');
    if(hasDraft && onboardingDraftDish && entryPanel){
      const banner = document.createElement('div');
      banner.style.cssText = 'margin-bottom:24px; padding:16px; background:#f0f7f0; border-radius:12px; border:1px solid #4caf50;';
      banner.innerHTML = `
        <div style="font-weight:600; font-size:16px; margin-bottom:8px; color:#2e7d32;">Du hast ein Gericht vorbereitet</div>
        <div style="font-size:14px; line-height:1.4; margin-bottom:12px; color:#666;">MÃ¶chtest du weitermachen?</div>
        <div style="display:flex; gap:8px;">
          <button class="btn secondary" type="button" id="btnOnboardingResume" style="flex:1; min-height:44px;">Weiter bearbeiten</button>
          <button class="btn ghost" type="button" id="btnOnboardingDiscard" style="flex:1; min-height:44px;">Verwerfen</button>
        </div>
      `;
      entryPanel.insertBefore(banner, entryPanel.firstChild);
      
      const btnResume = document.getElementById('btnOnboardingResume');
      const btnDiscard = document.getElementById('btnOnboardingDiscard');
      if(btnResume) btnResume.onclick = () => showOnboardingFirstDish(true);
      if(btnDiscard) btnDiscard.onclick = () => {
        onboardingDraftDish = null;
        save(LS.onboardingDraft, null);
        showOnboardingEntry(false);
      };
    }
  }
  
  function showOnboardingFirstDish(prefill = false){
    showView(views.providerOnboardingFirstDish);
    
    // Push state for browser back button
    pushViewState({onboarding: 'first-dish'}, location.pathname);
    
    if(prefill && onboardingDraftDish){
      const dishName = document.getElementById('onboardingDishName');
      const timeStart = document.getElementById('onboardingPickupTimeStart');
      const timeEnd = document.getElementById('onboardingPickupTimeEnd');
      const photoPreview = document.getElementById('onboardingPhotoPreview');
      const photoPreviewImg = document.getElementById('onboardingPhotoPreviewImg');
      
      if(dishName) dishName.value = onboardingDraftDish.dishName || '';
      if(timeStart) timeStart.value = onboardingDraftDish.pickupTimeStart || '';
      if(timeEnd) timeEnd.value = onboardingDraftDish.pickupTimeEnd || '';
      if(onboardingDraftDish.photoData && photoPreview && photoPreviewImg){
        photoPreview.style.display = 'block';
        photoPreviewImg.src = onboardingDraftDish.photoData;
      }
    }
    
    // Photo upload handler (recreate each time to avoid duplicates)
    const existingInput = document.getElementById('onboardingPhotoInput');
    if(existingInput) existingInput.remove();
    
    const photoInput = document.createElement('input');
    photoInput.id = 'onboardingPhotoInput';
    photoInput.type = 'file';
    photoInput.accept = 'image/*';
    photoInput.style.display = 'none';
    document.body.appendChild(photoInput);
    
    // Profi-Galerie System
    const foodLibrary = {
      klassiker: [
        {id: 'schnitzel', name: 'Schnitzel', url: 'https://images.unsplash.com/photo-1562967914-608f82629710?auto=format&fit=crop&w=800&q=80', allergens: ['Gluten', 'Ei']},
        {id: 'bratwurst', name: 'Bratwurst', url: 'https://images.unsplash.com/photo-1528607929212-2636ec44253e?auto=format&fit=crop&w=800&q=80', allergens: ['Gluten']},
        {id: 'roulade', name: 'Roulade', url: 'https://images.unsplash.com/photo-1546833999-b9f581a1996d?auto=format&fit=crop&w=800&q=80', allergens: ['Gluten']}
      ],
      deftig: [
        {id: 'gulasch', name: 'Gulasch', url: 'https://images.unsplash.com/photo-1563379091339-03246963d19c?auto=format&fit=crop&w=800&q=80', allergens: []},
        {id: 'braten', name: 'Braten', url: 'https://images.unsplash.com/photo-1544025162-d76694265947?auto=format&fit=crop&w=800&q=80', allergens: []},
        {id: 'kassler', name: 'Kassler', url: 'https://images.unsplash.com/photo-1544025162-d76694265947?auto=format&fit=crop&w=800&q=80', allergens: []}
      ],
      eintoepfe: [
        {id: 'linsensuppe', name: 'Linsensuppe', url: 'https://images.unsplash.com/photo-1547592166-23ac45744acd?auto=format&fit=crop&w=800&q=80', allergens: []},
        {id: 'erbsensuppe', name: 'Erbsensuppe', url: 'https://images.unsplash.com/photo-1547592166-23ac45744acd?auto=format&fit=crop&w=800&q=80', allergens: []},
        {id: 'kartoffelsuppe', name: 'Kartoffelsuppe', url: 'https://images.unsplash.com/photo-1547592166-23ac45744acd?auto=format&fit=crop&w=800&q=80', allergens: []}
      ],
      modern: [
        {id: 'bowl', name: 'Bowl', url: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=800&q=80', allergens: []},
        {id: 'wrap', name: 'Wrap', url: 'https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=800&q=80', allergens: ['Gluten']},
        {id: 'salat', name: 'Salat', url: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=800&q=80', allergens: []}
      ]
    };
    
    let selectedProPhoto = null;
    let recentProPhotos = JSON.parse(localStorage.getItem('mittagio_recent_pro_photos') || '[]');
    
    // Profi-Galerie Funktionen (global, damit onclick funktioniert)
    window.openProPhotoGallery = function(){
      const proPhotoBd = document.getElementById('proPhotoBd');
      const proPhotoSheet = document.getElementById('proPhotoSheet');
      if(proPhotoBd) proPhotoBd.style.display = 'block';
      if(proPhotoSheet) proPhotoSheet.style.display = 'flex';
      window.renderProPhotoGallery('all');
    };
    
    window.closeProPhotoGallery = function(){
      const proPhotoBd = document.getElementById('proPhotoBd');
      const proPhotoSheet = document.getElementById('proPhotoSheet');
      if(proPhotoBd) proPhotoBd.style.display = 'none';
      if(proPhotoSheet) proPhotoSheet.style.display = 'none';
    };
    
    window.renderProPhotoGallery = function(category){
      const gridEl = document.getElementById('proPhotoGrid');
      if(!gridEl) return;
      
      // Kategorien-Tabs aktualisieren
      document.querySelectorAll('.pro-photo-category-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.category === category);
        tab.style.background = tab.dataset.category === category ? '#FFD700' : '#f5f5f5';
        tab.style.color = tab.dataset.category === category ? '#2D3436' : '#666';
      });
      
      // Zuletzt genutzt anzeigen (wenn vorhanden)
      const recentEl = document.getElementById('proPhotoRecent');
      const recentGridEl = document.getElementById('proPhotoRecentGrid');
      if(recentEl && recentGridEl){
        if(recentProPhotos.length > 0 && category === 'all'){
          recentEl.style.display = 'block';
          recentGridEl.innerHTML = recentProPhotos.slice(0, 4).map(photo => {
            return `
              <div onclick="selectProPhoto('${photo.id}', '${esc(photo.url)}', '${esc(photo.category)}');" style="aspect-ratio:1; border-radius:12px; overflow:hidden; cursor:pointer; border:2px solid #FFD700;">
                <img src="${esc(photo.url)}" alt="${esc(photo.name)}" style="width:100%; height:100%; object-fit:cover;" />
              </div>
            `;
          }).join('');
        } else {
          recentEl.style.display = 'none';
        }
      }
      
      // Galerie rendern
      let photos = [];
      if(category === 'all'){
        Object.values(foodLibrary).flat().forEach(p => photos.push({...p, category: Object.keys(foodLibrary).find(k => foodLibrary[k].includes(p))}));
      } else {
        photos = foodLibrary[category] || [];
      }
      
      gridEl.innerHTML = photos.map(photo => {
        const cat = (photo.category || category);
        return `
          <div onclick="selectProPhoto('${photo.id}', '${esc(photo.url)}', '${cat}');" style="aspect-ratio:1; border-radius:12px; overflow:hidden; cursor:pointer; border:2px solid #e7e1d5; transition:all 0.2s;" onmouseover="this.style.borderColor='#FFD700'; this.style.transform='scale(1.05)';" onmouseout="this.style.borderColor='#e7e1d5'; this.style.transform='scale(1)';">
            <img src="${esc(photo.url)}" alt="${esc(photo.name)}" style="width:100%; height:100%; object-fit:cover;" />
          </div>
        `;
      }).join('');
    };
    
    window.selectProPhoto = function(photoId, photoUrl, category){
      selectedProPhoto = {id: photoId, url: photoUrl, category: category, isStockPhoto: true};
      
      const catKey = (typeof category === 'string' && category !== 'all') ? category : Object.keys(foodLibrary).find(k => (foodLibrary[k] || []).some(p => p.id === photoId)) || 'all';
      const photoName = (foodLibrary[catKey] || []).find(p => p.id === photoId)?.name || 'Gericht';
      recentProPhotos = recentProPhotos.filter(p => p.id !== photoId);
      recentProPhotos.unshift({id: photoId, url: photoUrl, category: catKey, name: photoName});
      recentProPhotos = recentProPhotos.slice(0, 10);
      localStorage.setItem('mittagio_recent_pro_photos', JSON.stringify(recentProPhotos));
      
      window.closeProPhotoGallery();
      
      // Immer durch Foto-Editor: Filter + Zuschnitt. Listing vs Onboarding unterscheiden.
      (async ()=>{
        let dataUrl = photoUrl;
        if(/^https?:\/\//i.test(photoUrl)){
          try { dataUrl = await urlToDataUrl(photoUrl); } catch(e){
            if(typeof showToast === 'function') showToast('Foto konnte nicht geladen werden.');
            return;
          }
        }
        if(window.proPhotoContext === 'listing'){
          window.proPhotoContext = null;
          await openPhotoEditor(dataUrl);
          if(typeof showToast === 'function') showToast('Profi-Foto Ã¼bernommen.');
          return;
        }
        await openPhotoEditor(dataUrl, {
          onAccept: (url)=>{
            if(typeof onboardingDraftDish === 'undefined') return;
            onboardingDraftDish = onboardingDraftDish || {};
            onboardingDraftDish.photoData = url;
            if(typeof save === 'function' && typeof LS !== 'undefined') save(LS.onboardingDraft, onboardingDraftDish);
            const previewEl = document.getElementById('onboardingPhotoPreview');
            const previewImgEl = document.getElementById('onboardingPhotoPreviewImg');
            const watermarkEl = document.getElementById('onboardingPhotoWatermark');
            if(previewEl && previewImgEl){
              previewEl.style.display = 'block';
              previewImgEl.src = url;
              previewImgEl.style.filter = '';
              if(watermarkEl) watermarkEl.style.display = 'block';
            }
            if(typeof showToast === 'function') showToast('Profi-Foto Ã¼bernommen.');
          }
        });
      })();
    };
    
    // Kategorien-Tab Handler
    document.querySelectorAll('.pro-photo-category-tab').forEach(tab => {
      tab.onclick = () => {
        window.renderProPhotoGallery(tab.dataset.category);
      };
    });
    
    // Profi-Galerie Button Handler
    const btnOnboardingChooseProPhoto = document.getElementById('btnOnboardingChooseProPhoto');
    if(btnOnboardingChooseProPhoto){
      btnOnboardingChooseProPhoto.onclick = () => {
        window.openProPhotoGallery();
      };
    }
    
    const btnAddPhoto = document.getElementById('btnOnboardingAddPhoto');
    if(btnAddPhoto){
      btnAddPhoto.onclick = () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.capture = 'environment';
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if(!file) return;
          const dataUrl = await toDataUrl(file);
          await openPhotoEditor(dataUrl, {
            onAccept: (url) => {
              if(typeof onboardingDraftDish === 'undefined') return;
              onboardingDraftDish = onboardingDraftDish || {};
              onboardingDraftDish.photoData = url;
              if(typeof save === 'function' && typeof LS !== 'undefined') save(LS.onboardingDraft, onboardingDraftDish);
              const previewEl = document.getElementById('onboardingPhotoPreview');
              const previewImgEl = document.getElementById('onboardingPhotoPreviewImg');
              const watermarkEl = document.getElementById('onboardingPhotoWatermark');
              if(previewEl && previewImgEl){
                previewEl.style.display = 'block';
                previewImgEl.src = url;
                previewImgEl.style.filter = '';
                if(watermarkEl) watermarkEl.style.display = 'none';
              }
              selectedProPhoto = null;
              if(typeof showToast === 'function') showToast('Foto Ã¼bernommen.');
            }
          });
        };
        input.click();
      };
    }
    
    // photoInput.onchange
    const existingPhotoInput = document.getElementById('photoInput');
    if(existingPhotoInput){
      existingPhotoInput.onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const dataUrl = await toDataUrl(file);
        await openPhotoEditor(dataUrl, {
          onAccept: (url) => {
            if(!onboardingDraftDish) onboardingDraftDish = {};
            onboardingDraftDish.photoData = url;
            if(typeof save === 'function' && typeof LS !== 'undefined') save(LS.onboardingDraft, onboardingDraftDish);
            const photoPreview = document.getElementById('onboardingPhotoPreview');
            const photoPreviewImg = document.getElementById('onboardingPhotoPreviewImg');
            if(photoPreview && photoPreviewImg){
              photoPreview.style.display = 'block';
              photoPreviewImg.src = url;
            }
            if(typeof showToast === 'function') showToast('Foto Ã¼bernommen.');
          }
        });
      };
    }
    
    // Warn before leaving if changes exist
    let hasChanges = false;
    const inputs = ['onboardingDishName', 'onboardingPickupTimeStart', 'onboardingPickupTimeEnd'];
    inputs.forEach(id => {
      const el = document.getElementById(id);
      if(el){
        el.oninput = () => { hasChanges = true; };
      }
    });
    
    window.onbeforeunload = (e) => {
      if(hasChanges && onboardingDraftDish){
        e.preventDefault();
        e.returnValue = '';
      }
    };
  }
  
  function showOnboardingSignup(){
    showView(views.providerOnboardingSignup);
    pushViewState({onboarding: 'signup'}, location.pathname);
  }
  
  function showOnboardingBusiness(){
    showView(views.providerOnboardingBusiness);
    pushViewState({onboarding: 'business'}, location.pathname);
  }
  
  function showOnboardingPreview(dishId){
    showView(views.providerOnboardingPreview);
    pushViewState({onboarding: 'preview'}, location.pathname);
    
    // Load saved dish and show preview
    const savedDish = dishId ? cookbook.find(c => c.id === dishId) : cookbook.find(c => c.providerId === providerId());
    const previewCard = document.getElementById('onboardingPreviewCard');
    if(previewCard && (savedDish || onboardingDraftDish)){
      const dish = savedDish || {
        dish: onboardingDraftDish.dishName,
        category: 'Vegetarisch',
        photoData: onboardingDraftDish.photoData || null
      };
      
      const preview = offerCard({
        id: dish.id || 'preview',
        dish: dish.dish,
        category: dish.category || 'Vegetarisch',
        price: 0, // No price in preview
        pickupWindow: savedDish?.pickupWindow || `${onboardingDraftDish?.pickupTimeStart || '11:30'} â€“ ${onboardingDraftDish?.pickupTimeEnd || '14:30'}`,
        imageUrl: dish.photoData || dish.imageUrl || '',
        providerName: provider.profile?.name || 'Dein Betrieb',
        hasPickupCode: false, // No abholcode in preview
        dineInPossible: false
      }, {interactive: false});
      
      previewCard.innerHTML = '';
      previewCard.appendChild(preview);
      
      // Disable all interactive elements in preview
      preview.querySelectorAll('button, a').forEach(el => {
        el.style.pointerEvents = 'none';
        el.style.opacity = '0.5';
      });
      
      // Update icons
      if(typeof lucide !== 'undefined'){
        setTimeout(() => lucide.createIcons(), 50);
      }
    }
  }
  
  // Onboarding Event Handlers
  const btnOnboardingEntryStart = document.getElementById('btnOnboardingEntryStart');
  if(btnOnboardingEntryStart) {
    btnOnboardingEntryStart.onclick = () => {
      // Direkt ins Kochbuch fÃ¼hren (erstes Gericht erstellen)
      showOnboardingFirstDish(false);
    };
  }
  
  const btnOnboardingEntryLater = document.getElementById('btnOnboardingEntryLater');
  if(btnOnboardingEntryLater) btnOnboardingEntryLater.onclick = () => {
    if(provider.loggedIn){
      showProviderHome();
    } else {
      showView(views.providerLogin);
    }
  };
  
  const btnOnboardingFirstDishBack = document.getElementById('btnOnboardingFirstDishBack');
  if(btnOnboardingFirstDishBack) btnOnboardingFirstDishBack.onclick = () => {
    const dishName = document.getElementById('onboardingDishName')?.value.trim();
    const timeStart = document.getElementById('onboardingPickupTimeStart')?.value;
    const timeEnd = document.getElementById('onboardingPickupTimeEnd')?.value;
    
    // Check if user has made changes
    if(dishName || timeStart || timeEnd || onboardingDraftDish?.photoData){
      if(confirm('SpÃ¤ter weitermachen?\n\nDein Gericht ist noch nicht gespeichert.')){
        showOnboardingEntry(!!onboardingDraftDish);
      }
    } else {
      showOnboardingEntry(!!onboardingDraftDish);
    }
  };
  
  const btnOnboardingFirstDishNext = document.getElementById('btnOnboardingFirstDishNext');
  if(btnOnboardingFirstDishNext) btnOnboardingFirstDishNext.onclick = () => {
    const dishName = document.getElementById('onboardingDishName')?.value.trim();
    const dishPrice = document.getElementById('onboardingDishPrice')?.value.trim();
    const dishDiet = document.querySelector('input[name="dishDiet"]:checked')?.value;
    const dishDesc = document.getElementById('onboardingDishDesc')?.value.trim();
    const timeStart = document.getElementById('onboardingPickupTimeStart')?.value;
    const timeEnd = document.getElementById('onboardingPickupTimeEnd')?.value;
    
    if(!dishName || !dishPrice || !timeStart || !timeEnd || !dishDiet){
      alert('Bitte fÃ¼lle alle Pflichtfelder aus (Name, Preis, Kategorie, Zeit).');
      return;
    }
    
    // Save draft
    onboardingDraftDish = {
      dishName,
      dishPrice,
      dishDiet,
      dishDesc,
      pickupTimeStart: timeStart,
      pickupTimeEnd: timeEnd,
      photoData: onboardingDraftDish?.photoData || null
    };
    save(LS.onboardingDraft, onboardingDraftDish);
    
    // Check where to go
    if(provider.loggedIn){
      // Wenn eingeloggt: AbkÃ¼rzung zur Vorschau (Ã¼berspringe Account & Business)
      showOnboardingPreview(null);
    } else {
      // Wenn neu: Konto erstellen
      showOnboardingSignup();
    }
  };

  // --- AUTO-SAVE / CACHE FOR ONBOARDING STEP 1 ---
  const obCacheIds = ['onboardingDishName', 'onboardingDishPrice', 'onboardingDishDesc', 'onboardingPickupTimeStart', 'onboardingPickupTimeEnd'];
  obCacheIds.forEach(id => {
    const el = document.getElementById(id);
    if(el){
      const cached = localStorage.getItem('cache_' + id);
      if(cached) el.value = cached;
      el.addEventListener('input', () => localStorage.setItem('cache_' + id, el.value));
    }
  });
  // Radio Buttons Cache (Kategorie)
  const dietRadios = document.querySelectorAll('input[name="dishDiet"]');
  const cachedDiet = localStorage.getItem('cache_dishDiet');
  if(cachedDiet) {
    dietRadios.forEach(r => { if(r.value === cachedDiet) r.checked = true; });
  }
  dietRadios.forEach(r => {
    r.addEventListener('change', () => localStorage.setItem('cache_dishDiet', r.value));
  });
  // ------------------------------------------------
  
  const btnOnboardingSignupCreate = document.getElementById('btnOnboardingSignupCreate');
  if(btnOnboardingSignupCreate) btnOnboardingSignupCreate.onclick = () => {
    const email = document.getElementById('onboardingEmail')?.value.trim();
    const password = document.getElementById('onboardingPassword')?.value.trim();
    
    if(!email || !password || password.length < 8){
      alert('Bitte gib eine gÃ¼ltige E-Mail und ein Passwort (mind. 8 Zeichen) ein.');
      return;
    }
    
    // Create account
    provider.loggedIn = true;
    provider.email = email;
    provider.onboardingCompleted = false; // Will be set to true after preview
    save(LS.provider, provider);
    
    // Save dish to cookbook
    if(onboardingDraftDish){
      const newDish = {
        id: cryptoId(),
        providerId: providerId(),
        dish: onboardingDraftDish.dishName,
        category: onboardingDraftDish.dishDiet || 'Vegetarisch',
        description: onboardingDraftDish.dishDesc || '',
        price: parseFloat(onboardingDraftDish.dishPrice.replace(',', '.')) || 0,
        pickupWindow: `${onboardingDraftDish.pickupTimeStart} â€“ ${onboardingDraftDish.pickupTimeEnd}`,
        photoData: onboardingDraftDish.photoData || '',
        hasPickupCode: false, // No abholcode in onboarding
        dineInPossible: false,
        allergens: [],
        extras: [],
        reuse: {enabled: false, deposit: 0},
        createdAt: Date.now(),
        lastUsed: null
      };
      cookbook.push(newDish);
      save(LS.cookbook, cookbook);
      
      // Clear draft after successful save
      onboardingDraftDish = null;
      save(LS.onboardingDraft, null);
      
      // Clear Input Cache
      ['onboardingDishName', 'onboardingDishPrice', 'onboardingPickupTimeStart', 'onboardingPickupTimeEnd'].forEach(id => localStorage.removeItem('cache_' + id));

      // Proceed to business screen
      showOnboardingBusiness();
    }
  };
  
  const btnOnboardingSignupLater = document.getElementById('btnOnboardingSignupLater');
  if(btnOnboardingSignupLater) btnOnboardingSignupLater.onclick = () => {
    // Keep draft, go to login
    showView(views.providerLogin);
  };

  // --- AUTO-SAVE STEP 2 ---
  const elEmail = document.getElementById('onboardingEmail');
  if(elEmail){
    const cachedEmail = localStorage.getItem('cache_onboardingEmail');
    if(cachedEmail) elEmail.value = cachedEmail;
    elEmail.addEventListener('input', () => localStorage.setItem('cache_onboardingEmail', elEmail.value));
  }
  // -----------------------
  
  const btnOnboardingBusinessBack = document.getElementById('btnOnboardingBusinessBack');
  if(btnOnboardingBusinessBack) btnOnboardingBusinessBack.onclick = () => showOnboardingSignup();
  
  const btnOnboardingBusinessNext = document.getElementById('btnOnboardingBusinessNext');
  if(btnOnboardingBusinessNext) btnOnboardingBusinessNext.onclick = () => {
    const businessName = document.getElementById('onboardingBusinessName')?.value.trim();
    const cityOrAddress = document.getElementById('onboardingCityOrAddress')?.value.trim();
    
    if(!businessName || !cityOrAddress){
      alert('Bitte fÃ¼lle alle Felder aus.');
      return;
    }
    
    // Save provider profile basics
    if(!provider.profile) provider.profile = {};
    provider.profile.name = businessName;
    const parsed = parseAddress(cityOrAddress);
    provider.profile.street = parsed.street || cityOrAddress;
    provider.profile.zip = parsed.zip || '';
    provider.profile.city = parsed.city || cityOrAddress;
    save(LS.provider, provider);
    
    // Get the saved dish ID
    const savedDish = cookbook.find(c => c.providerId === providerId() && c.dish === onboardingDraftDish?.dishName);
    if(savedDish){
      showOnboardingPreview(savedDish.id);
    } else {
      // Fallback: show preview with draft data
      showOnboardingPreview(null);
    }
  };
  
  // Tap-Demo Funktion (interaktiver Moment im Onboarding)
  function triggerTapDemo(){
    const demoCode = document.getElementById('demoPickupCode');
    const message = document.getElementById('tapDemoMessage');
    if(!demoCode || !message) return;
    
    // GrÃ¼ner Flash-Effekt
    demoCode.style.background = '#4caf50';
    demoCode.style.color = '#fff';
    demoCode.style.transform = 'scale(0.95)';
    demoCode.style.borderColor = '#4caf50';
    
    // Nach 200ms zurÃ¼ck
    setTimeout(() => {
      demoCode.style.background = '#fff';
      demoCode.style.color = '#2D3436';
      demoCode.style.transform = 'scale(1)';
      demoCode.style.borderColor = '#FFD700';
    }, 200);
    
    // Nachricht anzeigen
    message.style.display = 'block';
    
    // Haptic Feedback
    if('vibrate' in navigator){
      navigator.vibrate([50, 30, 50]);
    }
  }
  
  const btnOnboardingPreviewDashboard = document.getElementById('btnOnboardingPreviewDashboard');
  if(btnOnboardingPreviewDashboard) btnOnboardingPreviewDashboard.onclick = () => {
    // Falls noch ein Entwurf da ist (z.B. weil wir eingeloggt waren und Account-Erstellung Ã¼bersprungen haben), jetzt speichern!
    if(onboardingDraftDish){
      const newDish = {
        id: cryptoId(),
        providerId: providerId(),
        dish: onboardingDraftDish.dishName,
        category: onboardingDraftDish.dishDiet || 'Vegetarisch',
        description: onboardingDraftDish.dishDesc || '',
        price: parseFloat(onboardingDraftDish.dishPrice.replace(',', '.')) || 0,
        pickupWindow: `${onboardingDraftDish.pickupTimeStart} â€“ ${onboardingDraftDish.pickupTimeEnd}`,
        photoData: onboardingDraftDish.photoData || '',
        hasPickupCode: false,
        dineInPossible: false,
        allergens: [],
        extras: [],
        reuse: {enabled: false, deposit: 0},
        createdAt: Date.now(),
        lastUsed: null
      };
      cookbook.push(newDish);
      save(LS.cookbook, cookbook);
      
      // Clear draft
      onboardingDraftDish = null;
      save(LS.onboardingDraft, null);
      ['onboardingDishName', 'onboardingDishPrice', 'onboardingDishDesc', 'onboardingPickupTimeStart', 'onboardingPickupTimeEnd'].forEach(id => localStorage.removeItem('cache_' + id));
    }

    provider.onboardingCompleted = true;
    save(LS.provider, provider);
    // ZurÃ¼ck zum Dashboard
    showProviderHome();
  };
  
  const btnOnboardingPreviewEdit = document.getElementById('btnOnboardingPreviewEdit');
  if(btnOnboardingPreviewEdit) btnOnboardingPreviewEdit.onclick = () => {
    // Restore draft from saved dish
    const savedDish = cookbook.find(c => c.providerId === providerId());
    if(savedDish){
      onboardingDraftDish = {
        dishName: savedDish.dish,
        pickupTimeStart: savedDish.pickupWindow?.split(' â€“ ')[0] || '11:30',
        pickupTimeEnd: savedDish.pickupWindow?.split(' â€“ ')[1] || '14:30',
        photoData: savedDish.photoData || null
      };
      save(LS.onboardingDraft, onboardingDraftDish);
    }
    showOnboardingFirstDish(true);
  };
  
  // Browser back button handling for onboarding (integrated in existing popstate handler)
  // The existing popstate handler already handles wizard and sheets
  // We add onboarding handling there

  // --- Provider entry ---
  const btnProvBack = document.getElementById('btnProvBack');
  if(btnProvBack){
    btnProvBack.onclick=()=>{ setMode('customer'); showProfile(); };
  }

  const btnProvLogin = document.getElementById('btnProvLogin');
  if(btnProvLogin){
    btnProvLogin.onclick=()=>{
      const email = document.getElementById('provEmail').value.trim();
      const pass = document.getElementById('provPass').value.trim();
      if(!email || !pass){ showToast('Bitte E-Mail-Adresse und Passwort eingeben.', 2000); return; }
      
      const existingSession = load(LS.providerSession, null);
      const currentSessionId = load('mittagio_current_session_id', null);
      if(existingSession && existingSession.email === email && existingSession.sessionId !== currentSessionId){
        openLoginConflictModal(email, () => { performProviderLogin(email); });
        return;
      }
      performProviderLogin(email);
    };
  }

  const btnProvLogout = document.getElementById('btnProvLogout');
  if(btnProvLogout){
    btnProvLogout.onclick=()=>{
      // Session lÃ¶schen
      localStorage.removeItem(LS.providerSession);
      localStorage.removeItem('mittagio_current_session_id');
      
      provider.loggedIn=false;
      save(LS.provider, provider);
      setMode('customer');
      showProfile();
    };
  }

  // Rechtliches
  // --- AGB Onboarding Modal (1-Screen) ---
  function openAgbOnboardingModal(callback){
    const content = document.getElementById('agbOnboardingContent');
    if(!content) return;
    
    content.innerHTML = `
      <h2 style="font-size:20px; font-weight:900; margin-bottom:16px;">AGB</h2>
      <div style="line-height:1.7; font-size:14px; max-height:60vh; overflow-y:auto; padding-right:8px;">
        <p><strong>Mittagio ist Plattform, nicht VerkÃ¤ufer</strong></p>
        <p>Mittagio vermittelt Mittagsangebote lokaler Anbieter. Vertragspartner bei Bestellungen ist ausschlieÃŸlich der jeweilige Anbieter.</p>
        
        <p style="margin-top:16px;"><strong>Kosten:</strong></p>
        <ul style="padding-left:20px; margin:8px 0;">
          <li>4,99 â‚¬ zzgl. MwSt. pro VerÃ¶ffentlichung</li>
          <li>0,89 â‚¬ zzgl. MwSt. pro Online-Bestellung inkl. aller Bank- & ZahlungsgebÃ¼hren (pro Bestellung, egal wie viele Gerichte)</li>
        </ul>
        
        <p style="margin-top:16px;"><strong>Abholnummer:</strong></p>
        <p>Abholnummer = Zahlungs- & Abholnachweis. AbwicklungsgebÃ¼hr fÃ¤llt auch bei Nicht-Abholung an.</p>
        
        <p style="margin-top:16px;"><strong>Verantwortung:</strong></p>
        <p>Anbieter ist verantwortlich fÃ¼r Inhalte/Speisen/gesetzliche Vorgaben.</p>
        
        <p style="margin-top:16px;"><strong>Support:</strong></p>
        <p><a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a></p>
      </div>
    `;
    
    document.getElementById('agbOnboardingBd').classList.add('active');
    document.getElementById('agbOnboardingSheet').classList.add('active');
    
    const acceptBtn = document.getElementById('btnAgbOnboardingAccept');
    const cancelBtn = document.getElementById('btnAgbOnboardingCancel');
    if(acceptBtn) acceptBtn.onclick = () => {
      closeAgbOnboardingModal();
      if(callback) callback(true);
    };
    if(cancelBtn) cancelBtn.onclick = () => {
      closeAgbOnboardingModal();
      if(callback) callback(false);
    };
  }
  
  function closeAgbOnboardingModal(){
    document.getElementById('agbOnboardingBd').classList.remove('active');
    document.getElementById('agbOnboardingSheet').classList.remove('active');
  }
  
  // --- Legal Sheets (Impressum, AGB, Datenschutz) ---
  function openLegalSheet(type){
    const content = document.getElementById('legalContent');
    if(!content) return;
    
    let html = '';
    let title = '';
    
    if(type === 'impressum'){
      title = 'Impressum';
      html = `
        <h3 style="margin:0 0 20px;">Impressum</h3>
        <div style="line-height:1.8;">
          <p style="font-weight:700; margin-bottom:12px;">Verantwortlich fÃ¼r den Inhalt:</p>
          <p>
            <strong>Mike Quach</strong><br>
            LangÃ¤cker 2<br>
            73635 Rudersberg<br>
            Deutschland
          </p>
          <p style="margin-top:16px;">
            <strong>Kunden-Hilfe:</strong> <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a><br>
            <strong>Business:</strong> <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a>
          </p>
          <p style="margin-top:20px; padding-top:20px; border-top:1px solid #eee; font-size:13px; color:#666;">
            <strong>Plattformhinweis:</strong><br>
            Mittagio vermittelt Mittagsangebote lokaler Anbieter. Vertragspartner bei Bestellungen ist ausschlieÃŸlich der jeweilige Anbieter.
          </p>
          <p style="margin-top:20px; padding-top:16px; border-top:1px solid #eee; font-size:13px; color:#94a3b8; text-align:center;">
            made with â¤ï¸ by mittagio.de
          </p>
        </div>
      `;
    } else if(type === 'agb'){
      title = 'Allgemeine GeschÃ¤ftsbedingungen (Kunden)';
      html = `
        <h3 style="margin:0 0 20px;">Allgemeine GeschÃ¤ftsbedingungen (Kunden)</h3>
        <div style="line-height:1.8; font-size:14px;">
          <p style="margin-bottom:16px;"><strong>1. Geltungsbereich</strong></p>
          <p style="margin-bottom:20px;">Diese Allgemeinen GeschÃ¤ftsbedingungen (AGB) gelten fÃ¼r die Nutzung der Plattform Mittagio durch Kunden. Mittagio betreibt eine Plattform zur Vermittlung von Mittagsangeboten lokaler Anbieter.</p>
          
          <p style="margin-bottom:16px;"><strong>2. Rolle von Mittagio</strong></p>
          <p style="margin-bottom:20px;">Mittagio ist kein Restaurant und kein Lieferdienst. Mittagio vermittelt ausschlieÃŸlich zwischen Kunden und Anbietern. Der Kaufvertrag kommt direkt zwischen dem Kunden und dem jeweiligen Anbieter zustande.</p>
          
          <p style="margin-bottom:16px;"><strong>3. Nutzung der Plattform</strong></p>
          <p style="margin-bottom:20px;">Die Nutzung ist grundsÃ¤tzlich ohne Registrierung mÃ¶glich. Kunden kÃ¶nnen Mittagsangebote auswÃ¤hlen und vorbestellen. Ein Anspruch auf VerfÃ¼gbarkeit bestimmter Angebote besteht nicht.</p>
          
          <p style="margin-bottom:16px;"><strong>4. Bestellung & Abholung</strong></p>
          <p style="margin-bottom:20px;">Mit Abschluss der Bestellung erhÃ¤lt der Kunde eine Abholnummer. Die Abholnummer ist beim Anbieter vorzuzeigen. Die Abholung erfolgt innerhalb der vom Anbieter angegebenen Essenszeit.</p>
          
          <p style="margin-bottom:16px;"><strong>5. Preise & Bezahlung</strong></p>
          <p style="margin-bottom:20px;">Alle Preise werden vom Anbieter festgelegt. Die Bezahlung erfolgt direkt beim Anbieter vor Ort, sofern nicht anders angegeben. Mittagio erhebt aktuell keine GebÃ¼hren vom Kunden.</p>
          
          <p style="margin-bottom:16px;"><strong>6. Stornierung</strong></p>
          <p style="margin-bottom:20px;">Stornierungen sind abhÃ¤ngig von den Regelungen des jeweiligen Anbieters. Ein Anspruch auf Stornierung oder RÃ¼ckerstattung Ã¼ber Mittagio besteht nicht.</p>
          
          <p style="margin-bottom:16px;"><strong>7. Haftung</strong></p>
          <p style="margin-bottom:20px;">Mittagio haftet nicht fÃ¼r QualitÃ¤t, Menge oder Beschaffenheit der Speisen, AusfÃ¤lle, VerspÃ¤tungen oder Ã„nderungen durch den Anbieter, sowie Allergene oder UnvertrÃ¤glichkeiten. FÃ¼r diese Punkte ist ausschlieÃŸlich der jeweilige Anbieter verantwortlich.</p>
          
          <p style="margin-bottom:16px;"><strong>8. VerfÃ¼gbarkeit</strong></p>
          <p style="margin-bottom:20px;">Mittagio bemÃ¼ht sich um eine hohe VerfÃ¼gbarkeit der Plattform, Ã¼bernimmt jedoch keine Garantie fÃ¼r eine jederzeit unterbrechungsfreie Nutzung.</p>
          
          <p style="margin-bottom:16px;"><strong>9. Ã„nderungen der AGB</strong></p>
          <p style="margin-bottom:20px;">Mittagio behÃ¤lt sich vor, diese AGB anzupassen, wenn sich Funktionen oder rechtliche Rahmenbedingungen Ã¤ndern.</p>
          
          <p style="margin-bottom:16px;"><strong>10. Kontakt</strong></p>
          <p style="margin-bottom:20px;">Bei Fragen zur Nutzung der Plattform: <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a></p>
          
          <p style="margin-top:24px; padding-top:20px; border-top:1px solid #eee; font-size:12px; color:#666;">
            <strong>Stand:</strong> Januar 2026
          </p>
        </div>
      `;
    } else if(type === 'datenschutz'){
      title = 'DatenschutzerklÃ¤rung';
      html = `
        <h3 style="margin:0 0 20px;">DatenschutzerklÃ¤rung</h3>
        <div style="line-height:1.8; font-size:14px;">
          <p style="margin-bottom:16px;"><strong>1. Verantwortlicher</strong></p>
          <p style="margin-bottom:20px;">
            Verantwortlich fÃ¼r die Datenverarbeitung ist:<br><br>
            <strong>MQ Mittagio UG (haftungsbeschrÃ¤nkt)</strong><br>
            Vertreten durch: Mike Quach<br>
            LangÃ¤cker 2<br>
            73635 Rudersberg<br>
            Deutschland<br><br>
            <strong>Kunden-Hilfe:</strong> <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a><br>
            <strong>Business-Anfragen:</strong> <a href="mailto:support@mittagio.de" style="color:var(--brand);">support@mittagio.de</a>
          </p>
          
          <p style="margin-bottom:16px;"><strong>2. Allgemeines</strong></p>
          <p style="margin-bottom:20px;">Der Schutz deiner persÃ¶nlichen Daten ist uns wichtig. Wir verarbeiten personenbezogene Daten nur im notwendigen Umfang und gemÃ¤ÃŸ den geltenden Datenschutzgesetzen (DSGVO).</p>
          
          <p style="margin-bottom:16px;"><strong>3. Welche Daten wir verarbeiten</strong></p>
          <p style="margin-bottom:12px;"><strong>a) Bei der Nutzung der Plattform</strong></p>
          <p style="margin-bottom:20px;">Beim Besuch von Mittagio werden technisch notwendige Daten verarbeitet, z. B.:</p>
          <ul style="margin:0 0 20px 20px; padding-left:0;">
            <li style="margin-bottom:8px;">IP-Adresse (gekÃ¼rzt/anonymisiert, sofern mÃ¶glich)</li>
            <li style="margin-bottom:8px;">Datum und Uhrzeit des Zugriffs</li>
            <li style="margin-bottom:8px;">Browsertyp / Betriebssystem</li>
            <li style="margin-bottom:8px;">aufgerufene Seiten</li>
          </ul>
          <p style="margin-bottom:20px;">Diese Daten sind technisch erforderlich, um die Plattform bereitzustellen.</p>
          
          <p style="margin-bottom:12px;"><strong>b) Bei einer Bestellung</strong></p>
          <p style="margin-bottom:12px;">Wenn du ein Mittagsangebot bestellst, verarbeiten wir:</p>
          <ul style="margin:0 0 12px 20px; padding-left:0;">
            <li style="margin-bottom:8px;">ausgewÃ¤hltes Gericht</li>
            <li style="margin-bottom:8px;">Anbieter</li>
            <li style="margin-bottom:8px;">Abholzeit (ungefÃ¤hr)</li>
            <li style="margin-bottom:8px;">generierte Abholnummer</li>
          </ul>
          <p style="margin-bottom:20px;">
            ðŸ‘‰ Keine Pflicht zur Registrierung<br>
            ðŸ‘‰ Keine Zahlungsdaten (Bezahlung erfolgt ggf. vor Ort beim Anbieter)
          </p>
          
          <p style="margin-bottom:12px;"><strong>c) Lokale Speicherung (PWA)</strong></p>
          <p style="margin-bottom:20px;">Bestellungen und Abholnummern werden lokal auf deinem GerÃ¤t gespeichert (z. B. im LocalStorage), damit du sie auch offline wieder anzeigen kannst. Diese Daten werden nicht automatisch an uns Ã¼bertragen.</p>
          
          <p style="margin-bottom:16px;"><strong>4. Weitergabe von Daten</strong></p>
          <p style="margin-bottom:20px;">Deine Daten werden nur an den jeweiligen Anbieter weitergegeben, soweit dies zur Abwicklung deiner Bestellung erforderlich ist.</p>
          <p style="margin-bottom:20px;">Eine Weitergabe an Dritte erfolgt nicht, auÃŸer:</p>
          <ul style="margin:0 0 20px 20px; padding-left:0;">
            <li style="margin-bottom:8px;">es besteht eine gesetzliche Verpflichtung</li>
            <li style="margin-bottom:8px;">oder du hast ausdrÃ¼cklich eingewilligt</li>
          </ul>
          
          <p style="margin-bottom:16px;"><strong>5. Cookies & Tracking</strong></p>
          <p style="margin-bottom:20px;">Mittagio verwendet keine Tracking-Cookies und kein Nutzer-Tracking zu Werbezwecken.</p>
          <p style="margin-bottom:20px;">Es werden ausschlieÃŸlich technisch notwendige Speichermechanismen verwendet (z. B. fÃ¼r App-Funktionen).</p>
          
          <p style="margin-bottom:16px;"><strong>6. Hosting</strong></p>
          <p style="margin-bottom:20px;">Die Plattform wird Ã¼ber externe Hosting-Anbieter betrieben. Dabei kÃ¶nnen technisch notwendige Zugriffsdaten (z. B. IP-Adresse) verarbeitet werden, um den sicheren Betrieb zu gewÃ¤hrleisten.</p>
          
          <p style="margin-bottom:16px;"><strong>7. Deine Rechte</strong></p>
          <p style="margin-bottom:12px;">Du hast jederzeit das Recht auf:</p>
          <ul style="margin:0 0 12px 20px; padding-left:0;">
            <li style="margin-bottom:8px;">Auskunft Ã¼ber deine gespeicherten Daten</li>
            <li style="margin-bottom:8px;">Berichtigung unrichtiger Daten</li>
            <li style="margin-bottom:8px;">LÃ¶schung deiner Daten</li>
            <li style="margin-bottom:8px;">EinschrÃ¤nkung der Verarbeitung</li>
            <li style="margin-bottom:8px;">Widerspruch gegen die Verarbeitung</li>
          </ul>
          <p style="margin-bottom:20px;">Anfragen bitte per E-Mail an: <a href="mailto:info@mittagio.de" style="color:var(--brand);">info@mittagio.de</a></p>
          
          <p style="margin-bottom:16px;"><strong>8. Ã„nderungen dieser DatenschutzerklÃ¤rung</strong></p>
          <p style="margin-bottom:20px;">Diese DatenschutzerklÃ¤rung kann angepasst werden, wenn sich Funktionen oder gesetzliche Vorgaben Ã¤ndern.</p>
          <p style="margin-bottom:20px;">Es gilt jeweils die auf dieser Seite verÃ¶ffentlichte Version.</p>
          
          <p style="margin-top:24px; padding-top:20px; border-top:1px solid #eee; font-size:12px; color:#666;">
            <strong>9. Stand</strong><br>
            Stand: Januar 2026
          </p>
        </div>
      `;
    }
    
    content.innerHTML = html;
    document.getElementById('legalBd').classList.add('active');
    document.getElementById('legalSheet').classList.add('active');
  }
  
  function closeLegalSheet(){
    document.getElementById('legalBd').classList.remove('active');
    document.getElementById('legalSheet').classList.remove('active');
  }
  
  // Profil anlegen Sheet (Kunde)
  function openProfileCreateSheet(){
    const bd = document.getElementById('profileCreateBd');
    const sheet = document.getElementById('profileCreateSheet');
    const nameEl = document.getElementById('profileCreateName');
    const emailEl = document.getElementById('profileCreateEmail');
    if(!bd || !sheet || !emailEl) return;
    if(nameEl) nameEl.value = '';
    emailEl.value = '';
    bd.classList.add('active');
    sheet.classList.add('active');
    setTimeout(function(){ emailEl.focus(); }, 120);
    if(typeof lucide !== 'undefined') setTimeout(function(){ lucide.createIcons(); }, 50);
  }
  function closeProfileCreateSheet(){
    const bd = document.getElementById('profileCreateBd');
    const sheet = document.getElementById('profileCreateSheet');
    if(bd) bd.classList.remove('active');
    if(sheet) sheet.classList.remove('active');
  }
  
  // FAQ Sheet
  function openFaqSheet(){
    const content = document.getElementById('faqSheetContent');
    if(!content) return;
    
    const allFaq = `
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Wie funktioniert Mittagio?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Du findest Mittagsangebote in deiner Stadt, optional bezahlst du online und holst zur gewÃ¤hlten Zeit ab.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Was ist die Abholnummer?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Deine Abholnummer fÃ¼r die Mittagspause. Du erhÃ¤ltst sie nach erfolgreicher Online-Zahlung.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Muss ich online bezahlen?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Nein. Online-Zahlung ist optional. Eine Abholnummer gibt's nur bei Online-Zahlung.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Kann ich ohne Abholnummer Gerichte hinzufÃ¼gen?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Nein. Angebote ohne Abholnummer kannst du nur ansehen.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Wann kann ich abholen?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Innerhalb der Essenszeit. WÃ¤hle eine ungefÃ¤hre Abholzeit in deiner Mittagsbox.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Kann ich mehrere Gerichte in einem Vorgang buchen?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Ja. Du kannst mehrere Gerichte in einem Vorgang buchen (eine Abholnummer).</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Vor Ort essen mÃ¶glich?</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Wenn das Badge â€žVor Ort" angezeigt wird, kannst du vor Ort essen.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Teilen</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Teile Angebote per WhatsApp, Instagram oder Website.</p>
      </details>
      <details>
        <summary style="font-size:15px; line-height:1.4; font-weight:500; padding:12px 0;">Kontakt</summary>
        <p style="font-size:14px; line-height:1.5; margin-top:8px; padding-bottom:12px; color:var(--muted);">Bei Fragen schreib uns an <a href="mailto:info@mittagio.de" style="color:var(--muted);">info@mittagio.de</a></p>
      </details>
    `;
    
    content.innerHTML = allFaq;
    document.getElementById('faqBd').classList.add('active');
    document.getElementById('faqSheet').classList.add('active');
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined') setTimeout(()=> lucide.createIcons(), 50);
  }
  
  // Kachel-Popup Funktionen (Neugier-Popup)
  function showTilePopup(element, text){
    const popup = element.querySelector('.tile-popup');
    if(popup){
      if(text){
        const textNode = popup.childNodes[0];
        if(textNode && textNode.nodeType === 3) textNode.textContent = text;
        else {
          const arrow = popup.querySelector('div[style*="border-left"]') || '';
          popup.innerHTML = text + (arrow.outerHTML || '<div style="position:absolute; top:100%; left:50%; transform:translateX(-50%); width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; border-top:6px solid #1e1e1e;"></div>');
        }
      }
      popup.style.opacity = '1';
    }
  }
  function hideTilePopup(element){
    const popup = element.querySelector('.tile-popup');
    if(popup){
      popup.style.opacity = '0';
    }
  }
  
  // PDF-KÃ¼chenliste generieren & Download
  function generateKitchenListPDF(dayKey = null){
    const todayKey = dayKey || isoDate(new Date());
    const profile = normalizeProviderProfile(provider.profile || {});
    const providerName = profile.name || provider.email || 'Anbieter';
    const providerAddr = buildAddress(profile) || '';
    
    // Bestellungen fÃ¼r den Tag filtern
    const orders = loadOrders().filter(o => {
      const offer = offers.find(off => off.id === o.dishId || off.providerId === o.providerId);
      return offer && offer.providerId === providerId() && offer.day === todayKey && o.status === 'PAID';
    });
    
    // Gruppieren nach Gericht
    const grouped = {};
    orders.forEach(o => {
      const offer = offers.find(off => off.id === o.dishId);
      const dishName = offer?.dish || o.dishName || 'Gericht';
      if(!grouped[dishName]){
        grouped[dishName] = {count: 0, orders: [], price: offer?.price || 0};
      }
      grouped[dishName].count += 1;
      grouped[dishName].orders.push(o);
    });
    
    // HTML fÃ¼r Print generieren
    const dateStr = dayKey ? fmtDay(new Date(dayKey)) : 'Heute';
    const html = `
      <div class="print-card">
        <h1>KÃ¼chenliste - ${esc(providerName)}</h1>
        <div class="print-muted">${esc(providerAddr)}</div>
        <div class="print-muted" style="margin-top:8px;">${esc(dateStr)} Â· ${orders.length} Bestellung${orders.length !== 1 ? 'en' : ''}</div>
      </div>
      ${Object.entries(grouped).map(([dish, data]) => `
        <div class="print-card">
          <h2>${esc(dish)} Ã— ${data.count}</h2>
          <div class="print-muted" style="margin-top:4px;">Abholnummern: ${data.orders.map(o => o.pickupCode || o.code || 'â€“').join(', ')}</div>
        </div>
      `).join('')}
      <div class="print-card" style="margin-top:20px; padding-top:20px; border-top:2px solid #ddd;">
        <div class="print-muted">Erstellt am ${new Date().toLocaleString('de-DE')}</div>
        <div class="print-muted">Mittagio - Dein Mittag. Lokal. Frisch. Digital.</div>
      </div>
    `;
    
    printHtml(html);
  }
  
  // PDF-KÃ¼chenliste per E-Mail versenden (Fallback: Download)
  function emailKitchenList(dayKey = null){
    const todayKey = dayKey || isoDate(new Date());
    const dateStr = dayKey ? fmtDay(new Date(dayKey)) : 'Heute';
    
    // Generiere HTML
    generateKitchenListPDF(todayKey);
    
    // Fallback: Download-Link anbieten
    showToast('KÃ¼chenliste wird vorbereitet...');
    setTimeout(() => {
      if(confirm('KÃ¼chenliste drucken oder als PDF speichern?')){
        window.print();
      }
    }, 500);
  }
  
  function closeFaqSheet(){
    document.getElementById('faqBd').classList.remove('active');
    document.getElementById('faqSheet').classList.remove('active');
  }
  
  // Legal Links
  const btnImpressum = document.getElementById('btnImpressum');
  if(btnImpressum) btnImpressum.onclick=()=>{ openLegalSheet('impressum'); };
  const btnAGB = document.getElementById('btnAGB');
  if(btnAGB) btnAGB.onclick=()=>{ openLegalSheet('agb'); };
  const btnDatenschutz = document.getElementById('btnDatenschutz');
  if(btnDatenschutz) btnDatenschutz.onclick=()=>{ openLegalSheet('datenschutz'); };
  
  // Profile Legal Links - Ã¶ffnen statische Seiten
  const btnProfileImpressum = document.getElementById('btnProfileImpressum');
  if(btnProfileImpressum) btnProfileImpressum.onclick=(e)=>{ e.preventDefault(); showLegalPage('impressum'); };
  const btnProfileAGB = document.getElementById('btnProfileAGB');
  if(btnProfileAGB) btnProfileAGB.onclick=(e)=>{ e.preventDefault(); showLegalPage('agb-kurz'); };
  const btnProfileDatenschutz = document.getElementById('btnProfileDatenschutz');
  if(btnProfileDatenschutz) btnProfileDatenschutz.onclick=(e)=>{ e.preventDefault(); showLegalPage('datenschutz'); };

  // Support-Formular (Kunden): Nachricht senden â€“ BestÃ¤tigung ohne E-Mail im UI
  const supportForm = document.getElementById('supportForm');
  if(supportForm){
    supportForm.addEventListener('submit', function(e){
      e.preventDefault();
      const subjectEl = document.getElementById('supportSubject');
      const messageEl = document.getElementById('supportMessage');
      const pickupRefEl = document.getElementById('supportPickupRef');
      if(!messageEl || !messageEl.value.trim()){ showToast('Bitte Nachricht eingeben.', 2000); return; }
      showToast('Vielen Dank. Deine Nachricht wurde Ã¼bermittelt. Wir melden uns in KÃ¼rze.', 4000);
      if(subjectEl) subjectEl.value = '';
      if(messageEl) messageEl.value = '';
      if(pickupRefEl) pickupRefEl.value = '';
    });
  }
  
  // Profil anlegen Sheet: Submit & Abbrechen
  const btnProfileCreateSubmit = document.getElementById('btnProfileCreateSubmit');
  const btnProfileCreateCancel = document.getElementById('btnProfileCreateCancel');
  if(btnProfileCreateSubmit){
    btnProfileCreateSubmit.onclick = function(){
      const nameEl = document.getElementById('profileCreateName');
      const emailEl = document.getElementById('profileCreateEmail');
      const name = (nameEl && nameEl.value) ? nameEl.value.trim() : '';
      const email = (emailEl && emailEl.value) ? emailEl.value.trim() : '';
      if(!email){
        showToast('Bitte E-Mail-Adresse eingeben.', 2000);
        if(emailEl) emailEl.focus();
        return;
      }
      var re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if(!re.test(email)){
        showToast('Bitte gÃ¼ltige E-Mail-Adresse eingeben.', 2000);
        if(emailEl) emailEl.focus();
        return;
      }
      customer.loggedIn = true;
      customer.email = email;
      customer.name = name || email.split('@')[0];
      if(!customer.dietaryPreferences) customer.dietaryPreferences = { vegan: false, vegetarian: false, glutenFree: false, lactoseFree: false };
      if(customer.reuseEnabled === undefined) customer.reuseEnabled = false;
      save(LS.customer, customer);
      closeProfileCreateSheet();
      updateProfileView();
      showToast('Profil angelegt! ðŸ‘‹', 2000);
      if(typeof triggerHapticFeedback === 'function') triggerHapticFeedback([10]);
    };
  }
  if(btnProfileCreateCancel) btnProfileCreateCancel.onclick = closeProfileCreateSheet;
  
  // Provider nav handlers
  document.getElementById('providerNav').addEventListener('click',(e)=>{
    const b = e.target.closest('button');
    if(!b) return;
    const go = b.dataset.pgo;
    if(go==='provider-home') showProviderHome();
    if(go==='provider-pickups') showProviderPickups();
    if(go==='provider-cookbook') showProviderCookbook();
    if(go==='provider-support') openSupportContact();
    if(go==='provider-profile') showProviderProfile();
  });
  const btnProviderNavBack = document.getElementById('btnProviderNavBack');
  if(btnProviderNavBack) btnProviderNavBack.onclick = function(){ showProviderHome(); };

  // Customer nav handlers - Robuster Event-Delegation-Ansatz
  document.addEventListener('click', function(e){
    // PrÃ¼fe ob Klick innerhalb von customerNav
    const nav = document.getElementById('customerNav');
    if(!nav || !nav.contains(e.target)) return;
    
    // Finde den Button (auch wenn auf Icon/Text geklickt wurde)
    let target = e.target;
    let btn = null;
    
    while(target && target !== nav){
      if(target.tagName === 'BUTTON' && target.classList.contains('navbtn')){
        btn = target;
        break;
      }
      target = target.parentElement;
    }
    
    if(!btn || !btn.dataset.go) return;
    
    const go = btn.dataset.go;
    e.preventDefault();
    e.stopPropagation();
    
    console.log('Navigation clicked:', go, 'mode:', mode);
    
    try {
      if(go==='discover'){
        if(mode === 'start'){
          showStart();
        } else {
          showDiscover();
        }
      } else if(go==='fav'){
        showFav();
      } else if(go==='cart'){
        showCart();
      } else if(go==='orders'){
        showOrders();
      } else if(go==='profile'){
        showProfile();
      }
    } catch(err){
      console.error('Navigation error:', err, go);
      alert('Navigation-Fehler: ' + err.message);
    }
  }, true); // useCapture fÃ¼r frÃ¼here Event-Erfassung

  // --- Provider Dashboard (Home) - FINAL MVP ---
  let createFlowPreselectedDate = null; // FÃ¼r Date-Preselect aus Today/Week
  
  // Zeit-Tracker Animation
  function animateTimeTracker(element, startHours, startMinutes, endHours, endMinutes){
    const duration = 1500; // 1.5 Sekunden
    const startTime = Date.now();
    const totalStartMinutes = startHours * 60 + startMinutes;
    const totalEndMinutes = endHours * 60 + endMinutes;
    const diff = totalEndMinutes - totalStartMinutes;
    
    function update(){
      const elapsed = Date.now() - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const easeOut = 1 - Math.pow(1 - progress, 3); // Ease-out cubic
      const currentMinutes = Math.round(totalStartMinutes + diff * easeOut);
      const currentHours = Math.floor(currentMinutes / 60);
      const currentMinutesRemainder = currentMinutes % 60;
      
      element.textContent = `${currentHours}h ${currentMinutesRemainder}min`;
      
      if(progress < 1){
        requestAnimationFrame(update);
      } else {
        element.textContent = `${endHours}h ${endMinutes}min`;
      }
    }
    
    update();
  }
  
  function renderProviderHome(){
    // Session-AktivitÃ¤t aktualisieren
    updateSessionActivity();
    
    const profile = normalizeProviderProfile(provider.profile || {});
    const todayKey = isoDate(new Date());
    const mineAll = offers.filter(o => o.providerId === providerId());
    const mineActive = mineAll.filter(o => o.active !== false);
    const mineToday = mineActive.filter(o => o.day === todayKey);
    
    // Kunden-Nachfrage: Request-Count aus LocalStorage
    const requestCountEl = document.getElementById('providerRequestCount');
    if(requestCountEl){
      const requestCount = parseInt(localStorage.getItem(`provider_${providerId()}_requests`) || '0', 10);
      requestCountEl.textContent = requestCount;
      
      // Sektion nur anzeigen wenn Requests vorhanden
      const demandSection = document.getElementById('providerCustomerDemand');
      if(demandSection){
        if(requestCount > 0){
          demandSection.style.display = 'block';
        } else {
          demandSection.style.display = 'none';
        }
      }
    }
    
      // ---------------------------------------------------------
      // NEUE DASHBOARD LOGIK (Hero, Umsatz, Push)
      // ---------------------------------------------------------
      
      // 1. Daten berechnen
      const todayOrders = loadOrders().filter(o => {
        const offer = offers.find(off => off.id === o.dishId || off.providerId === o.providerId);
        return offer && offer.providerId === providerId() && offer.day === todayKey && o.status === 'PAID';
      });
      const tagesumsatzCents = todayOrders.reduce((sum, o) => sum + (o.totalCents || 0), 0);
      const tagesumsatzEuro = (tagesumsatzCents / 100).toFixed(2);
      
      const hasRevenue = tagesumsatzCents > 0;
      const hasOffers = mineToday.length > 0;
      const isHeroActive = hasRevenue || hasOffers;

      // 2. Hero Card Update
      const heroStateStart = document.getElementById('heroStateStart');
      const heroStateActive = document.getElementById('heroStateActive');
      const heroRevenue = document.getElementById('heroRevenueDisplay');
      const heroOrders = document.getElementById('heroOrdersCount');
      const heroPickups = document.getElementById('heroPickupCount');
      const btnHeroShare = document.getElementById('btnHeroShare');

      if(heroStateStart && heroStateActive){
        if(isHeroActive){
          heroStateStart.style.display = 'none';
          heroStateActive.style.display = 'block';
          
          if(heroRevenue) heroRevenue.textContent = tagesumsatzEuro.replace('.', ',') + ' â‚¬';
          if(heroOrders) heroOrders.textContent = todayOrders.length;
          if(heroPickups) heroPickups.textContent = todayOrders.filter(o => o.status === 'PAID').length;
          
          // Farbe bei Umsatz grÃ¼n
          if(heroRevenue && hasRevenue) heroRevenue.style.color = '#2e7d32';
          else if(heroRevenue) heroRevenue.style.color = '#1a1a1a';
          
        } else {
          heroStateStart.style.display = 'block';
          heroStateActive.style.display = 'none';
        }
      }
      
      if(btnHeroShare){
        btnHeroShare.onclick = () => shareTodayOffers();
      }

      // 3. Push Pickup (Anzeigen wenn Inserat da, aber kein Abholnummer)
      const providerPushPickup = document.getElementById('providerPushPickup');
      if(providerPushPickup){
        // Wir zeigen die Push-Karte NICHT mehr an, da der User meinte "Bottom ist immer noch nicht immer da"
        // und das Layout "heller" und "appliker" sein soll.
        // Die Abholnummer-Logik ist jetzt im Inserats-Flow integriert.
        providerPushPickup.style.display = 'none';
      }

      // Alte Elemente ausblenden/aufrÃ¤umen (falls noch Refs im Code)
      const providerTimeSaved = document.getElementById('providerTimeSaved');
      if(providerTimeSaved) providerTimeSaved.textContent = tagesumsatzEuro.replace('.', ',') + ' â‚¬';
      
      const todayPickups = todayOrders.length;
      const cookbookCount = cookbook.length;
      const kpiAbholungenCount = document.getElementById('kpiAbholungenCount');
      if(kpiAbholungenCount) kpiAbholungenCount.textContent = todayPickups;
      const kpiKochbuchCount = document.getElementById('kpiKochbuchCount');
      if(kpiKochbuchCount) kpiKochbuchCount.textContent = cookbookCount;
      const kpiTagesessenDish = document.getElementById('kpiTagesessenDish');
      if(kpiTagesessenDish){
        if(mineToday.length > 0){
          const firstDish = mineToday[0];
          const dishName = firstDish.dish || firstDish.title || 'Gericht';
          kpiTagesessenDish.textContent = dishName.length > 18 ? dishName.substring(0, 18) + 'â€¦' : dishName;
        } else {
          kpiTagesessenDish.textContent = 'â€“';
        }
      }

      // Dashboard 2.1: Header-Kennzahlen (Tagesessen, Abholungen, Kochbuch, Umsatz)
      const dashTagesessen = document.getElementById('dashboardTagesessenCount');
      const dashAbholungen = document.getElementById('dashboardAbholungenCount');
      const dashKochbuch = document.getElementById('dashboardKochbuchCount');
      const dashUmsatz = document.getElementById('dashboardUmsatzToday');
      if(dashTagesessen) dashTagesessen.textContent = mineToday.length;
      if(dashAbholungen) dashAbholungen.textContent = todayPickups;
      if(dashKochbuch) dashKochbuch.textContent = cookbookCount;
      const nettoEuro = (tagesumsatzCents / 100 - todayOrders.length * 0.89).toFixed(2);
      if(dashUmsatz){ dashUmsatz.textContent = nettoEuro.replace('.', ',') + ' â‚¬'; dashUmsatz.style.color = hasRevenue ? '#16a34a' : '#1a1a1a'; }

      // Aktive Inserate: Dashboard 2.1 â€“ ImmoScout-Style (Live-Badge, Preis auf Bild, Titel + Auge/Herz/Check, 3 SÃ¤ulen Pills)
      const providerActiveListings = document.getElementById('providerActiveListings');
      const providerActiveListingsSection = document.getElementById('providerActiveListingsSection');
      if(providerActiveListings && providerActiveListingsSection){
        providerActiveListingsSection.style.display = mineToday.length > 0 ? 'block' : 'none';
        providerActiveListings.innerHTML = '';
        mineToday.forEach(function(o){
          const d = normalizeOffer(o);
          const imgUrl = d.imageUrl || 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=800&q=70';
          const hasReusable = !!(o.reuse && o.reuse.enabled);
          const hasPickupNumber = !!o.hasPickupCode;
          const dishName = d.dish || d.title || 'Gericht';
          const isLive = o.active !== false;
          const viewsCount = parseInt(localStorage.getItem('mittagio_views_' + o.id) || '0', 10);
          const favCount = (JSON.parse(localStorage.getItem('mittagio_favorites') || '[]')).filter(function(id){ return id === o.id; }).length ? 1 : 0;
          const pickupsForOffer = todayOrders.filter(function(ord){ const off = offers.find(function(x){ return x.id === ord.dishId || x.providerId === ord.providerId; }); return off && off.id === o.id; });
          const checkCount = pickupsForOffer.length;
          const pillars = [];
          pillars.push('<div style="width:100%; background:#34c759; color:#fff; padding:10px 16px; border-radius:12px; font-size:10px; font-weight:800; text-transform:uppercase; letter-spacing:0.1em; text-align:center; box-shadow:0 1px 3px rgba(0,0,0,0.1);">Vor Ort mÃ¶glich</div>');
          if(hasPickupNumber) pillars.push('<div style="width:100%; background:#ffde00; color:#1a1a1a; padding:10px 16px; border-radius:12px; font-size:10px; font-weight:800; text-transform:uppercase; letter-spacing:0.1em; text-align:center; box-shadow:0 1px 3px rgba(0,0,0,0.1);">Abholnummer aktiv</div>');
          if(hasReusable) pillars.push('<div style="width:100%; background:#007aff; color:#fff; padding:10px 16px; border-radius:12px; font-size:10px; font-weight:800; text-transform:uppercase; letter-spacing:0.1em; text-align:center; box-shadow:0 1px 3px rgba(0,0,0,0.1);">Mehrweg verfÃ¼gbar</div>');
          const card = document.createElement('div');
          card.style.cssText = 'background:#fff; border-radius:2.5rem; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.08); border:1px solid rgba(0,0,0,0.04); cursor:pointer;';
          card.innerHTML = `
            <div style="position:relative; height:240px; width:100%; background:#e5e5e5;">
              <img src="${esc(imgUrl)}" alt="" style="width:100%; height:100%; object-fit:cover;" />
              ${isLive ? '<div style="position:absolute; top:16px; left:16px; background:rgba(255,255,255,0.95); backdrop-filter:blur(8px); padding:8px 14px; border-radius:999px; display:flex; align-items:center; gap:8px; box-shadow:0 2px 8px rgba(0,0,0,0.08);"><span style="width:10px; height:10px; background:#22c55e; border-radius:50%; animation:pulse 1.5s ease-in-out infinite;"></span><span style="font-size:10px; font-weight:800; text-transform:uppercase; letter-spacing:0.1em; color:#1a1a1a;">Live</span></div>' : ''}
              <div style="position:absolute; bottom:16px; right:16px; background:#1a1a1a; color:#fff; padding:8px 20px; border-radius:16px; font-size:18px; font-weight:900; box-shadow:0 4px 12px rgba(0,0,0,0.2);">${euro(d.price)}</div>
            </div>
            <div style="padding:24px 24px 32px;">
              <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px;">
                <h2 style="margin:0; font-size:22px; font-weight:900; color:#1a1a1a; line-height:1.25; flex:1; padding-right:16px;">${esc(dishName)}</h2>
                <div style="display:flex; gap:20px; flex-shrink:0;">
                  <div style="display:flex; flex-direction:column; align-items:center;"><span style="font-size:18px;">ðŸ‘ï¸</span><span style="font-size:13px; font-weight:800; color:#1a1a1a;">${viewsCount}</span></div>
                  <div style="display:flex; flex-direction:column; align-items:center;"><span style="font-size:18px;">â¤ï¸</span><span style="font-size:13px; font-weight:800; color:#1a1a1a;">${favCount}</span></div>
                  <div style="display:flex; flex-direction:column; align-items:center;"><span style="font-size:18px;">âœ…</span><span style="font-size:13px; font-weight:800; color:#1a1a1a;">${checkCount}</span></div>
                </div>
              </div>
              <div style="display:flex; flex-direction:column; gap:8px;">${pillars.join('')}</div>
            </div>
          `;
          card.onclick = function(){ openProviderOffer(o.id); };
          providerActiveListings.appendChild(card);
        });
      }

      // CTA-Button: Neues Gericht inserieren (wie FAB â†’ openDishFlow)
      const btnProviderDashboardCTA = document.getElementById('btnProviderDashboardCTA');
      if(btnProviderDashboardCTA) btnProviderDashboardCTA.onclick = function(){ openDishFlow(); };

      // Live Abholnummern: Pills (Referenz 97525 â€“ erste gelb #ffde00, rest grau)
      const providerNextPickupPills = document.getElementById('providerNextPickupPills');
      if(providerNextPickupPills){
        providerNextPickupPills.innerHTML = '';
        const paidOrders = todayOrders.filter(function(o){ return o.status === 'PAID' && o.pickupCode; });
        paidOrders.slice(0, 10).forEach(function(ord, i){
          const pill = document.createElement('div');
          const isFirst = i === 0;
          pill.style.cssText = 'flex-shrink:0; width:40px; height:40px; border-radius:50%; font-size:12px; font-weight:700; display:flex; align-items:center; justify-content:center; background:' + (isFirst ? '#ffde00' : '#f1f1f1') + '; color:' + (isFirst ? '#1a1a1a' : 'rgba(0,0,0,0.4)') + '; box-shadow:' + (isFirst ? 'inset 0 1px 2px rgba(0,0,0,0.08)' : 'none') + ';';
          pill.textContent = '#' + (ord.pickupCode || ord.id.slice(-3));
          providerNextPickupPills.appendChild(pill);
        });
        if(paidOrders.length === 0){
          const empty = document.createElement('div');
          empty.style.cssText = 'font-size:13px; color:rgba(0,0,0,0.4);';
          empty.textContent = 'Heute noch keine';
          providerNextPickupPills.appendChild(empty);
        }
      }
    
    // TODAY Card
    const providerTodayCard = document.getElementById('providerTodayCard');
    const providerTodayTitle = document.getElementById('providerTodayTitle');
    const providerTodayContent = document.getElementById('providerTodayContent');
    if(providerTodayCard && providerTodayTitle && providerTodayContent){
      const today = new Date();
      const weekday = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'][today.getDay()];
      const dateStr = `${today.getDate()}.${String(today.getMonth()+1).padStart(2,'0')}.`;
      providerTodayTitle.textContent = `Heute Â· ${weekday}, ${dateStr}`;
      
      if(mineToday.length > 0){
        const withCodeToday = mineToday.filter(o => o.hasPickupCode).length;
        const nextPickup = loadOrders().filter(o => {
          const offer = offers.find(off => off.id === o.dishId || off.providerId === o.providerId);
          return offer && offer.providerId === providerId() && offer.day === todayKey && o.status === 'PAID';
        }).sort((a,b) => (a.etaTime || '').localeCompare(b.etaTime || ''))[0];
        
        let html = `
          <div style="margin-bottom:12px;">
            <a href="#" id="providerTodayInserateLink" style="display:block; padding:10px; background:#f8f7f3; border-radius:12px; text-decoration:none; color:inherit; margin-bottom:8px;">
              <div style="font-weight:600; font-size:14px;">Inserate heute: ${mineToday.length}</div>
            </a>
            <a href="#" id="providerTodayPickupsLink" style="display:block; padding:10px; background:#f8f7f3; border-radius:12px; text-decoration:none; color:inherit;">
              <div style="font-weight:600; font-size:14px;">Abholungen heute: ${todayPickups}</div>
            </a>
        `;
        if(nextPickup && nextPickup.etaTime){
          const pickupCount = loadOrders().filter(o => {
            const offer = offers.find(off => off.id === o.dishId || off.providerId === o.providerId);
            return offer && offer.providerId === providerId() && offer.day === todayKey && o.status === 'PAID' && o.etaTime === nextPickup.etaTime;
          }).length;
          html += `
            <div style="margin-top:8px; padding:10px; background:#f8f7f3; border-radius:12px;">
              <div style="font-weight:600; font-size:14px;">NÃ¤chste Abholung: ${esc(nextPickup.etaTime)} (${pickupCount} ${pickupCount === 1 ? 'Code' : 'Codes'})</div>
            </div>
          `;
        }
        html += `</div>`;
        providerTodayContent.innerHTML = html;
        
        const providerTodayInserateLink = document.getElementById('providerTodayInserateLink');
        if(providerTodayInserateLink) providerTodayInserateLink.onclick = (e) => {
          e.preventDefault();
          // Scroll to Active Offers section (falls vorhanden)
          const activeOffers = document.getElementById('providerActiveOffers');
          if(activeOffers){
            activeOffers.scrollIntoView({behavior: 'smooth', block: 'start'});
          }
        };
        const providerTodayPickupsLink = document.getElementById('providerTodayPickupsLink');
        if(providerTodayPickupsLink) providerTodayPickupsLink.onclick = (e) => {
          e.preventDefault();
          showProviderPickups();
        };
      } else {
        providerTodayContent.innerHTML = `
          <div style="font-weight:600; font-size:16px; margin-bottom:8px; text-align:center;">Keine Inserate heute</div>
          <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:var(--muted); text-align:center;">
            Erstelle dein erstes Inserat fÃ¼r heute.
          </div>
          <button class="btn secondary" type="button" id="btnProviderTodayAddDish" style="width:100%; min-height:44px;">
            Inserat fÃ¼r heute erstellen
          </button>
        `;
        const btnProviderTodayAddDish = document.getElementById('btnProviderTodayAddDish');
        if(btnProviderTodayAddDish) btnProviderTodayAddDish.onclick = () => {
          // Unified Flow: Direkt mit Heute-Datum
          openDishFlow(todayKey);
        };
      }
    }
    
    // Active Offers Mini List (max 3, expandable)
    const providerActiveOffers = document.getElementById('providerActiveOffers');
    const providerActiveOffersList = document.getElementById('providerActiveOffersList');
    if(providerActiveOffers && providerActiveOffersList){
      const showAll = providerActiveOffers.dataset.showAll === 'true';
      const activeList = showAll ? mineActive : mineActive.slice(0, 3);
      if(activeList.length > 0){
        providerActiveOffers.style.display = 'block';
        providerActiveOffersList.innerHTML = activeList.map(o => {
          // Status-Badge: "LIVE Â· Online bezahlt" oder "LIVE Â· Vor Ort"
          let statusBadge = '';
          if(o.active !== false){
            if(o.hasPickupCode){
              statusBadge = '<span style="font-size:11px; padding:2px 8px; background:rgba(46,125,50,.12); border-radius:6px; color:#2e7d32; font-weight:600;">ðŸŸ¢ LIVE Â· Online bezahlt</span>';
            } else {
              statusBadge = '<span style="font-size:11px; padding:2px 8px; background:rgba(0,0,0,.06); border-radius:6px; color:#666; font-weight:600;">âšª LIVE Â· Vor Ort</span>';
            }
          }
          
          // Verzehrart-Badges
          const badges = [];
          const offerProvider = offers.find(p => p.providerId === o.providerId);
          const orderingEnabled = offerProvider && (offerProvider.orderingEnabled !== false && (o.hasPickupCode || offerProvider.hasPickupCode));
          if(orderingEnabled) badges.push('<span style="font-size:11px; padding:2px 6px; background:rgba(255,204,0,.15); border-radius:6px; color:var(--brand);">Abholnummer</span>');
          if(!orderingEnabled) badges.push('<span style="font-size:11px; padding:2px 6px; background:rgba(0,0,0,.06); border-radius:6px;">To Go</span>');
          
          // No-Limits: Prominenter "Ausverkauft" / "Noch da" Toggle direkt in der Liste
          const isActive = o.active !== false;
          const toggleBtn = isActive 
            ? `<button class="btn" type="button" data-offer-id="${esc(o.id)}" onclick="event.stopPropagation(); toggleOfferSoldOut('${esc(o.id)}');" style="background:#E34D4D; color:#fff; font-weight:700; padding:6px 12px; font-size:12px; min-height:32px; border-radius:8px; border:none; flex-shrink:0;">Ausverkauft</button>`
            : `<button class="btn" type="button" data-offer-id="${esc(o.id)}" onclick="event.stopPropagation(); toggleOfferSoldOut('${esc(o.id)}');" style="background:#4caf50; color:#fff; font-weight:700; padding:6px 12px; font-size:12px; min-height:32px; border-radius:8px; border:none; flex-shrink:0;">Wieder verfÃ¼gbar</button>`;
          
          return `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 0; border-bottom:1px solid var(--border);">
              <div style="flex:1; min-width:0;" data-offer-id="${esc(o.id)}" style="cursor:pointer;">
                <div style="font-weight:600; font-size:14px; line-height:1.3; margin-bottom:4px;">${esc(o.dish || o.title || 'Gericht')}</div>
                <div style="font-size:12px; color:var(--muted); margin-bottom:6px;">${esc(o.pickupWindow || o.time || '')}</div>
                <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
                  ${statusBadge}
                  ${badges.join('')}
                </div>
              </div>
              <div style="display:flex; gap:8px; align-items:center; flex-shrink:0;">
                ${toggleBtn}
                <button class="btn ghost" type="button" data-offer-id="${esc(o.id)}" style="padding:8px; min-width:36px;" onclick="event.stopPropagation(); openOfferMoreMenu('${esc(o.id)}');">
                  â‹¯
                </button>
              </div>
            </div>
          `;
        }).join('');
        
        // Tap on offer item
        providerActiveOffersList.querySelectorAll('[data-offer-id]').forEach(el => {
          if(el.tagName !== 'BUTTON'){
            el.onclick = () => {
              const offerId = el.dataset.offerId;
              startListingFlow({editOfferId: offerId});
            };
          }
        });
        
        const btnProviderShowAllOffers = document.getElementById('btnProviderShowAllOffers');
        if(btnProviderShowAllOffers){
          if(mineActive.length > 3){
            btnProviderShowAllOffers.style.display = 'inline-block';
            btnProviderShowAllOffers.onclick = (e) => {
              e.preventDefault();
              providerActiveOffers.dataset.showAll = 'true';
              renderProviderHome();
            };
          } else {
            btnProviderShowAllOffers.style.display = 'none';
          }
        }
      } else {
        providerActiveOffers.style.display = 'none';
      }
    }
    
    // Quick-Kill-Widget Handler (Not-Aus)
    const btnQuickKill = document.getElementById('btnQuickKill');
    if(btnQuickKill){
      btnQuickKill.onclick = () => {
        if(confirm('âš ï¸ NOT-AUS: MÃ¶chtest du wirklich ALLE aktiven Gerichte fÃ¼r heute schlieÃŸen?\n\nDies kann nicht rÃ¼ckgÃ¤ngig gemacht werden.')){
          const todayKey = isoDate(new Date());
          let closedCount = 0;
          mineToday.forEach(o => {
            const offer = offers.find(off => off.id === o.id);
            if(offer && offer.active !== false){
              offer.active = false;
              closedCount++;
            }
          });
          save(LS.offers, offers);
          showToast(`âœ… ${closedCount} Gericht${closedCount !== 1 ? 'e' : ''} geschlossen`);
          renderProviderHome();
          renderDiscover();
        }
      };
    }
    
    // Storno-Funktion fÃ¼r Bestellungen (0,89 â‚¬ ServicegebÃ¼hr bleibt)
    window.cancelOrder = function(orderId){
      const order = getOrderById(orderId);
      if(!order) return;
      
      if(order.status === 'PICKED_UP' || order.status === 'COMPLETED'){
        alert('Diese Bestellung wurde bereits abgeholt und kann nicht storniert werden.');
        return;
      }
      
      const serviceFee = 0.89; // ServicegebÃ¼hr bleibt
      const refundAmount = (order.total || 0) / 100 - serviceFee;
      
      if(confirm(`Bestellung stornieren?\n\nErstattung: ${euro(refundAmount)}\nServicegebÃ¼hr (0,89 â‚¬) wird einbehalten.\n\nFortfahren?`)){
        updateOrder(orderId, {
          status: 'CANCELLED',
          cancelledAt: Date.now(),
          refundAmount: Math.round(refundAmount * 100), // in cents
          serviceFeeRetained: Math.round(serviceFee * 100) // in cents
        });
        
        showToast(`Bestellung storniert. ${euro(refundAmount)} werden erstattet.`);
        
        // Historie speichern
        const history = load(LS.orderHistory, []);
        history.push({
          orderId: order.id,
          action: 'CANCELLED',
          timestamp: Date.now(),
          refundAmount: refundAmount,
          serviceFeeRetained: serviceFee
        });
        save(LS.orderHistory, history);
        
        // UI aktualisieren
        if(mode === 'provider'){
          renderProviderPickups();
          renderProviderHome();
        }
      }
    };
    
    // Week Preview
    renderProviderWeekPreviewNew();
    
    // Post-Onboarding Dashboard State (if just completed onboarding)
    const providerEmptyDashboard = document.getElementById('providerEmptyDashboard');
    if(providerEmptyDashboard){
      const hasAnyData = mineActive.length > 0 || cookbook.length > 0;
      const justCompletedOnboarding = provider.onboardingCompleted && !provider.onboardingShown && cookbook.length > 0;
      
      if(justCompletedOnboarding){
        // Show post-onboarding state
        providerEmptyDashboard.style.display = 'block';
        providerEmptyDashboard.innerHTML = `
          <div style="font-weight:600; font-size:18px; margin-bottom:8px; line-height:1.3;">Gericht erstellt</div>
          <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:var(--muted);">
            Dein Gericht ist gespeichert. VerÃ¶ffentliche es, um sichtbar zu werden.
          </div>
          <button class="btn-primary" type="button" id="btnPostOnboardingPublish" style="width:100%; min-height:56px; margin-bottom:12px;">
            Gericht verÃ¶ffentlichen
          </button>
          <button class="btn secondary" type="button" id="btnPostOnboardingPlan" style="width:100%; min-height:44px;">
            Weiter planen
          </button>
        `;
        
        const btnPublish = document.getElementById('btnPostOnboardingPublish');
        const btnPlan = document.getElementById('btnPostOnboardingPlan');
        if(btnPublish){
          const savedDish = cookbook.find(c => c.providerId === providerId());
          if(savedDish){
            btnPublish.onclick = () => {
              openDishFlow(); // Unified Flow: Heute
            };
          }
        }
        if(btnPlan) btnPlan.onclick = () => showProviderCookbook();
        
        // Mark onboarding as shown
        provider.onboardingShown = true;
        save(LS.provider, provider);
      } else {
        // Normal empty state
        providerEmptyDashboard.style.display = hasAnyData ? 'none' : 'block';
        if(!hasAnyData){
          providerEmptyDashboard.innerHTML = `
            <div style="font-weight:600; font-size:18px; margin-bottom:8px; line-height:1.3;">Willkommen bei Mittagio</div>
            <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:var(--muted);">
              Starte mit deinem ersten Gericht.
            </div>
            <button class="btn secondary" type="button" id="btnProviderEmptyAddDish" style="width:100%; min-height:44px;">
              Gericht hinzufÃ¼gen
            </button>
          `;
        }
        
        const btnProviderEmptyAddDish = document.getElementById('btnProviderEmptyAddDish');
        if(btnProviderEmptyAddDish) btnProviderEmptyAddDish.onclick = () => {
          // Unified Flow: Ohne Datum = Heute
          openDishFlow();
        };
      }
    }
    
    // FAB
    const fabProviderAddOffer = document.getElementById('fabProviderAddOffer');
    const fabProviderAddOfferLabel = document.getElementById('fabProviderAddOfferLabel');
    if(fabProviderAddOffer){
      fabProviderAddOffer.onclick = () => {
        // Unified Flow: Ohne Datum = Heute
        openDishFlow();
      };
      fabProviderAddOffer.onmouseenter = () => {
        if(fabProviderAddOfferLabel) fabProviderAddOfferLabel.style.opacity = '1';
      };
      fabProviderAddOffer.onmouseleave = () => {
        if(fabProviderAddOfferLabel) fabProviderAddOfferLabel.style.opacity = '0';
      };
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined') setTimeout(()=> lucide.createIcons(), 50);
  }

  // Week Preview (7 Tage) â€“ Wochenplaner: GrÃ¼n = Live, Blau = geplant, Grau = leer
  function renderProviderWeekPreviewNew(){
    const dayWrap = document.getElementById('providerWeekDays');
    const dayContent = document.getElementById('providerWeekDayContent');
    if(!dayWrap || !dayContent) return;
    
    const today = new Date();
    let selectedDay = providerWeekDay || isoDate(today);
    
    dayWrap.innerHTML = '';
    for(let i=0; i<7; i++){
      const d = new Date(today);
      d.setDate(d.getDate() + i);
      const key = isoDate(d);
      const liveCount = offers.filter(o => o.providerId === providerId() && o.day === key && o.active !== false).length;
      const plannedCount = (week[key] || []).filter(x => x.providerId === providerId() && x.active !== false).length;
      const isLive = liveCount > 0;
      const isPlanned = !isLive && plannedCount > 0;
      const statusColor = isLive ? '#10b981' : (isPlanned ? '#3b82f6' : '#9ca3af');
      const b = document.createElement('button');
      b.className = 'day' + (selectedDay === key ? ' active' : '');
      b.style.cssText = 'min-width:44px; min-height:44px; padding:8px 10px; border-radius:12px; border:2px solid ' + (selectedDay === key ? 'var(--color-emerald,#10b981)' : 'transparent') + '; background:' + statusColor + '; color:#fff; font-size:12px; font-weight:700; transition:all 0.2s;';
      const weekday = ['So','Mo','Di','Mi','Do','Fr','Sa'][d.getDay()];
      const dateStr = `${d.getDate()}.${String(d.getMonth()+1).padStart(2,'0')}.`;
      b.textContent = i === 0 ? 'Heute' : `${weekday}\n${dateStr}`;
      b.title = isLive ? 'Inseriert & Live (4,99 â‚¬)' : (isPlanned ? 'Im Kalender geplant' : 'Tag noch leer');
      b.onclick = () => {
        providerWeekDay = key;
        renderProviderWeekPreviewNew();
      };
      dayWrap.appendChild(b);
    }
    
    // Day Content
    const offersForDay = offers.filter(o => o.providerId === providerId() && o.active !== false && o.day === selectedDay);
    const weekEntries = (week[selectedDay] || []).filter(x => x.providerId === providerId() && x.active !== false);
    const totalPlanned = offersForDay.length + weekEntries.length;
    
    if(totalPlanned > 0){
      dayContent.innerHTML = `
        <div style="padding:12px; background:rgba(255,255,255,0.05); border-radius:12px; margin-bottom:12px; border:1px solid rgba(255,255,255,0.1);">
          <div style="font-weight:600; font-size:14px; margin-bottom:8px; color:#fff;">${totalPlanned} ${totalPlanned === 1 ? 'Inserat' : 'Inserate'} geplant</div>
          <div style="font-size:13px; color:rgba(255,255,255,0.5); margin-bottom:12px;">${offersForDay.length} aktiv, ${weekEntries.length} im Wochenplan</div>
        </div>
        <button class="btn secondary" type="button" id="btnProviderWeekAddDish" style="width:100%; min-height:44px; background:rgba(255,255,255,0.1); color:#fff; border:none; font-weight:600;">
          Inserat fÃ¼r diesen Tag hinzufÃ¼gen
        </button>
      `;
      const btnProviderWeekAddDish = document.getElementById('btnProviderWeekAddDish');
      if(btnProviderWeekAddDish) btnProviderWeekAddDish.onclick = () => {
        createFlowPreselectedDate = selectedDay;
        openCreateFlowSheet();
      };
    } else {
      dayContent.innerHTML = `
        <div style="font-weight:600; font-size:16px; margin-bottom:8px; text-align:center; color:#fff;">Keine Inserate geplant</div>
        <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:rgba(255,255,255,0.5); text-align:center;">
          Erstelle ein Inserat fÃ¼r diesen Tag.
        </div>
        <button class="btn secondary" type="button" id="btnProviderWeekAddDishEmpty" style="width:100%; min-height:44px; background:#FFD700; color:#000; border:none; font-weight:700;">
          Inserat fÃ¼r diesen Tag erstellen
        </button>
      `;
      const btnProviderWeekAddDishEmpty = document.getElementById('btnProviderWeekAddDishEmpty');
      if(btnProviderWeekAddDishEmpty) btnProviderWeekAddDishEmpty.onclick = () => {
        createFlowPreselectedDate = selectedDay;
        openCreateFlowSheet();
      };
    }
  }
  
  // KompatibilitÃ¤t
  function renderProviderWeekPreview(){
    const dayWrap = document.getElementById('provWeekDays');
    const list = document.getElementById('provWeekPreview');
    if(!dayWrap || !list) return;

    dayWrap.innerHTML = '';
    for(let i=0;i<5;i++){
      const d = new Date(); d.setDate(d.getDate()+i);
      const key = isoDate(d);
      const b = document.createElement('button');
      b.className = 'day' + (providerWeekDay===key ? ' active' : '');
      b.textContent = fmtDay(d);
      b.onclick=()=>{ providerWeekDay = key; renderProviderWeekPreview(); };
      dayWrap.appendChild(b);
    }

    const items = (week[providerWeekDay]||[]).filter(x=>x.providerId===providerId() && x.active !== false);
    if(!items.length){
      list.innerHTML = `
        <div>Keine Inserate geplant.</div>
        <div style="height:8px"></div>
        <button class="btn secondary" type="button" id="btnWeekAdd">Inserat hinzufÃ¼gen</button>
      `;
      const addBtn = document.getElementById('btnWeekAdd');
      if(addBtn) addBtn.onclick=()=> startListingFlow({});
      return;
    }
    list.innerHTML = items.map(i=>`â€¢ ${esc(i.dish)}`).join('<br>');
  }

  function renderWeekPlan(){
    // Session-AktivitÃ¤t aktualisieren
    updateSessionActivity();
    const dayWrap = document.getElementById('weekDays');
    const list = document.getElementById('weekList');
    if(!dayWrap || !list) return;

    dayWrap.innerHTML = '';
    for(let i=0;i<5;i++){
      const d = new Date(); d.setDate(d.getDate()+i);
      const key = isoDate(d);
      const b = document.createElement('button');
      b.className = 'day' + (weekPlanDay===key ? ' active' : '');
      b.textContent = fmtDay(d);
      b.onclick=()=>{ weekPlanDay = key; renderWeekPlan(); };
      dayWrap.appendChild(b);
    }

    const dayEntries = week[weekPlanDay] || [];
    const providerEntries = dayEntries
      .map((entry, idx)=>({entry, idx}))
      .filter(x=>x.entry.providerId===providerId());

    if(!providerEntries.length){
      list.innerHTML = `
        <div style="font-weight:600; font-size:16px; margin-bottom:8px;">Keine Inserate geplant</div>
        <div class="hint" style="font-size:14px; line-height:1.4; margin-bottom:16px; color:var(--muted);">
          Plane deine Woche und erstelle Inserate.
        </div>
        <button class="btn secondary" type="button" id="btnWeekEmptyAdd" style="width:100%; min-height:44px;">
          Inserat erstellen
        </button>
      `;
      const btnWeekEmptyAdd = document.getElementById('btnWeekEmptyAdd');
      if(btnWeekEmptyAdd) btnWeekEmptyAdd.onclick = () => {
        createFlowPreselectedDate = weekPlanDay;
        openCreateFlowSheet();
      };
      // Hide PDF button in empty state
      const btnWeekPdf = document.getElementById('btnWeekPdf');
      if(btnWeekPdf) btnWeekPdf.style.display = 'none';
      return;
    }

    // Show PDF button only when there are entries
    const btnWeekPdf = document.getElementById('btnWeekPdf');
    if(btnWeekPdf) btnWeekPdf.style.display = 'block';
    
    list.innerHTML = '';
    providerEntries.forEach(({entry, idx})=>{
      const cb = cookbook.find(c=>c.id===entry.cookbookId);
      const name = cb?.dish || entry.dish || 'Gericht';
      const price = cb?.price || 0;
      const isActive = entry.active !== false;

      const item = document.createElement('div');
      item.className = 'cookbook-item';
      item.innerHTML = `
        <div style="font-weight:900">${esc(name)}</div>
        <div class="hint">${euro(price)} - ${isActive ? 'Aktiv' : 'Inaktiv'}</div>
      `;

      const actions = document.createElement('div');
      actions.className = 'cookbook-actions';

      const edit = document.createElement('button');
      edit.type='button';
      edit.className='ans';
      edit.textContent='Bearbeiten';
      edit.onclick=()=>{ if(entry.cookbookId) startWizard('cookbook', {editId: entry.cookbookId}); };

      const toggle = document.createElement('button');
      toggle.type='button';
      toggle.className='ans';
      toggle.textContent = isActive ? 'Deaktivieren' : 'Aktivieren';
      toggle.onclick=()=>{
        const updated = (week[weekPlanDay]||[]).map((x,i)=> i===idx ? {...x, active: !(x.active !== false)} : x);
        if(updated.length) week[weekPlanDay]=updated; else delete week[weekPlanDay];
        save(LS.week, week);
        renderWeekPlan();
        renderProviderWeekPreview();
      };

      const share = document.createElement('button');
      share.type='button';
      share.className='ans';
      share.textContent='Teilen';
      share.onclick=()=>{ shareOffer({dish:name, price}); };

      const print = document.createElement('button');
      print.type='button';
      print.className='ans';
      print.textContent='Drucken';
      print.onclick=()=>{
        const profile = normalizeProviderProfile(provider.profile || {});
        const offer = normalizeOffer({
          providerId: providerId(),
          providerName: profile.name || provider.email || 'Anbieter',
          providerStreet: profile.street||'',
          providerZip: profile.zip||'',
          providerCity: profile.city||'',
          providerLogoData: profile.logoData||'',
          dish: name,
          category: cb?.category || 'Vegetarisch',
          price: Number(price||0),
          pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
          hasPickupCode: !!cb?.hasPickupCode,
          dineInPossible: !!cb?.dineInPossible,
          imageUrl: cb?.photoData || ''
        });
        printOffer(offer);
      };

      actions.appendChild(edit);
      actions.appendChild(toggle);
      actions.appendChild(share);
      actions.appendChild(print);
      item.appendChild(actions);
      list.appendChild(item);
    });
  }

  function pickupCodeCount(dish){
    const base = String(dish||'').split('').reduce((sum, ch)=>sum + ch.charCodeAt(0), 0);
    return 2 + (base % 4); // 2..5
  }

  // Build pickup list (single list, no grouping)
  // Single source of truth: Order record (ordersStore)
  function buildPickupList(){
    const todayKey = isoDate(new Date());
    const providerIdVal = providerId();
    
    // Load from shared ordersStore (localStorage)
    const ordersList = loadOrders();
    
    // Filter: providerId + pickupDate + status=PAID (default "Offen")
    const todayOrders = ordersList.filter(o => {
      // Must be for this provider
      if(o.providerId !== providerIdVal) return false;
      
      // Must be PAID with pickupCode
      if(o.status !== 'PAID' || !o.pickupCode) return false;
      
      // Check pickupDate (from order - single source of truth)
      const orderPickupDate = o.pickupDate;
      if(orderPickupDate){
        return orderPickupDate === todayKey;
      }
      
      // Fallback: check offer.day (for legacy orders)
      const offer = offers.find(off => off.id === o.dishId || off.id === o.offerId);
      return offer && offer.day === todayKey;
    });
    
    if(!todayOrders.length) return [];
    
    // Map orders to pickup items (one Abholnummer = one order; Icons aus Verzehr/Verpackung)
    return todayOrders.map(order => {
      const isPickedUp = order.status === 'PICKED_UP' || order.status === 'COMPLETED' || order.pickupStatus === 'PICKED_UP';
      const hasEatIn = order.verzehrmodus === 'vor_ort';
      const hasReuse = order.verpackung === 'mehrweg' || (order.verpackung && String(order.verpackung).toLowerCase().includes('mehrweg'));
      return {
        orderId: order.id,
        code: order.pickupCode || order.code || '',
        dishName: order.dishName || order.summary || 'Gericht',
        pickupTime: order.pickupWindow || order.etaTime || order.abholzeit || '',
        status: isPickedUp ? 'PICKED_UP' : 'OPEN',
        hasEatIn: !!hasEatIn,
        hasReuse: !!hasReuse,
        order: order
      };
    });
  }

  function renderProviderPickups(){
    // Session-AktivitÃ¤t aktualisieren
    updateSessionActivity();
    const subheader = document.getElementById('provPickupsSubheader');
    const filterEl = document.getElementById('provPickupFilter');
    const empty = document.getElementById('provPickupsEmpty');
    const listEl = document.getElementById('provPickupsList');
    if(!subheader || !filterEl || !empty || !listEl) return;

    // Subheader: "Heute Â· {weekday, date}"
    const today = new Date();
    const weekday = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'][today.getDay()];
    const dateStr = `${today.getDate()}.${String(today.getMonth()+1).padStart(2,'0')}.`;
    subheader.textContent = `Heute Â· ${weekday}, ${dateStr}`;

    // Get all pickups
    const allPickups = buildPickupList();
    
    // Filter pickups
    const filteredPickups = allPickups.filter(p => {
      if(pickupFilter === 'offen') return p.status === 'OPEN';
      if(pickupFilter === 'abgeholt') return p.status === 'PICKED_UP';
      return true;
    });

    // Filter Toggle
    filterEl.innerHTML='';
    [
      {id:'offen', label:'Offen'},
      {id:'abgeholt', label:'Abgeholt'}
    ].forEach(f=>{
      const b=document.createElement('button');
      b.type='button';
      b.className='ans'+(pickupFilter===f.id?' on':'');
      b.textContent=f.label;
      b.onclick=()=>{ pickupFilter=f.id; renderProviderPickups(); };
      filterEl.appendChild(b);
    });

    // Empty States
    if(!allPickups.length){
      empty.style.display='block';
      empty.innerHTML = `
        <div style="font-weight:600; font-size:16px; margin-bottom:8px;">Keine Abholungen</div>
        <div style="font-size:14px; line-height:1.4; color:var(--muted);">Heute gibt es noch keine Abholungen.</div>
      `;
      listEl.style.display='none';
      return;
    }
    
    if(!filteredPickups.length){
      empty.style.display='block';
      if(pickupFilter === 'offen'){
        empty.innerHTML = `
          <div style="font-weight:600; font-size:16px; margin-bottom:8px;">Alles erledigt</div>
          <div style="font-size:14px; line-height:1.4; color:var(--muted);">Alle Abholungen sind abgeschlossen.</div>
        `;
      } else {
        empty.innerHTML = `
          <div style="font-weight:600; font-size:16px; margin-bottom:8px;">Keine abgeholten Bestellungen</div>
          <div style="font-size:14px; line-height:1.4; color:var(--muted);">Noch keine Bestellungen als abgeholt markiert.</div>
        `;
      }
      listEl.style.display='none';
      return;
    }
    
    empty.style.display='none';
    listEl.style.display='none'; // Grid hat PrioritÃ¤t

    // Sort pickups: Zuerst nach Abholzeit (frÃ¼heste zuerst), dann nach Code-Reihenfolge
    const list = [...filteredPickups];
    list.sort((a, b) => {
      // PrioritÃ¤t 1: Abholzeit (frÃ¼heste zuerst)
      const aTime = a.pickupTime || a.etaTime || '';
      const bTime = b.pickupTime || b.etaTime || '';
      if(aTime && bTime){
        // Parse time (z.B. "11:30" -> 1130)
        const parseTime = (timeStr) => {
          const match = String(timeStr).match(/(\d{1,2}):(\d{2})/);
          if(!match) return 9999; // SpÃ¤teste Zeit
          return parseInt(match[1], 10) * 100 + parseInt(match[2], 10);
        };
        const aTimeNum = parseTime(aTime);
        const bTimeNum = parseTime(bTime);
        if(aTimeNum !== bTimeNum) return aTimeNum - bTimeNum;
      }
      
      // PrioritÃ¤t 2: Code-Reihenfolge (1A, 1B, 1C, 2A, 2B, 2C, 10A, 10B...)
      const parseCode = (code) => {
        const match = String(code || '').match(/^(\d+)([A-Z])$/);
        if(!match) return {num: 9999, letter: 'Z'};
        return {num: parseInt(match[1], 10), letter: match[2]};
      };
      const aCode = parseCode(a.code);
      const bCode = parseCode(b.code);
      
      if(aCode.num !== bCode.num) return aCode.num - bCode.num;
      return aCode.letter.localeCompare(bCode.letter);
    });

    // Render Grid (Theken-Grid) - GroÃŸe Kacheln
    const gridEl = document.getElementById('provPickupsGrid');
    if(gridEl){
      gridEl.style.display = filteredPickups.length > 0 ? 'grid' : 'none';
      gridEl.innerHTML = '';
      
      list.forEach(p=>{
        const isDone = p.status === 'PICKED_UP';
        const isPaid = !isDone;
        const codeDisplay = (p.code ? '#' + String(p.code).replace(/\s/g,'') : '#â€“');
        const icons = [];
        if(p.hasEatIn) icons.push('<span style="font-size:18px;" title="Vor Ort">ðŸ´</span>');
        if(p.hasReuse) icons.push('<span style="font-size:18px;" title="Mehrweg">ðŸ”„</span>');
        icons.push('<span style="font-size:18px;" title="Abholnummer">ðŸ§¾</span>');
        const iconsHtml = icons.join(' ');
        
        const card = document.createElement('div');
        card.className = `pickup-card ${isDone ? 'status-done' : 'status-paid'}`;
        card.innerHTML = `
          <div class="pickup-card-header">
            <div class="pickup-card-code">${esc(codeDisplay)}</div>
            <div class="pickup-card-time">${esc(p.pickupTime || 'Sofort')}</div>
          </div>
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px; font-size:16px;">${iconsHtml}</div>
          <div class="pickup-card-body">
            <div class="pickup-card-dish">${esc((p.dishName || 'Gericht').split(',')[0])}</div>
            <div class="pickup-card-customer">${p.order && p.order.customerName ? esc(p.order.customerName) : 'Gast'}</div>
          </div>
          ${!isDone ? '<div class="pickup-card-badge">Bezahlt</div>' : ''}
          <div class="check-overlay"><i data-lucide="check" class="check-icon" style="width:48px;height:48px;color:#fff;stroke-width:4;"></i></div>
        `;
        card.onclick = () => {
          if(isDone){
            if(confirm('Abholnummer wieder als â€žOffenâ€œ markieren?')){
              updateOrder(p.orderId, { status: 'PAID', pickupStatus: undefined, completedAt: undefined });
              renderProviderPickups();
            }
          } else {
            openPickupDetailSheet(p.orderId);
          }
        };
        gridEl.appendChild(card);
      });
        
    }
    
    // Render list (falls Grid nicht verfÃ¼gbar)
    listEl.innerHTML='';
    listEl.style.display = gridEl ? 'none' : (filteredPickups.length > 0 ? 'block' : 'none');
    list.forEach(p=>{
      const isPickedUp = p.status === 'PICKED_UP';
      const codeDisplay = p.code ? '#' + String(p.code).replace(/\s/g,'') : '#â€“';
      const icons = (p.hasEatIn ? 'ðŸ´ ' : '') + (p.hasReuse ? 'ðŸ”„ ' : '') + 'ðŸ§¾';
      const row = document.createElement('div');
      row.className = 'pickup-row' + (isPickedUp ? ' picked-up' : '');
      row.style.cssText = 'display:flex; align-items:center; gap:16px; padding:16px; border-bottom:1px solid var(--border); ' + (isPickedUp ? 'opacity:0.5; background:#f8f8f8;' : 'cursor:pointer;');
      row.innerHTML = `
        <div style="font-size:32px; font-weight:900; font-family:monospace; color:var(--brand); min-width:70px; text-align:center; line-height:1;">${esc(codeDisplay)}</div>
        <div style="font-size:16px; margin-right:8px;">${icons}</div>
        <div style="flex:1; min-width:0;">
          <div style="font-weight:600; font-size:16px; line-height:1.3; margin-bottom:4px;">${esc((p.dishName||'').split(',')[0])}</div>
          <div style="font-size:14px; color:var(--muted); margin-bottom:4px;">${esc(p.pickupTime || '')}</div>
          <div style="font-size:13px; color:${isPickedUp ? 'var(--muted)' : '#2e7d32'}; font-weight:500;">${isPickedUp ? 'âœ… Abgeholt' : 'ðŸŸ¢ Bezahlt'}</div>
        </div>
      `;
      if(!isPickedUp){
        row.onclick = () => openPickupDetailSheet(p.orderId);
      }
      listEl.appendChild(row);
    });
    
    // PDF-KÃ¼chenliste Buttons
    const btnKitchenListPDF = document.getElementById('btnKitchenListPDF');
    const btnKitchenListEmail = document.getElementById('btnKitchenListEmail');
    if(btnKitchenListPDF){
      btnKitchenListPDF.onclick = () => {
        generateKitchenListPDF();
      };
    }
    if(btnKitchenListEmail){
      btnKitchenListEmail.onclick = () => {
        emailKitchenList();
      };
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }
  
  // Pickup Detail Sheet (Sammel-Ansicht: Abholnummer, Gerichte, Vor Ort/Mehrweg, Alles Ã¼bergeben)
  let currentPickupConfirmOrderId = null;
  
  function openPickupConfirmSheet(orderId, code, dishName){
    openPickupDetailSheet(orderId);
  }
  
  function openPickupDetailSheet(orderId){
    const order = getOrderById(orderId);
    if(!order) return;
    currentPickupConfirmOrderId = orderId;
    const code = order.pickupCode || order.code || 'â€“';
    const codeDisplay = code ? '#' + String(code).replace(/\s/g,'') : '#â€“';
    const codeEl = document.getElementById('pickupConfirmCode');
    if(codeEl) codeEl.textContent = codeDisplay;
    const hasEatIn = order.verzehrmodus === 'vor_ort';
    const hasReuse = order.verpackung === 'mehrweg' || (order.verpackung && String(order.verpackung).toLowerCase().includes('mehrweg'));
    const iconsRow = document.getElementById('pickupConfirmIcons');
    if(iconsRow) iconsRow.innerHTML = (hasEatIn ? '<span title="Vor Ort">ðŸ´</span>' : '') + (hasReuse ? '<span title="Mehrweg">ðŸ”„</span>' : '') + '<span title="Abholnummer">ðŸ§¾</span>';
    const dishesEl = document.getElementById('pickupConfirmDishes');
    if(dishesEl){
      const dishLines = (order.dishName || order.summary || 'Gericht').split(',').map(s => s.trim()).filter(Boolean);
      if(!dishLines.length) dishLines.push('Gericht');
      dishesEl.innerHTML = dishLines.map(line => {
        const icon = hasEatIn ? 'ðŸ´ Vor Ort' : (hasReuse ? 'ðŸ”„ Mehrweg' : 'ðŸ§¾');
        return `<div style="display:flex; align-items:center; justify-content:space-between; padding:12px 14px; background:#f8f9fa; border-radius:12px; font-size:15px;"><span>${esc(line)}</span><span style="font-size:14px; color:#64748b;">${esc(icon)}</span></div>`;
      }).join('');
    }
    document.getElementById('pickupConfirmBd').classList.add('active');
    document.getElementById('pickupConfirmSheet').classList.add('active');
  }
  
  function closePickupConfirmSheet(){
    document.getElementById('pickupConfirmBd').classList.remove('active');
    document.getElementById('pickupConfirmSheet').classList.remove('active');
    currentPickupConfirmOrderId = null;
  }
  
  function showPickupSuccessThenNextStep(orderId){
    const order = getOrderById(orderId);
    if(!order) return;
    const totalEur = (order.total || 0) / 100;
    const netto = Math.max(0, totalEur - ABHOLNUMMER_FEE);
    const nettoStr = netto.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' â‚¬';
    const overlay = document.getElementById('pickupSuccessOverlay');
    const nettoEl = document.getElementById('pickupSuccessNetto');
    if(overlay){ overlay.style.display = 'flex'; }
    if(nettoEl){ nettoEl.textContent = 'Netto-Verdienst: ' + nettoStr; }
    setTimeout(() => {
      if(overlay) overlay.style.display = 'none';
      const allPickups = buildPickupList();
      const openPickups = allPickups.filter(p => p.status === 'OPEN');
      const nextEl = document.getElementById('pickupNextStepOverlay');
      const titleEl = document.getElementById('pickupNextStepTitle');
      const listEl = document.getElementById('pickupNextStepList');
      if(nextEl) nextEl.style.display = 'flex';
      if(titleEl) titleEl.textContent = openPickups.length ? 'ðŸŽ‰ Noch ' + openPickups.length + ' Essen offen!' : 'ðŸŽ‰ Alles erledigt!';
      if(listEl){
        const next3 = openPickups.slice(0, 3);
        listEl.innerHTML = next3.length ? next3.map(p => {
          const codeDisplay = p.code ? '#' + String(p.code).replace(/\s/g,'') : '#â€“';
          return '<button type="button" data-order-id="' + esc(p.orderId) + '" style="display:flex; align-items:center; justify-content:space-between; padding:14px 16px; background:#f1f5f9; border:none; border-radius:14px; font-size:16px; font-weight:700; cursor:pointer; text-align:left;">' + esc(codeDisplay) + ' <span style="color:#64748b; font-weight:500;">â†’</span></button>';
        }).join('') : '<p style="margin:0; color:#64748b; font-size:15px;">Keine weiteren Abholnummern.</p>';
        listEl.querySelectorAll('button[data-order-id]').forEach(btn => {
          btn.onclick = () => {
            const id = btn.getAttribute('data-order-id');
            document.getElementById('pickupNextStepOverlay').style.display = 'none';
            if(id) openPickupDetailSheet(id);
          };
        });
      }
      const btnClose = document.getElementById('btnPickupNextStepClose');
      if(btnClose) btnClose.onclick = () => { document.getElementById('pickupNextStepOverlay').style.display = 'none'; renderProviderPickups(); };
    }, 2200);
  }
  
  const btnPickupConfirmYes = document.getElementById('btnPickupConfirmYes');
  if(btnPickupConfirmYes){
    btnPickupConfirmYes.onclick = () => {
      if(!currentPickupConfirmOrderId) return;
      const order = getOrderById(currentPickupConfirmOrderId);
      if(!order) return;
      updateOrder(currentPickupConfirmOrderId, { status: 'PICKED_UP', pickupStatus: 'PICKED_UP', completedAt: Date.now() });
      closePickupConfirmSheet();
      renderProviderPickups();
      showPickupSuccessThenNextStep(currentPickupConfirmOrderId);
    };
  }
  
  const btnPickupConfirmNo = document.getElementById('btnPickupConfirmNo');
  if(btnPickupConfirmNo){
    btnPickupConfirmNo.onclick = () => { closePickupConfirmSheet(); };
  }

  function showPickupUndo(key){
    pickupUndoKey = key;
    const snack = document.getElementById('pickupUndo');
    if(!snack) return;
    const label = document.getElementById('pickupUndoLabel');
    if(label) label.textContent = 'Abholung markiert';
    const btn = document.getElementById('pickupUndoBtn');
    if(btn){
      btn.onclick=()=>{
        if(pickupUndoKey && pickupDone.has(pickupUndoKey)){
          pickupDone.delete(pickupUndoKey);
          save(LS.pickupDone, Array.from(pickupDone));
          renderProviderPickups();
        }
        hidePickupUndo();
      };
    }
    snack.classList.add('active');
    if(pickupUndoTimer) clearTimeout(pickupUndoTimer);
    pickupUndoTimer = setTimeout(hidePickupUndo, 5000);
  }

  function hidePickupUndo(){
    const snack = document.getElementById('pickupUndo');
    if(!snack) return;
    snack.classList.remove('active');
    pickupUndoKey = null;
  }

  function renderProviderProfile(){
    // Session-AktivitÃ¤t aktualisieren
    updateSessionActivity();
    const p = normalizeProviderProfile(provider.profile || {});
    const addr = buildAddress(p);
    const name = p.name || provider.email || 'Anbieter';
    
    // Progressive Disclosure: MenÃ¼-Zeilen und ZurÃ¼ck-Buttons
    function goProfileSub(id){ showProviderProfileSub(id); }
    function goProfileBack(){ showProviderProfileSub(null); }
    ['Business','Times','Service','Payment','Faq'].forEach(function(cap){
      var row = document.getElementById('providerProfileRow' + cap);
      var back = document.getElementById('providerProfileBack' + cap);
      var subId = cap.toLowerCase();
      if(row) row.onclick = function(){ goProfileSub(subId); };
      if(back) back.onclick = goProfileBack;
    });
    var btnBillingArchive = document.getElementById('btnBillingArchive');
    if(btnBillingArchive) btnBillingArchive.onclick = function(){ showView(views.providerBilling); renderBilling(); };
    var providerSupportChat = document.getElementById('providerSupportChat');
    if(providerSupportChat){ providerSupportChat.onclick = function(e){ e.preventDefault(); showToast('Chat wird geÃ¶ffnet'); }; }
    var btnProviderDeleteAccount = document.getElementById('btnProviderDeleteAccount');
    if(btnProviderDeleteAccount){ btnProviderDeleteAccount.onclick = function(){ if(confirm('Account wirklich dauerhaft lÃ¶schen? Diese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden.')) { showToast('Account-LÃ¶schung angefragt.'); } }; }

    // Logo rendern (helles Theme: Platzhalter mit Initialen)
    const logoWrap = document.getElementById('providerProfileLogo');
    if(logoWrap){
      if(p.logoData){
        logoWrap.style.backgroundImage = `url('${esc(p.logoData)}')`;
        logoWrap.innerHTML = '';
      } else {
        const initials = name.charAt(0).toUpperCase();
        logoWrap.style.backgroundImage = 'none';
        logoWrap.innerHTML = `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:32px; font-weight:900; color:#666;">${esc(initials)}</div>`;
      }
    }
    
    // Name & Adresse
    const nameEl = document.getElementById('providerProfileName');
    const addrEl = document.getElementById('providerProfileAddress');
    if(nameEl) nameEl.textContent = name;
    if(addrEl){
      if(addr){
        addrEl.textContent = esc(addr);
        addrEl.style.color = '#666';
      } else {
        addrEl.textContent = 'Standort-Adresse hinzufÃ¼gen';
        addrEl.style.color = '#b45309';
      }
    }
    
    // Kontaktdaten (Telefon, E-Mail, Internetseite)
    const profilePhone = document.getElementById('providerProfilePhone');
    const profileEmail = document.getElementById('providerProfileEmail');
    const profileWebsite = document.getElementById('providerProfileWebsite');
    if(profilePhone){ profilePhone.value = p.phone || ''; profilePhone.onchange = ()=>{ if(!provider.profile) provider.profile = {}; provider.profile.phone = profilePhone.value; save(LS.provider, provider); showToast('Telefon gespeichert'); }; }
    if(profileEmail){ profileEmail.value = p.email || ''; profileEmail.onchange = ()=>{ if(!provider.profile) provider.profile = {}; provider.profile.email = profileEmail.value; save(LS.provider, provider); showToast('E-Mail gespeichert'); }; }
    if(profileWebsite){ profileWebsite.value = p.website || ''; profileWebsite.onchange = ()=>{ if(!provider.profile) provider.profile = {}; provider.profile.website = profileWebsite.value; save(LS.provider, provider); showToast('Internetseite gespeichert'); }; }
    
    // Meine Mittagszeiten: Start/Ende
    const mealStartEl = document.getElementById('providerMealStart');
    const mealEndEl = document.getElementById('providerMealEnd');
    const saveMealWindow = () => {
      if(!provider.profile) provider.profile = {};
      const start = mealStartEl ? mealStartEl.value : p.mealStart || '11:30';
      const end = mealEndEl ? mealEndEl.value : p.mealEnd || '14:00';
      provider.profile.mealStart = start;
      provider.profile.mealEnd = end;
      provider.profile.mealWindow = `${start} â€“ ${end}`;
      save(LS.provider, provider);
      showToast('Mittagszeiten gespeichert');
    };
    if(mealStartEl){ mealStartEl.value = p.mealStart || '11:30'; mealStartEl.onchange = saveMealWindow; }
    if(mealEndEl){ mealEndEl.value = p.mealEnd || '14:00'; mealEndEl.onchange = saveMealWindow; }
    
    // Wochentage (Mo=1 â€¦ So=7)
    const weekdaysWrap = document.getElementById('providerLunchWeekdays');
    if(weekdaysWrap){
      const labels = [{d:1,l:'Mo'},{d:2,l:'Di'},{d:3,l:'Mi'},{d:4,l:'Do'},{d:5,l:'Fr'},{d:6,l:'Sa'},{d:7,l:'So'}];
      const arr = Array.isArray(p.lunchWeekdays) ? p.lunchWeekdays : [1,2,3,4,5];
      weekdaysWrap.innerHTML = labels.map(({d,l}) => `<label style="display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border-radius:10px; border:2px solid ${arr.includes(d)?'#10b981':'#e7e1d5'}; background:${arr.includes(d)?'rgba(16,185,129,0.1)':'#fff'}; cursor:pointer; font-size:14px; font-weight:600;"><input type="checkbox" data-wd="${d}" ${arr.includes(d)?'checked':''} style="width:18px; height:18px;">${l}</label>`).join('');
      weekdaysWrap.querySelectorAll('input[type=checkbox]').forEach(cb => {
        cb.onchange = () => {
          const wd = parseInt(cb.dataset.wd, 10);
          if(!provider.profile) provider.profile = {};
          if(!Array.isArray(provider.profile.lunchWeekdays)) provider.profile.lunchWeekdays = [1,2,3,4,5];
          if(cb.checked) { if(!provider.profile.lunchWeekdays.includes(wd)) provider.profile.lunchWeekdays.push(wd); }
          else provider.profile.lunchWeekdays = provider.profile.lunchWeekdays.filter(x => x !== wd);
          provider.profile.lunchWeekdays.sort((a,b)=>a-b);
          save(LS.provider, provider);
          showToast('Wochentage gespeichert');
          renderProviderProfile();
        };
      });
    }
    
    // Abholnummer-Standard-Toggle
    const abholnummerEnabled = document.getElementById('providerAbholnummerEnabled');
    const abholnummerSwitch = abholnummerEnabled ? abholnummerEnabled.closest('.toggle-switch') : null;
    if(abholnummerEnabled){
      abholnummerEnabled.checked = p.abholnummerEnabledByDefault || false;
      if(abholnummerSwitch){ abholnummerEnabled.checked ? abholnummerSwitch.classList.add('active') : abholnummerSwitch.classList.remove('active'); }
      abholnummerEnabled.onchange = () => {
        if(!provider.profile) provider.profile = {};
        provider.profile.abholnummerEnabledByDefault = abholnummerEnabled.checked;
        save(LS.provider, provider);
        if(abholnummerSwitch){ abholnummerEnabled.checked ? abholnummerSwitch.classList.add('active') : abholnummerSwitch.classList.remove('active'); }
        showToast(abholnummerEnabled.checked ? 'Abholnummer standardmÃ¤ÃŸig an' : 'Abholnummer standardmÃ¤ÃŸig aus');
      };
      if(abholnummerSwitch){ abholnummerSwitch.onclick = () => { abholnummerEnabled.checked = !abholnummerEnabled.checked; abholnummerEnabled.onchange(); }; }
    }
    
    // Account: Status 1 aktive Sitzung
    const sessionStatusEl = document.getElementById('providerSessionStatus');
    if(sessionStatusEl) sessionStatusEl.textContent = '1 aktive Sitzung';
    const btnChangeEmail = document.getElementById('btnProviderChangeEmail');
    if(btnChangeEmail){ btnChangeEmail.onclick = (e) => { e.preventDefault(); showToast('E-Mail & Passwort Ã¤ndern: In der App unter Account verfÃ¼gbar.'); }; }
    
    // KÃ¼chen-Zeiten: Automatischer Ausverkauf
    const autoSelloutTime = document.getElementById('providerAutoSelloutTime');
    if(autoSelloutTime){
      autoSelloutTime.value = p.autoSelloutTime || '14:00';
      autoSelloutTime.onchange = () => {
        if(!provider.profile) provider.profile = {};
        provider.profile.autoSelloutTime = autoSelloutTime.value;
        save(LS.provider, provider);
        showToast('KÃ¼chen-Zeiten gespeichert');
        
        // Automatischen Ausverkauf aktivieren (wenn Zeit erreicht)
        checkAutoSellout();
      };
    }
    
    // KÃ¼chen-E-Mail
    const kitchenEmail = document.getElementById('providerKitchenEmail');
    if(kitchenEmail){
      kitchenEmail.value = p.kitchenEmail || '';
      kitchenEmail.onchange = () => {
        if(!provider.profile) provider.profile = {};
        provider.profile.kitchenEmail = kitchenEmail.value;
        save(LS.provider, provider);
        showToast('KÃ¼chen-E-Mail gespeichert');
      };
    }
    
    // Mehrweg-Pfandsystem Switch
    const reuseEnabled = document.getElementById('providerReuseEnabled');
    const reuseSwitch = reuseEnabled ? reuseEnabled.closest('.toggle-switch') : null;
    if(reuseEnabled){
      reuseEnabled.checked = p.reuseEnabledByDefault || false;
      if(reuseSwitch){
        if(reuseEnabled.checked) reuseSwitch.classList.add('active');
        else reuseSwitch.classList.remove('active');
      }
      reuseEnabled.onchange = () => {
        if(!provider.profile) provider.profile = {};
        provider.profile.reuseEnabledByDefault = reuseEnabled.checked;
        save(LS.provider, provider);
        if(reuseSwitch){
          if(reuseEnabled.checked) reuseSwitch.classList.add('active');
          else reuseSwitch.classList.remove('active');
        }
        showToast(reuseEnabled.checked ? 'Mehrweg-Pfandsystem aktiviert' : 'Mehrweg-Pfandsystem deaktiviert');
      };
      // Toggle-Switch Klick-Handler
      if(reuseSwitch){
        reuseSwitch.onclick = () => {
          reuseEnabled.checked = !reuseEnabled.checked;
          reuseEnabled.onchange();
        };
      }
    }
    
    // Speisekarte teilen Button
    const btnShareMenu = document.getElementById('btnProviderShareMenu');
    if(btnShareMenu){
      btnShareMenu.onclick = () => {
        shareProviderMenu();
      };
    }
    
    // Finanz-Dashboard: Zeit-Ersparnis
    const timeSavedEl = document.getElementById('providerProfileTimeSaved');
    if(timeSavedEl){
      const todayAbholnummern = loadOrders().filter(o => {
        const offer = offers.find(off => off.id === o.dishId || off.providerId === o.providerId);
        return offer && offer.providerId === providerId() && offer.day === isoDate(new Date()) && o.status === 'PAID';
      }).length;
      const timeSavedMinutes = Math.round(todayAbholnummern * 1.5);
      timeSavedEl.textContent = `${timeSavedMinutes} Minuten`;
    }
    
    // Netto-Auszahlung pro Abholnummer (Beispiel: Durchschnittspreis - 0,89 â‚¬)
    const netPayoutEl = document.getElementById('providerProfileNetPayout');
    if(netPayoutEl){
      const todayOffers = offers.filter(o => o.providerId === providerId() && o.day === isoDate(new Date()) && o.active !== false);
      if(todayOffers.length > 0){
        const avgPrice = todayOffers.reduce((sum, o) => sum + (o.price || 0), 0) / todayOffers.length;
        const netPayout = Math.max(0, avgPrice - 0.89);
        netPayoutEl.textContent = euro(netPayout);
      } else {
        netPayoutEl.textContent = 'â€“';
      }
    }
    
    // Icons aktualisieren (inkl. Support-Segment mit Herz-Icon)
    if(typeof lucide !== 'undefined'){
      setTimeout(() => lucide.createIcons(), 50);
    }
  }
  
  // Speisekarte teilen (Provider-MenÃ¼)
  function shareProviderMenu(){
    const profile = normalizeProviderProfile(provider.profile || {});
    const providerName = profile.name || provider.email || 'Anbieter';
    const providerIdVal = providerId();
    
    // Alle aktiven Gerichte des Providers sammeln
    const providerOffers = offers.filter(o => o.providerId === providerIdVal && o.active !== false);
    
    if(providerOffers.length === 0){
      showToast('Keine Gerichte zum Teilen');
      return;
    }
    
    const shareUrl = `${location.origin}${location.pathname}#provider/${providerIdVal}`;
    const shareText = `Schau mal, was es bei ${providerName} gibt!\n\n${providerOffers.slice(0, 5).map(o => `â€¢ ${o.dish || o.title || 'Gericht'} - ${euro(o.price || 0)}`).join('\n')}${providerOffers.length > 5 ? `\n... und ${providerOffers.length - 5} weitere` : ''}\n\n${shareUrl}`;
    
    if(navigator.share){
      navigator.share({
        title: `Speisekarte ${providerName}`,
        text: shareText,
        url: shareUrl
      }).then(() => {
        showToast('Speisekarte geteilt!');
      }).catch((err) => {
        if(err.name !== 'AbortError'){
          copyToClipboard(shareText);
          showToast('Link kopiert!');
        }
      });
    } else {
      copyToClipboard(shareText);
      showToast('Link kopiert!');
    }
  }
  
  // Automatischer Ausverkauf prÃ¼fen (wird regelmÃ¤ÃŸig aufgerufen)
  function checkAutoSellout(){
    const profile = normalizeProviderProfile(provider.profile || {});
    const autoSelloutTime = profile.autoSelloutTime;
    if(!autoSelloutTime) return;
    
    const now = new Date();
    const [hours, minutes] = autoSelloutTime.split(':').map(Number);
    const selloutTime = new Date();
    selloutTime.setHours(hours, minutes, 0, 0);
    
    // PrÃ¼fe ob aktuelle Zeit >= Ausverkauf-Zeit
    if(now >= selloutTime){
      const todayKey = isoDate(now);
      const mineToday = offers.filter(o => o.providerId === providerId() && o.day === todayKey && o.active !== false);
      
      if(mineToday.length > 0){
        let changed = false;
        mineToday.forEach(o => {
          if(o.active !== false){
            o.active = false;
            changed = true;
          }
        });
        
        if(changed){
          save(LS.offers, offers);
          renderProviderHome();
          renderDiscover();
          showToast('Automatischer Ausverkauf: Alle Gerichte deaktiviert');
        }
      }
    }
  }
  
  // Automatischen Ausverkauf regelmÃ¤ÃŸig prÃ¼fen (alle 5 Minuten)
  setInterval(checkAutoSellout, 5 * 60 * 1000);

  function renderBilling(){
    // Kosten-Info-Box (ganz oben) - Neue Terminologie
    const costInfoEl = document.getElementById('billingCostInfo');
    if(costInfoEl){
      costInfoEl.innerHTML = `
        <div style="font-weight:600; font-size:16px; margin-bottom:12px; color:#2e7d32;">GebÃ¼hren â€“ kurz erklÃ¤rt</div>
        <div style="font-size:14px; line-height:1.6; color:#333; margin-bottom:8px;">
          <div style="margin-bottom:8px;">
            <strong>InseratsgebÃ¼hr: 4,99 â‚¬</strong> (einmalig pro Gericht)
          </div>
          <div>
            <strong>All-In ErfolgsgebÃ¼hr: 0,89 â‚¬</strong> pro verkaufter Abholnummer<br>
            <span style="font-size:12px; color:#666; font-style:italic;">
              Beinhaltet bereits alle Bank-, Stripe- und VerwaltungsgebÃ¼hren
            </span>
          </div>
        </div>
        <div style="margin-top:12px; padding:12px; background:rgba(31,157,85,0.1); border-radius:12px; border-left:4px solid #1f9d55;">
          <div style="font-size:13px; color:#2D3436; font-weight:600; margin-bottom:4px;">ðŸ’¡ Wichtig:</div>
          <div style="font-size:12px; color:#666; line-height:1.5;">
            Alle BetrÃ¤ge sind Netto-Auszahlungen inkl. abgegoltenen TransaktionsgebÃ¼hren.
          </div>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <a href="#/datenschutz" onclick="showLegalPage('datenschutz'); return false;" style="font-size:13px; color:var(--brand); text-decoration:none;">Datenschutz</a>
        </div>
      `;
    }
    
    const amountEl = document.getElementById('billingAmount');
    const lastEl = document.getElementById('billingLast');
    const filtersEl = document.getElementById('billingFilters');
    const monthEl = document.getElementById('billingMonth');
    const listEl = document.getElementById('billingList');
    if(!amountEl || !lastEl || !filtersEl || !monthEl || !listEl) return;

    // Demo-Daten: Berechnung nach Formel (Verkaufspreis - 0,89 â‚¬ pro Abholnummer)
    // Beispiel: 18 VerkÃ¤ufe Ã  8,50 â‚¬ = 153,00 â‚¬ Gesamt
    // GebÃ¼hren: 18 Ã— 0,89 â‚¬ = 16,02 â‚¬
    // Auszahlung: 153,00 â‚¬ - 16,02 â‚¬ = 136,98 â‚¬
    const demo = [
      {range:'06.01.â€“12.01.2026', sales:18, total:153.00, fee:16.02, payout:136.98, status:'NÃ¤chste Auszahlung geplant'},
      {range:'30.12.â€“05.01.2026', sales:12, total:102.00, fee:10.68, payout:91.32, status:'Auszahlung erfolgt'}
    ];

    amountEl.textContent = euro(demo[0].payout);
    lastEl.textContent = `Letzte Auszahlung: ${demo[1].range} Â· ${euro(demo[1].payout)}`;

    const filters = [
      {id:'today', label:'Heute'},
      {id:'week', label:'Woche'},
      {id:'month', label:'Monat'},
      {id:'custom', label:'Benutzerdefiniert'}
    ];
    filtersEl.innerHTML = '';
    filters.forEach(f=>{
      const b=document.createElement('button');
      b.type='button';
      b.className='ans'+(billingFilter===f.id?' on':'');
      b.textContent=f.label;
      b.onclick=()=>{ billingFilter = f.id; renderBilling(); };
      filtersEl.appendChild(b);
    });

    monthEl.value = billingMonth;
    monthEl.onchange = ()=>{ billingMonth = monthEl.value; renderBilling(); };

    listEl.innerHTML = demo.map(d=>`
      <div class="cookbook-item">
        <div style="font-weight:900">${esc(d.range)}</div>
        <div class="cookbook-facts">
          Abholnummern verkauft: ${d.sales} Â· Gesamtumsatz: ${euro(d.total)}<br>
          All-In ErfolgsgebÃ¼hren: ${euro(d.fee)} Â· <b style="color:#2ECC71;">Auszahlung: ${euro(d.payout)}</b><br>
          <span style="font-size:11px; color:#666;">Netto-Auszahlung inkl. abgegoltenen TransaktionsgebÃ¼hren</span><br>
          Status: ${esc(d.status)}
        </div>
        <div class="cookbook-actions">
          <button class="card-action" type="button" data-icon="print">PDF-Download</button>
        </div>
      </div>
    `).join('');
    listEl.querySelectorAll('button').forEach(btn=>{
      btn.onclick=()=> alert('PDF-Download (Demo).');
    });
    applyStaticIcons();
  }

  const btnProvFaq = document.getElementById('btnProvFaq');
  if(btnProvFaq){
    btnProvFaq.onclick=()=>{
      // Navigiere zu Anbieter-FAQ
      showLegalPage('faq-provider');
      // URL aktualisieren fÃ¼r Provider-Mode
      if(mode === 'provider'){
        pushViewState({view: 'provider-faq', mode: mode}, '/anbieter/hilfe/faq');
      }
    };
  }

  const btnBilling = document.getElementById('btnBilling');
  if(btnBilling){
    btnBilling.onclick=()=>{
      showView(views.providerBilling);
      renderBilling();
      // Browser-Verlauf aktualisieren
      pushViewState({view: 'provider-billing', mode: mode}, location.pathname);
    };
  }
  const btnBillingBack = document.getElementById('btnBillingBack');
  if(btnBillingBack){
    btnBillingBack.onclick=()=> showProviderProfile();
  }

  const rowProfileOverview = document.getElementById('rowProfileOverview');
  if(rowProfileOverview){
    rowProfileOverview.onclick=()=>{
      // ProfilÃ¼bersicht: Navigiere zu Profil-Seite
      showProviderProfile();
      window.scrollTo({top: 0, behavior: 'smooth'});
    };
  }
  
  // Profil bearbeiten Button (neu im "Mein Profil" Abschnitt)
  const btnProfileEdit = document.getElementById('btnProfileEdit');
  if(btnProfileEdit){
    btnProfileEdit.onclick=()=>{
      startWizard('provider');
    };
  }

  const btnProvShareOffer = document.getElementById('btnProvShareOffer');
  if(btnProvShareOffer){
    btnProvShareOffer.onclick=()=>{
      const first = offers.find(o=>o.providerId===providerId());
      if(first) {
        try {
          shareOffer(first);
        } catch(err) {
          console.error('Share error:', err);
          showToast('Teilen kommt als nÃ¤chstes.');
        }
      } else {
        showToast('Noch keine Inserate zum Teilen.');
      }
    };
  }
  const btnProvWeekPdf = document.getElementById('btnProvWeekPdf');
  if(btnProvWeekPdf){
    btnProvWeekPdf.onclick=()=> printWeekCard();
  }
  // Provider Support (nur im Anbieter-Dashboard, support@mittagio.de)
  const btnProvSupport = document.getElementById('btnProvSupport');
  if(btnProvSupport){
    btnProvSupport.onclick=()=>{
      window.location.href = 'mailto:support@mittagio.de';
    };
  }

  // Legal Pages Navigation (statische Seiten)
  function showLegalPage(page){
    // Separate Impressen und AGBs fÃ¼r Kunden und Anbieter
    const isProvider = mode === 'provider';
    const pageMap = {
      'impressum': isProvider ? 'v-legal-impressum-provider' : 'v-legal-impressum',
      'agb-kurz': isProvider ? 'v-legal-agb-provider' : 'v-legal-agb-kurz',
      'agb-provider': 'v-legal-agb-provider',
      'impressum-provider': 'v-legal-impressum-provider',
      'datenschutz': isProvider ? 'v-legal-datenschutz-provider' : 'v-legal-datenschutz',
      'datenschutz-provider': 'v-legal-datenschutz-provider',
      'faq': 'v-legal-faq',
      'support': 'v-support',
      'faq-provider': 'v-legal-faq-provider'
    };
    const viewId = pageMap[page];
    if(viewId){
      showView(viewId);
      window.scrollTo({top:0, behavior:'smooth'});
      // Wenn FAQ, auf Anbieter-Tab wechseln wenn Provider-Modus
      if(viewId === 'v-legal-faq' && isProvider){
        setTimeout(() => switchFaqTab('provider'), 100);
      }
      // URL aktualisieren fÃ¼r Provider-Mode
      if(isProvider){
        const urlMap = {
          'faq-provider': '/anbieter/hilfe/faq',
          'impressum-provider': '/anbieter/recht/impressum',
          'agb-provider': '/anbieter/recht/agb',
          'datenschutz': '/anbieter/recht/datenschutz',
          'datenschutz-provider': '/anbieter/recht/datenschutz'
        };
        const url = urlMap[page];
        if(url){
          pushViewState({view: `provider-${page}`, mode: mode}, url);
        }
      }
    }
  }
  
  // FAQ-Tab wechseln
  function switchFaqTab(tab){
    const customerTab = document.getElementById('faqTabCustomer');
    const providerTab = document.getElementById('faqTabProvider');
    const customerContent = document.getElementById('faqContentCustomer');
    const providerContent = document.getElementById('faqContentProvider');
    
    if(tab === 'customer'){
      if(customerTab){
        customerTab.style.background = '#fff';
        customerTab.style.borderBottom = '3px solid #FFD700';
        customerTab.style.fontWeight = '700';
        customerTab.style.color = '#334155';
      }
      if(providerTab){
        providerTab.style.background = '#f9f9f9';
        providerTab.style.borderBottom = '3px solid transparent';
        providerTab.style.fontWeight = '600';
        providerTab.style.color = '#666';
      }
      if(customerContent) customerContent.style.display = 'block';
      if(providerContent) providerContent.style.display = 'none';
    } else {
      if(providerTab){
        providerTab.style.background = '#fff';
        providerTab.style.borderBottom = '3px solid #FFD700';
        providerTab.style.fontWeight = '700';
        providerTab.style.color = '#334155';
      }
      if(customerTab){
        customerTab.style.background = '#f9f9f9';
        customerTab.style.borderBottom = '3px solid transparent';
        customerTab.style.fontWeight = '600';
        customerTab.style.color = '#666';
      }
      if(providerContent) providerContent.style.display = 'block';
      if(customerContent) customerContent.style.display = 'none';
    }
  }
  
  function goBackFromLegalPage(){
    // ZurÃ¼ck zur Profil-Seite (Kunde oder Anbieter)
    if(mode === 'provider'){
      showProviderProfile();
    } else {
      showProfile();
    }
  }

  // Provider Legal Links - Ã¶ffnen statische Seiten
  const btnLegalImprint = document.getElementById('btnLegalImprint');
  if(btnLegalImprint){
    btnLegalImprint.onclick=()=>{
      showLegalPage('impressum');
    };
  }
  const btnLegalPrivacy = document.getElementById('btnLegalPrivacy');
  if(btnLegalPrivacy){
    btnLegalPrivacy.onclick=()=>{
      showLegalPage('datenschutz');
    };
  }
  const btnLegalTerms = document.getElementById('btnLegalTerms');
  if(btnLegalTerms){
    btnLegalTerms.onclick=()=>{
      showLegalPage('agb-kurz');
    };
  }
  
  // Provider-Profil: AGB | Datenschutz | Impressum sind im Footer per onclick gebunden (showLegalPage 'agb-provider', 'datenschutz-provider', 'impressum-provider').
  
  // Support-Kontakt Ã¶ffnen (von Vertrauens-Segment)
  // Funktion ist bereits oben definiert: openSupportContact()
  // Wird automatisch von onclick="openSupportContact()" im HTML aufgerufen

  // Provider actions (Create Flow Sheet)
  // btnNewListing und btnFromCookbook werden nicht mehr verwendet
  const btnNewListing = document.getElementById('btnNewListing');
  if(btnNewListing) btnNewListing.style.display = 'none';
  const btnFromCookbook = document.getElementById('btnFromCookbook');
  if(btnFromCookbook) btnFromCookbook.style.display = 'none';
  
  // Kochbuch: "+ Gericht hinzufÃ¼gen" Ã¶ffnet IMMER Unified Flow
  const btnCookbookAdd = document.getElementById('btnCookbookAdd');
  if(btnCookbookAdd) btnCookbookAdd.onclick=()=> openDishFlow();
  const btnCookbookAddSticky = document.getElementById('btnCookbookAddSticky');
  if(btnCookbookAddSticky) btnCookbookAddSticky.onclick=()=> openDishFlow();

  // Kochbuch Action-Sheet: Bearbeiten, In Wochenplan, LÃ¶schen
  const cookbookActionEdit = document.getElementById('cookbookActionEdit');
  const cookbookActionWeek = document.getElementById('cookbookActionWeek');
  const cookbookActionDelete = document.getElementById('cookbookActionDelete');
  if(cookbookActionEdit) cookbookActionEdit.onclick=()=>{
    const ent = window._cookbookActionEntry;
    if(ent){ closeCookbookActionSheet(); startWizard('cookbook', {editId: ent.id}); }
  };
  if(cookbookActionWeek) cookbookActionWeek.onclick=()=>{
    const ent = window._cookbookActionEntry;
    if(ent){ closeCookbookActionSheet(); startListingFlow({dishId: ent.id, source: 'weekplan', date: createFlowPreselectedDate || isoDate(new Date())}); }
  };
  if(cookbookActionDelete) cookbookActionDelete.onclick=()=>{
    const ent = window._cookbookActionEntry;
    if(!ent) return;
    if(confirm(`"${ent.dish}" wirklich lÃ¶schen?`)){
      const idx = cookbook.findIndex(c => c.id === ent.id);
      if(idx >= 0){ cookbook.splice(idx, 1); save(LS.cookbook, cookbook); renderCookbook(); showToast('Gericht gelÃ¶scht'); }
    }
    closeCookbookActionSheet();
  };

  const btnOpenWeekPlan = document.getElementById('btnOpenWeekPlan');
  if(btnOpenWeekPlan) btnOpenWeekPlan.style.display = 'none';
  const btnPickupsFaq = document.getElementById('btnPickupsFaq');
  if(btnPickupsFaq){
    btnPickupsFaq.onclick=()=>{
      showProviderProfile();
      const box = document.getElementById('provFaqBox');
      if(box) box.style.display = 'block';
    };
  }

  const btnEditOffer = document.getElementById('btnEditOffer');
  if(btnEditOffer){
    btnEditOffer.onclick=()=>{
      if(!activeProviderOfferId) return;
      closeProviderSheet();
      startListingFlow({editOfferId: activeProviderOfferId});
    };
  }
  // No-Limits: Toggle-Funktion fÃ¼r "Ausverkauft" / "Noch da"
  function toggleOfferSoldOut(offerId){
    const idx = offers.findIndex(x=>x.id===offerId);
    if(idx<0) return;
    const wasActive = offers[idx].active !== false;
    offers[idx].active = !wasActive;
    save(LS.offers, offers);
    
    // Toast-Feedback
    showToast(wasActive ? 'Als ausverkauft markiert' : 'Wieder verfÃ¼gbar', 2000);
    
    // Neu rendern
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
  }
  
  const btnToggleOffer = document.getElementById('btnToggleOffer');
  if(btnToggleOffer){
    btnToggleOffer.onclick=()=>{
      if(!activeProviderOfferId) return;
      toggleOfferSoldOut(activeProviderOfferId);
      closeProviderSheet();
    };
  }
  const btnShareOffer = document.getElementById('btnShareOffer');
  if(btnShareOffer){
    btnShareOffer.onclick=()=>{
      if(!activeProviderOfferId) return;
      const o = offers.find(x=>x.id===activeProviderOfferId);
      if(!o) return;
      shareOffer(o);
    };
  }
  const btnPrintOffer = document.getElementById('btnPrintOffer');
  if(btnPrintOffer){
    btnPrintOffer.onclick=()=>{
      if(!activeProviderOfferId) return;
      const o = offers.find(x=>x.id===activeProviderOfferId);
      if(!o) return;
      printOffer(o);
    };
  }

  const btnWeekBack = document.getElementById('btnWeekBack');
  if(btnWeekBack){
    btnWeekBack.onclick=()=> showProviderHome();
  }
  const btnWeekPdf = document.getElementById('btnWeekPdf');
  if(btnWeekPdf){
    btnWeekPdf.onclick=()=>{
      printWeekCard();
    };
  }
  
  // Wochenplan teilen
  const btnWeekShare = document.getElementById('btnWeekShare');
  if(btnWeekShare){
    btnWeekShare.onclick=()=>{
      shareWeekPlan();
    };
  }
  
  // Wochenplan teilen-Funktion
  function shareWeekPlan(){
    const profile = normalizeProviderProfile(provider.profile || {});
    const providerName = profile.name || provider.email || 'Anbieter';
    const providerAddr = buildAddress(profile) || '';
    
    // Alle Gerichte der Woche sammeln
    const weekOffers = [];
    for(let i=0; i<7; i++){
      const d = new Date();
      d.setDate(d.getDate() + i);
      const key = isoDate(d);
      const dayOffers = (week[key] || []).filter(x => x.providerId === providerId() && x.active !== false);
      dayOffers.forEach(entry => {
        const cb = cookbook.find(c => c.id === entry.cookbookId);
        weekOffers.push({
          day: fmtDay(new Date(key)),
          dish: cb?.dish || entry.dish || 'Gericht',
          price: cb?.price || 0
        });
      });
    }
    
    if(weekOffers.length === 0){
      showToast('Keine Gerichte zum Teilen');
      return;
    }
    
    const shareUrl = `${location.origin}${location.pathname}#provider/${providerId()}/week`;
    const shareText = `Schau mal, was es diese Woche bei ${providerName} gibt!\n\n${weekOffers.slice(0, 5).map(o => `â€¢ ${o.dish} - ${euro(o.price)}`).join('\n')}${weekOffers.length > 5 ? `\n... und ${weekOffers.length - 5} weitere` : ''}\n\n${shareUrl}`;
    
    if(navigator.share){
      navigator.share({
        title: `Wochenplan ${providerName}`,
        text: shareText,
        url: shareUrl
      }).then(() => {
        showToast('Wochenplan geteilt!');
      }).catch((err) => {
        if(err.name !== 'AbortError'){
          copyToClipboard(shareText);
          showToast('Link kopiert!');
        }
      });
    } else {
      copyToClipboard(shareText);
      showToast('Link kopiert!');
    }
  }
  
  // Tagesessen teilen-Funktion
  function shareTodayOffers(){
    const todayKey = isoDate(new Date());
    const profile = normalizeProviderProfile(provider.profile || {});
    const providerName = profile.name || provider.email || 'Anbieter';
    const mineToday = offers.filter(o => o.providerId === providerId() && o.day === todayKey && o.active !== false);
    
    if(mineToday.length === 0){
      showToast('Keine Gerichte fÃ¼r heute');
      return;
    }
    
    const shareUrl = `${location.origin}${location.pathname}#provider/${providerId()}/today`;
    const shareText = `Heute bei ${providerName}:\n\n${mineToday.map(o => `â€¢ ${o.dish || o.title || 'Gericht'} - ${euro(o.price || 0)}`).join('\n')}\n\n${shareUrl}`;
    
    if(navigator.share){
      navigator.share({
        title: `Heute bei ${providerName}`,
        text: shareText,
        url: shareUrl
      }).then(() => {
        showToast('Tagesessen geteilt!');
      }).catch((err) => {
        if(err.name !== 'AbortError'){
          copyToClipboard(shareText);
          showToast('Link kopiert!');
        }
      });
    } else {
      copyToClipboard(shareText);
      showToast('Link kopiert!');
    }
  }

  // Provider ID (for demo)
  function providerId(){
    // stable per email
    const e = provider.email || 'provider';
    return 'prov_' + btoa(unescape(encodeURIComponent(e))).slice(0,16);
  }

  // --- Cookbook ---
  function openCookbookActionSheet(entry){
    window._cookbookActionEntry = entry;
    const titleEl = document.getElementById('cookbookActionSheetTitle');
    if(titleEl) titleEl.textContent = entry.dish || 'Gericht';
    const bd = document.getElementById('cookbookActionSheetBd');
    const sheet = document.getElementById('cookbookActionSheet');
    if(bd) bd.style.display = 'block';
    if(sheet) sheet.style.display = 'block';
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }
  function closeCookbookActionSheet(){
    window._cookbookActionEntry = null;
    const bd = document.getElementById('cookbookActionSheetBd');
    const sheet = document.getElementById('cookbookActionSheet');
    if(bd) bd.style.display = 'none';
    if(sheet) sheet.style.display = 'none';
  }

  function renderCookbook(){
    const box = document.getElementById('cookbookList');
    const tabs = document.getElementById('cookbookTabs');
    const sortSelect = document.getElementById('cookbookSortSelect');
    const search = document.getElementById('cookbookSearch');
    if(!box) return;

    let updated = false;
    cookbook = cookbook.map(entry=>{
      const out = {...entry};
      if(!out.createdAt){ out.createdAt = Date.now(); updated = true; }
      if(out.lastUsed === undefined){ out.lastUsed = null; updated = true; }
      return out;
    });
    if(updated) save(LS.cookbook, cookbook);

    if(search){
      if(search.value !== cookbookQuery) search.value = cookbookQuery || '';
      search.oninput=()=>{ cookbookQuery = search.value; renderCookbook(); };
    }

    if(sortSelect){
      if(sortSelect.value !== cookbookSort) sortSelect.value = cookbookSort || 'recent';
      sortSelect.onchange=()=>{ cookbookSort = sortSelect.value; renderCookbook(); };
    }

    if(tabs){
      tabs.innerHTML='';
      [
        {id:'dishes', label:'Meine Gerichte'},
        {id:'drafts', label:'EntwÃ¼rfe'}
      ].forEach(t=>{
        const b=document.createElement('button');
        b.type='button';
        b.className=cookbookTab===t.id?' on':'';
        b.textContent=t.label;
        b.onclick=()=>{ cookbookTab=t.id; renderCookbook(); };
        tabs.appendChild(b);
      });
    }

    const mine = cookbook.filter(x=>x.providerId===providerId());
    const q = String(cookbookQuery||'').trim().toLowerCase();
    const filtered = mine.filter(x => !q || String(x.dish||'').toLowerCase().includes(q));

    if(!filtered.length){
      box.className='';
      box.innerHTML = `
        <div class="cookbook-empty" style="text-align:center; padding:48px 24px;">
          <div style="width:96px; height:96px; margin:0 auto 24px; background:rgba(255,215,0,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,215,0,0.2);">
            <i data-lucide="chef-hat" style="width:48px; height:48px; color:#FFD700;"></i>
          </div>
          <div style="font-weight:900; font-size:22px; color:#fff; margin-bottom:12px;">Noch leer hier?</div>
          <div style="font-size:16px; color:rgba(255,255,255,0.7); line-height:1.6; margin-bottom:32px; max-width:300px; margin-left:auto; margin-right:auto;">
            Starte jetzt deine Erfolgsgeschichte! Lege dein erstes Gericht an â€“ es dauert nur wenige Sekunden.
          </div>
          <button class="btn" type="button" id="btnCookbookEmptyAdd" style="width:100%; max-width:280px; margin:0 auto; min-height:56px; background:#FFD700; color:#334155; font-weight:800; border:none; border-radius:16px; display:flex; align-items:center; justify-content:center; gap:10px; box-shadow:0 8px 24px rgba(255,215,0,0.25);">
            <i data-lucide="plus" style="width:24px;height:24px;"></i>
            Jetzt Gericht anlegen
          </button>
        </div>
      `;
      const btnCookbookEmptyAdd = document.getElementById('btnCookbookEmptyAdd');
      if(btnCookbookEmptyAdd) btnCookbookEmptyAdd.onclick = () => openDishFlow();
      if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
      return;
    }

    const sortRecent = (a,b)=>(b.lastUsed||b.createdAt) - (a.lastUsed||a.createdAt);
    const sortAlpha = (a,b)=>String(a.dish||'').localeCompare(String(b.dish||''));
    const sortPriceAsc = (a,b)=>(Number(a.price||0) - Number(b.price||0));
    const sortPriceDesc = (a,b)=>(Number(b.price||0) - Number(a.price||0));
    const sortFn = cookbookSort==='alpha' ? sortAlpha : (cookbookSort==='priceAsc' ? sortPriceAsc : (cookbookSort==='priceDesc' ? sortPriceDesc : sortRecent));

    const dishes = filtered.filter(x=>x.lastUsed);
    const drafts = filtered.filter(x=>!x.lastUsed);
    dishes.sort(sortFn);
    drafts.sort(sortFn);

    const list = cookbookTab === 'drafts' ? drafts : dishes;
    const formatDayLabel = (iso)=>{
      if(!iso) return 'Neu';
      const d = new Date(iso);
      if(Number.isNaN(d.getTime())) return iso;
      const today = isoDate(new Date());
      const yesterday = isoDate(new Date(Date.now()-86400000));
      if(iso===today) return 'Heute';
      if(iso===yesterday) return 'Gestern';
      return d.toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit'});
    };

    const buildItem = (entry, isDraft)=>{
      const item=document.createElement('div');
      item.className='cookbook-item';
      const hasAbholnummer = !!entry.hasPickupCode;
      const hasMehrweg = !!(entry.reuse && entry.reuse.enabled);
      const imgEl = entry.photoData
        ? `<img class="cookbook-item-image" src="${esc(entry.photoData)}" alt="${esc(entry.dish)}" loading="lazy" />`
        : `<div class="cookbook-item-image" style="background:#e5e7eb; display:flex; align-items:center; justify-content:center;"><i data-lucide="utensils" style="width:36px; height:36px; color:#94a3b8;"></i></div>`;
      const categoryBadge = entry.category ? `<span class="cookbook-item-badge">${esc(entry.category)}</span>` : '';
      const lastUsedLabel = isDraft ? 'Entwurf' : ('Zuletzt am ' + esc(formatDayLabel(entry.lastUsed)));
      const lastPriceLabel = entry.price != null ? 'Letzter Preis: ' + euro(entry.price) : '';
      const allergens = (entry.allergens || []).slice(0, 5);
      const allergenStr = allergens.map(a => typeof a === 'string' ? (a.trim().split(/\s+/)[0] || '').slice(0, 2).toUpperCase() : '').filter(Boolean).join(' ') || 'â€“';
      const abholZusatz = hasAbholnummer ? '<div class="cookbook-item-abholzusatz">+ 0,89 â‚¬ Abholnummer</div>' : '';
      const pillarClass = (on) => on ? '' : ' pillar-gray';
      item.innerHTML = `
        <div class="cookbook-item-header">
          ${imgEl}
          <div class="cookbook-item-price-tag">${euro(entry.price||0)}</div>
          <button type="button" class="cookbook-item-menu" aria-label="Optionen">
            <i data-lucide="more-horizontal"></i>
          </button>
        </div>
        <div class="cookbook-item-pillars">
          <span title="Vor Ort"${pillarClass(true)}>ðŸ´</span>
          <span title="Abholnummer"${pillarClass(hasAbholnummer)}>ðŸ§¾</span>
          <span title="Mehrweg"${pillarClass(hasMehrweg)}>ðŸ”„</span>
        </div>
        <div class="cookbook-item-body">
          <div class="cookbook-item-title">${esc(entry.dish||'Gericht')}</div>
          <div class="cookbook-item-meta">
            ${categoryBadge}
            <span class="cookbook-item-info">${lastUsedLabel}</span>
          </div>
          <div class="cookbook-item-allergens">${esc(allergenStr)}</div>
          ${lastPriceLabel ? '<div class="cookbook-item-info">' + esc(lastPriceLabel) + '</div>' : ''}
          <div class="cookbook-item-cta-wrap">
            ${abholZusatz}
            <button type="button" class="cookbook-item-btn" data-dish-id="${esc(entry.id)}">
              Jetzt fÃ¼r 4,99 â‚¬ inserieren
            </button>
          </div>
        </div>
      `;
      const menuBtn = item.querySelector('.cookbook-item-menu');
      if(menuBtn){
        const ent = entry;
        menuBtn.onclick = (e)=>{ e.stopPropagation(); openCookbookActionSheet(ent); };
      }
      const insertBtn = item.querySelector('.cookbook-item-btn');
      if(insertBtn) insertBtn.onclick = ()=>{ startListingFlow({dishId: entry.id, date: createFlowPreselectedDate || isoDate(new Date())}); };
      item.style.cursor = 'pointer';
      item.onclick = (e)=>{ if(!e.target.closest('.cookbook-item-menu') && !e.target.closest('.cookbook-item-btn')) insertBtn && insertBtn.click(); };
      return item;
    };

    box.className='cookbook-grid';
    box.innerHTML = '';
    if(!list.length){
      box.innerHTML = `<div class="cookbook-empty hint" style="grid-column:1/-1; text-align:center; padding:32px 16px; color:#64748b; font-size:15px;">In dieser Ansicht sind noch keine ${cookbookTab==='drafts' ? 'EntwÃ¼rfe' : 'Gerichte'}.</div>`;
      if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
      return;
    }
    list.forEach(entry=> box.appendChild(buildItem(entry, cookbookTab==='drafts')));
    if(typeof lucide !== 'undefined') setTimeout(() => lucide.createIcons(), 50);
  }

  function publishCookbookEntry(entryId){
    const entry = cookbook.find(c=>c.id===entryId && c.providerId===providerId());
    if(!entry) return;

    const profile = normalizeProviderProfile(provider.profile || {});
    const offer = normalizeOffer({
      id: cryptoId(),
      providerId: providerId(),
      providerName: profile.name || provider.email || 'Anbieter',
      providerStreet: profile.street||'',
      providerZip: profile.zip||'',
      providerCity: profile.city||'',
      providerLogoData: profile.logoData||'',
      dish: entry.dish||'',
      category: entry.category||'Vegetarisch',
      price: Number(entry.price||0),
      pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
      hasPickupCode: !!entry.hasPickupCode,
      dineInPossible: !!entry.dineInPossible,
      allergens: entry.allergens||[],
      extras: entry.extras||[],
      reuse: entry.reuse||{enabled:false,deposit:0},
      imageUrl: entry.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
      day: isoDate(new Date())
    });

    if(!offer.providerStreet){
      alert('Bitte zuerst Anbieterprofil ausfÃ¼llen (Adresse).');
      return;
    }

    offers.unshift(offer);
    save(LS.offers, offers);

    const idx = cookbook.findIndex(c=>c.id===entryId);
    if(idx>=0){ cookbook[idx].lastUsed = Date.now(); }
    save(LS.cookbook, cookbook);

    renderCookbook();
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
    renderStart();
    alert('Inserat verÃ¶ffentlicht.');
  }

  function publishWeekEntry(dayKey, entry){
    const cb = cookbook.find(c=>c.id===entry.cookbookId);
    if(!cb){
      alert('Gericht nicht gefunden.');
      return;
    }

    const profile = normalizeProviderProfile(provider.profile || {});
    const offer = normalizeOffer({
      id: cryptoId(),
      providerId: providerId(),
      providerName: profile.name || provider.email || 'Anbieter',
      providerStreet: profile.street||'',
      providerZip: profile.zip||'',
      providerCity: profile.city||'',
      providerLogoData: profile.logoData||'',
      dish: cb.dish||entry.dish||'',
      category: cb.category||'Vegetarisch',
      price: Number(cb.price||0),
      pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
      hasPickupCode: !!cb.hasPickupCode,
      dineInPossible: !!cb.dineInPossible,
      allergens: cb.allergens||[],
      extras: cb.extras||[],
      reuse: cb.reuse||{enabled:false,deposit:0},
      imageUrl: cb.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
      day: dayKey
    });

    if(!offer.providerStreet){
      alert('Bitte zuerst Anbieterprofil ausfÃ¼llen (Adresse).');
      return;
    }

    offers.unshift(offer);
    save(LS.offers, offers);

    const idx = cookbook.findIndex(c=>c.id===entry.cookbookId);
    if(idx>=0){ cookbook[idx].lastUsed = Date.now(); }
    save(LS.cookbook, cookbook);

    renderWeekPlan();
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
    renderStart();
    alert('Inserat verÃ¶ffentlicht.');
  }

  // --- Wizard engine (Provider profile / Listing / Cookbook / Week) ---
  let w = { kind:null, step:0, data:{}, ctx:{} };
  let publishFeePendingOffer = null;

  const ALLERGENS_14 = [
    {name:'Gluten', short:'GL'},
    {name:'Krebstiere', short:'KR'},
    {name:'Eier', short:'EI'},
    {name:'Fisch', short:'FI'},
    {name:'ErdnÃ¼sse', short:'EN'},
    {name:'Soja', short:'SO'},
    {name:'Milch', short:'MI'},
    {name:'SchalenfrÃ¼chte', short:'SF'},
    {name:'Sellerie', short:'SE'},
    {name:'Senf', short:'SN'},
    {name:'Sesam', short:'SS'},
    {name:'Sulfite', short:'SU'},
    {name:'Lupinen', short:'LU'},
    {name:'Weichtiere', short:'WE'}
  ];

  function openWizard(){
    const wbd = document.getElementById('wbd');
    const wizard = document.getElementById('wizard');
    if(wbd) wbd.classList.add('active');
    if(wizard) wizard.classList.add('active');
    pushViewState({wizard: true}, location.pathname);
  }
  function closeWizard(){
    const wizard = document.getElementById('wizard');
    document.getElementById('wbd').classList.remove('active');
    if(wizard){ wizard.classList.remove('active'); wizard.removeAttribute('data-flow'); }
  }

  /**
   * UNIFIED DISH FLOW - Zentrale Funktion fÃ¼r alle Inserats-Buttons
   * Egal ob "Schnellschuss" fÃ¼r heute oder Wochenplan - immer derselbe Flow!
   * 
   * @param {string} [defaultDate] - Preselected date (ISO format, z.B. "2026-01-26")
   *                                  Wenn null/undefined: Heute
   *                                  Wenn vom Wochenplan: GewÃ¤hlter Tag
   */
  function openDishFlow(defaultDate = null){
    // CRITICAL FIX: openDishFlow sollte startListingFlow verwenden fÃ¼r konsistenten Inseratsflow
    startListingFlow({date: defaultDate || isoDate(new Date())});
    return;
    // Normalisiere Datum: null/undefined = Heute
    const date = defaultDate || isoDate(new Date());
    
    // Ã–ffne Master-Flow mit Datum
    startListingFlow({date: date});
  }
  
  /**
   * MASTER INSERATSFLOW - Einziger Entry-Point
   * Wird IMMER verwendet fÃ¼r:
   * - Inserat erstellen
   * - Gericht hinzufÃ¼gen (Kochbuch)
   * - Gericht hinzufÃ¼gen (Wochenplan)
   * KEINE Sonderflows bauen!
   * 
   * @param {Object} context
   * @param {string} [context.source] - "cookbook" | "new" | undefined
   * @param {string} [context.dishId] - Kochbuch-Eintrag ID (wenn aus Kochbuch)
   * @param {string} [context.date] - Preselected date (ISO format)
   * @param {string} [context.editOfferId] - Offer ID (wenn bearbeiten)
   */
  function startListingFlow(context = {}){
    // Always use listing wizard (Master Flow)
    startWizard('listing', context);
  }

  function startWizard(kind, ctx={}){
    w = { kind, step:0, data:{}, ctx };
    const wizardEl = document.getElementById('wizard');
    if(wizardEl) wizardEl.setAttribute('data-flow', kind === 'listing' ? 'listing' : (kind || ''));

    if(kind==='provider'){
      w.data = normalizeProviderProfile(JSON.parse(JSON.stringify(provider.profile||{})));
      buildProviderStep();
    }
    if(kind==='cookbook'){
      // Cookbook editing only (not for creating new dishes)
      // For creating new dishes, use startListingFlow() instead
      if(ctx.editId){
        const existing = cookbook.find(c=>c.id===ctx.editId);
        if(existing){ w.data = JSON.parse(JSON.stringify(existing)); }
      }
      if(!w.data || !w.data.providerId){
        w.data = {
          providerId: providerId(),
          dish:'', category:'Vegetarisch', price:0,
          allergens:[],
          extras:[],
          reuse:{enabled:false, deposit:0},
          photoData:'',
          hasPickupCode:false,
          dineInPossible:false,
          createdAt: Date.now(),
          lastUsed: null
        };
      }
      w.data.providerId = providerId();
      w.data.category = w.data.category || 'Vegetarisch';
      w.data.price = Number(w.data.price||0);
      w.data.allergens = Array.isArray(w.data.allergens) ? w.data.allergens : [];
      w.data.extras = Array.isArray(w.data.extras) ? w.data.extras : [];
      if(!w.data.reuse) w.data.reuse = {enabled:false, deposit:0};
      w.data.photoData = w.data.photoData || '';
      w.data.hasPickupCode = !!w.data.hasPickupCode;
      w.data.dineInPossible = !!w.data.dineInPossible;
      w.data.createdAt = w.data.createdAt || Date.now();
      if(w.data.lastUsed === undefined) w.data.lastUsed = null;
      buildCookbookStep();
    }
    if(kind==='listing'){
      // MASTER INSERATSFLOW - Always the same flow
      const profile = normalizeProviderProfile(provider.profile || {});
      
      // Case 1: Edit existing offer
      if(ctx.editOfferId){
        const existing = offers.find(o=>o.id===ctx.editOfferId);
        if(existing){
          const o = normalizeOffer(existing);
          w.data = {
            providerId: o.providerId || providerId(),
            dish: o.dish||'',
            category: o.category||'Vegetarisch',
            price: Number(o.price||0),
            pickupWindow: o.pickupWindow || profile.mealWindow || DEFAULT_MEAL_WINDOW,
            hasPickupCode: !!o.hasPickupCode,
            dineInPossible: !!o.dineInPossible,
            allergens: Array.isArray(o.allergens) ? [...o.allergens] : [],
            wantsAllergens: !!(o.allergens && Array.isArray(o.allergens) && o.allergens.length > 0),
            extras: Array.isArray(o.extras) ? JSON.parse(JSON.stringify(o.extras)) : [],
            reuse: o.reuse ? JSON.parse(JSON.stringify(o.reuse)) : {enabled:false, deposit:0},
            photoData: o.imageUrl || '',
            photoDataIsStandard: !!o.photoDataIsStandard,
            day: o.day,
            active: o.active !== false,
            cookbookId: null
          };
        }
      } 
      // Case 2: From cookbook (context.dishId or ctx.fromCookbookId)
      else if(ctx.dishId || ctx.fromCookbookId){
        const cookbookId = ctx.dishId || ctx.fromCookbookId;
        const x = cookbook.find(c=>c.id===cookbookId);
        if(x){
          // Prefill from cookbook entry â€“ Abholnummer: Profil-Default wenn im Kochbuch nicht gesetzt
          const globalReuseEnabled = profile.reuseEnabledByDefault || false;
          const defaultAbholnummer = !!profile.abholnummerEnabledByDefault;
          w.data = {
            providerId: providerId(),
            dish: x.dish || '',
            category: x.category || 'Vegetarisch',
            price: Number(x.price||0),
            pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
            hasPickupCode: x.hasPickupCode !== undefined ? !!x.hasPickupCode : defaultAbholnummer,
            dineInPossible: x.dineInPossible !== undefined ? !!x.dineInPossible : true,
            allergens: Array.isArray(x.allergens) ? [...x.allergens] : [],
            wantsAllergens: !!(x.allergens && Array.isArray(x.allergens) && x.allergens.length > 0),
            extras: Array.isArray(x.extras) ? JSON.parse(JSON.stringify(x.extras)) : [],
            reuse: x.reuse ? JSON.parse(JSON.stringify(x.reuse)) : {enabled:globalReuseEnabled, deposit:globalReuseEnabled ? 2 : 0},
            photoData: x.photoData || '',
            cookbookId: x.id,
            day: ctx.date || createFlowPreselectedDate || isoDate(new Date())
          };
        } else {
          const globalReuseEnabled = profile.reuseEnabledByDefault || false;
          w.data = {
            providerId: providerId(),
            dish:'', category:'Vegetarisch', price:0,
            pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
            hasPickupCode: !!profile.abholnummerEnabledByDefault,
            dineInPossible: true,
            allergens:[],
            wantsAllergens: false,
            extras:[],
            reuse:{enabled:globalReuseEnabled, deposit:globalReuseEnabled ? 2 : 0},
            photoData:'',
            cookbookId:null,
            day: ctx.date || createFlowPreselectedDate || isoDate(new Date())
          };
        }
      } 
      // Case 3: New dish (default) - Spec: Vor Ort immer, Abholnummer default ON
      else {
        const globalReuseEnabled = profile.reuseEnabledByDefault || false;
        w.data = {
          providerId: providerId(),
          dish:'', category:'Vegetarisch', price:0,
          pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
          hasPickupCode:true,
          dineInPossible:true,
          allergens:[],
          wantsAllergens: false,
          extras:[],
          reuse:{enabled:globalReuseEnabled, deposit:globalReuseEnabled ? 2 : 0},
          photoData:'',
          cookbookId:null,
          day: ctx.date || createFlowPreselectedDate || isoDate(new Date())
        };
      }
      
      // Normalize data
      w.data.providerId = w.data.providerId || providerId();
      w.data.category = w.data.category || 'Vegetarisch';
      w.data.price = Number(w.data.price||0);
      w.data.pickupWindow = w.data.pickupWindow || profile.mealWindow || DEFAULT_MEAL_WINDOW;
      w.data.cookbookId = w.data.cookbookId || null;
      // Date preselect support
      if(ctx.date || createFlowPreselectedDate){
        w.data.day = ctx.date || createFlowPreselectedDate;
      } else if(!w.data.day){
        w.data.day = isoDate(new Date());
      }
      w.data.hasPickupCode = !!w.data.hasPickupCode;
      w.data.dineInPossible = !!w.data.dineInPossible;
      w.data.allergens = Array.isArray(w.data.allergens) ? w.data.allergens : [];
      if(w.data.wantsAllergens === undefined) w.data.wantsAllergens = !!(w.data.allergens && w.data.allergens.length > 0);
      w.data.extras = Array.isArray(w.data.extras) ? w.data.extras : [];
      // Mehrweg: Verwende globale Einstellung wenn nicht gesetzt
      if(!w.data.reuse || (!w.data.reuse.enabled && !profile.reuseEnabledByDefault)){
        const globalReuseEnabled = profile.reuseEnabledByDefault || false;
        w.data.reuse = {enabled:globalReuseEnabled, deposit:globalReuseEnabled ? 2 : 0};
      }
      buildListingStep();
    }
    if(kind==='week'){
      // Cookbook-Eintrag fÃ¼r Datum planen
      // Should use startListingFlow({dishId, date}) instead
      const x = cookbook.find(c=>c.id===ctx.fromCookbookId);
      if(!x){ alert('Bitte erst ein Gericht im Kochbuch speichern.'); return; }
      w.data = { cookbookId:x.id, date: isoDate(new Date()) };
      buildWeekStep();
    }

    openWizard();
  }

  // Common wizard buttons
  const wBackBtn = document.getElementById('wBack');
  const wNextBtn = document.getElementById('wNext');
  const defaultWizardNext = ()=>{ w.step += 1; rebuildWizard(); };
  function setWizardNextDefault(){ wNextBtn.onclick = defaultWizardNext; }

  wBackBtn.onclick=()=>{
    if(w.step===0){ closeWizard(); return; }
    w.step -= 1;
    rebuildWizard();
  };
  setWizardNextDefault();

  function setWizardHeader(title, stepText){
    const titleEl = document.getElementById('wTitle');
    const stepEl = document.getElementById('wStep');
    if(titleEl) titleEl.textContent = title;
    if(stepEl) stepEl.textContent = stepText;
    const dotsEl = document.getElementById('wizardProgressDots');
    if(dotsEl){
      const m = String(stepText).match(/Schritt\s*(\d+)\s*von\s*(\d+)|(\d+)\/(\d+)/);
      const step = m ? parseInt(m[1] || m[3], 10) : 1;
      const total = m ? parseInt(m[2] || m[4], 10) : 5;
      dotsEl.innerHTML = '';
      for(let i = 0; i < total; i++){
        const dot = document.createElement('span');
        dot.className = 'wizard-dot' + (i < step ? ' active' : '');
        dot.setAttribute('aria-hidden', 'true');
        dotsEl.appendChild(dot);
      }
    }
  }
  function setWizardQuestion(q, help=''){ 
    document.getElementById('wQ').textContent = q;
    document.getElementById('wHelp').textContent = help;
  }
  function setWizardContent(node){
    const c = document.getElementById('wContent');
    c.innerHTML='';
    c.appendChild(node);
  }

  function rebuildWizard(){
    if(w.kind==='provider') return buildProviderStep();
    if(w.kind==='cookbook') return buildCookbookStep();
    if(w.kind==='listing') return buildListingStep();
    if(w.kind==='week') return buildWeekStep();
  }

  function saveProviderProfileFromWizard(){
    const parsed = parseAddress(w.data.address || '');
    const street = parsed.street || w.data.street || '';
    const zip = parsed.zip || w.data.zip || '';
    const city = parsed.city || w.data.city || '';
    const address = parsed.address || buildAddress({street, zip, city});

    provider.profile = {
      name: w.data.name||'',
      address,
      street,
      zip,
      city,
      mealWindow: w.data.mealWindow || DEFAULT_MEAL_WINDOW,
      mealStart: w.data.mealStart || '11:30',
      mealEnd: w.data.mealEnd || '14:00',
      lunchWeekdays: Array.isArray(w.data.lunchWeekdays) ? w.data.lunchWeekdays : [1,2,3,4,5],
      phone: w.data.phone||'',
      email: w.data.email||'',
      website: w.data.website||'',
      logoData: w.data.logoData||'',
      reuseEnabledByDefault: !!w.data.reuseEnabledByDefault,
      abholnummerEnabledByDefault: !!w.data.abholnummerEnabledByDefault
    };
    save(LS.provider, provider);
    renderProviderProfile();
    renderProviderHome();
  }

  // --- Provider onboarding (step-by-step, no form) ---
  function buildProviderStep(){
    setWizardNextDefault();
    const total = 5;
    const stepText = `Schritt ${Math.min(w.step+1,total)} von ${total}`;
    setWizardHeader('Anbieter-Profil', stepText);

    if(w.step >= total){
      saveProviderProfileFromWizard();
      closeWizard();
      alert('Profil ist bereit.');
      return;
    }

    if(w.step===0){
      setWizardQuestion('Wie heiÃŸt dein Betrieb?', 'Du kannst den Namen jederzeit Ã¤ndern.');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field';
      input.placeholder='z.B. Metzgerei MÃ¼ller';
      input.value = w.data.name || '';
      input.oninput=()=>{ w.data.name=input.value; };
      box.appendChild(input);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===1){
      setWizardQuestion('Adresse deines Betriebs?', 'Auto-VervollstÃ¤ndigung folgt (Demo).');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field';
      input.placeholder='Musterstrasse 12, 73614 Schorndorf';
      input.value = w.data.address || buildAddress(w.data) || '';
      input.oninput=()=>{ w.data.address=input.value; };
      box.appendChild(input);
      const h=document.createElement('div'); h.className='hint'; h.textContent='Tipp: StraÃŸe, PLZ, Ort - getrennt mit Komma.';
      box.appendChild(h);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===2){
      setWizardQuestion('Wann kÃ¶nnen GÃ¤ste dein Essen genieÃŸen?', 'Standard aus Profil, optional anpassen.');
      if(!w.data.mealWindow) w.data.mealWindow = DEFAULT_MEAL_WINDOW;

      const current = w.data.mealWindow || DEFAULT_MEAL_WINDOW;
      const split = current.includes('â€“') ? current.split('â€“') : current.split('-');
      const startDefault = split[0] ? split[0].trim() : '11:30';
      const endDefault = split[1] ? split[1].trim() : '14:00';
      if(!w.data.mealStart) w.data.mealStart = startDefault;
      if(!w.data.mealEnd) w.data.mealEnd = endDefault;

      const box=document.createElement('div');
      const summary=document.createElement('div');
      summary.className='panel';
      summary.innerHTML = `<b>${esc(current)}</b><div class="hint">Standard aus Profil</div>`;
      box.appendChild(summary);

      const actions=document.createElement('div');
      actions.className='answers';
      const toggle=document.createElement('button');
      toggle.type='button';
      toggle.className='ans';
      toggle.textContent = w.data.mealCustom ? 'Fertig' : 'Essenszeit Ã¤ndern';
      toggle.onclick=()=>{
        w.data.mealCustom = !w.data.mealCustom;
        rebuildWizard();
      };
      actions.appendChild(toggle);
      box.appendChild(actions);

      if(w.data.mealCustom){
        const updateMealWindow = ()=>{
          if(w.data.mealStart && w.data.mealEnd){
            w.data.mealWindow = `${w.data.mealStart} â€“ ${w.data.mealEnd}`;
          }
        };

        const startLabel=document.createElement('div'); startLabel.className='hint'; startLabel.textContent='Start';
        const startRow=document.createElement('div'); startRow.className='answers';
        ['10:30','11:00','11:30','12:00'].forEach(t=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.mealStart===t?' on':'');
          b.textContent=t;
          b.onclick=()=>{ w.data.mealStart=t; updateMealWindow(); rebuildWizard(); };
          startRow.appendChild(b);
        });

        const endLabel=document.createElement('div'); endLabel.className='hint'; endLabel.textContent='Ende';
        const endRow=document.createElement('div'); endRow.className='answers';
        ['13:00','13:30','14:00','14:30'].forEach(t=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.mealEnd===t?' on':'');
          b.textContent=t;
          b.onclick=()=>{ w.data.mealEnd=t; updateMealWindow(); rebuildWizard(); };
          endRow.appendChild(b);
        });

        box.appendChild(document.createElement('div')).style.height='10px';
        box.appendChild(startLabel);
        box.appendChild(startRow);
        box.appendChild(document.createElement('div')).style.height='8px';
        box.appendChild(endLabel);
        box.appendChild(endRow);
      }

      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===3){
      setWizardQuestion('Logo hochladen?', 'Optional, spÃ¤ter jederzeit austauschbar.');
      const wrap = document.createElement('div');
      const btns=document.createElement('div');
      btns.className='answers';

      const up=document.createElement('button');
      up.className='ans';
      up.type='button';
      up.textContent='Logo auswÃ¤hlen';
      up.onclick=async()=>{
        const file = await pickImage();
        if(!file) return;
        w.data.logoData = await toDataUrl(file);
        rebuildWizard();
      };

      const skip=document.createElement('button');
      skip.className='ans';
      skip.type='button';
      skip.textContent='SpÃ¤ter';
      skip.onclick=()=>{ w.data.logoData=''; rebuildWizard(); };

      btns.appendChild(up);
      btns.appendChild(skip);
      wrap.appendChild(btns);

      if(w.data.logoData){
        const prev=document.createElement('div');
        prev.style.marginTop='10px';
        prev.innerHTML = `<div class="hint">Vorschau:</div><div class="plogo" style="width:60px;height:60px;border-radius:14px"><img src="${w.data.logoData}" alt="Logo" /></div>`;
        wrap.appendChild(prev);
      }

      setWizardContent(wrap);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===4){
      setWizardQuestion('Profil ist bereit', 'Kurz prÃ¼fen, dann loslegen.');
      const box=document.createElement('div');
      const addr = buildAddress(w.data);
      const logo = w.data.logoData ? `<img src="${w.data.logoData}" alt="Logo" />` : `<img src="assets/provider-placeholder.png" alt="Logo" />`;

      const summary=document.createElement('div');
      summary.className='panel';
      summary.innerHTML = `
        <div style="display:flex;gap:10px;align-items:center;">
          <div class="plogo" style="width:52px;height:52px;border-radius:14px">${logo}</div>
          <div>
            <div style="font-weight:950">${esc(w.data.name || 'Betrieb')}</div>
            <div class="hint">${esc(addr || 'Adresse fehlt')}</div>
          </div>
        </div>
        <div class="row"><span>Essenszeit</span><b>${esc(w.data.mealWindow || DEFAULT_MEAL_WINDOW)}</b></div>
      `;

      const cta=document.createElement('button');
      cta.className='btn';
      cta.type='button';
      cta.textContent='Erstes Gericht erstellen';
      cta.onclick=()=>{
        saveProviderProfileFromWizard();
        closeWizard();
        startWizard('listing');
      };

      box.appendChild(summary);
      box.appendChild(cta);
      setWizardContent(box);
      wNextBtn.textContent='Fertig';
      return;
    }
  }

  // --- Listing wizard (Punkt 6 final) ---
  function updateListingPreviewContent(target){
    target.innerHTML = '';
    const title = document.createElement('div');
    title.className = 'hint';
    title.textContent = 'So wirkt dein Inserat';
    target.appendChild(title);
    
    // Badge und Subline fÃ¼r Online-Zahlung + Abholnummer
    if(w.data.hasPickupCode){
      const badgeContainer = document.createElement('div');
      badgeContainer.className = 'listing-preview-badge';
      badgeContainer.style.cssText = 'margin-bottom:12px; padding:12px; background:rgba(16,185,129,0.1); border-radius:12px; border:1px solid var(--color-emerald,#10b981);';
      const badge = document.createElement('div');
      badge.style.cssText = 'font-weight:600; font-size:14px; color:var(--color-emerald,#10b981); margin-bottom:4px; display:flex; align-items:center; gap:6px;';
      badge.innerHTML = 'ðŸŸ¢ Online bezahlt Â· Abholung mit Abholnummer';
      const subline = document.createElement('div');
      subline.className = 'listing-preview-subline';
      subline.style.cssText = 'font-size:12px; color:#666;';
      subline.textContent = 'Zahlung lÃ¤uft direkt Ã¼ber Mittagio';
      badgeContainer.appendChild(badge);
      badgeContainer.appendChild(subline);
      target.appendChild(badgeContainer);
    }
    
    target.appendChild(offerCard(previewOfferFromWizard(), {interactive:false}));
    if(w.data.hasPickupCode){
      const note = document.createElement('div');
      note.className = 'mini';
      note.textContent = 'Beispiel-Abholnummer: A3';
      target.appendChild(note);
    }
  }

  function attachListingPreview(box){
    const wrap = document.createElement('div');
    wrap.id = 'listingPreview';
    wrap.style.marginTop = '12px';
    updateListingPreviewContent(wrap);
    box.appendChild(wrap);
  }

  function refreshListingPreview(){
    const wrap = document.getElementById('listingPreview');
    if(wrap){ updateListingPreviewContent(wrap); }
  }

  // ============================================================
  // MASTER INSERATSFLOW
  // Wird IMMER verwendet fÃ¼r:
  // - Inserat erstellen
  // - Gericht hinzufÃ¼gen (Kochbuch)
  // - Gericht hinzufÃ¼gen (Wochenplan)
  // KEINE Sonderflows bauen!
  // ============================================================
  function buildListingStep(){
    setWizardNextDefault();
    if(wNextBtn) wNextBtn.style.display = ''; // Weiter-Button sichtbar (Schritt 4 blendet ihn aus)
    const total = 5;
    setWizardHeader('Inserat erstellen', `Schritt ${Math.min(w.step+1,total)} von ${total}`);
    const profile = normalizeProviderProfile(provider.profile || {});
    if(!w.data.pickupWindow){ w.data.pickupWindow = profile.mealWindow || DEFAULT_MEAL_WINDOW; }
    w.data.dineInPossible = true;

    // Schritt 1: Basis (Quick-Input) â€“ Name, 3-Slot Bild, Abholzeit 11:30â€“14:00 (+/- 15min), Preis
    if(w.step===0){
      setWizardQuestion('Was kochst du heute?', 'Basis: Name, Bild, Zeit, Preis.');
      const box=document.createElement('div');
      const saveDraft = () => { localStorage.setItem('wizard_draft', JSON.stringify(w)); };

      // --- NAME + Autocomplete ---
      const labelName=document.createElement('div'); labelName.className='hint'; labelName.textContent='Gerichtname';
      box.appendChild(labelName);
      const input=document.createElement('input');
      input.className='field';
      input.placeholder='z.B. KÃ¼rbissuppe';
      input.value=w.data.dish||'';
      input.autocomplete='off';
      input.style.marginBottom='8px';
      const suggestWrap=document.createElement('div');
      suggestWrap.className='answers';
      suggestWrap.style.marginTop='6px'; suggestWrap.style.marginBottom='16px';
      function fillSuggestions(){
        suggestWrap.innerHTML='';
        const q=(input.value||'').trim();
        const list = typeof getDishSuggestionsSmartInput==='function' ? getDishSuggestionsSmartInput(q) : [];
        list.slice(0,6).forEach(s=>{
          const cat = (s.category==='Fleisch') ? 'Fleisch' : (s.category||'Vegetarisch');
          const b=document.createElement('button');
          b.type='button'; b.className='ans'; b.style.minHeight='44px';
          b.textContent=s.dish;
          b.onclick=()=>{ w.data.dish=s.dish; w.data.category=cat; if(s.allergens) w.data.allergens=[].concat(s.allergens||[]); saveDraft(); rebuildWizard(); };
          suggestWrap.appendChild(b);
        });
      }
      input.oninput=()=>{ w.data.dish=input.value; saveDraft(); fillSuggestions(); };
      input.onfocus=fillSuggestions;
      box.appendChild(input);
      box.appendChild(suggestWrap);

      // --- 3-Slot Bild: Kamera | Galerie | KI ---
      const labelImg=document.createElement('div'); labelImg.className='hint'; labelImg.textContent='Bild';
      box.appendChild(labelImg);
      const imgRow=document.createElement('div'); imgRow.className='answers'; imgRow.style.marginBottom='16px';
      ['ðŸ“· Kamera','ðŸ“¤ Galerie','ðŸ–¼ï¸ KI-VorschlÃ¤ge'].forEach((txt,i)=>{
        const btn=document.createElement('button');
        btn.type='button'; btn.className='ans'; btn.style.minHeight='44px';
        btn.textContent=txt;
        btn.onclick=async function(){
          if(i===0){ const f=await pickImage({capture:true}); if(!f) return; const dataUrl=await toDataUrl(f); w.data.photoData=dataUrl; w.data.photoDataIsStandard=false; }
          else if(i===1){ const f=await pickImage(); if(!f) return; const dataUrl=await toDataUrl(f); w.data.photoData=dataUrl; w.data.photoDataIsStandard=false; }
          else { const imgs=typeof getDishImagesForName==='function'?getDishImagesForName(w.data.dish||''):[]; if(imgs.length>0){ w.data.photoData=imgs[0]; w.data.photoDataIsStandard=true; } }
          saveDraft(); rebuildWizard();
        };
        imgRow.appendChild(btn);
      });
      box.appendChild(imgRow);
      if(w.data.photoData){
        const prev=document.createElement('div');
        prev.style.cssText='width:100%; height:80px; border-radius:12px; overflow:hidden; margin-bottom:16px; background:#f0f0f0;';
        prev.innerHTML='<img src="'+w.data.photoData+'" style="width:100%; height:100%; object-fit:cover;">';
        const rem=document.createElement('button');
        rem.type='button'; rem.textContent='Ã— Bild entfernen'; rem.style.cssText='font-size:12px; color:#64748b; background:none; border:none; margin-bottom:16px; cursor:pointer;';
        rem.onclick=()=>{ w.data.photoData=''; w.data.photoDataIsStandard=false; saveDraft(); rebuildWizard(); };
        box.appendChild(prev); box.appendChild(rem);
      }

      // --- Abholzeit: Standard 11:30 â€“ 14:00, +/- 15min (kein Abend) ---
      const labelTime=document.createElement('div'); labelTime.className='hint'; labelTime.textContent='Abholzeit (Mittagstisch)';
      box.appendChild(labelTime);
      const pw=(w.data.pickupWindow||DEFAULT_MEAL_WINDOW).split(/\s*[â€“\-]\s*/);
      let timeStart=(pw[0]||'11:30').trim(); let timeEnd=(pw[1]||'14:00').trim();
      if(timeStart.length===4) timeStart='0'+timeStart; if(timeEnd.length===4) timeEnd='0'+timeEnd;
      const timeRow=document.createElement('div');
      timeRow.style.cssText='display:flex; align-items:center; gap:12px; margin-bottom:16px;';
      const timeDisplay=document.createElement('span');
      timeDisplay.style.cssText='font-size:18px; font-weight:800; color:#1a1a1a; flex:1; text-align:center;';
      timeDisplay.textContent=timeStart+' â€“ '+timeEnd;
      function parseTime(s){ const [h,m]=s.split(':').map(Number); return (h||0)*60+(m||0); }
      function fmtTime(m){ const h=Math.floor(m/60), min=m%60; return (h<10?'0':'')+h+':'+(min<10?'0':'')+min; }
      const minusBtn=document.createElement('button');
      minusBtn.type='button'; minusBtn.className='btn secondary'; minusBtn.style.cssText='min-width:44px; min-height:44px;';
      minusBtn.textContent='âˆ’';
      minusBtn.onclick=()=>{
        let start=parseTime(timeStart), end=parseTime(timeEnd);
        if(end-start>15){ end-=15; w.data.pickupWindow=timeStart+' â€“ '+fmtTime(end); timeEnd=fmtTime(end); timeDisplay.textContent=timeStart+' â€“ '+timeEnd; saveDraft(); }
      };
      const plusBtn=document.createElement('button');
      plusBtn.type='button'; plusBtn.className='btn secondary'; plusBtn.style.cssText='min-width:44px; min-height:44px;';
      plusBtn.textContent='+';
      plusBtn.onclick=()=>{
        let start=parseTime(timeStart), end=parseTime(timeEnd);
        if(end<14*60&&end-start<4*60){ end+=15; w.data.pickupWindow=timeStart+' â€“ '+fmtTime(end); timeEnd=fmtTime(end); timeDisplay.textContent=timeStart+' â€“ '+timeEnd; saveDraft(); }
      };
      timeRow.appendChild(minusBtn); timeRow.appendChild(timeDisplay); timeRow.appendChild(plusBtn);
      box.appendChild(timeRow);

      // --- PREIS ---
      const labelPrice=document.createElement('div'); labelPrice.className='hint'; labelPrice.textContent='Preis (â‚¬)';
      box.appendChild(labelPrice);
      const inputPrice=document.createElement('input');
      inputPrice.className='field';
      inputPrice.type='number';
      inputPrice.step='0.10';
      inputPrice.inputmode='decimal';
      inputPrice.placeholder='z.B. 8,50';
      inputPrice.value=w.data.price>0?w.data.price:'';
      inputPrice.style.marginBottom='16px';
      inputPrice.oninput=()=>{ w.data.price=parseFloat(inputPrice.value.replace(',','.'))||0; saveDraft(); };
      box.appendChild(inputPrice);

      // --- KATEGORIE ---
      const labelCat=document.createElement('div'); labelCat.className='hint'; labelCat.textContent='Kategorie';
      box.appendChild(labelCat);
      const catRow=document.createElement('div'); catRow.className='answers';
      catRow.style.marginBottom='16px';
      ['Fleisch','Vegetarisch','Vegan'].forEach(c=>{
        const b=document.createElement('button');
        b.type='button'; b.className='ans'+(w.data.category===c?' on':''); b.style.minHeight='44px';
        b.textContent=c;
        b.onclick=()=>{ w.data.category=c; saveDraft(); rebuildWizard(); };
        catRow.appendChild(b);
      });
      box.appendChild(catRow);

      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      if(wBackBtn) wBackBtn.textContent='ZurÃ¼ck';
      return;
    }

    // Schritt 2: Service & Details â€“ Toggles Vor Ort (ðŸ´), Mehrweg (ðŸ”„), Allergene optional, Extra-Pills
    if(w.step===1){
      setWizardQuestion('Service & Details', 'Kann man bei dir vor Ort essen? Bietest du Mehrweg an?');
      const box=document.createElement('div');
      const saveDraft = () => { localStorage.setItem('wizard_draft', JSON.stringify(w)); };
      
      // Toggles Container (min 44px Tap-Targets)
      const toggleWrap = document.createElement('div');
      toggleWrap.style.cssText = 'display:flex; flex-direction:column; gap:12px; margin-bottom:24px;';
      
      // 1. Vor Ort (ðŸ´)
      const rowDine = document.createElement('div');
      rowDine.style.cssText = 'display:flex; align-items:center; justify-content:space-between; padding:14px 16px; min-height:44px; background:#f8f9fa; border-radius:12px;';
      rowDine.innerHTML = '<div style="font-weight:600;display:flex;align-items:center;gap:8px"><span style="font-size:18px;">ðŸ´</span> Kann man bei dir vor Ort essen?</div>';
      // Toggle Switch (simulated)
      const togDine = document.createElement('button');
      togDine.type='button';
      togDine.style.cssText = `width:44px; height:24px; border-radius:12px; background:${w.data.dineInPossible?'#10b981':'#e5e7eb'}; position:relative; border:none; transition:0.2s;`;
      togDine.innerHTML = `<div style="width:20px; height:20px; background:#fff; border-radius:50%; position:absolute; top:2px; left:${w.data.dineInPossible?'22px':'2px'}; transition:0.2s; box-shadow:0 1px 2px rgba(0,0,0,0.2);"></div>`;
      togDine.onclick = ()=>{ w.data.dineInPossible=!w.data.dineInPossible; saveDraft(); rebuildWizard(); };
      rowDine.appendChild(togDine);
      toggleWrap.appendChild(rowDine);

      // 2. Mehrweg (ðŸ”„)
      const rowReuse = document.createElement('div');
      rowReuse.style.cssText = 'display:flex; align-items:center; justify-content:space-between; padding:14px 16px; min-height:44px; background:#f8f9fa; border-radius:12px;';
      rowReuse.innerHTML = '<div style="font-weight:600;display:flex;align-items:center;gap:8px"><span style="font-size:18px;">ðŸ”„</span> Bietest du Mehrweg an?</div>';
      const togReuse = document.createElement('button');
      togReuse.type='button';
      togReuse.style.cssText = `width:44px; height:24px; border-radius:12px; background:${w.data.reuse.enabled?'#10b981':'#e5e7eb'}; position:relative; border:none; transition:0.2s;`;
      togReuse.innerHTML = `<div style="width:20px; height:20px; background:#fff; border-radius:50%; position:absolute; top:2px; left:${w.data.reuse.enabled?'22px':'2px'}; transition:0.2s; box-shadow:0 1px 2px rgba(0,0,0,0.2);"></div>`;
      togReuse.onclick = ()=>{ 
        w.data.reuse.enabled=!w.data.reuse.enabled; 
        if(w.data.reuse.enabled && !w.data.reuse.deposit) w.data.reuse.deposit=2; 
        saveDraft(); rebuildWizard(); 
      };
      rowReuse.appendChild(togReuse);
      toggleWrap.appendChild(rowReuse);
      
      box.appendChild(toggleWrap);

      // Allergene (optional)
      const labelAll=document.createElement('div'); labelAll.className='hint'; labelAll.textContent='Willst du Allergene angeben?';
      box.appendChild(labelAll);
      const allRow=document.createElement('div'); allRow.className='answers'; allRow.style.marginBottom='24px';
      const btnAllYes=document.createElement('button'); btnAllYes.className='ans'+(w.data.wantsAllergens?' on':''); btnAllYes.textContent='Ja';
      btnAllYes.onclick=()=>{ w.data.wantsAllergens=true; saveDraft(); rebuildWizard(); };
      const btnAllNo=document.createElement('button'); btnAllNo.className='ans'+(!w.data.wantsAllergens?' on':''); btnAllNo.textContent='Nein';
      btnAllNo.onclick=()=>{ w.data.wantsAllergens=false; w.data.allergens=[]; saveDraft(); rebuildWizard(); };
      allRow.appendChild(btnAllYes); allRow.appendChild(btnAllNo);
      box.appendChild(allRow);

      if(w.data.wantsAllergens){
        const allList=document.createElement('div');
        allList.innerHTML='<div class="hint" style="margin-bottom:8px">WÃ¤hle Allergene:</div>';
        const pills=document.createElement('div'); pills.className='answers';
        ALLERGENS_LIST.forEach(a=>{
          const active=w.data.allergens.includes(a.code);
          const p=document.createElement('button'); p.className='ans'+(active?' on':''); p.textContent=`${a.code} ${a.label}`;
          p.onclick=()=>{
            if(active) w.data.allergens=w.data.allergens.filter(x=>x!==a.code);
            else w.data.allergens.push(a.code);
            saveDraft(); rebuildWizard();
          };
          pills.appendChild(p);
        });
        allList.appendChild(pills);
        box.appendChild(allList);
      }

      // Extra-Pills (Beilagensalat, Extra Sauce, Brot, Ketchup, Mayo) + Verdienst-Vorschau
      if(!Array.isArray(w.data.extras)) w.data.extras=[];
      const hasExtras = w.data.extras.length > 0;
      const extLabel=document.createElement('div'); extLabel.className='hint'; extLabel.style.marginTop='16px'; extLabel.textContent='Extras (Aufpreis)';
      box.appendChild(extLabel);
      const extRow=document.createElement('div'); extRow.style.cssText='display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px;';
      ['Beilagensalat','Extra Sauce','Brot','Ketchup','Mayo'].forEach(name=>{
        const extra=w.data.extras.find(e=>e.name===name);
        const hasPrice=!!extra && Number(extra.price||0)>0;
        const b=document.createElement('button'); b.type='button'; b.style.cssText=`min-height:44px; padding:8px 12px; border-radius:8px; font-size:13px; font-weight:600; border:2px solid ${hasPrice?'var(--color-emerald,#10b981)':(extra?'#94a3b8':'#e5e7eb')}; background:${hasPrice?'rgba(16,185,129,0.12)':'#fff'}; color:${hasPrice?'var(--color-emerald,#10b981)':'#475569'};`;
        b.textContent=extra && extra.price ? name+' +'+Number(extra.price).toFixed(2).replace('.',',')+' â‚¬' : name;
        b.onclick=()=>{
          const idx=w.data.extras.findIndex(e=>e.name===name);
          if(idx>=0){ w.data.extras.splice(idx,1); rebuildWizard(); return; }
          const priceStr=prompt('Aufpreis in â‚¬ (z.B. 1,50):','0');
          const priceVal=parseFloat((priceStr||'0').replace(',','.'))||0;
          w.data.extras.push({name, price:priceVal});
          rebuildWizard();
        };
        extRow.appendChild(b);
      });
      box.appendChild(extRow);
      const verdienstEl=document.createElement('div');
      verdienstEl.id='listingVerdienstEl';
      verdienstEl.style.cssText='margin-top:12px; padding:12px; background:rgba(16,185,129,0.12); border-radius:12px; font-weight:700; font-size:14px; text-align:center; color:var(--color-emerald,#10b981);';
      function refreshVerdienstEl(){
        const el=document.getElementById('listingVerdienstEl');
        if(!el) return;
        const p=Number(w.data.price||0);
        const exSum=(w.data.extras||[]).reduce((s,e)=>s+Number(e.price||0),0);
        const nettoProVerkauf = p + exSum - (w.data.hasPickupCode ? ABHOLNUMMER_FEE : 0);
        el.innerHTML=`Verdienst pro Verkauf: <span style="font-size:16px;">${nettoProVerkauf.toFixed(2).replace('.',',')} â‚¬</span> (abzgl. 4,99 â‚¬ InseratsgebÃ¼hr einmalig)`;
      }
      verdienstEl.innerHTML='Verdienst pro Verkauf: â€“ (abzgl. 4,99 â‚¬ InseratsgebÃ¼hr einmalig)';
      box.appendChild(verdienstEl);
      setTimeout(refreshVerdienstEl, 0);

      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      if(typeof lucide!=='undefined') lucide.createIcons();
      return;
    }

    // Schritt 3: Vorschau (Erfolgsmoment) â€“ Discovery-Card wie Kunde sie sieht, ðŸ´ðŸ”„ðŸ§¾ unter Bild
    if(w.step===2){
      setWizardQuestion('So wirkt dein Inserat', 'Genau so sehen es deine GÃ¤ste.');
      const box=document.createElement('div');
      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      if(wBackBtn) wBackBtn.textContent='ZurÃ¼ck';
      if(typeof lucide!=='undefined') lucide.createIcons();
      return;
    }

    // Schritt 4: Entscheidung & Planung (3 Kacheln)
    if(w.step===3){
      setWizardQuestion('Wie mÃ¶chtest du starten?', 'VerÃ¶ffentliche sofort oder plane fÃ¼r spÃ¤ter.');
      const box=document.createElement('div');
      
      const grid = document.createElement('div');
      grid.style.cssText = 'display:grid; grid-template-columns:1fr; gap:16px; margin-top:16px;';

      // 1. Jetzt Inserieren (Primary)
      const tilePub = document.createElement('button');
      tilePub.className = 'btn'; // Primary
      tilePub.style.cssText = 'display:flex; flex-direction:column; align-items:center; justify-content:center; padding:24px; border-radius:20px; background:#FFD700; color:#1a1a1a; border:none; box-shadow:0 8px 20px rgba(255,215,0,0.2); transition:transform 0.1s;';
      tilePub.innerHTML = `
        <i data-lucide="rocket" style="width:32px; height:32px; margin-bottom:12px;"></i>
        <div style="font-size:18px; font-weight:900;">Jetzt fÃ¼r 4,99 â‚¬ inserieren</div>
        <div style="font-size:13px; font-weight:600; opacity:0.8; margin-top:4px;">FÃ¼hrt zum Checkout</div>
      `;
      tilePub.onclick = () => { w.step++; rebuildWizard(); }; // Go to Upsell
      grid.appendChild(tilePub);

      // 2. Kochbuch
      const tileCook = document.createElement('button');
      tileCook.className = 'btn secondary';
      tileCook.style.cssText = 'display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; border-radius:20px; border:2px solid #e5e7eb; background:#fff; color:#333;';
      tileCook.innerHTML = `
        <i data-lucide="book-open" style="width:28px; height:28px; margin-bottom:8px; color:#666;"></i>
        <div style="font-size:16px; font-weight:700;">Ins Kochbuch</div>
        <div style="font-size:12px; color:#999; margin-top:2px;">Speichern & spÃ¤ter nutzen</div>
      `;
      tileCook.onclick = () => { saveToCookbookFromWizard(); closeWizard(); showProviderCookbook(); };
      grid.appendChild(tileCook);

      // 3. Wochenplan
      const tileWeek = document.createElement('button');
      tileWeek.className = 'btn secondary';
      tileWeek.style.cssText = 'display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; border-radius:20px; border:2px solid #e5e7eb; background:#fff; color:#333;';
      tileWeek.innerHTML = `
        <i data-lucide="calendar" style="width:28px; height:28px; margin-bottom:8px; color:#666;"></i>
        <div style="font-size:16px; font-weight:700;">Wochenplan</div>
        <div style="font-size:12px; color:#999; margin-top:2px;">FÃ¼r einen anderen Tag</div>
      `;
      tileWeek.onclick = () => { saveToCookbookFromWizard(); closeWizard(); showProviderWeek(); };
      grid.appendChild(tileWeek);

      box.appendChild(grid);
      setWizardContent(box);
      wNextBtn.style.display = 'none'; // Hide default Next button
      if(typeof lucide!=='undefined') lucide.createIcons();
      return;
    }

    // Schritt 5: Abholnummer-Upsell & Checkout
    if(w.step===4){
      setWizardQuestion('Turbo-Modus aktivieren?', 'Abholnummern sparen Zeit und schaffen Ordnung.');
      const box=document.createElement('div');
      
      // Emotional Image
      const emoImg = document.createElement('div');
      emoImg.style.cssText = 'width:100%; height:160px; background:#f0f0f0; border-radius:16px; overflow:hidden; margin-bottom:20px; display:flex; align-items:center; justify-content:center; position:relative;';
      emoImg.innerHTML = '<img src="assets/icon-abholnummer.png" style="width:80px; opacity:0.8;">'; // Placeholder
      // Badge
      const badge = document.createElement('div');
      badge.style.cssText = 'position:absolute; top:12px; right:12px; background:var(--color-emerald,#10b981); color:#fff; padding:6px 12px; border-radius:20px; font-weight:700; font-size:12px; box-shadow:0 4px 12px rgba(16,185,129,0.3);';
      badge.textContent = 'Empfohlen';
      emoImg.appendChild(badge);
      box.appendChild(emoImg);

      // Benefits
      const benefits = document.createElement('div');
      benefits.style.cssText = 'display:flex; flex-direction:column; gap:12px; margin-bottom:24px;';
      ['Stressfrei: Kein Anstehen, kein Chaos', 'Speed: Schnelle Ausgabe per Nummer', 'Ordnung: Automatische Liste fÃ¼r die KÃ¼che'].forEach(t => {
        const row = document.createElement('div');
        row.style.cssText = 'display:flex; align-items:center; gap:10px; font-size:14px; color:#333; font-weight:500;';
        row.innerHTML = '<i data-lucide="check-circle-2" style="width:18px; color:var(--color-emerald,#10b981);"></i> ' + t;
        benefits.appendChild(row);
      });
      box.appendChild(benefits);

      // Options
      const btnYes = document.createElement('button');
      btnYes.className = 'btn-primary';
      btnYes.style.cssText = 'width:100%; min-height:56px; margin-bottom:12px; background:var(--color-emerald,#10b981); box-shadow:0 4px 16px rgba(16,185,129,0.3); font-size:16px; font-weight:700; border-radius:16px; border:none; color:#fff; display:flex; align-items:center; justify-content:center; gap:8px;';
      btnYes.innerHTML = '<span>Abholnummer fÃ¼r 0,89 â‚¬ hinzufÃ¼gen</span>';
      btnYes.onclick = () => {
        w.data.hasPickupCode = true;
        const o = previewOfferFromWizard();
        closeWizard();
        showPublishFeeModal(o);
      };
      
      const btnNo = document.createElement('button');
      btnNo.className = 'btn ghost';
      btnNo.style.cssText = 'width:100%; min-height:48px; font-size:14px; color:#666; font-weight:600; border-radius:12px;';
      btnNo.textContent = 'Ohne fortfahren';
      btnNo.onclick = () => {
        w.data.hasPickupCode = false;
        const o = previewOfferFromWizard();
        closeWizard();
        showPublishFeeModal(o);
      };

      box.appendChild(btnYes);
      box.appendChild(btnNo);

      setWizardContent(box);
      wNextBtn.style.display = 'none';
      if(typeof lucide!=='undefined') lucide.createIcons();
      return;
    }
  }

  function previewOfferFromWizard(){
    const p = normalizeProviderProfile(provider.profile||{});
    let pickupWindow = w.data.pickupWindow || p.mealWindow || DEFAULT_MEAL_WINDOW;
    if(w.data.mealStart && w.data.mealEnd) pickupWindow = w.data.mealStart + ' â€“ ' + w.data.mealEnd;
    return {
      id: 'preview',
      providerId: providerId(),
      providerName: p.name || provider.email || 'Anbieter',
      providerStreet: p.street||'',
      providerZip: p.zip||'',
      providerCity: p.city||'',
      providerLogoData: p.logoData||'',
      dish: w.data.dish||'Gericht',
      category: w.data.category||'Vegetarisch',
      price: Number(w.data.price||0),
      pickupWindow,
      imageUrl: w.data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
      photoDataIsStandard: !!w.data.photoDataIsStandard,
      hasPickupCode: !!w.data.hasPickupCode,
      dineInPossible: !!w.data.dineInPossible,
      allergens: w.data.allergens||[],
      extras: w.data.extras||[],
      reuse: w.data.reuse||{enabled:false,deposit:0},
      day: w.data.day || isoDate(new Date()),
      active: w.data.active !== false
    };
  }

  function publishOffer(o){
    const existingId = w.ctx && w.ctx.editOfferId ? w.ctx.editOfferId : null;
    const id = existingId || cryptoId();
    const out = {...o, id, day: o.day || w.data.day || isoDate(new Date()), active: o.active !== false};
    // ensure provider address exists
    if(!out.providerStreet){
      alert('Bitte zuerst Anbieterprofil ausfÃ¼llen (Adresse).');
      return null;
    }
    if(existingId){
      const idx = offers.findIndex(x=>x.id===existingId);
      if(idx>=0){
        const prev = offers[idx];
        offers[idx] = {...prev, ...out, id: prev.id, day: out.day, active: out.active};
      } else {
        offers.unshift(out);
      }
    } else {
      offers.unshift(out);
    }
    save(LS.offers, offers);
    
    // Reset createFlowPreselectedDate
    createFlowPreselectedDate = null;
    // restore default next button handler
    setWizardNextDefault();
    
    // Ostereier: Feuerwerk-Icon bei erstem Inserat
    const isFirstOffer = !existingId && offers.filter(x => x.providerId === providerId()).length === 1;
    if(isFirstOffer){
      showToast('ðŸŽ‰ Dein erstes Inserat ist live!', 4000);
    } else {
      showToast(existingId ? 'Inserat aktualisiert' : 'Inserat verÃ¶ffentlicht');
    }
    
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
    renderStart();
    return out;
  }

  function showPublishFeeModal(offer){
    publishFeePendingOffer = offer;
    const bd = document.getElementById('publishFeeBd');
    const sheet = document.getElementById('publishFeeSheet');
    if(bd) bd.style.display = 'block';
    if(sheet) sheet.style.display = 'block';
  }
  function closePublishFeeModal(){
    publishFeePendingOffer = null;
    const bd = document.getElementById('publishFeeBd');
    const sheet = document.getElementById('publishFeeSheet');
    if(bd) bd.style.display = 'none';
    if(sheet) sheet.style.display = 'none';
  }
  function showInseratSuccessSheet(publishedOffer){
    const d = normalizeOffer(publishedOffer);
    const dishNameEl = document.getElementById('inseratSuccessDishName');
    const nextCodeEl = document.getElementById('inseratSuccessNextCode');
    const nextBtnEl = document.getElementById('inseratSuccessBtnNext');
    const revenueEl = document.getElementById('inseratSuccessRevenue');
    const abholSection = document.getElementById('inseratSuccessAbholnummerSection');
    const todayKey = isoDate(new Date());
    const todayOrders = loadOrders().filter(o => {
      const offer = offers.find(off => off.id === o.dishId || (off.providerId === o.providerId && off.day === todayKey));
      return offer && offer.providerId === providerId() && o.status === 'PAID';
    });
    const tagesumsatzCents = todayOrders.reduce((sum, o) => sum + (o.totalCents || 0), 0);
    const tagesumsatzEuro = (tagesumsatzCents / 100).toFixed(2).replace('.', ',');
    if(dishNameEl) dishNameEl.textContent = d.dish || d.title || 'Gericht';
    if(nextCodeEl) nextCodeEl.textContent = '#' + (todayOrders.length + 1);
    if(nextBtnEl) nextBtnEl.textContent = 'NÃ¤chste: #' + (todayOrders.length + 2);
    if(revenueEl) revenueEl.textContent = '+ ' + tagesumsatzEuro + ' â‚¬';
    if(abholSection) abholSection.style.display = (d.hasPickupCode ? '' : 'none');
    const bd = document.getElementById('inseratSuccessBd');
    const sheet = document.getElementById('inseratSuccessSheet');
    if(bd) bd.style.display = 'block';
    if(sheet) sheet.style.display = 'block';
  }
  function closeInseratSuccessSheet(){
    const bd = document.getElementById('inseratSuccessBd');
    const sheet = document.getElementById('inseratSuccessSheet');
    if(bd) bd.style.display = 'none';
    if(sheet) sheet.style.display = 'none';
    showProviderHome();
  }
  (function wirePublishAndSuccessSheets(){
    const btnPublishConfirm = document.getElementById('btnPublishConfirm');
    if(btnPublishConfirm){
      btnPublishConfirm.onclick = function(){
        if(!publishFeePendingOffer) return;
        const published = publishOffer(publishFeePendingOffer);
        closePublishFeeModal();
        if(published) showInseratSuccessSheet(published);
      };
    }
    const inseratSuccessBtnBack = document.getElementById('inseratSuccessBtnBack');
    if(inseratSuccessBtnBack) inseratSuccessBtnBack.onclick = closeInseratSuccessSheet;
    const inseratSuccessBd = document.getElementById('inseratSuccessBd');
    if(inseratSuccessBd) inseratSuccessBd.onclick = closeInseratSuccessSheet;
    if(typeof window !== 'undefined'){
      window.closePublishFeeModal = closePublishFeeModal;
      window.closeInseratSuccessSheet = closeInseratSuccessSheet;
    }
  })();

  function saveToCookbookFromWizard(keepOpen=false){
    const now = Date.now();
    const base = {
      id: cryptoId(),
      providerId: providerId(),
      dish: w.data.dish||'',
      category: w.data.category||'Vegetarisch',
      price: Number(w.data.price||0),
      allergens: w.data.allergens||[],
      extras: w.data.extras||[],
      reuse: w.data.reuse||{enabled:false,deposit:0},
      photoData: w.data.photoData||'',
      hasPickupCode: !!w.data.hasPickupCode,
      dineInPossible: !!w.data.dineInPossible,
      createdAt: now,
      lastUsed: null
    };
    if(w.ctx && w.ctx.editId){
      const idx = cookbook.findIndex(c=>c.id===w.ctx.editId);
      if(idx>=0){
        const prev = cookbook[idx];
        cookbook[idx] = {
          ...prev,
          ...base,
          id: prev.id,
          createdAt: prev.createdAt || now,
          lastUsed: prev.lastUsed ?? null
        };
      } else {
        cookbook.push(base);
      }
    } else {
      cookbook.push(base);
    }
    save(LS.cookbook, cookbook);
    if(!keepOpen){ renderCookbook(); }
  }

  // Cookbook wizard (add recipe)
  function buildCookbookStep(){
    setWizardNextDefault();
    // reuse listing steps subset: category, photo, name, allergens, extras, reuse, price, preview/save
    const total = 8;
    setWizardHeader('Kochbuch', `${Math.min(w.step+1,total)}/${total}`);

    if(w.step===0){
      setWizardQuestion('Kategorie?', 'Tippe eine Kategorie.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      ['Vegan','Vegetarisch','Fleisch','Salat'].forEach(c=>{
        const b=document.createElement('button'); b.type='button'; b.className='ans'+(w.data.category===c?' on':''); b.textContent=c;
        b.onclick=()=>{ w.data.category=c; rebuildWizard(); };
        ans.appendChild(b);
      });
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===1){
      setWizardQuestion('Foto speichern?', 'Optional (fÃ¼r schnelleres Wiederverwenden).');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      const b1=document.createElement('button'); b1.type='button'; b1.className='ans'; b1.textContent='Foto auswÃ¤hlen';
      b1.onclick=async()=>{ const f=await pickImage(); if(!f) return; const dataUrl = await toDataUrl(f); await openPhotoEditor(dataUrl); };
      const b2=document.createElement('button'); b2.type='button'; b2.className='ans'; b2.textContent='Ohne';
      b2.onclick=()=>{ w.data.photoData=''; w.data.photoDataIsStandard=false; rebuildWizard(); };
      ans.appendChild(b1); ans.appendChild(b2);
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===2){
      setWizardQuestion('Gerichtname?', 'Wie im Kochbuch.');
      const box=document.createElement('div');
      const input=document.createElement('input'); input.className='field'; input.placeholder='z.B. Lasagne'; input.value=w.data.dish||'';
      input.oninput=()=>{ w.data.dish=input.value; };
      box.appendChild(input);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===3){
      setWizardQuestion('Allergene?', 'Optional, antippen.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      if(!Array.isArray(w.data.allergens)) w.data.allergens=[];
      ALLERGENS_14.forEach(a=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(w.data.allergens.includes(a.short)?' on':'');
        b.textContent=`${a.short} ${a.name}`;
        b.onclick=()=>{
          const i=w.data.allergens.indexOf(a.short);
          if(i>=0) w.data.allergens.splice(i,1); else w.data.allergens.push(a.short);
          rebuildWizard();
        };
        ans.appendChild(b);
      });
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===4){
      // Extras
      setWizardQuestion('Extras?', 'Optional.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(w.data.extras?.length?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!w.data.extras?.length?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.extras = w.data.extras?.length ? w.data.extras : [{name:'Beilagensalat', price:2.0}]; rebuildWizard(); };
      no.onclick=()=>{ w.data.extras=[]; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===5){
      // reuse
      setWizardQuestion('Mehrweg / Pfand?', 'Optional.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      if(!w.data.reuse) w.data.reuse={enabled:false,deposit:0};
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(w.data.reuse.enabled?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!w.data.reuse.enabled?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.reuse.enabled=true; if(!w.data.reuse.deposit) w.data.reuse.deposit=5; rebuildWizard(); };
      no.onclick=()=>{ w.data.reuse.enabled=false; w.data.reuse.deposit=0; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===6){
      setWizardQuestion('Standardpreis?', 'Nur Zahl - Komma nicht nÃ¶tig.');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field'; input.inputMode='numeric'; input.placeholder='z.B. 799';
      input.value = w.data.price ? String(Math.round(w.data.price*100)) : '';
      input.oninput=()=>{ w.data.price = smartNumberToEuro(input.value); };
      box.appendChild(input);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===7){
      setWizardQuestion('Speichern?', 'Damit du spÃ¤ter mit 2 Taps inserierst.');
      const box=document.createElement('div');
      const prev = {
        id:'preview',
        providerId:providerId(),
        providerName: provider.profile.name || provider.email || 'Anbieter',
        providerStreet:'',providerZip:'',providerCity:'',providerLogoData: provider.profile.logoData||'',
        dish:w.data.dish||'Gericht',
        category:w.data.category||'Vegetarisch',
        price:Number(w.data.price||0),
        pickupWindow:'',
        imageUrl: w.data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
        hasPickupCode:false,
        allergens:w.data.allergens||[],
        extras:w.data.extras||[],
        reuse:w.data.reuse||{enabled:false,deposit:0},
        day: isoDate(new Date())
      };
      box.appendChild(offerCard(prev, {interactive:false}));
      const btn=document.createElement('button');
      btn.className='btn';
      btn.type='button';
      btn.textContent = w.ctx && w.ctx.editId ? 'Ã„nderungen speichern' : 'Im Kochbuch speichern';
      btn.onclick=()=>{
        saveToCookbookFromWizard();
        closeWizard();
        renderCookbook();
        alert('Gespeichert.');
      };
      box.appendChild(btn);
      setWizardContent(box);
      wNextBtn.textContent='Fertig';
      wNextBtn.onclick=()=>{ closeWizard(); showProviderCookbook(); };
      return;
    }
  }

  // Weekplan wizard (simple date choose)
  function buildWeekStep(){
    setWizardNextDefault();
    setWizardHeader('Wochenplan', '1/1');
    setWizardQuestion('FÃ¼r welchen Tag?', 'WÃ¤hle einen Tag und fÃ¼ge das Gericht hinzu.');

    const box=document.createElement('div');
    const ans=document.createElement('div'); ans.className='answers';

    for(let i=0;i<5;i++){
      const d=new Date(); d.setDate(d.getDate()+i);
      const key=isoDate(d);
      const b=document.createElement('button');
      b.type='button';
      b.className='ans'+(w.data.date===key?' on':'');
      b.textContent = i===0?'Heute':(i===1?'Morgen':fmtDay(d));
      b.onclick=()=>{ w.data.date=key; rebuildWizard(); };
      ans.appendChild(b);
    }
    box.appendChild(ans);

    const btn=document.createElement('button');
    btn.className='btn';
    btn.type='button';
    btn.textContent='Zum Wochenplan hinzufÃ¼gen';
    btn.onclick=()=>{
      const cb = cookbook.find(c=>c.id===w.data.cookbookId);
      if(!cb){ alert('Gericht nicht gefunden'); return; }
      const entry = { providerId:providerId(), dish:cb.dish, cookbookId:cb.id, active:true };
      if(!week[w.data.date]) week[w.data.date]=[];
      week[w.data.date].push(entry);
      save(LS.week, week);
      
      // Automatisch als Angebot verÃ¶ffentlichen, damit Kunden es sehen
      publishWeekEntry(w.data.date, entry);
      
      closeWizard();
      renderProviderHome();
    };

    box.appendChild(document.createElement('div')).style.height='10px';
    box.appendChild(btn);

    setWizardContent(box);
    wNextBtn.textContent='Fertig';
    wNextBtn.onclick=()=>{ closeWizard(); showProviderHome(); };
  }

  // --- Input helpers (thumb-friendly) ---
  function formatPriceInput(value){
    const num = Number(value||0);
    return num.toFixed(2).replace('.',',');
  }
  function parsePriceInput(raw){
    const cleaned = String(raw||'').trim().replace(',', '.').replace(/[^0-9.]/g,'');
    const num = parseFloat(cleaned);
    if(Number.isNaN(num)) return 0;
    return Math.round(num*100)/100;
  }
  function smartNumberToEuro(raw){
    const digits = String(raw||'').replace(/\D/g,'');
    if(!digits) return 0;
    const cents = parseInt(digits,10);
    return Math.round((cents/100)*100)/100;
  }
  function smartNumber(raw){
    const digits = String(raw||'').replace(/\D/g,'');
    if(!digits) return 0;
    return parseInt(digits,10);
  }

  // Image picker
  function pickImage(opts={}){
    return new Promise(resolve=>{
      const input=document.createElement('input');
      input.type='file';
      input.accept='image/*';
      if(opts.capture) input.capture='environment';
      input.onchange=()=> resolve(input.files && input.files[0] ? input.files[0] : null);
      input.click();
    });
  }
  function toDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload=()=>resolve(r.result);
      r.onerror=reject;
      r.readAsDataURL(file);
    });
  }
  async function urlToDataUrl(url){
    try {
      const r = await fetch(url, { mode: 'cors' });
      const blob = await r.blob();
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(blob);
      });
    } catch (e) {
      // Fallback: Galerie/Bibliothek (Unsplash etc.) â€“ CORS oder fetch schlÃ¤gt fehl â†’ Bild per img + Canvas laden
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = function(){
          try {
            const canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            resolve(canvas.toDataURL('image/jpeg', 0.9));
          } catch (err) { reject(err); }
        };
        img.onerror = () => reject(new Error('Bild konnte nicht geladen werden'));
        img.src = url;
      });
    }
  }

  // Fotoeditor mit Filter & Zuschnitt
  // Foto-KI: Analysiert Foto mit GPT-4o Vision API
  async function analyzeFoodPhoto(imageDataUrl){
    try {
      // TODO: In Production: Echte GPT-4o Vision API Integration
      // Beispiel-Request:
      // const response = await fetch('https://api.openai.com/v1/chat/completions', {
      //   method: 'POST',
      //   headers: {
      //     'Authorization': `Bearer ${OPENAI_API_KEY}`,
      //     'Content-Type': 'application/json'
      //   },
      //   body: JSON.stringify({
      //     model: 'gpt-4o',
      //     messages: [{
      //       role: 'user',
      //       content: [
      //         { type: 'text', text: 'Analysiere dieses Food-Foto und extrahiere: Name des Gerichts, geschÃ¤tzter Preis in EUR, Hauptzutaten (Liste). Antworte im JSON-Format: {name, price, ingredients: []}. KEINE MengenschÃ¤tzungen oder Kalorien.' },
      //         { type: 'image_url', image_url: { url: imageDataUrl } }
      //       ]
      //     }]
      //   })
      // });
      // const data = await response.json();
      // return JSON.parse(data.choices[0].message.content);
      
      // Demo: Simuliere KI-Analyse (wird spÃ¤ter durch echte API ersetzt)
      await new Promise(resolve => setTimeout(resolve, 1500)); // Simuliere API-Latenz
      
      // Mock-Daten basierend auf hÃ¤ufigsten Gerichten
      const mockAnalysis = {
        name: 'Schnitzel mit Pommes',
        price: 8.50,
        ingredients: ['Schweinefleisch', 'Eier', 'Mehl', 'SemmelbrÃ¶sel', 'Kartoffeln', 'Ã–l'],
        calories: 650
      };
      
      return mockAnalysis;
    } catch(err){
      console.error('Foto-KI Fehler:', err);
      return null;
    }
  }
  
  // Auto-Tagging: Vergleicht Zutaten mit 14 Hauptallergenen
  function tagAllergensFromIngredients(ingredients){
    const allergenMap = {
      'A': ['gluten', 'weizen', 'roggen', 'gerste', 'hafer', 'dinkel'],
      'B': ['krebstiere', 'krebs', 'garnelen', 'shrimps'],
      'C': ['eier', 'ei', 'eigelb', 'eiweiÃŸ'],
      'D': ['fisch', 'lachs', 'thunfisch', 'forelle'],
      'E': ['erdnÃ¼sse', 'erdnuss'],
      'F': ['soja', 'sojabohnen', 'tofu'],
      'G': ['milch', 'milchprodukte', 'kÃ¤se', 'butter', 'sahne', 'joghurt'],
      'H': ['schalenfrÃ¼chte', 'mandeln', 'haselnÃ¼sse', 'walnÃ¼sse', 'cashew'],
      'I': ['sellerie'],
      'J': ['senf'],
      'K': ['sesam'],
      'L': ['schwefeldioxid', 'sulfite'],
      'M': ['lupinen'],
      'N': ['weichtiere', 'muscheln', 'austern']
    };
    
    const detectedAllergens = [];
    const ingredientsLower = ingredients.map(i => i.toLowerCase());
    
    Object.keys(allergenMap).forEach(code => {
      const keywords = allergenMap[code];
      if(keywords.some(keyword => ingredientsLower.some(ing => ing.includes(keyword)))){
        detectedAllergens.push(code);
      }
    });
    
    return detectedAllergens;
  }
  
  async function openPhotoEditor(imageDataUrl, opts){
    opts = opts || {};
    const onAccept = opts.onAccept;
    const useWizard = !onAccept;
    return new Promise(async (resolve)=>{
      const editor = document.createElement('div');
      editor.className='backdrop active';
      editor.style.zIndex='50';
      
      const editorContent = document.createElement('div');
      editorContent.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:24px;padding:24px;max-width:90vw;max-height:90vh;overflow:auto;z-index:51;box-shadow:0 8px 32px rgba(0,0,0,.2);';
      
      const aiAnalysisPromise = useWizard ? analyzeFoodPhoto(imageDataUrl) : Promise.resolve(null);
      
      const img = new Image();
      img.src = imageDataUrl;
      img.onload = async ()=>{
        const size = 400;
        const sourceSize = Math.min(img.width, img.height);
        const maxOffsetX = Math.max(0, img.width - sourceSize);
        const maxOffsetY = Math.max(0, img.height - sourceSize);
        let cropX = 50, cropY = 50;
        
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');
        
        function sourceX(){ return maxOffsetX * (cropX / 100); }
        function sourceY(){ return maxOffsetY * (cropY / 100); }
        
        function draw(){
          ctx.filter = 'brightness(1.1) contrast(1.15) saturate(1.1)';
          ctx.drawImage(img, sourceX(), sourceY(), sourceSize, sourceSize, 0, 0, size, size);
          previewImg.src = canvas.toDataURL('image/jpeg', 0.85);
        }
        
        const previewImg = document.createElement('img');
        previewImg.alt = '';
        previewImg.style.cssText = 'width:100%;max-width:400px;display:block;border-radius:12px;';
        const previewWrap = document.createElement('div');
        previewWrap.style.cssText = 'border-radius:16px;overflow:hidden;border:1px solid #eee;margin-bottom:16px;background:#f5f5f5';
        previewWrap.appendChild(previewImg);
        
        const heading = document.createElement('h3');
        heading.style.cssText = 'margin:0 0 16px;font-size:18px;font-weight:900;';
        heading.textContent = 'Foto bearbeiten';
        const hint = document.createElement('div');
        hint.className = 'hint';
        hint.style.marginBottom = '16px';
        hint.innerHTML = 'âœ“ Filter: Helligkeit + Kontrast Â· Quadratischer Zuschnitt, verschiebbar';
        
        const slidersWrap = document.createElement('div');
        slidersWrap.style.marginBottom = '16px';
        if(maxOffsetX > 0){
          const rowH = document.createElement('div');
          rowH.style.marginBottom = '12px';
          const labelH = document.createElement('label');
          labelH.style.cssText = 'display:block;font-size:13px;margin-bottom:4px;';
          labelH.textContent = 'Ausschnitt horizontal';
          const rangeH = document.createElement('input');
          rangeH.type = 'range';
          rangeH.min = 0;
          rangeH.max = 100;
          rangeH.value = 50;
          rangeH.style.width = '100%';
          rangeH.oninput = ()=>{ cropX = Number(rangeH.value); draw(); };
          rowH.appendChild(labelH);
          rowH.appendChild(rangeH);
          slidersWrap.appendChild(rowH);
        }
        if(maxOffsetY > 0){
          const rowV = document.createElement('div');
          rowV.style.marginBottom = '12px';
          const labelV = document.createElement('label');
          labelV.style.cssText = 'display:block;font-size:13px;margin-bottom:4px;';
          labelV.textContent = 'Ausschnitt vertikal';
          const rangeV = document.createElement('input');
          rangeV.type = 'range';
          rangeV.min = 0;
          rangeV.max = 100;
          rangeV.value = 50;
          rangeV.style.width = '100%';
          rangeV.oninput = ()=>{ cropY = Number(rangeV.value); draw(); };
          rowV.appendChild(labelV);
          rowV.appendChild(rangeV);
          slidersWrap.appendChild(rowV);
        }
        
        draw();
        
        const aiResult = await aiAnalysisPromise;
        if(useWizard && aiResult && w && w.data){
          if(aiResult.name && !w.data.dish) w.data.dish = aiResult.name;
          if(aiResult.price && !w.data.price) w.data.price = aiResult.price;
          if(aiResult.ingredients && aiResult.ingredients.length > 0){
            const allergens = tagAllergensFromIngredients(aiResult.ingredients);
            if(allergens.length > 0 && !w.data.allergens){
              w.data.allergens = allergens;
              w.data.wantsAllergens = true;
            }
          }
          if(typeof showToast === 'function') showToast('KI-Analyse: ' + (aiResult.name || 'Gericht erkannt'));
        }
        
        function finish(dataUrl){
          editor.remove();
          if(onAccept){ onAccept(dataUrl); resolve(dataUrl); return; }
          if(w && w.data){ w.data.photoData = dataUrl; w.data.photoDataIsStandard = false; }
          if(typeof rebuildWizard === 'function') rebuildWizard();
          resolve(dataUrl);
        }
        
        const acceptBtn = document.createElement('button');
        acceptBtn.className = 'btn';
        acceptBtn.textContent = 'Ãœbernehmen';
        acceptBtn.onclick = ()=> finish(canvas.toDataURL('image/jpeg', 0.85));
        
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn secondary';
        cancelBtn.textContent = 'Abbrechen';
        cancelBtn.style.marginLeft = '8px';
        cancelBtn.onclick = ()=>{ editor.remove(); resolve(null); };
        
        const btnRow = document.createElement('div');
        btnRow.style.display = 'flex';
        btnRow.style.gap = '8px';
        btnRow.appendChild(acceptBtn);
        btnRow.appendChild(cancelBtn);
        
        editorContent.appendChild(heading);
        editorContent.appendChild(previewWrap);
        editorContent.appendChild(hint);
        if(slidersWrap.children.length) editorContent.appendChild(slidersWrap);
        editorContent.appendChild(btnRow);
        
        editor.onclick = (e)=>{
          if(e.target === editor){ editor.remove(); resolve(null); }
        };
        
        editor.appendChild(editorContent);
        document.body.appendChild(editor);
      };
    });
  }

  // --- Pickup Code Screen Event Handlers ---
  const btnPickupCodeBack = document.getElementById('btnPickupCodeBack');
  if(btnPickupCodeBack){
    btnPickupCodeBack.onclick = () => {
      // Abholnummer-Ansicht explizit verstecken
      const pickupCodeView = document.getElementById('v-pickup-code');
      if(pickupCodeView){
        pickupCodeView.style.display = 'none';
        pickupCodeView.classList.remove('active');
      }
      showOrders(); // ZurÃ¼ck zu Abholnummern
    };
  }
  
  const btnCopyCode = document.getElementById('btnCopyCode');
  if(btnCopyCode){
    btnCopyCode.onclick = async () => {
      if(!currentPickupOrderId) return;
      const order = getOrderById(currentPickupOrderId);
      if(!order) return;
      // Code nur kopieren wenn PAID
      if(order.status !== 'PAID'){
        alert('Abholnummer wird nach erfolgreicher Zahlung generiert.');
        return;
      }
      const code = order.pickupCode || order.code || '';
      if(!code) return;
      
      // Clipboard API nutzen
      try{
        if(navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(code);
          btnCopyCode.innerHTML = '<i data-lucide="check"></i> Kopiert!';
          setTimeout(()=>{
            btnCopyCode.innerHTML = '<i data-lucide="copy"></i> Abholnummer kopieren';
            if(typeof lucide !== 'undefined') lucide.createIcons();
          }, 2000);
          if(typeof lucide !== 'undefined') lucide.createIcons();
          return;
        }
      } catch(e){
        // Fallback
      }
      
      // Fallback: select + copy
      const textarea = document.createElement('textarea');
      textarea.value = code;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      try{
        document.execCommand('copy');
        btnCopyCode.innerHTML = '<i data-lucide="check"></i> Kopiert!';
        setTimeout(()=>{
          btnCopyCode.innerHTML = '<i data-lucide="copy"></i> Abholnummer kopieren';
          if(typeof lucide !== 'undefined') lucide.createIcons();
        }, 2000);
        if(typeof lucide !== 'undefined') lucide.createIcons();
      } catch(e){
        // Fehler
      }
      document.body.removeChild(textarea);
    };
  }
  
  const btnOpenRoute = document.getElementById('btnOpenRoute');
  if(btnOpenRoute){
    btnOpenRoute.onclick = () => {
      if(!currentPickupOrderId) return;
      const order = getOrderById(currentPickupOrderId);
      if(!order) return;
      const address = order.providerAddress || '';
      if(address){
        // Route Ã¶ffnen (Ã¶ffnet Maps mit providerAddress)
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
        window.open(mapsUrl, '_blank');
      } else {
        alert('Adresse nicht verfÃ¼gbar.');
      }
    };
  }
  
  const btnToOrders = document.getElementById('btnToOrders');
  if(btnToOrders){
    btnToOrders.onclick = () => {
      showOrders(); // Zu Abholnummern
    };
  }
  
  // --- Swipe Action-Buttons Handler ---
  // Reset-Button (Nochmal von vorne)
  const btnSwipeReset = document.getElementById('btnSwipeReset');
  if(btnSwipeReset){
    btnSwipeReset.onclick = () => {
      // SessionStorage leeren (Ablehnungen zurÃ¼cksetzen)
      sessionStorage.removeItem('mittagio_disliked');
      
      // Index zurÃ¼cksetzen
      currentSwipeIndex = 0;
      
      // Swipe-Stack neu rendern
      renderSwipeCards();
      
      // End-of-Stack Karte ausblenden
      const swipeEndOfStack = document.getElementById('swipeEndOfStack');
      if(swipeEndOfStack) swipeEndOfStack.style.display = 'none';
      
      showToast('Von vorne gestartet', 1500);
    };
  }
  
  // Zur Liste wechseln Button (falls Swipe-UI vorhanden)
  const btnSwipeToList = document.getElementById('btnSwipeToList');
  if(btnSwipeToList){
    btnSwipeToList.onclick = () => {
      switchDiscoverView('list');
    };
  }
  
  // --- boot ---
  // Testdaten erstellen (nur wenn keine vorhanden oder fÃ¼r Demo)
  // seedExampleData()
  // seed(); // Auskommentiert, da seedExampleData() die neuen Beispieldaten lÃ¤dt
  
  // Neue Beispieldaten laden (10 Anbieter, je 3 Gerichte, je 10 Abholnummers)
  // Nur wenn keine Offers vorhanden oder fÃ¼r Demo
  if(offers.length === 0 || true){ // true fÃ¼r Demo - immer neu generieren
    seedExampleData();
  }
  offers = offers.map(normalizeOffer);
  save(LS.offers, offers);
  
  // Orders laden
  orders = loadOrders();
  
  // --- Route Handler: Checkout Success/Cancel + Abholnummer ---
  // Routes:
  //   /checkout/success?session_id=xxx OR ?orderId=xxx
  //   /checkout/cancel?orderId=xxx OR ?session_id=xxx
  //   /abholcode/:orderId (via URL hash or query param)
  {
    const urlParams = new URLSearchParams(window.location.search);
    const path = window.location.pathname;
    const hash = window.location.hash;
    
    // Success Route: /checkout/success
    if(path.includes('/checkout/success') || urlParams.has('session_id') || (urlParams.has('success') && urlParams.has('orderId'))){
      const sessionId = urlParams.get('session_id');
      const orderId = urlParams.get('orderId');
      
      if(sessionId || orderId){
        handleCheckoutSuccess(sessionId, orderId);
        // Clean URL (remove query params)
        window.history.replaceState({}, '', window.location.pathname);
      }
    }
    
    // Cancel Route: /checkout/cancel
    if(path.includes('/checkout/cancel') || (urlParams.has('cancel') && (urlParams.has('orderId') || urlParams.has('session_id')))){
      const orderId = urlParams.get('orderId');
      const sessionId = urlParams.get('session_id');
      if(orderId || sessionId){
        handleCheckoutCancel(orderId, sessionId);
        // Clean URL
        window.history.replaceState({}, '', window.location.pathname);
      }
    }
    
    // Legal Pages Routes: /impressum, /agb-kurz, /datenschutz, /faq; Version: /version
    if(hash){
      const legalRoutes = {
        '#/impressum': 'impressum',
        '#/agb-kurz': 'agb-kurz',
        '#/datenschutz': 'datenschutz',
        '#/faq': 'faq',
        '#/support': 'support'
      };
      if(legalRoutes[hash]){
        showLegalPage(legalRoutes[hash]);
      } else if(hash === '#/version'){
        showView(views.version || 'v-version');
      }
    }
    
    // Hash-Change Listener fÃ¼r Legal Pages & Version
    window.addEventListener('hashchange', function(){
      const hash = window.location.hash;
      const legalRoutes = {
        '#/impressum': 'impressum',
        '#/agb-kurz': 'agb-kurz',
        '#/datenschutz': 'datenschutz',
        '#/faq': 'faq',
        '#/support': 'support'
      };
      if(legalRoutes[hash]){
        showLegalPage(legalRoutes[hash]);
      } else if(hash === '#/version'){
        showView(views.version || 'v-version');
      }
    });
    
    // Abholnummer Route: /abholcode/:orderId
    // Support: /abholcode?orderId=xxx OR hash #abholcode/:orderId
    if(path.includes('/abholcode') || hash.includes('#abholcode/') || urlParams.has('abholcode')){
      let orderId = null;
      
      // Try hash first: #abholcode/:orderId
      if(hash.includes('#abholcode/')){
        orderId = hash.split('#abholcode/')[1]?.split('?')[0]?.split('#')[0];
      }
      
      // Try query param: ?abholcode=xxx or ?orderId=xxx
      if(!orderId){
        orderId = urlParams.get('abholcode') || urlParams.get('orderId');
      }
      
      if(orderId){
        showPickupCode(orderId);
        // Clean URL
        window.history.replaceState({}, '', window.location.pathname);
      }
    }
    
    // Share Route: /share/:offerId
    // Support: /share?offerId=xxx OR hash #share/:offerId
    if(path.includes('/share/') || hash.includes('#share/') || urlParams.has('share')){
      let offerId = null;
      
      // Try path: /share/:offerId
      if(path.includes('/share/')){
        offerId = path.split('/share/')[1]?.split('?')[0]?.split('#')[0];
      }
      
      // Try hash: #share/:offerId
      if(!offerId && hash.includes('#share/')){
        offerId = hash.split('#share/')[1]?.split('?')[0]?.split('#')[0];
      }
      
      // Try query param: ?share=xxx or ?offerId=xxx
      if(!offerId){
        offerId = urlParams.get('share') || urlParams.get('offerId');
      }
      
      if(offerId){
        // Ã–ffne das Gericht direkt
        openOffer(offerId);
        // Clean URL
        window.history.replaceState({}, '', window.location.pathname);
      }
    }
  } // Ende Route Handler Block
  
  // --- StabilitÃ¤ts-Sicherung: Status-Ampel & Connectivity-Check ---
  let connectivityCheckInterval = null;
  let lastConnectivityStatus = 'online';
  
  // Status-Ampel aktualisieren
  function updateStatusIndicator(status){
    const indicator = document.getElementById('providerStatusIndicator');
    const dot = document.getElementById('statusIndicatorDot');
    const text = document.getElementById('statusIndicatorText');
    
    if(!indicator || !dot || !text) return;
    
    // Entferne alle Animationen
    dot.style.animation = 'none';
    
    if(status === 'online'){
      dot.style.background = '#2ECC71';
      dot.style.boxShadow = '0 0 8px rgba(46,204,113,0.6)';
      dot.style.animation = 'pulse-green 2s infinite';
      text.textContent = 'In der KÃ¼che aktiv';
      text.style.color = 'rgba(255,255,255,0.9)';
      lastConnectivityStatus = 'online';
    } else if(status === 'offline'){
      dot.style.background = '#E34D4D';
      dot.style.boxShadow = '0 0 8px rgba(227,77,77,0.6)';
      dot.style.animation = 'blink-red 1s infinite';
      text.textContent = 'Offline!';
      text.style.color = '#E34D4D';
      lastConnectivityStatus = 'offline';
    } else if(status === 'connecting'){
      dot.style.background = '#FFD700';
      dot.style.boxShadow = '0 0 8px rgba(255,215,0,0.6)';
      dot.style.animation = 'pulse-yellow 1.5s infinite';
      text.textContent = 'Verbindung...';
      text.style.color = '#FFD700';
      lastConnectivityStatus = 'connecting';
    }
  }
  
  // Connectivity-Check (alle 10 Sekunden)
  function checkConnectivity(){
    const isOnline = navigator.onLine;
    
    // ZusÃ¤tzlicher Ping-Test: aktuelle Seite (existiert immer), kein Favicon (404 auf GitHub Pages)
    if(isOnline){
      const pingUrl = (window.location.origin + (window.location.pathname || '/')) + '?t=' + Date.now();
      fetch(pingUrl, { method: 'HEAD', cache: 'no-cache' })
        .then((r) => {
          updateStatusIndicator(r.ok ? 'online' : 'offline');
        })
        .catch(() => {
          updateStatusIndicator('offline');
        });
    } else {
      updateStatusIndicator('offline');
    }
  }
  
  // Connectivity-Check starten (nur im Provider-Modus)
  function startConnectivityCheck(){
    if(connectivityCheckInterval) clearInterval(connectivityCheckInterval);
    
    // Initial-Check
    checkConnectivity();
    
    // Alle 10 Sekunden prÃ¼fen
    connectivityCheckInterval = setInterval(checkConnectivity, 10000);
    
    // Event-Listener fÃ¼r Online/Offline-Events
    window.addEventListener('online', () => {
      updateStatusIndicator('connecting');
      setTimeout(() => checkConnectivity(), 1000);
    });
    window.addEventListener('offline', () => {
      updateStatusIndicator('offline');
    });
  }
  
  // Connectivity-Check stoppen
  function stopConnectivityCheck(){
    if(connectivityCheckInterval){
      clearInterval(connectivityCheckInterval);
      connectivityCheckInterval = null;
    }
  }
  
  // Support-Hilfe Ã¶ffnen (von Status-Ampel oder Support-Button)
  function openSupportHelp(){
    openSupportContact();
  }
  
  // Support-Kontakt Ã¶ffnen
  function openSupportContact(){
    const bd = document.getElementById('supportContactBd');
    const sheet = document.getElementById('supportContactSheet');
    if(bd) bd.classList.add('active');
    if(sheet) sheet.classList.add('active');
    
    // Formular zurÃ¼cksetzen
    const form = document.getElementById('supportContactForm');
    if(form) form.style.display = 'none';
    const message = document.getElementById('supportContactMessage');
    if(message) message.value = '';
    
    // Themen-Buttons zurÃ¼cksetzen
    ['technik', 'abrechnung', 'feedback'].forEach(topic => {
      const btn = document.getElementById('supportTopic' + topic.charAt(0).toUpperCase() + topic.slice(1));
      if(btn){
        btn.style.border = '2px solid #eee';
        btn.style.background = '#fff';
      }
    });
    
    // Icons rendern
    if(typeof lucide !== 'undefined'){
      setTimeout(() => lucide.createIcons(), 50);
    }
  }
  
  // Support-Kontakt schlieÃŸen
  function closeSupportContact(){
    const bd = document.getElementById('supportContactBd');
    const sheet = document.getElementById('supportContactSheet');
    if(bd) bd.classList.remove('active');
    if(sheet) sheet.classList.remove('active');
  }
  
  // Support-Thema auswÃ¤hlen
  let selectedSupportTopic = null;
  function selectSupportTopic(topic){
    selectedSupportTopic = topic;
    
    // Alle Buttons zurÃ¼cksetzen
    ['technik', 'abrechnung', 'feedback'].forEach(t => {
      const btn = document.getElementById('supportTopic' + t.charAt(0).toUpperCase() + t.slice(1));
      if(btn){
        btn.style.border = '2px solid #eee';
        btn.style.background = '#fff';
      }
    });
    
    // AusgewÃ¤hlten Button markieren
    const btn = document.getElementById('supportTopic' + topic.charAt(0).toUpperCase() + topic.slice(1));
    if(btn){
      btn.style.border = '2px solid #E34D4D';
      btn.style.background = 'rgba(227,77,77,0.05)';
    }
    
    // Formular anzeigen
    const form = document.getElementById('supportContactForm');
    if(form) form.style.display = 'block';
    
    // Textarea fokussieren
    const message = document.getElementById('supportContactMessage');
    if(message){
      setTimeout(() => message.focus(), 100);
    }
  }
  
  // Support-Kontakt absenden
  function submitSupportContact(){
    if(!selectedSupportTopic){
      showToast('Bitte wÃ¤hle ein Thema aus');
      return;
    }
    
    const message = document.getElementById('supportContactMessage');
    const messageText = message ? message.value.trim() : '';
    
    if(!messageText){
      showToast('Bitte gib eine Nachricht ein');
      if(message) message.focus();
      return;
    }
    
    const profile = normalizeProviderProfile(provider.profile || {});
    const providerName = profile.name || provider.email || 'Anbieter';
    
    // Themen-Mapping
    const topicLabels = {
      'technik': 'Technik & App',
      'abrechnung': 'Abrechnung & Zahlung',
      'feedback': 'Feedback & Ideen'
    };
    
    // E-Mail vorbereiten
    const subject = encodeURIComponent(`Support-Anfrage: ${topicLabels[selectedSupportTopic] || 'Allgemein'}`);
    const body = encodeURIComponent(`Hallo Mike,\n\nIch habe eine Anfrage zum Thema: ${topicLabels[selectedSupportTopic] || 'Allgemein'}\n\n${messageText}\n\n---\nAnbieter: ${providerName}\nE-Mail: ${provider.email || 'Nicht angegeben'}\nStatus: ${lastConnectivityStatus === 'offline' ? 'Offline' : 'Online'}\nZeitpunkt: ${new Date().toLocaleString('de-DE')}`);
    
    // E-Mail Ã¶ffnen
    window.location.href = `mailto:support@mittagio.de?subject=${subject}&body=${body}`;
    
    // Automatische Antwort-Mail senden (vorbereitet fÃ¼r Backend)
    sendSupportAutoReply(providerName, selectedSupportTopic);
    
    // Erfolgs-Toast
    showToast('E-Mail geÃ¶ffnet â€“ Vielen Dank fÃ¼r deine Nachricht!');
    
    // Sheet schlieÃŸen nach kurzer VerzÃ¶gerung
    setTimeout(() => {
      closeSupportContact();
    }, 1500);
  }
  
  // Automatische Antwort-Mail senden (vorbereitet fÃ¼r Backend)
  function sendSupportAutoReply(providerName, topic){
    // Themen-Mapping fÃ¼r Auto-Reply
    const topicLabels = {
      'technik': 'Technik & App',
      'abrechnung': 'Abrechnung & Zahlung',
      'feedback': 'Feedback & Ideen'
    };
    
    // TODO: In Production: Backend-Endpoint aufrufen
    // POST /api/send-support-auto-reply
    // Body: { providerId, providerName, providerEmail, topic, message, ... }
    
    // MVP: Log fÃ¼r Debugging
    const autoReplySubject = 'Deine Nachricht an das Mittagio-Team ðŸ¤';
    const autoReplyBody = `Hallo ${providerName},\n\nvielen Dank fÃ¼r deine Nachricht! Wir haben deine Anfrage zum Thema ${topicLabels[topic] || 'Allgemein'} erhalten.\n\nDa wir wissen, dass es in der KÃ¼che oft stressig zugeht, geben wir Vollgas: Wir schauen uns dein Anliegen sofort an und melden uns innerhalb der nÃ¤chsten 24 Stunden persÃ¶nlich bei dir.\n\nIn der Zwischenzeit: Schau gerne in unsere 'Erste-Hilfe'-Checkliste in deinem Profil â€“ oft lÃ¤sst sich dort schon eine schnelle LÃ¶sung finden.\n\nBeste GrÃ¼ÃŸe,\nMike von Mittagio`;
    
    console.log('[Support Auto-Reply] Sollte gesendet werden:', {
      providerId: providerId(),
      providerName: providerName,
      providerEmail: provider.email,
      topic: topic,
      subject: autoReplySubject,
      body: autoReplyBody,
      timestamp: new Date().toISOString()
    });
    
    // In Production wÃ¼rde hier ein fetch() zum Backend erfolgen:
    /*
    fetch('/api/send-support-auto-reply', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        providerId: providerId(),
        providerName: providerName,
        providerEmail: provider.email,
        topic: topic,
        autoReplySubject: autoReplySubject,
        autoReplyBody: autoReplyBody
      })
    }).catch(err => console.error('Support Auto-Reply failed:', err));
    */
  }
  
  // Backup-E-Mail an Anbieter senden (vorbereitet fÃ¼r Backend-Integration)
  function sendBackupEmailToProvider(order){
    // TODO: In Production: Backend-Endpoint aufrufen
    // POST /api/send-backup-email
    // Body: { orderId, providerId, pickupCode, dishName, ... }
    
    // MVP: Log fÃ¼r Debugging
    console.log('[Backup-Email] Sollte gesendet werden:', {
      orderId: order.id,
      providerId: order.providerId,
      pickupCode: order.pickupCode,
      dishName: order.dishName,
      timestamp: new Date().toISOString()
    });
    
    // In Production wÃ¼rde hier ein fetch() zum Backend erfolgen:
    /*
    fetch('/api/send-backup-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        orderId: order.id,
        providerId: order.providerId,
        pickupCode: order.pickupCode,
        dishName: order.dishName,
        providerEmail: provider.profile?.kitchenEmail || provider.email,
        timestamp: new Date().toISOString()
      })
    }).catch(err => console.error('Backup-Email failed:', err));
    */
  }
  
  // Auto-Reload-Logik (alle 30 Sekunden, nur wenn offline)
  function autoReloadIfNeeded(){
    if(!navigator.onLine && mode === 'provider'){
      // Wenn offline, versuche Seite neu zu laden (nur wenn wirklich nÃ¶tig)
      const lastReload = load('mittagio_last_reload', 0);
      const now = Date.now();
      if(now - lastReload > 30000){ // Maximal alle 30 Sekunden
        save('mittagio_last_reload', now);
        // Leise Reload (ohne Benutzer zu stÃ¶ren)
        window.location.reload();
      }
    }
  }
  
  // Initialisierung startet
  renderChips();

  // init nav bindings
  if(mode==='provider' && !provider.loggedIn) mode='customer';
  if(mode==='start') mode='customer';
  
  // Session-ValiditÃ¤t prÃ¼fen BEVOR setMode aufgerufen wird
  if(mode === 'provider' && provider.loggedIn){
    if(!checkSessionValidity()){
      // Session ungÃ¼ltig, wurde bereits ausgeloggt
      mode = 'customer';
    }
  }
  
  setMode(mode);
  
  // Connectivity-Check starten wenn Provider-Modus
  if(mode === 'provider' && provider.loggedIn){
    startConnectivityCheck();
    // Auto-Reload-Check alle 30 Sekunden
    setInterval(autoReloadIfNeeded, 30000);
  }
  
  updateProfileView();
  
  if(mode === 'customer'){
    setTimeout(()=>{
      if(typeof renderDiscover !== 'undefined'){
        renderDiscover();
      }
      if(typeof lucide !== 'undefined'){
        setTimeout(()=> lucide.createIcons(), 150);
      }
    }, 100);
  }
  
  if(mode === 'start'){
    setTimeout(()=>{
      if(typeof renderStart !== 'undefined'){
        renderStart();
      }
    }, 200);
  }
</script>

<script>
  // Icon-Initialisierung (immer, nicht nur bei Service Worker)
  function initIcons(){
    if(typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function'){
      lucide.createIcons();
    } else {
      // Warte bis Lucide geladen ist (max. 2 Sekunden)
      let attempts = 0;
      const checkLucide = setInterval(()=>{
        attempts++;
        if(typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function'){
          lucide.createIcons();
          clearInterval(checkLucide);
        } else if(attempts > 20){ // Nach 2 Sekunden aufgeben
          clearInterval(checkLucide);
        }
      }, 100);
    }
  }

  // Beispieldaten laden: 10 Anbieter mit je 3 Gerichten und 10 Abholnummers
  // WICHTIG: seedExampleData() NACH seed() aufrufen, damit die neuen Daten nicht Ã¼berschrieben werden
  // seedExampleData() wird am Ende aufgerufen (siehe unten)
  
  // Test-Funktion global verfÃ¼gbar machen (in Browser-Konsole: testPickupCodeLogic() aufrufen)
  if(typeof testPickupCodeLogic !== 'undefined'){
    window.testPickupCodeLogic = testPickupCodeLogic;
  }

  // PWA (optional)
  // TEMPORÃ„R DEAKTIVIERT ZUM TESTEN
  if(false && 'serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      // Service Worker-Pfad relativ zum aktuellen Verzeichnis
      const swPath = document.querySelector('base') ? 'sw.js' : './sw.js';
      navigator.serviceWorker.register(swPath).catch(()=>{});
      // Icons initialisieren
      initIcons();
      // Profile-View aktualisieren
      if(typeof updateProfileView !== 'undefined'){
        updateProfileView();
      }
      // Startseite rendern, falls im start-Mode
      if(typeof mode !== 'undefined' && mode === 'start' && typeof renderStart !== 'undefined'){
        setTimeout(()=>{
          renderStart();
          initIcons();
        }, 100);
      }
    });
  } else {
    // Fallback: Icons auch ohne Service Worker initialisieren
    window.addEventListener('load', ()=>{
      initIcons();
      // Topbar: Kundefarben setzen, wenn initial aktive View eine Kundenseite ist
      const activeView = document.querySelector('.view.active');
      const topbar = document.querySelector('.topbar');
      if(topbar && activeView && activeView.classList.contains('customer-view')){
        topbar.classList.add('customer-context');
      }
      // Profile-View aktualisieren
      if(typeof updateProfileView !== 'undefined'){
        updateProfileView();
      }
      // Startseite rendern, falls im start-Mode
      if(typeof mode !== 'undefined' && mode === 'start' && typeof renderStart !== 'undefined'){
        setTimeout(()=>{
          renderStart();
          initIcons();
        }, 100);
      }
    });
  }
  
  // Offline/Online Event-Handler (Fallback-Verhalten)
  window.addEventListener('online', () => {
    console.log('Online-Verbindung wiederhergestellt');
    // Optional: Toast anzeigen
    if(typeof showToast === 'function'){
      showToast('Verbindung wiederhergestellt', 2000);
    }
    // Optional: Daten neu laden
    if(mode === 'customer'){
      renderDiscover();
    }
  });
  
  window.addEventListener('offline', () => {
    console.log('Offline-Verbindung erkannt');
    // Optional: Toast anzeigen
    if(typeof showToast === 'function'){
      showToast('Keine Internetverbindung', 3000);
    }
    // Hinweis: Service Worker ist deaktiviert, daher keine Offline-FunktionalitÃ¤t
  });

  // Icons nach jedem View-Wechsel aktualisieren
  if(typeof showView !== 'undefined'){
    const originalShowView = showView;
    showView = function(id){
      originalShowView(id);
      setTimeout(()=> initIcons(), 50);
    };
  }
  // ---------------------------------------------------------
  // LIVE SYNC & OFFLINE HANDLING
  // ---------------------------------------------------------
  function setupLiveSync(){
    window.addEventListener('storage', (e) => {
      if(e.key === LS.orders || e.key === LS.offers){
        refreshCurrentView();
      }
    });

    setInterval(() => {
      if(document.visibilityState === 'visible' && mode === 'provider'){
        refreshCurrentView(true);
      }
    }, 10000);

    function updateOnlineStatus(){
      const isOnline = navigator.onLine;
      let statusEl = document.getElementById('appOnlineStatus');
      if(!isOnline){
        if(!statusEl){
          statusEl = document.createElement('div');
          statusEl.id = 'appOnlineStatus';
          statusEl.style.cssText = 'position:fixed; bottom:0; left:0; right:0; background:#d32f2f; color:#fff; font-size:12px; font-weight:700; text-align:center; padding:6px; z-index:9999; box-shadow:0 -2px 10px rgba(0,0,0,0.2);';
          statusEl.textContent = 'âš ï¸ Keine Internetverbindung â€“ Offline-Modus aktiv';
          document.body.appendChild(statusEl);
        } else {
          statusEl.style.display = 'block';
        }
      } else {
        if(statusEl) statusEl.style.display = 'none';
      }
    }
    
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();
  }

  function refreshCurrentView(silent=false){
    const activeView = document.querySelector('.view[style*="display: block"]');
    if(!activeView) return;
    if(activeView.id === 'v-provider-home'){ if(typeof renderProviderHome==='function') renderProviderHome(); }
    else if(activeView.id === 'v-provider-pickups'){ if(typeof renderProviderPickups==='function') renderProviderPickups(); }
  }

  setupLiveSync();
</script>
</body>
</html>
