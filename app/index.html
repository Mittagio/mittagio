<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Mittagio</title>
  <meta name="theme-color" content="#F2B705" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="assets/icons/icon-192.png" />
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
    :root{
      /* Mittagio palette (can be adjusted later) */
      --bg:#F7F6F0;
      --card:#FFFFFF;
      --text:#111;
      --muted:#6b6b6b;
      --border:#e7e1d5;
      --shadow:0 10px 24px rgba(0,0,0,.08);
      --shadow2:0 16px 40px rgba(0,0,0,.14);
      --radius:18px;
      --brand:#F2B705;   /* warm yellow */
      --brand2:#1F9D55;  /* green */
      --danger:#E34D4D;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit}

    /* App shell */
    .app{min-height:100%; padding-bottom:78px;}
    .topbar{
      position:sticky; top:0; z-index:10;
      background:rgba(247,246,240,.92);
      backdrop-filter:saturate(160%) blur(8px);
      border-bottom:1px solid var(--border);
    }
    .topbar-inner{max-width:980px; margin:0 auto; padding:12px 14px; display:flex; align-items:center; gap:10px;}
    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .brand-badge{
      width:38px; height:38px; border-radius:12px;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      box-shadow:0 8px 18px rgba(0,0,0,.16);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .brand-badge img{width:100%; height:100%; object-fit:cover; display:block}
    .brand-name{font-weight:900; letter-spacing:.06em; font-size:18px; white-space:nowrap}
    .spacer{flex:1}

    .chiprow{
      max-width:980px; margin:0 auto; padding:10px 14px 12px;
      display:flex; gap:8px; overflow:auto; -webkit-overflow-scrolling:touch;
    }
    .chip{
      flex:0 0 auto;
      border:1px solid var(--border);
      background:#fff;
      padding:9px 12px;
      border-radius:999px;
      font-size:13px;
      font-weight:800;
      color:#222;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .chip.active{border-color:rgba(31,157,85,.35); box-shadow:0 10px 22px rgba(31,157,85,.12)}

    .pickup-group{
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      padding:10px;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .pickup-group + .pickup-group{margin-top:10px}
    .pickup-head{display:flex; align-items:center; justify-content:space-between; gap:8px; font-weight:900}
    .pickup-sub{font-size:12px; color:var(--muted)}
    .code-chip{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px; border:1px solid var(--border);
      background:#fff; font-size:12px; font-weight:900;
      margin:4px 6px 0 0; box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .code-chip.done{background:rgba(31,157,85,.12); border-color:rgba(31,157,85,.4); color:#1f9d55; text-decoration:line-through}

    .dayrow{
      max-width:980px; margin:0 auto; padding:0 14px 12px;
      display:flex; gap:8px; overflow:auto; -webkit-overflow-scrolling:touch;
    }
    .day{
      flex:0 0 auto;
      border:none;
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      border:1px solid var(--border);
    }
    .day.active{background:rgba(242,183,5,.14); border-color:rgba(242,183,5,.55)}

    main{max-width:980px; margin:0 auto; padding:14px}
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    @media (min-width:820px){ .grid{grid-template-columns:1fr 1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:var(--shadow);
      cursor:pointer;
      position:relative;
    }
    .img{height:190px; background:#eee; position:relative}
    .img img{width:100%; height:100%; object-fit:cover; display:block}

    .provider-logo{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px 0;
    }
    .plogo{
      width:28px; height:28px; border-radius:8px;
      background:#f2f2f2;
      overflow:hidden;
      border:1px solid var(--border);
      flex:0 0 auto;
    }
    .plogo img{width:100%; height:100%; object-fit:cover; display:block}
    .pname{font-size:13px; font-weight:900; color:#222; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}

    .body{padding:10px 12px 12px}
    .title{font-weight:950; font-size:16px; margin:0}
    .sub{margin:3px 0 0; color:#444; font-size:13px}

    .meta{display:flex; justify-content:space-between; align-items:flex-end; gap:12px; margin-top:10px}
    .price{font-weight:950; font-size:16px; color:#0f5c4c}
    .right{ text-align:right; font-size:12px; color:var(--muted); line-height:1.25 }
    .tag{display:inline-block; margin-top:6px; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:900; background:rgba(31,157,85,.12)}

    .badge{
      position:absolute; top:12px; left:12px;
      background:rgba(17,17,17,.82);
      color:#fff;
      font-size:12px; font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      box-shadow:0 10px 22px rgba(0,0,0,.18);
    }
    .badge.code{left:auto; right:12px; background:rgba(31,157,85,.9)}
    .badge.dine{background:rgba(242,183,5,.9); color:#111}
    .badge.inactive{background:rgba(0,0,0,.45)}

    .heart{
      position:absolute; top:12px; right:12px;
      width:36px; height:36px; border-radius:999px;
      border:none; cursor:pointer;
      background:rgba(255,255,255,.92);
      box-shadow:0 10px 22px rgba(0,0,0,.16);
      font-size:16px;
      color:#bbb;
      display:flex; align-items:center; justify-content:center;
    }
    .heart.on{color:var(--danger)}

    /* Bottom nav */
    .bottom{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      height:72px; padding-bottom:env(safe-area-inset-bottom);
      background:#fff; border-top:1px solid var(--border);
      display:flex;
    }
    .navbtn{
      flex:1; border:none; background:none; cursor:pointer;
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:5px;
      color:#777; font-size:11px;
    }
    .navbtn .ico{font-size:18px}
    .navbtn.active{color:#111; font-weight:900}

    /* Views */
    .view{display:none}
    .view.active{display:block}

    /* Sheets / modals */
    .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.38); opacity:0; pointer-events:none; transition:opacity .2s; z-index:30}
    .backdrop.active{opacity:1; pointer-events:auto}
    .sheet{
      position:fixed; left:0; right:0; bottom:-120%; z-index:31;
      background:#fff; border-radius:22px 22px 0 0;
      box-shadow:var(--shadow2);
      transition:bottom .28s ease;
      max-height:92vh; overflow:auto;
    }
    .sheet.active{bottom:0}
    .handle{width:46px; height:5px; background:#ddd; border-radius:999px; margin:10px auto 6px}
    .sheet-img{height:260px; background:#eee}
    .sheet-img img{width:100%; height:100%; object-fit:cover; display:block}
    .sheet-body{padding:12px 14px 18px}
    .row{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px 0; border-top:1px solid #eee; font-size:14px}
    .btn{
      width:100%; border:none; cursor:pointer;
      border-radius:999px; padding:14px 14px; font-weight:950; font-size:15px;
      background:var(--brand); color:#111;
      margin-top:10px;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn.secondary{background:#fff; border:1px solid var(--border)}
    .btn.ghost{background:#f8f7f3; border:1px solid var(--border)}
    .mini{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.25}

    .card-actions{display:flex; flex-wrap:wrap; gap:6px; margin-top:10px}
    .card-action{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
    }
    .card-action.primary{background:var(--brand); border-color:var(--brand)}
    .card-action.ghost{background:#f8f7f3}
    .card-action:disabled{opacity:.5; cursor:not-allowed}

    /* Profile cards */
    .panel{background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); padding:12px}
    .panel h3{margin:0 0 8px; font-size:14px}
    .section-title{font-weight:900; margin:10px 0 6px}
    .rowlist{display:flex; flex-direction:column; gap:8px}
    .rowbtn{
      width:100%; border:1px solid var(--border); background:#fff; cursor:pointer;
      border-radius:14px; padding:12px; text-align:left; font-weight:900;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .rowbtn span{display:block; font-weight:600; font-size:12px; color:var(--muted); margin-top:4px}
    .rowgroup-title{font-size:12px; font-weight:900; color:var(--muted); margin-top:6px}
    .cookbook-item{border:1px solid var(--border); border-radius:14px; padding:10px; background:#fff; box-shadow:0 6px 14px rgba(0,0,0,.06)}
    .cookbook-item + .cookbook-item{margin-top:10px}
    .cookbook-actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .cookbook-facts{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.35}
    .cart-line{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 0; border-top:1px solid #eee}
    .cart-left{font-weight:700}
    .cart-qty{display:flex; align-items:center; gap:6px}
    .qty-btn{border:1px solid var(--border); background:#fff; border-radius:999px; width:28px; height:28px; cursor:pointer; font-weight:900}
    .cart-price{font-weight:900}
    .order-item{border:1px solid var(--border); border-radius:14px; padding:10px; background:#fff; box-shadow:0 6px 14px rgba(0,0,0,.06)}
    .order-item.done{opacity:.65}
    .order-item + .order-item{margin-top:10px}
    .order-top{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .order-right{display:flex; flex-direction:column; align-items:flex-end; gap:6px}
    .order-code{border:1px solid var(--border); background:#fff; border-radius:10px; padding:6px 10px; font-weight:900; cursor:pointer}
    .status-pill{display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; font-size:11px; font-weight:900; border:1px solid var(--border)}
    .status-pill.open{background:rgba(242,183,5,.12); color:#b37b00}
    .status-pill.done{background:rgba(31,157,85,.12); color:#1f9d55}
    .code-full{font-size:42px; font-weight:950; text-align:center; margin:10px 0}
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .bigbtn{
      border:none; cursor:pointer;
      border-radius:18px; padding:14px;
      background:linear-gradient(135deg,rgba(242,183,5,.18),rgba(31,157,85,.12));
      border:1px solid var(--border);
      text-align:left;
      font-weight:950;
    }
    .bigbtn span{display:block; font-weight:700; font-size:12px; color:var(--muted); margin-top:6px}

    /* Provider app header */
    .prov-pill{
      display:inline-flex; align-items:center; gap:8px;
      background:#fff; border:1px solid var(--border);
      padding:9px 12px; border-radius:999px;
      font-weight:950; font-size:13px;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }

    /* Wizard */
    .wizard{
      background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow);
      padding:12px;
    }
    .w-top{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .w-title{font-weight:950}
    .w-step{font-size:12px; color:var(--muted)}
    .w-q{margin:12px 0 10px; font-size:18px; font-weight:950; line-height:1.2}
    .w-help{margin:0 0 10px; color:var(--muted); font-size:13px}
    .answers{display:flex; flex-wrap:wrap; gap:8px}
    .ans{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-weight:950;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .ans.on{border-color:rgba(31,157,85,.4); background:rgba(31,157,85,.10)}
    .field{width:100%; padding:12px 12px; border-radius:14px; border:1px solid var(--border); font-size:16px; background:#fbfaf7}
    .w-actions{display:flex; gap:10px; margin-top:12px}
    .w-actions button{flex:1}

    /* FAQ accordion */
    .faq{margin-top:12px}
    details{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 14px rgba(0,0,0,.06);padding:10px 12px}
    details+details{margin-top:10px}
    summary{cursor:pointer;font-weight:950}
    details p{margin:8px 0 0;color:var(--muted);font-size:13px;line-height:1.3}

    /* helper */
    .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.25}
  </style>
</head>
<body>
<div class="app" id="app">
  <div class="topbar" id="topbar">
    <div class="topbar-inner">
      <div class="brand" role="button" aria-label="Mittagio">
        <div class="brand-badge"><img src="assets/mittagio-logo.png" alt="Mittagio" onerror="this.style.display='none'" /></div>
        <div class="brand-name">MITTAGIO</div>
      </div>
      <div class="spacer"></div>
      <div id="modePill" class="prov-pill" style="display:none;">Dashboard</div>
    </div>

    <!-- Customer discover filter rows (hidden in provider mode) -->
    <div id="discoverFilters">
      <div class="chiprow" id="catChips"></div>
      <div class="dayrow" id="dayChips"></div>
    </div>
  </div>

  <main>
    <!-- CUSTOMER: Discover -->
    <section class="view active" id="v-discover">
      <div class="panel">
        <div class="hint">Standort (optional)</div>
        <input class="field" id="locationInput" type="text" placeholder="PLZ oder Stadt" />
      </div>
      <div style="height:10px"></div>
      <div class="grid" id="offerGrid"></div>
      <p class="hint" id="emptyOffers" style="display:none;">Noch keine Angebote. Demo: Als Anbieter ein Inserat erstellen.</p>
    </section>

    <!-- CUSTOMER: Favorites -->
    <section class="view" id="v-fav">
      <div class="panel">
        <div class="section-title">Anbieter-Favoriten</div>
        <div class="grid" id="favProviders"></div>
        <div class="hint" id="emptyFavProviders" style="display:none;">Noch keine Anbieter-Favoriten.</div>
        <div class="section-title" style="margin-top:12px;">Gericht-Favoriten</div>
        <div class="grid" id="favDishes"></div>
        <div class="hint" id="emptyFavDishes" style="display:none;">Noch keine Gericht-Favoriten.</div>
      </div>
    </section>

    <!-- CUSTOMER: Orders -->
    <section class="view" id="v-orders">
      <div class="panel">
        <h3>Bestellungen</h3>
        <div class="answers" id="ordersFilters"></div>
        <div style="height:10px"></div>
        <div id="ordersList" class="hint">Noch keine Bestellungen.</div>
      </div>
    </section>

    <!-- CUSTOMER: Cart -->
    <section class="view" id="v-cart">
      <div class="panel">
        <h3>Warenkorb</h3>
        <div id="cartBox" class="hint">Dein Warenkorb ist leer.</div>
        <button class="btn" id="btnCheckout" type="button" style="display:none;">Weiter zur Zahlung</button>
        <div class="mini" id="cartNote" style="display:none;">
          Warenkorb nur mit Abholcode. Ein Anbieter pro Warenkorb.
        </div>
      </div>
    </section>

    <!-- CUSTOMER: Profile -->
    <section class="view" id="v-profile">
      <div class="panel">
        <h3>Profil</h3>
        <div class="two" style="margin-top:10px;">
          <button class="bigbtn" type="button" id="btnCustomerLogin">Als Kunde anmelden<span>Google / Apple / E-Mail (Demo)</span></button>
          <button class="bigbtn" type="button" id="btnProviderEntry">Anbieter-Login<span>Zum Anbieterbereich</span></button>
        </div>
        <div style="margin-top:10px;" class="hint" id="customerStatus">Nicht angemeldet (Demo).</div>
      </div>

      <div class="faq">
        <details>
          <summary>Wie funktioniert Mittagio?</summary>
          <p>Entdecken -> Gericht auswaehlen -> in den Warenkorb -> bezahlen -> Abholcode zeigen.</p>
        </details>
        <details>
          <summary>Kann ich f√ºr mehrere Personen bestellen?</summary>
          <p>Ja. Du kannst mehrere Gerichte in einem Vorgang bestellen (Abholcode pro Vorgang).</p>
        </details>
      </div>
    </section>

    <!-- PROVIDER: Login page -->
    <section class="view" id="v-provider-login">
      <div class="panel">
        <h3>Anbieter-Login</h3>
        <input class="field" id="provEmail" type="email" placeholder="E-Mail" autocomplete="email" />
        <div style="height:10px"></div>
        <input class="field" id="provPass" type="password" placeholder="Passwort" autocomplete="current-password" />
        <button class="btn" type="button" id="btnProvLogin">Einloggen</button>
        <button class="btn secondary" type="button" id="btnProvBack">Zur√ºck</button>
        <p class="hint">Demo: beliebige E-Mail/Passwort -> du bist drin. (Sp√§ter: Firebase Auth.)</p>
      </div>
    </section>

    <!-- PROVIDER APP -->
    <section class="view" id="v-provider-home">
      <div class="panel">
        <h3>Dashboard</h3>
        <div class="hint" id="provHomeHello"></div>
        <button class="btn" type="button" id="btnNewListing">+ Neues Gericht erstellen</button>
        <button class="btn ghost" type="button" id="btnShareToday" style="display:none;">Heutige Angebote teilen</button>
      </div>

      <div style="height:12px"></div>
      <div class="panel">
        <h3>Aktive Inserate</h3>
        <div id="provActiveGrid" class="grid" style="margin-top:10px"></div>
        <div id="provActiveEmpty" class="hint">Noch keine aktiven Inserate.</div>
      </div>

      <div style="height:12px"></div>
      <div class="panel" id="provInactivePanel" style="display:none;">
        <h3>Inaktive Inserate</h3>
        <div id="provInactiveGrid" class="grid" style="margin-top:10px"></div>
        <div id="provInactiveEmpty" class="hint">Keine inaktiven Inserate.</div>
      </div>

      <div style="height:12px"></div>
      <div class="panel">
        <h3>Wochenvorschau</h3>
        <div class="dayrow" id="provWeekDays" style="padding:0 0 10px; max-width:none;"></div>
        <div id="provWeekPreview" class="hint">Noch nichts geplant.</div>
        <button class="btn secondary" type="button" id="btnOpenWeekPlan">Wochenplan anzeigen</button>
      </div>

      <div style="height:12px"></div>
      <div class="panel">
        <h3>Abholcodes heute</h3>
        <div id="provPickupStats" class="hint">Noch keine Abholcodes f√ºr heute.</div>
      </div>
    </section>

    <section class="view" id="v-provider-pickups">
      <div class="panel">
        <h3>Abholungen</h3>
        <div id="provPickupsEmpty" class="hint">
          Aktuell keine Abholungen geplant.<br>
          Geplante Abholungen sorgen f√ºr weniger Chaos.
          <div style="height:10px"></div>
          <button class="btn secondary" type="button" id="btnPickupsFaq">Mehr erfahren</button>
        </div>
        <div id="provPickupsWrap" style="display:none;">
          <div class="hint" style="margin-top:8px;">Sortierung</div>
          <div class="answers" id="provPickupSort"></div>
          <div id="provPickupGroups" style="margin-top:10px;"></div>
        </div>
      </div>
    </section>

    <section class="view" id="v-provider-week">
      <div class="panel">
        <h3>Wochenplan</h3>
        <div class="dayrow" id="weekDays" style="padding:0 0 10px; max-width:none;"></div>
        <div id="weekList" class="hint">Noch nichts geplant.</div>
        <button class="btn secondary" type="button" id="btnWeekPdf">PDF-Wochenkarte erstellen</button>
        <button class="btn ghost" type="button" id="btnWeekBack">Zur√ºck</button>
      </div>
    </section>

    <section class="view" id="v-provider-cookbook">
      <div class="panel">
        <h3>Mein Kochbuch</h3>
        <div class="hint">Dein digitales Kochbuch - dein Kopf in der App.</div>
        <div style="height:10px"></div>
        <input class="field" id="cookbookSearch" type="text" placeholder="Suche nach Gerichten" />
        <div style="height:10px"></div>
        <div class="answers" id="cookbookFilters"></div>
        <button class="btn" type="button" id="btnCookbookAdd">+ Gericht hinzuf√ºgen</button>
        <div style="height:10px"></div>
        <div id="cookbookList" class="hint">Noch keine Gerichte gespeichert.</div>
      </div>
    </section>

    <section class="view" id="v-provider-profile">
      <div class="panel">
        <h3>Mein Profil</h3>
        <div class="hint" id="provProfileHint"></div>
      </div>

      <div style="height:12px"></div>
      <div class="panel">
        <div class="rowlist">
          <button class="rowbtn" type="button" id="rowProfileOverview">
            <div>Mein Profil<span>√úbersicht</span></div>
            <div>‚Ä∫</div>
          </button>
          <button class="rowbtn" type="button" id="btnProvSetup">
            <div>Profil bearbeiten<span>Name, Adresse, Logo, E-Mail, Website</span></div>
            <div>‚Ä∫</div>
          </button>
          <button class="rowbtn" type="button" id="btnBilling">
            <div>Abrechnungen</div>
            <div>‚Ä∫</div>
          </button>
          <button class="rowbtn" type="button" id="btnProvActions">
            <div>Aktionen</div>
            <div>‚Ä∫</div>
          </button>
          <button class="rowbtn" type="button" id="btnProvFaq">
            <div>FAQs & Hilfe</div>
            <div>‚Ä∫</div>
          </button>
          <div class="rowgroup-title">Rechtliches</div>
          <button class="rowbtn" type="button" id="btnLegalImprint">
            <div>Impressum</div>
            <div>‚Ä∫</div>
          </button>
          <button class="rowbtn" type="button" id="btnLegalPrivacy">
            <div>Datenschutz</div>
            <div>‚Ä∫</div>
          </button>
          <button class="rowbtn" type="button" id="btnLegalTerms">
            <div>AGB</div>
            <div>‚Ä∫</div>
          </button>
        </div>
      </div>

      <div style="height:12px"></div>
      <button class="btn ghost" type="button" id="btnProvLogout">Logout</button>

      <div id="provFaqBox" class="faq" style="display:none;">
        <details>
          <summary>Kein Abo / keine Provision?</summary>
          <p>Ja. Fixpreis pro Inserat (aktuell 4,99 EUR). Keine Mindestlaufzeit.</p>
        </details>
        <details>
          <summary>Wie funktionieren Abholungen?</summary>
          <p>Wenn Abholcode aktiv ist, werden die Codes nach Gericht gruppiert angezeigt. Tippe einen Code an, sobald ein Gast abgeholt hat.</p>
        </details>
        <details>
          <summary>Warum Abholcode?</summary>
          <p>Vorab bezahlt, weniger Chaos an der Ausgabe und ein klarer Ablauf pro Bestellung.</p>
        </details>
        <details>
          <summary>Was kostet Abholcode?</summary>
          <p>49 Cent pro bezahltem Vorgang. (Auch wenn der Kunde mehrere Gerichte in einem Vorgang holt.)</p>
        </details>
        <details>
          <summary>Wie spare ich Zeit?</summary>
          <p>Speichere Gerichte im Kochbuch und ver√∂ffentliche sie mit 2-3 Taps erneut.</p>
        </details>
      </div>
    </section>

  </main>

  <!-- CUSTOMER bottom nav -->
  <nav class="bottom" id="customerNav">
    <button class="navbtn active" data-go="discover"><div class="ico">üçΩÔ∏è</div><div>Entdecken</div></button>
    <button class="navbtn" data-go="fav"><div class="ico">‚ù§Ô∏è</div><div>Favoriten</div></button>
    <button class="navbtn" data-go="orders"><div class="ico">üßæ</div><div>Bestellungen</div></button>
    <button class="navbtn" data-go="cart"><div class="ico">üõí</div><div>Warenkorb</div></button>
    <button class="navbtn" data-go="profile"><div class="ico">üë§</div><div>Profil</div></button>
  </nav>

  <!-- PROVIDER bottom nav -->
  <nav class="bottom" id="providerNav" style="display:none;">
    <button class="navbtn active" data-pgo="provider-home"><div class="ico">üè†</div><div>Home</div></button>
    <button class="navbtn" data-pgo="provider-pickups"><div class="ico">üßæ</div><div>Abholungen</div></button>
    <button class="navbtn" data-pgo="provider-cookbook"><div class="ico">üìö</div><div>Kochbuch</div></button>
    <button class="navbtn" data-pgo="provider-profile"><div class="ico">‚öôÔ∏è</div><div>Profil</div></button>
  </nav>
</div>

<!-- Offer sheet -->
<div class="backdrop" id="bd" onclick="closeSheet()"></div>
<div class="sheet" id="sheet">
  <div class="handle"></div>
  <div class="sheet-img"><img id="sImg" alt="" /></div>
  <div class="sheet-body">
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;">
      <div>
        <div style="font-weight:950;font-size:18px" id="sDish"></div>
        <div style="color:#444;font-size:13px;margin-top:4px" id="sProvider"></div>
      </div>
      <div style="text-align:right">
        <div class="price" id="sPrice"></div>
        <div class="tag" id="sCat" style="margin-top:8px"></div>
      </div>
    </div>

    <div class="row"><span>Abholfenster</span><b id="sWindow"></b></div>
    <div class="row"><span>Adresse</span><a id="sAddr" href="#" target="_blank" rel="noopener">√∂ffnen</a></div>

    <div id="sAllergensWrap" style="display:none">
      <div class="row"><span>Allergene</span><span id="sAllergens" style="text-align:right;color:var(--muted)"></span></div>
    </div>
    <div id="sExtrasWrap" style="display:none">
      <div class="row"><span>Extras</span><span id="sExtras" style="text-align:right;color:var(--muted)"></span></div>
    </div>
    <div id="sReuseWrap" style="display:none">
      <div class="row"><span>Mehrweg / Pfand</span><span id="sReuse" style="text-align:right;color:var(--muted)"></span></div>
    </div>

    <button class="btn" type="button" id="btnAddCart">In den Warenkorb</button>
    <button class="btn secondary" type="button" id="btnShare">Teilen</button>
    <button class="btn ghost" type="button" id="btnDishFav">Gericht speichern</button>
    <button class="btn ghost" type="button" id="btnFav">Anbieter speichern</button>
    <div class="mini" id="sCodeNote"></div>
  </div>
</div>

<!-- Provider offer sheet -->
<div class="backdrop" id="pbd" onclick="closeProviderSheet()"></div>
<div class="sheet" id="psheet">
  <div class="handle"></div>
  <div class="sheet-body">
    <div id="pPreview"></div>
    <div class="row"><span>Status</span><b id="pStatus"></b></div>
    <div class="row"><span>Essenszeit</span><b id="pWindow"></b></div>
    <button class="btn" type="button" id="btnEditOffer">Bearbeiten</button>
    <button class="btn secondary" type="button" id="btnToggleOffer">Deaktivieren</button>
    <button class="btn ghost" type="button" id="btnShareOffer">Teilen</button>
    <button class="btn ghost" type="button" id="btnPrintOffer">Drucken</button>
  </div>
</div>

<!-- Pickup code sheet -->
<div class="backdrop" id="codeBd" onclick="closeCodeSheet()"></div>
<div class="sheet" id="codeSheet">
  <div class="handle"></div>
  <div class="sheet-body">
    <div class="code-full" id="codeText">A1</div>
    <div class="hint" style="text-align:center;">Abholnummer</div>
    <div class="hint" id="codeStatus" style="text-align:center; margin-top:6px;"></div>
    <div class="panel" style="margin-top:10px;">
      <div style="font-weight:900" id="codeProvider">Anbieter</div>
      <div class="hint" id="codeSummary"></div>
      <div class="hint" id="codePickupWindow"></div>
      <div class="hint" id="codePickupTime"></div>
    </div>
    <button class="btn" type="button" id="btnToggleOrderStatus">Als abgeholt markieren</button>
    <button class="btn secondary" type="button" id="btnCodeClose">Schlie√üen</button>
  </div>
</div>

<!-- Share sheet -->
<div class="backdrop" id="shareBd" onclick="closeShareSheet()"></div>
<div class="sheet" id="shareSheet">
  <div class="handle"></div>
  <div class="sheet-body">
    <div class="panel">
      <div style="font-weight:900">Teilen</div>
      <div class="hint" id="sharePreview"></div>
    </div>
    <div class="answers" style="margin-top:10px;">
      <button class="ans" type="button" id="btnShareWhatsApp">WhatsApp</button>
      <button class="ans" type="button" id="btnShareInstagram">Instagram</button>
      <button class="ans" type="button" id="btnShareWebsite">Website</button>
      <button class="ans" type="button" id="btnShareCopy">Link kopieren</button>
    </div>
    <button class="btn secondary" type="button" id="btnShareClose">Schlie√üen</button>
  </div>
</div>

<!-- Provider Wizard sheet (single reusable) -->
<div class="backdrop" id="wbd" onclick="closeWizard()"></div>
<div class="sheet" id="wizard">
  <div class="handle"></div>
  <div class="sheet-body">
    <div class="wizard" id="wBox">
      <div class="w-top">
        <div class="w-title" id="wTitle">Setup</div>
        <div class="w-step" id="wStep">1/6</div>
      </div>
      <div class="w-q" id="wQ">‚Ä¶</div>
      <p class="w-help" id="wHelp"></p>
      <div id="wContent"></div>
      <div class="w-actions">
        <button class="btn secondary" type="button" id="wBack">Zur√ºck</button>
        <button class="btn" type="button" id="wNext">Weiter</button>
      </div>
    </div>
  </div>
</div>

<script>
  // --- Storage keys ---
  const LS = {
    offers: 'mittagio_offers_v1',
    favs: 'mittagio_favs_v1',
    providerFavs: 'mittagio_provider_favs_v1',
    dishFavs: 'mittagio_dish_favs_v1',
    cart: 'mittagio_cart_v1',
    orders: 'mittagio_orders_v1',
    customer: 'mittagio_customer_v1',
    provider: 'mittagio_provider_v1',
    cookbook: 'mittagio_cookbook_v1',
    week: 'mittagio_week_v1',
    mode: 'mittagio_mode_v1'
  };
  const load = (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch { return d; } };
  const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

  // --- State ---
  let mode = load(LS.mode, 'customer'); // 'customer' | 'provider'
  let offers = load(LS.offers, []);
  const legacyFavs = load(LS.favs, []);
  let providerFavs = new Set(load(LS.providerFavs, legacyFavs));
  let dishFavs = new Set(load(LS.dishFavs, []));
  let cart = load(LS.cart, null); // {providerId, items:[{offerId, qty}]} or null
  let orders = load(LS.orders, []); // [{id, providerName, summary, code, status, createdAt}]
  let customer = load(LS.customer, { loggedIn:false, name:null });
  let provider = load(LS.provider, { loggedIn:false, email:null, profile:{ name:'', address:'', street:'', zip:'', city:'', mealWindow:'11:30 ‚Äì 14:00', logoData:'' } });
  let cookbook = load(LS.cookbook, []); // [{id, dish, category, price, allergens[], extras?, reuse? , photoData?}]
  let week = load(LS.week, {}); // { 'YYYY-MM-DD': [cookbookId,...] }

  const CATEGORIES = ['Vegan','Vegetarisch','Fleisch'];
  const CAT_MAP = {
    'Vegan':'Vegan',
    'Vegetarisch':'Vegetarisch',
    'Fleisch':'Fleisch'
  };
  const DISH_SUGGESTIONS = [
    {name:'K√ºrbissuppe', category:'Vegan'},
    {name:'Tomatensuppe mit Brot', category:'Vegan'},
    {name:'Pasta mit Gem√ºse', category:'Vegetarisch'},
    {name:'K√§sesp√§tzle', category:'Vegetarisch'},
    {name:'Salat Bowl', category:'Vegetarisch'},
    {name:'Falafel Teller', category:'Vegan'},
    {name:'Veggie Burger', category:'Vegan'},
    {name:'Schnitzel mit Pommes', category:'Fleisch'},
    {name:'Currywurst', category:'Fleisch'},
    {name:'Gulasch mit Sp√§tzle', category:'Fleisch'}
  ];

  // Day slider: today..+6
  function fmtDay(d){
    const wd = ['So','Mo','Di','Mi','Do','Fr','Sa'][d.getDay()];
    return `${wd} ${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}`;
  }
  function isoDate(d){ return d.toISOString().slice(0,10); }

  let activeCat = null;
  let activeDay = isoDate(new Date());
  let providerWeekDay = isoDate(new Date());
  let pickupSort = 'time';
  let cookbookSort = 'recent';
  let cookbookQuery = '';
  let weekPlanDay = isoDate(new Date());
  let locationQuery = '';
  let pickupDone = new Set();
  let activeOrderId = null;
  let ordersFilter = 'offen';
  let sharePayload = { text:'', url:'' };

  // --- Seed demo offers if empty ---
  function seed(){
    if(offers.length) return;
    offers = [
      // Demo: 3 Anbieter √ó 4 Gerichte
      // Metzgerei Maier (Schorndorf) ‚Äî Vorab-Bezahlung aktiv
      {id: uid(), providerId: 'p_maier', providerName: 'Metzgerei Maier', address: 'Musterstra√üe 12, 73614 Schorndorf', title: 'Schnitzel mit Pommes', price: 7.90, time: '11:30 ‚Äì 14:00', diet: 'Fleisch', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1544025162-d76694265947?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true},
      {id: uid(), providerId: 'p_maier', providerName: 'Metzgerei Maier', address: 'Musterstra√üe 12, 73614 Schorndorf', title: 'Currywurst mit Br√∂tchen', price: 5.90, time: '11:30 ‚Äì 14:00', diet: 'Fleisch', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1550547660-d9450f859349?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true},
      {id: uid(), providerId: 'p_maier', providerName: 'Metzgerei Maier', address: 'Musterstra√üe 12, 73614 Schorndorf', title: 'Leberk√§se mit Kartoffelsalat', price: 6.50, time: '11:30 ‚Äì 14:00', diet: 'Fleisch', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1604908177522-937be1a2d0a0?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true},
      {id: uid(), providerId: 'p_maier', providerName: 'Metzgerei Maier', address: 'Musterstra√üe 12, 73614 Schorndorf', title: 'K√§sesp√§tzle', price: 6.90, time: '11:30 ‚Äì 14:00', diet: 'Vegetarisch', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1604908812253-9b998f4949b3?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true},

      // B√§ckerei & Bistro Sonneneck (Stuttgart) ‚Äî Vorab-Bezahlung NICHT aktiv
      {id: uid(), providerId: 'p_sonn', providerName: 'B√§ckerei Sonneneck', address: 'Hauptstra√üe 8, 70173 Stuttgart', title: 'Pasta-Bowl', price: 7.20, time: '11:00 ‚Äì 13:30', diet: 'Vegetarisch', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1523986371872-9d3ba2e2f642?auto=format&fit=crop&w=1200&q=60', hasPickupCode: false},
      {id: uid(), providerId: 'p_sonn', providerName: 'B√§ckerei Sonneneck', address: 'Hauptstra√üe 8, 70173 Stuttgart', title: 'H√§hnchen-Sandwich', price: 5.40, time: '11:00 ‚Äì 13:30', diet: 'Fleisch', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1528735602780-2552fd46c7af?auto=format&fit=crop&w=1200&q=60', hasPickupCode: false},
      {id: uid(), providerId: 'p_sonn', providerName: 'B√§ckerei Sonneneck', address: 'Hauptstra√üe 8, 70173 Stuttgart', title: 'Veggie Bowl', price: 6.80, time: '11:00 ‚Äì 13:30', diet: 'Vegan', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60', hasPickupCode: false},
      {id: uid(), providerId: 'p_sonn', providerName: 'B√§ckerei Sonneneck', address: 'Hauptstra√üe 8, 70173 Stuttgart', title: 'Tomatensuppe mit Brot', price: 4.90, time: '11:00 ‚Äì 13:30', diet: 'Vegetarisch', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1547592180-85f173990554?auto=format&fit=crop&w=1200&q=60', hasPickupCode: false},

      // Foodtruck ‚ÄûGr√ºne Pause‚Äú (Esslingen) ‚Äî Vorab-Bezahlung aktiv
      {id: uid(), providerId: 'p_green', providerName: 'Foodtruck Gr√ºne Pause', address: 'Marktplatz 1, 73728 Esslingen', title: 'Veggie-Burger mit S√º√ükartoffeln', price: 8.40, time: '12:00 ‚Äì 14:30', diet: 'Vegan', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1550547660-d9450f859349?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true},
      {id: uid(), providerId: 'p_green', providerName: 'Foodtruck Gr√ºne Pause', address: 'Marktplatz 1, 73728 Esslingen', title: 'Falafel-Teller mit Hummus', price: 7.90, time: '12:00 ‚Äì 14:30', diet: 'Vegan', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1613408181925-78e9f9a49f3f?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true},
      {id: uid(), providerId: 'p_green', providerName: 'Foodtruck Gr√ºne Pause', address: 'Marktplatz 1, 73728 Esslingen', title: 'Pasta mit Gem√ºse & Pesto', price: 7.50, time: '12:00 ‚Äì 14:30', diet: 'Vegetarisch', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1523986371872-9d3ba2e2f642?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true},
      {id: uid(), providerId: 'p_green', providerName: 'Foodtruck Gr√ºne Pause', address: 'Marktplatz 1, 73728 Esslingen', title: 'Ofenkartoffel mit Kr√§uterquark', price: 6.90, time: '12:00 ‚Äì 14:30', diet: 'Vegetarisch', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1518779578993-ec3579fee39f?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true},

      // Ein paar Angebote f√ºr morgen/√ºbermorgen (damit die Datums-Tabs nicht leer wirken)
      {id: uid(), providerId: 'p_maier', providerName: 'Metzgerei Maier', address: 'Musterstra√üe 12, 73614 Schorndorf', title: 'Gulasch mit Sp√§tzle', price: 8.20, time: '11:30 ‚Äì 14:00', diet: 'Fleisch', day: '2026-01-19', img: 'https://images.unsplash.com/photo-1604908177522-937be1a2d0a0?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true},
      {id: uid(), providerId: 'p_sonn', providerName: 'B√§ckerei Sonneneck', address: 'Hauptstra√üe 8, 70173 Stuttgart', title: 'K√ºrbissuppe', price: 5.20, time: '11:00 ‚Äì 13:30', diet: 'Vegan', day: '2026-01-19', img: 'https://images.unsplash.com/photo-1547592180-85f173990554?auto=format&fit=crop&w=1200&q=60', hasPickupCode: false},
      {id: uid(), providerId: 'p_green', providerName: 'Foodtruck Gr√ºne Pause', address: 'Marktplatz 1, 73728 Esslingen', title: 'Wrap (Vegan)', price: 7.10, time: '12:00 ‚Äì 14:30', diet: 'Vegan', day: '2026-01-20', img: 'https://images.unsplash.com/photo-1528735602780-2552fd46c7af?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true},
    ];
    save(LS.offers, offers);
  }

  // --- UI helpers ---
  function euro(n){
    const v = Number(n||0);
    return v.toFixed(2).replace('.',',') + ' ‚Ç¨';
  }
  function cryptoId(){
    return 'id_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
  }
  function esc(s){
    return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[c]));
  }

  const DEFAULT_MEAL_WINDOW = '11:30 ‚Äì 14:00';

  function buildAddress(p){
    if(p && p.address && String(p.address).trim()) return String(p.address).trim();
    const rest = [p?.zip, p?.city].filter(Boolean).join(' ').trim();
    return [p?.street, rest].filter(Boolean).join(', ');
  }

  function parseAddress(addr){
    const raw = String(addr||'').trim();
    const out = { address: raw, street:'', zip:'', city:'' };
    if(!raw) return out;
    const parts = raw.split(',').map(s=>s.trim()).filter(Boolean);
    if(parts.length){ out.street = parts[0]; }
    if(parts.length > 1){
      const rest = parts.slice(1).join(', ');
      const m = rest.match(/^(\d{4,6})\s*(.*)$/);
      if(m){ out.zip = m[1]; out.city = m[2] || ''; }
      else { out.city = rest; }
    }
    return out;
  }

  function normalizeProviderProfile(p){
    const base = { name:'', address:'', street:'', zip:'', city:'', mealWindow:DEFAULT_MEAL_WINDOW, logoData:'' };
    const out = {...base, ...(p||{})};
    if(!out.address){ out.address = buildAddress(out); }
    if(!out.mealWindow){ out.mealWindow = DEFAULT_MEAL_WINDOW; }
    return out;
  }

  function normalizeOffer(o){
    const out = {...(o||{})};
    if(!out.dish && out.title) out.dish = out.title;
    if(!out.imageUrl && out.img) out.imageUrl = out.img;
    if(!out.pickupWindow && out.time) out.pickupWindow = out.time;
    if(!out.category && out.diet) out.category = out.diet;

    if(out.address && (!out.providerStreet && !out.providerZip && !out.providerCity)){
      const parsed = parseAddress(out.address);
      out.providerStreet = out.providerStreet || parsed.street || '';
      out.providerZip = out.providerZip || parsed.zip || '';
      out.providerCity = out.providerCity || parsed.city || '';
    }
    out.providerStreet = out.providerStreet || '';
    out.providerZip = out.providerZip || '';
    out.providerCity = out.providerCity || '';
    out.hasPickupCode = !!out.hasPickupCode;
    out.dineInPossible = !!out.dineInPossible;
    if(out.active === undefined) out.active = true;
    return out;
  }

  // --- Navigation ---
  const views = {
    discover:'v-discover', fav:'v-fav', orders:'v-orders', cart:'v-cart', profile:'v-profile',
    providerLogin:'v-provider-login',
    providerHome:'v-provider-home', providerPickups:'v-provider-pickups', providerCookbook:'v-provider-cookbook', providerProfile:'v-provider-profile', providerWeek:'v-provider-week'
  };

  function setCustomerNavActive(go){
    document.querySelectorAll('#customerNav .navbtn').forEach(b=>b.classList.toggle('active', b.dataset.go===go));
  }
  function setProviderNavActive(go){
    document.querySelectorAll('#providerNav .navbtn').forEach(b=>b.classList.toggle('active', b.dataset.pgo===go));
  }

  function showView(id){
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo({top:0,behavior:'smooth'});
  }

  function setMode(next){
    mode = next;
    save(LS.mode, mode);

    const isProv = mode==='provider';
    document.getElementById('customerNav').style.display = isProv ? 'none' : 'flex';
    document.getElementById('providerNav').style.display = isProv ? 'flex' : 'none';
    document.getElementById('discoverFilters').style.display = isProv ? 'none' : 'block';
    document.getElementById('modePill').style.display = isProv ? 'inline-flex' : 'none';

    if(isProv){
      // provider must be logged in
      if(!provider.loggedIn){
        showView(views.providerLogin);
      } else {
        showProviderHome();
      }
    } else {
      showDiscover();
    }
  }

  // --- Customer views ---
  function showDiscover(){
    setCustomerNavActive('discover');
    showView(views.discover);
    renderDiscover();
  }
  function showFav(){
    setCustomerNavActive('fav');
    showView(views.fav);
    renderFavorites();
  }
  function showOrders(){
    setCustomerNavActive('orders');
    showView(views.orders);
    renderOrders();
  }
  function showCart(){
    setCustomerNavActive('cart');
    showView(views.cart);
    renderCart();
  }
  function showProfile(){
    setCustomerNavActive('profile');
    showView(views.profile);
    document.getElementById('customerStatus').textContent = customer.loggedIn ? `Angemeldet als ${customer.name || 'Kunde'}` : 'Nicht angemeldet (Demo).';
  }

  // --- Provider views ---
  function showProviderHome(){
    setProviderNavActive('provider-home');
    showView(views.providerHome);
    renderProviderHome();
  }
  function showProviderPickups(){
    setProviderNavActive('provider-pickups');
    showView(views.providerPickups);
    renderProviderPickups();
  }
  function showProviderWeek(){
    setProviderNavActive('provider-home');
    showView(views.providerWeek);
    renderWeekPlan();
  }
  function showProviderCookbook(){
    setProviderNavActive('provider-cookbook');
    showView(views.providerCookbook);
    renderCookbook();
  }
  function showProviderProfile(){
    setProviderNavActive('provider-profile');
    showView(views.providerProfile);
    renderProviderProfile();
  }

  // --- Chips render ---
  function renderChips(){
    const catEl = document.getElementById('catChips');
    catEl.innerHTML='';
    CATEGORIES.forEach(c=>{
      const b=document.createElement('button');
      b.className='chip'+(activeCat===c?' active':'');
      b.textContent=c;
      b.onclick=()=>{
        activeCat = activeCat===c ? null : c;
        renderChips();
        renderDiscover();
      };
      catEl.appendChild(b);
    });

    const dayEl = document.getElementById('dayChips');
    dayEl.innerHTML='';
    for(let i=0;i<5;i++){
      const d=new Date(); d.setDate(d.getDate()+i);
      const key=isoDate(d);
      const b=document.createElement('button');
      b.className='day'+(activeDay===key?' active':'');
      b.textContent = i===0 ? 'Heute' : (i===1 ? 'Morgen' : fmtDay(d));
      b.onclick=()=>{ activeDay=key; renderChips(); renderDiscover(); };
      dayEl.appendChild(b);
    }
  }

  // --- Discover render ---
  function renderDiscover(){
    const grid=document.getElementById('offerGrid');
    const empty=document.getElementById('emptyOffers');
    const loc=document.getElementById('locationInput');
    if(loc){
      if(loc.value !== locationQuery) loc.value = locationQuery || '';
      loc.oninput=()=>{ locationQuery = loc.value; renderDiscover(); };
    }

    let list = offers.filter(o => o.day === activeDay && o.active !== false);

    if(activeCat){
      const cat = CAT_MAP[activeCat] || activeCat;
      list = list.filter(o => (o.category||'') === cat);
    }

    const q = String(locationQuery||'').trim().toLowerCase();
    if(q){
      list = list.filter(o=>{
        const data = normalizeOffer(o);
        const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity});
        return String(addr||'').toLowerCase().includes(q);
      });
    }

    grid.innerHTML='';
    empty.textContent = q ? 'Keine Angebote f√ºr diesen Standort.' : 'Noch keine Angebote. Demo: Als Anbieter ein Inserat erstellen.';
    empty.style.display = list.length ? 'none' : 'block';

    list.forEach(o=> grid.appendChild(offerCard(o)));
  }

  function offerCard(o, opts={}){
    const data = normalizeOffer(o);
    const interactive = opts.interactive !== false;
    const card=document.createElement('div');
    card.className='card';
    if(interactive){
      card.onclick=()=>openOffer(data.id);
    } else {
      card.style.cursor='default';
    }

    const img=document.createElement('div');
    img.className='img';
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    img.innerHTML = `
      <img alt="${esc(data.dish||'')}" src="${esc(imgSrc)}" />
      ${data.dineInPossible?'<div class="badge dine">Vor Ort</div>':''}
      ${data.hasPickupCode?'<div class="badge code">Abholcode</div>':''}
    `;

    const providerKey = data.providerId || data.id;
    const dishKey = data.id;
    const heart=document.createElement('button');
    heart.className='heart'+(dishFavs.has(dishKey)?' on':'');
    heart.type='button';
    heart.textContent = dishFavs.has(dishKey)?'‚ù§':'‚ô°';
    heart.onclick=(e)=>{ e.stopPropagation(); toggleDishFav(dishKey); };

    const plogo = data.providerLogoData ? `<img src="${data.providerLogoData}" alt="Logo" />` : `<img src="assets/provider-placeholder.png" alt="Logo" />`;

    const providerRow=document.createElement('div');
    providerRow.className='provider-logo';
    providerRow.innerHTML = `
      <div class="plogo">${plogo}</div>
      <div class="pname">${esc(data.providerName||'Anbieter')}</div>
    `;

    const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity});
    const body=document.createElement('div');
    body.className='body';
    body.innerHTML = `
      <p class="title">${esc(data.dish||'')}</p>
      <p class="sub">${esc(addr || '')}</p>
      <div class="meta">
        <div class="price">${euro(data.price)}</div>
        <div class="right">
          <div>‚è±Ô∏è ${esc(data.pickupWindow||'')}</div>
          <div class="tag">${esc(data.category||'')}</div>
        </div>
      </div>
    `;

    if(interactive){
      const actions=document.createElement('div');
      actions.className='card-actions';

      const orderBtn=document.createElement('button');
      orderBtn.type='button';
      orderBtn.className='card-action primary';
      orderBtn.textContent='Bestellen';
      orderBtn.disabled = !data.hasPickupCode;
      orderBtn.onclick=(e)=>{ e.stopPropagation(); handleOrderClick(data); };

      const favBtn=document.createElement('button');
      favBtn.type='button';
      favBtn.className='card-action';
      favBtn.textContent = providerFavs.has(providerKey) ? 'Anbieter gespeichert' : 'Anbieter speichern';
      favBtn.onclick=(e)=>{ e.stopPropagation(); toggleProviderFav(providerKey); };

      const shareBtn=document.createElement('button');
      shareBtn.type='button';
      shareBtn.className='card-action ghost';
      shareBtn.textContent='Teilen';
      shareBtn.onclick=(e)=>{ e.stopPropagation(); shareOffer(data); };

      actions.appendChild(orderBtn);
      actions.appendChild(favBtn);
      actions.appendChild(shareBtn);
      body.appendChild(actions);
    }

    card.appendChild(img);
    if(interactive){ card.appendChild(heart); }
    card.appendChild(providerRow);
    card.appendChild(body);
    return card;
  }

  function providerCard(o, opts={}){
    const data = normalizeOffer(o);
    const interactive = opts.interactive !== false;
    const card=document.createElement('div');
    card.className='card';
    card.style.cursor = interactive ? 'pointer' : 'default';
    if(interactive){
      card.onclick=()=>openProviderOffer(data.id);
    }

    const profile = normalizeProviderProfile(provider.profile || {});
    const imgSrc = data.imageUrl || data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    const windowText = data.pickupWindow || profile.mealWindow || '';

    const img=document.createElement('div');
    img.className='img';
    img.innerHTML = `
      <img alt="${esc(data.dish||'Gericht')}" src="${esc(imgSrc)}" />
      ${data.active===false?'<div class="badge inactive">Inaktiv</div>':''}
      ${data.hasPickupCode?'<div class="badge code">Abholcode</div>':''}
    `;

    const body=document.createElement('div');
    body.className='body';
    body.innerHTML = `
      <p class="title">${esc(data.dish||'Gericht')}</p>
      <p class="sub">Essenszeit: ${esc(windowText || '‚Äî')}</p>
      <div class="meta">
        <div class="price">${euro(data.price)}</div>
        <div class="right">
          <div>${esc(data.category||'')}</div>
        </div>
      </div>
    `;

    card.appendChild(img);
    card.appendChild(body);
    return card;
  }

  function toggleProviderFav(providerId){
    if(!providerId) return;
    if(providerFavs.has(providerId)) providerFavs.delete(providerId); else providerFavs.add(providerId);
    const arr = Array.from(providerFavs);
    save(LS.providerFavs, arr);
    // keep legacy key for compatibility
    save(LS.favs, arr);
    renderDiscover();
    renderFavorites();
    updateSheetFavs();
  }

  function toggleDishFav(offerId){
    if(!offerId) return;
    if(dishFavs.has(offerId)) dishFavs.delete(offerId); else dishFavs.add(offerId);
    save(LS.dishFavs, Array.from(dishFavs));
    renderDiscover();
    renderFavorites();
    updateSheetFavs();
  }

  function renderFavorites(){
    const provGrid=document.getElementById('favProviders');
    const provEmpty=document.getElementById('emptyFavProviders');
    const dishGrid=document.getElementById('favDishes');
    const dishEmpty=document.getElementById('emptyFavDishes');
    if(!provGrid || !dishGrid || !provEmpty || !dishEmpty) return;

    const candidates = offers
      .filter(o => o.active !== false && providerFavs.has(o.providerId))
      .sort((a,b)=>String(b.day||'').localeCompare(String(a.day||'')));
    const bestByProvider = new Map();
    candidates.forEach(o=>{
      if(!bestByProvider.has(o.providerId)) bestByProvider.set(o.providerId, o);
    });
    const providerList = Array.from(bestByProvider.values());

    provGrid.innerHTML='';
    provEmpty.style.display = providerList.length ? 'none' : 'block';
    providerList.forEach(o=>provGrid.appendChild(offerCard(o)));

    const dishList = offers
      .filter(o => o.active !== false && dishFavs.has(o.id))
      .sort((a,b)=>String(b.day||'').localeCompare(String(a.day||'')));
    dishGrid.innerHTML='';
    dishEmpty.style.display = dishList.length ? 'none' : 'block';
    dishList.forEach(o=>dishGrid.appendChild(offerCard(o)));
  }

  function genPickupCode(){
    const letters = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
    const letter = letters[Math.floor(Math.random()*letters.length)];
    const num = Math.floor(Math.random()*9) + 1;
    return `${letter}${num}`;
  }

  function renderOrders(){
    const box = document.getElementById('ordersList');
    const filters = document.getElementById('ordersFilters');
    if(!box) return;
    if(filters){
      filters.innerHTML='';
      [
        {id:'offen', label:'Offen'},
        {id:'abgeholt', label:'Abgeholt'},
        {id:'alle', label:'Alle'}
      ].forEach(f=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(ordersFilter===f.id?' on':'');
        b.textContent=f.label;
        b.onclick=()=>{ ordersFilter=f.id; renderOrders(); };
        filters.appendChild(b);
      });
    }
    if(!orders.length){
      box.textContent = 'Noch keine Bestellungen.';
      return;
    }
    const fmt = (ts)=>{
      const d = new Date(ts);
      if(Number.isNaN(d.getTime())) return '';
      return fmtDay(d);
    };
    const list = orders.filter(o=>{
      if(ordersFilter==='alle') return true;
      return (o.status || 'offen') === ordersFilter;
    });
    list.sort((a,b)=>{
      if(ordersFilter === 'alle'){
        const sa = a.status || 'offen';
        const sb = b.status || 'offen';
        if(sa !== sb) return sa === 'offen' ? -1 : 1;
      }
      return (b.createdAt||0) - (a.createdAt||0);
    });
    if(!list.length){
      box.textContent = 'Keine passenden Bestellungen.';
      return;
    }
    box.innerHTML = list.map(o=>`
      <div class="order-item ${o.status==='abgeholt' ? 'done' : ''}">
        <div class="order-top">
          <div>
            <div style="font-weight:900">${esc(o.providerName || 'Anbieter')}</div>
            <div class="hint">${esc(o.summary || '')}</div>
          </div>
          <div class="order-right">
            <button class="order-code" type="button" data-id="${esc(o.id||'')}" data-code="${esc(o.code||'')}">${esc(o.code||'')}</button>
            <div class="status-pill ${o.status==='abgeholt' ? 'done' : 'open'}">${esc(o.status||'offen')}</div>
          </div>
        </div>
        <div class="hint" style="margin-top:6px;">
          Status: ${esc(o.status||'offen')}${o.pickupTime ? ` - Abholzeit: ${esc(o.pickupTime)}` : ''} - ${fmt(o.createdAt)}
        </div>
      </div>
    `).join('');

    box.querySelectorAll('.order-code').forEach(btn=>{
      btn.onclick=()=> openCodeSheet(btn.getAttribute('data-id') || '');
    });
  }

  function openCodeSheet(orderId){
    const order = orders.find(o=>o.id===orderId);
    if(!order) return;
    activeOrderId = orderId;
    document.getElementById('codeText').textContent = order.code || '';
    document.getElementById('codeStatus').textContent = order.status === 'abgeholt' ? 'Status: abgeholt' : 'Status: offen';
    document.getElementById('btnToggleOrderStatus').textContent = order.status === 'abgeholt' ? 'Als offen markieren' : 'Als abgeholt markieren';
    document.getElementById('codeProvider').textContent = order.providerName || 'Anbieter';
    document.getElementById('codeSummary').textContent = order.summary || '';
    document.getElementById('codePickupWindow').textContent = order.pickupWindow ? `Essenszeit: ${order.pickupWindow}` : '';
    document.getElementById('codePickupTime').textContent = order.pickupTime ? `Abholzeit: ${order.pickupTime}` : 'Abholzeit: offen';
    document.getElementById('codeBd').classList.add('active');
    document.getElementById('codeSheet').classList.add('active');
  }
  function closeCodeSheet(){
    document.getElementById('codeBd').classList.remove('active');
    document.getElementById('codeSheet').classList.remove('active');
    activeOrderId = null;
  }

  // --- Offer sheet ---
  let activeOfferId=null;
  let activeProviderOfferId=null;
  function openOffer(id){
    const raw = offers.find(x=>x.id===id);
    if(!raw) return;
    const o = normalizeOffer(raw);
    activeOfferId=id;

    document.getElementById('sImg').src = o.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    document.getElementById('sDish').textContent = o.dish || '';
    document.getElementById('sProvider').textContent = o.providerName || '';
    document.getElementById('sPrice').textContent = euro(o.price);
    document.getElementById('sCat').textContent = o.category || '';
    document.getElementById('sWindow').textContent = o.pickupWindow || '';

    const addr = buildAddress({address:o.address, street:o.providerStreet, zip:o.providerZip, city:o.providerCity});
    const maps = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
    const a = document.getElementById('sAddr');
    a.textContent = addr || '-';
    a.href = maps;

    // Allergens
    const aw = document.getElementById('sAllergensWrap');
    if(o.allergens && o.allergens.length){
      aw.style.display='block';
      document.getElementById('sAllergens').textContent = o.allergens.join(', ');
    } else aw.style.display='none';

    // Extras
    const ew = document.getElementById('sExtrasWrap');
    if(o.extras && o.extras.length){
      ew.style.display='block';
      document.getElementById('sExtras').textContent = o.extras.map(e=>`${e.name} (+${euro(e.price)})`).join(' ¬∑ ');
    } else ew.style.display='none';

    // Reuse
    const rw = document.getElementById('sReuseWrap');
    if(o.reuse && o.reuse.enabled){
      rw.style.display='block';
      document.getElementById('sReuse').textContent = `Pfand ${euro(o.reuse.deposit)}`;
    } else rw.style.display='none';

    const addBtn = document.getElementById('btnAddCart');
    if(o.hasPickupCode){
      addBtn.disabled = false;
      addBtn.textContent = 'In den Warenkorb';
    } else {
      addBtn.disabled = true;
      addBtn.textContent = 'Nur ansehen';
    }

    document.getElementById('sCodeNote').innerHTML = o.hasPickupCode
      ? 'Abholcode aktiv: <b>vorab bezahlt</b>.'
      : 'Ohne Abholcode nur ansehen.';

    updateSheetFavs();

    document.getElementById('bd').classList.add('active');
    document.getElementById('sheet').classList.add('active');
  }

  function updateSheetFavs(){
    const providerBtn = document.getElementById('btnFav');
    const dishBtn = document.getElementById('btnDishFav');
    if(!activeOfferId){
      if(providerBtn) providerBtn.textContent='Anbieter speichern';
      if(dishBtn) dishBtn.textContent='Gericht speichern';
      return;
    }
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    const providerKey = o.providerId;
    const dishKey = o.id;
    if(providerBtn){
      providerBtn.textContent = providerKey && providerFavs.has(providerKey) ? 'Anbieter entfernen' : 'Anbieter speichern';
    }
    if(dishBtn){
      dishBtn.textContent = dishKey && dishFavs.has(dishKey) ? 'Gericht entfernen' : 'Gericht speichern';
    }
  }

  function closeSheet(){
    document.getElementById('bd').classList.remove('active');
    document.getElementById('sheet').classList.remove('active');
  }

  function openProviderOffer(id){
    const raw = offers.find(x=>x.id===id);
    if(!raw) return;
    const o = normalizeOffer(raw);
    activeProviderOfferId = id;

    const preview = document.getElementById('pPreview');
    preview.innerHTML = '';
    preview.appendChild(offerCard(o, {interactive:false}));

    document.getElementById('pStatus').textContent = o.active===false ? 'Inaktiv' : 'Aktiv';
    document.getElementById('pWindow').textContent = o.pickupWindow || '-';
    document.getElementById('btnToggleOffer').textContent = o.active===false ? 'Aktivieren' : 'Deaktivieren';

    document.getElementById('pbd').classList.add('active');
    document.getElementById('psheet').classList.add('active');
  }

  function closeProviderSheet(){
    document.getElementById('pbd').classList.remove('active');
    document.getElementById('psheet').classList.remove('active');
  }

  function buildShareText(o){
    const dish = o.dish || o.title || 'Gericht';
    return `Heute bei uns zu Mittag:\n${dish} - ${euro(o.price)}\npowered by mittagio.de`;
  }

  function openShareSheet(text, url=location.href){
    sharePayload = { text, url };
    const preview = document.getElementById('sharePreview');
    if(preview) preview.textContent = text;
    document.getElementById('shareBd').classList.add('active');
    document.getElementById('shareSheet').classList.add('active');
  }

  function closeShareSheet(){
    document.getElementById('shareBd').classList.remove('active');
    document.getElementById('shareSheet').classList.remove('active');
  }

  async function copyShareText(){
    const txt = `${sharePayload.text}\n${sharePayload.url}`.trim();
    if(navigator.clipboard && navigator.clipboard.writeText){
      try{ await navigator.clipboard.writeText(txt); return true; }catch{}
    }
    prompt('Kopieren und teilen:', txt);
    return false;
  }

  function shareOffer(o){
    if(!o) return;
    const txt = buildShareText(o);
    openShareSheet(txt);
  }

  function addToCart(o){
    if(!o || !o.hasPickupCode){
      alert('Ohne Abholcode nur ansehen.');
      return false;
    }
    if(cart && cart.providerId !== o.providerId){
      alert('MVP: Warenkorb nur f√ºr einen Anbieter. Bitte zuerst Warenkorb leeren.');
      return false;
    }
    if(!cart){ cart = { providerId:o.providerId, providerName:o.providerName, items:[], pickupTime:'' }; }
    const idx = cart.items.findIndex(i=>i.offerId===o.id);
    if(idx>=0) cart.items[idx].qty += 1; else cart.items.push({offerId:o.id, qty:1});
    save(LS.cart, cart);
    return true;
  }

  function handleOrderClick(o){
    if(addToCart(o)){
      showCart();
    } else {
      openOffer(o.id);
    }
  }

  document.getElementById('btnFav').onclick=()=>{
    if(!activeOfferId) return;
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    toggleProviderFav(o.providerId);
  };
  document.getElementById('btnDishFav').onclick=()=>{
    if(!activeOfferId) return;
    toggleDishFav(activeOfferId);
  };
  document.getElementById('btnShare').onclick=()=>{
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    shareOffer(o);
  };
  document.getElementById('btnCodeClose').onclick=()=> closeCodeSheet();
  document.getElementById('btnToggleOrderStatus').onclick=()=>{
    if(!activeOrderId) return;
    const idx = orders.findIndex(o=>o.id===activeOrderId);
    if(idx<0) return;
    orders[idx].status = orders[idx].status === 'abgeholt' ? 'offen' : 'abgeholt';
    save(LS.orders, orders);
    renderOrders();
    openCodeSheet(activeOrderId);
  };
  document.getElementById('btnShareClose').onclick=()=> closeShareSheet();
  document.getElementById('btnShareWhatsApp').onclick=()=>{
    const txt = `${sharePayload.text}\n${sharePayload.url}`.trim();
    window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`,'_blank');
  };
  document.getElementById('btnShareInstagram').onclick=async()=>{
    await copyShareText();
    window.open('https://www.instagram.com/','_blank');
  };
  document.getElementById('btnShareWebsite').onclick=async()=>{
    await copyShareText();
    window.open(sharePayload.url || location.href,'_blank');
  };
  document.getElementById('btnShareCopy').onclick=async()=>{
    const ok = await copyShareText();
    if(ok) alert('Link kopiert.');
  };

  document.getElementById('btnAddCart').onclick=()=>{
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    if(!addToCart(o)) return;
    closeSheet();
    showCart();
  };

  // --- Cart ---
  function renderCart(){
    const box=document.getElementById('cartBox');
    const btn=document.getElementById('btnCheckout');
    const note=document.getElementById('cartNote');

    if(!cart || !cart.items.length){
      box.textContent='Dein Warenkorb ist leer.';
      btn.style.display='none';
      note.style.display='none';
      return;
    }

    let total=0;
    let canCheckout = true;
    const firstOffer = cart.items.length ? offers.find(x=>x.id===cart.items[0].offerId) : null;
    const windowText = firstOffer && firstOffer.pickupWindow ? firstOffer.pickupWindow : '';
    const lines = cart.items.map(it=>{
      const o = offers.find(x=>x.id===it.offerId);
      if(!o) return '';
      if(!o.hasPickupCode) canCheckout = false;
      const lineTotal = Number(o.price||0) * it.qty;
      total += lineTotal;
      return `
        <div class="cart-line">
          <div class="cart-left">${esc(o.dish)}</div>
          <div class="cart-qty">
            <button class="qty-btn" type="button" data-action="dec" data-id="${esc(o.id)}">-</button>
            <div>${it.qty}</div>
            <button class="qty-btn" type="button" data-action="inc" data-id="${esc(o.id)}">+</button>
          </div>
          <div class="cart-price">${euro(lineTotal)}</div>
        </div>
      `;
    }).filter(Boolean);

    box.innerHTML = `
      <b>${esc(cart.providerName || 'Anbieter')}</b>
      ${lines.join('')}
      ${windowText ? `<div class="hint">Essenszeit: ${esc(windowText)}</div>` : ''}
      <div class="row"><span>Wann m√∂chtest du ungef√§hr da sein?</span></div>
      <input class="field" id="pickupTimeInput" type="text" placeholder="z.B. 12:15" value="${esc(cart.pickupTime||'')}" />
      <div class="hint">Bitte innerhalb der Essenszeit.</div>
      <div class="row"><span>Gesamt</span><b>${euro(total)}</b></div>
      <a href="#" id="clearCart">Warenkorb leeren</a>
    `;

    document.getElementById('clearCart').onclick=(e)=>{ e.preventDefault(); cart=null; save(LS.cart, cart); renderCart(); };
    const timeInput = document.getElementById('pickupTimeInput');
    if(timeInput){
      timeInput.oninput=()=>{
        cart.pickupTime = timeInput.value;
        save(LS.cart, cart);
      };
    }

    box.querySelectorAll('.qty-btn').forEach(btnEl=>{
      btnEl.onclick=()=>{
        const id = btnEl.getAttribute('data-id');
        const action = btnEl.getAttribute('data-action');
        const idx = cart.items.findIndex(i=>i.offerId===id);
        if(idx<0) return;
        if(action==='inc') cart.items[idx].qty += 1;
        if(action==='dec') cart.items[idx].qty -= 1;
        if(cart.items[idx].qty <= 0) cart.items.splice(idx,1);
        save(LS.cart, cart);
        renderCart();
      };
    });

    btn.style.display='block';
    btn.disabled = !canCheckout;
    btn.textContent = canCheckout ? 'Weiter zur Zahlung' : 'Nur ansehen';
    note.style.display='block';
  }

  document.getElementById('btnCheckout').onclick=()=>{
    if(!customer.loggedIn){
      alert('F√ºr die Demo: Bitte zuerst als Kunde anmelden (Profil).');
      showProfile();
      return;
    }
    if(!cart || !cart.items || !cart.items.length) return;
    const pickupTime = String(cart.pickupTime||'').trim();
    if(!pickupTime){
      alert('Bitte eine ungef√§hre Abholzeit angeben.');
      showCart();
      setTimeout(()=>{
        const input = document.getElementById('pickupTimeInput');
        if(input) input.focus();
      }, 50);
      return;
    }
    const code = genPickupCode();
    const firstOffer = cart.items.length ? offers.find(x=>x.id===cart.items[0].offerId) : null;
    const pickupWindow = firstOffer && firstOffer.pickupWindow ? firstOffer.pickupWindow : '';
    const summary = cart.items.map(it=>{
      const o = offers.find(x=>x.id===it.offerId);
      if(!o) return '';
      return `${o.dish} x ${it.qty}`;
    }).filter(Boolean).join(', ');
    const newOrder = {
      id: cryptoId(),
      providerName: cart.providerName || 'Anbieter',
      summary,
      code,
      status:'offen',
      pickupTime: cart.pickupTime || '',
      pickupWindow,
      createdAt: Date.now()
    };
    orders.unshift(newOrder);
    save(LS.orders, orders);
    cart = null;
    save(LS.cart, cart);
    renderCart();
    renderOrders();
    showOrders();
    openCodeSheet(newOrder.id);
  };

  // --- Customer login (demo) ---
  document.getElementById('btnCustomerLogin').onclick=()=>{
    customer.loggedIn = true;
    customer.name = customer.name || 'Mike';
    save(LS.customer, customer);
    showProfile();
  };

  // --- Provider entry ---
  document.getElementById('btnProviderEntry').onclick=()=>{
    // switch mode; show provider login page
    setMode('provider');
  };
  document.getElementById('btnProvBack').onclick=()=>{ setMode('customer'); showProfile(); };

  document.getElementById('btnProvLogin').onclick=()=>{
    const email = document.getElementById('provEmail').value.trim();
    const pass = document.getElementById('provPass').value.trim();
    if(!email || !pass){ alert('Bitte E-Mail und Passwort eingeben.'); return; }
    provider.loggedIn = true;
    provider.email = email;
    save(LS.provider, provider);
    showProviderHome();
  };

  document.getElementById('btnProvLogout').onclick=()=>{
    provider.loggedIn=false;
    save(LS.provider, provider);
    setMode('customer');
    showProfile();
  };

  // Provider nav handlers
  document.getElementById('providerNav').addEventListener('click',(e)=>{
    const b = e.target.closest('button');
    if(!b) return;
    const go = b.dataset.pgo;
    if(go==='provider-home') showProviderHome();
    if(go==='provider-pickups') showProviderPickups();
    if(go==='provider-cookbook') showProviderCookbook();
    if(go==='provider-profile') showProviderProfile();
  });

  // Customer nav handlers
  document.getElementById('customerNav').addEventListener('click',(e)=>{
    const b = e.target.closest('button');
    if(!b) return;
    const go = b.dataset.go;
    if(go==='discover') showDiscover();
    if(go==='fav') showFav();
    if(go==='orders') showOrders();
    if(go==='cart') showCart();
    if(go==='profile') showProfile();
  });

  // --- Provider home renders ---
  function renderProviderHome(){
    const profile = normalizeProviderProfile(provider.profile || {});
    document.getElementById('provHomeHello').textContent = `Eingeloggt als ${profile.name || provider.email}`;

    const todayKey = isoDate(new Date());
    const mineAll = offers.filter(o => o.providerId === providerId());
    const mineActive = mineAll.filter(o => o.active !== false && o.day >= todayKey);
    const mineInactive = mineAll.filter(o => o.active === false);
    const mineToday = mineActive.filter(o => o.day === todayKey);

    const grid = document.getElementById('provActiveGrid');
    const empty = document.getElementById('provActiveEmpty');
    grid.innerHTML = '';
    if(!mineActive.length){
      empty.style.display='block';
    } else {
      empty.style.display='none';
      mineActive.slice(0,6).forEach(o=> grid.appendChild(providerCard(o)));
    }

    const inactivePanel = document.getElementById('provInactivePanel');
    const inactiveGrid = document.getElementById('provInactiveGrid');
    const inactiveEmpty = document.getElementById('provInactiveEmpty');
    if(inactivePanel && inactiveGrid && inactiveEmpty){
      inactiveGrid.innerHTML = '';
      if(!mineInactive.length){
        inactivePanel.style.display = 'none';
      } else {
        inactivePanel.style.display = 'block';
        mineInactive.slice(0,6).forEach(o=> inactiveGrid.appendChild(providerCard(o)));
        inactiveEmpty.style.display = mineInactive.length ? 'none' : 'block';
      }
    }

    renderProviderWeekPreview();

    const stats = document.getElementById('provPickupStats');
    const withCodeToday = mineToday.filter(o=>o.hasPickupCode).length;
    stats.textContent = withCodeToday ? `Abholcode heute: ${withCodeToday} Inserate.` : 'Noch keine Abholcodes f√ºr heute.';

    const shareBtn = document.getElementById('btnShareToday');
    shareBtn.style.display = mineToday.length ? 'block' : 'none';
  }

  function renderProviderWeekPreview(){
    const dayWrap = document.getElementById('provWeekDays');
    const list = document.getElementById('provWeekPreview');
    if(!dayWrap || !list) return;

    dayWrap.innerHTML = '';
    for(let i=0;i<5;i++){
      const d = new Date(); d.setDate(d.getDate()+i);
      const key = isoDate(d);
      const b = document.createElement('button');
      b.className = 'day' + (providerWeekDay===key ? ' active' : '');
      b.textContent = i===0 ? 'Heute' : (i===1 ? 'Morgen' : fmtDay(d));
      b.onclick=()=>{ providerWeekDay = key; renderProviderWeekPreview(); };
      dayWrap.appendChild(b);
    }

    const items = (week[providerWeekDay]||[]).filter(x=>x.providerId===providerId() && x.active !== false);
    if(!items.length){
      list.textContent = 'Noch nichts geplant.';
      return;
    }
    list.innerHTML = items.map(i=>`‚Ä¢ ${esc(i.dish)}`).join('<br>');
  }

  function renderWeekPlan(){
    const dayWrap = document.getElementById('weekDays');
    const list = document.getElementById('weekList');
    if(!dayWrap || !list) return;

    dayWrap.innerHTML = '';
    for(let i=0;i<5;i++){
      const d = new Date(); d.setDate(d.getDate()+i);
      const key = isoDate(d);
      const b = document.createElement('button');
      b.className = 'day' + (weekPlanDay===key ? ' active' : '');
      b.textContent = i===0 ? 'Heute' : (i===1 ? 'Morgen' : fmtDay(d));
      b.onclick=()=>{ weekPlanDay = key; renderWeekPlan(); };
      dayWrap.appendChild(b);
    }

    const dayEntries = week[weekPlanDay] || [];
    const providerEntries = dayEntries
      .map((entry, idx)=>({entry, idx}))
      .filter(x=>x.entry.providerId===providerId());

    if(!providerEntries.length){
      list.textContent = 'Noch nichts geplant.';
      return;
    }

    list.innerHTML = '';
    providerEntries.forEach(({entry, idx})=>{
      const cb = cookbook.find(c=>c.id===entry.cookbookId);
      const name = cb?.dish || entry.dish || 'Gericht';
      const price = cb?.price || 0;
      const isActive = entry.active !== false;

      const item = document.createElement('div');
      item.className = 'cookbook-item';
      item.innerHTML = `
        <div style="font-weight:900">${esc(name)}</div>
        <div class="hint">${euro(price)} - ${isActive ? 'Aktiv' : 'Inaktiv'}</div>
      `;

      const actions = document.createElement('div');
      actions.className = 'cookbook-actions';

      const edit = document.createElement('button');
      edit.type='button';
      edit.className='ans';
      edit.textContent='Bearbeiten';
      edit.onclick=()=>{ if(entry.cookbookId) startWizard('cookbook', {editId: entry.cookbookId}); };

      const toggle = document.createElement('button');
      toggle.type='button';
      toggle.className='ans';
      toggle.textContent = isActive ? 'Deaktivieren' : 'Aktivieren';
      toggle.onclick=()=>{
        const updated = (week[weekPlanDay]||[]).map((x,i)=> i===idx ? {...x, active: !(x.active !== false)} : x);
        if(updated.length) week[weekPlanDay]=updated; else delete week[weekPlanDay];
        save(LS.week, week);
        renderWeekPlan();
        renderProviderWeekPreview();
      };

      const share = document.createElement('button');
      share.type='button';
      share.className='ans';
      share.textContent='Teilen';
      share.onclick=()=>{ shareOffer({dish:name, price}); };

      const print = document.createElement('button');
      print.type='button';
      print.className='ans';
      print.textContent='Drucken';
      print.onclick=()=>{ window.print(); };

      actions.appendChild(edit);
      actions.appendChild(toggle);
      actions.appendChild(share);
      actions.appendChild(print);
      item.appendChild(actions);
      list.appendChild(item);
    });
  }

  function pickupCodeCount(dish){
    const base = String(dish||'').split('').reduce((sum, ch)=>sum + ch.charCodeAt(0), 0);
    return 2 + (base % 4); // 2..5
  }

  function buildPickupGroups(){
    const todayKey = isoDate(new Date());
    const mineToday = offers.filter(o => o.providerId === providerId() && o.hasPickupCode && o.day === todayKey && o.active !== false);
    if(!mineToday.length) return [];

    const map = new Map();
    mineToday.forEach(o=>{
      const dish = o.dish || 'Gericht';
      if(!map.has(dish)){
        map.set(dish, {dish, time: o.pickupWindow || '', offerId: o.id});
      }
    });

    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const groups = Array.from(map.values()).map((g, idx)=>{
      const group = letters[idx % letters.length];
      const count = pickupCodeCount(g.dish);
      const codes = Array.from({length:count}, (_,i)=>`${group}${i+1}`);
      return {id:`${group}:${g.offerId}`, group, dish:g.dish, time:g.time, codes};
    });
    return groups;
  }

  function renderProviderPickups(){
    const empty = document.getElementById('provPickupsEmpty');
    const wrap = document.getElementById('provPickupsWrap');
    const sortEl = document.getElementById('provPickupSort');
    const groupsEl = document.getElementById('provPickupGroups');
    if(!empty || !wrap || !sortEl || !groupsEl) return;

    const groups = buildPickupGroups();
    if(!groups.length){
      empty.style.display='block';
      wrap.style.display='none';
      return;
    }
    empty.style.display='none';
    wrap.style.display='block';

    sortEl.innerHTML='';
    [
      {id:'time', label:'Zeit'},
      {id:'code', label:'Code'},
      {id:'group', label:'Gruppe'}
    ].forEach(s=>{
      const b=document.createElement('button');
      b.type='button';
      b.className='ans'+(pickupSort===s.id?' on':'');
      b.textContent=s.label;
      b.onclick=()=>{ pickupSort=s.id; renderProviderPickups(); };
      sortEl.appendChild(b);
    });

    const list = [...groups];
    const timeKey = (t)=>{
      const raw = String(t||'').split(/[‚Äì-]/)[0].trim();
      const parts = raw.split(':');
      const h = parseInt(parts[0]||'0',10);
      const m = parseInt(parts[1]||'0',10);
      return h*60+m;
    };
    if(pickupSort==='time') list.sort((a,b)=>timeKey(a.time)-timeKey(b.time));
    if(pickupSort==='code') list.sort((a,b)=>(a.codes[0]||'').localeCompare(b.codes[0]||''));
    if(pickupSort==='group') list.sort((a,b)=>a.group.localeCompare(b.group));

    groupsEl.innerHTML='';
    list.forEach(g=>{
      const box=document.createElement('div');
      box.className='pickup-group';
      box.innerHTML = `
        <div class="pickup-head">
          <div>${esc(g.dish)}</div>
          <div class="pickup-sub">Gruppe ${esc(g.group)} - ${esc(g.time || '-')}</div>
        </div>
        <div style="margin-top:6px;">
          ${g.codes.map(c=>{
            const key = `${g.id}:${c}`;
            const done = pickupDone.has(key);
            return `<button type="button" class="code-chip${done ? ' done' : ''}" data-code="${esc(c)}" data-group="${esc(g.id)}">${esc(c)}</button>`;
          }).join('')}
        </div>
      `;
      groupsEl.appendChild(box);
    });

    groupsEl.querySelectorAll('.code-chip').forEach(btn=>{
      btn.onclick=()=>{
        const code = btn.getAttribute('data-code') || '';
        const group = btn.getAttribute('data-group') || '';
        const key = `${group}:${code}`;
        if(pickupDone.has(key)) pickupDone.delete(key); else pickupDone.add(key);
        btn.classList.toggle('done');
      };
    });
  }

  function renderProviderProfile(){
    const p = normalizeProviderProfile(provider.profile || {});
    const addr = buildAddress(p);
    document.getElementById('provProfileHint').innerHTML = `
      <b>${esc(p.name || 'Name fehlt')}</b><br>
      ${esc(addr || 'Adresse fehlt')}<br>
      Essenszeit: <b>${esc(p.mealWindow || DEFAULT_MEAL_WINDOW)}</b><br>
      ${p.logoData ? 'Logo: vorhanden' : 'Logo: fehlt'}
    `;
  }

  document.getElementById('btnProvFaq').onclick=()=>{
    const box = document.getElementById('provFaqBox');
    box.style.display = box.style.display==='none' ? 'block' : 'none';
  };

  document.getElementById('btnBilling').onclick=()=>{
    alert('Abrechnungen (MVP): monatliche Sammelrechnung. Stripe Tax folgt sp√§ter.');
  };

  document.getElementById('rowProfileOverview').onclick=()=>{
    const p = normalizeProviderProfile(provider.profile || {});
    const addr = buildAddress(p) || 'Adresse fehlt';
    alert(`Profil-√úbersicht\n${p.name || 'Name fehlt'}\n${addr}\nEssenszeit: ${p.mealWindow || DEFAULT_MEAL_WINDOW}`);
  };

  document.getElementById('btnProvActions').onclick=()=>{
    alert('Aktionen (Demo): Teilen, Deaktivieren, Gutscheinaktionen.');
  };

  document.getElementById('btnLegalImprint').onclick=()=>{
    alert('Impressum (Demo): Link folgt.');
  };
  document.getElementById('btnLegalPrivacy').onclick=()=>{
    alert('Datenschutz (Demo): Link folgt.');
  };
  document.getElementById('btnLegalTerms').onclick=()=>{
    alert('AGB (Demo): Link folgt.');
  };

  // --- Provider actions ---
  document.getElementById('btnNewListing').onclick=()=> startWizard('listing');
  document.getElementById('btnCookbookAdd').onclick=()=> startWizard('cookbook');
  document.getElementById('btnProvSetup').onclick=()=> startWizard('provider');
  document.getElementById('btnOpenWeekPlan').onclick=()=> showProviderWeek();
  document.getElementById('btnPickupsFaq').onclick=()=>{
    showProviderProfile();
    const box = document.getElementById('provFaqBox');
    if(box) box.style.display = 'block';
  };

  document.getElementById('btnEditOffer').onclick=()=>{
    if(!activeProviderOfferId) return;
    closeProviderSheet();
    startWizard('listing', {editOfferId: activeProviderOfferId});
  };
  document.getElementById('btnToggleOffer').onclick=()=>{
    if(!activeProviderOfferId) return;
    const idx = offers.findIndex(x=>x.id===activeProviderOfferId);
    if(idx<0) return;
    offers[idx].active = offers[idx].active === false ? true : false;
    save(LS.offers, offers);
    closeProviderSheet();
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
  };
  document.getElementById('btnShareOffer').onclick=()=>{
    if(!activeProviderOfferId) return;
    const o = offers.find(x=>x.id===activeProviderOfferId);
    if(!o) return;
    shareOffer(o);
  };
  document.getElementById('btnPrintOffer').onclick=()=>{
    window.print();
  };

  document.getElementById('btnShareToday').onclick=()=>{
    const todayKey = isoDate(new Date());
    const mineToday = offers.filter(o => o.providerId === providerId() && o.day === todayKey && o.active !== false);
    if(!mineToday.length) return;
    const txt = `Heute bei uns zu Mittag:\n` + mineToday.map(o=>`${o.dish} - ${euro(o.price)}`).join('\n') + `\npowered by mittagio.de`;
    openShareSheet(txt);
  };

  document.getElementById('btnWeekBack').onclick=()=> showProviderHome();
  document.getElementById('btnWeekPdf').onclick=()=>{
    alert('PDF-Wochenkarte (Demo): Logo, Gerichte, Preis, Essenszeit, QR-Code. Footer: Powered by Mittagio.');
  };

  // Provider ID (for demo)
  function providerId(){
    // stable per email
    const e = provider.email || 'provider';
    return 'prov_' + btoa(unescape(encodeURIComponent(e))).slice(0,16);
  }

  // --- Cookbook ---
  function renderCookbook(){
    const box = document.getElementById('cookbookList');
    const filterBox = document.getElementById('cookbookFilters');
    const search = document.getElementById('cookbookSearch');
    if(!box) return;

    let updated = false;
    cookbook = cookbook.map(entry=>{
      const out = {...entry};
      if(!out.createdAt){ out.createdAt = Date.now(); updated = true; }
      if(out.lastUsed === undefined){ out.lastUsed = null; updated = true; }
      return out;
    });
    if(updated) save(LS.cookbook, cookbook);

    if(search){
      if(search.value !== cookbookQuery) search.value = cookbookQuery || '';
      search.oninput=()=>{ cookbookQuery = search.value; renderCookbook(); };
    }

    if(filterBox){
      filterBox.innerHTML='';
      [
        {id:'recent', label:'Zuletzt verwendet'},
        {id:'alpha', label:'Alphabetisch'}
      ].forEach(f=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(cookbookSort===f.id?' on':'');
        b.textContent=f.label;
        b.onclick=()=>{ cookbookSort=f.id; renderCookbook(); };
        filterBox.appendChild(b);
      });
    }

    const mine = cookbook.filter(x=>x.providerId===providerId());
    const q = String(cookbookQuery||'').trim().toLowerCase();
    const filtered = mine.filter(x => !q || String(x.dish||'').toLowerCase().includes(q));

    if(!filtered.length){
      box.innerHTML = '<div class="hint">Noch keine Gerichte gespeichert.</div>';
      return;
    }

    const sortRecent = (a,b)=>(b.lastUsed||b.createdAt) - (a.lastUsed||a.createdAt);
    const sortAlpha = (a,b)=>String(a.dish||'').localeCompare(String(b.dish||''));
    const sortFn = cookbookSort==='alpha' ? sortAlpha : sortRecent;

    const used = filtered.filter(x=>x.lastUsed);
    const drafts = filtered.filter(x=>!x.lastUsed);
    used.sort(sortFn);
    drafts.sort(sortFn);

    const wrap = document.createElement('div');

    const formatDayLabel = (iso)=>{
      if(!iso) return '‚Äî';
      const d = new Date(iso);
      if(Number.isNaN(d.getTime())) return iso;
      const today = isoDate(new Date());
      const tomorrow = isoDate(new Date(Date.now()+86400000));
      if(iso===today) return 'Heute';
      if(iso===tomorrow) return 'Morgen';
      return fmtDay(d);
    };

    const buildItem = (entry)=>{
      const item=document.createElement('div');
      item.className='cookbook-item';

      const lastOnline = offers
        .filter(o=>o.providerId===providerId() && o.dish===entry.dish)
        .map(o=>o.day)
        .sort()
        .slice(-1)[0];
      const sales = offers.filter(o=>o.providerId===providerId() && o.dish===entry.dish).length * 3;

      item.innerHTML = `
        <div style="font-weight:900">${esc(entry.dish||'Gericht')}</div>
        <div class="hint">${esc(entry.category||'Vegetarisch')} ¬∑ ${euro(entry.price||0)}</div>
        <div class="cookbook-facts">
          Zuletzt online: <b>${esc(formatDayLabel(lastOnline))}</b><br>
          Verk√§ufe √ºber Mittagio: <b>${sales}</b>
        </div>
      `;

      const actions=document.createElement('div');
      actions.className='cookbook-actions';

      const pub=document.createElement('button');
      pub.type='button';
      pub.className='ans';
      pub.textContent='Ver√∂ffentlichen';
      pub.onclick=()=>{ publishCookbookEntry(entry.id); };

      const edit=document.createElement('button');
      edit.type='button';
      edit.className='ans';
      edit.textContent='Bearbeiten';
      edit.onclick=()=>{ startWizard('cookbook', {editId: entry.id}); };

      actions.appendChild(pub);
      actions.appendChild(edit);
      item.appendChild(actions);
      return item;
    };

    const usedTitle=document.createElement('div');
    usedTitle.className='section-title';
    usedTitle.textContent='Zuletzt verwendet';
    wrap.appendChild(usedTitle);
    if(!used.length){
      const h=document.createElement('div'); h.className='hint'; h.textContent='Noch keine verwendeten Gerichte.';
      wrap.appendChild(h);
    } else {
      used.forEach(x=>wrap.appendChild(buildItem(x)));
    }

    const draftTitle=document.createElement('div');
    draftTitle.className='section-title';
    draftTitle.textContent='Entw√ºrfe';
    wrap.appendChild(draftTitle);
    if(!drafts.length){
      const h=document.createElement('div'); h.className='hint'; h.textContent='Keine Entw√ºrfe vorhanden.';
      wrap.appendChild(h);
    } else {
      drafts.forEach(x=>wrap.appendChild(buildItem(x)));
    }

    box.innerHTML='';
    box.appendChild(wrap);
  }

  function publishCookbookEntry(entryId){
    const entry = cookbook.find(c=>c.id===entryId && c.providerId===providerId());
    if(!entry) return;

    const profile = normalizeProviderProfile(provider.profile || {});
    const offer = normalizeOffer({
      id: cryptoId(),
      providerId: providerId(),
      providerName: profile.name || provider.email || 'Anbieter',
      providerStreet: profile.street||'',
      providerZip: profile.zip||'',
      providerCity: profile.city||'',
      providerLogoData: profile.logoData||'',
      dish: entry.dish||'',
      category: entry.category||'Vegetarisch',
      price: Number(entry.price||0),
      pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
      hasPickupCode: !!entry.hasPickupCode,
      dineInPossible: !!entry.dineInPossible,
      allergens: entry.allergens||[],
      extras: entry.extras||[],
      reuse: entry.reuse||{enabled:false,deposit:0},
      imageUrl: entry.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
      day: isoDate(new Date())
    });

    if(!offer.providerStreet){
      alert('Bitte zuerst Anbieterprofil ausf√ºllen (Adresse).');
      return;
    }

    offers.unshift(offer);
    save(LS.offers, offers);

    const idx = cookbook.findIndex(c=>c.id===entryId);
    if(idx>=0){ cookbook[idx].lastUsed = Date.now(); }
    save(LS.cookbook, cookbook);

    renderCookbook();
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
    alert('Inserat ver√∂ffentlicht.');
  }

  function publishWeekEntry(dayKey, entry){
    const cb = cookbook.find(c=>c.id===entry.cookbookId);
    if(!cb){
      alert('Gericht nicht gefunden.');
      return;
    }

    const profile = normalizeProviderProfile(provider.profile || {});
    const offer = normalizeOffer({
      id: cryptoId(),
      providerId: providerId(),
      providerName: profile.name || provider.email || 'Anbieter',
      providerStreet: profile.street||'',
      providerZip: profile.zip||'',
      providerCity: profile.city||'',
      providerLogoData: profile.logoData||'',
      dish: cb.dish||entry.dish||'',
      category: cb.category||'Vegetarisch',
      price: Number(cb.price||0),
      pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
      hasPickupCode: !!cb.hasPickupCode,
      dineInPossible: !!cb.dineInPossible,
      allergens: cb.allergens||[],
      extras: cb.extras||[],
      reuse: cb.reuse||{enabled:false,deposit:0},
      imageUrl: cb.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
      day: dayKey
    });

    if(!offer.providerStreet){
      alert('Bitte zuerst Anbieterprofil ausf√ºllen (Adresse).');
      return;
    }

    offers.unshift(offer);
    save(LS.offers, offers);

    const idx = cookbook.findIndex(c=>c.id===entry.cookbookId);
    if(idx>=0){ cookbook[idx].lastUsed = Date.now(); }
    save(LS.cookbook, cookbook);

    renderWeekPlan();
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
    alert('Inserat ver√∂ffentlicht.');
  }

  // --- Wizard engine (Provider profile / Listing / Cookbook / Week) ---
  let w = { kind:null, step:0, data:{}, ctx:{} };

  const ALLERGENS_14 = [
    {name:'Gluten', short:'GL'},
    {name:'Krebstiere', short:'KR'},
    {name:'Eier', short:'EI'},
    {name:'Fisch', short:'FI'},
    {name:'Erdn√ºsse', short:'EN'},
    {name:'Soja', short:'SO'},
    {name:'Milch', short:'MI'},
    {name:'Schalenfr√ºchte', short:'SF'},
    {name:'Sellerie', short:'SE'},
    {name:'Senf', short:'SN'},
    {name:'Sesam', short:'SS'},
    {name:'Sulfite', short:'SU'},
    {name:'Lupinen', short:'LU'},
    {name:'Weichtiere', short:'WE'}
  ];

  function openWizard(){
    document.getElementById('wbd').classList.add('active');
    document.getElementById('wizard').classList.add('active');
  }
  function closeWizard(){
    document.getElementById('wbd').classList.remove('active');
    document.getElementById('wizard').classList.remove('active');
  }

  function startWizard(kind, ctx={}){
    w = { kind, step:0, data:{}, ctx };

    if(kind==='provider'){
      w.data = normalizeProviderProfile(JSON.parse(JSON.stringify(provider.profile||{})));
      buildProviderStep();
    }
    if(kind==='cookbook'){
      if(ctx.editId){
        const existing = cookbook.find(c=>c.id===ctx.editId);
        if(existing){ w.data = JSON.parse(JSON.stringify(existing)); }
      }
      if(!w.data || !w.data.providerId){
        w.data = {
          providerId: providerId(),
          dish:'', category:'Vegetarisch', price:0,
          allergens:[],
          extras:[],
          reuse:{enabled:false, deposit:0},
          photoData:'',
          hasPickupCode:false,
          dineInPossible:false,
          createdAt: Date.now(),
          lastUsed: null
        };
      }
      w.data.providerId = providerId();
      w.data.category = w.data.category || 'Vegetarisch';
      w.data.price = Number(w.data.price||0);
      w.data.allergens = Array.isArray(w.data.allergens) ? w.data.allergens : [];
      w.data.extras = Array.isArray(w.data.extras) ? w.data.extras : [];
      if(!w.data.reuse) w.data.reuse = {enabled:false, deposit:0};
      w.data.photoData = w.data.photoData || '';
      w.data.hasPickupCode = !!w.data.hasPickupCode;
      w.data.dineInPossible = !!w.data.dineInPossible;
      w.data.createdAt = w.data.createdAt || Date.now();
      if(w.data.lastUsed === undefined) w.data.lastUsed = null;
      buildCookbookStep();
    }
    if(kind==='listing'){
      const profile = normalizeProviderProfile(provider.profile || {});
      // if from cookbook
      if(ctx.editOfferId){
        const existing = offers.find(o=>o.id===ctx.editOfferId);
        if(existing){
          const o = normalizeOffer(existing);
          w.data = {
            providerId: o.providerId || providerId(),
            dish: o.dish||'',
            category: o.category||'Vegetarisch',
            price: Number(o.price||0),
            pickupWindow: o.pickupWindow || profile.mealWindow || DEFAULT_MEAL_WINDOW,
            hasPickupCode: !!o.hasPickupCode,
            dineInPossible: !!o.dineInPossible,
            allergens: Array.isArray(o.allergens) ? [...o.allergens] : [],
            extras: Array.isArray(o.extras) ? JSON.parse(JSON.stringify(o.extras)) : [],
            reuse: o.reuse ? JSON.parse(JSON.stringify(o.reuse)) : {enabled:false, deposit:0},
            photoData: o.imageUrl || '',
            day: o.day,
            active: o.active !== false
          };
        }
      } else if(ctx.fromCookbookId){
        const x = cookbook.find(c=>c.id===ctx.fromCookbookId);
        if(x){ w.data = JSON.parse(JSON.stringify(x)); }
      } else {
        w.data = {
          providerId: providerId(),
          dish:'', category:'Vegetarisch', price:0,
          pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
          hasPickupCode:false,
          dineInPossible:false,
          allergens:[],
          extras:[],
          reuse:{enabled:false, deposit:0},
          photoData:''
        };
      }
      w.data.providerId = w.data.providerId || providerId();
      w.data.category = w.data.category || 'Vegetarisch';
      w.data.price = Number(w.data.price||0);
      w.data.pickupWindow = w.data.pickupWindow || profile.mealWindow || DEFAULT_MEAL_WINDOW;
      w.data.hasPickupCode = !!w.data.hasPickupCode;
      w.data.dineInPossible = !!w.data.dineInPossible;
      w.data.allergens = Array.isArray(w.data.allergens) ? w.data.allergens : [];
      w.data.extras = Array.isArray(w.data.extras) ? w.data.extras : [];
      if(!w.data.reuse) w.data.reuse = {enabled:false, deposit:0};
      buildListingStep();
    }
    if(kind==='week'){
      // schedule cookbook item to a date
      const x = cookbook.find(c=>c.id===ctx.fromCookbookId);
      if(!x){ alert('Bitte erst ein Gericht im Kochbuch speichern.'); return; }
      w.data = { cookbookId:x.id, date: isoDate(new Date()) };
      buildWeekStep();
    }

    openWizard();
  }

  // Common wizard buttons
  const wBackBtn = document.getElementById('wBack');
  const wNextBtn = document.getElementById('wNext');
  const defaultWizardNext = ()=>{ w.step += 1; rebuildWizard(); };
  function setWizardNextDefault(){ wNextBtn.onclick = defaultWizardNext; }

  wBackBtn.onclick=()=>{
    if(w.step===0){ closeWizard(); return; }
    w.step -= 1;
    rebuildWizard();
  };
  setWizardNextDefault();

  function setWizardHeader(title, stepText){
    document.getElementById('wTitle').textContent = title;
    document.getElementById('wStep').textContent = stepText;
  }
  function setWizardQuestion(q, help=''){ 
    document.getElementById('wQ').textContent = q;
    document.getElementById('wHelp').textContent = help;
  }
  function setWizardContent(node){
    const c = document.getElementById('wContent');
    c.innerHTML='';
    c.appendChild(node);
  }

  function rebuildWizard(){
    if(w.kind==='provider') return buildProviderStep();
    if(w.kind==='cookbook') return buildCookbookStep();
    if(w.kind==='listing') return buildListingStep();
    if(w.kind==='week') return buildWeekStep();
  }

  function saveProviderProfileFromWizard(){
    const parsed = parseAddress(w.data.address || '');
    const street = parsed.street || w.data.street || '';
    const zip = parsed.zip || w.data.zip || '';
    const city = parsed.city || w.data.city || '';
    const address = parsed.address || buildAddress({street, zip, city});

    provider.profile = {
      name: w.data.name||'',
      address,
      street,
      zip,
      city,
      mealWindow: w.data.mealWindow || DEFAULT_MEAL_WINDOW,
      logoData: w.data.logoData||''
    };
    save(LS.provider, provider);
    renderProviderProfile();
    renderProviderHome();
  }

  // --- Provider onboarding (step-by-step, no form) ---
  function buildProviderStep(){
    setWizardNextDefault();
    const total = 5;
    const stepText = `Schritt ${Math.min(w.step+1,total)} von ${total}`;
    setWizardHeader('Anbieter-Profil', stepText);

    if(w.step >= total){
      saveProviderProfileFromWizard();
      closeWizard();
      alert('Profil ist bereit.');
      return;
    }

    if(w.step===0){
      setWizardQuestion('Wie hei√üt dein Betrieb?', 'Du kannst den Namen jederzeit √§ndern.');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field';
      input.placeholder='z.B. Metzgerei M√ºller';
      input.value = w.data.name || '';
      input.oninput=()=>{ w.data.name=input.value; };
      box.appendChild(input);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===1){
      setWizardQuestion('Adresse deines Betriebs?', 'Auto-Vervollst√§ndigung folgt (Demo).');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field';
      input.placeholder='Musterstrasse 12, 73614 Schorndorf';
      input.value = w.data.address || buildAddress(w.data) || '';
      input.oninput=()=>{ w.data.address=input.value; };
      box.appendChild(input);
      const h=document.createElement('div'); h.className='hint'; h.textContent='Tipp: Stra√üe, PLZ, Ort - getrennt mit Komma.';
      box.appendChild(h);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===2){
      setWizardQuestion('Wann k√∂nnen G√§ste dein Essen genie√üen?', 'Standard aus Profil, optional anpassen.');
      if(!w.data.mealWindow) w.data.mealWindow = DEFAULT_MEAL_WINDOW;

      const current = w.data.mealWindow || DEFAULT_MEAL_WINDOW;
      const split = current.includes('‚Äì') ? current.split('‚Äì') : current.split('-');
      const startDefault = split[0] ? split[0].trim() : '11:30';
      const endDefault = split[1] ? split[1].trim() : '14:00';
      if(!w.data.mealStart) w.data.mealStart = startDefault;
      if(!w.data.mealEnd) w.data.mealEnd = endDefault;

      const box=document.createElement('div');
      const summary=document.createElement('div');
      summary.className='panel';
      summary.innerHTML = `<b>${esc(current)}</b><div class="hint">Standard aus Profil</div>`;
      box.appendChild(summary);

      const actions=document.createElement('div');
      actions.className='answers';
      const toggle=document.createElement('button');
      toggle.type='button';
      toggle.className='ans';
      toggle.textContent = w.data.mealCustom ? 'Fertig' : 'Essenszeit √§ndern';
      toggle.onclick=()=>{
        w.data.mealCustom = !w.data.mealCustom;
        rebuildWizard();
      };
      actions.appendChild(toggle);
      box.appendChild(actions);

      if(w.data.mealCustom){
        const updateMealWindow = ()=>{
          if(w.data.mealStart && w.data.mealEnd){
            w.data.mealWindow = `${w.data.mealStart} ‚Äì ${w.data.mealEnd}`;
          }
        };

        const startLabel=document.createElement('div'); startLabel.className='hint'; startLabel.textContent='Start';
        const startRow=document.createElement('div'); startRow.className='answers';
        ['10:30','11:00','11:30','12:00'].forEach(t=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.mealStart===t?' on':'');
          b.textContent=t;
          b.onclick=()=>{ w.data.mealStart=t; updateMealWindow(); rebuildWizard(); };
          startRow.appendChild(b);
        });

        const endLabel=document.createElement('div'); endLabel.className='hint'; endLabel.textContent='Ende';
        const endRow=document.createElement('div'); endRow.className='answers';
        ['13:00','13:30','14:00','14:30'].forEach(t=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.mealEnd===t?' on':'');
          b.textContent=t;
          b.onclick=()=>{ w.data.mealEnd=t; updateMealWindow(); rebuildWizard(); };
          endRow.appendChild(b);
        });

        box.appendChild(document.createElement('div')).style.height='10px';
        box.appendChild(startLabel);
        box.appendChild(startRow);
        box.appendChild(document.createElement('div')).style.height='8px';
        box.appendChild(endLabel);
        box.appendChild(endRow);
      }

      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===3){
      setWizardQuestion('Logo hochladen?', 'Optional, sp√§ter jederzeit austauschbar.');
      const wrap = document.createElement('div');
      const btns=document.createElement('div');
      btns.className='answers';

      const up=document.createElement('button');
      up.className='ans';
      up.type='button';
      up.textContent='Logo ausw√§hlen';
      up.onclick=async()=>{
        const file = await pickImage();
        if(!file) return;
        w.data.logoData = await toDataUrl(file);
        rebuildWizard();
      };

      const skip=document.createElement('button');
      skip.className='ans';
      skip.type='button';
      skip.textContent='Sp√§ter';
      skip.onclick=()=>{ w.data.logoData=''; rebuildWizard(); };

      btns.appendChild(up);
      btns.appendChild(skip);
      wrap.appendChild(btns);

      if(w.data.logoData){
        const prev=document.createElement('div');
        prev.style.marginTop='10px';
        prev.innerHTML = `<div class="hint">Vorschau:</div><div class="plogo" style="width:60px;height:60px;border-radius:14px"><img src="${w.data.logoData}" alt="Logo" /></div>`;
        wrap.appendChild(prev);
      }

      setWizardContent(wrap);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===4){
      setWizardQuestion('Profil ist bereit', 'Kurz pr√ºfen, dann loslegen.');
      const box=document.createElement('div');
      const addr = buildAddress(w.data);
      const logo = w.data.logoData ? `<img src="${w.data.logoData}" alt="Logo" />` : `<img src="assets/provider-placeholder.png" alt="Logo" />`;

      const summary=document.createElement('div');
      summary.className='panel';
      summary.innerHTML = `
        <div style="display:flex;gap:10px;align-items:center;">
          <div class="plogo" style="width:52px;height:52px;border-radius:14px">${logo}</div>
          <div>
            <div style="font-weight:950">${esc(w.data.name || 'Betrieb')}</div>
            <div class="hint">${esc(addr || 'Adresse fehlt')}</div>
          </div>
        </div>
        <div class="row"><span>Essenszeit</span><b>${esc(w.data.mealWindow || DEFAULT_MEAL_WINDOW)}</b></div>
      `;

      const cta=document.createElement('button');
      cta.className='btn';
      cta.type='button';
      cta.textContent='Erstes Gericht erstellen';
      cta.onclick=()=>{
        saveProviderProfileFromWizard();
        closeWizard();
        startWizard('listing');
      };

      box.appendChild(summary);
      box.appendChild(cta);
      setWizardContent(box);
      wNextBtn.textContent='Fertig';
      return;
    }
  }

  // --- Listing wizard (Punkt 6 final) ---
  function updateListingPreviewContent(target){
    target.innerHTML = '';
    const title = document.createElement('div');
    title.className = 'hint';
    title.textContent = 'Live-Vorschau';
    target.appendChild(title);
    target.appendChild(offerCard(previewOfferFromWizard(), {interactive:false}));
    if(w.data.hasPickupCode){
      const note = document.createElement('div');
      note.className = 'mini';
      note.textContent = 'Beispielcode: A3';
      target.appendChild(note);
    }
  }

  function attachListingPreview(box){
    const wrap = document.createElement('div');
    wrap.id = 'listingPreview';
    wrap.style.marginTop = '12px';
    updateListingPreviewContent(wrap);
    box.appendChild(wrap);
  }

  function refreshListingPreview(){
    const wrap = document.getElementById('listingPreview');
    if(wrap){ updateListingPreviewContent(wrap); }
  }

  function buildListingStep(){
    setWizardNextDefault();
    const total = 10;
    setWizardHeader('Neues Inserat', `Schritt ${Math.min(w.step+1,total)} von ${total}`);

    if(w.step===0){
      setWizardQuestion('Gerichtname?', 'Vorschl√§ge erleichtern die Eingabe.');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field';
      input.placeholder='z.B. K√ºrbissuppe';
      input.setAttribute('list','dishSuggestions');
      input.value=w.data.dish||'';
      input.oninput=()=>{
        w.data.dish = input.value;
        const hit = DISH_SUGGESTIONS.find(d => d.name.toLowerCase() === input.value.trim().toLowerCase());
        if(hit){ w.data.category = hit.category; }
        refreshListingPreview();
      };
      const list=document.createElement('datalist');
      list.id='dishSuggestions';
      DISH_SUGGESTIONS.forEach(d=>{
        const opt=document.createElement('option');
        opt.value=d.name;
        list.appendChild(opt);
      });
      const h=document.createElement('div'); h.className='hint'; h.textContent='Kategorie wird automatisch gesetzt, wenn bekannt.';

      box.appendChild(input);
      box.appendChild(list);
      box.appendChild(h);
      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===1){
      setWizardQuestion('Preis pro Portion?', 'Standard: 0,00.');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field';
      input.inputMode='decimal';
      input.placeholder='0,00';
      input.value = formatPriceInput(w.data.price);
      input.oninput=()=>{ w.data.price = parsePriceInput(input.value); refreshListingPreview(); };
      const h=document.createElement('div'); h.className='hint'; h.textContent='Beispiel: 7,90';
      box.appendChild(input);
      box.appendChild(h);
      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===2){
      setWizardQuestion('Essenszeit?', 'Standard aus Profil, optional anpassen.');
      const profile = normalizeProviderProfile(provider.profile || {});
      if(!w.data.pickupWindow){ w.data.pickupWindow = profile.mealWindow || DEFAULT_MEAL_WINDOW; }

      const current = w.data.pickupWindow || profile.mealWindow || DEFAULT_MEAL_WINDOW;
      const split = current.includes('‚Äì') ? current.split('‚Äì') : current.split('-');
      const startDefault = split[0] ? split[0].trim() : '11:30';
      const endDefault = split[1] ? split[1].trim() : '14:00';
      if(!w.data.mealStart) w.data.mealStart = startDefault;
      if(!w.data.mealEnd) w.data.mealEnd = endDefault;

      const box=document.createElement('div');
      const summary=document.createElement('div');
      summary.className='panel';
      summary.innerHTML = `<b>${esc(current)}</b><div class="hint">Standard aus Profil</div>`;
      box.appendChild(summary);

      const actions=document.createElement('div');
      actions.className='answers';
      const toggle=document.createElement('button');
      toggle.type='button';
      toggle.className='ans';
      toggle.textContent = w.data.mealCustom ? 'Fertig' : 'Essenszeit √§ndern';
      toggle.onclick=()=>{
        w.data.mealCustom = !w.data.mealCustom;
        if(!w.data.mealCustom){
          w.data.pickupWindow = profile.mealWindow || DEFAULT_MEAL_WINDOW;
        }
        rebuildWizard();
      };
      actions.appendChild(toggle);
      box.appendChild(actions);

      if(w.data.mealCustom){
        const updateWindow = ()=>{
          if(w.data.mealStart && w.data.mealEnd){
            w.data.pickupWindow = `${w.data.mealStart} ‚Äì ${w.data.mealEnd}`;
          }
        };

        const startLabel=document.createElement('div'); startLabel.className='hint'; startLabel.textContent='Start';
        const startRow=document.createElement('div'); startRow.className='answers';
        ['10:30','11:00','11:30','12:00'].forEach(t=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.mealStart===t?' on':'');
          b.textContent=t;
          b.onclick=()=>{ w.data.mealStart=t; updateWindow(); rebuildWizard(); };
          startRow.appendChild(b);
        });

        const endLabel=document.createElement('div'); endLabel.className='hint'; endLabel.textContent='Ende';
        const endRow=document.createElement('div'); endRow.className='answers';
        ['13:00','13:30','14:00','14:30'].forEach(t=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.mealEnd===t?' on':'');
          b.textContent=t;
          b.onclick=()=>{ w.data.mealEnd=t; updateWindow(); rebuildWizard(); };
          endRow.appendChild(b);
        });

        box.appendChild(document.createElement('div')).style.height='10px';
        box.appendChild(startLabel);
        box.appendChild(startRow);
        box.appendChild(document.createElement('div')).style.height='8px';
        box.appendChild(endLabel);
        box.appendChild(endRow);
      }

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===3){
      setWizardQuestion('Allergene?', 'Ja/Nein. Bei Ja: 14 Allergene als Toggle.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      const has = w.data.hasAllergens || (Array.isArray(w.data.allergens) && w.data.allergens.length);

      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(has?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!has?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.hasAllergens=true; if(!Array.isArray(w.data.allergens)) w.data.allergens=[]; rebuildWizard(); };
      no.onclick=()=>{ w.data.hasAllergens=false; w.data.allergens=[]; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);

      if(has){
        const list=document.createElement('div'); list.className='answers';
        ALLERGENS_14.forEach(a=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.allergens.includes(a.short)?' on':'');
          b.textContent=`${a.short} ${a.name}`;
          b.onclick=()=>{
            const i=w.data.allergens.indexOf(a.short);
            if(i>=0) w.data.allergens.splice(i,1); else w.data.allergens.push(a.short);
            rebuildWizard();
          };
          list.appendChild(b);
        });
        box.appendChild(document.createElement('div')).style.height='8px';
        box.appendChild(list);
      }

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===4){
      setWizardQuestion('Extras?', 'Presets w√§hlen und Preis angeben.');
      const box=document.createElement('div');
      if(!Array.isArray(w.data.extras)) w.data.extras=[];

      const ans=document.createElement('div'); ans.className='answers';
      ['Beilagensalat','Extrasosse','Sonstiges'].forEach(name=>{
        const active = w.data.extras.some(e=>e.name===name);
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(active?' on':'');
        b.textContent=name;
        b.onclick=()=>{
          const idx = w.data.extras.findIndex(e=>e.name===name);
          if(idx>=0) w.data.extras.splice(idx,1);
          else w.data.extras.push({name, price:0});
          rebuildWizard();
        };
        ans.appendChild(b);
      });
      box.appendChild(ans);

      if(w.data.extras.length){
        w.data.extras.forEach(extra=>{
          const label=document.createElement('div');
          label.className='hint';
          label.textContent=extra.name;
          const input=document.createElement('input');
          input.className='field';
          input.inputMode='decimal';
          input.placeholder='Preis in EUR (z.B. 2,00)';
          input.value = formatPriceInput(extra.price);
          input.oninput=()=>{ extra.price = parsePriceInput(input.value); refreshListingPreview(); };
          box.appendChild(document.createElement('div')).style.height='8px';
          box.appendChild(label);
          box.appendChild(input);
        });
      }

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===5){
      setWizardQuestion('Mehrweg anbieten?', 'Ja/Nein. Presets: 2, 3, 5 EUR.');
      const box=document.createElement('div');
      if(!w.data.reuse) w.data.reuse = {enabled:false, deposit:0};

      const ans=document.createElement('div'); ans.className='answers';
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(w.data.reuse.enabled?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!w.data.reuse.enabled?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.reuse.enabled=true; if(!w.data.reuse.deposit) w.data.reuse.deposit=2; rebuildWizard(); };
      no.onclick=()=>{ w.data.reuse.enabled=false; w.data.reuse.deposit=0; w.data.reuseCustom=false; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);

      if(w.data.reuse.enabled){
        const presets=document.createElement('div'); presets.className='answers';
        [2,3,5].forEach(val=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.reuse.deposit===val && !w.data.reuseCustom?' on':'');
          b.textContent=`${val} EUR`;
          b.onclick=()=>{ w.data.reuse.deposit=val; w.data.reuseCustom=false; rebuildWizard(); };
          presets.appendChild(b);
        });
        const other=document.createElement('button');
        other.type='button';
        other.className='ans'+(w.data.reuseCustom?' on':'');
        other.textContent='Anderer Betrag';
        other.onclick=()=>{ w.data.reuseCustom=true; rebuildWizard(); };
        presets.appendChild(other);
        box.appendChild(document.createElement('div')).style.height='8px';
        box.appendChild(presets);
        const hint=document.createElement('div');
        hint.className='hint';
        hint.textContent='Hinweis: sp√§ter Recup/Rebowl.';
        box.appendChild(hint);

        if(w.data.reuseCustom){
          const input=document.createElement('input');
          input.className='field';
          input.inputMode='decimal';
          input.placeholder='Betrag in EUR';
          input.value = formatPriceInput(w.data.reuse.deposit);
          input.oninput=()=>{ w.data.reuse.deposit = parsePriceInput(input.value); refreshListingPreview(); };
          box.appendChild(document.createElement('div')).style.height='8px';
          box.appendChild(input);
        }
      }

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===6){
      setWizardQuestion('Foto?', 'Kamera, Galerie oder ohne Foto.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';

      const cam=document.createElement('button'); cam.type='button'; cam.className='ans'; cam.textContent='Kamera';
      cam.onclick=async()=>{ const f=await pickImage({capture:true}); if(!f) return; w.data.photoData = await toDataUrl(f); rebuildWizard(); };
      const gal=document.createElement('button'); gal.type='button'; gal.className='ans'; gal.textContent='Galerie';
      gal.onclick=async()=>{ const f=await pickImage(); if(!f) return; w.data.photoData = await toDataUrl(f); rebuildWizard(); };
      const none=document.createElement('button'); none.type='button'; none.className='ans'; none.textContent='Ohne Foto';
      none.onclick=()=>{ w.data.photoData=''; rebuildWizard(); };

      ans.appendChild(cam); ans.appendChild(gal); ans.appendChild(none);
      box.appendChild(ans);
      if(w.data.photoData){
        const p=document.createElement('div'); p.style.marginTop='10px';
        p.innerHTML = `<div class="hint">Vorschau:</div><div style="border-radius:16px;overflow:hidden;border:1px solid #eee"><img src="${w.data.photoData}" alt="" style="width:100%;height:200px;object-fit:cover;display:block"></div>`;
        box.appendChild(p);
      }

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===7){
      setWizardQuestion('Bezahlung mit Abholcode?', 'Vorschau zeigt Badge + Beispielcode.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(w.data.hasPickupCode?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!w.data.hasPickupCode?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.hasPickupCode=true; rebuildWizard(); };
      no.onclick=()=>{ w.data.hasPickupCode=false; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===8){
      setWizardQuestion('Vor Ort essen m√∂glich?', 'Vorschau zeigt Badge.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(w.data.dineInPossible?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!w.data.dineInPossible?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.dineInPossible=true; rebuildWizard(); };
      no.onclick=()=>{ w.data.dineInPossible=false; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===9){
      setWizardQuestion('Abschluss', 'Ver√∂ffentlichen oder speichern.');
      const box=document.createElement('div');
      attachListingPreview(box);

      const actions=document.createElement('div');
      actions.style.marginTop='10px';

      const btnPub=document.createElement('button');
      btnPub.className='btn';
      btnPub.type='button';
      btnPub.textContent = 'Inserat ver√∂ffentlichen';
      btnPub.onclick=()=>{
        const o = previewOfferFromWizard();
        publishOffer(o);
        closeWizard();
        alert('Inserat ver√∂ffentlicht.');
        showProviderHome();
      };

      const btnSave=document.createElement('button');
      btnSave.className='btn secondary';
      btnSave.type='button';
      btnSave.textContent='In Kochbuch speichern';
      btnSave.onclick=()=>{
        saveToCookbookFromWizard();
        alert('Im Kochbuch gespeichert.');
        closeWizard();
        showProviderCookbook();
      };

      const btnWeek=document.createElement('button');
      btnWeek.className='btn ghost';
      btnWeek.type='button';
      btnWeek.textContent='In Wochenplan √ºbernehmen';
      btnWeek.onclick=()=>{
        saveToCookbookFromWizard(true);
        const cb = cookbook.filter(x=>x.providerId===providerId()).slice(-1)[0];
        if(cb) startWizard('week', {fromCookbookId:cb.id});
      };

      const btnBack=document.createElement('button');
      btnBack.className='btn ghost';
      btnBack.type='button';
      btnBack.textContent='Zur√ºck';
      btnBack.onclick=()=>{ w.step = Math.max(0, w.step-1); rebuildWizard(); };

      actions.appendChild(btnPub);
      actions.appendChild(btnSave);
      actions.appendChild(btnWeek);
      actions.appendChild(btnBack);
      box.appendChild(actions);

      setWizardContent(box);
      wNextBtn.textContent='Fertig';
      wNextBtn.onclick=()=>{ closeWizard(); showProviderHome(); };
      return;
    }
  }

  function previewOfferFromWizard(){
    const p = normalizeProviderProfile(provider.profile||{});
    const pickupWindow = w.data.pickupWindow || p.mealWindow || DEFAULT_MEAL_WINDOW;
    return {
      id: 'preview',
      providerId: providerId(),
      providerName: p.name || provider.email || 'Anbieter',
      providerStreet: p.street||'',
      providerZip: p.zip||'',
      providerCity: p.city||'',
      providerLogoData: p.logoData||'',
      dish: w.data.dish||'Gericht',
      category: w.data.category||'Vegetarisch',
      price: Number(w.data.price||0),
      pickupWindow,
      imageUrl: w.data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
      hasPickupCode: !!w.data.hasPickupCode,
      dineInPossible: !!w.data.dineInPossible,
      allergens: w.data.allergens||[],
      extras: w.data.extras||[],
      reuse: w.data.reuse||{enabled:false,deposit:0},
      day: w.data.day || isoDate(new Date()),
      active: w.data.active !== false
    };
  }

  function publishOffer(o){
    const existingId = w.ctx && w.ctx.editOfferId ? w.ctx.editOfferId : null;
    const id = existingId || cryptoId();
    const out = {...o, id, day: o.day || isoDate(new Date()), active: o.active !== false};
    // ensure provider address exists
    if(!out.providerStreet){
      alert('Bitte zuerst Anbieterprofil ausf√ºllen (Adresse).');
      return;
    }
    if(existingId){
      const idx = offers.findIndex(x=>x.id===existingId);
      if(idx>=0){
        const prev = offers[idx];
        offers[idx] = {...prev, ...out, id: prev.id, day: prev.day, active: prev.active !== false};
      } else {
        offers.unshift(out);
      }
    } else {
      offers.unshift(out);
    }
    save(LS.offers, offers);
    // restore default next button handler
    setWizardNextDefault();
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
  }

  function saveToCookbookFromWizard(keepOpen=false){
    const now = Date.now();
    const base = {
      id: cryptoId(),
      providerId: providerId(),
      dish: w.data.dish||'',
      category: w.data.category||'Vegetarisch',
      price: Number(w.data.price||0),
      allergens: w.data.allergens||[],
      extras: w.data.extras||[],
      reuse: w.data.reuse||{enabled:false,deposit:0},
      photoData: w.data.photoData||'',
      hasPickupCode: !!w.data.hasPickupCode,
      dineInPossible: !!w.data.dineInPossible,
      createdAt: now,
      lastUsed: null
    };
    if(w.ctx && w.ctx.editId){
      const idx = cookbook.findIndex(c=>c.id===w.ctx.editId);
      if(idx>=0){
        const prev = cookbook[idx];
        cookbook[idx] = {
          ...prev,
          ...base,
          id: prev.id,
          createdAt: prev.createdAt || now,
          lastUsed: prev.lastUsed ?? null
        };
      } else {
        cookbook.push(base);
      }
    } else {
      cookbook.push(base);
    }
    save(LS.cookbook, cookbook);
    if(!keepOpen){ renderCookbook(); }
  }

  // Cookbook wizard (add recipe)
  function buildCookbookStep(){
    setWizardNextDefault();
    // reuse listing steps subset: category, photo, name, allergens, extras, reuse, price, preview/save
    const total = 8;
    setWizardHeader('Kochbuch', `${Math.min(w.step+1,total)}/${total}`);

    if(w.step===0){
      setWizardQuestion('Kategorie?', 'Tippe eine Kategorie.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      ['Vegan','Vegetarisch','Fleisch','Salat'].forEach(c=>{
        const b=document.createElement('button'); b.type='button'; b.className='ans'+(w.data.category===c?' on':''); b.textContent=c;
        b.onclick=()=>{ w.data.category=c; rebuildWizard(); };
        ans.appendChild(b);
      });
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===1){
      setWizardQuestion('Foto speichern?', 'Optional (f√ºr schnelleres Wiederverwenden).');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      const b1=document.createElement('button'); b1.type='button'; b1.className='ans'; b1.textContent='Foto ausw√§hlen';
      b1.onclick=async()=>{ const f=await pickImage(); if(!f) return; w.data.photoData = await toDataUrl(f); rebuildWizard(); };
      const b2=document.createElement('button'); b2.type='button'; b2.className='ans'; b2.textContent='Ohne';
      b2.onclick=()=>{ w.data.photoData=''; rebuildWizard(); };
      ans.appendChild(b1); ans.appendChild(b2);
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===2){
      setWizardQuestion('Gerichtname?', 'Wie im Kochbuch.');
      const box=document.createElement('div');
      const input=document.createElement('input'); input.className='field'; input.placeholder='z.B. Lasagne'; input.value=w.data.dish||'';
      input.oninput=()=>{ w.data.dish=input.value; };
      box.appendChild(input);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===3){
      setWizardQuestion('Allergene?', 'Optional, antippen.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      if(!Array.isArray(w.data.allergens)) w.data.allergens=[];
      ALLERGENS_14.forEach(a=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(w.data.allergens.includes(a.short)?' on':'');
        b.textContent=`${a.short} ${a.name}`;
        b.onclick=()=>{
          const i=w.data.allergens.indexOf(a.short);
          if(i>=0) w.data.allergens.splice(i,1); else w.data.allergens.push(a.short);
          rebuildWizard();
        };
        ans.appendChild(b);
      });
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===4){
      // Extras
      setWizardQuestion('Extras?', 'Optional.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(w.data.extras?.length?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!w.data.extras?.length?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.extras = w.data.extras?.length ? w.data.extras : [{name:'Beilagensalat', price:2.0}]; rebuildWizard(); };
      no.onclick=()=>{ w.data.extras=[]; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===5){
      // reuse
      setWizardQuestion('Mehrweg / Pfand?', 'Optional.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      if(!w.data.reuse) w.data.reuse={enabled:false,deposit:0};
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(w.data.reuse.enabled?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!w.data.reuse.enabled?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.reuse.enabled=true; if(!w.data.reuse.deposit) w.data.reuse.deposit=5; rebuildWizard(); };
      no.onclick=()=>{ w.data.reuse.enabled=false; w.data.reuse.deposit=0; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===6){
      setWizardQuestion('Standardpreis?', 'Nur Zahl - Komma nicht n√∂tig.');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field'; input.inputMode='numeric'; input.placeholder='z.B. 799';
      input.value = w.data.price ? String(Math.round(w.data.price*100)) : '';
      input.oninput=()=>{ w.data.price = smartNumberToEuro(input.value); };
      box.appendChild(input);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===7){
      setWizardQuestion('Speichern?', 'Damit du sp√§ter mit 2 Taps inserierst.');
      const box=document.createElement('div');
      const prev = {
        id:'preview',
        providerId:providerId(),
        providerName: provider.profile.name || provider.email || 'Anbieter',
        providerStreet:'',providerZip:'',providerCity:'',providerLogoData: provider.profile.logoData||'',
        dish:w.data.dish||'Gericht',
        category:w.data.category||'Vegetarisch',
        price:Number(w.data.price||0),
        pickupWindow:'',
        imageUrl: w.data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
        hasPickupCode:false,
        allergens:w.data.allergens||[],
        extras:w.data.extras||[],
        reuse:w.data.reuse||{enabled:false,deposit:0},
        day: isoDate(new Date())
      };
      box.appendChild(offerCard(prev, {interactive:false}));
      const btn=document.createElement('button');
      btn.className='btn';
      btn.type='button';
      btn.textContent = w.ctx && w.ctx.editId ? '√Ñnderungen speichern' : 'Im Kochbuch speichern';
      btn.onclick=()=>{
        saveToCookbookFromWizard();
        closeWizard();
        renderCookbook();
        alert('Gespeichert.');
      };
      box.appendChild(btn);
      setWizardContent(box);
      wNextBtn.textContent='Fertig';
      wNextBtn.onclick=()=>{ closeWizard(); showProviderCookbook(); };
      return;
    }
  }

  // Weekplan wizard (simple date choose)
  function buildWeekStep(){
    setWizardNextDefault();
    setWizardHeader('Wochenplan', '1/1');
    setWizardQuestion('F√ºr welchen Tag?', 'W√§hle einen Tag und f√ºge das Gericht hinzu.');

    const box=document.createElement('div');
    const ans=document.createElement('div'); ans.className='answers';

    for(let i=0;i<5;i++){
      const d=new Date(); d.setDate(d.getDate()+i);
      const key=isoDate(d);
      const b=document.createElement('button');
      b.type='button';
      b.className='ans'+(w.data.date===key?' on':'');
      b.textContent = i===0?'Heute':(i===1?'Morgen':fmtDay(d));
      b.onclick=()=>{ w.data.date=key; rebuildWizard(); };
      ans.appendChild(b);
    }
    box.appendChild(ans);

    const btn=document.createElement('button');
    btn.className='btn';
    btn.type='button';
    btn.textContent='Zum Wochenplan hinzuf√ºgen';
    btn.onclick=()=>{
      const cb = cookbook.find(c=>c.id===w.data.cookbookId);
      if(!cb){ alert('Gericht nicht gefunden'); return; }
      const entry = { providerId:providerId(), dish:cb.dish, cookbookId:cb.id, active:true };
      if(!week[w.data.date]) week[w.data.date]=[];
      week[w.data.date].push(entry);
      save(LS.week, week);
      closeWizard();
      renderProviderHome();
      alert('Im Wochenplan gespeichert.');
    };

    box.appendChild(document.createElement('div')).style.height='10px';
    box.appendChild(btn);

    setWizardContent(box);
    wNextBtn.textContent='Fertig';
    wNextBtn.onclick=()=>{ closeWizard(); showProviderHome(); };
  }

  // --- Input helpers (thumb-friendly) ---
  function formatPriceInput(value){
    const num = Number(value||0);
    return num.toFixed(2).replace('.',',');
  }
  function parsePriceInput(raw){
    const cleaned = String(raw||'').trim().replace(',', '.').replace(/[^0-9.]/g,'');
    const num = parseFloat(cleaned);
    if(Number.isNaN(num)) return 0;
    return Math.round(num*100)/100;
  }
  function smartNumberToEuro(raw){
    const digits = String(raw||'').replace(/\D/g,'');
    if(!digits) return 0;
    const cents = parseInt(digits,10);
    return Math.round((cents/100)*100)/100;
  }
  function smartNumber(raw){
    const digits = String(raw||'').replace(/\D/g,'');
    if(!digits) return 0;
    return parseInt(digits,10);
  }

  // Image picker
  function pickImage(opts={}){
    return new Promise(resolve=>{
      const input=document.createElement('input');
      input.type='file';
      input.accept='image/*';
      if(opts.capture) input.capture='environment';
      input.onchange=()=> resolve(input.files && input.files[0] ? input.files[0] : null);
      input.click();
    });
  }
  function toDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload=()=>resolve(r.result);
      r.onerror=reject;
      r.readAsDataURL(file);
    });
  }

  // --- boot ---
  seed();
  offers = offers.map(normalizeOffer);
  save(LS.offers, offers);
  renderChips();

  // init nav bindings
  // default start
  if(mode==='provider' && !provider.loggedIn) mode='customer';
  setMode(mode);

  // initial customer view
  showDiscover();
</script>

<script>
  // PWA (optional)
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('sw.js').catch(()=>{});
    });
  }
</script>
</body>
</html>
