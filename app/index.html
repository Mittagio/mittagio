<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Mittagio</title>
  <meta name="theme-color" content="#F2B705" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root{
      /* Mittagio palette (can be adjusted later) */
      --bg:#F7F6F0;
      --card:#FFFFFF;
      --text:#111;
      --muted:#6b6b6b;
      --border:#e7e1d5;
      --shadow:0 10px 24px rgba(0,0,0,.08);
      --shadow2:0 16px 40px rgba(0,0,0,.14);
      --radius:18px;
      --brand:#F2B705;   /* warm yellow */
      --brand2:#1F9D55;  /* green */
      --danger:#E34D4D;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit}

    /* App shell */
    .app{min-height:100%; padding-bottom:78px;}
    .topbar{
      position:sticky; top:0; z-index:10;
      background:rgba(247,246,240,.92);
      backdrop-filter:saturate(160%) blur(8px);
      border-bottom:1px solid var(--border);
    }
    .topbar-inner{max-width:980px; margin:0 auto; padding:12px 14px; display:flex; align-items:center; gap:10px;}
    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .brand-badge{
      width:38px; height:38px; border-radius:12px;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      box-shadow:0 8px 18px rgba(0,0,0,.16);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .brand-badge img{width:100%; height:100%; object-fit:cover; display:block}
    .brand-name{font-weight:900; letter-spacing:.06em; font-size:18px; white-space:nowrap}
    .spacer{flex:1}

    .chiprow{
      max-width:980px; margin:0 auto; padding:10px 14px 12px;
      display:flex; gap:8px; overflow:auto; -webkit-overflow-scrolling:touch;
    }
    .chip{
      flex:0 0 auto;
      border:1px solid var(--border);
      background:#fff;
      padding:9px 12px;
      border-radius:999px;
      font-size:13px;
      font-weight:800;
      color:#222;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .chip.active{border-color:rgba(31,157,85,.35); box-shadow:0 10px 22px rgba(31,157,85,.12)}

    .pickup-group{
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      padding:10px;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .pickup-group + .pickup-group{margin-top:10px}
    .pickup-head{display:flex; align-items:center; justify-content:space-between; gap:8px; font-weight:900}
    .pickup-sub{font-size:12px; color:var(--muted)}
    .code-chip{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px; border:1px solid var(--border);
      background:#fff; font-size:12px; font-weight:900;
      margin:4px 6px 0 0; box-shadow:0 6px 14px rgba(0,0,0,.06);
    }

    .dayrow{
      max-width:980px; margin:0 auto; padding:0 14px 12px;
      display:flex; gap:8px; overflow:auto; -webkit-overflow-scrolling:touch;
    }
    .day{
      flex:0 0 auto;
      border:none;
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      border:1px solid var(--border);
    }
    .day.active{background:rgba(242,183,5,.14); border-color:rgba(242,183,5,.55)}

    main{max-width:980px; margin:0 auto; padding:14px}
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    @media (min-width:820px){ .grid{grid-template-columns:1fr 1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:var(--shadow);
      cursor:pointer;
      position:relative;
    }
    .img{height:190px; background:#eee; position:relative}
    .img img{width:100%; height:100%; object-fit:cover; display:block}

    .provider-logo{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px 0;
    }
    .plogo{
      width:28px; height:28px; border-radius:8px;
      background:#f2f2f2;
      overflow:hidden;
      border:1px solid var(--border);
      flex:0 0 auto;
    }
    .plogo img{width:100%; height:100%; object-fit:cover; display:block}
    .pname{font-size:13px; font-weight:900; color:#222; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}

    .body{padding:10px 12px 12px}
    .title{font-weight:950; font-size:16px; margin:0}
    .sub{margin:3px 0 0; color:#444; font-size:13px}

    .meta{display:flex; justify-content:space-between; align-items:flex-end; gap:12px; margin-top:10px}
    .price{font-weight:950; font-size:16px; color:#0f5c4c}
    .right{ text-align:right; font-size:12px; color:var(--muted); line-height:1.25 }
    .tag{display:inline-block; margin-top:6px; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:900; background:rgba(31,157,85,.12)}

    .badge{
      position:absolute; top:12px; left:12px;
      background:rgba(17,17,17,.82);
      color:#fff;
      font-size:12px; font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      box-shadow:0 10px 22px rgba(0,0,0,.18);
    }
    .badge.code{left:auto; right:12px; background:rgba(31,157,85,.9)}
    .badge.dine{background:rgba(242,183,5,.9); color:#111}

    .heart{
      position:absolute; top:12px; right:12px;
      width:36px; height:36px; border-radius:999px;
      border:none; cursor:pointer;
      background:rgba(255,255,255,.92);
      box-shadow:0 10px 22px rgba(0,0,0,.16);
      font-size:16px;
      color:#bbb;
      display:flex; align-items:center; justify-content:center;
    }
    .heart.on{color:var(--danger)}

    /* Bottom nav */
    .bottom{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      height:72px; padding-bottom:env(safe-area-inset-bottom);
      background:#fff; border-top:1px solid var(--border);
      display:flex;
    }
    .navbtn{
      flex:1; border:none; background:none; cursor:pointer;
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:5px;
      color:#777; font-size:11px;
    }
    .navbtn .ico{font-size:18px}
    .navbtn.active{color:#111; font-weight:900}

    /* Views */
    .view{display:none}
    .view.active{display:block}

    /* Sheets / modals */
    .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.38); opacity:0; pointer-events:none; transition:opacity .2s; z-index:30}
    .backdrop.active{opacity:1; pointer-events:auto}
    .sheet{
      position:fixed; left:0; right:0; bottom:-120%; z-index:31;
      background:#fff; border-radius:22px 22px 0 0;
      box-shadow:var(--shadow2);
      transition:bottom .28s ease;
      max-height:92vh; overflow:auto;
    }
    .sheet.active{bottom:0}
    .handle{width:46px; height:5px; background:#ddd; border-radius:999px; margin:10px auto 6px}
    .sheet-img{height:260px; background:#eee}
    .sheet-img img{width:100%; height:100%; object-fit:cover; display:block}
    .sheet-body{padding:12px 14px 18px}
    .row{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px 0; border-top:1px solid #eee; font-size:14px}
    .btn{
      width:100%; border:none; cursor:pointer;
      border-radius:999px; padding:14px 14px; font-weight:950; font-size:15px;
      background:var(--brand); color:#111;
      margin-top:10px;
    }
    .btn.secondary{background:#fff; border:1px solid var(--border)}
    .btn.ghost{background:#f8f7f3; border:1px solid var(--border)}
    .mini{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.25}

    /* Profile cards */
    .panel{background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); padding:12px}
    .panel h3{margin:0 0 8px; font-size:14px}
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .bigbtn{
      border:none; cursor:pointer;
      border-radius:18px; padding:14px;
      background:linear-gradient(135deg,rgba(242,183,5,.18),rgba(31,157,85,.12));
      border:1px solid var(--border);
      text-align:left;
      font-weight:950;
    }
    .bigbtn span{display:block; font-weight:700; font-size:12px; color:var(--muted); margin-top:6px}

    /* Provider app header */
    .prov-pill{
      display:inline-flex; align-items:center; gap:8px;
      background:#fff; border:1px solid var(--border);
      padding:9px 12px; border-radius:999px;
      font-weight:950; font-size:13px;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }

    /* Wizard */
    .wizard{
      background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow);
      padding:12px;
    }
    .w-top{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .w-title{font-weight:950}
    .w-step{font-size:12px; color:var(--muted)}
    .w-q{margin:12px 0 10px; font-size:18px; font-weight:950; line-height:1.2}
    .w-help{margin:0 0 10px; color:var(--muted); font-size:13px}
    .answers{display:flex; flex-wrap:wrap; gap:8px}
    .ans{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-weight:950;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .ans.on{border-color:rgba(31,157,85,.4); background:rgba(31,157,85,.10)}
    .field{width:100%; padding:12px 12px; border-radius:14px; border:1px solid var(--border); font-size:16px; background:#fbfaf7}
    .w-actions{display:flex; gap:10px; margin-top:12px}
    .w-actions button{flex:1}

    /* FAQ accordion */
    .faq{margin-top:12px}
    details{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 14px rgba(0,0,0,.06);padding:10px 12px}
    details+details{margin-top:10px}
    summary{cursor:pointer;font-weight:950}
    details p{margin:8px 0 0;color:var(--muted);font-size:13px;line-height:1.3}

    /* helper */
    .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.25}
  </style>
</head>
<body>
<div class="app" id="app">
  <div class="topbar" id="topbar">
    <div class="topbar-inner">
      <div class="brand" role="button" aria-label="Mittagio">
        <div class="brand-badge"><img src="assets/mittagio-logo.png" alt="Mittagio" onerror="this.style.display='none'" /></div>
        <div class="brand-name">MITTAGIO</div>
      </div>
      <div class="spacer"></div>
      <div id="modePill" class="prov-pill" style="display:none;">üßë‚Äçüç≥ Anbieter-Modus</div>
    </div>

    <!-- Customer discover filter rows (hidden in provider mode) -->
    <div id="discoverFilters">
      <div class="chiprow" id="catChips"></div>
      <div class="dayrow" id="dayChips"></div>
    </div>
  </div>

  <main>
    <!-- CUSTOMER: Discover -->
    <section class="view active" id="v-discover">
      <div class="grid" id="offerGrid"></div>
      <p class="hint" id="emptyOffers" style="display:none;">Noch keine Angebote. (Demo: Als Anbieter ein Inserat erstellen.)</p>
    </section>

    <!-- CUSTOMER: Favorites -->
    <section class="view" id="v-fav">
      <div class="grid" id="favGrid"></div>
      <p class="hint" id="emptyFav" style="display:none;">Noch keine Favoriten. Tippe auf ‚ù§Ô∏è.</p>
    </section>

    <!-- CUSTOMER: Cart -->
    <section class="view" id="v-cart">
      <div class="panel">
        <h3>Warenkorb</h3>
        <div id="cartBox" class="hint">Noch leer.</div>
        <button class="btn" id="btnCheckout" type="button" style="display:none;">Zur Kasse</button>
        <div class="mini" id="cartNote" style="display:none;">
          MVP: Ein Warenkorb nur f√ºr <b>einen Anbieter</b>. (Mehrere Gerichte m√∂glich.)
        </div>
      </div>
    </section>

    <!-- CUSTOMER: Profile -->
    <section class="view" id="v-profile">
      <div class="panel">
        <h3>Profil</h3>
        <div class="two" style="margin-top:10px;">
          <button class="bigbtn" type="button" id="btnCustomerLogin">Kunde anmelden<span>Google / Apple / E-Mail (Demo)</span></button>
          <button class="bigbtn" type="button" id="btnProviderEntry">Anbieter Login<span>Zum Anbieterbereich</span></button>
        </div>
        <div style="margin-top:10px;" class="hint" id="customerStatus">Nicht angemeldet (Demo).</div>
      </div>

      <div class="faq">
        <details>
          <summary>Wie funktioniert Mittagio?</summary>
          <p>Entdecken ‚Üí Gericht ausw√§hlen ‚Üí in den Warenkorb ‚Üí bezahlen ‚Üí Abholcode zeigen.</p>
        </details>
        <details>
          <summary>Kann ich f√ºr mehrere Personen bestellen?</summary>
          <p>Ja. Du kannst mehrere Gerichte in einem Vorgang bestellen (Abholcode pro Vorgang).</p>
        </details>
      </div>
    </section>

    <!-- PROVIDER: Login page -->
    <section class="view" id="v-provider-login">
      <div class="panel">
        <h3>Anbieter Login</h3>
        <input class="field" id="provEmail" type="email" placeholder="E-Mail" autocomplete="email" />
        <div style="height:10px"></div>
        <input class="field" id="provPass" type="password" placeholder="Passwort" autocomplete="current-password" />
        <button class="btn" type="button" id="btnProvLogin">Einloggen</button>
        <button class="btn secondary" type="button" id="btnProvBack">Zur√ºck</button>
        <p class="hint">Demo: beliebige E-Mail/Passwort ‚Üí du bist drin. (Sp√§ter Firebase Auth.)</p>
      </div>
    </section>

    <!-- PROVIDER APP -->
    <section class="view" id="v-provider-home">
      <div class="panel">
        <h3>Home</h3>
        <div class="hint" id="provHomeHello"></div>
        <button class="btn" type="button" id="btnNewListing">+ Neues Gericht erstellen</button>
        <button class="btn ghost" type="button" id="btnShareToday" style="display:none;">Heutige Inserate teilen</button>
      </div>

      <div style="height:12px"></div>
      <div class="panel">
        <h3>Aktive Inserate</h3>
        <div id="provActiveGrid" class="grid" style="margin-top:10px"></div>
        <div id="provActiveEmpty" class="hint">Noch keine aktiven Inserate.</div>
      </div>

      <div style="height:12px"></div>
      <div class="panel">
        <h3>Wochenvorschau</h3>
        <div class="dayrow" id="provWeekDays" style="padding:0 0 10px; max-width:none;"></div>
        <div id="provWeekPreview" class="hint">Noch nichts geplant.</div>
      </div>

      <div style="height:12px"></div>
      <div class="panel">
        <h3>Abholcodes heute</h3>
        <div id="provPickupStats" class="hint">Noch keine Abholcodes geplant.</div>
      </div>
    </section>

    <section class="view" id="v-provider-pickups">
      <div class="panel">
        <h3>Abholungen</h3>
        <div id="provPickupsEmpty" class="hint">
          Aktuell keine Abholungen geplant.<br>
          Geplante Abholungen sorgen fuer weniger Chaos.
        </div>
        <div id="provPickupsWrap" style="display:none;">
          <div class="hint" style="margin-top:8px;">Sortierung</div>
          <div class="answers" id="provPickupSort"></div>
          <div id="provPickupGroups" style="margin-top:10px;"></div>
        </div>
      </div>
    </section>

    <section class="view" id="v-provider-cookbook">
      <div class="panel">
        <h3>Mein Kochbuch</h3>
        <button class="btn" type="button" id="btnCookbookAdd">+ Gericht hinzuf√ºgen</button>
        <div style="height:10px"></div>
        <div id="cookbookList" class="hint">Noch leer.</div>
      </div>
    </section>

    <section class="view" id="v-provider-profile">
      <div class="panel">
        <h3>Mein Profil</h3>
        <div class="hint" id="provProfileHint"></div>
        <button class="btn" type="button" id="btnProvSetup">Meine Daten bearbeiten</button>
        <button class="btn secondary" type="button" id="btnBilling">Abrechnungen</button>
        <button class="btn secondary" type="button" id="btnProvFaq">FAQ / Hilfe</button>
        <button class="btn ghost" type="button" id="btnProvLogout">Logout</button>
      </div>

      <div id="provFaqBox" class="faq" style="display:none;">
        <details>
          <summary>Kein Abo / keine Provision?</summary>
          <p>Ja. Fixpreis pro Inserat (aktuell 4,99 ‚Ç¨). Keine Mindestlaufzeit.</p>
        </details>
        <details>
          <summary>Was kostet Abholcode?</summary>
          <p>49 Cent pro bezahltem Vorgang. (Auch wenn der Kunde mehrere Gerichte in einem Vorgang holt.)</p>
        </details>
        <details>
          <summary>Wie spare ich Zeit?</summary>
          <p>Speichere Gerichte im Kochbuch und ver√∂ffentliche sie mit 2‚Äì3 Taps erneut.</p>
        </details>
      </div>
    </section>

  </main>

  <!-- CUSTOMER bottom nav -->
  <nav class="bottom" id="customerNav">
    <button class="navbtn active" data-go="discover"><div class="ico">üçΩÔ∏è</div><div>Entdecken</div></button>
    <button class="navbtn" data-go="fav"><div class="ico">‚ù§Ô∏è</div><div>Favoriten</div></button>
    <button class="navbtn" data-go="cart"><div class="ico">üõí</div><div>Warenkorb</div></button>
    <button class="navbtn" data-go="profile"><div class="ico">üë§</div><div>Profil</div></button>
  </nav>

  <!-- PROVIDER bottom nav -->
  <nav class="bottom" id="providerNav" style="display:none;">
    <button class="navbtn active" data-pgo="provider-home"><div class="ico">üè†</div><div>Home</div></button>
    <button class="navbtn" data-pgo="provider-pickups"><div class="ico">üßæ</div><div>Abholungen</div></button>
    <button class="navbtn" data-pgo="provider-cookbook"><div class="ico">üìö</div><div>Kochbuch</div></button>
    <button class="navbtn" data-pgo="provider-profile"><div class="ico">‚öôÔ∏è</div><div>Profil</div></button>
  </nav>
</div>

<!-- Offer sheet -->
<div class="backdrop" id="bd" onclick="closeSheet()"></div>
<div class="sheet" id="sheet">
  <div class="handle"></div>
  <div class="sheet-img"><img id="sImg" alt="" /></div>
  <div class="sheet-body">
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;">
      <div>
        <div style="font-weight:950;font-size:18px" id="sDish"></div>
        <div style="color:#444;font-size:13px;margin-top:4px" id="sProvider"></div>
      </div>
      <div style="text-align:right">
        <div class="price" id="sPrice"></div>
        <div class="tag" id="sCat" style="margin-top:8px"></div>
      </div>
    </div>

    <div class="row"><span>Abholfenster</span><b id="sWindow"></b></div>
    <div class="row"><span>Adresse</span><a id="sAddr" href="#" target="_blank" rel="noopener">√∂ffnen</a></div>

    <div id="sAllergensWrap" style="display:none">
      <div class="row"><span>Allergene</span><span id="sAllergens" style="text-align:right;color:var(--muted)"></span></div>
    </div>
    <div id="sExtrasWrap" style="display:none">
      <div class="row"><span>Extras</span><span id="sExtras" style="text-align:right;color:var(--muted)"></span></div>
    </div>
    <div id="sReuseWrap" style="display:none">
      <div class="row"><span>Mehrweg / Pfand</span><span id="sReuse" style="text-align:right;color:var(--muted)"></span></div>
    </div>

    <button class="btn" type="button" id="btnAddCart">In den Warenkorb</button>
    <button class="btn secondary" type="button" id="btnShare">Teilen: ‚ÄûDas zum Mittagio?‚Äú</button>
    <button class="btn ghost" type="button" id="btnFav">‚ù§Ô∏è Favorit</button>
    <div class="mini" id="sCodeNote"></div>
  </div>
</div>

<!-- Provider Wizard sheet (single reusable) -->
<div class="backdrop" id="wbd" onclick="closeWizard()"></div>
<div class="sheet" id="wizard">
  <div class="handle"></div>
  <div class="sheet-body">
    <div class="wizard" id="wBox">
      <div class="w-top">
        <div class="w-title" id="wTitle">Setup</div>
        <div class="w-step" id="wStep">1/6</div>
      </div>
      <div class="w-q" id="wQ">‚Ä¶</div>
      <p class="w-help" id="wHelp"></p>
      <div id="wContent"></div>
      <div class="w-actions">
        <button class="btn secondary" type="button" id="wBack">Zur√ºck</button>
        <button class="btn" type="button" id="wNext">Weiter</button>
      </div>
    </div>
  </div>
</div>

<script>
  // --- Storage keys ---
  const LS = {
    offers: 'mittagio_offers_v1',
    favs: 'mittagio_favs_v1',
    cart: 'mittagio_cart_v1',
    customer: 'mittagio_customer_v1',
    provider: 'mittagio_provider_v1',
    cookbook: 'mittagio_cookbook_v1',
    week: 'mittagio_week_v1',
    mode: 'mittagio_mode_v1'
  };
  const load = (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch { return d; } };
  const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

  // --- State ---
  let mode = load(LS.mode, 'customer'); // 'customer' | 'provider'
  let offers = load(LS.offers, []);
  let favs = new Set(load(LS.favs, []));
  let cart = load(LS.cart, null); // {providerId, items:[{offerId, qty}]} or null
  let customer = load(LS.customer, { loggedIn:false, name:null });
  let provider = load(LS.provider, { loggedIn:false, email:null, profile:{ name:'', address:'', street:'', zip:'', city:'', mealWindow:'11:30 ‚Äì 14:00', logoData:'' } });
  let cookbook = load(LS.cookbook, []); // [{id, dish, category, price, allergens[], extras?, reuse? , photoData?}]
  let week = load(LS.week, {}); // { 'YYYY-MM-DD': [cookbookId,...] }

  const CATEGORIES = ['In meiner N√§he','Vegan','Vegetarisch','Mit Fleisch'];
  const CAT_MAP = {
    'Vegan':'Vegan',
    'Vegetarisch':'Vegetarisch',
    'Mit Fleisch':'Fleisch'
  };
  const DISH_SUGGESTIONS = [
    {name:'Kuerbissuppe', category:'Vegan'},
    {name:'Tomatensuppe mit Brot', category:'Vegan'},
    {name:'Pasta mit Gemuese', category:'Vegetarisch'},
    {name:'Kaesespaetzle', category:'Vegetarisch'},
    {name:'Salat Bowl', category:'Vegetarisch'},
    {name:'Falafel Teller', category:'Vegan'},
    {name:'Veggie Burger', category:'Vegan'},
    {name:'Schnitzel mit Pommes', category:'Fleisch'},
    {name:'Currywurst', category:'Fleisch'},
    {name:'Gulasch mit Spaetzle', category:'Fleisch'}
  ];

  // Day slider: today..+6
  function fmtDay(d){
    const wd = ['So','Mo','Di','Mi','Do','Fr','Sa'][d.getDay()];
    return `${wd} ${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}`;
  }
  function isoDate(d){ return d.toISOString().slice(0,10); }

  let activeCat = 'In meiner N√§he';
  let activeDay = isoDate(new Date());
  let providerWeekDay = isoDate(new Date());
  let pickupSort = 'time';

  // --- Seed demo offers if empty ---
  function seed(){
    if(offers.length) return;
    offers = [
      // Demo: 3 Anbieter √ó 4 Gerichte
      // Metzgerei Maier (Schorndorf) ‚Äî Vorab-Bezahlung aktiv
      {id: uid(), providerId: 'p_maier', providerName: 'Metzgerei Maier', address: 'Musterstra√üe 12, 73614 Schorndorf', title: 'Schnitzel mit Pommes', price: 7.90, time: '11:30 ‚Äì 14:00', diet: 'Fleisch', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1544025162-d76694265947?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true},
      {id: uid(), providerId: 'p_maier', providerName: 'Metzgerei Maier', address: 'Musterstra√üe 12, 73614 Schorndorf', title: 'Currywurst mit Br√∂tchen', price: 5.90, time: '11:30 ‚Äì 14:00', diet: 'Fleisch', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1550547660-d9450f859349?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true},
      {id: uid(), providerId: 'p_maier', providerName: 'Metzgerei Maier', address: 'Musterstra√üe 12, 73614 Schorndorf', title: 'Leberk√§se mit Kartoffelsalat', price: 6.50, time: '11:30 ‚Äì 14:00', diet: 'Fleisch', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1604908177522-937be1a2d0a0?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true},
      {id: uid(), providerId: 'p_maier', providerName: 'Metzgerei Maier', address: 'Musterstra√üe 12, 73614 Schorndorf', title: 'K√§sesp√§tzle', price: 6.90, time: '11:30 ‚Äì 14:00', diet: 'Vegetarisch', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1604908812253-9b998f4949b3?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true},

      // B√§ckerei & Bistro Sonneneck (Stuttgart) ‚Äî Vorab-Bezahlung NICHT aktiv
      {id: uid(), providerId: 'p_sonn', providerName: 'B√§ckerei Sonneneck', address: 'Hauptstra√üe 8, 70173 Stuttgart', title: 'Pasta-Bowl', price: 7.20, time: '11:00 ‚Äì 13:30', diet: 'Vegetarisch', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1523986371872-9d3ba2e2f642?auto=format&fit=crop&w=1200&q=60', hasPickupCode: false},
      {id: uid(), providerId: 'p_sonn', providerName: 'B√§ckerei Sonneneck', address: 'Hauptstra√üe 8, 70173 Stuttgart', title: 'H√§hnchen-Sandwich', price: 5.40, time: '11:00 ‚Äì 13:30', diet: 'Fleisch', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1528735602780-2552fd46c7af?auto=format&fit=crop&w=1200&q=60', hasPickupCode: false},
      {id: uid(), providerId: 'p_sonn', providerName: 'B√§ckerei Sonneneck', address: 'Hauptstra√üe 8, 70173 Stuttgart', title: 'Veggie Bowl', price: 6.80, time: '11:00 ‚Äì 13:30', diet: 'Vegan', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60', hasPickupCode: false},
      {id: uid(), providerId: 'p_sonn', providerName: 'B√§ckerei Sonneneck', address: 'Hauptstra√üe 8, 70173 Stuttgart', title: 'Tomatensuppe mit Brot', price: 4.90, time: '11:00 ‚Äì 13:30', diet: 'Vegetarisch', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1547592180-85f173990554?auto=format&fit=crop&w=1200&q=60', hasPickupCode: false},

      // Foodtruck ‚ÄûGr√ºne Pause‚Äú (Esslingen) ‚Äî Vorab-Bezahlung aktiv
      {id: uid(), providerId: 'p_green', providerName: 'Foodtruck Gr√ºne Pause', address: 'Marktplatz 1, 73728 Esslingen', title: 'Veggie-Burger mit S√º√ükartoffeln', price: 8.40, time: '12:00 ‚Äì 14:30', diet: 'Vegan', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1550547660-d9450f859349?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true},
      {id: uid(), providerId: 'p_green', providerName: 'Foodtruck Gr√ºne Pause', address: 'Marktplatz 1, 73728 Esslingen', title: 'Falafel-Teller mit Hummus', price: 7.90, time: '12:00 ‚Äì 14:30', diet: 'Vegan', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1613408181925-78e9f9a49f3f?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true},
      {id: uid(), providerId: 'p_green', providerName: 'Foodtruck Gr√ºne Pause', address: 'Marktplatz 1, 73728 Esslingen', title: 'Pasta mit Gem√ºse & Pesto', price: 7.50, time: '12:00 ‚Äì 14:30', diet: 'Vegetarisch', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1523986371872-9d3ba2e2f642?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true},
      {id: uid(), providerId: 'p_green', providerName: 'Foodtruck Gr√ºne Pause', address: 'Marktplatz 1, 73728 Esslingen', title: 'Ofenkartoffel mit Kr√§uterquark', price: 6.90, time: '12:00 ‚Äì 14:30', diet: 'Vegetarisch', day: '2026-01-18', img: 'https://images.unsplash.com/photo-1518779578993-ec3579fee39f?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true},

      // Ein paar Angebote f√ºr morgen/√ºbermorgen (damit die Datums-Tabs nicht leer wirken)
      {id: uid(), providerId: 'p_maier', providerName: 'Metzgerei Maier', address: 'Musterstra√üe 12, 73614 Schorndorf', title: 'Gulasch mit Sp√§tzle', price: 8.20, time: '11:30 ‚Äì 14:00', diet: 'Fleisch', day: '2026-01-19', img: 'https://images.unsplash.com/photo-1604908177522-937be1a2d0a0?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true},
      {id: uid(), providerId: 'p_sonn', providerName: 'B√§ckerei Sonneneck', address: 'Hauptstra√üe 8, 70173 Stuttgart', title: 'K√ºrbissuppe', price: 5.20, time: '11:00 ‚Äì 13:30', diet: 'Vegan', day: '2026-01-19', img: 'https://images.unsplash.com/photo-1547592180-85f173990554?auto=format&fit=crop&w=1200&q=60', hasPickupCode: false},
      {id: uid(), providerId: 'p_green', providerName: 'Foodtruck Gr√ºne Pause', address: 'Marktplatz 1, 73728 Esslingen', title: 'Wrap (Vegan)', price: 7.10, time: '12:00 ‚Äì 14:30', diet: 'Vegan', day: '2026-01-20', img: 'https://images.unsplash.com/photo-1528735602780-2552fd46c7af?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true},
    ];
    save(LS.offers, offers);
  }

  // --- UI helpers ---
  function euro(n){
    const v = Number(n||0);
    return v.toFixed(2).replace('.',',') + ' ‚Ç¨';
  }
  function cryptoId(){
    return 'id_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
  }
  function esc(s){
    return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[c]));
  }

  const DEFAULT_MEAL_WINDOW = '11:30 ‚Äì 14:00';

  function buildAddress(p){
    if(p && p.address && String(p.address).trim()) return String(p.address).trim();
    const rest = [p?.zip, p?.city].filter(Boolean).join(' ').trim();
    return [p?.street, rest].filter(Boolean).join(', ');
  }

  function parseAddress(addr){
    const raw = String(addr||'').trim();
    const out = { address: raw, street:'', zip:'', city:'' };
    if(!raw) return out;
    const parts = raw.split(',').map(s=>s.trim()).filter(Boolean);
    if(parts.length){ out.street = parts[0]; }
    if(parts.length > 1){
      const rest = parts.slice(1).join(', ');
      const m = rest.match(/^(\d{4,6})\s*(.*)$/);
      if(m){ out.zip = m[1]; out.city = m[2] || ''; }
      else { out.city = rest; }
    }
    return out;
  }

  function normalizeProviderProfile(p){
    const base = { name:'', address:'', street:'', zip:'', city:'', mealWindow:DEFAULT_MEAL_WINDOW, logoData:'' };
    const out = {...base, ...(p||{})};
    if(!out.address){ out.address = buildAddress(out); }
    if(!out.mealWindow){ out.mealWindow = DEFAULT_MEAL_WINDOW; }
    return out;
  }

  function normalizeOffer(o){
    const out = {...(o||{})};
    if(!out.dish && out.title) out.dish = out.title;
    if(!out.imageUrl && out.img) out.imageUrl = out.img;
    if(!out.pickupWindow && out.time) out.pickupWindow = out.time;
    if(!out.category && out.diet) out.category = out.diet;

    if(out.address && (!out.providerStreet && !out.providerZip && !out.providerCity)){
      const parsed = parseAddress(out.address);
      out.providerStreet = out.providerStreet || parsed.street || '';
      out.providerZip = out.providerZip || parsed.zip || '';
      out.providerCity = out.providerCity || parsed.city || '';
    }
    out.providerStreet = out.providerStreet || '';
    out.providerZip = out.providerZip || '';
    out.providerCity = out.providerCity || '';
    out.dineInPossible = !!out.dineInPossible;
    return out;
  }

  // --- Navigation ---
  const views = {
    discover:'v-discover', fav:'v-fav', cart:'v-cart', profile:'v-profile',
    providerLogin:'v-provider-login',
    providerHome:'v-provider-home', providerPickups:'v-provider-pickups', providerCookbook:'v-provider-cookbook', providerProfile:'v-provider-profile'
  };

  function setCustomerNavActive(go){
    document.querySelectorAll('#customerNav .navbtn').forEach(b=>b.classList.toggle('active', b.dataset.go===go));
  }
  function setProviderNavActive(go){
    document.querySelectorAll('#providerNav .navbtn').forEach(b=>b.classList.toggle('active', b.dataset.pgo===go));
  }

  function showView(id){
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo({top:0,behavior:'smooth'});
  }

  function setMode(next){
    mode = next;
    save(LS.mode, mode);

    const isProv = mode==='provider';
    document.getElementById('customerNav').style.display = isProv ? 'none' : 'flex';
    document.getElementById('providerNav').style.display = isProv ? 'flex' : 'none';
    document.getElementById('discoverFilters').style.display = isProv ? 'none' : 'block';
    document.getElementById('modePill').style.display = isProv ? 'inline-flex' : 'none';

    if(isProv){
      // provider must be logged in
      if(!provider.loggedIn){
        showView(views.providerLogin);
      } else {
        showProviderHome();
      }
    } else {
      showDiscover();
    }
  }

  // --- Customer views ---
  function showDiscover(){
    setCustomerNavActive('discover');
    showView(views.discover);
    renderDiscover();
  }
  function showFav(){
    setCustomerNavActive('fav');
    showView(views.fav);
    renderFavorites();
  }
  function showCart(){
    setCustomerNavActive('cart');
    showView(views.cart);
    renderCart();
  }
  function showProfile(){
    setCustomerNavActive('profile');
    showView(views.profile);
    document.getElementById('customerStatus').textContent = customer.loggedIn ? `Angemeldet als ${customer.name || 'Kunde'}` : 'Nicht angemeldet (Demo).';
  }

  // --- Provider views ---
  function showProviderHome(){
    setProviderNavActive('provider-home');
    showView(views.providerHome);
    renderProviderHome();
  }
  function showProviderPickups(){
    setProviderNavActive('provider-pickups');
    showView(views.providerPickups);
    renderProviderPickups();
  }
  function showProviderCookbook(){
    setProviderNavActive('provider-cookbook');
    showView(views.providerCookbook);
    renderCookbook();
  }
  function showProviderProfile(){
    setProviderNavActive('provider-profile');
    showView(views.providerProfile);
    renderProviderProfile();
  }

  // --- Chips render ---
  function renderChips(){
    const catEl = document.getElementById('catChips');
    catEl.innerHTML='';
    CATEGORIES.forEach(c=>{
      const b=document.createElement('button');
      b.className='chip'+(activeCat===c?' active':'');
      b.textContent=c;
      b.onclick=()=>{ activeCat=c; renderChips(); renderDiscover(); };
      catEl.appendChild(b);
    });

    const dayEl = document.getElementById('dayChips');
    dayEl.innerHTML='';
    for(let i=0;i<7;i++){
      const d=new Date(); d.setDate(d.getDate()+i);
      const key=isoDate(d);
      const b=document.createElement('button');
      b.className='day'+(activeDay===key?' active':'');
      b.textContent = i===0 ? 'Heute' : (i===1 ? 'Morgen' : fmtDay(d));
      b.onclick=()=>{ activeDay=key; renderChips(); renderDiscover(); };
      dayEl.appendChild(b);
    }
  }

  // --- Discover render ---
  function renderDiscover(){
    const grid=document.getElementById('offerGrid');
    const empty=document.getElementById('emptyOffers');

    let list = offers.filter(o => o.day === activeDay);

    if(activeCat !== 'In meiner N√§he'){
      const cat = CAT_MAP[activeCat];
      list = list.filter(o => (o.category||'') === cat);
    }

    grid.innerHTML='';
    empty.style.display = list.length ? 'none' : 'block';

    list.forEach(o=> grid.appendChild(offerCard(o)));
  }

  function offerCard(o, opts={}){
    const data = normalizeOffer(o);
    const interactive = opts.interactive !== false;
    const card=document.createElement('div');
    card.className='card';
    if(interactive){
      card.onclick=()=>openOffer(data.id);
    } else {
      card.style.cursor='default';
    }

    const img=document.createElement('div');
    img.className='img';
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    img.innerHTML = `
      <img alt="${esc(data.dish||'')}" src="${esc(imgSrc)}" />
      ${data.dineInPossible?'<div class="badge dine">Vor Ort</div>':''}
      ${data.hasPickupCode?'<div class="badge code">Abholcode</div>':''}
    `;

    const heart=document.createElement('button');
    heart.className='heart'+(favs.has(data.id)?' on':'');
    heart.type='button';
    heart.textContent = favs.has(data.id)?'‚ù§':'‚ô°';
    heart.onclick=(e)=>{ e.stopPropagation(); toggleFav(data.id); };

    const plogo = data.providerLogoData ? `<img src="${data.providerLogoData}" alt="Logo" />` : `<img src="assets/provider-placeholder.png" alt="Logo" />`;

    const providerRow=document.createElement('div');
    providerRow.className='provider-logo';
    providerRow.innerHTML = `
      <div class="plogo">${plogo}</div>
      <div class="pname">${esc(data.providerName||'Anbieter')}</div>
    `;

    const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity});
    const body=document.createElement('div');
    body.className='body';
    body.innerHTML = `
      <p class="title">${esc(data.dish||'')}</p>
      <p class="sub">${esc(addr || '')}</p>
      <div class="meta">
        <div class="price">${euro(data.price)}</div>
        <div class="right">
          <div>‚è±Ô∏è ${esc(data.pickupWindow||'')}</div>
          <div class="tag">${esc(data.category||'')}</div>
        </div>
      </div>
    `;

    card.appendChild(img);
    if(interactive){ card.appendChild(heart); }
    card.appendChild(providerRow);
    card.appendChild(body);
    return card;
  }

  function providerCard(o){
    const data = normalizeOffer(o);
    const card=document.createElement('div');
    card.className='card';
    card.style.cursor='default';

    const profile = normalizeProviderProfile(provider.profile || {});
    const imgSrc = data.imageUrl || data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    const windowText = data.pickupWindow || profile.mealWindow || '';

    const img=document.createElement('div');
    img.className='img';
    img.innerHTML = `
      <img alt="${esc(data.dish||'Gericht')}" src="${esc(imgSrc)}" />
      ${data.hasPickupCode?'<div class="badge code">Abholcode</div>':''}
    `;

    const body=document.createElement('div');
    body.className='body';
    body.innerHTML = `
      <p class="title">${esc(data.dish||'Gericht')}</p>
      <p class="sub">Essenszeit: ${esc(windowText || '‚Äî')}</p>
      <div class="meta">
        <div class="price">${euro(data.price)}</div>
        <div class="right">
          <div>${esc(data.category||'')}</div>
        </div>
      </div>
    `;

    card.appendChild(img);
    card.appendChild(body);
    return card;
  }

  function toggleFav(id){
    if(favs.has(id)) favs.delete(id); else favs.add(id);
    save(LS.favs, Array.from(favs));
    renderDiscover();
    renderFavorites();
    updateSheetFav();
  }

  function renderFavorites(){
    const grid=document.getElementById('favGrid');
    const empty=document.getElementById('emptyFav');
    const list = offers.filter(o => favs.has(o.id));
    grid.innerHTML='';
    empty.style.display = list.length ? 'none' : 'block';
    list.forEach(o=>grid.appendChild(offerCard(o)));
  }

  // --- Offer sheet ---
  let activeOfferId=null;
  function openOffer(id){
    const raw = offers.find(x=>x.id===id);
    if(!raw) return;
    const o = normalizeOffer(raw);
    activeOfferId=id;

    document.getElementById('sImg').src = o.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    document.getElementById('sDish').textContent = o.dish || '';
    document.getElementById('sProvider').textContent = o.providerName || '';
    document.getElementById('sPrice').textContent = euro(o.price);
    document.getElementById('sCat').textContent = o.category || '';
    document.getElementById('sWindow').textContent = o.pickupWindow || '';

    const addr = buildAddress({address:o.address, street:o.providerStreet, zip:o.providerZip, city:o.providerCity});
    const maps = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
    const a = document.getElementById('sAddr');
    a.textContent = addr || '‚Äì';
    a.href = maps;

    // Allergens
    const aw = document.getElementById('sAllergensWrap');
    if(o.allergens && o.allergens.length){
      aw.style.display='block';
      document.getElementById('sAllergens').textContent = o.allergens.join(', ');
    } else aw.style.display='none';

    // Extras
    const ew = document.getElementById('sExtrasWrap');
    if(o.extras && o.extras.length){
      ew.style.display='block';
      document.getElementById('sExtras').textContent = o.extras.map(e=>`${e.name} (+${euro(e.price)})`).join(' ¬∑ ');
    } else ew.style.display='none';

    // Reuse
    const rw = document.getElementById('sReuseWrap');
    if(o.reuse && o.reuse.enabled){
      rw.style.display='block';
      document.getElementById('sReuse').textContent = `Pfand ${euro(o.reuse.deposit)}`;
    } else rw.style.display='none';

    document.getElementById('sCodeNote').innerHTML = o.hasPickupCode
      ? '‚úÖ Dieses Angebot unterst√ºtzt <b>Abholcode</b> (schnell & ohne Chaos).' 
      : '‚ÑπÔ∏è Dieses Angebot ist nur Inserat (ohne Abholcode).';

    updateSheetFav();

    document.getElementById('bd').classList.add('active');
    document.getElementById('sheet').classList.add('active');
  }

  function updateSheetFav(){
    const b = document.getElementById('btnFav');
    if(!activeOfferId){ b.textContent='‚ù§Ô∏è Favorit'; return; }
    b.textContent = favs.has(activeOfferId) ? '‚ù§Ô∏è Aus Favoriten entfernen' : '‚ù§Ô∏è Als Favorit speichern';
  }

  function closeSheet(){
    document.getElementById('bd').classList.remove('active');
    document.getElementById('sheet').classList.remove('active');
  }

  document.getElementById('btnFav').onclick=()=>{ if(activeOfferId) toggleFav(activeOfferId); };
  document.getElementById('btnShare').onclick=()=>{
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    const txt = `Das zum Mittagio? üçΩÔ∏è\n${o.dish} ¬∑ ${euro(o.price)}\nAbholfenster: ${o.pickupWindow}\n${o.providerName}`;
    if(navigator.share){ navigator.share({title:'Mittagio', text:txt, url:location.href}).catch(()=>{}); }
    else prompt('Kopieren & teilen:', txt + '\n' + location.href);
  };

  document.getElementById('btnAddCart').onclick=()=>{
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    // cart: one provider only
    if(cart && cart.providerId !== o.providerId){
      alert('MVP: Warenkorb nur f√ºr einen Anbieter. Bitte zuerst Warenkorb leeren.');
      return;
    }
    if(!cart){ cart = { providerId:o.providerId, providerName:o.providerName, items:[] }; }
    const idx = cart.items.findIndex(i=>i.offerId===o.id);
    if(idx>=0) cart.items[idx].qty += 1; else cart.items.push({offerId:o.id, qty:1});
    save(LS.cart, cart);
    closeSheet();
    showCart();
  };

  // --- Cart ---
  function renderCart(){
    const box=document.getElementById('cartBox');
    const btn=document.getElementById('btnCheckout');
    const note=document.getElementById('cartNote');

    if(!cart || !cart.items.length){
      box.textContent='Noch leer.';
      btn.style.display='none';
      note.style.display='none';
      return;
    }

    let total=0;
    const lines = cart.items.map(it=>{
      const o = offers.find(x=>x.id===it.offerId);
      if(!o) return '';
      total += Number(o.price||0) * it.qty;
      return `‚Ä¢ ${o.dish} √ó ${it.qty} = ${euro(Number(o.price||0)*it.qty)}`;
    }).filter(Boolean);

    box.innerHTML = `<b>${esc(cart.providerName)}</b><br>${lines.join('<br>')}<br><br><b>Gesamt:</b> ${euro(total)}<br><br><a href="#" id="clearCart">Warenkorb leeren</a>`;

    document.getElementById('clearCart').onclick=(e)=>{ e.preventDefault(); cart=null; save(LS.cart, cart); renderCart(); };

    btn.style.display='block';
    note.style.display='block';
  }

  document.getElementById('btnCheckout').onclick=()=>{
    if(!customer.loggedIn){
      alert('F√ºr die Demo: Bitte zuerst als Kunde anmelden (Profil).');
      showProfile();
      return;
    }
    alert('Checkout (Demo): Stripe/PayPal bauen wir als n√§chstes sauber ein.');
  };

  // --- Customer login (demo) ---
  document.getElementById('btnCustomerLogin').onclick=()=>{
    customer.loggedIn = true;
    customer.name = customer.name || 'Mike';
    save(LS.customer, customer);
    showProfile();
  };

  // --- Provider entry ---
  document.getElementById('btnProviderEntry').onclick=()=>{
    // switch mode; show provider login page
    setMode('provider');
  };
  document.getElementById('btnProvBack').onclick=()=>{ setMode('customer'); showProfile(); };

  document.getElementById('btnProvLogin').onclick=()=>{
    const email = document.getElementById('provEmail').value.trim();
    const pass = document.getElementById('provPass').value.trim();
    if(!email || !pass){ alert('Bitte E-Mail und Passwort eingeben.'); return; }
    provider.loggedIn = true;
    provider.email = email;
    save(LS.provider, provider);
    showProviderHome();
  };

  document.getElementById('btnProvLogout').onclick=()=>{
    provider.loggedIn=false;
    save(LS.provider, provider);
    setMode('customer');
    showProfile();
  };

  // Provider nav handlers
  document.getElementById('providerNav').addEventListener('click',(e)=>{
    const b = e.target.closest('button');
    if(!b) return;
    const go = b.dataset.pgo;
    if(go==='provider-home') showProviderHome();
    if(go==='provider-pickups') showProviderPickups();
    if(go==='provider-cookbook') showProviderCookbook();
    if(go==='provider-profile') showProviderProfile();
  });

  // Customer nav handlers
  document.getElementById('customerNav').addEventListener('click',(e)=>{
    const b = e.target.closest('button');
    if(!b) return;
    const go = b.dataset.go;
    if(go==='discover') showDiscover();
    if(go==='fav') showFav();
    if(go==='cart') showCart();
    if(go==='profile') showProfile();
  });

  // --- Provider home renders ---
  function renderProviderHome(){
    const profile = normalizeProviderProfile(provider.profile || {});
    document.getElementById('provHomeHello').textContent = `Eingeloggt als ${profile.name || provider.email}`;

    const todayKey = isoDate(new Date());
    const mineActive = offers.filter(o => o.providerId === providerId() && o.day >= todayKey);
    const mineToday = mineActive.filter(o => o.day === todayKey);

    const grid = document.getElementById('provActiveGrid');
    const empty = document.getElementById('provActiveEmpty');
    grid.innerHTML = '';
    if(!mineActive.length){
      empty.style.display='block';
    } else {
      empty.style.display='none';
      mineActive.slice(0,6).forEach(o=> grid.appendChild(providerCard(o)));
    }

    renderProviderWeekPreview();

    const stats = document.getElementById('provPickupStats');
    const withCodeToday = mineToday.filter(o=>o.hasPickupCode).length;
    stats.textContent = withCodeToday ? `${withCodeToday} aktive Abholcode-Inserate heute.` : 'Noch keine Abholcodes geplant.';

    const shareBtn = document.getElementById('btnShareToday');
    shareBtn.style.display = mineToday.length ? 'block' : 'none';
  }

  function renderProviderWeekPreview(){
    const dayWrap = document.getElementById('provWeekDays');
    const list = document.getElementById('provWeekPreview');
    if(!dayWrap || !list) return;

    dayWrap.innerHTML = '';
    for(let i=0;i<5;i++){
      const d = new Date(); d.setDate(d.getDate()+i);
      const key = isoDate(d);
      const b = document.createElement('button');
      b.className = 'day' + (providerWeekDay===key ? ' active' : '');
      b.textContent = i===0 ? 'Heute' : (i===1 ? 'Morgen' : fmtDay(d));
      b.onclick=()=>{ providerWeekDay = key; renderProviderWeekPreview(); };
      dayWrap.appendChild(b);
    }

    const items = (week[providerWeekDay]||[]).filter(x=>x.providerId===providerId());
    if(!items.length){
      list.textContent = 'Noch nichts geplant.';
      return;
    }
    list.innerHTML = items.map(i=>`‚Ä¢ ${esc(i.dish)}`).join('<br>');
  }

  function buildPickupGroups(){
    const todayKey = isoDate(new Date());
    const mineToday = offers.filter(o => o.providerId === providerId() && o.hasPickupCode && o.day === todayKey);
    if(!mineToday.length) return [];

    if(mineToday.length === 1){
      return [{time:'11:30', group:'A', codes:['A1','A2','A3']}];
    }
    if(mineToday.length === 2){
      return [
        {time:'11:30', group:'A', codes:['A1','A2','A3','A4']},
        {time:'12:00', group:'B', codes:['B1','B2','B3']}
      ];
    }
    return [
      {time:'11:30', group:'A', codes:['A1','A2','A3','A4','A5']},
      {time:'12:00', group:'B', codes:['B1','B2','B3']},
      {time:'12:30', group:'C', codes:['C1','C2']}
    ];
  }

  function renderProviderPickups(){
    const empty = document.getElementById('provPickupsEmpty');
    const wrap = document.getElementById('provPickupsWrap');
    const sortEl = document.getElementById('provPickupSort');
    const groupsEl = document.getElementById('provPickupGroups');
    if(!empty || !wrap || !sortEl || !groupsEl) return;

    const groups = buildPickupGroups();
    if(!groups.length){
      empty.style.display='block';
      wrap.style.display='none';
      return;
    }
    empty.style.display='none';
    wrap.style.display='block';

    sortEl.innerHTML='';
    [
      {id:'time', label:'Zeit'},
      {id:'code', label:'Code'},
      {id:'group', label:'Gruppe'}
    ].forEach(s=>{
      const b=document.createElement('button');
      b.type='button';
      b.className='ans'+(pickupSort===s.id?' on':'');
      b.textContent=s.label;
      b.onclick=()=>{ pickupSort=s.id; renderProviderPickups(); };
      sortEl.appendChild(b);
    });

    const list = [...groups];
    if(pickupSort==='time') list.sort((a,b)=>a.time.localeCompare(b.time));
    if(pickupSort==='code') list.sort((a,b)=>(a.codes[0]||'').localeCompare(b.codes[0]||''));
    if(pickupSort==='group') list.sort((a,b)=>a.group.localeCompare(b.group));

    groupsEl.innerHTML='';
    list.forEach(g=>{
      const box=document.createElement('div');
      box.className='pickup-group';
      box.innerHTML = `
        <div class="pickup-head">
          <div>Gruppe ${esc(g.group)}</div>
          <div class="pickup-sub">${esc(g.time)}</div>
        </div>
        <div style="margin-top:6px;">
          ${g.codes.map(c=>`<span class="code-chip">${esc(c)}</span>`).join('')}
        </div>
      `;
      groupsEl.appendChild(box);
    });
  }

  function renderProviderProfile(){
    const p = normalizeProviderProfile(provider.profile || {});
    const addr = buildAddress(p);
    document.getElementById('provProfileHint').innerHTML = `
      <b>${esc(p.name || 'Name fehlt')}</b><br>
      ${esc(addr || 'Adresse fehlt')}<br>
      Essenszeit: <b>${esc(p.mealWindow || DEFAULT_MEAL_WINDOW)}</b><br>
      ${p.logoData ? 'Logo: ‚úÖ' : 'Logo: ‚Äî'}
    `;
  }

  document.getElementById('btnProvFaq').onclick=()=>{
    const box = document.getElementById('provFaqBox');
    box.style.display = box.style.display==='none' ? 'block' : 'none';
  };

  document.getElementById('btnBilling').onclick=()=>{
    alert('Abrechnungen (MVP): monatliche Sammelrechnung. Dashboard + Stripe Tax bauen wir danach.');
  };

  // --- Provider actions ---
  document.getElementById('btnNewListing').onclick=()=> startWizard('listing');
  document.getElementById('btnCookbookAdd').onclick=()=> startWizard('cookbook');
  document.getElementById('btnProvSetup').onclick=()=> startWizard('provider');

  document.getElementById('btnShareToday').onclick=()=>{
    const todayKey = isoDate(new Date());
    const mineToday = offers.filter(o => o.providerId === providerId() && o.day === todayKey);
    if(!mineToday.length) return;
    const txt = `Mittagio ‚Äì heutige Angebote\n` + mineToday.map(o=>`‚Ä¢ ${o.dish} (${euro(o.price)}) ‚Äî ${o.pickupWindow}`).join('\n');
    if(navigator.share){ navigator.share({title:'Mittagio', text:txt, url:location.href}).catch(()=>{}); }
    else prompt('Kopieren & teilen:', txt);
  };

  // Provider ID (for demo)
  function providerId(){
    // stable per email
    const e = provider.email || 'provider';
    return 'prov_' + btoa(unescape(encodeURIComponent(e))).slice(0,16);
  }

  // --- Cookbook ---
  function renderCookbook(){
    const box = document.getElementById('cookbookList');
    const mine = cookbook.filter(x=>x.providerId===providerId());
    if(!mine.length){ box.textContent='Noch keine gespeicherten Gerichte.'; return; }
    box.innerHTML = mine.map(x=>{
      const sold = offers.filter(o=>o.providerId===providerId() && o.dish===x.dish).length; // simple proxy
      return `
        <div style="padding:10px 0;border-top:1px solid #eee">
          <b>${esc(x.dish)}</b> ¬∑ ${esc(x.category)} ¬∑ ${euro(x.price)}<br>
          <span class="hint">Letzte Nutzung (Proxy): ${sold}√ó</span><br>
          <a href="#" data-cb="${x.id}" class="cbUse">[als Inserat]</a>
          &nbsp; <a href="#" data-cb="${x.id}" class="cbWeek">[zum Wochenplan]</a>
        </div>
      `;
    }).join('');

    box.querySelectorAll('.cbUse').forEach(a=>{
      a.onclick=(e)=>{
        e.preventDefault();
        const id=a.getAttribute('data-cb');
        startWizard('listing', {fromCookbookId:id});
      };
    });
    box.querySelectorAll('.cbWeek').forEach(a=>{
      a.onclick=(e)=>{
        e.preventDefault();
        const id=a.getAttribute('data-cb');
        startWizard('week', {fromCookbookId:id});
      };
    });
  }

  // --- Wizard engine (Provider profile / Listing / Cookbook / Week) ---
  let w = { kind:null, step:0, data:{}, ctx:{} };

  const ALLERGENS_14 = [
    {name:'Gluten', short:'GL'},
    {name:'Krebstiere', short:'KR'},
    {name:'Eier', short:'EI'},
    {name:'Fisch', short:'FI'},
    {name:'Erdnuesse', short:'EN'},
    {name:'Soja', short:'SO'},
    {name:'Milch', short:'MI'},
    {name:'Schalenfruechte', short:'SF'},
    {name:'Sellerie', short:'SE'},
    {name:'Senf', short:'SN'},
    {name:'Sesam', short:'SS'},
    {name:'Sulfite', short:'SU'},
    {name:'Lupinen', short:'LU'},
    {name:'Weichtiere', short:'WE'}
  ];

  function openWizard(){
    document.getElementById('wbd').classList.add('active');
    document.getElementById('wizard').classList.add('active');
  }
  function closeWizard(){
    document.getElementById('wbd').classList.remove('active');
    document.getElementById('wizard').classList.remove('active');
  }

  function startWizard(kind, ctx={}){
    w = { kind, step:0, data:{}, ctx };

    if(kind==='provider'){
      w.data = normalizeProviderProfile(JSON.parse(JSON.stringify(provider.profile||{})));
      buildProviderStep();
    }
    if(kind==='cookbook'){
      w.data = {
        providerId: providerId(),
        dish:'', category:'Vegetarisch', price:0,
        allergens:[],
        extras:[],
        reuse:{enabled:false, deposit:0},
        photoData:''
      };
      buildCookbookStep();
    }
    if(kind==='listing'){
      const profile = normalizeProviderProfile(provider.profile || {});
      // if from cookbook
      if(ctx.fromCookbookId){
        const x = cookbook.find(c=>c.id===ctx.fromCookbookId);
        if(x){ w.data = JSON.parse(JSON.stringify(x)); }
      } else {
        w.data = {
          providerId: providerId(),
          dish:'', category:'Vegetarisch', price:0,
          pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
          hasPickupCode:false,
          dineInPossible:false,
          allergens:[],
          extras:[],
          reuse:{enabled:false, deposit:0},
          photoData:''
        };
      }
      w.data.providerId = providerId();
      w.data.category = w.data.category || 'Vegetarisch';
      w.data.price = Number(w.data.price||0);
      w.data.pickupWindow = w.data.pickupWindow || profile.mealWindow || DEFAULT_MEAL_WINDOW;
      w.data.hasPickupCode = !!w.data.hasPickupCode;
      w.data.dineInPossible = !!w.data.dineInPossible;
      w.data.allergens = Array.isArray(w.data.allergens) ? w.data.allergens : [];
      w.data.extras = Array.isArray(w.data.extras) ? w.data.extras : [];
      if(!w.data.reuse) w.data.reuse = {enabled:false, deposit:0};
      buildListingStep();
    }
    if(kind==='week'){
      // schedule cookbook item to a date
      const x = cookbook.find(c=>c.id===ctx.fromCookbookId);
      if(!x){ alert('Bitte erst ein Gericht im Kochbuch speichern.'); return; }
      w.data = { cookbookId:x.id, date: isoDate(new Date()) };
      buildWeekStep();
    }

    openWizard();
  }

  // Common wizard buttons
  const wBackBtn = document.getElementById('wBack');
  const wNextBtn = document.getElementById('wNext');
  const defaultWizardNext = ()=>{ w.step += 1; rebuildWizard(); };
  function setWizardNextDefault(){ wNextBtn.onclick = defaultWizardNext; }

  wBackBtn.onclick=()=>{
    if(w.step===0){ closeWizard(); return; }
    w.step -= 1;
    rebuildWizard();
  };
  setWizardNextDefault();

  function setWizardHeader(title, stepText){
    document.getElementById('wTitle').textContent = title;
    document.getElementById('wStep').textContent = stepText;
  }
  function setWizardQuestion(q, help=''){ 
    document.getElementById('wQ').textContent = q;
    document.getElementById('wHelp').textContent = help;
  }
  function setWizardContent(node){
    const c = document.getElementById('wContent');
    c.innerHTML='';
    c.appendChild(node);
  }

  function rebuildWizard(){
    if(w.kind==='provider') return buildProviderStep();
    if(w.kind==='cookbook') return buildCookbookStep();
    if(w.kind==='listing') return buildListingStep();
    if(w.kind==='week') return buildWeekStep();
  }

  function saveProviderProfileFromWizard(){
    const parsed = parseAddress(w.data.address || '');
    const street = parsed.street || w.data.street || '';
    const zip = parsed.zip || w.data.zip || '';
    const city = parsed.city || w.data.city || '';
    const address = parsed.address || buildAddress({street, zip, city});

    provider.profile = {
      name: w.data.name||'',
      address,
      street,
      zip,
      city,
      mealWindow: w.data.mealWindow || DEFAULT_MEAL_WINDOW,
      logoData: w.data.logoData||''
    };
    save(LS.provider, provider);
    renderProviderProfile();
    renderProviderHome();
  }

  // --- Provider onboarding (step-by-step, no form) ---
  function buildProviderStep(){
    setWizardNextDefault();
    const total = 5;
    const stepText = `Schritt ${Math.min(w.step+1,total)} von ${total}`;
    setWizardHeader('Anbieter-Profil', stepText);

    if(w.step >= total){
      saveProviderProfileFromWizard();
      closeWizard();
      alert('Profil ist bereit ‚úÖ');
      return;
    }

    if(w.step===0){
      setWizardQuestion('Wie hei√üt dein Betrieb?', 'Du kannst den Namen jederzeit √§ndern.');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field';
      input.placeholder='z.B. Metzgerei M√ºller';
      input.value = w.data.name || '';
      input.oninput=()=>{ w.data.name=input.value; };
      box.appendChild(input);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===1){
      setWizardQuestion('Adresse deines Betriebs?', 'Auto-Vervollst√§ndigung folgt (Demo).');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field';
      input.placeholder='Musterstra√üe 12, 73614 Schorndorf';
      input.value = w.data.address || buildAddress(w.data) || '';
      input.oninput=()=>{ w.data.address=input.value; };
      box.appendChild(input);
      const h=document.createElement('div'); h.className='hint'; h.textContent='Tipp: Stra√üe, PLZ, Ort ‚Äì getrennt mit Komma.';
      box.appendChild(h);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===2){
      setWizardQuestion('Wann k√∂nnen G√§ste dein Essen genie√üen?', 'Standard aus Profil, optional anpassen.');
      if(!w.data.mealWindow) w.data.mealWindow = DEFAULT_MEAL_WINDOW;

      const current = w.data.mealWindow || DEFAULT_MEAL_WINDOW;
      const split = current.includes('‚Äì') ? current.split('‚Äì') : current.split('-');
      const startDefault = split[0] ? split[0].trim() : '11:30';
      const endDefault = split[1] ? split[1].trim() : '14:00';
      if(!w.data.mealStart) w.data.mealStart = startDefault;
      if(!w.data.mealEnd) w.data.mealEnd = endDefault;

      const box=document.createElement('div');
      const summary=document.createElement('div');
      summary.className='panel';
      summary.innerHTML = `<b>${esc(current)}</b><div class="hint">Standard aus Profil</div>`;
      box.appendChild(summary);

      const actions=document.createElement('div');
      actions.className='answers';
      const toggle=document.createElement('button');
      toggle.type='button';
      toggle.className='ans';
      toggle.textContent = w.data.mealCustom ? 'Fertig' : 'Essenszeit √§ndern';
      toggle.onclick=()=>{
        w.data.mealCustom = !w.data.mealCustom;
        rebuildWizard();
      };
      actions.appendChild(toggle);
      box.appendChild(actions);

      if(w.data.mealCustom){
        const updateMealWindow = ()=>{
          if(w.data.mealStart && w.data.mealEnd){
            w.data.mealWindow = `${w.data.mealStart} ‚Äì ${w.data.mealEnd}`;
          }
        };

        const startLabel=document.createElement('div'); startLabel.className='hint'; startLabel.textContent='Start';
        const startRow=document.createElement('div'); startRow.className='answers';
        ['10:30','11:00','11:30','12:00'].forEach(t=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.mealStart===t?' on':'');
          b.textContent=t;
          b.onclick=()=>{ w.data.mealStart=t; updateMealWindow(); rebuildWizard(); };
          startRow.appendChild(b);
        });

        const endLabel=document.createElement('div'); endLabel.className='hint'; endLabel.textContent='Ende';
        const endRow=document.createElement('div'); endRow.className='answers';
        ['13:00','13:30','14:00','14:30'].forEach(t=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.mealEnd===t?' on':'');
          b.textContent=t;
          b.onclick=()=>{ w.data.mealEnd=t; updateMealWindow(); rebuildWizard(); };
          endRow.appendChild(b);
        });

        box.appendChild(document.createElement('div')).style.height='10px';
        box.appendChild(startLabel);
        box.appendChild(startRow);
        box.appendChild(document.createElement('div')).style.height='8px';
        box.appendChild(endLabel);
        box.appendChild(endRow);
      }

      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===3){
      setWizardQuestion('Logo hochladen?', 'Optional, sp√§ter jederzeit austauschbar.');
      const wrap = document.createElement('div');
      const btns=document.createElement('div');
      btns.className='answers';

      const up=document.createElement('button');
      up.className='ans';
      up.type='button';
      up.textContent='Logo ausw√§hlen';
      up.onclick=async()=>{
        const file = await pickImage();
        if(!file) return;
        w.data.logoData = await toDataUrl(file);
        rebuildWizard();
      };

      const skip=document.createElement('button');
      skip.className='ans';
      skip.type='button';
      skip.textContent='Sp√§ter';
      skip.onclick=()=>{ w.data.logoData=''; rebuildWizard(); };

      btns.appendChild(up);
      btns.appendChild(skip);
      wrap.appendChild(btns);

      if(w.data.logoData){
        const prev=document.createElement('div');
        prev.style.marginTop='10px';
        prev.innerHTML = `<div class="hint">Vorschau:</div><div class="plogo" style="width:60px;height:60px;border-radius:14px"><img src="${w.data.logoData}" alt="Logo" /></div>`;
        wrap.appendChild(prev);
      }

      setWizardContent(wrap);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===4){
      setWizardQuestion('Profil ist bereit', 'Kurz pr√ºfen, dann loslegen.');
      const box=document.createElement('div');
      const addr = buildAddress(w.data);
      const logo = w.data.logoData ? `<img src="${w.data.logoData}" alt="Logo" />` : `<img src="assets/provider-placeholder.png" alt="Logo" />`;

      const summary=document.createElement('div');
      summary.className='panel';
      summary.innerHTML = `
        <div style="display:flex;gap:10px;align-items:center;">
          <div class="plogo" style="width:52px;height:52px;border-radius:14px">${logo}</div>
          <div>
            <div style="font-weight:950">${esc(w.data.name || 'Betrieb')}</div>
            <div class="hint">${esc(addr || 'Adresse fehlt')}</div>
          </div>
        </div>
        <div class="row"><span>Essenszeit</span><b>${esc(w.data.mealWindow || DEFAULT_MEAL_WINDOW)}</b></div>
      `;

      const cta=document.createElement('button');
      cta.className='btn';
      cta.type='button';
      cta.textContent='Erstes Gericht erstellen';
      cta.onclick=()=>{
        saveProviderProfileFromWizard();
        closeWizard();
        startWizard('listing');
      };

      box.appendChild(summary);
      box.appendChild(cta);
      setWizardContent(box);
      wNextBtn.textContent='Fertig';
      return;
    }
  }

  // --- Listing wizard (Punkt 6 final) ---
  function updateListingPreviewContent(target){
    target.innerHTML = '';
    const title = document.createElement('div');
    title.className = 'hint';
    title.textContent = 'Live-Preview';
    target.appendChild(title);
    target.appendChild(offerCard(previewOfferFromWizard(), {interactive:false}));
    if(w.data.hasPickupCode){
      const note = document.createElement('div');
      note.className = 'mini';
      note.textContent = 'Abholcode-Beispiel: A3';
      target.appendChild(note);
    }
  }

  function attachListingPreview(box){
    const wrap = document.createElement('div');
    wrap.id = 'listingPreview';
    wrap.style.marginTop = '12px';
    updateListingPreviewContent(wrap);
    box.appendChild(wrap);
  }

  function refreshListingPreview(){
    const wrap = document.getElementById('listingPreview');
    if(wrap){ updateListingPreviewContent(wrap); }
  }

  function buildListingStep(){
    setWizardNextDefault();
    const total = 10;
    setWizardHeader('Neues Inserat', `Schritt ${Math.min(w.step+1,total)} von ${total}`);

    if(w.step===0){
      setWizardQuestion('Gerichtname?', 'Autocomplete: schnell tippen.');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field';
      input.placeholder='z.B. Kuerbissuppe';
      input.setAttribute('list','dishSuggestions');
      input.value=w.data.dish||'';
      input.oninput=()=>{
        w.data.dish = input.value;
        const hit = DISH_SUGGESTIONS.find(d => d.name.toLowerCase() === input.value.trim().toLowerCase());
        if(hit){ w.data.category = hit.category; }
        refreshListingPreview();
      };
      const list=document.createElement('datalist');
      list.id='dishSuggestions';
      DISH_SUGGESTIONS.forEach(d=>{
        const opt=document.createElement('option');
        opt.value=d.name;
        list.appendChild(opt);
      });
      const h=document.createElement('div'); h.className='hint'; h.textContent='Kategorie wird automatisch gesetzt, wenn bekannt.';

      box.appendChild(input);
      box.appendChild(list);
      box.appendChild(h);
      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===1){
      setWizardQuestion('Preis pro Portion?', 'Zahlen-Tastatur, Standard 0,00.');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field';
      input.inputMode='decimal';
      input.placeholder='0,00';
      input.value = formatPriceInput(w.data.price);
      input.oninput=()=>{ w.data.price = parsePriceInput(input.value); refreshListingPreview(); };
      const h=document.createElement('div'); h.className='hint'; h.textContent='Beispiel: 7,90';
      box.appendChild(input);
      box.appendChild(h);
      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===2){
      setWizardQuestion('Essenszeit?', 'Standard aus Profil, optional aendern.');
      const profile = normalizeProviderProfile(provider.profile || {});
      if(!w.data.pickupWindow){ w.data.pickupWindow = profile.mealWindow || DEFAULT_MEAL_WINDOW; }

      const current = w.data.pickupWindow || profile.mealWindow || DEFAULT_MEAL_WINDOW;
      const split = current.includes('‚Äì') ? current.split('‚Äì') : current.split('-');
      const startDefault = split[0] ? split[0].trim() : '11:30';
      const endDefault = split[1] ? split[1].trim() : '14:00';
      if(!w.data.mealStart) w.data.mealStart = startDefault;
      if(!w.data.mealEnd) w.data.mealEnd = endDefault;

      const box=document.createElement('div');
      const summary=document.createElement('div');
      summary.className='panel';
      summary.innerHTML = `<b>${esc(current)}</b><div class="hint">Standard aus Profil</div>`;
      box.appendChild(summary);

      const actions=document.createElement('div');
      actions.className='answers';
      const toggle=document.createElement('button');
      toggle.type='button';
      toggle.className='ans';
      toggle.textContent = w.data.mealCustom ? 'Fertig' : 'Essenszeit aendern';
      toggle.onclick=()=>{
        w.data.mealCustom = !w.data.mealCustom;
        if(!w.data.mealCustom){
          w.data.pickupWindow = profile.mealWindow || DEFAULT_MEAL_WINDOW;
        }
        rebuildWizard();
      };
      actions.appendChild(toggle);
      box.appendChild(actions);

      if(w.data.mealCustom){
        const updateWindow = ()=>{
          if(w.data.mealStart && w.data.mealEnd){
            w.data.pickupWindow = `${w.data.mealStart} ‚Äì ${w.data.mealEnd}`;
          }
        };

        const startLabel=document.createElement('div'); startLabel.className='hint'; startLabel.textContent='Start';
        const startRow=document.createElement('div'); startRow.className='answers';
        ['10:30','11:00','11:30','12:00'].forEach(t=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.mealStart===t?' on':'');
          b.textContent=t;
          b.onclick=()=>{ w.data.mealStart=t; updateWindow(); rebuildWizard(); };
          startRow.appendChild(b);
        });

        const endLabel=document.createElement('div'); endLabel.className='hint'; endLabel.textContent='Ende';
        const endRow=document.createElement('div'); endRow.className='answers';
        ['13:00','13:30','14:00','14:30'].forEach(t=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.mealEnd===t?' on':'');
          b.textContent=t;
          b.onclick=()=>{ w.data.mealEnd=t; updateWindow(); rebuildWizard(); };
          endRow.appendChild(b);
        });

        box.appendChild(document.createElement('div')).style.height='10px';
        box.appendChild(startLabel);
        box.appendChild(startRow);
        box.appendChild(document.createElement('div')).style.height='8px';
        box.appendChild(endLabel);
        box.appendChild(endRow);
      }

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===3){
      setWizardQuestion('Allergene?', 'Ja / Nein. Bei Ja: 14 Allergene als Toggle.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      const has = w.data.hasAllergens || (Array.isArray(w.data.allergens) && w.data.allergens.length);

      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(has?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!has?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.hasAllergens=true; if(!Array.isArray(w.data.allergens)) w.data.allergens=[]; rebuildWizard(); };
      no.onclick=()=>{ w.data.hasAllergens=false; w.data.allergens=[]; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);

      if(has){
        const list=document.createElement('div'); list.className='answers';
        ALLERGENS_14.forEach(a=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.allergens.includes(a.short)?' on':'');
          b.textContent=`${a.short} ${a.name}`;
          b.onclick=()=>{
            const i=w.data.allergens.indexOf(a.short);
            if(i>=0) w.data.allergens.splice(i,1); else w.data.allergens.push(a.short);
            rebuildWizard();
          };
          list.appendChild(b);
        });
        box.appendChild(document.createElement('div')).style.height='8px';
        box.appendChild(list);
      }

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===4){
      setWizardQuestion('Extras?', 'Presets auswaehlen und Preis tippen.');
      const box=document.createElement('div');
      if(!Array.isArray(w.data.extras)) w.data.extras=[];

      const ans=document.createElement('div'); ans.className='answers';
      ['Beilagensalat','Extrasosse','Sonstiges'].forEach(name=>{
        const active = w.data.extras.some(e=>e.name===name);
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(active?' on':'');
        b.textContent=name;
        b.onclick=()=>{
          const idx = w.data.extras.findIndex(e=>e.name===name);
          if(idx>=0) w.data.extras.splice(idx,1);
          else w.data.extras.push({name, price:0});
          rebuildWizard();
        };
        ans.appendChild(b);
      });
      box.appendChild(ans);

      if(w.data.extras.length){
        w.data.extras.forEach(extra=>{
          const label=document.createElement('div');
          label.className='hint';
          label.textContent=extra.name;
          const input=document.createElement('input');
          input.className='field';
          input.inputMode='decimal';
          input.placeholder='Preis in EUR (z.B. 2,00)';
          input.value = formatPriceInput(extra.price);
          input.oninput=()=>{ extra.price = parsePriceInput(input.value); refreshListingPreview(); };
          box.appendChild(document.createElement('div')).style.height='8px';
          box.appendChild(label);
          box.appendChild(input);
        });
      }

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===5){
      setWizardQuestion('Mehrweg anbieten?', 'Ja / Nein. Presets: 2, 3, 5.');
      const box=document.createElement('div');
      if(!w.data.reuse) w.data.reuse = {enabled:false, deposit:0};

      const ans=document.createElement('div'); ans.className='answers';
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(w.data.reuse.enabled?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!w.data.reuse.enabled?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.reuse.enabled=true; if(!w.data.reuse.deposit) w.data.reuse.deposit=2; rebuildWizard(); };
      no.onclick=()=>{ w.data.reuse.enabled=false; w.data.reuse.deposit=0; w.data.reuseCustom=false; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);

      if(w.data.reuse.enabled){
        const presets=document.createElement('div'); presets.className='answers';
        [2,3,5].forEach(val=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.reuse.deposit===val && !w.data.reuseCustom?' on':'');
          b.textContent=`${val} EUR`;
          b.onclick=()=>{ w.data.reuse.deposit=val; w.data.reuseCustom=false; rebuildWizard(); };
          presets.appendChild(b);
        });
        const other=document.createElement('button');
        other.type='button';
        other.className='ans'+(w.data.reuseCustom?' on':'');
        other.textContent='Anderer Betrag';
        other.onclick=()=>{ w.data.reuseCustom=true; rebuildWizard(); };
        presets.appendChild(other);
        box.appendChild(document.createElement('div')).style.height='8px';
        box.appendChild(presets);

        if(w.data.reuseCustom){
          const input=document.createElement('input');
          input.className='field';
          input.inputMode='decimal';
          input.placeholder='Betrag in EUR';
          input.value = formatPriceInput(w.data.reuse.deposit);
          input.oninput=()=>{ w.data.reuse.deposit = parsePriceInput(input.value); refreshListingPreview(); };
          box.appendChild(document.createElement('div')).style.height='8px';
          box.appendChild(input);
        }
      }

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===6){
      setWizardQuestion('Foto?', 'Kamera, Galerie oder ohne Foto.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';

      const cam=document.createElement('button'); cam.type='button'; cam.className='ans'; cam.textContent='Kamera';
      cam.onclick=async()=>{ const f=await pickImage({capture:true}); if(!f) return; w.data.photoData = await toDataUrl(f); rebuildWizard(); };
      const gal=document.createElement('button'); gal.type='button'; gal.className='ans'; gal.textContent='Galerie';
      gal.onclick=async()=>{ const f=await pickImage(); if(!f) return; w.data.photoData = await toDataUrl(f); rebuildWizard(); };
      const none=document.createElement('button'); none.type='button'; none.className='ans'; none.textContent='Ohne Foto';
      none.onclick=()=>{ w.data.photoData=''; rebuildWizard(); };

      ans.appendChild(cam); ans.appendChild(gal); ans.appendChild(none);
      box.appendChild(ans);
      if(w.data.photoData){
        const p=document.createElement('div'); p.style.marginTop='10px';
        p.innerHTML = `<div class="hint">Vorschau:</div><div style="border-radius:16px;overflow:hidden;border:1px solid #eee"><img src="${w.data.photoData}" alt="" style="width:100%;height:200px;object-fit:cover;display:block"></div>`;
        box.appendChild(p);
      }

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===7){
      setWizardQuestion('Bezahlung mit Abholcode?', 'Preview zeigt Badge + Abholcode-Beispiel.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(w.data.hasPickupCode?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!w.data.hasPickupCode?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.hasPickupCode=true; rebuildWizard(); };
      no.onclick=()=>{ w.data.hasPickupCode=false; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===8){
      setWizardQuestion('Vor Ort essen moeglich?', 'Preview zeigt das Badge.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(w.data.dineInPossible?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!w.data.dineInPossible?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.dineInPossible=true; rebuildWizard(); };
      no.onclick=()=>{ w.data.dineInPossible=false; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===9){
      setWizardQuestion('Abschluss', 'Inserat veroeffentlichen oder speichern.');
      const box=document.createElement('div');
      attachListingPreview(box);

      const actions=document.createElement('div');
      actions.style.marginTop='10px';

      const btnPub=document.createElement('button');
      btnPub.className='btn';
      btnPub.type='button';
      btnPub.textContent = 'Inserat veroeffentlichen';
      btnPub.onclick=()=>{
        const o = previewOfferFromWizard();
        publishOffer(o);
        closeWizard();
        alert('Inserat veroeffentlicht ‚úÖ');
        showProviderHome();
      };

      const btnSave=document.createElement('button');
      btnSave.className='btn secondary';
      btnSave.type='button';
      btnSave.textContent='In Kochbuch speichern';
      btnSave.onclick=()=>{
        saveToCookbookFromWizard();
        alert('Im Kochbuch gespeichert ‚úÖ');
        closeWizard();
        showProviderCookbook();
      };

      const btnWeek=document.createElement('button');
      btnWeek.className='btn ghost';
      btnWeek.type='button';
      btnWeek.textContent='In Wochenplan uebernehmen';
      btnWeek.onclick=()=>{
        saveToCookbookFromWizard(true);
        const cb = cookbook.filter(x=>x.providerId===providerId()).slice(-1)[0];
        if(cb) startWizard('week', {fromCookbookId:cb.id});
      };

      const btnBack=document.createElement('button');
      btnBack.className='btn ghost';
      btnBack.type='button';
      btnBack.textContent='Zurueck';
      btnBack.onclick=()=>{ w.step = Math.max(0, w.step-1); rebuildWizard(); };

      actions.appendChild(btnPub);
      actions.appendChild(btnSave);
      actions.appendChild(btnWeek);
      actions.appendChild(btnBack);
      box.appendChild(actions);

      setWizardContent(box);
      wNextBtn.textContent='Fertig';
      wNextBtn.onclick=()=>{ closeWizard(); showProviderHome(); };
      return;
    }
  }

  function previewOfferFromWizard(){
    const p = normalizeProviderProfile(provider.profile||{});
    const pickupWindow = w.data.pickupWindow || p.mealWindow || DEFAULT_MEAL_WINDOW;
    return {
      id: 'preview',
      providerId: providerId(),
      providerName: p.name || provider.email || 'Anbieter',
      providerStreet: p.street||'',
      providerZip: p.zip||'',
      providerCity: p.city||'',
      providerLogoData: p.logoData||'',
      dish: w.data.dish||'Gericht',
      category: w.data.category||'Vegetarisch',
      price: Number(w.data.price||0),
      pickupWindow,
      imageUrl: w.data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
      hasPickupCode: !!w.data.hasPickupCode,
      dineInPossible: !!w.data.dineInPossible,
      allergens: w.data.allergens||[],
      extras: w.data.extras||[],
      reuse: w.data.reuse||{enabled:false,deposit:0},
      day: isoDate(new Date())
    };
  }

  function publishOffer(o){
    const id = cryptoId();
    const out = {...o, id, day: isoDate(new Date())};
    // ensure provider address exists
    if(!out.providerStreet){
      alert('Bitte zuerst Anbieterprofil ausf√ºllen (Adresse).');
      return;
    }
    offers.unshift(out);
    save(LS.offers, offers);
    // restore default next button handler
    setWizardNextDefault();
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
  }

  function saveToCookbookFromWizard(keepOpen=false){
    const x = {
      id: cryptoId(),
      providerId: providerId(),
      dish: w.data.dish||'',
      category: w.data.category||'Vegetarisch',
      price: Number(w.data.price||0),
      allergens: w.data.allergens||[],
      extras: w.data.extras||[],
      reuse: w.data.reuse||{enabled:false,deposit:0},
      photoData: w.data.photoData||''
    };
    cookbook.push(x);
    save(LS.cookbook, cookbook);
    if(!keepOpen){ renderCookbook(); }
  }

  // Cookbook wizard (add recipe)
  function buildCookbookStep(){
    setWizardNextDefault();
    // reuse listing steps subset: category, photo, name, allergens, extras, reuse, price, preview/save
    const total = 8;
    setWizardHeader('Kochbuch', `${Math.min(w.step+1,total)}/${total}`);

    if(w.step===0){
      setWizardQuestion('Kategorie?', 'Tippe eine Kategorie.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      ['Vegan','Vegetarisch','Fleisch','Salat'].forEach(c=>{
        const b=document.createElement('button'); b.type='button'; b.className='ans'+(w.data.category===c?' on':''); b.textContent=c;
        b.onclick=()=>{ w.data.category=c; rebuildWizard(); };
        ans.appendChild(b);
      });
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===1){
      setWizardQuestion('Foto speichern?', 'Optional (f√ºr schnelleres Wiederverwenden).');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      const b1=document.createElement('button'); b1.type='button'; b1.className='ans'; b1.textContent='Foto ausw√§hlen';
      b1.onclick=async()=>{ const f=await pickImage(); if(!f) return; w.data.photoData = await toDataUrl(f); rebuildWizard(); };
      const b2=document.createElement('button'); b2.type='button'; b2.className='ans'; b2.textContent='Ohne';
      b2.onclick=()=>{ w.data.photoData=''; rebuildWizard(); };
      ans.appendChild(b1); ans.appendChild(b2);
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===2){
      setWizardQuestion('Gerichtname?', 'Wie im Kochbuch.');
      const box=document.createElement('div');
      const input=document.createElement('input'); input.className='field'; input.placeholder='z.B. Lasagne'; input.value=w.data.dish||'';
      input.oninput=()=>{ w.data.dish=input.value; };
      box.appendChild(input);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===3){
      setWizardQuestion('Allergene?', 'Optional, antippen.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      if(!Array.isArray(w.data.allergens)) w.data.allergens=[];
      ALLERGENS_14.forEach(a=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(w.data.allergens.includes(a.short)?' on':'');
        b.textContent=`${a.short} ${a.name}`;
        b.onclick=()=>{
          const i=w.data.allergens.indexOf(a.short);
          if(i>=0) w.data.allergens.splice(i,1); else w.data.allergens.push(a.short);
          rebuildWizard();
        };
        ans.appendChild(b);
      });
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===4){
      // Extras
      setWizardQuestion('Extras?', 'Optional.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(w.data.extras?.length?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!w.data.extras?.length?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.extras = w.data.extras?.length ? w.data.extras : [{name:'Beilagensalat', price:2.0}]; rebuildWizard(); };
      no.onclick=()=>{ w.data.extras=[]; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===5){
      // reuse
      setWizardQuestion('Mehrweg / Pfand?', 'Optional.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      if(!w.data.reuse) w.data.reuse={enabled:false,deposit:0};
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(w.data.reuse.enabled?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!w.data.reuse.enabled?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.reuse.enabled=true; if(!w.data.reuse.deposit) w.data.reuse.deposit=5; rebuildWizard(); };
      no.onclick=()=>{ w.data.reuse.enabled=false; w.data.reuse.deposit=0; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===6){
      setWizardQuestion('Standardpreis?', 'Nur Zahl ‚Äì Komma nicht n√∂tig.');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field'; input.inputMode='numeric'; input.placeholder='z.B. 799';
      input.value = w.data.price ? String(Math.round(w.data.price*100)) : '';
      input.oninput=()=>{ w.data.price = smartNumberToEuro(input.value); };
      box.appendChild(input);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===7){
      setWizardQuestion('Speichern?', 'Damit du sp√§ter mit 2 Taps inserierst.');
      const box=document.createElement('div');
      const prev = {
        id:'preview',
        providerId:providerId(),
        providerName: provider.profile.name || provider.email || 'Anbieter',
        providerStreet:'',providerZip:'',providerCity:'',providerLogoData: provider.profile.logoData||'',
        dish:w.data.dish||'Gericht',
        category:w.data.category||'Vegetarisch',
        price:Number(w.data.price||0),
        pickupWindow:'',
        imageUrl: w.data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
        hasPickupCode:false,
        allergens:w.data.allergens||[],
        extras:w.data.extras||[],
        reuse:w.data.reuse||{enabled:false,deposit:0},
        day: isoDate(new Date())
      };
      box.appendChild(offerCard(prev));
      const btn=document.createElement('button');
      btn.className='btn';
      btn.type='button';
      btn.textContent='Im Kochbuch speichern';
      btn.onclick=()=>{
        cookbook.push({
          id:cryptoId(),
          providerId:providerId(),
          dish:w.data.dish||'',
          category:w.data.category||'Vegetarisch',
          price:Number(w.data.price||0),
          allergens:w.data.allergens||[],
          extras:w.data.extras||[],
          reuse:w.data.reuse||{enabled:false,deposit:0},
          photoData:w.data.photoData||''
        });
        save(LS.cookbook, cookbook);
        closeWizard();
        renderCookbook();
        alert('Gespeichert ‚úÖ');
      };
      box.appendChild(btn);
      setWizardContent(box);
      wNextBtn.textContent='Fertig';
      wNextBtn.onclick=()=>{ closeWizard(); showProviderCookbook(); };
      return;
    }
  }

  // Weekplan wizard (simple date choose)
  function buildWeekStep(){
    setWizardNextDefault();
    setWizardHeader('Wochenplan', '1/1');
    setWizardQuestion('F√ºr welchen Tag?', 'W√§hle einen Tag und f√ºge das Gericht hinzu.');

    const box=document.createElement('div');
    const ans=document.createElement('div'); ans.className='answers';

    for(let i=0;i<7;i++){
      const d=new Date(); d.setDate(d.getDate()+i);
      const key=isoDate(d);
      const b=document.createElement('button');
      b.type='button';
      b.className='ans'+(w.data.date===key?' on':'');
      b.textContent = i===0?'Heute':(i===1?'Morgen':fmtDay(d));
      b.onclick=()=>{ w.data.date=key; rebuildWizard(); };
      ans.appendChild(b);
    }
    box.appendChild(ans);

    const btn=document.createElement('button');
    btn.className='btn';
    btn.type='button';
    btn.textContent='Zum Wochenplan hinzuf√ºgen';
    btn.onclick=()=>{
      const cb = cookbook.find(c=>c.id===w.data.cookbookId);
      if(!cb){ alert('Gericht nicht gefunden'); return; }
      const entry = { providerId:providerId(), dish:cb.dish, cookbookId:cb.id };
      if(!week[w.data.date]) week[w.data.date]=[];
      week[w.data.date].push(entry);
      save(LS.week, week);
      closeWizard();
      renderProviderHome();
      alert('Im Wochenplan ‚úÖ');
    };

    box.appendChild(document.createElement('div')).style.height='10px';
    box.appendChild(btn);

    setWizardContent(box);
    wNextBtn.textContent='Fertig';
    wNextBtn.onclick=()=>{ closeWizard(); showProviderHome(); };
  }

  // --- Input helpers (thumb-friendly) ---
  function formatPriceInput(value){
    const num = Number(value||0);
    return num.toFixed(2).replace('.',',');
  }
  function parsePriceInput(raw){
    const cleaned = String(raw||'').trim().replace(',', '.').replace(/[^0-9.]/g,'');
    const num = parseFloat(cleaned);
    if(Number.isNaN(num)) return 0;
    return Math.round(num*100)/100;
  }
  function smartNumberToEuro(raw){
    const digits = String(raw||'').replace(/\D/g,'');
    if(!digits) return 0;
    const cents = parseInt(digits,10);
    return Math.round((cents/100)*100)/100;
  }
  function smartNumber(raw){
    const digits = String(raw||'').replace(/\D/g,'');
    if(!digits) return 0;
    return parseInt(digits,10);
  }

  // Image picker
  function pickImage(opts={}){
    return new Promise(resolve=>{
      const input=document.createElement('input');
      input.type='file';
      input.accept='image/*';
      if(opts.capture) input.capture='environment';
      input.onchange=()=> resolve(input.files && input.files[0] ? input.files[0] : null);
      input.click();
    });
  }
  function toDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload=()=>resolve(r.result);
      r.onerror=reject;
      r.readAsDataURL(file);
    });
  }

  // --- boot ---
  seed();
  offers = offers.map(normalizeOffer);
  save(LS.offers, offers);
  renderChips();

  // init nav bindings
  // default start
  if(mode==='provider' && !provider.loggedIn) mode='customer';
  setMode(mode);

  // initial customer view
  showDiscover();
</script>

<script>
  // PWA (optional)
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('sw.js').catch(()=>{});
    });
  }
</script>
</body>
</html>
