<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Mittagio</title>
  <meta name="theme-color" content="#F2B705" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="assets/icons/icon-192.png" />
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png" />
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
    :root{
      /* Mittagio palette (can be adjusted later) */
      --bg:#F7F6F0;
      --card:#FFFFFF;
      --text:#111;
      --muted:#6b6b6b;
      --border:#e7e1d5;
      --shadow:0 10px 24px rgba(0,0,0,.08);
      --shadow2:0 16px 40px rgba(0,0,0,.14);
      --radius:24px;     /* rounded-3xl for messenger vibe */
      --brand:#FFCC00;   /* Mittagio-Gelb */
      --brand2:#1F9D55;  /* green */
      --danger:#E34D4D;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-size:16px;
      line-height:1.5;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit}

    /* App shell */
    .app{min-height:100%; padding-bottom:78px;}
    .topbar{
      position:relative; z-index:10;
      background:rgba(247,246,240,.92);
      backdrop-filter:saturate(160%) blur(8px);
      border-bottom:1px solid var(--border);
    }
    .topbar-inner{max-width:980px; margin:0 auto; padding:12px 14px; display:flex; align-items:center; gap:10px;}
    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .brand-badge{
      width:38px; height:38px; border-radius:12px;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      box-shadow:0 8px 18px rgba(0,0,0,.16);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .brand-badge img{width:100%; height:100%; object-fit:cover; display:block}
    .brand-name{font-weight:900; letter-spacing:.06em; font-size:20px; white-space:nowrap}
    .spacer{flex:1}

    .chiprow{
      max-width:980px; margin:0 auto; padding:6px 14px 8px;
      display:flex; gap:8px; overflow:auto; -webkit-overflow-scrolling:touch;
    }
    .chip{
      flex:0 0 auto;
      border:1px solid var(--border);
      background:#f8f7f3;
      padding:10px 16px;
      border-radius:999px;
      font-size:14px;
      font-weight:800;
      color:#222;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .chip.active{
      border-color:rgba(31,157,85,.45);
      background:rgba(31,157,85,.12);
      box-shadow:0 10px 22px rgba(31,157,85,.12)
    }

    .pickup-group{
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      padding:10px;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .pickup-group + .pickup-group{margin-top:10px}
    .pickup-head{display:flex; align-items:center; justify-content:space-between; gap:8px; font-weight:900}
    .pickup-sub{font-size:12px; color:var(--muted)}
    .code-chip{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px; border:1px solid var(--border);
      background:#fff; font-size:12px; font-weight:900;
      margin:4px 6px 0 0; box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .code-chip.done{background:rgba(31,157,85,.12); border-color:rgba(31,157,85,.4); color:#1f9d55; text-decoration:line-through}

    .dayrow{
      max-width:980px; margin:0 auto; padding:0 14px 12px;
      display:flex; gap:8px; overflow:auto; -webkit-overflow-scrolling:touch;
    }
    .day{
      flex:0 0 auto;
      border:none;
      background:#fff;
      padding:12px 16px;
      border-radius:999px;
      font-size:14px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      border:1px solid var(--border);
    }
    .day.active{background:rgba(242,183,5,.14); border-color:rgba(242,183,5,.55)}

    main{max-width:980px; margin:0 auto; padding:14px}
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    @media (min-width:820px){ .grid{grid-template-columns:1fr 1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:20px;
      overflow:hidden;
      box-shadow:var(--shadow);
      cursor:pointer;
      position:relative;
    }
    .card.playful{
      border-color:rgba(242,183,5,.38);
      box-shadow:0 12px 26px rgba(242,183,5,.18);
    }
    .card.playful .body{
      background:linear-gradient(180deg,#fff, #fff4e6);
    }
    .card.playful .price{color:#b26b00}
    .card.playful .tag{background:rgba(242,183,5,.25)}
    .img{height:190px; background:#eee; position:relative}
    .img img{width:100%; height:100%; object-fit:cover; display:block}

    .provider-logo{
      display:flex; align-items:center; gap:8px;
      padding:12px 14px 0;
    }
    .plogo{
      width:28px; height:28px; border-radius:8px;
      background:#f2f2f2;
      overflow:hidden;
      border:1px solid var(--border);
      flex:0 0 auto;
    }
    .plogo img{width:100%; height:100%; object-fit:cover; display:block}
    .pname{font-size:14px; font-weight:900; color:#222; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; line-height:1.3}

    .body{padding:14px 16px 16px}
    .title{font-weight:950; font-size:18px; margin:0; line-height:1.3}
    .sub{margin:4px 0 0; color:#444; font-size:14px; line-height:1.4}

    .meta{display:flex; justify-content:space-between; align-items:flex-end; gap:12px; margin-top:12px}
    .price{font-weight:950; font-size:18px; color:#0f5c4c}
    .right{ text-align:right; font-size:13px; color:var(--muted); line-height:1.4 }
    .meta-line{display:flex; align-items:center; gap:6px; justify-content:flex-end}
    .tag{display:inline-block; margin-top:6px; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:900; background:rgba(242,183,5,.18)}

    .badge{
      position:absolute; top:12px; left:12px;
      background:rgba(17,17,17,.72);
      color:#fff;
      font-size:12px; font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      box-shadow:0 10px 22px rgba(0,0,0,.18);
      line-height:1.3;
    }
    .badge.code{left:auto; right:12px; background:rgba(31,157,85,.9)}
    .badge.dine{background:rgba(242,183,5,.9); color:#111}
    .badge.inactive{background:rgba(0,0,0,.45)}

    .heart{
      position:absolute; top:12px; right:12px;
      width:36px; height:36px; border-radius:999px;
      border:none; cursor:pointer;
      background:rgba(255,255,255,.92);
      box-shadow:0 10px 22px rgba(0,0,0,.16);
      font-size:16px;
      color:#bbb;
      display:flex; align-items:center; justify-content:center;
    }
    .heart.on{color:var(--danger)}

    /* Bottom nav - Glassmorphism Mittagio-Bar */
    .bottom{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      height:80px; padding-bottom:env(safe-area-inset-bottom);
      background:rgba(255,255,255,.85);
      backdrop-filter:saturate(180%) blur(20px);
      -webkit-backdrop-filter:saturate(180%) blur(20px);
      border-top:1px solid rgba(231,225,213,.3);
      display:flex;
      box-shadow:0 -4px 20px rgba(0,0,0,.05);
    }
    .navbtn{
      flex:1; border:none; background:none; cursor:pointer;
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
      color:#777; font-size:11px; font-weight:600;
      padding:8px 4px; transition:color .2s;
      position:relative;
      -webkit-tap-highlight-color: transparent;
    }
    .navbtn * {
      pointer-events: none;
    }
    .navbtn .ico{font-size:22px; display:inline-flex; align-items:center; justify-content:center}
    .navbtn .ico svg{width:22px; height:22px; stroke-width:2}
    .navbtn.active{color:var(--brand); font-weight:900}
    .navbtn .badge-notification{
      position:absolute; top:8px; right:calc(50% - 20px);
      width:8px; height:8px; border-radius:50%;
      background:var(--brand); border:2px solid rgba(255,255,255,.85);
    }

    /* Views */
    .view{display:none}
    .view.active{display:block}

    /* Sheets / modals */
    .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.38); opacity:0; pointer-events:none; transition:opacity .2s; z-index:30}
    .backdrop.active{opacity:1; pointer-events:auto}
    .sheet{
      position:fixed; left:0; right:0; bottom:-120%; z-index:31;
      background:#fff; border-radius:22px 22px 0 0;
      box-shadow:var(--shadow2);
      transition:bottom .28s ease;
      max-height:92vh; overflow:auto;
    }
    .sheet.active{bottom:0}
    .handle{width:46px; height:5px; background:#ddd; border-radius:999px; margin:10px auto 6px}
    .sheet-img{height:260px; background:#eee}
    .sheet-img img{width:100%; height:100%; object-fit:cover; display:block}
    .sheet-body{padding:12px 14px 18px}
    .row{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px 0; border-top:1px solid #eee; font-size:15px; line-height:1.4}
    .btn{
      width:100%; border:none; cursor:pointer;
      border-radius:999px; padding:16px 20px; font-weight:950; font-size:16px;
      background:var(--brand); color:#111;
      line-height:1.4;
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn.secondary{background:#fff; border:1px solid var(--border)}
    .btn.ghost{background:#f8f7f3; border:1px solid var(--border)}
    .mini{font-size:13px; color:var(--muted); margin-top:8px; line-height:1.5}

    .card-actions{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
    .card-action{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .card-action.primary{background:var(--brand); border-color:var(--brand)}
    .card-action.ghost{background:#f8f7f3}
    .card-action:disabled{opacity:.5; cursor:not-allowed}

    /* Profile cards */
    .panel{background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); padding:12px}
    .panel h3{margin:0 0 10px; font-size:18px; font-weight:900; line-height:1.3}
    .section-title{font-weight:900; font-size:20px; margin:12px 0 8px; line-height:1.3}
    .rowlist{display:flex; flex-direction:column; gap:8px}
    .rowbtn{
      width:100%; border:1px solid var(--border); background:#fff; cursor:pointer;
      border-radius:14px; padding:12px; text-align:left; font-weight:900;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .rowbtn-left{display:flex; align-items:center; gap:10px; min-width:0}
    .rowbtn-ico{
      width:36px; height:36px; border-radius:10px; flex:0 0 auto;
      border:1px solid var(--border); background:#f8f7f3;
      display:flex; align-items:center; justify-content:center;
    }
    .rowbtn-ico svg{width:16px; height:16px}
    .rowbtn-text{min-width:0}
    .rowbtn-text span{display:block; font-weight:600; font-size:13px; color:var(--muted); margin-top:4px; line-height:1.4}
    .rowbtn .chev{font-size:20px; color:var(--muted)}
    .rowgroup-title{font-size:13px; font-weight:900; color:var(--muted); margin-top:8px; line-height:1.4}
    .profile-head{display:flex; align-items:center; gap:12px}
    .profile-head .plogo{width:56px; height:56px; border-radius:50%}
    .profile-meta{display:flex; flex-direction:column; gap:4px}
    .profile-chip{display:inline-flex; align-items:center; gap:6px; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900; background:#fff}
    .profile-actions{margin-top:10px}
    .profile-actions .btn{width:auto; margin-top:0}
    .row-group{margin-top:12px}
    .row-group .rowgroup-title{margin:0 0 8px}
    .row-muted{font-size:12px; color:var(--muted)}

    .tabrow{display:flex; gap:8px; flex-wrap:wrap}
    .tabrow .ans{font-size:12px; padding:8px 10px}
    .cookbook-item{border:1px solid var(--border); border-radius:14px; padding:10px; background:#fff; box-shadow:0 6px 14px rgba(0,0,0,.06)}
    .cookbook-item + .cookbook-item{margin-top:10px}
    .cookbook-actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .cookbook-facts{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.35}
    .cart-line{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 0; border-top:1px solid #eee}
    .cart-left{font-weight:700}
    .cart-qty{display:flex; align-items:center; gap:6px}
    .qty-btn{border:1px solid var(--border); background:#fff; border-radius:999px; width:28px; height:28px; cursor:pointer; font-weight:900}
    .cart-price{font-weight:900}
    .order-item{border:1px solid var(--border); border-radius:14px; padding:10px; background:#fff; box-shadow:0 6px 14px rgba(0,0,0,.06)}
    .order-item.done{opacity:.65}
    .order-item + .order-item{margin-top:10px}
    .order-top{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .order-right{display:flex; flex-direction:column; align-items:flex-end; gap:6px}
    .order-code{border:1px solid var(--border); background:#fff; border-radius:10px; padding:6px 10px; font-weight:900; cursor:pointer}
    .status-pill{display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; font-size:11px; font-weight:900; border:1px solid var(--border)}
    .status-pill.open{background:rgba(242,183,5,.12); color:#b37b00}
    .status-pill.done{background:rgba(31,157,85,.12); color:#1f9d55}
    .code-full{font-size:42px; font-weight:950; text-align:center; margin:10px 0}

    /* Quick-Ticket (bildschirmf√ºllend) */
    .quick-ticket{
      position:fixed; inset:0; z-index:31;
      background:linear-gradient(135deg, var(--brand) 0%, #FFD700 100%);
      display:flex; align-items:center; justify-content:center;
      transform:translateY(100%); transition:transform .3s cubic-bezier(.4,0,.2,1);
      padding:20px;
    }
    .quick-ticket.active{transform:translateY(0)}
    .quick-ticket-close{
      position:absolute; top:20px; right:20px;
      width:44px; height:44px; border-radius:50%;
      background:rgba(255,255,255,.2); backdrop-filter:blur(10px);
      border:2px solid rgba(255,255,255,.3);
      color:#fff; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      transition:background .2s;
    }
    .quick-ticket-close:hover{background:rgba(255,255,255,.3)}
    .quick-ticket-close i{width:24px; height:24px}
    .quick-ticket-content{
      width:100%; max-width:400px; text-align:center;
      color:#111;
    }
    .quick-ticket-header{
      margin-bottom:40px;
    }
    .quick-ticket-logo{
      width:80px; height:80px; border-radius:20px;
      background:#fff; border:4px solid rgba(255,255,255,.5);
      margin:0 auto 16px; overflow:hidden;
      box-shadow:0 8px 24px rgba(0,0,0,.2);
    }
    .quick-ticket-logo img{
      width:100%; height:100%; object-fit:cover;
    }
    .quick-ticket-provider{
      font-size:26px; font-weight:900; margin-bottom:10px; line-height:1.3;
    }
    .quick-ticket-time{
      font-size:15px; opacity:.8; font-weight:600; line-height:1.4;
    }
    .quick-ticket-code{
      background:#fff; border-radius:var(--radius);
      padding:32px 24px; margin-bottom:24px;
      box-shadow:0 12px 32px rgba(0,0,0,.2);
    }
    .quick-ticket-code-label{
      font-size:12px; font-weight:700; text-transform:uppercase;
      letter-spacing:.1em; color:var(--muted); margin-bottom:12px;
    }
    .quick-ticket-code-value{
      font-size:72px; font-weight:950; line-height:1;
      color:#111; font-family:'Inter', monospace;
      letter-spacing:.05em;
    }
    .quick-ticket-details{
      background:rgba(255,255,255,.3); backdrop-filter:blur(10px);
      border-radius:var(--radius); padding:20px;
      margin-bottom:20px;
    }
    .quick-ticket-detail-item{
      margin-bottom:16px;
    }
    .quick-ticket-detail-item:last-child{margin-bottom:0}
    .quick-ticket-detail-label{
      font-size:13px; font-weight:700; opacity:.7; margin-bottom:6px; line-height:1.4;
    }
    .quick-ticket-detail-value{
      font-size:17px; font-weight:900; line-height:1.4;
    }
    .quick-ticket-status{
      font-size:14px; font-weight:700; opacity:.8; line-height:1.4;
      margin-bottom:24px;
    }
    .quick-ticket-actions .btn{
      background:#fff; color:#111; box-shadow:0 8px 24px rgba(0,0,0,.2);
    }

    .print-view{display:none}
    @media print{
      body{background:#fff; color:#000}
      body > *:not(#printView){display:none !important}
      #printView{display:block}
      #printView .print-card{
        border:1px solid #ddd; border-radius:12px; padding:16px; margin-bottom:12px;
      }
      #printView h1{margin:0 0 8px; font-size:20px}
      #printView h2{margin:12px 0 6px; font-size:16px}
      #printView .print-row{display:flex; justify-content:space-between; gap:12px; margin-top:6px}
      #printView .print-muted{color:#555; font-size:12px}
      #printView .print-badge{display:inline-block; padding:4px 8px; border:1px solid #999; border-radius:999px; font-size:11px; font-weight:700}
      #printView .print-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
      #printView .qr{width:120px; height:120px; border:1px dashed #999; display:flex; align-items:center; justify-content:center; font-size:11px}
    }
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .bigbtn{
      border:none; cursor:pointer;
      border-radius:18px; padding:14px;
      background:linear-gradient(135deg,rgba(242,183,5,.18),rgba(31,157,85,.12));
      border:1px solid var(--border);
      text-align:left;
      font-weight:950;
    }
    .bigbtn span{display:block; font-weight:700; font-size:12px; color:var(--muted); margin-top:6px}

    /* Provider app header */
    .prov-pill{
      display:inline-flex; align-items:center; gap:8px;
      background:#fff; border:1px solid var(--border);
      padding:9px 12px; border-radius:999px;
      font-weight:950; font-size:13px;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .provider-header{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .provider-logo.compact{padding:0}
    .header-actions{display:flex; gap:8px; flex-wrap:wrap}
    .header-actions .btn{width:auto; margin-top:0}

    .snackbar{
      position:fixed; left:50%; bottom:90px; transform:translateX(-50%);
      background:#111; color:#fff; border-radius:999px; padding:10px 14px;
      display:flex; align-items:center; gap:10px; box-shadow:0 10px 24px rgba(0,0,0,.22);
      opacity:0; pointer-events:none; transition:opacity .2s ease;
      z-index:40; font-size:13px; font-weight:900;
    }
    .snackbar.active{opacity:1; pointer-events:auto}
    .snackbar button{
      border:none; background:#fff; color:#111; border-radius:999px; padding:6px 10px;
      font-size:12px; font-weight:900; cursor:pointer;
    }

    /* Wizard */
    .wizard{
      background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow);
      padding:12px;
    }
    .w-top{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .w-title{font-weight:950}
    .w-step{font-size:12px; color:var(--muted)}
    .w-q{margin:12px 0 10px; font-size:18px; font-weight:950; line-height:1.2}
    .w-help{margin:0 0 10px; color:var(--muted); font-size:13px}
    .answers{display:flex; flex-wrap:wrap; gap:8px}
    .ans{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-weight:950;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .ans.on{border-color:rgba(31,157,85,.4); background:rgba(31,157,85,.10)}
    .field{width:100%; padding:14px 16px; border-radius:14px; border:1px solid var(--border); font-size:16px; background:#fbfaf7; line-height:1.5}
    .w-actions{display:flex; gap:10px; margin-top:12px}
    .w-actions button{flex:1}

    /* FAQ accordion */
    .faq{margin-top:12px}
    details{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 14px rgba(0,0,0,.06);padding:14px 16px}
    details+details{margin-top:10px}
    summary{cursor:pointer;font-weight:950;font-size:15px;line-height:1.4}
    details p{margin:10px 0 0;color:var(--muted);font-size:14px;line-height:1.6}

    /* helper */
    .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.25}

    .loc-row{display:flex; gap:8px; align-items:center}
    .pin-btn{
      border:1px solid var(--border); background:#fff; border-radius:14px;
      width:44px; height:44px; cursor:pointer; font-size:18px;
      display:flex; align-items:center; justify-content:center;
    }
    .ico-inline{display:inline-flex; align-items:center}
    .ico-inline svg{width:14px; height:14px}
    .info-row{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; font-size:12px; color:var(--muted)}
    .info-item{
      display:inline-flex; align-items:center; gap:6px;
      background:#f8f7f3; border:1px solid var(--border);
      padding:5px 10px; border-radius:999px;
      font-size:13px; line-height:1.4;
    }

    /* Onboarding */
    .onboarding-step{
      max-width:600px; margin:0 auto;
    }
    .onboarding-header{
      display:flex; justify-content:space-between; align-items:flex-start;
    }
    .onboarding-progress{
      font-size:12px; font-weight:900; color:var(--muted);
      text-transform:uppercase; letter-spacing:.05em;
    }
    .onboarding-logo-preview:hover{
      border-color:var(--brand); background:#fff4e6;
    }
    .onboarding-logo-preview img{
      display:block;
    }
    .time-btn.active{
      background:var(--brand); border-color:var(--brand);
    }
    .onboarding-summary-item:last-child{
      margin-bottom:0;
    }

    /* Social Feed - Story-Leiste */
    .stories-container{
      padding:16px 14px 20px;
      max-width:980px; margin:0 auto;
    }
    .stories-scroll{
      display:flex; gap:16px; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:4px;
    }
    .story-item{
      flex:0 0 auto; display:flex; flex-direction:column; align-items:center; gap:8px;
      cursor:pointer;
    }
    .story-avatar{
      width:64px; height:64px; border-radius:50%;
      border:3px solid var(--brand);
      padding:2px; background:#fff;
      overflow:hidden; position:relative;
    }
    .story-avatar img{
      width:100%; height:100%; object-fit:cover; border-radius:50%;
    }
    .story-name{
      font-size:12px; font-weight:700; color:var(--text);
      max-width:64px; text-align:center; overflow:hidden; text-overflow:ellipsis;
      line-height:1.3;
    }

    /* Discover Page - App-like UX */
    .discover-header{
      padding:12px 14px 8px;
      max-width:980px; margin:0 auto;
    }
    .discover-location-pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:8px 14px; border-radius:20px;
      background:rgba(0,0,0,.04); border:none;
      font-size:14px; font-weight:600; color:#333;
      cursor:pointer; transition:all .2s;
    }
    .discover-location-pill:active{
      background:rgba(0,0,0,.08);
    }
    .discover-location-text{
      max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .discover-location-icon{
      width:16px; height:16px; flex-shrink:0;
    }
    
    .discover-categories{
      padding:8px 0 12px;
      max-width:980px; margin:0 auto;
    }
    .discover-categories-scroll{
      display:flex; gap:8px; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding:0 14px;
    }
    .discover-category-chip{
      flex:0 0 auto; padding:8px 16px;
      border-radius:20px; border:none;
      font-size:14px; font-weight:600;
      background:#f5f5f5; color:#666;
      cursor:pointer; transition:all .2s;
      white-space:nowrap;
    }
    .discover-category-chip.active{
      background:var(--brand); color:#000;
    }
    
    .discover-calendar{
      padding:0 0 12px;
      max-width:980px; margin:0 auto;
    }
    .discover-calendar-scroll{
      display:flex; gap:8px; overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding:0 14px;
    }
    .discover-day{
      flex:0 0 auto; padding:10px 16px;
      border-radius:16px; border:none;
      font-size:13px; font-weight:600;
      background:#f5f5f5; color:#666;
      cursor:pointer; transition:all .2s;
      white-space:nowrap;
      min-width:60px; text-align:center;
    }
    .discover-day.active{
      background:var(--brand); color:#000;
    }
    
    .discover-offers{
      padding:0 14px 20px;
      max-width:980px; margin:0 auto;
      display:flex; flex-direction:column; gap:12px;
    }
    .discover-hero-card{
      display:flex; gap:12px; padding:12px;
      background:#fff; border-radius:16px;
      box-shadow:0 2px 8px rgba(0,0,0,.08);
      cursor:pointer; transition:transform .2s, box-shadow .2s;
    }
    .discover-hero-card:active{
      transform:scale(.98);
      box-shadow:0 1px 4px rgba(0,0,0,.12);
    }
    .discover-hero-image{
      flex:0 0 100px; width:100px; height:100px;
      border-radius:12px; overflow:hidden;
      position:relative;
    }
    .discover-hero-image img{
      width:100%; height:100%; object-fit:cover;
    }
    .discover-hero-content{
      flex:1; display:flex; flex-direction:column; gap:6px;
      min-width:0;
    }
    .discover-hero-title{
      font-size:16px; font-weight:900; color:#000;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .discover-hero-price{
      font-size:18px; font-weight:900; color:var(--brand);
    }
    .discover-hero-badges{
      display:flex; gap:6px; flex-wrap:wrap;
      margin-top:4px;
    }
    .discover-hero-badge{
      display:inline-flex; align-items:center; gap:4px;
      padding:4px 8px; border-radius:8px;
      font-size:11px; font-weight:600;
      background:rgba(0,0,0,.05);
    }
    .discover-hero-badge.code{
      background:rgba(255,204,0,.2); color:#000;
    }
    .discover-hero-badge.dine{
      background:rgba(76,175,80,.1); color:#4caf50;
    }
    .discover-hero-actions{
      display:flex; gap:8px; margin-top:auto;
    }
    .discover-hero-btn{
      flex:1; padding:8px 12px;
      border-radius:10px; border:none;
      font-size:13px; font-weight:700;
      cursor:pointer; transition:all .2s;
    }
    .discover-hero-btn.primary{
      background:var(--brand); color:#000;
    }
    .discover-hero-btn.secondary{
      background:#f5f5f5; color:#666;
    }
    
    /* Back Navigation */
    .back-button{
      position:absolute; top:12px; left:12px;
      width:40px; height:40px;
      border-radius:50%; border:none;
      background:rgba(255,255,255,.9);
      backdrop-filter:blur(10px);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; z-index:10;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
    }
    .back-button i{
      width:20px; height:20px;
    }

    /* Chat-Bubbles Feed */
    .feed-container{
      max-width:980px; margin:0 auto; padding:0 14px 20px;
    }
    .chat-bubble{
      background:#fff; border:1px solid var(--border);
      border-radius:var(--radius); padding:16px;
      margin-bottom:16px; box-shadow:0 4px 12px rgba(0,0,0,.06);
      position:relative;
    }
    .chat-bubble-header{
      display:flex; align-items:center; gap:12px; margin-bottom:12px;
    }
    .chat-bubble-avatar{
      width:44px; height:44px; border-radius:50%;
      overflow:hidden; flex:0 0 auto;
      border:2px solid var(--border);
    }
    .chat-bubble-avatar img{
      width:100%; height:100%; object-fit:cover;
    }
    .chat-bubble-meta{
      flex:1; min-width:0;
    }
    .chat-bubble-name{
      font-weight:900; font-size:17px; margin-bottom:4px; line-height:1.3;
    }
    .chat-bubble-time{
      font-size:13px; color:var(--muted);
      display:flex; align-items:center; gap:6px; line-height:1.4;
    }
    .chat-bubble-distance{
      position:absolute; top:16px; right:16px;
      font-size:12px; font-weight:700; color:var(--muted);
      background:#f8f7f3; padding:5px 10px; border-radius:999px;
    }
    .chat-bubble-message{
      font-size:16px; line-height:1.6; color:var(--text);
      margin-bottom:14px;
    }
    .chat-bubble-image{
      width:100%; border-radius:16px; overflow:hidden;
      margin-bottom:12px; max-height:300px; object-fit:cover;
    }
    .chat-bubble-actions{
      display:flex; gap:10px; margin-top:12px;
    }
    .chat-bubble-btn{
      flex:1; padding:12px; border-radius:12px;
      border:none; font-weight:900; font-size:14px;
      cursor:pointer; transition:transform .1s;
    }
    .chat-bubble-btn:active{transform:scale(.98)}
    .chat-bubble-btn-primary{
      background:var(--brand); color:#111;
    }
    .chat-bubble-btn-secondary{
      background:#f8f7f3; border:1px solid var(--border); color:var(--text);
    }
    .feed-empty{
      max-width:980px; margin:0 auto;
    }
  </style>
</head>
<body>
<div class="app" id="app">
  <div class="topbar" id="topbar">
    <div class="topbar-inner">
      <div class="brand" role="button" aria-label="Mittagio">
        <div class="brand-badge"><img src="assets/mittagio-logo.png" alt="Mittagio" onerror="this.style.display='none'" /></div>
        <div class="brand-name">MITTAGIO</div>
      </div>
      <div class="spacer"></div>
      <div id="modePill" class="prov-pill" style="display:none;">Dashboard</div>
    </div>
  </div>

  <main>
    <!-- START - Lunch-Feed (Social Style) -->
    <section class="view active" id="v-start">
      <!-- Standort-Suche -->
      <div class="panel" style="margin-top:12px;">
        <div class="section-title">Entdecken</div>
        <div class="loc-row" style="margin-top:8px;">
          <input class="field" id="startLocationInput" type="text" placeholder="Ort oder PLZ eingeben" />
          <button class="pin-btn" type="button" id="btnStartLocationPin" aria-label="Standort setzen"></button>
        </div>
      </div>

      <!-- Filter: Kategorien und Tage -->
      <div style="height:10px"></div>
      <div class="hint" style="padding:0 14px;">Kategorien</div>
      <div class="chiprow" id="startCatChips"></div>
      <div class="hint" style="margin-top:6px; padding:0 14px;">Datum</div>
      <div class="dayrow" id="startDayChips"></div>
      <div class="answers" style="margin-top:6px; padding:0 14px;">
        <button class="ans" type="button" id="btnStartNear" data-icon="location">In der N√§he</button>
      </div>

      <!-- Angebots-Grid (normale Kacheln) -->
      <div class="section-title" style="margin-top:8px; padding:0 14px;">Heute in deiner N√§he</div>
      <div class="grid" id="startOfferGrid"></div>
      <p class="hint" id="startEmptyOffers" style="display:none; text-align:center; padding:40px 20px;">
        Noch keine Angebote. Demo: Als Anbieter ein Inserat erstellen.
      </p>
    </section>

    <!-- CUSTOMER: Discover - App-like UX -->
    <section class="view" id="v-discover">
      <!-- Header: Kompakte Adresszeile (44-48px, Pill-Form) -->
      <div class="discover-header">
        <button class="discover-location-pill" type="button" id="btnDiscoverLocation">
          <span class="discover-location-text" id="discoverLocationText">Standort</span>
          <i data-lucide="map-pin" class="discover-location-icon"></i>
        </button>
      </div>

      <!-- Kategorien (horizontal swipebar) -->
      <div class="discover-categories">
        <div class="discover-categories-scroll" id="discoverCategories">
          <!-- Wird dynamisch bef√ºllt -->
        </div>
      </div>

      <!-- Kalender (horizontal swipebar, direkt unter Kategorien) -->
      <div class="discover-calendar">
        <div class="discover-calendar-scroll" id="discoverCalendar">
          <!-- Wird dynamisch bef√ºllt -->
        </div>
      </div>

      <!-- Angebots-Kacheln (Hero Cards - horizontal) -->
      <div class="discover-offers" id="discoverOffers">
        <!-- Wird dynamisch bef√ºllt -->
      </div>
      <p class="hint" id="discoverEmpty" style="display:none; text-align:center; padding:40px 20px;">
        Noch keine Angebote. Demo: Als Anbieter ein Inserat erstellen.
      </p>
    </section>

    <section class="view" id="v-provider-billing">
      <div class="panel">
        <h3>Abrechnungen</h3>
        <div class="hint">Auszahlbarer Betrag</div>
        <div style="font-size:24px;font-weight:900" id="billingAmount">0,00 ‚Ç¨</div>
        <div class="hint" id="billingLast">Letzte Auszahlung: ‚Äì</div>
      </div>

      <div style="height:12px"></div>
      <div class="panel">
        <div class="hint">Filter</div>
        <div class="answers" id="billingFilters"></div>
        <div style="height:8px"></div>
        <select class="field" id="billingMonth">
          <option value="2026-01">Januar 2026</option>
          <option value="2025-12">Dezember 2025</option>
          <option value="2025-11">November 2025</option>
        </select>
        <div style="height:10px"></div>
        <div id="billingList" class="hint">Noch keine Abrechnungen.</div>
      </div>

      <div style="height:12px"></div>
      <button class="btn ghost" type="button" id="btnBillingBack">Zur√ºck</button>
    </section>

    <!-- CUSTOMER: Favorites -->
    <section class="view" id="v-fav">
      <div class="panel">
        <div class="section-title">Anbieter-Favoriten</div>
        <div class="grid" id="favProviders"></div>
        <div class="hint" id="emptyFavProviders" style="display:none;">Noch keine Anbieter-Favoriten.</div>
        <div class="section-title" style="margin-top:12px;">Gericht-Favoriten</div>
        <div class="grid" id="favDishes"></div>
        <div class="hint" id="emptyFavDishes" style="display:none;">Noch keine Gericht-Favoriten.</div>
      </div>
    </section>

    <!-- CUSTOMER: Orders -->
    <section class="view" id="v-orders">
      <div class="panel">
        <h3>Mittagsbox</h3>
        <div class="hint">Deine aktiven Tickets (Abholcodes)</div>
        <div class="answers" id="ordersFilters" style="margin-top:12px;"></div>
        <div style="height:10px"></div>
        <div id="ordersList" class="hint">Noch keine Bestellungen.</div>
      </div>
    </section>

    <!-- CUSTOMER: Cart -->
    <section class="view" id="v-cart">
      <div class="panel">
        <h3>Warenkorb</h3>
        <div id="cartBox" class="hint">Dein Warenkorb ist leer.</div>
        <button class="btn" id="btnCheckout" type="button" style="display:none;" data-icon="card">Weiter zur Zahlung</button>
        <div class="mini" id="cartNote" style="display:none;">
          Warenkorb nur mit Abholcode. Ein Anbieter pro Warenkorb.
        </div>
      </div>
    </section>

    <!-- CUSTOMER: Profile -->
    <section class="view" id="v-profile">
      <div class="panel">
        <h3>Profil</h3>
        <div id="profileLoginSection">
          <input class="field" id="unifiedEmail" type="email" placeholder="E-Mail" autocomplete="email" style="margin-top:12px;" />
          <div style="height:10px"></div>
          <input class="field" id="unifiedPass" type="password" placeholder="Passwort" autocomplete="current-password" />
          <button class="btn" type="button" id="btnUnifiedLogin" style="margin-top:16px;">Anmelden</button>
          <div style="margin-top:12px; text-align:center;">
            <button class="btn ghost" type="button" id="btnUnifiedLoginDemo" style="width:auto; padding:8px 16px;">Demo-Login (ohne Anmeldung)</button>
          </div>
          <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--border); text-align:center;">
            <a href="#" id="linkProviderLogin" style="font-size:13px; color:var(--muted); text-decoration:none;">
              Du bist Gastronom? Hier lang ‚Üí
            </a>
          </div>
        </div>
        <div id="profileLoggedInSection" style="display:none;">
          <div style="margin-top:12px;" class="hint" id="customerStatus">Nicht angemeldet (Demo).</div>
          <button class="btn secondary" type="button" id="btnUnifiedLogout" style="margin-top:12px;">Abmelden</button>
        </div>
      </div>

      <div class="panel" style="margin-top:12px;">
        <div class="section-title">FAQ</div>
        <div class="faq">
          <details>
            <summary>Wie funktioniert Mittagio?</summary>
            <p>Du findest Mittagsangebote in deiner Stadt, optional bezahlst du online und holst zur gew√§hlten Zeit ab.</p>
          </details>
          <details>
            <summary>Ist Online-Zahlung Pflicht?</summary>
            <p>Nein. Online-Zahlung ist optional. Eine Abholnummer gibt‚Äôs nur bei Online-Zahlung.</p>
          </details>
          <details>
            <summary>Was ist der Abholcode?</summary>
            <p>Dein Schnell-Ticket f√ºr die Mittagspause.</p>
          </details>
          <details>
            <summary>Kann ich ohne Abholcode bestellen?</summary>
            <p>Nein. Angebote ohne Abholcode kannst du nur ansehen.</p>
          </details>
          <details>
            <summary>Wann kann ich abholen?</summary>
            <p>Innerhalb der Essenszeit. W√§hle eine ungef√§hre Abholzeit im Warenkorb.</p>
          </details>
          <details>
            <summary>Kann ich f√ºr mehrere Personen bestellen?</summary>
            <p>Ja. Du kannst mehrere Gerichte in einem Vorgang bestellen (eine Abholnummer).</p>
          </details>
          <details>
            <summary>Vor Ort essen m√∂glich?</summary>
            <p>Wenn das Badge ‚ÄûVor Ort‚Äú angezeigt wird, kannst du vor Ort essen.</p>
          </details>
          <details>
            <summary>Teilen</summary>
            <p>Teile Angebote per WhatsApp, Instagram oder Website.</p>
          </details>
        </div>
      </div>

      <!-- Rechtliches -->
      <div class="panel" style="margin-top:12px;">
        <div class="section-title">Rechtliches</div>
        <div class="rowlist">
          <button class="rowbtn" type="button" id="btnImpressum">
            <div class="rowbtn-left">
              <div class="rowbtn-ico"><i data-lucide="file-text"></i></div>
              <div class="rowbtn-text">Impressum</div>
            </div>
            <div class="chev">‚Ä∫</div>
          </button>
          <button class="rowbtn" type="button" id="btnAGB">
            <div class="rowbtn-left">
              <div class="rowbtn-ico"><i data-lucide="file-text"></i></div>
              <div class="rowbtn-text">AGB</div>
            </div>
            <div class="chev">‚Ä∫</div>
          </button>
          <button class="rowbtn" type="button" id="btnDatenschutz">
            <div class="rowbtn-left">
              <div class="rowbtn-ico"><i data-lucide="shield"></i></div>
              <div class="rowbtn-text">Datenschutz</div>
            </div>
            <div class="chev">‚Ä∫</div>
          </button>
        </div>
      </div>

      <!-- Anbieter-Switch (nur wenn eingeloggt) -->
      <div class="panel" id="providerSwitchPanel" style="margin-top:12px; display:none;">
        <div class="section-title">Anbieter-Modus</div>
        <div class="hint">Wechsle zum Anbieter-Dashboard</div>
        <button class="btn" type="button" id="btnSwitchToProvider" style="margin-top:12px;">
          <i data-lucide="store" style="width:18px; height:18px; margin-right:8px;"></i>
          Zum Anbieter-Modus
        </button>
      </div>
    </section>

    <!-- PROVIDER: Login page (f√ºr direkten Zugriff) -->
    <section class="view" id="v-provider-login">
      <div class="panel">
        <h3>Anbieter-Login</h3>
        <div class="hint">Melde dich als Gastronom an</div>
        <input class="field" id="provEmail" type="email" placeholder="E-Mail" autocomplete="email" style="margin-top:12px;" />
        <div style="height:10px"></div>
        <input class="field" id="provPass" type="password" placeholder="Passwort" autocomplete="current-password" />
        <button class="btn" type="button" id="btnProvLogin" style="margin-top:16px;">Einloggen</button>
        <button class="btn secondary" type="button" id="btnProvBack" style="margin-top:8px;">Zur√ºck</button>
        <p class="hint" style="margin-top:12px;">Demo: beliebige E-Mail/Passwort -> du bist drin. (Sp√§ter: Firebase Auth.)</p>
      </div>
    </section>

    <!-- PROVIDER: Onboarding -->
    <section class="view" id="v-provider-onboarding">
      <!-- Schritt 1: Betriebsname -->
      <div class="panel onboarding-step" data-step="1">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 1 von 5</div>
          <button class="btn ghost" type="button" id="btnOnboardingBack" style="width:auto; padding:8px 12px; margin-top:8px;">
            ‚Üê Zur√ºck
          </button>
        </div>
        <h3 style="margin-top:16px;">Wie hei√üt dein Betrieb?</h3>
        <div class="hint">Gib den Namen deines Restaurants, Caf√©s oder Betriebs ein.</div>
        <input class="field" id="onboardingBusinessName" type="text" placeholder="z.B. Caf√© Sonnenschein" style="margin-top:12px;" />
        <button class="btn" type="button" id="btnOnboardingStep1Next" style="margin-top:16px;">Weiter</button>
      </div>

      <!-- Schritt 2: Adresse -->
      <div class="panel onboarding-step" data-step="2" style="display:none;">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 2 von 5</div>
          <button class="btn ghost" type="button" id="btnOnboardingStep2Back" style="width:auto; padding:8px 12px; margin-top:8px;">
            ‚Üê Zur√ºck
          </button>
        </div>
        <h3 style="margin-top:16px;">Adresse deines Betriebs</h3>
        <div class="hint">Wo k√∂nnen G√§ste dein Essen abholen?</div>
        <div class="loc-row" style="margin-top:12px;">
          <input class="field" id="onboardingAddress" type="text" placeholder="Stra√üe und Hausnummer" />
          <button class="pin-btn" type="button" id="btnOnboardingLocationPin" aria-label="Standort setzen"></button>
        </div>
        <input class="field" id="onboardingPostalCode" type="text" placeholder="PLZ" style="margin-top:10px;" />
        <input class="field" id="onboardingCity" type="text" placeholder="Stadt" style="margin-top:10px;" />
        <button class="btn" type="button" id="btnOnboardingStep2Next" style="margin-top:16px;">Weiter</button>
      </div>

      <!-- Schritt 3: Essenszeit -->
      <div class="panel onboarding-step" data-step="3" style="display:none;">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 3 von 5</div>
          <button class="btn ghost" type="button" id="btnOnboardingStep3Back" style="width:auto; padding:8px 12px; margin-top:8px;">
            ‚Üê Zur√ºck
          </button>
        </div>
        <h3 style="margin-top:16px;">Wann k√∂nnen G√§ste dein Essen genie√üen?</h3>
        <div class="hint">W√§hle die Standard-Zeiten f√ºr deine Essensausgabe.</div>
        
        <div style="margin-top:16px;">
          <div class="hint" style="margin-bottom:6px;">Startzeit</div>
          <div class="w-actions">
            <button class="btn secondary time-btn" type="button" data-time="11:00">11:00</button>
            <button class="btn secondary time-btn" type="button" data-time="11:30">11:30</button>
            <button class="btn secondary time-btn" type="button" data-time="12:00">12:00</button>
            <button class="btn secondary time-btn" type="button" data-time="12:30">12:30</button>
          </div>
          <input class="field" id="onboardingMealStart" type="time" placeholder="Startzeit" style="margin-top:10px;" />
        </div>

        <div style="margin-top:16px;">
          <div class="hint" style="margin-bottom:6px;">Endzeit</div>
          <div class="w-actions">
            <button class="btn secondary time-btn" type="button" data-time="14:00">14:00</button>
            <button class="btn secondary time-btn" type="button" data-time="14:30">14:30</button>
            <button class="btn secondary time-btn" type="button" data-time="15:00">15:00</button>
            <button class="btn secondary time-btn" type="button" data-time="15:30">15:30</button>
          </div>
          <input class="field" id="onboardingMealEnd" type="time" placeholder="Endzeit" style="margin-top:10px;" />
        </div>

        <button class="btn" type="button" id="btnOnboardingStep3Next" style="margin-top:20px;">Weiter</button>
      </div>

      <!-- Schritt 4: Logo -->
      <div class="panel onboarding-step" data-step="4" style="display:none;">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 4 von 5</div>
          <button class="btn ghost" type="button" id="btnOnboardingStep4Back" style="width:auto; padding:8px 12px; margin-top:8px;">
            ‚Üê Zur√ºck
          </button>
        </div>
        <h3 style="margin-top:16px;">Logo hochladen</h3>
        <div class="hint">Optional: Lade ein Logo f√ºr deinen Betrieb hoch. Du kannst das auch sp√§ter machen.</div>
        
        <div style="margin-top:20px; text-align:center;">
          <div class="onboarding-logo-preview" id="onboardingLogoPreview" style="width:120px; height:120px; margin:0 auto; border-radius:18px; border:2px dashed var(--border); background:#f8f7f3; display:flex; align-items:center; justify-content:center; cursor:pointer; position:relative; overflow:hidden;">
            <div style="text-align:center; color:var(--muted); font-size:12px;">
              <div style="font-size:32px; margin-bottom:8px;">üì∑</div>
              <div>Logo hinzuf√ºgen</div>
            </div>
            <img id="onboardingLogoImg" style="display:none; width:100%; height:100%; object-fit:cover;" />
          </div>
          <input type="file" id="onboardingLogoInput" accept="image/*" style="display:none;" />
          <button class="btn secondary" type="button" id="btnOnboardingLogoRemove" style="margin-top:12px; display:none;">Logo entfernen</button>
        </div>

        <button class="btn" type="button" id="btnOnboardingStep4Next" style="margin-top:20px;">Weiter</button>
        <button class="btn ghost" type="button" id="btnOnboardingSkipLogo" style="margin-top:8px;">√úberspringen</button>
      </div>

      <!-- Schritt 5: Zusammenfassung -->
      <div class="panel onboarding-step" data-step="5" style="display:none;">
        <div class="onboarding-header">
          <div class="onboarding-progress">Schritt 5 von 5</div>
        </div>
        <h3 style="margin-top:16px;">Profil ist bereit! üéâ</h3>
        <div class="hint">Hier ist eine Zusammenfassung deiner Angaben:</div>
        
        <div class="onboarding-summary" style="margin-top:20px; padding:16px; background:#f8f7f3; border-radius:14px; border:1px solid var(--border);">
          <div class="onboarding-summary-item" style="margin-bottom:12px;">
            <div style="font-weight:900; font-size:14px;" id="summaryBusinessName">‚Äì</div>
            <div class="hint" id="summaryAddress" style="margin-top:4px;">‚Äì</div>
          </div>
          <div class="onboarding-summary-item" style="margin-bottom:12px;">
            <div class="hint" style="margin-bottom:4px;">Essenszeit</div>
            <div style="font-weight:900;" id="summaryMealTime">‚Äì</div>
          </div>
          <div class="onboarding-summary-item" id="summaryLogoContainer" style="display:none;">
            <div class="hint" style="margin-bottom:4px;">Logo</div>
            <div id="summaryLogo" style="width:60px; height:60px; border-radius:12px; overflow:hidden; border:1px solid var(--border);">
              <img id="summaryLogoImg" style="width:100%; height:100%; object-fit:cover;" />
            </div>
          </div>
        </div>

        <button class="btn" type="button" id="btnOnboardingComplete" style="margin-top:24px;">Erstes Gericht erstellen</button>
        <button class="btn secondary" type="button" id="btnOnboardingEdit" style="margin-top:8px;">Angaben bearbeiten</button>
      </div>
    </section>

    <!-- PROVIDER APP -->
    <section class="view" id="v-provider-home">
      <div class="panel">
        <div class="provider-header">
          <div class="provider-logo compact">
            <div class="plogo" id="provCardLogo"></div>
            <div>
              <div style="font-weight:900" id="provCardName">Anbieter</div>
              <div class="hint" id="provCardAddr"></div>
            </div>
          </div>
          <div class="header-actions">
            <button class="btn" type="button" id="btnNewListing" data-icon="plus">Neues Inserat</button>
            <button class="btn secondary" type="button" id="btnFromCookbook" data-icon="book">Aus Kochbuch</button>
          </div>
        </div>
      </div>

      <div style="height:12px"></div>
      <div class="panel">
        <h3>Heute</h3>
        <div class="hint">Aktive Inserate f√ºr heute. Online-Abholcodes sind markiert.</div>
        <div class="hint" id="provTodayCount" style="margin-top:6px;"></div>
        <div id="provTodayGrid" class="grid" style="margin-top:10px"></div>
        <div id="provTodayEmpty" class="hint">Noch keine Inserate f√ºr heute.</div>
      </div>

      <div style="height:12px"></div>
      <div class="panel" id="provWeekPanel">
        <h3>Wochenvorschau</h3>
        <div class="hint">Swipe nach links/rechts ¬∑ Tippen f√ºr Aktionen</div>
        <div class="dayrow" id="provWeekDays" style="padding:0 0 10px; max-width:none;"></div>
        <div id="provWeekPreview" class="hint">Noch nichts geplant.</div>
        <button class="btn secondary" type="button" id="btnOpenWeekPlan" data-icon="calendar">Wochenplan anzeigen</button>
      </div>
    </section>

    <section class="view" id="v-provider-pickups">
      <div class="panel">
        <h3>Abholungen</h3>
        <div id="provPickupsEmpty" class="hint">
          Aktuell keine Abholungen geplant.<br>
          Geplante Abholungen sorgen f√ºr weniger Chaos.
          <div style="height:10px"></div>
          <button class="btn secondary" type="button" id="btnPickupsFaq" data-icon="info">Mehr erfahren</button>
        </div>
        <div id="provPickupsWrap" style="display:none;">
          <div class="hint" style="margin-top:8px;">Sortierung</div>
          <div class="answers" id="provPickupSort"></div>
          <div id="provPickupGroups" style="margin-top:10px;"></div>
        </div>
      </div>
    </section>

    <section class="view" id="v-provider-week">
      <div class="panel">
        <h3>Wochenplan</h3>
        <div class="dayrow" id="weekDays" style="padding:0 0 10px; max-width:none;"></div>
        <div id="weekList" class="hint">Noch nichts geplant.</div>
        <button class="btn secondary" type="button" id="btnWeekPdf" data-icon="print">PDF-Wochenkarte erstellen</button>
        <button class="btn ghost" type="button" id="btnWeekBack">Zur√ºck</button>
      </div>
    </section>

    <section class="view" id="v-provider-cookbook">
      <div class="panel">
        <h3>Mein Kochbuch</h3>
        <div class="hint">Dein digitales Kochbuch. Immer griffbereit f√ºr deine Planung.</div>
        <div style="height:10px"></div>
        <div class="tabrow" id="cookbookTabs"></div>
        <div style="height:10px"></div>
        <input class="field" id="cookbookSearch" type="text" placeholder="Suche nach Gerichten" />
        <div style="height:10px"></div>
        <div class="hint">Sortierung</div>
        <div class="answers" id="cookbookSorts"></div>
        <button class="btn" type="button" id="btnCookbookAdd" data-icon="plus">Gericht hinzuf√ºgen</button>
        <div style="height:10px"></div>
        <div id="cookbookList" class="hint">Noch keine Gerichte gespeichert.</div>
      </div>
    </section>

    <section class="view" id="v-provider-profile">
      <div class="panel">
        <div class="profile-head">
          <div class="plogo" id="provProfileLogo"></div>
          <div class="profile-meta">
            <div style="font-weight:900" id="provProfileName">Anbieter</div>
            <div class="hint" id="provProfileCity"></div>
            <div class="profile-chip" id="provProfileMeal"></div>
          </div>
        </div>
        <div class="profile-actions">
          <button class="btn" type="button" id="btnProvSetup" data-icon="edit">Profil bearbeiten</button>
        </div>
      </div>

      <div style="height:12px"></div>
      <div class="panel">
        <div class="row-group">
          <div class="rowgroup-title">Profil & Betrieb</div>
          <div class="rowlist">
            <button class="rowbtn" type="button" id="rowProfileOverview">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="user" data-icon-only="1"></div>
                <div class="rowbtn-text">Mein Profil<span>√úbersicht</span></div>
              </div>
              <div class="chev">‚Ä∫</div>
            </button>
            <button class="rowbtn" type="button" id="btnBilling">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="wallet" data-icon-only="1"></div>
                <div class="rowbtn-text">Meine Abrechnungen</div>
              </div>
              <div class="chev">‚Ä∫</div>
            </button>
          </div>
        </div>

        <div class="row-group">
          <div class="rowgroup-title">Aktionen</div>
          <div class="rowlist">
            <button class="rowbtn" type="button" id="btnProvShareOffer">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="share" data-icon-only="1"></div>
                <div class="rowbtn-text">Angebot teilen</div>
              </div>
              <div class="chev">‚Ä∫</div>
            </button>
            <button class="rowbtn" type="button" id="btnProvWeekPdf">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="print" data-icon-only="1"></div>
                <div class="rowbtn-text">Wochenkarte als PDF</div>
              </div>
              <div class="chev">‚Ä∫</div>
            </button>
          </div>
        </div>

        <div class="row-group">
          <div class="rowgroup-title">Hilfe</div>
          <div class="rowlist">
            <button class="rowbtn" type="button" id="btnProvFaq">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="info" data-icon-only="1"></div>
                <div class="rowbtn-text">FAQ</div>
              </div>
              <div class="chev">‚Ä∫</div>
            </button>
            <button class="rowbtn" type="button" id="btnProvSupport">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="mail" data-icon-only="1"></div>
                <div class="rowbtn-text">Support kontaktieren<span>√ñffnet dein Mail-Programm</span></div>
              </div>
              <div class="chev">‚Ä∫</div>
            </button>
          </div>
        </div>

        <div class="row-group">
          <div class="rowgroup-title">Rechtliches</div>
          <div class="rowlist">
            <button class="rowbtn" type="button" id="btnLegalImprint">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="file" data-icon-only="1"></div>
                <div class="rowbtn-text">Impressum</div>
              </div>
              <div class="chev">‚Ä∫</div>
            </button>
            <button class="rowbtn" type="button" id="btnLegalPrivacy">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="shield" data-icon-only="1"></div>
                <div class="rowbtn-text">Datenschutz</div>
              </div>
              <div class="chev">‚Ä∫</div>
            </button>
            <button class="rowbtn" type="button" id="btnLegalTerms">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="file" data-icon-only="1"></div>
                <div class="rowbtn-text">AGB</div>
              </div>
              <div class="chev">‚Ä∫</div>
            </button>
            <button class="rowbtn" type="button" id="btnLegalPricing">
              <div class="rowbtn-left">
                <div class="rowbtn-ico" data-icon="card" data-icon-only="1"></div>
                <div class="rowbtn-text">Preise & Konditionen</div>
              </div>
              <div class="chev">‚Ä∫</div>
            </button>
          </div>
        </div>
      </div>

      <div style="height:12px"></div>
      <div class="row-muted">Kein Abo ¬∑ Keine Laufzeit ¬∑ Kein Vertrag</div>
      <div style="height:12px"></div>
      <button class="btn ghost" type="button" id="btnProvLogout">Logout</button>

      <div id="provFaqBox" style="display:none;">
        <div class="panel">
          <div class="section-title">FAQ (Anbieter)</div>
          <div class="faq">
            <details>
              <summary>Was ist Mittagio?</summary>
              <p>Mittagio ist eine Online-Plattform, auf der du dein Mittagsangebot sichtbar machst ‚Äì schnell, einfach und flexibel.</p>
            </details>
            <details>
              <summary>Wie verdiene ich damit Zeit?</summary>
              <p>Du legst Gerichte einmal an (Kochbuch) und ver√∂ffentlichst sie mit einem Klick. Weniger Telefonate, weniger Chaos.</p>
            </details>
            <details>
              <summary>Muss Online-Zahlung aktiv sein?</summary>
              <p>Nein. Online-Zahlung ist optional. Abholnummern gibt‚Äôs nur bei Online-Zahlung.</p>
            </details>
            <details>
              <summary>Wie kann ich mein Angebot teilen?</summary>
              <p>Mit einem Tap: WhatsApp, Instagram oder Homepage ‚Äì Text ist automatisch vorbereitet.</p>
            </details>
            <details>
              <summary>Kein Abo / keine Provision?</summary>
              <p>Ja. Fixpreis pro Inserat (aktuell 4,99 EUR). Keine Mindestlaufzeit.</p>
            </details>
            <details>
              <summary>Wie funktionieren Abholungen?</summary>
              <p>Wenn Abholcode aktiv ist, werden die Codes nach Gericht gruppiert angezeigt. Tippe einen Code an, sobald ein Gast abgeholt hat.</p>
            </details>
            <details>
              <summary>Warum Abholcode?</summary>
              <p>Vorab bezahlt, weniger Chaos an der Ausgabe und ein klarer Ablauf pro Bestellung.</p>
            </details>
            <details>
              <summary>Was kostet Abholcode?</summary>
              <p>49 Cent pro bezahltem Vorgang. (Auch wenn der Kunde mehrere Gerichte in einem Vorgang holt.)</p>
            </details>
            <details>
              <summary>Wie spare ich Zeit?</summary>
              <p>Speichere Gerichte im Kochbuch und ver√∂ffentliche sie mit 2-3 Taps erneut.</p>
            </details>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- CUSTOMER bottom nav - Mittagio-Bar -->
  <nav class="bottom" id="customerNav">
    <button class="navbtn active" data-go="discover" style="position:relative;">
      <div class="ico"><i data-lucide="utensils"></i></div>
      <div>Entdecken</div>
    </button>
    <button class="navbtn" data-go="fav" style="position:relative;">
      <div class="ico"><i data-lucide="heart"></i></div>
      <div>Favoriten</div>
    </button>
    <button class="navbtn" data-go="cart" style="position:relative;">
      <div class="ico"><i data-lucide="shopping-bag"></i></div>
      <div>Essenskorb</div>
      <span class="badge-notification" id="cartBadge" style="display:none;"></span>
    </button>
    <button class="navbtn" data-go="orders" style="position:relative;">
      <div class="ico"><i data-lucide="box"></i></div>
      <div>Mittagsbox</div>
    </button>
    <button class="navbtn" data-go="profile" style="position:relative;">
      <div class="ico"><i data-lucide="user"></i></div>
      <div>Profil</div>
    </button>
  </nav>

  <!-- PROVIDER bottom nav -->
  <nav class="bottom" id="providerNav" style="display:none;">
    <button class="navbtn active" data-pgo="provider-home"><div class="ico" data-icon="home" data-icon-only="1"></div><div>Home</div></button>
    <button class="navbtn" data-pgo="provider-pickups"><div class="ico" data-icon="receipt" data-icon-only="1"></div><div>Abholungen</div></button>
    <button class="navbtn" data-pgo="provider-cookbook"><div class="ico" data-icon="bookOpen" data-icon-only="1"></div><div>Kochbuch</div></button>
    <button class="navbtn" data-pgo="provider-profile"><div class="ico" data-icon="user" data-icon-only="1"></div><div>Profil</div></button>
  </nav>
</div>

<!-- Offer sheet -->
<div class="backdrop" id="bd" onclick="closeSheet()"></div>
<div class="sheet" id="sheet">
  <button class="back-button" type="button" onclick="closeSheet()" aria-label="Zur√ºck">
    <i data-lucide="arrow-left"></i>
  </button>
  <div class="handle"></div>
  <div class="sheet-img"><img id="sImg" alt="" /></div>
  <div class="sheet-body">
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;">
      <div>
        <div style="font-weight:950;font-size:18px" id="sDish"></div>
        <div style="color:#444;font-size:13px;margin-top:4px" id="sProvider"></div>
      </div>
      <div style="text-align:right">
        <div class="price" id="sPrice"></div>
        <div class="tag" id="sCat" style="margin-top:8px"></div>
      </div>
    </div>

    <div class="row"><span>Abholfenster</span><b id="sWindow"></b></div>
    <div class="row"><span>Adresse</span><a id="sAddr" href="#" target="_blank" rel="noopener">√∂ffnen</a></div>
    <div class="row"><span>Entfernung</span><b id="sDistance"></b></div>
    <div class="row"><span>Verf√ºgbar</span><b id="sAvail"></b></div>

    <div id="sAllergensWrap" style="display:none">
      <div class="row"><span>Allergene</span><span id="sAllergens" style="text-align:right;color:var(--muted)"></span></div>
    </div>
    <div id="sExtrasWrap" style="display:none">
      <div class="row"><span>Extras</span><span id="sExtras" style="text-align:right;color:var(--muted)"></span></div>
    </div>
    <div id="sReuseWrap" style="display:none">
      <div class="row"><span>Mehrweg / Pfand</span><span id="sReuse" style="text-align:right;color:var(--muted)"></span></div>
    </div>

    <button class="btn" type="button" id="btnAddCart" data-icon="cart">In den Warenkorb</button>
    <button class="btn secondary" type="button" id="btnShare" data-icon="share">Teilen</button>
    <button class="btn ghost" type="button" id="btnDishFav" data-icon="heart">Gericht speichern</button>
    <button class="btn ghost" type="button" id="btnFav" data-icon="heart">Anbieter speichern</button>
    <div class="mini" id="sCodeNote"></div>
  </div>
</div>

<!-- Provider offer sheet -->
<div class="backdrop" id="pbd" onclick="closeProviderSheet()"></div>
<div class="sheet" id="psheet">
  <div class="handle"></div>
  <div class="sheet-body">
    <div id="pPreview"></div>
    <div class="row"><span>Status</span><b id="pStatus"></b></div>
    <div class="row"><span>Essenszeit</span><b id="pWindow"></b></div>
    <button class="btn" type="button" id="btnEditOffer" data-icon="edit">Bearbeiten</button>
    <button class="btn secondary" type="button" id="btnToggleOffer" data-icon="action">Deaktivieren</button>
    <button class="btn ghost" type="button" id="btnShareOffer" data-icon="share">Teilen</button>
    <button class="btn ghost" type="button" id="btnPrintOffer" data-icon="print">Drucken</button>
  </div>
</div>

<!-- Quick-Ticket (bildschirmf√ºllend) -->
<div class="backdrop" id="codeBd" onclick="closeCodeSheet()"></div>
<div class="quick-ticket" id="codeSheet">
  <button class="quick-ticket-close" onclick="closeCodeSheet()" aria-label="Schlie√üen">
    <i data-lucide="x"></i>
  </button>
  <div class="quick-ticket-content">
    <div class="quick-ticket-header">
      <div class="quick-ticket-logo" id="codeProviderLogo"></div>
      <div class="quick-ticket-provider" id="codeProvider">Anbieter</div>
      <div class="quick-ticket-time" id="codePickupWindow">Essenszeit: ‚Äì</div>
    </div>
    <div class="quick-ticket-code">
      <div class="quick-ticket-code-label">Abholcode</div>
      <div class="quick-ticket-code-value" id="codeText">A1</div>
    </div>
    <div class="quick-ticket-details">
      <div class="quick-ticket-detail-item">
        <div class="quick-ticket-detail-label">Gericht</div>
        <div class="quick-ticket-detail-value" id="codeSummary">‚Äì</div>
      </div>
      <div class="quick-ticket-detail-item">
        <div class="quick-ticket-detail-label">Abholzeit</div>
        <div class="quick-ticket-detail-value" id="codePickupTime">offen</div>
      </div>
    </div>
    <div class="quick-ticket-status" id="codeStatus">Status: offen</div>
    <div class="quick-ticket-actions">
      <button class="btn" type="button" id="btnToggleOrderStatus">Als abgeholt markieren</button>
    </div>
  </div>
</div>

<!-- Share sheet -->
<div class="backdrop" id="shareBd" onclick="closeShareSheet()"></div>
<div class="sheet" id="shareSheet">
  <div class="handle"></div>
  <div class="sheet-body">
    <div class="panel">
      <div style="font-weight:900">Teilen</div>
      <div class="hint" id="sharePreview"></div>
    </div>
    <div class="answers" style="margin-top:10px;">
      <button class="ans" type="button" id="btnShareWhatsApp" data-icon="message">WhatsApp</button>
      <button class="ans" type="button" id="btnShareInstagram" data-icon="camera">Instagram</button>
      <button class="ans" type="button" id="btnShareWebsite" data-icon="globe">Website</button>
      <button class="ans" type="button" id="btnShareCopy" data-icon="link">Link kopieren</button>
    </div>
    <button class="btn secondary" type="button" id="btnShareClose" data-icon="action">Schlie√üen</button>
  </div>
</div>

<!-- Snackbar: Undo pickup -->
<div class="snackbar" id="pickupUndo">
  <span id="pickupUndoLabel">Abholung markiert</span>
  <button type="button" id="pickupUndoBtn">R√ºckg√§ngig</button>
</div>

<!-- Print view -->
<div id="printView" class="print-view"></div>

<!-- Provider Wizard sheet (single reusable) -->
<div class="backdrop" id="wbd" onclick="closeWizard()"></div>
<div class="sheet" id="wizard">
  <div class="handle"></div>
  <div class="sheet-body">
    <div class="wizard" id="wBox">
      <div class="w-top">
        <div class="w-title" id="wTitle">Setup</div>
        <div class="w-step" id="wStep">1/6</div>
      </div>
      <div class="w-q" id="wQ">‚Ä¶</div>
      <p class="w-help" id="wHelp"></p>
      <div id="wContent"></div>
      <div class="w-actions">
        <button class="btn secondary" type="button" id="wBack">Zur√ºck</button>
        <button class="btn" type="button" id="wNext">Weiter</button>
      </div>
    </div>
  </div>
</div>

<script>
  // --- Storage keys ---
  const LS = {
    offers: 'mittagio_offers_v2',
    favs: 'mittagio_favs_v1',
    providerFavs: 'mittagio_provider_favs_v1',
    dishFavs: 'mittagio_dish_favs_v1',
    cart: 'mittagio_cart_v1',
    orders: 'mittagio_orders_v1',
    customer: 'mittagio_customer_v1',
    provider: 'mittagio_provider_v1',
    cookbook: 'mittagio_cookbook_v1',
    week: 'mittagio_week_v1',
    pickupDone: 'mittagio_pickup_done_v1',
    mode: 'mittagio_mode_v1'
  };
  const load = (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch { return d; } };
  const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

  // --- State ---
  let mode = 'start'; // 'start' | 'customer' | 'provider'
  let offers = load(LS.offers, []);
  const legacyFavs = load(LS.favs, []);
  let providerFavs = new Set(load(LS.providerFavs, legacyFavs));
  let dishFavs = new Set(load(LS.dishFavs, []));
  let cart = load(LS.cart, null); // {providerId, items:[{offerId, qty}]} or null
  let orders = load(LS.orders, []); // [{id, providerName, summary, code, status, createdAt}]
  let customer = load(LS.customer, { loggedIn:false, name:null });
  let provider = load(LS.provider, { loggedIn:false, email:null, profile:{ name:'', address:'', street:'', zip:'', city:'', mealWindow:'11:30 ‚Äì 14:00', logoData:'' } });
  let cookbook = load(LS.cookbook, []); // [{id, dish, category, price, allergens[], extras?, reuse? , photoData?}]
  let week = load(LS.week, {}); // { 'YYYY-MM-DD': [cookbookId,...] }

  const CATEGORIES = ['Vegetarisch','Vegan','Mit Fleisch'];
  const CAT_MAP = {
    'Vegan':'Vegan',
    'Vegetarisch':'Vegetarisch',
    'Mit Fleisch':'Fleisch'
  };
  const DISH_SUGGESTIONS = [
    {name:'K√ºrbissuppe', category:'Vegan'},
    {name:'Tomatensuppe mit Brot', category:'Vegan'},
    {name:'Pasta mit Gem√ºse', category:'Vegetarisch'},
    {name:'K√§sesp√§tzle', category:'Vegetarisch'},
    {name:'Salat Bowl', category:'Vegetarisch'},
    {name:'Falafel Teller', category:'Vegan'},
    {name:'Veggie Burger', category:'Vegan'},
    {name:'Schnitzel mit Pommes', category:'Fleisch'},
    {name:'Currywurst', category:'Fleisch'},
    {name:'Gulasch mit Sp√§tzle', category:'Fleisch'}
  ];

  // Day slider: today..+6
  function fmtDay(d){
    const wd = ['So','Mo','Di','Mi','Do','Fr','Sa'][d.getDay()];
    return `${wd}, ${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.`;
  }
  function isoDate(d){ return d.toISOString().slice(0,10); }

  let activeCat = null;
  let activeDay = isoDate(new Date());
  let providerWeekDay = isoDate(new Date());
  let pickupSort = 'time';
  let cookbookSort = 'recent';
  let cookbookQuery = '';
  let cookbookTab = 'dishes';
  let weekPlanDay = isoDate(new Date());
  let locationQuery = '';
  let pickupDone = new Set(load(LS.pickupDone, []));
  let activeOrderId = null;
  let ordersFilter = 'offen';
  let sharePayload = { text:'', url:'' };
  let pickupUndoKey = null;
  let pickupUndoTimer = null;
  let billingFilter = 'month';
  let billingMonth = '2026-01';

  // --- Seed demo offers (Testanbieter) ---
  function seed(){
    // Testdaten immer erstellen (zum Testen)
    const today = isoDate(new Date());
    offers = [
      // 4 Testanbieter √ó 4 Gerichte (mit Bildern & je Abholcodes)
      
      // 1. Pizzeria Bella Vista (Stuttgart)
      {id: cryptoId(), providerId: 'p_bellavista', providerName: 'Pizzeria Bella Vista', address: 'Hauptstra√üe 45, 70173 Stuttgart', title: 'Pizza Prosciutto', price: 9.90, time: '11:30 ‚Äì 14:30', diet: 'Fleisch', day: today, img: 'https://images.unsplash.com/photo-1574071318508-1cdbab80d002?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 3},
      {id: cryptoId(), providerId: 'p_bellavista', providerName: 'Pizzeria Bella Vista', address: 'Hauptstra√üe 45, 70173 Stuttgart', title: 'Pizza Quattro Formaggi', price: 8.50, time: '11:30 ‚Äì 14:30', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1571997478779-2adcbbe9ab2f?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 4},
      {id: cryptoId(), providerId: 'p_bellavista', providerName: 'Pizzeria Bella Vista', address: 'Hauptstra√üe 45, 70173 Stuttgart', title: 'Pasta Carbonara', price: 8.80, time: '11:30 ‚Äì 14:30', diet: 'Fleisch', day: today, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 2},
      {id: cryptoId(), providerId: 'p_bellavista', providerName: 'Pizzeria Bella Vista', address: 'Hauptstra√üe 45, 70173 Stuttgart', title: 'Insalata Caprese', price: 7.20, time: '11:30 ‚Äì 14:30', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 3},

      // 2. Asia Wok Express (T√ºbingen)
      {id: cryptoId(), providerId: 'p_asiawok', providerName: 'Asia Wok Express', address: 'Neckarhalde 8, 72070 T√ºbingen', title: 'H√§hnchen Teriyaki', price: 8.90, time: '11:00 ‚Äì 14:00', diet: 'Fleisch', day: today, img: 'https://images.unsplash.com/photo-1603133872878-684f208fb84b?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 5},
      {id: cryptoId(), providerId: 'p_asiawok', providerName: 'Asia Wok Express', address: 'Neckarhalde 8, 72070 T√ºbingen', title: 'Gebratene Nudeln mit Gem√ºse', price: 7.50, time: '11:00 ‚Äì 14:00', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1569718212165-3a8278d5f624?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 4},
      {id: cryptoId(), providerId: 'p_asiawok', providerName: 'Asia Wok Express', address: 'Neckarhalde 8, 72070 T√ºbingen', title: 'Pad Thai', price: 8.40, time: '11:00 ‚Äì 14:00', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 3},
      {id: cryptoId(), providerId: 'p_asiawok', providerName: 'Asia Wok Express', address: 'Neckarhalde 8, 72070 T√ºbingen', title: 'Fr√ºhlingsrollen (4 St√ºck)', price: 6.80, time: '11:00 ‚Äì 14:00', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1529692236671-f1f6cf9683ba?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 6},

      // 3. Burger House (Ludwigsburg)
      {id: cryptoId(), providerId: 'p_burgerhouse', providerName: 'Burger House', address: 'Wilhelmstra√üe 12, 71634 Ludwigsburg', title: 'Classic Cheeseburger', price: 8.90, time: '11:30 ‚Äì 14:00', diet: 'Fleisch', day: today, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 4},
      {id: cryptoId(), providerId: 'p_burgerhouse', providerName: 'Burger House', address: 'Wilhelmstra√üe 12, 71634 Ludwigsburg', title: 'Veggie Burger', price: 7.90, time: '11:30 ‚Äì 14:00', diet: 'Vegetarisch', day: today, img: 'https://images.unsplash.com/photo-1525059696034-4967a7290027?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 3},
      {id: cryptoId(), providerId: 'p_burgerhouse', providerName: 'Burger House', address: 'Wilhelmstra√üe 12, 71634 Ludwigsburg', title: 'Chicken Burger', price: 9.20, time: '11:30 ‚Äì 14:00', diet: 'Fleisch', day: today, img: 'https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 5},
      {id: cryptoId(), providerId: 'p_burgerhouse', providerName: 'Burger House', address: 'Wilhelmstra√üe 12, 71634 Ludwigsburg', title: 'Sweet Potato Fries', price: 4.50, time: '11:30 ‚Äì 14:00', diet: 'Vegan', day: today, img: 'https://images.unsplash.com/photo-1573080496219-bb080dd4f877?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 8},

      // 4. Green Garden (Esslingen)
      {id: cryptoId(), providerId: 'p_greengarden', providerName: 'Green Garden', address: 'Marktplatz 7, 73728 Esslingen', title: 'Avocado-Bowl', price: 9.50, time: '11:00 ‚Äì 14:00', diet: 'Vegan', day: today, img: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 4},
      {id: cryptoId(), providerId: 'p_greengarden', providerName: 'Green Garden', address: 'Marktplatz 7, 73728 Esslingen', title: 'Quinoa-Salat', price: 8.20, time: '11:00 ‚Äì 14:00', diet: 'Vegan', day: today, img: 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 5},
      {id: cryptoId(), providerId: 'p_greengarden', providerName: 'Green Garden', address: 'Marktplatz 7, 73728 Esslingen', title: 'Falafel-Wrap', price: 7.80, time: '11:00 ‚Äì 14:00', diet: 'Vegan', day: today, img: 'https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 6},
      {id: cryptoId(), providerId: 'p_greengarden', providerName: 'Green Garden', address: 'Marktplatz 7, 73728 Esslingen', title: 'Gem√ºse-Curry', price: 8.60, time: '11:00 ‚Äì 14:00', diet: 'Vegan', day: today, img: 'https://images.unsplash.com/photo-1546069901-d5bfd2cbfb1f?auto=format&fit=crop&w=1200&q=60', hasPickupCode: true, pickupCodeCount: 3},
    ];
    save(LS.offers, offers);
  }

  // --- UI helpers ---
  function euro(n){
    const v = Number(n||0);
    return v.toFixed(2).replace('.',',') + ' ‚Ç¨';
  }
  function cryptoId(){
    return 'id_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
  }
  function esc(s){
    return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[c]));
  }

  const ICONS = {
    plus:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>',
    book:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M4 4.5A2.5 2.5 0 0 1 6.5 2H20v15H6.5A2.5 2.5 0 0 0 4 17.5z"/></svg>',
    share:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="m16 6-4-4-4 4"/><path d="M12 2v14"/></svg>',
    print:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 14h12v8H6z"/></svg>',
    edit:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>',
    action:'<svg viewBox="0 0 24 24" fill="currentColor"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/></svg>',
    heart:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.8 6.6a5 5 0 0 0-7.1 0L12 8.3l-1.7-1.7a5 5 0 1 0-7.1 7.1L12 22l8.8-8.3a5 5 0 0 0 0-7.1Z"/></svg>',
    cart:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2h12l2 7H4z"/><path d="M4 9h16v11a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V9Z"/></svg>',
    location:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s7-7.2 7-12a7 7 0 1 0-14 0c0 4.8 7 12 7 12z"/><circle cx="12" cy="10" r="2.5"/></svg>',
    star:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 2 3 7 7 .6-5.2 4.5 1.6 7L12 17l-6.4 4.1 1.6-7L2 9.6 9 9z"/></svg>',
    box:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7l9-4 9 4-9 4-9-4Z"/><path d="M3 7v10l9 4 9-4V7"/><path d="M12 11v10"/></svg>',
    leaf:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 14c6-8 14-8 16-6-2 8-10 16-18 14 0-6 2-8 2-8Z"/><path d="M6 14c2 0 6 0 10-4"/></svg>',
    flame:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2s3 4 3 7a3 3 0 1 1-6 0c0-3 3-7 3-7Z"/><path d="M5.5 14.5a6.5 6.5 0 1 0 13 0c0-3.5-2.5-6.5-6.5-9-4 2.5-6.5 5.5-6.5 9Z"/></svg>',
    calendar:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>',
    eye:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s4-6 10-6 10 6 10 6-4 6-10 6S2 12 2 12Z"/><circle cx="12" cy="12" r="3"/></svg>',
    info:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 10v6"/><path d="M12 7h.01"/></svg>',
    card:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/></svg>',
    home:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 11.5 12 4l9 7.5"/><path d="M5 10.5V20h14v-9.5"/></svg>',
    user:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20a8 8 0 0 1 16 0"/></svg>',
    compass:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M15 9l-2 6-6 2 2-6 6-2Z"/></svg>',
    receipt:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2h12v20l-3-2-3 2-3-2-3 2Z"/><path d="M8 6h8M8 10h8M8 14h6"/></svg>',
    bookOpen:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 5h7a4 4 0 0 1 4 4v12H6a4 4 0 0 0-4 4Z"/><path d="M22 5h-7a4 4 0 0 0-4 4v12h7a4 4 0 0 1 4 4Z"/></svg>',
    clock:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 7v6l4 2"/></svg>',
    globe:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M3 12h18"/><path d="M12 3a12 12 0 0 1 0 18"/><path d="M12 3a12 12 0 0 0 0 18"/></svg>',
    link:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 1 0-7l2-2a5 5 0 0 1 7 7l-2 2"/><path d="M14 11a5 5 0 0 1 0 7l-2 2a5 5 0 0 1-7-7l2-2"/></svg>',
    message:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a4 4 0 0 1-4 4H7l-4 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/></svg>',
    camera:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h4l2-3h4l2 3h4v12H4z"/><circle cx="12" cy="13" r="3"/></svg>',
    mail:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="m3 7 9 6 9-6"/></svg>',
    shield:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2 20 5v6c0 5-3.5 9-8 11-4.5-2-8-6-8-11V5z"/></svg>',
    file:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>',
    wallet:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7h18a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H3z"/><path d="M3 7V5a2 2 0 0 1 2-2h14"/><path d="M17 12h4"/></svg>',
    utensils:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 2v6a4 4 0 0 0 8 0V2"/><path d="M8 2v10"/><path d="M16 2v20"/><path d="M20 2v6a2 2 0 0 1-2 2h-2"/></svg>'
  };
  const iconMarkup = (name)=> ICONS[name] ? `<span class="ico-inline">${ICONS[name]}</span>` : '';
  function applyStaticIcons(){
    document.querySelectorAll('[data-icon]').forEach(el=>{
      if(el.dataset.iconApplied) return;
      const iconOnly = el.dataset.iconOnly === '1';
      const label = el.dataset.label || el.textContent.trim();
      el.dataset.label = label;
      if(iconOnly){
        el.innerHTML = iconMarkup(el.dataset.icon);
      } else {
        el.innerHTML = `${iconMarkup(el.dataset.icon)}<span>${esc(label)}</span>`;
      }
      el.dataset.iconApplied = '1';
    });
  }

  function seededInfoKey(str){
    const s = String(str||'');
    let h = 0;
    for(let i=0;i<s.length;i++){ h = (h*31 + s.charCodeAt(i)) % 10000; }
    return h;
  }
  function seededInfo(str){
    const h = seededInfoKey(str);
    const distanceKm = Number((0.5 + (h % 80) / 10).toFixed(1));
    const rating = Number((4 + (h % 9) / 10).toFixed(1));
    const ratingCount = 30 + (h % 400);
    const availableCount = 1 + (h % 6);
    return {distanceKm, rating, ratingCount, availableCount};
  }

  const DEFAULT_MEAL_WINDOW = '11:30 ‚Äì 14:00';

  function buildAddress(p){
    if(p && p.address && String(p.address).trim()) return String(p.address).trim();
    const rest = [p?.zip, p?.city].filter(Boolean).join(' ').trim();
    return [p?.street, rest].filter(Boolean).join(', ');
  }

  function parseAddress(addr){
    const raw = String(addr||'').trim();
    const out = { address: raw, street:'', zip:'', city:'' };
    if(!raw) return out;
    const parts = raw.split(',').map(s=>s.trim()).filter(Boolean);
    if(parts.length){ out.street = parts[0]; }
    if(parts.length > 1){
      const rest = parts.slice(1).join(', ');
      const m = rest.match(/^(\d{4,6})\s*(.*)$/);
      if(m){ out.zip = m[1]; out.city = m[2] || ''; }
      else { out.city = rest; }
    }
    return out;
  }

  function normalizeProviderProfile(p){
    const base = { name:'', address:'', street:'', zip:'', city:'', mealWindow:DEFAULT_MEAL_WINDOW, logoData:'' };
    const out = {...base, ...(p||{})};
    if(!out.address){ out.address = buildAddress(out); }
    if(!out.mealWindow){ out.mealWindow = DEFAULT_MEAL_WINDOW; }
    return out;
  }

  function normalizeOffer(o){
    const out = {...(o||{})};
    if(!out.dish && out.title) out.dish = out.title;
    if(!out.imageUrl && out.img) out.imageUrl = out.img;
    if(!out.pickupWindow && out.time) out.pickupWindow = out.time;
    if(!out.category && out.diet) out.category = out.diet;

    if(out.address && (!out.providerStreet && !out.providerZip && !out.providerCity)){
      const parsed = parseAddress(out.address);
      out.providerStreet = out.providerStreet || parsed.street || '';
      out.providerZip = out.providerZip || parsed.zip || '';
      out.providerCity = out.providerCity || parsed.city || '';
    }
    out.providerStreet = out.providerStreet || '';
    out.providerZip = out.providerZip || '';
    out.providerCity = out.providerCity || '';
    out.hasPickupCode = !!out.hasPickupCode;
    out.dineInPossible = !!out.dineInPossible;
    if(out.active === undefined) out.active = true;
    const info = seededInfo(out.dish || out.providerName || out.providerId);
    if(out.distanceKm == null) out.distanceKm = info.distanceKm;
    if(out.rating == null) out.rating = info.rating;
    if(out.ratingCount == null) out.ratingCount = info.ratingCount;
    if(out.availableCount == null) out.availableCount = info.availableCount;
    return out;
  }

  // --- Navigation ---
  const views = {
    start:'v-start',
    discover:'v-discover', fav:'v-fav', orders:'v-orders', cart:'v-cart', profile:'v-profile',
    providerLogin:'v-provider-login',
    providerHome:'v-provider-home', providerPickups:'v-provider-pickups', providerCookbook:'v-provider-cookbook',
    providerProfile:'v-provider-profile', providerBilling:'v-provider-billing', providerWeek:'v-provider-week'
  };

  function setCustomerNavActive(go){
    document.querySelectorAll('#customerNav .navbtn').forEach(b=>b.classList.toggle('active', b.dataset.go===go));
  }
  function setProviderNavActive(go){
    document.querySelectorAll('#providerNav .navbtn').forEach(b=>b.classList.toggle('active', b.dataset.pgo===go));
  }

  function showView(id){
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo({top:0,behavior:'smooth'});
  }

  function setMode(next){
    mode = next;
    save(LS.mode, mode);

    const isProv = mode==='provider';
    const isStart = mode==='start';
    const isCustomer = mode==='customer';
    document.getElementById('customerNav').style.display = (isCustomer || isStart) ? 'flex' : 'none';
    document.getElementById('providerNav').style.display = isProv ? 'flex' : 'none';
    document.getElementById('discoverFilters').style.display = isCustomer ? 'block' : 'none';
    document.getElementById('modePill').style.display = isProv ? 'inline-flex' : 'none';

    if(isStart){
      showStart();
      return;
    }

    if(isProv){
      // provider must be logged in
      if(!provider.loggedIn){
        showView(views.providerLogin);
      } else {
        showProviderHome();
      }
    } else {
      showDiscover();
    }
  }

  // --- Start ---
  function showStart(){
    // Navigation auf "Entdecken" setzen (auch wenn wir auf Startseite sind)
    const navBtn = document.querySelector('#customerNav button[data-go="discover"]');
    if(navBtn){
      document.querySelectorAll('#customerNav .navbtn').forEach(b=>b.classList.remove('active'));
      navBtn.classList.add('active');
    }
    showView(views.start);
    renderStart();
  }

  // --- Customer views ---
  function showDiscover(){
    setCustomerNavActive('discover');
    showView(views.discover);
    renderChips();
    renderDiscover();
  }
  function showFav(){
    setCustomerNavActive('fav');
    showView(views.fav);
    renderFavorites();
  }
  function showOrders(){
    setCustomerNavActive('orders');
    showView(views.orders);
    renderOrders();
  }
  function showCart(){
    setCustomerNavActive('cart');
    showView(views.cart);
    renderCart();
  }
  function showProfile(){
    setCustomerNavActive('profile');
    showView(views.profile);
    updateProfileView();
    lucide.createIcons();
  }

  // --- Provider views ---
  function showProviderHome(){
    setProviderNavActive('provider-home');
    showView(views.providerHome);
    renderProviderHome();
  }
  function showProviderPickups(){
    setProviderNavActive('provider-pickups');
    showView(views.providerPickups);
    renderProviderPickups();
  }
  function showProviderWeek(){
    setProviderNavActive('provider-home');
    showView(views.providerWeek);
    renderWeekPlan();
  }
  function showProviderCookbook(){
    setProviderNavActive('provider-cookbook');
    showView(views.providerCookbook);
    renderCookbook();
  }
  function showProviderProfile(){
    setProviderNavActive('provider-profile');
    showView(views.providerProfile);
    renderProviderProfile();
  }
  function showProviderBilling(){
    setProviderNavActive('provider-profile');
    showView(views.providerBilling);
    renderBilling();
  }

  // --- Chips render ---
  function renderChips(){
    const catEl = document.getElementById('catChips');
    const dayEl = document.getElementById('dayChips');
    if(!catEl || !dayEl){
      return;
    }
    catEl.innerHTML='';
    CATEGORIES.forEach(c=>{
      const b=document.createElement('button');
      b.className='chip'+(activeCat===c?' active':'');
      const iconName = c==='Vegetarisch' ? 'leaf' : (c==='Vegan' ? 'leaf' : 'flame');
      b.innerHTML = `${iconMarkup(iconName)}<span>${esc(c)}</span>`;
      b.onclick=()=>{
        activeCat = activeCat===c ? null : c;
        renderChips();
        renderDiscover();
      };
      catEl.appendChild(b);
    });

    dayEl.innerHTML='';
    for(let i=0;i<5;i++){
      const d=new Date(); d.setDate(d.getDate()+i);
      const key=isoDate(d);
      const b=document.createElement('button');
      b.className='day'+(activeDay===key?' active':'');
      b.textContent = fmtDay(d);
      b.onclick=()=>{ activeDay=key; renderChips(); renderDiscover(); };
      dayEl.appendChild(b);
    }
  }

  function renderStartChips(){
    const catEl = document.getElementById('startCatChips');
    const dayEl = document.getElementById('startDayChips');
    if(!catEl || !dayEl){
      return;
    }
    catEl.innerHTML='';
    CATEGORIES.forEach(c=>{
      const b=document.createElement('button');
      b.className='chip'+(activeCat===c?' active':'');
      const iconName = c==='Vegetarisch' ? 'leaf' : (c==='Vegan' ? 'leaf' : 'flame');
      b.innerHTML = `${iconMarkup(iconName)}<span>${esc(c)}</span>`;
      b.onclick=()=>{
        activeCat = activeCat===c ? null : c;
        renderStart();
        renderDiscover();
      };
      catEl.appendChild(b);
    });

    dayEl.innerHTML='';
    for(let i=0;i<5;i++){
      const d=new Date(); d.setDate(d.getDate()+i);
      const key=isoDate(d);
      const b=document.createElement('button');
      b.className='day'+(activeDay===key?' active':'');
      b.textContent = fmtDay(d);
      b.onclick=()=>{ activeDay=key; renderStart(); renderDiscover(); };
      dayEl.appendChild(b);
    }
  }

  function renderStart(){
    renderStartChips();
    renderStartDiscover();
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }

  function renderStartDiscover(){
    const grid = document.getElementById('startOfferGrid');
    const empty = document.getElementById('startEmptyOffers');
    const loc = document.getElementById('startLocationInput');
    
    if(!grid || !empty) return;

    // Standort-Suche
    if(loc){
      if(loc.value !== locationQuery) loc.value = locationQuery || '';
      loc.oninput=()=>{ locationQuery = loc.value; renderStart(); renderDiscover(); };
    }

    let list = offers.filter(o => o.day === activeDay && o.active !== false);

    if(activeCat){
      const cat = CAT_MAP[activeCat] || activeCat;
      list = list.filter(o => (o.category||'') === cat);
    }

    const q = String(locationQuery||'').trim().toLowerCase();
    if(q){
      list = list.filter(o=>{
        const data = normalizeOffer(o);
        const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity});
        return String(addr||'').toLowerCase().includes(q);
      });
    }

    // Normale Kacheln rendern
    grid.innerHTML='';
    empty.textContent = q ? 'Keine Angebote f√ºr diesen Standort.' : 'Noch keine Angebote. Demo: Als Anbieter ein Inserat erstellen.';
    empty.style.display = list.length ? 'none' : 'block';

    list.slice(0,6).forEach(o=> grid.appendChild(offerCard(o, {context:'start'})));
  }

  function createChatBubble(offer){
    const data = normalizeOffer(offer);
    const bubble = document.createElement('div');
    bubble.className='chat-bubble';
    bubble.onclick=()=>openOffer(data.id);
    
    const timeAgo = 'vor 2h'; // Placeholder
    const distance = data.distanceKm ? `${Number(data.distanceKm).toFixed(1)} km` : '';
    const emoji = data.category === 'Vegan' ? 'üå±' : (data.category === 'Vegetarisch' ? 'ü•ó' : 'üçñ');
    
    bubble.innerHTML=`
      <div class="chat-bubble-header">
        <div class="chat-bubble-avatar">
          <img src="${esc(data.imageUrl || 'https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=1200&q=60')}" alt="${esc(data.providerName || '')}" />
        </div>
        <div class="chat-bubble-meta">
          <div class="chat-bubble-name">${esc(data.providerName || 'Anbieter')}</div>
          <div class="chat-bubble-time">
            <i data-lucide="clock"></i>
            ${timeAgo}
          </div>
        </div>
        ${distance ? `<div class="chat-bubble-distance">${distance}</div>` : ''}
      </div>
      ${data.imageUrl ? `<img src="${esc(data.imageUrl)}" alt="${esc(data.dish || '')}" class="chat-bubble-image" />` : ''}
      <div class="chat-bubble-message">
        Hey! Heute gibt's ${emoji} <strong>${esc(data.dish || 'Gericht')}</strong> f√ºr <strong>${euro(data.price || 0)}</strong> ‚Äì wer ist dabei?
      </div>
      <div class="chat-bubble-actions">
        <button class="chat-bubble-btn chat-bubble-btn-primary" onclick="event.stopPropagation(); const o=offers.find(x=>x.id==='${data.id}'); if(o) openOffer('${data.id}');">Dabei sein</button>
      </div>
    `;
    
    return bubble;
  }

  // --- Discover render (App-like UX) ---
  let activeDiscoverFilter = 'near'; // 'near', 'Vegan', 'Vegetarisch', 'Mit Fleisch'
  
  function renderDiscover(){
    // Header: Standort
    const locationText = document.getElementById('discoverLocationText');
    if(locationText){
      const addr = locationQuery || 'Standort w√§hlen';
      locationText.textContent = addr;
    }
    
    // Kategorien rendern
    const categoriesEl = document.getElementById('discoverCategories');
    if(categoriesEl){
      categoriesEl.innerHTML = '';
      const cats = [
        {id:'near', label:'In der N√§he'},
        {id:'Vegan', label:'Vegan'},
        {id:'Vegetarisch', label:'Vegetarisch'},
        {id:'Mit Fleisch', label:'Mit Fleisch'}
      ];
      cats.forEach(cat=>{
        const btn = document.createElement('button');
        btn.className = 'discover-category-chip' + (activeDiscoverFilter === cat.id ? ' active' : '');
        btn.textContent = cat.label;
        btn.onclick = ()=>{
          activeDiscoverFilter = cat.id;
          renderDiscover();
        };
        categoriesEl.appendChild(btn);
      });
    }
    
    // Kalender rendern
    const calendarEl = document.getElementById('discoverCalendar');
    if(calendarEl){
      calendarEl.innerHTML = '';
      for(let i=0; i<5; i++){
        const d = new Date();
        d.setDate(d.getDate() + i);
        const key = isoDate(d);
        const dayName = ['So','Mo','Di','Mi','Do','Fr','Sa'][d.getDay()];
        const dayNum = String(d.getDate()).padStart(2,'0');
        
        const btn = document.createElement('button');
        btn.className = 'discover-day' + (activeDay === key ? ' active' : '');
        btn.textContent = i===0 ? 'Heute' : `${dayName} ${dayNum}`;
        btn.onclick = ()=>{
          activeDay = key;
          renderDiscover();
        };
        calendarEl.appendChild(btn);
      }
    }
    
    // Angebote filtern
    let list = offers.filter(o => o.day === activeDay && o.active !== false);
    
    // Kategorie-Filter
    if(activeDiscoverFilter !== 'near'){
      const cat = CAT_MAP[activeDiscoverFilter] || activeDiscoverFilter;
      list = list.filter(o => (o.category||'') === cat);
    }
    
    // Standort-Filter
    const q = String(locationQuery||'').trim().toLowerCase();
    if(q){
      list = list.filter(o=>{
        const data = normalizeOffer(o);
        const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity});
        return String(addr||'').toLowerCase().includes(q);
      });
    }
    
    // Hero Cards rendern
    const offersEl = document.getElementById('discoverOffers');
    const emptyEl = document.getElementById('discoverEmpty');
    if(offersEl && emptyEl){
      offersEl.innerHTML = '';
      emptyEl.textContent = q ? 'Keine Angebote f√ºr diesen Standort.' : 'Noch keine Angebote. Demo: Als Anbieter ein Inserat erstellen.';
      emptyEl.style.display = list.length ? 'none' : 'block';
      
      list.forEach(o=> offersEl.appendChild(createDiscoverHeroCard(o)));
    }
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }
  
  // Hero Card f√ºr Discover-Seite
  function createDiscoverHeroCard(o){
    const data = normalizeOffer(o);
    const card = document.createElement('div');
    card.className = 'discover-hero-card';
    card.onclick = ()=> openOffer(data.id);
    
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    
    card.innerHTML = `
      <div class="discover-hero-image">
        <img src="${esc(imgSrc)}" alt="${esc(data.dish||'')}" />
      </div>
      <div class="discover-hero-content">
        <div class="discover-hero-title">${esc(data.dish||'Gericht')}</div>
        <div class="discover-hero-price">${euro(data.price)}</div>
        <div class="discover-hero-badges">
          ${data.hasPickupCode ? '<div class="discover-hero-badge code"><i data-lucide="shopping-bag"></i> Abholcode</div>' : ''}
          ${data.dineInPossible ? '<div class="discover-hero-badge dine"><i data-lucide="utensils"></i> Vor Ort</div>' : ''}
          ${!data.dineInPossible && !data.hasPickupCode ? '<div class="discover-hero-badge"><i data-lucide="package"></i> Zum Mitnehmen</div>' : ''}
        </div>
        <div class="discover-hero-actions">
          <button class="discover-hero-btn primary" onclick="event.stopPropagation(); const o=offers.find(x=>x.id==='${data.id}'); if(o) handleOrderClick(o);">
            ${data.hasPickupCode ? 'Bestellen' : 'Details'}
          </button>
          <button class="discover-hero-btn secondary" onclick="event.stopPropagation(); openOffer('${data.id}');">
            Details
          </button>
        </div>
      </div>
    `;
    
    return card;
  }

  function offerCard(o, opts={}){
    const data = normalizeOffer(o);
    const interactive = opts.interactive !== false;
    const card=document.createElement('div');
    card.className='card';
    if(opts.context === 'start' || opts.context === 'customer'){
      card.classList.add('playful');
    }
    if(interactive){
      card.onclick=()=>openOffer(data.id);
    } else {
      card.style.cursor='default';
    }

    const img=document.createElement('div');
    img.className='img';
    const imgSrc = data.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    img.innerHTML = `
      <img alt="${esc(data.dish||'')}" src="${esc(imgSrc)}" />
      ${data.dineInPossible?'<div class="badge dine">Vor Ort</div>':''}
      ${data.hasPickupCode?'<div class="badge code">Online bezahlen</div>':''}
    `;

    const providerKey = data.providerId || data.id;
    const dishKey = data.id;
    const heart=document.createElement('button');
    heart.className='heart'+(dishFavs.has(dishKey)?' on':'');
    heart.type='button';
    heart.textContent = dishFavs.has(dishKey)?'‚ù§':'‚ô°';
    heart.onclick=(e)=>{ e.stopPropagation(); toggleDishFav(dishKey); };

    const plogo = data.providerLogoData ? `<img src="${data.providerLogoData}" alt="Logo" />` : `<img src="assets/provider-placeholder.png" alt="Logo" />`;

    const providerRow=document.createElement('div');
    providerRow.className='provider-logo';
    providerRow.innerHTML = `
      <div class="plogo">${plogo}</div>
      <div class="pname">${esc(data.providerName||'Anbieter')}</div>
    `;

    const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity});
    const body=document.createElement('div');
    body.className='body';
    body.innerHTML = `
      <p class="title">${esc(data.dish||'')}</p>
      <p class="sub">${esc(addr || '')}</p>
      <div class="meta">
        <div class="price">${euro(data.price)}</div>
        <div class="right">
          <div class="meta-line">${iconMarkup('clock')}<span>${esc(data.pickupWindow||'')}</span></div>
          <div class="tag">${esc(data.category||'')}</div>
        </div>
      </div>
    `;

    const info=document.createElement('div');
    info.className='info-row';
    const addInfo = (icon, text)=>{
      const item=document.createElement('div');
      item.className='info-item';
      item.innerHTML = `${iconMarkup(icon)}<span>${esc(text)}</span>`;
      info.appendChild(item);
    };
    if(data.availableCount != null) addInfo('box', `${data.availableCount} verf√ºgbar`);
    if(data.distanceKm != null) addInfo('location', `${Number(data.distanceKm).toFixed(1)} km`);
    body.appendChild(info);

    if(interactive){
      const actions=document.createElement('div');
      actions.className='card-actions';

      const orderBtn=document.createElement('button');
      orderBtn.type='button';
      orderBtn.className='card-action primary';
      const orderLabel = data.hasPickupCode ? 'Bestellen' : 'Nur ansehen';
      orderBtn.innerHTML = `${iconMarkup(data.hasPickupCode ? 'cart' : 'eye')}<span>${esc(orderLabel)}</span>`;
      orderBtn.disabled = !data.hasPickupCode;
      orderBtn.onclick=(e)=>{ e.stopPropagation(); handleOrderClick(data); };

      const favBtn=document.createElement('button');
      favBtn.type='button';
      favBtn.className='card-action';
      const favLabel = providerFavs.has(providerKey) ? 'Anbieter gespeichert' : 'Anbieter speichern';
      favBtn.innerHTML = `${iconMarkup('heart')}<span>${esc(favLabel)}</span>`;
      favBtn.onclick=(e)=>{ e.stopPropagation(); toggleProviderFav(providerKey); };

      const shareBtn=document.createElement('button');
      shareBtn.type='button';
      shareBtn.className='card-action ghost';
      shareBtn.innerHTML = `${iconMarkup('share')}<span>Teilen</span>`;
      shareBtn.onclick=(e)=>{ e.stopPropagation(); shareOffer(data); };

      actions.appendChild(orderBtn);
      actions.appendChild(favBtn);
      actions.appendChild(shareBtn);
      body.appendChild(actions);
    }

    card.appendChild(img);
    if(interactive){ card.appendChild(heart); }
    card.appendChild(providerRow);
    card.appendChild(body);
    return card;
  }

  function providerCard(o, opts={}){
    const data = normalizeOffer(o);
    const interactive = opts.interactive !== false;
    const showActions = opts.showActions === true;
    const isToday = data.day === (opts.todayKey || isoDate(new Date()));
    const statusLine = data.hasPickupCode ? (isToday ? 'Online-Abholcode ¬∑ Heute' : 'Online-Abholcode') : '';
    const card=document.createElement('div');
    card.className='card';
    card.style.cursor = interactive ? 'pointer' : 'default';
    if(interactive){
      card.onclick=()=>openProviderOffer(data.id);
    }

    const profile = normalizeProviderProfile(provider.profile || {});
    const imgSrc = data.imageUrl || data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    const windowText = data.pickupWindow || profile.mealWindow || '';

    const img=document.createElement('div');
    img.className='img';
    img.innerHTML = `
      <img alt="${esc(data.dish||'Gericht')}" src="${esc(imgSrc)}" />
      ${data.active===false?'<div class="badge inactive">Inaktiv</div>':''}
      ${data.hasPickupCode?'<div class="badge code">Abholcode</div>':''}
      ${data.dineInPossible?'<div class="badge dine">Vor Ort</div>':''}
    `;

    const body=document.createElement('div');
    body.className='body';
    body.innerHTML = `
      <p class="title">${esc(data.dish||'Gericht')}</p>
      <p class="sub">Essenszeit: ${esc(windowText || '‚Äî')}</p>
      ${statusLine ? `<div class="tag">${esc(statusLine)}</div>` : ''}
      <div class="meta">
        <div class="price">${euro(data.price)}</div>
        <div class="right">
          <div>${esc(data.category||'')}</div>
        </div>
      </div>
    `;

    const info=document.createElement('div');
    info.className='info-row';
    const addInfo = (icon, text)=>{
      const item=document.createElement('div');
      item.className='info-item';
      item.innerHTML = `${iconMarkup(icon)}<span>${esc(text)}</span>`;
      info.appendChild(item);
    };
    if(data.hasPickupCode) addInfo('card', 'Online-Abholcode');
    if(data.dineInPossible) addInfo('utensils', 'Vor Ort');
    if(info.childElementCount){ body.appendChild(info); }

    if(showActions){
      const actions=document.createElement('div');
      actions.className='card-actions';

      const actBtn=document.createElement('button');
      actBtn.type='button';
      actBtn.className='card-action';
      actBtn.innerHTML = `${iconMarkup('action')}<span>Aktionen</span>`;
      actBtn.onclick=(e)=>{ e.stopPropagation(); openProviderOffer(data.id); };

      const shareBtn=document.createElement('button');
      shareBtn.type='button';
      shareBtn.className='card-action';
      shareBtn.innerHTML = `${iconMarkup('share')}<span>Teilen</span>`;
      shareBtn.onclick=(e)=>{ e.stopPropagation(); shareOffer(data); };

      const printBtn=document.createElement('button');
      printBtn.type='button';
      printBtn.className='card-action';
      printBtn.innerHTML = `${iconMarkup('print')}<span>Drucken</span>`;
      printBtn.onclick=(e)=>{ e.stopPropagation(); printOffer(data); };

      actions.appendChild(actBtn);
      actions.appendChild(shareBtn);
      actions.appendChild(printBtn);
      body.appendChild(actions);
    }

    card.appendChild(img);
    card.appendChild(body);
    return card;
  }

  function toggleProviderFav(providerId){
    if(!providerId) return;
    if(providerFavs.has(providerId)) providerFavs.delete(providerId); else providerFavs.add(providerId);
    const arr = Array.from(providerFavs);
    save(LS.providerFavs, arr);
    // keep legacy key for compatibility
    save(LS.favs, arr);
    renderDiscover();
    renderStart();
    renderFavorites();
    updateSheetFavs();
  }

  function toggleDishFav(offerId){
    if(!offerId) return;
    if(dishFavs.has(offerId)) dishFavs.delete(offerId); else dishFavs.add(offerId);
    save(LS.dishFavs, Array.from(dishFavs));
    renderDiscover();
    renderStart();
    renderFavorites();
    updateSheetFavs();
  }

  function renderFavorites(){
    const provGrid=document.getElementById('favProviders');
    const provEmpty=document.getElementById('emptyFavProviders');
    const dishGrid=document.getElementById('favDishes');
    const dishEmpty=document.getElementById('emptyFavDishes');
    if(!provGrid || !dishGrid || !provEmpty || !dishEmpty) return;

    const candidates = offers
      .filter(o => o.active !== false && providerFavs.has(o.providerId))
      .sort((a,b)=>String(b.day||'').localeCompare(String(a.day||'')));
    const bestByProvider = new Map();
    candidates.forEach(o=>{
      if(!bestByProvider.has(o.providerId)) bestByProvider.set(o.providerId, o);
    });
    const providerList = Array.from(bestByProvider.values());

    provGrid.innerHTML='';
    provEmpty.style.display = providerList.length ? 'none' : 'block';
    providerList.forEach(o=>provGrid.appendChild(offerCard(o)));

    const dishList = offers
      .filter(o => o.active !== false && dishFavs.has(o.id))
      .sort((a,b)=>String(b.day||'').localeCompare(String(a.day||'')));
    dishGrid.innerHTML='';
    dishEmpty.style.display = dishList.length ? 'none' : 'block';
    dishList.forEach(o=>dishGrid.appendChild(offerCard(o)));
  }

  function genPickupCode(){
    const letters = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
    const letter = letters[Math.floor(Math.random()*letters.length)];
    const num = Math.floor(Math.random()*9) + 1;
    return `${letter}${num}`;
  }

  function renderOrders(){
    const box = document.getElementById('ordersList');
    const filters = document.getElementById('ordersFilters');
    if(!box) return;
    if(filters){
      filters.innerHTML='';
      [
        {id:'offen', label:'Offen'},
        {id:'abgeholt', label:'Abgeholt'},
        {id:'alle', label:'Alle'}
      ].forEach(f=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(ordersFilter===f.id?' on':'');
        b.textContent=f.label;
        b.onclick=()=>{ ordersFilter=f.id; renderOrders(); };
        filters.appendChild(b);
      });
    }
    if(!orders.length){
      box.textContent = 'Noch keine Bestellungen.';
      return;
    }
    const fmt = (ts)=>{
      const d = new Date(ts);
      if(Number.isNaN(d.getTime())) return '';
      return fmtDay(d);
    };
    const list = orders.filter(o=>{
      if(ordersFilter==='alle') return true;
      return (o.status || 'offen') === ordersFilter;
    });
    list.sort((a,b)=>{
      if(ordersFilter === 'alle'){
        const sa = a.status || 'offen';
        const sb = b.status || 'offen';
        if(sa !== sb) return sa === 'offen' ? -1 : 1;
      }
      return (b.createdAt||0) - (a.createdAt||0);
    });
    if(!list.length){
      box.textContent = 'Keine passenden Bestellungen.';
      return;
    }
    box.innerHTML = list.map(o=>`
      <div class="order-item ${o.status==='abgeholt' ? 'done' : ''}">
        <div class="order-top">
          <div>
            <div style="font-weight:900">${esc(o.providerName || 'Anbieter')}</div>
            <div class="hint">${esc(o.summary || '')}</div>
          </div>
          <div class="order-right">
            <button class="order-code" type="button" data-id="${esc(o.id||'')}" data-code="${esc(o.code||'')}">${esc(o.code||'')}</button>
            <div class="status-pill ${o.status==='abgeholt' ? 'done' : 'open'}">${esc(o.status||'offen')}</div>
          </div>
        </div>
        <div class="hint" style="margin-top:6px;">
          Status: ${esc(o.status||'offen')}${o.pickupTime ? ` - Abholzeit: ${esc(o.pickupTime)}` : ''} - ${fmt(o.createdAt)}
        </div>
      </div>
    `).join('');

    box.querySelectorAll('.order-code').forEach(btn=>{
      btn.onclick=()=> openCodeSheet(btn.getAttribute('data-id') || '');
    });
  }

  function openCodeSheet(orderId){
    const order = orders.find(o=>o.id===orderId);
    if(!order) return;
    activeOrderId = orderId;
    document.getElementById('codeText').textContent = order.code || '';
    document.getElementById('codeStatus').textContent = order.status === 'abgeholt' ? 'Status: abgeholt' : 'Status: offen';
    document.getElementById('btnToggleOrderStatus').textContent = order.status === 'abgeholt' ? 'Als offen markieren' : 'Als abgeholt markieren';
    document.getElementById('codeProvider').textContent = order.providerName || 'Anbieter';
    document.getElementById('codeSummary').textContent = order.summary || '';
    document.getElementById('codePickupWindow').textContent = order.pickupWindow ? `Essenszeit: ${order.pickupWindow}` : 'Essenszeit: ‚Äì';
    document.getElementById('codePickupTime').textContent = order.pickupTime ? order.pickupTime : 'offen';
    
    // Logo rendern (falls vorhanden)
    const logoEl = document.getElementById('codeProviderLogo');
    if(logoEl){
      const providerOffer = offers.find(o=>o.providerName === order.providerName);
      if(providerOffer && providerOffer.providerLogo){
        logoEl.innerHTML = `<img src="${providerOffer.providerLogo}" alt="Logo" />`;
      } else {
        logoEl.innerHTML = `<img src="assets/provider-placeholder.png" alt="Logo" />`;
      }
    }
    
    document.getElementById('codeBd').classList.add('active');
    document.getElementById('codeSheet').classList.add('active');
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }
  function closeCodeSheet(){
    document.getElementById('codeBd').classList.remove('active');
    document.getElementById('codeSheet').classList.remove('active');
    activeOrderId = null;
  }

  // --- Offer sheet ---
  let activeOfferId=null;
  let activeProviderOfferId=null;
  // Navigation History f√ºr Back-Button
  let navigationHistory = [];
  
  function openOffer(id){
    const raw = offers.find(x=>x.id===id);
    if(!raw) return;
    const o = normalizeOffer(raw);
    activeOfferId=id;
    
    // History speichern
    navigationHistory.push({
      view: mode === 'start' ? 'start' : 'discover',
      locationQuery: locationQuery,
      activeCat: activeCat,
      activeDay: activeDay,
      activeFilter: activeDiscoverFilter
    });

    document.getElementById('sImg').src = o.imageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70';
    document.getElementById('sDish').textContent = o.dish || '';
    document.getElementById('sProvider').textContent = o.providerName || '';
    document.getElementById('sPrice').textContent = euro(o.price);
    document.getElementById('sCat').textContent = o.category || '';
    document.getElementById('sWindow').textContent = o.pickupWindow || '';

    const addr = buildAddress({address:o.address, street:o.providerStreet, zip:o.providerZip, city:o.providerCity});
    const maps = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
    const a = document.getElementById('sAddr');
    a.textContent = addr || '-';
    a.href = maps;

    const distRow = document.getElementById('sDistance');
    if(distRow){
      distRow.textContent = o.distanceKm != null ? `${Number(o.distanceKm).toFixed(1)} km` : '-';
    }
    const availRow = document.getElementById('sAvail');
    if(availRow){
      availRow.textContent = o.availableCount != null ? `${o.availableCount}` : '-';
    }

    // Allergens
    const aw = document.getElementById('sAllergensWrap');
    if(o.allergens && o.allergens.length){
      aw.style.display='block';
      document.getElementById('sAllergens').textContent = o.allergens.join(', ');
    } else aw.style.display='none';

    // Extras
    const ew = document.getElementById('sExtrasWrap');
    if(o.extras && o.extras.length){
      ew.style.display='block';
      document.getElementById('sExtras').textContent = o.extras.map(e=>`${e.name} (+${euro(e.price)})`).join(' ¬∑ ');
    } else ew.style.display='none';

    // Reuse
    const rw = document.getElementById('sReuseWrap');
    if(o.reuse && o.reuse.enabled){
      rw.style.display='block';
      document.getElementById('sReuse').textContent = `Pfand ${euro(o.reuse.deposit)}`;
    } else rw.style.display='none';

    const addBtn = document.getElementById('btnAddCart');
    if(o.hasPickupCode){
      addBtn.disabled = false;
      addBtn.innerHTML = `${iconMarkup('cart')}<span>In den Warenkorb</span>`;
    } else {
      addBtn.disabled = true;
      addBtn.innerHTML = `${iconMarkup('eye')}<span>Nur ansehen</span>`;
    }

    document.getElementById('sCodeNote').innerHTML = o.hasPickupCode
      ? 'Online bezahlen aktiv.'
      : 'Ohne Online-Bezahlung nur ansehen.';

    updateSheetFavs();

    document.getElementById('bd').classList.add('active');
    document.getElementById('sheet').classList.add('active');
    
    // Icons aktualisieren
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  }

  function updateSheetFavs(){
    const providerBtn = document.getElementById('btnFav');
    const dishBtn = document.getElementById('btnDishFav');
    if(!activeOfferId){
      if(providerBtn) providerBtn.textContent='Anbieter speichern';
      if(dishBtn) dishBtn.textContent='Gericht speichern';
      return;
    }
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    const providerKey = o.providerId;
    const dishKey = o.id;
    if(providerBtn){
      const label = providerKey && providerFavs.has(providerKey) ? 'Anbieter entfernen' : 'Anbieter speichern';
      providerBtn.innerHTML = `${iconMarkup('heart')}<span>${esc(label)}</span>`;
    }
    if(dishBtn){
      const label = dishKey && dishFavs.has(dishKey) ? 'Gericht entfernen' : 'Gericht speichern';
      dishBtn.innerHTML = `${iconMarkup('heart')}<span>${esc(label)}</span>`;
    }
  }

  function closeSheet(){
    document.getElementById('bd').classList.remove('active');
    document.getElementById('sheet').classList.remove('active');
    
    // Zur√ºck zur vorherigen Ansicht
    if(navigationHistory.length > 0){
      const prev = navigationHistory.pop();
      locationQuery = prev.locationQuery || '';
      activeCat = prev.activeCat || null;
      activeDay = prev.activeDay || isoDate(new Date());
      activeDiscoverFilter = prev.activeFilter || 'near';
      
      if(prev.view === 'start'){
        showStart();
      } else {
        showDiscover();
      }
    }
  }
  
  // Android Hardware-Back unterst√ºtzen
  window.addEventListener('popstate', function(e){
    if(document.getElementById('sheet').classList.contains('active')){
      closeSheet();
      e.preventDefault();
      history.pushState(null, '', location.pathname);
    }
  });

  function openProviderOffer(id){
    const raw = offers.find(x=>x.id===id);
    if(!raw) return;
    const o = normalizeOffer(raw);
    activeProviderOfferId = id;

    const preview = document.getElementById('pPreview');
    preview.innerHTML = '';
    preview.appendChild(offerCard(o, {interactive:false}));

    document.getElementById('pStatus').textContent = o.active===false ? 'Inaktiv' : 'Aktiv';
    document.getElementById('pWindow').textContent = o.pickupWindow || '-';
    const toggleLabel = o.active===false ? 'Aktivieren' : 'Deaktivieren';
    const toggleBtn = document.getElementById('btnToggleOffer');
    if(toggleBtn){
      toggleBtn.innerHTML = `${iconMarkup('action')}<span>${esc(toggleLabel)}</span>`;
    }

    document.getElementById('pbd').classList.add('active');
    document.getElementById('psheet').classList.add('active');
  }

  function closeProviderSheet(){
    document.getElementById('pbd').classList.remove('active');
    document.getElementById('psheet').classList.remove('active');
  }

  function buildShareText(o){
    const dish = o.dish || o.title || 'Gericht';
    const profile = normalizeProviderProfile(provider.profile || {});
    const providerName = o.providerName || profile.name || 'Anbieter';
    const pickup = o.pickupWindow || profile.mealWindow || '‚Äî';
    return `${providerName}\nHeute zu Mittag: ${dish}\nüí∞ ${euro(o.price)}\n‚è∞ ${pickup}\nPowered by Mittagio`;
  }

  function setPrintView(html){
    const pv = document.getElementById('printView');
    if(!pv) return;
    pv.innerHTML = html;
  }
  function clearPrintView(){
    const pv = document.getElementById('printView');
    if(!pv) return;
    pv.innerHTML = '';
  }
  window.addEventListener('afterprint', clearPrintView);

  function printHtml(html){
    setPrintView(html);
    window.print();
    setTimeout(clearPrintView, 300);
  }

  function buildOfferPrintHtml(o){
    const data = normalizeOffer(o);
    const profile = normalizeProviderProfile(provider.profile || {});
    const name = data.providerName || profile.name || 'Anbieter';
    const addr = buildAddress({address:data.address, street:data.providerStreet, zip:data.providerZip, city:data.providerCity}) || buildAddress(profile);
    const badges = [];
    if(data.hasPickupCode) badges.push('Abholcode');
    if(data.dineInPossible) badges.push('Vor Ort');
    return `
      <div class="print-card">
        <div style="display:flex;align-items:center;gap:12px;">
          ${profile.logoData ? `<img src="${profile.logoData}" alt="Logo" style="width:56px;height:56px;border-radius:12px;object-fit:cover" />` : ''}
          <div>
            <h1>${esc(name)}</h1>
            <div class="print-muted">${esc(addr || '')}</div>
          </div>
        </div>
        <h2>${esc(data.dish || 'Gericht')}</h2>
        <div class="print-row">
          <div><b>Preis:</b> ${euro(data.price || 0)}</div>
          <div><b>Essenszeit:</b> ${esc(data.pickupWindow || profile.mealWindow || '')}</div>
        </div>
        <div style="margin-top:8px;">
          ${badges.map(b=>`<span class="print-badge">${esc(b)}</span>`).join(' ')}
        </div>
      </div>
    `;
  }

  function buildWeekCardHtml(){
    const profile = normalizeProviderProfile(provider.profile || {});
    const days = [];
    for(let i=0;i<5;i++){
      const d = new Date(); d.setDate(d.getDate()+i);
      days.push(isoDate(d));
    }
    const dayBlocks = days.map(key=>{
      const items = (week[key]||[])
        .filter(x=>x.providerId===providerId() && x.active !== false)
        .map(entry=>{
          const cb = cookbook.find(c=>c.id===entry.cookbookId);
          const name = cb?.dish || entry.dish || 'Gericht';
          const price = cb?.price || 0;
          const windowText = cb?.pickupWindow || profile.mealWindow || '';
          return `
            <div class="print-row">
              <div>
                <div>${esc(name)}</div>
                <div class="print-muted">${esc(windowText)}</div>
              </div>
              <div>${euro(price)}</div>
            </div>
          `;
        });
      const label = key ? fmtDay(new Date(key)) : key;
      return `
        <div class="print-card">
          <h2>${esc(label)}</h2>
          ${items.length ? items.join('') : '<div class="print-muted">Keine Gerichte geplant.</div>'}
        </div>
      `;
    }).join('');

    return `
      <div class="print-card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <div>
            <h1>${esc(profile.name || 'Anbieter')}</h1>
            <div class="print-muted">${esc(buildAddress(profile) || '')}</div>
            <div class="print-muted">Essenszeit: ${esc(profile.mealWindow || '')}</div>
            <div class="print-muted" style="margin-top:6px;"><b>Unsere Gerichte ‚Äì n√§chste Tage</b></div>
          </div>
          ${profile.logoData ? `<img src="${profile.logoData}" alt="Logo" style="width:72px;height:72px;border-radius:14px;object-fit:cover" />` : ''}
        </div>
      </div>
      <div class="print-grid">
        ${dayBlocks}
      </div>
      <div class="print-card" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div>
          <div style="font-weight:900">Mittagio</div>
          <div class="print-muted">Dein Mittag! lokal ¬∑ frisch ¬∑ digital</div>
        </div>
        <div style="text-align:center;">
          <div class="qr">QR-Code</div>
          <div class="print-muted">Jetzt scannen</div>
        </div>
      </div>
    `;
  }

  function printOffer(o){
    if(!o) return;
    printHtml(buildOfferPrintHtml(o));
  }

  function printCookbookEntry(entry){
    if(!entry) return;
    const profile = normalizeProviderProfile(provider.profile || {});
    const offer = normalizeOffer({
      dish: entry.dish,
      category: entry.category,
      price: entry.price,
      pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
      providerName: profile.name || provider.email || 'Anbieter',
      providerStreet: profile.street||'',
      providerZip: profile.zip||'',
      providerCity: profile.city||'',
      providerLogoData: profile.logoData||'',
      hasPickupCode: !!entry.hasPickupCode,
      dineInPossible: !!entry.dineInPossible,
      allergens: entry.allergens||[],
      extras: entry.extras||[],
      reuse: entry.reuse||{enabled:false,deposit:0}
    });
    printHtml(buildOfferPrintHtml(offer));
  }

  function printWeekCard(){
    printHtml(buildWeekCardHtml());
  }

  function openShareSheet(text, url=location.href){
    sharePayload = { text, url };
    const preview = document.getElementById('sharePreview');
    if(preview) preview.textContent = text;
    document.getElementById('shareBd').classList.add('active');
    document.getElementById('shareSheet').classList.add('active');
  }

  function closeShareSheet(){
    document.getElementById('shareBd').classList.remove('active');
    document.getElementById('shareSheet').classList.remove('active');
  }

  async function copyShareText(){
    const txt = `${sharePayload.text}\n${sharePayload.url}`.trim();
    if(navigator.clipboard && navigator.clipboard.writeText){
      try{ await navigator.clipboard.writeText(txt); return true; }catch{}
    }
    prompt('Kopieren und teilen:', txt);
    return false;
  }

  function shareOffer(o){
    if(!o) return;
    const txt = buildShareText(o);
    openShareSheet(txt);
  }

  function addToCart(o){
    if(!o || !o.hasPickupCode){
      alert('Ohne Abholcode nur ansehen.');
      return false;
    }
    if(cart && cart.providerId !== o.providerId){
      alert('MVP: Warenkorb nur f√ºr einen Anbieter. Bitte zuerst Warenkorb leeren.');
      return false;
    }
    if(!cart){ cart = { providerId:o.providerId, providerName:o.providerName, items:[], pickupTime:'' }; }
    const idx = cart.items.findIndex(i=>i.offerId===o.id);
    if(idx>=0) cart.items[idx].qty += 1; else cart.items.push({offerId:o.id, qty:1});
    save(LS.cart, cart);
    return true;
  }

  function handleOrderClick(o){
    if(addToCart(o)){
      showCart();
    } else {
      openOffer(o.id);
    }
  }

  document.getElementById('btnFav').onclick=()=>{
    if(!activeOfferId) return;
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    toggleProviderFav(o.providerId);
  };
  document.getElementById('btnDishFav').onclick=()=>{
    if(!activeOfferId) return;
    toggleDishFav(activeOfferId);
  };
  document.getElementById('btnShare').onclick=()=>{
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    shareOffer(o);
  };
  document.getElementById('btnCodeClose').onclick=()=> closeCodeSheet();
  document.getElementById('btnToggleOrderStatus').onclick=()=>{
    if(!activeOrderId) return;
    const idx = orders.findIndex(o=>o.id===activeOrderId);
    if(idx<0) return;
    orders[idx].status = orders[idx].status === 'abgeholt' ? 'offen' : 'abgeholt';
    save(LS.orders, orders);
    renderOrders();
    openCodeSheet(activeOrderId);
  };
  document.getElementById('btnShareClose').onclick=()=> closeShareSheet();
  document.getElementById('btnShareWhatsApp').onclick=()=>{
    const txt = `${sharePayload.text}\n${sharePayload.url}`.trim();
    window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`,'_blank');
  };
  document.getElementById('btnShareInstagram').onclick=async()=>{
    await copyShareText();
    window.open('https://www.instagram.com/','_blank');
  };
  document.getElementById('btnShareWebsite').onclick=async()=>{
    await copyShareText();
    window.open(sharePayload.url || location.href,'_blank');
  };
  document.getElementById('btnShareCopy').onclick=async()=>{
    const ok = await copyShareText();
    if(ok) alert('Link kopiert.');
  };

  applyStaticIcons();
  const locBtn = document.getElementById('btnLocationPin');
  if(locBtn){
    locBtn.innerHTML = iconMarkup('location');
    locBtn.onclick=()=>{
      alert('Standort gesetzt. Du kannst jederzeit wechseln.');
    };
  }
  const startLocBtn = document.getElementById('btnStartLocationPin');
  if(startLocBtn){
    startLocBtn.innerHTML = iconMarkup('location');
    startLocBtn.onclick=()=>{
      alert('Standort gesetzt. Du kannst jederzeit wechseln.');
    };
  }
  const startNearBtn = document.getElementById('btnStartNear');
  if(startNearBtn){
    startNearBtn.onclick=()=>{
      alert('Zeige Angebote in deiner N√§he.');
      renderStart();
    };
  }
  
  // Discover Standort-Button
  const discoverLocationBtn = document.getElementById('btnDiscoverLocation');
  if(discoverLocationBtn){
    discoverLocationBtn.onclick=()=>{
      const newLoc = prompt('Standort eingeben (Ort oder PLZ):', locationQuery || '');
      if(newLoc !== null){
        locationQuery = newLoc.trim();
        renderDiscover();
      }
    };
  }

  document.getElementById('btnAddCart').onclick=()=>{
    const o = offers.find(x=>x.id===activeOfferId);
    if(!o) return;
    if(!addToCart(o)) return;
    closeSheet();
    showCart();
  };

  // --- Cart ---
  function renderCart(){
    const box=document.getElementById('cartBox');
    const btn=document.getElementById('btnCheckout');
    const note=document.getElementById('cartNote');

    if(!cart || !cart.items.length){
      box.textContent='Dein Warenkorb ist leer.';
      btn.style.display='none';
      note.style.display='none';
      return;
    }

    let total=0;
    let canCheckout = true;
    const firstOffer = cart.items.length ? offers.find(x=>x.id===cart.items[0].offerId) : null;
    const firstOfferNormalized = firstOffer ? normalizeOffer(firstOffer) : null;
    const windowText = firstOfferNormalized && firstOfferNormalized.pickupWindow ? firstOfferNormalized.pickupWindow : '';
    const lines = cart.items.map(it=>{
      const o = offers.find(x=>x.id===it.offerId);
      if(!o) return '';
      const normalized = normalizeOffer(o);
      if(!normalized.hasPickupCode) canCheckout = false;
      const lineTotal = Number(normalized.price||0) * it.qty;
      total += lineTotal;
      return `
        <div class="cart-line">
          <div class="cart-left">${esc(normalized.dish || normalized.title || 'Gericht')}</div>
          <div class="cart-qty">
            <button class="qty-btn" type="button" data-action="dec" data-id="${esc(o.id)}">-</button>
            <div>${it.qty}</div>
            <button class="qty-btn" type="button" data-action="inc" data-id="${esc(o.id)}">+</button>
          </div>
          <div class="cart-price">${euro(lineTotal)}</div>
        </div>
      `;
    }).filter(Boolean);

    box.innerHTML = `
      <b>${esc(cart.providerName || 'Anbieter')}</b>
      ${lines.join('')}
      ${windowText ? `<div class="hint">Essenszeit: ${esc(windowText)}</div>` : ''}
      <div class="row"><span>Wann m√∂chtest du ungef√§hr da sein?</span></div>
      <input class="field" id="pickupTimeInput" type="text" placeholder="z.B. 12:15" value="${esc(cart.pickupTime||'')}" />
      <div class="hint">Bitte innerhalb der Essenszeit.</div>
      <div class="row"><span>Gesamt</span><b>${euro(total)}</b></div>
      <a href="#" id="clearCart">Warenkorb leeren</a>
    `;

    document.getElementById('clearCart').onclick=(e)=>{ e.preventDefault(); cart=null; save(LS.cart, cart); renderCart(); };
    const timeInput = document.getElementById('pickupTimeInput');
    if(timeInput){
      timeInput.oninput=()=>{
        cart.pickupTime = timeInput.value;
        save(LS.cart, cart);
      };
    }

    box.querySelectorAll('.qty-btn').forEach(btnEl=>{
      btnEl.onclick=()=>{
        const id = btnEl.getAttribute('data-id');
        const action = btnEl.getAttribute('data-action');
        const idx = cart.items.findIndex(i=>i.offerId===id);
        if(idx<0) return;
        if(action==='inc') cart.items[idx].qty += 1;
        if(action==='dec') cart.items[idx].qty -= 1;
        if(cart.items[idx].qty <= 0) cart.items.splice(idx,1);
        save(LS.cart, cart);
        renderCart();
      };
    });

    btn.style.display='block';
    btn.disabled = !canCheckout;
    btn.innerHTML = canCheckout
      ? `${iconMarkup('card')}<span>Weiter zur Zahlung</span>`
      : `${iconMarkup('eye')}<span>Nur ansehen</span>`;
    note.style.display='block';
  }

  document.getElementById('btnCheckout').onclick=()=>{
    if(!customer.loggedIn){
      alert('F√ºr die Demo: Bitte zuerst als Kunde anmelden (Profil).');
      showProfile();
      return;
    }
    if(!cart || !cart.items || !cart.items.length) return;
    const pickupTime = String(cart.pickupTime||'').trim();
    if(!pickupTime){
      alert('Bitte eine ungef√§hre Abholzeit angeben.');
      showCart();
      setTimeout(()=>{
        const input = document.getElementById('pickupTimeInput');
        if(input) input.focus();
      }, 50);
      return;
    }
    const code = genPickupCode();
    const firstOffer = cart.items.length ? offers.find(x=>x.id===cart.items[0].offerId) : null;
    const firstOfferNormalized = firstOffer ? normalizeOffer(firstOffer) : null;
    const pickupWindow = firstOfferNormalized && firstOfferNormalized.pickupWindow ? firstOfferNormalized.pickupWindow : '';
    const summary = cart.items.map(it=>{
      const o = offers.find(x=>x.id===it.offerId);
      if(!o) return '';
      const normalized = normalizeOffer(o);
      return `${normalized.dish || normalized.title || 'Gericht'} x ${it.qty}`;
    }).filter(Boolean).join(', ');
    const newOrder = {
      id: cryptoId(),
      providerName: cart.providerName || 'Anbieter',
      summary,
      code,
      status:'offen',
      pickupTime: cart.pickupTime || '',
      pickupWindow,
      createdAt: Date.now()
    };
    orders.unshift(newOrder);
    save(LS.orders, orders);
    cart = null;
    save(LS.cart, cart);
    renderCart();
    renderOrders();
    showOrders();
    openCodeSheet(newOrder.id);
  };

  // --- Start actions ---
  const startCustomerBtn = document.getElementById('btnStartCustomer');
  if(startCustomerBtn){
    startCustomerBtn.onclick=()=>{
      setMode('customer');
    };
  }
  const startProviderBtn = document.getElementById('btnStartProvider');
  if(startProviderBtn){
    startProviderBtn.onclick=()=>{
      setMode('provider');
    };
  }

  // --- Unified Login ---
  function updateProfileView(){
    const isLoggedIn = customer.loggedIn;
    document.getElementById('profileLoginSection').style.display = isLoggedIn ? 'none' : 'block';
    document.getElementById('profileLoggedInSection').style.display = isLoggedIn ? 'block' : 'none';
    document.getElementById('providerSwitchPanel').style.display = (isLoggedIn && provider.loggedIn) ? 'block' : 'none';
    if(isLoggedIn){
      document.getElementById('customerStatus').textContent = `Angemeldet als ${customer.name || 'Kunde'}`;
    }
  }

  document.getElementById('btnUnifiedLogin').onclick=()=>{
    const email = document.getElementById('unifiedEmail').value.trim();
    const pass = document.getElementById('unifiedPass').value.trim();
    if(!email || !pass){
      alert('Bitte E-Mail und Passwort eingeben.');
      return;
    }
    customer.loggedIn = true;
    customer.name = customer.name || email.split('@')[0];
    customer.email = email;
    save(LS.customer, customer);
    updateProfileView();
    showProfile();
  };

  document.getElementById('btnUnifiedLoginDemo').onclick=()=>{
    customer.loggedIn = true;
    customer.name = customer.name || 'Mike';
    save(LS.customer, customer);
    updateProfileView();
    showProfile();
  };

  document.getElementById('btnUnifiedLogout').onclick=()=>{
    customer.loggedIn = false;
    customer.name = null;
    customer.email = null;
    save(LS.customer, customer);
    updateProfileView();
    showProfile();
  };

  document.getElementById('linkProviderLogin').onclick=(e)=>{
    e.preventDefault();
    setMode('provider');
  };

  document.getElementById('btnSwitchToProvider').onclick=()=>{
    if(!provider.loggedIn){
      setMode('provider');
    } else {
      showProviderHome();
    }
  };

  // --- Provider entry ---
  document.getElementById('btnProvBack').onclick=()=>{ setMode('customer'); showProfile(); };

  document.getElementById('btnProvLogin').onclick=()=>{
    const email = document.getElementById('provEmail').value.trim();
    const pass = document.getElementById('provPass').value.trim();
    if(!email || !pass){ alert('Bitte E-Mail und Passwort eingeben.'); return; }
    provider.loggedIn = true;
    provider.email = email;
    save(LS.provider, provider);
    showProviderHome();
  };

  document.getElementById('btnProvLogout').onclick=()=>{
    provider.loggedIn=false;
    save(LS.provider, provider);
    setMode('customer');
    showProfile();
  };

  // Rechtliches
  document.getElementById('btnImpressum').onclick=()=>{
    alert('Impressum\n\nMittagio\n[Adresse]\n[Kontakt]\n\n(Platzhalter - wird sp√§ter ausgef√ºllt)');
  };
  document.getElementById('btnAGB').onclick=()=>{
    alert('Allgemeine Gesch√§ftsbedingungen\n\n(Platzhalter - wird sp√§ter ausgef√ºllt)');
  };
  document.getElementById('btnDatenschutz').onclick=()=>{
    alert('Datenschutzerkl√§rung\n\n(Platzhalter - wird sp√§ter ausgef√ºllt)');
  };

  // Provider nav handlers
  document.getElementById('providerNav').addEventListener('click',(e)=>{
    const b = e.target.closest('button');
    if(!b) return;
    const go = b.dataset.pgo;
    if(go==='provider-home') showProviderHome();
    if(go==='provider-pickups') showProviderPickups();
    if(go==='provider-cookbook') showProviderCookbook();
    if(go==='provider-profile') showProviderProfile();
  });

  // Customer nav handlers - Robuster Event-Delegation-Ansatz
  document.addEventListener('click', function(e){
    // Pr√ºfe ob Klick innerhalb von customerNav
    const nav = document.getElementById('customerNav');
    if(!nav || !nav.contains(e.target)) return;
    
    // Finde den Button (auch wenn auf Icon/Text geklickt wurde)
    let target = e.target;
    let btn = null;
    
    while(target && target !== nav){
      if(target.tagName === 'BUTTON' && target.classList.contains('navbtn')){
        btn = target;
        break;
      }
      target = target.parentElement;
    }
    
    if(!btn || !btn.dataset.go) return;
    
    const go = btn.dataset.go;
    e.preventDefault();
    e.stopPropagation();
    
    console.log('Navigation clicked:', go, 'mode:', mode);
    
    try {
      if(go==='discover'){
        if(mode === 'start'){
          showStart();
        } else {
          showDiscover();
        }
      } else if(go==='fav'){
        showFav();
      } else if(go==='orders'){
        showOrders();
      } else if(go==='cart'){
        showCart();
      } else if(go==='profile'){
        showProfile();
      }
    } catch(err){
      console.error('Navigation error:', err, go);
      alert('Navigation-Fehler: ' + err.message);
    }
  }, true); // useCapture f√ºr fr√ºhere Event-Erfassung

  // --- Provider home renders ---
  function renderProviderHome(){
    const profile = normalizeProviderProfile(provider.profile || {});

    const logoWrap = document.getElementById('provCardLogo');
    if(logoWrap){
      logoWrap.innerHTML = profile.logoData ? `<img src="${profile.logoData}" alt="Logo" />` : `<img src="assets/provider-placeholder.png" alt="Logo" />`;
    }
    const nameEl = document.getElementById('provCardName');
    if(nameEl) nameEl.textContent = profile.name || provider.email || 'Anbieter';
    const addrEl = document.getElementById('provCardAddr');
    if(addrEl) addrEl.textContent = buildAddress(profile) || 'Adresse fehlt';

    const todayKey = isoDate(new Date());
    const mineAll = offers.filter(o => o.providerId === providerId());
    const mineToday = mineAll.filter(o => o.active !== false && o.day === todayKey);

    const grid = document.getElementById('provTodayGrid');
    const empty = document.getElementById('provTodayEmpty');
    if(grid && empty){
      grid.innerHTML = '';
      if(!mineToday.length){
        empty.style.display='block';
      } else {
        empty.style.display='none';
        mineToday.forEach(o=> grid.appendChild(providerCard(o, {showActions:true, todayKey})));
      }
    }

    const withCodeToday = mineToday.filter(o=>o.hasPickupCode).length;
    const todayCount = document.getElementById('provTodayCount');
    if(todayCount){
      todayCount.textContent = withCodeToday ? `${withCodeToday} Abholcodes heute` : 'Keine Abholungen geplant.';
    }

    const weekPanel = document.getElementById('provWeekPanel');
    if(weekPanel){
      weekPanel.style.display = mineToday.length ? 'none' : 'block';
    }
    renderProviderWeekPreview();
  }

  function renderProviderWeekPreview(){
    const dayWrap = document.getElementById('provWeekDays');
    const list = document.getElementById('provWeekPreview');
    if(!dayWrap || !list) return;

    dayWrap.innerHTML = '';
    for(let i=0;i<5;i++){
      const d = new Date(); d.setDate(d.getDate()+i);
      const key = isoDate(d);
      const b = document.createElement('button');
      b.className = 'day' + (providerWeekDay===key ? ' active' : '');
      b.textContent = fmtDay(d);
      b.onclick=()=>{ providerWeekDay = key; renderProviderWeekPreview(); };
      dayWrap.appendChild(b);
    }

    const items = (week[providerWeekDay]||[]).filter(x=>x.providerId===providerId() && x.active !== false);
    if(!items.length){
      list.innerHTML = `
        <div>Keine Inserate geplant.</div>
        <div style="height:8px"></div>
        <button class="btn secondary" type="button" id="btnWeekAdd">Inserat hinzuf√ºgen</button>
      `;
      const addBtn = document.getElementById('btnWeekAdd');
      if(addBtn) addBtn.onclick=()=> startWizard('listing');
      return;
    }
    list.innerHTML = items.map(i=>`‚Ä¢ ${esc(i.dish)}`).join('<br>');
  }

  function renderWeekPlan(){
    const dayWrap = document.getElementById('weekDays');
    const list = document.getElementById('weekList');
    if(!dayWrap || !list) return;

    dayWrap.innerHTML = '';
    for(let i=0;i<5;i++){
      const d = new Date(); d.setDate(d.getDate()+i);
      const key = isoDate(d);
      const b = document.createElement('button');
      b.className = 'day' + (weekPlanDay===key ? ' active' : '');
      b.textContent = fmtDay(d);
      b.onclick=()=>{ weekPlanDay = key; renderWeekPlan(); };
      dayWrap.appendChild(b);
    }

    const dayEntries = week[weekPlanDay] || [];
    const providerEntries = dayEntries
      .map((entry, idx)=>({entry, idx}))
      .filter(x=>x.entry.providerId===providerId());

    if(!providerEntries.length){
      list.textContent = 'Noch nichts geplant.';
      return;
    }

    list.innerHTML = '';
    providerEntries.forEach(({entry, idx})=>{
      const cb = cookbook.find(c=>c.id===entry.cookbookId);
      const name = cb?.dish || entry.dish || 'Gericht';
      const price = cb?.price || 0;
      const isActive = entry.active !== false;

      const item = document.createElement('div');
      item.className = 'cookbook-item';
      item.innerHTML = `
        <div style="font-weight:900">${esc(name)}</div>
        <div class="hint">${euro(price)} - ${isActive ? 'Aktiv' : 'Inaktiv'}</div>
      `;

      const actions = document.createElement('div');
      actions.className = 'cookbook-actions';

      const edit = document.createElement('button');
      edit.type='button';
      edit.className='ans';
      edit.textContent='Bearbeiten';
      edit.onclick=()=>{ if(entry.cookbookId) startWizard('cookbook', {editId: entry.cookbookId}); };

      const toggle = document.createElement('button');
      toggle.type='button';
      toggle.className='ans';
      toggle.textContent = isActive ? 'Deaktivieren' : 'Aktivieren';
      toggle.onclick=()=>{
        const updated = (week[weekPlanDay]||[]).map((x,i)=> i===idx ? {...x, active: !(x.active !== false)} : x);
        if(updated.length) week[weekPlanDay]=updated; else delete week[weekPlanDay];
        save(LS.week, week);
        renderWeekPlan();
        renderProviderWeekPreview();
      };

      const share = document.createElement('button');
      share.type='button';
      share.className='ans';
      share.textContent='Teilen';
      share.onclick=()=>{ shareOffer({dish:name, price}); };

      const print = document.createElement('button');
      print.type='button';
      print.className='ans';
      print.textContent='Drucken';
      print.onclick=()=>{
        const profile = normalizeProviderProfile(provider.profile || {});
        const offer = normalizeOffer({
          providerId: providerId(),
          providerName: profile.name || provider.email || 'Anbieter',
          providerStreet: profile.street||'',
          providerZip: profile.zip||'',
          providerCity: profile.city||'',
          providerLogoData: profile.logoData||'',
          dish: name,
          category: cb?.category || 'Vegetarisch',
          price: Number(price||0),
          pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
          hasPickupCode: !!cb?.hasPickupCode,
          dineInPossible: !!cb?.dineInPossible,
          imageUrl: cb?.photoData || ''
        });
        printOffer(offer);
      };

      actions.appendChild(edit);
      actions.appendChild(toggle);
      actions.appendChild(share);
      actions.appendChild(print);
      item.appendChild(actions);
      list.appendChild(item);
    });
  }

  function pickupCodeCount(dish){
    const base = String(dish||'').split('').reduce((sum, ch)=>sum + ch.charCodeAt(0), 0);
    return 2 + (base % 4); // 2..5
  }

  function buildPickupGroups(){
    const todayKey = isoDate(new Date());
    const mineToday = offers.filter(o => o.providerId === providerId() && o.hasPickupCode && o.day === todayKey && o.active !== false);
    if(!mineToday.length) return [];

    const map = new Map();
    mineToday.forEach(o=>{
      const dish = o.dish || 'Gericht';
      if(!map.has(dish)){
        map.set(dish, {dish, time: o.pickupWindow || '', offerId: o.id, codeCount: o.pickupCodeCount});
      }
    });

    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const groups = Array.from(map.values()).map((g, idx)=>{
      const group = letters[idx % letters.length];
      const count = Number(g.codeCount) || pickupCodeCount(g.dish);
      const codes = Array.from({length:count}, (_,i)=>`${group}${i+1}`);
      return {id:`${group}:${g.offerId}`, group, dish:g.dish, time:g.time, codes};
    });
    return groups;
  }

  function renderProviderPickups(){
    const empty = document.getElementById('provPickupsEmpty');
    const wrap = document.getElementById('provPickupsWrap');
    const sortEl = document.getElementById('provPickupSort');
    const groupsEl = document.getElementById('provPickupGroups');
    if(!empty || !wrap || !sortEl || !groupsEl) return;

    const groups = buildPickupGroups();
    if(!groups.length){
      empty.style.display='block';
      wrap.style.display='none';
      return;
    }
    empty.style.display='none';
    wrap.style.display='block';

    sortEl.innerHTML='';
    [
      {id:'time', label:'Zeit'},
      {id:'code', label:'Code'},
      {id:'group', label:'Gruppe'}
    ].forEach(s=>{
      const b=document.createElement('button');
      b.type='button';
      b.className='ans'+(pickupSort===s.id?' on':'');
      b.textContent=s.label;
      b.onclick=()=>{ pickupSort=s.id; renderProviderPickups(); };
      sortEl.appendChild(b);
    });

    const list = [...groups];
    const timeKey = (t)=>{
      const raw = String(t||'').split(/[‚Äì-]/)[0].trim();
      const parts = raw.split(':');
      const h = parseInt(parts[0]||'0',10);
      const m = parseInt(parts[1]||'0',10);
      return h*60+m;
    };
    if(pickupSort==='time') list.sort((a,b)=>timeKey(a.time)-timeKey(b.time));
    if(pickupSort==='code') list.sort((a,b)=>(a.codes[0]||'').localeCompare(b.codes[0]||''));
    if(pickupSort==='group') list.sort((a,b)=>a.group.localeCompare(b.group));

    groupsEl.innerHTML='';
    list.forEach(g=>{
      const box=document.createElement('div');
      box.className='pickup-group';
      box.innerHTML = `
        <div class="pickup-head">
          <div>${esc(g.dish)}</div>
          <div class="pickup-sub">Gruppe ${esc(g.group)} - ${esc(g.time || '-')}</div>
        </div>
        <div style="margin-top:6px;">
          ${g.codes.map(c=>{
            const key = `${g.id}:${c}`;
            const done = pickupDone.has(key);
            return `<button type="button" class="code-chip${done ? ' done' : ''}" data-code="${esc(c)}" data-group="${esc(g.id)}">${esc(c)}</button>`;
          }).join('')}
        </div>
      `;
      groupsEl.appendChild(box);
    });

    groupsEl.querySelectorAll('.code-chip').forEach(btn=>{
      btn.onclick=()=>{
        const code = btn.getAttribute('data-code') || '';
        const group = btn.getAttribute('data-group') || '';
        const key = `${group}:${code}`;
        if(pickupDone.has(key)){
          pickupDone.delete(key);
          save(LS.pickupDone, Array.from(pickupDone));
          renderProviderPickups();
        } else {
          pickupDone.add(key);
          save(LS.pickupDone, Array.from(pickupDone));
          renderProviderPickups();
          showPickupUndo(key);
        }
      };
    });
  }

  function showPickupUndo(key){
    pickupUndoKey = key;
    const snack = document.getElementById('pickupUndo');
    if(!snack) return;
    const label = document.getElementById('pickupUndoLabel');
    if(label) label.textContent = 'Abholung markiert';
    const btn = document.getElementById('pickupUndoBtn');
    if(btn){
      btn.onclick=()=>{
        if(pickupUndoKey && pickupDone.has(pickupUndoKey)){
          pickupDone.delete(pickupUndoKey);
          save(LS.pickupDone, Array.from(pickupDone));
          renderProviderPickups();
        }
        hidePickupUndo();
      };
    }
    snack.classList.add('active');
    if(pickupUndoTimer) clearTimeout(pickupUndoTimer);
    pickupUndoTimer = setTimeout(hidePickupUndo, 5000);
  }

  function hidePickupUndo(){
    const snack = document.getElementById('pickupUndo');
    if(!snack) return;
    snack.classList.remove('active');
    pickupUndoKey = null;
  }

  function renderProviderProfile(){
    const p = normalizeProviderProfile(provider.profile || {});
    const addr = buildAddress(p);
    const parsed = parseAddress(p.address || '');
    const city = p.city || parsed.city || '';
    const logoWrap = document.getElementById('provProfileLogo');
    if(logoWrap){
      logoWrap.innerHTML = p.logoData ? `<img src="${p.logoData}" alt="Logo" />` : `<img src="assets/provider-placeholder.png" alt="Logo" />`;
    }
    const nameEl = document.getElementById('provProfileName');
    if(nameEl) nameEl.textContent = p.name || provider.email || 'Anbieter';
    const cityEl = document.getElementById('provProfileCity');
    if(cityEl) cityEl.textContent = city || addr || 'Ort fehlt';
    const mealEl = document.getElementById('provProfileMeal');
    if(mealEl) mealEl.textContent = p.mealWindow || DEFAULT_MEAL_WINDOW;
  }

  function renderBilling(){
    const amountEl = document.getElementById('billingAmount');
    const lastEl = document.getElementById('billingLast');
    const filtersEl = document.getElementById('billingFilters');
    const monthEl = document.getElementById('billingMonth');
    const listEl = document.getElementById('billingList');
    if(!amountEl || !lastEl || !filtersEl || !monthEl || !listEl) return;

    const demo = [
      {range:'06.01.‚Äì12.01.2026', sales:18, total:148.50, fee:7.20, payout:141.30, status:'N√§chste Auszahlung geplant'},
      {range:'30.12.‚Äì05.01.2026', sales:12, total:96.80, fee:4.80, payout:92.00, status:'Auszahlung erfolgt'}
    ];

    amountEl.textContent = euro(demo[0].payout);
    lastEl.textContent = `Letzte Auszahlung: ${demo[1].range} ¬∑ ${euro(demo[1].payout)}`;

    const filters = [
      {id:'today', label:'Heute'},
      {id:'week', label:'Woche'},
      {id:'month', label:'Monat'},
      {id:'custom', label:'Benutzerdefiniert'}
    ];
    filtersEl.innerHTML = '';
    filters.forEach(f=>{
      const b=document.createElement('button');
      b.type='button';
      b.className='ans'+(billingFilter===f.id?' on':'');
      b.textContent=f.label;
      b.onclick=()=>{ billingFilter = f.id; renderBilling(); };
      filtersEl.appendChild(b);
    });

    monthEl.value = billingMonth;
    monthEl.onchange = ()=>{ billingMonth = monthEl.value; renderBilling(); };

    listEl.innerHTML = demo.map(d=>`
      <div class="cookbook-item">
        <div style="font-weight:900">${esc(d.range)}</div>
        <div class="cookbook-facts">
          Verk√§ufe: ${d.sales} ¬∑ Gesamt: ${euro(d.total)}<br>
          Geb√ºhren: ${euro(d.fee)} ¬∑ Auszahlung: <b>${euro(d.payout)}</b><br>
          Status: ${esc(d.status)}
        </div>
        <div class="cookbook-actions">
          <button class="card-action" type="button" data-icon="print">PDF-Download</button>
        </div>
      </div>
    `).join('');
    listEl.querySelectorAll('button').forEach(btn=>{
      btn.onclick=()=> alert('PDF-Download (Demo).');
    });
    applyStaticIcons();
  }

  document.getElementById('btnProvFaq').onclick=()=>{
    const box = document.getElementById('provFaqBox');
    box.style.display = box.style.display==='none' ? 'block' : 'none';
  };

  document.getElementById('btnBilling').onclick=()=>{
    showProviderBilling();
  };
  document.getElementById('btnBillingBack').onclick=()=> showProviderProfile();

  document.getElementById('rowProfileOverview').onclick=()=>{
    const p = normalizeProviderProfile(provider.profile || {});
    const addr = buildAddress(p) || 'Adresse fehlt';
    alert(`Profil-√úbersicht\n${p.name || 'Name fehlt'}\n${addr}\nEssenszeit: ${p.mealWindow || DEFAULT_MEAL_WINDOW}`);
  };

  document.getElementById('btnProvShareOffer').onclick=()=>{
    const first = offers.find(o=>o.providerId===providerId());
    if(first) shareOffer(first);
    else alert('Noch keine Inserate zum Teilen.');
  };
  document.getElementById('btnProvWeekPdf').onclick=()=> printWeekCard();
  document.getElementById('btnProvSupport').onclick=()=>{
    window.location.href = 'mailto:support@mittagio.de';
  };

  document.getElementById('btnLegalImprint').onclick=()=>{
    alert('Impressum (Demo): Link folgt.');
  };
  document.getElementById('btnLegalPrivacy').onclick=()=>{
    alert('Datenschutz (Demo): Link folgt.');
  };
  document.getElementById('btnLegalTerms').onclick=()=>{
    alert('AGB (Demo): Link folgt.');
  };
  document.getElementById('btnLegalPricing').onclick=()=>{
    alert('Preise & Konditionen (Demo): Link folgt.');
  };

  // --- Provider actions ---
  document.getElementById('btnNewListing').onclick=()=> startWizard('listing');
  document.getElementById('btnFromCookbook').onclick=()=> startWizard('listing', {source:'cookbook'});
  document.getElementById('btnCookbookAdd').onclick=()=> startWizard('cookbook');
  document.getElementById('btnProvSetup').onclick=()=> startWizard('provider');
  document.getElementById('btnOpenWeekPlan').onclick=()=> showProviderWeek();
  document.getElementById('btnPickupsFaq').onclick=()=>{
    showProviderProfile();
    const box = document.getElementById('provFaqBox');
    if(box) box.style.display = 'block';
  };

  document.getElementById('btnEditOffer').onclick=()=>{
    if(!activeProviderOfferId) return;
    closeProviderSheet();
    startWizard('listing', {editOfferId: activeProviderOfferId});
  };
  document.getElementById('btnToggleOffer').onclick=()=>{
    if(!activeProviderOfferId) return;
    const idx = offers.findIndex(x=>x.id===activeProviderOfferId);
    if(idx<0) return;
    offers[idx].active = offers[idx].active === false ? true : false;
    save(LS.offers, offers);
    closeProviderSheet();
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
  };
  document.getElementById('btnShareOffer').onclick=()=>{
    if(!activeProviderOfferId) return;
    const o = offers.find(x=>x.id===activeProviderOfferId);
    if(!o) return;
    shareOffer(o);
  };
  document.getElementById('btnPrintOffer').onclick=()=>{
    if(!activeProviderOfferId) return;
    const o = offers.find(x=>x.id===activeProviderOfferId);
    if(!o) return;
    printOffer(o);
  };

  document.getElementById('btnWeekBack').onclick=()=> showProviderHome();
  document.getElementById('btnWeekPdf').onclick=()=>{
    printWeekCard();
  };

  // Provider ID (for demo)
  function providerId(){
    // stable per email
    const e = provider.email || 'provider';
    return 'prov_' + btoa(unescape(encodeURIComponent(e))).slice(0,16);
  }

  // --- Cookbook ---
  function renderCookbook(){
    const box = document.getElementById('cookbookList');
    const tabs = document.getElementById('cookbookTabs');
    const sortBox = document.getElementById('cookbookSorts');
    const search = document.getElementById('cookbookSearch');
    if(!box) return;

    let updated = false;
    cookbook = cookbook.map(entry=>{
      const out = {...entry};
      if(!out.createdAt){ out.createdAt = Date.now(); updated = true; }
      if(out.lastUsed === undefined){ out.lastUsed = null; updated = true; }
      return out;
    });
    if(updated) save(LS.cookbook, cookbook);

    if(search){
      if(search.value !== cookbookQuery) search.value = cookbookQuery || '';
      search.oninput=()=>{ cookbookQuery = search.value; renderCookbook(); };
    }

    if(tabs){
      tabs.innerHTML='';
      [
        {id:'drafts', label:'Entw√ºrfe'},
        {id:'dishes', label:'Gerichte'}
      ].forEach(t=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(cookbookTab===t.id?' on':'');
        b.textContent=t.label;
        b.onclick=()=>{ cookbookTab=t.id; renderCookbook(); };
        tabs.appendChild(b);
      });
    }

    if(sortBox){
      sortBox.innerHTML='';
      [
        {id:'recent', label:'Zuletzt verwendet'},
        {id:'alpha', label:'Alphabetisch'},
        {id:'priceAsc', label:'Preis aufsteigend'},
        {id:'priceDesc', label:'Preis absteigend'}
      ].forEach(f=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(cookbookSort===f.id?' on':'');
        b.textContent=f.label;
        b.onclick=()=>{ cookbookSort=f.id; renderCookbook(); };
        sortBox.appendChild(b);
      });
    }

    const mine = cookbook.filter(x=>x.providerId===providerId());
    const q = String(cookbookQuery||'').trim().toLowerCase();
    const filtered = mine.filter(x => !q || String(x.dish||'').toLowerCase().includes(q));

    if(!filtered.length){
      box.innerHTML = '<div class="hint">Noch keine Gerichte gespeichert.</div>';
      return;
    }

    const sortRecent = (a,b)=>(b.lastUsed||b.createdAt) - (a.lastUsed||a.createdAt);
    const sortAlpha = (a,b)=>String(a.dish||'').localeCompare(String(b.dish||''));
    const sortPriceAsc = (a,b)=>(Number(a.price||0) - Number(b.price||0));
    const sortPriceDesc = (a,b)=>(Number(b.price||0) - Number(a.price||0));
    const sortFn = cookbookSort==='alpha' ? sortAlpha : (cookbookSort==='priceAsc' ? sortPriceAsc : (cookbookSort==='priceDesc' ? sortPriceDesc : sortRecent));

    const dishes = filtered.filter(x=>x.lastUsed);
    const drafts = filtered.filter(x=>!x.lastUsed);
    dishes.sort(sortFn);
    drafts.sort(sortFn);

    const list = cookbookTab === 'drafts' ? drafts : dishes;
    const formatDayLabel = (iso)=>{
      if(!iso) return '‚Äî';
      const d = new Date(iso);
      if(Number.isNaN(d.getTime())) return iso;
      const today = isoDate(new Date());
      const tomorrow = isoDate(new Date(Date.now()+86400000));
      if(iso===today) return 'Heute';
      if(iso===tomorrow) return 'Morgen';
      return fmtDay(d);
    };

    const buildItem = (entry, isDraft)=>{
      const item=document.createElement('div');
      item.className='cookbook-item';

      const lastOnline = offers
        .filter(o=>o.providerId===providerId() && o.dish===entry.dish)
        .map(o=>o.day)
        .sort()
        .slice(-1)[0];
      const sales = offers.filter(o=>o.providerId===providerId() && o.dish===entry.dish).length * 3;

      item.innerHTML = `
        <div style="font-weight:900">${esc(entry.dish||'Gericht')}</div>
        <div class="hint">${esc(entry.category||'Vegetarisch')} ¬∑ ${euro(entry.price||0)}</div>
        <div class="cookbook-facts">
          ${isDraft ? 'Entwurf seit:' : 'Letzte Ver√∂ffentlichung:'}
          <b>${esc(formatDayLabel(isDraft ? entry.createdAt : lastOnline))}</b><br>
          Verk√§ufe (Mittagio, gesamt): <b>${sales}</b>
        </div>
      `;

      const actions=document.createElement('div');
      actions.className='cookbook-actions';

      if(isDraft){
        const cont=document.createElement('button');
        cont.type='button';
        cont.className='ans';
        cont.textContent='Weiterf√ºhren';
        cont.dataset.icon = 'plus';
        cont.onclick=()=>{ startWizard('listing', {fromCookbookId: entry.id}); };

        const edit=document.createElement('button');
        edit.type='button';
        edit.className='ans';
        edit.textContent='Bearbeiten';
        edit.dataset.icon = 'edit';
        edit.onclick=()=>{ startWizard('cookbook', {editId: entry.id}); };

        actions.appendChild(cont);
        actions.appendChild(edit);
      } else {
        const create=document.createElement('button');
        create.type='button';
        create.className='ans';
        create.textContent='Inserat erstellen';
        create.dataset.icon = 'plus';
        create.onclick=()=>{ startWizard('listing', {fromCookbookId: entry.id}); };

        const edit=document.createElement('button');
        edit.type='button';
        edit.className='ans';
        edit.textContent='Bearbeiten';
        edit.dataset.icon = 'edit';
        edit.onclick=()=>{ startWizard('cookbook', {editId: entry.id}); };

        const print=document.createElement('button');
        print.type='button';
        print.className='ans';
        print.textContent='Drucken';
        print.dataset.icon = 'print';
        print.onclick=()=>{ printCookbookEntry(entry); };

        actions.appendChild(create);
        actions.appendChild(edit);
        actions.appendChild(print);
      }
      item.appendChild(actions);
      return item;
    };

    box.innerHTML = '';
    if(!list.length){
      box.innerHTML = `<div class="hint">Keine ${cookbookTab==='drafts' ? 'Entw√ºrfe' : 'Gerichte'} vorhanden.</div>`;
      return;
    }
    list.forEach(entry=> box.appendChild(buildItem(entry, cookbookTab==='drafts')));
    applyStaticIcons();
  }

  function publishCookbookEntry(entryId){
    const entry = cookbook.find(c=>c.id===entryId && c.providerId===providerId());
    if(!entry) return;

    const profile = normalizeProviderProfile(provider.profile || {});
    const offer = normalizeOffer({
      id: cryptoId(),
      providerId: providerId(),
      providerName: profile.name || provider.email || 'Anbieter',
      providerStreet: profile.street||'',
      providerZip: profile.zip||'',
      providerCity: profile.city||'',
      providerLogoData: profile.logoData||'',
      dish: entry.dish||'',
      category: entry.category||'Vegetarisch',
      price: Number(entry.price||0),
      pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
      hasPickupCode: !!entry.hasPickupCode,
      dineInPossible: !!entry.dineInPossible,
      allergens: entry.allergens||[],
      extras: entry.extras||[],
      reuse: entry.reuse||{enabled:false,deposit:0},
      imageUrl: entry.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
      day: isoDate(new Date())
    });

    if(!offer.providerStreet){
      alert('Bitte zuerst Anbieterprofil ausf√ºllen (Adresse).');
      return;
    }

    offers.unshift(offer);
    save(LS.offers, offers);

    const idx = cookbook.findIndex(c=>c.id===entryId);
    if(idx>=0){ cookbook[idx].lastUsed = Date.now(); }
    save(LS.cookbook, cookbook);

    renderCookbook();
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
    renderStart();
    alert('Inserat ver√∂ffentlicht.');
  }

  function publishWeekEntry(dayKey, entry){
    const cb = cookbook.find(c=>c.id===entry.cookbookId);
    if(!cb){
      alert('Gericht nicht gefunden.');
      return;
    }

    const profile = normalizeProviderProfile(provider.profile || {});
    const offer = normalizeOffer({
      id: cryptoId(),
      providerId: providerId(),
      providerName: profile.name || provider.email || 'Anbieter',
      providerStreet: profile.street||'',
      providerZip: profile.zip||'',
      providerCity: profile.city||'',
      providerLogoData: profile.logoData||'',
      dish: cb.dish||entry.dish||'',
      category: cb.category||'Vegetarisch',
      price: Number(cb.price||0),
      pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
      hasPickupCode: !!cb.hasPickupCode,
      dineInPossible: !!cb.dineInPossible,
      allergens: cb.allergens||[],
      extras: cb.extras||[],
      reuse: cb.reuse||{enabled:false,deposit:0},
      imageUrl: cb.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
      day: dayKey
    });

    if(!offer.providerStreet){
      alert('Bitte zuerst Anbieterprofil ausf√ºllen (Adresse).');
      return;
    }

    offers.unshift(offer);
    save(LS.offers, offers);

    const idx = cookbook.findIndex(c=>c.id===entry.cookbookId);
    if(idx>=0){ cookbook[idx].lastUsed = Date.now(); }
    save(LS.cookbook, cookbook);

    renderWeekPlan();
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
    renderStart();
    alert('Inserat ver√∂ffentlicht.');
  }

  // --- Wizard engine (Provider profile / Listing / Cookbook / Week) ---
  let w = { kind:null, step:0, data:{}, ctx:{} };

  const ALLERGENS_14 = [
    {name:'Gluten', short:'GL'},
    {name:'Krebstiere', short:'KR'},
    {name:'Eier', short:'EI'},
    {name:'Fisch', short:'FI'},
    {name:'Erdn√ºsse', short:'EN'},
    {name:'Soja', short:'SO'},
    {name:'Milch', short:'MI'},
    {name:'Schalenfr√ºchte', short:'SF'},
    {name:'Sellerie', short:'SE'},
    {name:'Senf', short:'SN'},
    {name:'Sesam', short:'SS'},
    {name:'Sulfite', short:'SU'},
    {name:'Lupinen', short:'LU'},
    {name:'Weichtiere', short:'WE'}
  ];

  function openWizard(){
    document.getElementById('wbd').classList.add('active');
    document.getElementById('wizard').classList.add('active');
  }
  function closeWizard(){
    document.getElementById('wbd').classList.remove('active');
    document.getElementById('wizard').classList.remove('active');
  }

  function startWizard(kind, ctx={}){
    w = { kind, step:0, data:{}, ctx };

    if(kind==='provider'){
      w.data = normalizeProviderProfile(JSON.parse(JSON.stringify(provider.profile||{})));
      buildProviderStep();
    }
    if(kind==='cookbook'){
      if(ctx.editId){
        const existing = cookbook.find(c=>c.id===ctx.editId);
        if(existing){ w.data = JSON.parse(JSON.stringify(existing)); }
      }
      if(!w.data || !w.data.providerId){
        w.data = {
          providerId: providerId(),
          dish:'', category:'Vegetarisch', price:0,
          allergens:[],
          extras:[],
          reuse:{enabled:false, deposit:0},
          photoData:'',
          hasPickupCode:false,
          dineInPossible:false,
          createdAt: Date.now(),
          lastUsed: null
        };
      }
      w.data.providerId = providerId();
      w.data.category = w.data.category || 'Vegetarisch';
      w.data.price = Number(w.data.price||0);
      w.data.allergens = Array.isArray(w.data.allergens) ? w.data.allergens : [];
      w.data.extras = Array.isArray(w.data.extras) ? w.data.extras : [];
      if(!w.data.reuse) w.data.reuse = {enabled:false, deposit:0};
      w.data.photoData = w.data.photoData || '';
      w.data.hasPickupCode = !!w.data.hasPickupCode;
      w.data.dineInPossible = !!w.data.dineInPossible;
      w.data.createdAt = w.data.createdAt || Date.now();
      if(w.data.lastUsed === undefined) w.data.lastUsed = null;
      buildCookbookStep();
    }
    if(kind==='listing'){
      const profile = normalizeProviderProfile(provider.profile || {});
      // if from cookbook
      if(ctx.editOfferId){
        const existing = offers.find(o=>o.id===ctx.editOfferId);
        if(existing){
          const o = normalizeOffer(existing);
          w.data = {
            providerId: o.providerId || providerId(),
            dish: o.dish||'',
            category: o.category||'Vegetarisch',
            price: Number(o.price||0),
            pickupWindow: o.pickupWindow || profile.mealWindow || DEFAULT_MEAL_WINDOW,
            hasPickupCode: !!o.hasPickupCode,
            dineInPossible: !!o.dineInPossible,
            allergens: Array.isArray(o.allergens) ? [...o.allergens] : [],
            extras: Array.isArray(o.extras) ? JSON.parse(JSON.stringify(o.extras)) : [],
            reuse: o.reuse ? JSON.parse(JSON.stringify(o.reuse)) : {enabled:false, deposit:0},
            photoData: o.imageUrl || '',
            day: o.day,
            active: o.active !== false
          };
        }
      } else if(ctx.fromCookbookId){
        const x = cookbook.find(c=>c.id===ctx.fromCookbookId);
        if(x){
          w.data = {
            ...JSON.parse(JSON.stringify(x)),
            source:'cookbook',
            cookbookId: x.id
          };
        }
      } else {
        w.data = {
          providerId: providerId(),
          dish:'', category:'Vegetarisch', price:0,
          pickupWindow: profile.mealWindow || DEFAULT_MEAL_WINDOW,
          hasPickupCode:false,
          dineInPossible:false,
          allergens:[],
          extras:[],
          reuse:{enabled:false, deposit:0},
          photoData:'',
          source:'new',
          cookbookId:null
        };
      }
      w.data.providerId = w.data.providerId || providerId();
      w.data.category = w.data.category || 'Vegetarisch';
      w.data.price = Number(w.data.price||0);
      w.data.pickupWindow = w.data.pickupWindow || profile.mealWindow || DEFAULT_MEAL_WINDOW;
      w.data.source = w.data.source || 'new';
      if(ctx.source){ w.data.source = ctx.source; }
      w.data.cookbookId = w.data.cookbookId || null;
      w.data.hasPickupCode = !!w.data.hasPickupCode;
      w.data.dineInPossible = !!w.data.dineInPossible;
      w.data.allergens = Array.isArray(w.data.allergens) ? w.data.allergens : [];
      w.data.extras = Array.isArray(w.data.extras) ? w.data.extras : [];
      if(!w.data.reuse) w.data.reuse = {enabled:false, deposit:0};
      buildListingStep();
    }
    if(kind==='week'){
      // schedule cookbook item to a date
      const x = cookbook.find(c=>c.id===ctx.fromCookbookId);
      if(!x){ alert('Bitte erst ein Gericht im Kochbuch speichern.'); return; }
      w.data = { cookbookId:x.id, date: isoDate(new Date()) };
      buildWeekStep();
    }

    openWizard();
  }

  // Common wizard buttons
  const wBackBtn = document.getElementById('wBack');
  const wNextBtn = document.getElementById('wNext');
  const defaultWizardNext = ()=>{ w.step += 1; rebuildWizard(); };
  function setWizardNextDefault(){ wNextBtn.onclick = defaultWizardNext; }

  wBackBtn.onclick=()=>{
    if(w.step===0){ closeWizard(); return; }
    w.step -= 1;
    rebuildWizard();
  };
  setWizardNextDefault();

  function setWizardHeader(title, stepText){
    document.getElementById('wTitle').textContent = title;
    document.getElementById('wStep').textContent = stepText;
  }
  function setWizardQuestion(q, help=''){ 
    document.getElementById('wQ').textContent = q;
    document.getElementById('wHelp').textContent = help;
  }
  function setWizardContent(node){
    const c = document.getElementById('wContent');
    c.innerHTML='';
    c.appendChild(node);
  }

  function rebuildWizard(){
    if(w.kind==='provider') return buildProviderStep();
    if(w.kind==='cookbook') return buildCookbookStep();
    if(w.kind==='listing') return buildListingStep();
    if(w.kind==='week') return buildWeekStep();
  }

  function saveProviderProfileFromWizard(){
    const parsed = parseAddress(w.data.address || '');
    const street = parsed.street || w.data.street || '';
    const zip = parsed.zip || w.data.zip || '';
    const city = parsed.city || w.data.city || '';
    const address = parsed.address || buildAddress({street, zip, city});

    provider.profile = {
      name: w.data.name||'',
      address,
      street,
      zip,
      city,
      mealWindow: w.data.mealWindow || DEFAULT_MEAL_WINDOW,
      logoData: w.data.logoData||''
    };
    save(LS.provider, provider);
    renderProviderProfile();
    renderProviderHome();
  }

  // --- Provider onboarding (step-by-step, no form) ---
  function buildProviderStep(){
    setWizardNextDefault();
    const total = 5;
    const stepText = `Schritt ${Math.min(w.step+1,total)} von ${total}`;
    setWizardHeader('Anbieter-Profil', stepText);

    if(w.step >= total){
      saveProviderProfileFromWizard();
      closeWizard();
      alert('Profil ist bereit.');
      return;
    }

    if(w.step===0){
      setWizardQuestion('Wie hei√üt dein Betrieb?', 'Du kannst den Namen jederzeit √§ndern.');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field';
      input.placeholder='z.B. Metzgerei M√ºller';
      input.value = w.data.name || '';
      input.oninput=()=>{ w.data.name=input.value; };
      box.appendChild(input);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===1){
      setWizardQuestion('Adresse deines Betriebs?', 'Auto-Vervollst√§ndigung folgt (Demo).');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field';
      input.placeholder='Musterstrasse 12, 73614 Schorndorf';
      input.value = w.data.address || buildAddress(w.data) || '';
      input.oninput=()=>{ w.data.address=input.value; };
      box.appendChild(input);
      const h=document.createElement('div'); h.className='hint'; h.textContent='Tipp: Stra√üe, PLZ, Ort - getrennt mit Komma.';
      box.appendChild(h);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===2){
      setWizardQuestion('Wann k√∂nnen G√§ste dein Essen genie√üen?', 'Standard aus Profil, optional anpassen.');
      if(!w.data.mealWindow) w.data.mealWindow = DEFAULT_MEAL_WINDOW;

      const current = w.data.mealWindow || DEFAULT_MEAL_WINDOW;
      const split = current.includes('‚Äì') ? current.split('‚Äì') : current.split('-');
      const startDefault = split[0] ? split[0].trim() : '11:30';
      const endDefault = split[1] ? split[1].trim() : '14:00';
      if(!w.data.mealStart) w.data.mealStart = startDefault;
      if(!w.data.mealEnd) w.data.mealEnd = endDefault;

      const box=document.createElement('div');
      const summary=document.createElement('div');
      summary.className='panel';
      summary.innerHTML = `<b>${esc(current)}</b><div class="hint">Standard aus Profil</div>`;
      box.appendChild(summary);

      const actions=document.createElement('div');
      actions.className='answers';
      const toggle=document.createElement('button');
      toggle.type='button';
      toggle.className='ans';
      toggle.textContent = w.data.mealCustom ? 'Fertig' : 'Essenszeit √§ndern';
      toggle.onclick=()=>{
        w.data.mealCustom = !w.data.mealCustom;
        rebuildWizard();
      };
      actions.appendChild(toggle);
      box.appendChild(actions);

      if(w.data.mealCustom){
        const updateMealWindow = ()=>{
          if(w.data.mealStart && w.data.mealEnd){
            w.data.mealWindow = `${w.data.mealStart} ‚Äì ${w.data.mealEnd}`;
          }
        };

        const startLabel=document.createElement('div'); startLabel.className='hint'; startLabel.textContent='Start';
        const startRow=document.createElement('div'); startRow.className='answers';
        ['10:30','11:00','11:30','12:00'].forEach(t=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.mealStart===t?' on':'');
          b.textContent=t;
          b.onclick=()=>{ w.data.mealStart=t; updateMealWindow(); rebuildWizard(); };
          startRow.appendChild(b);
        });

        const endLabel=document.createElement('div'); endLabel.className='hint'; endLabel.textContent='Ende';
        const endRow=document.createElement('div'); endRow.className='answers';
        ['13:00','13:30','14:00','14:30'].forEach(t=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.mealEnd===t?' on':'');
          b.textContent=t;
          b.onclick=()=>{ w.data.mealEnd=t; updateMealWindow(); rebuildWizard(); };
          endRow.appendChild(b);
        });

        box.appendChild(document.createElement('div')).style.height='10px';
        box.appendChild(startLabel);
        box.appendChild(startRow);
        box.appendChild(document.createElement('div')).style.height='8px';
        box.appendChild(endLabel);
        box.appendChild(endRow);
      }

      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===3){
      setWizardQuestion('Logo hochladen?', 'Optional, sp√§ter jederzeit austauschbar.');
      const wrap = document.createElement('div');
      const btns=document.createElement('div');
      btns.className='answers';

      const up=document.createElement('button');
      up.className='ans';
      up.type='button';
      up.textContent='Logo ausw√§hlen';
      up.onclick=async()=>{
        const file = await pickImage();
        if(!file) return;
        w.data.logoData = await toDataUrl(file);
        rebuildWizard();
      };

      const skip=document.createElement('button');
      skip.className='ans';
      skip.type='button';
      skip.textContent='Sp√§ter';
      skip.onclick=()=>{ w.data.logoData=''; rebuildWizard(); };

      btns.appendChild(up);
      btns.appendChild(skip);
      wrap.appendChild(btns);

      if(w.data.logoData){
        const prev=document.createElement('div');
        prev.style.marginTop='10px';
        prev.innerHTML = `<div class="hint">Vorschau:</div><div class="plogo" style="width:60px;height:60px;border-radius:14px"><img src="${w.data.logoData}" alt="Logo" /></div>`;
        wrap.appendChild(prev);
      }

      setWizardContent(wrap);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===4){
      setWizardQuestion('Profil ist bereit', 'Kurz pr√ºfen, dann loslegen.');
      const box=document.createElement('div');
      const addr = buildAddress(w.data);
      const logo = w.data.logoData ? `<img src="${w.data.logoData}" alt="Logo" />` : `<img src="assets/provider-placeholder.png" alt="Logo" />`;

      const summary=document.createElement('div');
      summary.className='panel';
      summary.innerHTML = `
        <div style="display:flex;gap:10px;align-items:center;">
          <div class="plogo" style="width:52px;height:52px;border-radius:14px">${logo}</div>
          <div>
            <div style="font-weight:950">${esc(w.data.name || 'Betrieb')}</div>
            <div class="hint">${esc(addr || 'Adresse fehlt')}</div>
          </div>
        </div>
        <div class="row"><span>Essenszeit</span><b>${esc(w.data.mealWindow || DEFAULT_MEAL_WINDOW)}</b></div>
      `;

      const cta=document.createElement('button');
      cta.className='btn';
      cta.type='button';
      cta.textContent='Erstes Gericht erstellen';
      cta.onclick=()=>{
        saveProviderProfileFromWizard();
        closeWizard();
        startWizard('listing');
      };

      box.appendChild(summary);
      box.appendChild(cta);
      setWizardContent(box);
      wNextBtn.textContent='Fertig';
      return;
    }
  }

  // --- Listing wizard (Punkt 6 final) ---
  function updateListingPreviewContent(target){
    target.innerHTML = '';
    const title = document.createElement('div');
    title.className = 'hint';
    title.textContent = 'Live-Vorschau';
    target.appendChild(title);
    target.appendChild(offerCard(previewOfferFromWizard(), {interactive:false}));
    if(w.data.hasPickupCode){
      const note = document.createElement('div');
      note.className = 'mini';
      note.textContent = 'Beispielcode: A3';
      target.appendChild(note);
    }
  }

  function attachListingPreview(box){
    const wrap = document.createElement('div');
    wrap.id = 'listingPreview';
    wrap.style.marginTop = '12px';
    updateListingPreviewContent(wrap);
    box.appendChild(wrap);
  }

  function refreshListingPreview(){
    const wrap = document.getElementById('listingPreview');
    if(wrap){ updateListingPreviewContent(wrap); }
  }

  function buildListingStep(){
    setWizardNextDefault();
    const total = 8;
    setWizardHeader('Inserat erstellen', `Schritt ${Math.min(w.step+1,total)} von ${total}`);
    const profile = normalizeProviderProfile(provider.profile || {});
    if(!w.data.pickupWindow){ w.data.pickupWindow = profile.mealWindow || DEFAULT_MEAL_WINDOW; }

    if(w.step===0){
      setWizardQuestion('Kategorie?', 'W√§hle eine Kategorie.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      CATEGORIES.forEach(c=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(w.data.category===c?' on':'');
        b.textContent=c;
        b.onclick=()=>{ w.data.category=c; rebuildWizard(); };
        ans.appendChild(b);
      });
      box.appendChild(ans);
      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===1){
      setWizardQuestion('Gericht ausw√§hlen', 'Aus Kochbuch oder neu.');
      const box=document.createElement('div');
      const source=document.createElement('div'); source.className='answers';
      const fromCb=document.createElement('button'); fromCb.type='button'; fromCb.className='ans'+(w.data.source==='cookbook'?' on':''); fromCb.textContent='Aus Kochbuch';
      const fromNew=document.createElement('button'); fromNew.type='button'; fromNew.className='ans'+(w.data.source==='new'?' on':''); fromNew.textContent='Neu';
      fromCb.onclick=()=>{ w.data.source='cookbook'; rebuildWizard(); };
      fromNew.onclick=()=>{ w.data.source='new'; w.data.cookbookId=null; rebuildWizard(); };
      source.appendChild(fromCb); source.appendChild(fromNew);
      box.appendChild(source);

      const applyEntry = (entry)=>{
        w.data.dish = entry.dish || w.data.dish;
        w.data.category = entry.category || w.data.category;
        w.data.price = Number(entry.price||w.data.price||0);
        w.data.allergens = Array.isArray(entry.allergens) ? [...entry.allergens] : [];
        w.data.extras = Array.isArray(entry.extras) ? JSON.parse(JSON.stringify(entry.extras)) : [];
        w.data.reuse = entry.reuse ? JSON.parse(JSON.stringify(entry.reuse)) : {enabled:false, deposit:0};
        w.data.photoData = entry.photoData || '';
        w.data.hasPickupCode = !!entry.hasPickupCode;
        w.data.dineInPossible = !!entry.dineInPossible;
        w.data.cookbookId = entry.id;
      };

      if(w.data.source==='cookbook'){
        const mine = cookbook.filter(c=>c.providerId===providerId());
        if(!mine.length){
          const hint=document.createElement('div');
          hint.className='hint';
          hint.textContent='Noch keine Gerichte im Kochbuch.';
          const add=document.createElement('button');
          add.className='btn secondary';
          add.type='button';
          add.textContent='Gericht anlegen';
          add.onclick=()=> startWizard('cookbook');
          box.appendChild(document.createElement('div')).style.height='8px';
          box.appendChild(hint);
          box.appendChild(add);
        } else {
          const list=document.createElement('div'); list.className='answers';
          mine.forEach(entry=>{
            const b=document.createElement('button');
            b.type='button';
            b.className='ans'+(w.data.cookbookId===entry.id?' on':'');
            b.textContent=entry.dish||'Gericht';
            b.onclick=()=>{ applyEntry(entry); rebuildWizard(); };
            list.appendChild(b);
          });
          box.appendChild(document.createElement('div')).style.height='8px';
          box.appendChild(list);
        }
      } else {
        const input=document.createElement('input');
        input.className='field';
        input.placeholder='z.B. K√ºrbissuppe';
        input.value=w.data.dish||'';
        input.oninput=()=>{
          w.data.dish = input.value;
          const hit = DISH_SUGGESTIONS.find(d => d.name.toLowerCase() === input.value.trim().toLowerCase());
          if(hit){ w.data.category = hit.category; }
          refreshListingPreview();
        };
        const suggest=document.createElement('div');
        suggest.className='answers';
        DISH_SUGGESTIONS.slice(0,6).forEach(s=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans';
          b.textContent=s.name;
          b.onclick=()=>{ w.data.dish = s.name; w.data.category = s.category; rebuildWizard(); };
          suggest.appendChild(b);
        });
        box.appendChild(document.createElement('div')).style.height='8px';
        box.appendChild(input);
        box.appendChild(document.createElement('div')).style.height='8px';
        box.appendChild(suggest);
      }

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===2){
      setWizardQuestion('Preis pro Portion?', 'Preset w√§hlen oder frei eingeben.');
      const box=document.createElement('div');
      const presets=document.createElement('div'); presets.className='answers';
      [4.5,5.5,6.5,7.5,8.5].forEach(val=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(Number(w.data.price)===val?' on':'');
        b.textContent=`${val.toFixed(2).replace('.',',')} ‚Ç¨`;
        b.onclick=()=>{ w.data.price=val; rebuildWizard(); };
        presets.appendChild(b);
      });
      const input=document.createElement('input');
      input.className='field';
      input.inputMode='decimal';
      input.placeholder='0,00';
      input.value = formatPriceInput(w.data.price);
      input.oninput=()=>{ w.data.price = parsePriceInput(input.value); refreshListingPreview(); };
      box.appendChild(presets);
      box.appendChild(document.createElement('div')).style.height='8px';
      box.appendChild(input);
      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===3){
      setWizardQuestion('Abholzeit', 'Aus Profil √ºbernommen.');
      const box=document.createElement('div');
      const summary=document.createElement('div');
      summary.className='panel';
      summary.innerHTML = `<b>${esc(w.data.pickupWindow || DEFAULT_MEAL_WINDOW)}</b><div class="hint">Aus Profil √ºbernommen</div>`;
      const hint=document.createElement('div');
      hint.className='hint';
      hint.textContent='√Ñnderung der Essenszeit ist im Profil m√∂glich.';
      box.appendChild(summary);
      box.appendChild(hint);
      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===4){
      setWizardQuestion('Extras & Mehrweg', 'Optional hinzuf√ºgen.');
      const box=document.createElement('div');
      if(!Array.isArray(w.data.extras)) w.data.extras=[];
      if(!w.data.reuse) w.data.reuse = {enabled:false, deposit:0};

      const extrasTitle=document.createElement('div');
      extrasTitle.className='hint';
      extrasTitle.textContent='Extras';
      const extrasAns=document.createElement('div'); extrasAns.className='answers';
      ['Beilagensalat','Extrasosse','Sonstiges'].forEach(name=>{
        const active = w.data.extras.some(e=>e.name===name);
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(active?' on':'');
        b.textContent=name;
        b.onclick=()=>{
          const idx = w.data.extras.findIndex(e=>e.name===name);
          if(idx>=0) w.data.extras.splice(idx,1);
          else w.data.extras.push({name, price:0});
          rebuildWizard();
        };
        extrasAns.appendChild(b);
      });
      box.appendChild(extrasTitle);
      box.appendChild(extrasAns);

      if(w.data.extras.length){
        w.data.extras.forEach(extra=>{
          const label=document.createElement('div');
          label.className='hint';
          label.textContent=extra.name;
          const input=document.createElement('input');
          input.className='field';
          input.inputMode='decimal';
          input.placeholder='Preis in EUR (z.B. 2,00)';
          input.value = formatPriceInput(extra.price);
          input.oninput=()=>{ extra.price = parsePriceInput(input.value); refreshListingPreview(); };
          box.appendChild(document.createElement('div')).style.height='8px';
          box.appendChild(label);
          box.appendChild(input);
        });
      }

      const reuseTitle=document.createElement('div');
      reuseTitle.className='hint';
      reuseTitle.textContent='Mehrweg / Pfand';
      const reuseAns=document.createElement('div'); reuseAns.className='answers';
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(w.data.reuse.enabled?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!w.data.reuse.enabled?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.reuse.enabled=true; if(!w.data.reuse.deposit) w.data.reuse.deposit=2; rebuildWizard(); };
      no.onclick=()=>{ w.data.reuse.enabled=false; w.data.reuse.deposit=0; w.data.reuseCustom=false; rebuildWizard(); };
      reuseAns.appendChild(yes); reuseAns.appendChild(no);
      box.appendChild(document.createElement('div')).style.height='8px';
      box.appendChild(reuseTitle);
      box.appendChild(reuseAns);

      if(w.data.reuse.enabled){
        const presets=document.createElement('div'); presets.className='answers';
        [2,3,5].forEach(val=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.reuse.deposit===val && !w.data.reuseCustom?' on':'');
          b.textContent=`${val} ‚Ç¨`;
          b.onclick=()=>{ w.data.reuse.deposit=val; w.data.reuseCustom=false; rebuildWizard(); };
          presets.appendChild(b);
        });
        const other=document.createElement('button');
        other.type='button';
        other.className='ans'+(w.data.reuseCustom?' on':'');
        other.textContent='Anderer Betrag';
        other.onclick=()=>{ w.data.reuseCustom=true; rebuildWizard(); };
        presets.appendChild(other);
        box.appendChild(document.createElement('div')).style.height='8px';
        box.appendChild(presets);

        if(w.data.reuseCustom){
          const input=document.createElement('input');
          input.className='field';
          input.inputMode='decimal';
          input.placeholder='Betrag in EUR';
          input.value = formatPriceInput(w.data.reuse.deposit);
          input.oninput=()=>{ w.data.reuse.deposit = parsePriceInput(input.value); refreshListingPreview(); };
          box.appendChild(document.createElement('div')).style.height='8px';
          box.appendChild(input);
        }
      }

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===5){
      setWizardQuestion('Allergene?', 'Optional ausw√§hlen.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      const has = w.data.hasAllergens || (Array.isArray(w.data.allergens) && w.data.allergens.length);
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(has?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!has?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.hasAllergens=true; if(!Array.isArray(w.data.allergens)) w.data.allergens=[]; rebuildWizard(); };
      no.onclick=()=>{ w.data.hasAllergens=false; w.data.allergens=[]; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);

      if(has){
        const list=document.createElement('div'); list.className='answers';
        ALLERGENS_14.forEach(a=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='ans'+(w.data.allergens.includes(a.short)?' on':'');
          b.textContent=`${a.short} ${a.name}`;
          b.onclick=()=>{
            const i=w.data.allergens.indexOf(a.short);
            if(i>=0) w.data.allergens.splice(i,1); else w.data.allergens.push(a.short);
            rebuildWizard();
          };
          list.appendChild(b);
        });
        box.appendChild(document.createElement('div')).style.height='8px';
        box.appendChild(list);
      }

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===6){
      setWizardQuestion('Foto', 'Pflicht: Foto mit automatischem Filter & Zuschnitt.');
      const box=document.createElement('div');
      
      if(!w.data.photoData){
        const ans=document.createElement('div'); ans.className='answers';
        const cam=document.createElement('button'); cam.type='button'; cam.className='ans'; cam.textContent='Kamera';
        cam.onclick=async()=>{ 
          const f=await pickImage({capture:true}); 
          if(!f) return; 
          const dataUrl = await toDataUrl(f);
          await openPhotoEditor(dataUrl);
        };
        const gal=document.createElement('button'); gal.type='button'; gal.className='ans'; gal.textContent='Galerie';
        gal.onclick=async()=>{ 
          const f=await pickImage(); 
          if(!f) return; 
          const dataUrl = await toDataUrl(f);
          await openPhotoEditor(dataUrl);
        };
        ans.appendChild(cam); ans.appendChild(gal);
        box.appendChild(ans);
      } else {
        // Foto bereits vorhanden - Editor √∂ffnen
        const preview=document.createElement('div');
        preview.style.marginTop='10px';
        preview.innerHTML = `
          <div class="hint">Aktuelles Foto:</div>
          <div style="border-radius:16px;overflow:hidden;border:1px solid #eee;margin-top:8px">
            <img src="${w.data.photoData}" alt="" style="width:100%;height:200px;object-fit:cover;display:block">
          </div>
        `;
        box.appendChild(preview);
        
        const editBtn=document.createElement('button');
        editBtn.className='btn secondary';
        editBtn.type='button';
        editBtn.textContent='Foto bearbeiten';
        editBtn.style.marginTop='12px';
        editBtn.onclick=async()=> await openPhotoEditor(w.data.photoData);
        box.appendChild(editBtn);
        
        const removeBtn=document.createElement('button');
        removeBtn.className='btn ghost';
        removeBtn.type='button';
        removeBtn.textContent='Foto entfernen';
        removeBtn.style.marginTop='8px';
        removeBtn.onclick=()=>{ w.data.photoData=''; rebuildWizard(); };
        box.appendChild(removeBtn);
      }
      
      // Live-Vorschau "So erscheint es in der App"
      const livePreview=document.createElement('div');
      livePreview.style.marginTop='20px';
      livePreview.style.padding='16px';
      livePreview.style.background='#f8f7f3';
      livePreview.style.borderRadius='16px';
      livePreview.innerHTML = `
        <div class="hint" style="margin-bottom:8px;font-weight:700;">So erscheint es in der App:</div>
        <div class="discover-hero-card" style="margin:0;cursor:default;">
          <div class="discover-hero-image">
            <img src="${w.data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70'}" alt="" />
          </div>
          <div class="discover-hero-content">
            <div class="discover-hero-title">${esc(w.data.dish||'Gericht')}</div>
            <div class="discover-hero-price">${euro(w.data.price||0)}</div>
          </div>
        </div>
      `;
      box.appendChild(livePreview);

      attachListingPreview(box);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===7){
      setWizardQuestion('Abschluss', 'Ver√∂ffentlichen oder speichern.');
      const box=document.createElement('div');
      attachListingPreview(box);

      const options=document.createElement('div');
      options.style.marginTop='10px';
      const codeLabel=document.createElement('div');
      codeLabel.className='hint';
      codeLabel.textContent='Bezahlung mit Abholcode';
      const codeRow=document.createElement('div'); codeRow.className='answers';
      const codeYes=document.createElement('button'); codeYes.type='button'; codeYes.className='ans'+(w.data.hasPickupCode?' on':''); codeYes.textContent='Ja';
      const codeNo=document.createElement('button'); codeNo.type='button'; codeNo.className='ans'+(!w.data.hasPickupCode?' on':''); codeNo.textContent='Nein';
      codeYes.onclick=()=>{ w.data.hasPickupCode=true; rebuildWizard(); };
      codeNo.onclick=()=>{ w.data.hasPickupCode=false; rebuildWizard(); };
      codeRow.appendChild(codeYes); codeRow.appendChild(codeNo);

      const dineLabel=document.createElement('div');
      dineLabel.className='hint';
      dineLabel.textContent='Vor Ort essen m√∂glich';
      const dineRow=document.createElement('div'); dineRow.className='answers';
      const dineYes=document.createElement('button'); dineYes.type='button'; dineYes.className='ans'+(w.data.dineInPossible?' on':''); dineYes.textContent='Ja';
      const dineNo=document.createElement('button'); dineNo.type='button'; dineNo.className='ans'+(!w.data.dineInPossible?' on':''); dineNo.textContent='Nein';
      dineYes.onclick=()=>{ w.data.dineInPossible=true; rebuildWizard(); };
      dineNo.onclick=()=>{ w.data.dineInPossible=false; rebuildWizard(); };
      dineRow.appendChild(dineYes); dineRow.appendChild(dineNo);

      options.appendChild(codeLabel);
      options.appendChild(codeRow);
      options.appendChild(document.createElement('div')).style.height='6px';
      options.appendChild(dineLabel);
      options.appendChild(dineRow);
      box.appendChild(options);

      const actions=document.createElement('div');
      actions.style.marginTop='10px';

      const btnPub=document.createElement('button');
      btnPub.className='btn';
      btnPub.type='button';
      btnPub.textContent = 'Inserat ver√∂ffentlichen';
      btnPub.onclick=()=>{
        const o = previewOfferFromWizard();
        publishOffer(o);
        closeWizard();
        showProviderHome();
        if(confirm('Inserat ver√∂ffentlicht. Weiteres Inserat erstellen?')){
          startWizard('listing');
        }
      };

      const btnSave=document.createElement('button');
      btnSave.className='btn secondary';
      btnSave.type='button';
      btnSave.textContent='Im Kochbuch speichern';
      btnSave.onclick=()=>{
        saveToCookbookFromWizard();
        closeWizard();
        showProviderCookbook();
      };

      const btnWeek=document.createElement('button');
      btnWeek.className='btn ghost';
      btnWeek.type='button';
      btnWeek.textContent='Zum Wochenplan hinzuf√ºgen';
      btnWeek.onclick=()=>{
        saveToCookbookFromWizard(true);
        const cb = cookbook.filter(x=>x.providerId===providerId()).slice(-1)[0];
        if(cb) startWizard('week', {fromCookbookId:cb.id});
      };

      actions.appendChild(btnPub);
      actions.appendChild(btnSave);
      actions.appendChild(btnWeek);
      box.appendChild(actions);

      setWizardContent(box);
      wNextBtn.textContent='Schlie√üen';
      wNextBtn.onclick=()=>{ closeWizard(); showProviderHome(); };
      return;
    }
  }

  function previewOfferFromWizard(){
    const p = normalizeProviderProfile(provider.profile||{});
    const pickupWindow = w.data.pickupWindow || p.mealWindow || DEFAULT_MEAL_WINDOW;
    return {
      id: 'preview',
      providerId: providerId(),
      providerName: p.name || provider.email || 'Anbieter',
      providerStreet: p.street||'',
      providerZip: p.zip||'',
      providerCity: p.city||'',
      providerLogoData: p.logoData||'',
      dish: w.data.dish||'Gericht',
      category: w.data.category||'Vegetarisch',
      price: Number(w.data.price||0),
      pickupWindow,
      imageUrl: w.data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
      hasPickupCode: !!w.data.hasPickupCode,
      dineInPossible: !!w.data.dineInPossible,
      allergens: w.data.allergens||[],
      extras: w.data.extras||[],
      reuse: w.data.reuse||{enabled:false,deposit:0},
      day: w.data.day || isoDate(new Date()),
      active: w.data.active !== false
    };
  }

  function publishOffer(o){
    const existingId = w.ctx && w.ctx.editOfferId ? w.ctx.editOfferId : null;
    const id = existingId || cryptoId();
    const out = {...o, id, day: o.day || isoDate(new Date()), active: o.active !== false};
    // ensure provider address exists
    if(!out.providerStreet){
      alert('Bitte zuerst Anbieterprofil ausf√ºllen (Adresse).');
      return;
    }
    if(existingId){
      const idx = offers.findIndex(x=>x.id===existingId);
      if(idx>=0){
        const prev = offers[idx];
        offers[idx] = {...prev, ...out, id: prev.id, day: prev.day, active: prev.active !== false};
      } else {
        offers.unshift(out);
      }
    } else {
      offers.unshift(out);
    }
    save(LS.offers, offers);
    // restore default next button handler
    setWizardNextDefault();
    renderProviderHome();
    renderProviderPickups();
    renderDiscover();
    renderStart();
  }

  function saveToCookbookFromWizard(keepOpen=false){
    const now = Date.now();
    const base = {
      id: cryptoId(),
      providerId: providerId(),
      dish: w.data.dish||'',
      category: w.data.category||'Vegetarisch',
      price: Number(w.data.price||0),
      allergens: w.data.allergens||[],
      extras: w.data.extras||[],
      reuse: w.data.reuse||{enabled:false,deposit:0},
      photoData: w.data.photoData||'',
      hasPickupCode: !!w.data.hasPickupCode,
      dineInPossible: !!w.data.dineInPossible,
      createdAt: now,
      lastUsed: null
    };
    if(w.ctx && w.ctx.editId){
      const idx = cookbook.findIndex(c=>c.id===w.ctx.editId);
      if(idx>=0){
        const prev = cookbook[idx];
        cookbook[idx] = {
          ...prev,
          ...base,
          id: prev.id,
          createdAt: prev.createdAt || now,
          lastUsed: prev.lastUsed ?? null
        };
      } else {
        cookbook.push(base);
      }
    } else {
      cookbook.push(base);
    }
    save(LS.cookbook, cookbook);
    if(!keepOpen){ renderCookbook(); }
  }

  // Cookbook wizard (add recipe)
  function buildCookbookStep(){
    setWizardNextDefault();
    // reuse listing steps subset: category, photo, name, allergens, extras, reuse, price, preview/save
    const total = 8;
    setWizardHeader('Kochbuch', `${Math.min(w.step+1,total)}/${total}`);

    if(w.step===0){
      setWizardQuestion('Kategorie?', 'Tippe eine Kategorie.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      ['Vegan','Vegetarisch','Fleisch','Salat'].forEach(c=>{
        const b=document.createElement('button'); b.type='button'; b.className='ans'+(w.data.category===c?' on':''); b.textContent=c;
        b.onclick=()=>{ w.data.category=c; rebuildWizard(); };
        ans.appendChild(b);
      });
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===1){
      setWizardQuestion('Foto speichern?', 'Optional (f√ºr schnelleres Wiederverwenden).');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      const b1=document.createElement('button'); b1.type='button'; b1.className='ans'; b1.textContent='Foto ausw√§hlen';
      b1.onclick=async()=>{ const f=await pickImage(); if(!f) return; w.data.photoData = await toDataUrl(f); rebuildWizard(); };
      const b2=document.createElement('button'); b2.type='button'; b2.className='ans'; b2.textContent='Ohne';
      b2.onclick=()=>{ w.data.photoData=''; rebuildWizard(); };
      ans.appendChild(b1); ans.appendChild(b2);
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===2){
      setWizardQuestion('Gerichtname?', 'Wie im Kochbuch.');
      const box=document.createElement('div');
      const input=document.createElement('input'); input.className='field'; input.placeholder='z.B. Lasagne'; input.value=w.data.dish||'';
      input.oninput=()=>{ w.data.dish=input.value; };
      box.appendChild(input);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===3){
      setWizardQuestion('Allergene?', 'Optional, antippen.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      if(!Array.isArray(w.data.allergens)) w.data.allergens=[];
      ALLERGENS_14.forEach(a=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='ans'+(w.data.allergens.includes(a.short)?' on':'');
        b.textContent=`${a.short} ${a.name}`;
        b.onclick=()=>{
          const i=w.data.allergens.indexOf(a.short);
          if(i>=0) w.data.allergens.splice(i,1); else w.data.allergens.push(a.short);
          rebuildWizard();
        };
        ans.appendChild(b);
      });
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===4){
      // Extras
      setWizardQuestion('Extras?', 'Optional.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(w.data.extras?.length?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!w.data.extras?.length?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.extras = w.data.extras?.length ? w.data.extras : [{name:'Beilagensalat', price:2.0}]; rebuildWizard(); };
      no.onclick=()=>{ w.data.extras=[]; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===5){
      // reuse
      setWizardQuestion('Mehrweg / Pfand?', 'Optional.');
      const box=document.createElement('div');
      const ans=document.createElement('div'); ans.className='answers';
      if(!w.data.reuse) w.data.reuse={enabled:false,deposit:0};
      const yes=document.createElement('button'); yes.type='button'; yes.className='ans'+(w.data.reuse.enabled?' on':''); yes.textContent='Ja';
      const no=document.createElement('button'); no.type='button'; no.className='ans'+(!w.data.reuse.enabled?' on':''); no.textContent='Nein';
      yes.onclick=()=>{ w.data.reuse.enabled=true; if(!w.data.reuse.deposit) w.data.reuse.deposit=5; rebuildWizard(); };
      no.onclick=()=>{ w.data.reuse.enabled=false; w.data.reuse.deposit=0; rebuildWizard(); };
      ans.appendChild(yes); ans.appendChild(no);
      box.appendChild(ans);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===6){
      setWizardQuestion('Standardpreis?', 'Nur Zahl - Komma nicht n√∂tig.');
      const box=document.createElement('div');
      const input=document.createElement('input');
      input.className='field'; input.inputMode='numeric'; input.placeholder='z.B. 799';
      input.value = w.data.price ? String(Math.round(w.data.price*100)) : '';
      input.oninput=()=>{ w.data.price = smartNumberToEuro(input.value); };
      box.appendChild(input);
      setWizardContent(box);
      wNextBtn.textContent='Weiter';
      return;
    }

    if(w.step===7){
      setWizardQuestion('Speichern?', 'Damit du sp√§ter mit 2 Taps inserierst.');
      const box=document.createElement('div');
      const prev = {
        id:'preview',
        providerId:providerId(),
        providerName: provider.profile.name || provider.email || 'Anbieter',
        providerStreet:'',providerZip:'',providerCity:'',providerLogoData: provider.profile.logoData||'',
        dish:w.data.dish||'Gericht',
        category:w.data.category||'Vegetarisch',
        price:Number(w.data.price||0),
        pickupWindow:'',
        imageUrl: w.data.photoData || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?auto=format&fit=crop&w=1400&q=70',
        hasPickupCode:false,
        allergens:w.data.allergens||[],
        extras:w.data.extras||[],
        reuse:w.data.reuse||{enabled:false,deposit:0},
        day: isoDate(new Date())
      };
      box.appendChild(offerCard(prev, {interactive:false}));
      const btn=document.createElement('button');
      btn.className='btn';
      btn.type='button';
      btn.textContent = w.ctx && w.ctx.editId ? '√Ñnderungen speichern' : 'Im Kochbuch speichern';
      btn.onclick=()=>{
        saveToCookbookFromWizard();
        closeWizard();
        renderCookbook();
        alert('Gespeichert.');
      };
      box.appendChild(btn);
      setWizardContent(box);
      wNextBtn.textContent='Fertig';
      wNextBtn.onclick=()=>{ closeWizard(); showProviderCookbook(); };
      return;
    }
  }

  // Weekplan wizard (simple date choose)
  function buildWeekStep(){
    setWizardNextDefault();
    setWizardHeader('Wochenplan', '1/1');
    setWizardQuestion('F√ºr welchen Tag?', 'W√§hle einen Tag und f√ºge das Gericht hinzu.');

    const box=document.createElement('div');
    const ans=document.createElement('div'); ans.className='answers';

    for(let i=0;i<5;i++){
      const d=new Date(); d.setDate(d.getDate()+i);
      const key=isoDate(d);
      const b=document.createElement('button');
      b.type='button';
      b.className='ans'+(w.data.date===key?' on':'');
      b.textContent = i===0?'Heute':(i===1?'Morgen':fmtDay(d));
      b.onclick=()=>{ w.data.date=key; rebuildWizard(); };
      ans.appendChild(b);
    }
    box.appendChild(ans);

    const btn=document.createElement('button');
    btn.className='btn';
    btn.type='button';
    btn.textContent='Zum Wochenplan hinzuf√ºgen';
    btn.onclick=()=>{
      const cb = cookbook.find(c=>c.id===w.data.cookbookId);
      if(!cb){ alert('Gericht nicht gefunden'); return; }
      const entry = { providerId:providerId(), dish:cb.dish, cookbookId:cb.id, active:true };
      if(!week[w.data.date]) week[w.data.date]=[];
      week[w.data.date].push(entry);
      save(LS.week, week);
      
      // Automatisch als Angebot ver√∂ffentlichen, damit Kunden es sehen
      publishWeekEntry(w.data.date, entry);
      
      closeWizard();
      renderProviderHome();
    };

    box.appendChild(document.createElement('div')).style.height='10px';
    box.appendChild(btn);

    setWizardContent(box);
    wNextBtn.textContent='Fertig';
    wNextBtn.onclick=()=>{ closeWizard(); showProviderHome(); };
  }

  // --- Input helpers (thumb-friendly) ---
  function formatPriceInput(value){
    const num = Number(value||0);
    return num.toFixed(2).replace('.',',');
  }
  function parsePriceInput(raw){
    const cleaned = String(raw||'').trim().replace(',', '.').replace(/[^0-9.]/g,'');
    const num = parseFloat(cleaned);
    if(Number.isNaN(num)) return 0;
    return Math.round(num*100)/100;
  }
  function smartNumberToEuro(raw){
    const digits = String(raw||'').replace(/\D/g,'');
    if(!digits) return 0;
    const cents = parseInt(digits,10);
    return Math.round((cents/100)*100)/100;
  }
  function smartNumber(raw){
    const digits = String(raw||'').replace(/\D/g,'');
    if(!digits) return 0;
    return parseInt(digits,10);
  }

  // Image picker
  function pickImage(opts={}){
    return new Promise(resolve=>{
      const input=document.createElement('input');
      input.type='file';
      input.accept='image/*';
      if(opts.capture) input.capture='environment';
      input.onchange=()=> resolve(input.files && input.files[0] ? input.files[0] : null);
      input.click();
    });
  }
  function toDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload=()=>resolve(r.result);
      r.onerror=reject;
      r.readAsDataURL(file);
    });
  }
  
  // Fotoeditor mit Filter & Zuschnitt
  async function openPhotoEditor(imageDataUrl){
    return new Promise((resolve)=>{
      const editor = document.createElement('div');
      editor.className='backdrop active';
      editor.style.zIndex='50';
      
      const editorContent = document.createElement('div');
      editorContent.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:24px;padding:24px;max-width:90vw;max-height:90vh;overflow:auto;z-index:51;box-shadow:0 8px 32px rgba(0,0,0,.2);';
      
      const img = new Image();
      img.src = imageDataUrl;
      img.onload = ()=>{
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const size = 400;
        canvas.width = size;
        canvas.height = size;
        
        // Quadratischer Zuschnitt (zentriert)
        const sourceSize = Math.min(img.width, img.height);
        const sourceX = (img.width - sourceSize) / 2;
        const sourceY = (img.height - sourceSize) / 2;
        
        // Filter: Helligkeit + Kontrast
        ctx.filter = 'brightness(1.1) contrast(1.15) saturate(1.1)';
        ctx.drawImage(img, sourceX, sourceY, sourceSize, sourceSize, 0, 0, size, size);
        
        const processedDataUrl = canvas.toDataURL('image/jpeg', 0.85);
        
        const acceptBtn = document.createElement('button');
        acceptBtn.className='btn';
        acceptBtn.textContent='√úbernehmen';
        acceptBtn.onclick=()=>{
          w.data.photoData = processedDataUrl;
          editor.remove();
          rebuildWizard();
          resolve(processedDataUrl);
        };
        
        const cancelBtn = document.createElement('button');
        cancelBtn.className='btn secondary';
        cancelBtn.textContent='Abbrechen';
        cancelBtn.style.marginLeft='8px';
        cancelBtn.onclick=()=>{
          editor.remove();
          resolve(null);
        };
        
        editorContent.innerHTML = `
          <h3 style="margin:0 0 16px;font-size:18px;font-weight:900;">Foto bearbeiten</h3>
          <div style="border-radius:16px;overflow:hidden;border:1px solid #eee;margin-bottom:16px;background:#f5f5f5">
            <img src="${processedDataUrl}" alt="" style="width:100%;max-width:400px;display:block" />
          </div>
          <div class="hint" style="margin-bottom:16px;">‚úì Automatisch optimiert: Helligkeit + Kontrast<br>‚úì Quadratischer Zuschnitt (wie in der App)</div>
        `;
        
        const btnRow = document.createElement('div');
        btnRow.style.display='flex';
        btnRow.style.gap='8px';
        btnRow.appendChild(acceptBtn);
        btnRow.appendChild(cancelBtn);
        editorContent.appendChild(btnRow);
        
        editor.onclick=(e)=>{
          if(e.target === editor){
            editor.remove();
            resolve(null);
          }
        };
        
        editor.appendChild(editorContent);
        document.body.appendChild(editor);
      };
    });
  }

  // --- boot ---
  // Testdaten immer erstellen (√ºberschreibt vorhandene f√ºr Demo)
  seed();
  offers = offers.map(normalizeOffer);
  save(LS.offers, offers);
  renderChips();

  // init nav bindings
  if(mode==='provider' && !provider.loggedIn) mode='customer';
  setMode(mode);
  
  
  // Sicherstellen, dass Startseite gerendert wird
  if(mode === 'start'){
    setTimeout(()=>{
      if(typeof renderStart !== 'undefined'){
        renderStart();
      }
    }, 200);
  }
</script>

<script>
  // PWA (optional)
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('sw.js').catch(()=>{});
      // Icons initialisieren
      if(typeof lucide !== 'undefined'){
        lucide.createIcons();
      }
      // Profile-View aktualisieren
      if(typeof updateProfileView !== 'undefined'){
        updateProfileView();
      }
      // Startseite rendern, falls im start-Mode
      if(mode === 'start' && typeof renderStart !== 'undefined'){
        setTimeout(()=>{
          renderStart();
          if(typeof lucide !== 'undefined'){
            lucide.createIcons();
          }
        }, 100);
      }
    });
  }

  // Icons nach jedem View-Wechsel aktualisieren
  const originalShowView = showView;
  showView = function(id){
    originalShowView(id);
    if(typeof lucide !== 'undefined'){
      setTimeout(()=> lucide.createIcons(), 50);
    }
  };
</script>
</body>
</html>
